From f8765d4be9065f7cd3a0760a116b315d2b4ebad9 Mon Sep 17 00:00:00 2001
From: Robert Gifford <robertgif@gmail.com>
Date: Fri, 10 Jun 2016 16:45:59 -0400
Subject: [PATCH] Added tun support

---
 sys/rump/net/lib/libtap/Makefile        |  2 ++
 sys/rump/net/lib/libtap/tap_component.c | 39 ++++++++++++++++++++++++++++-----
 2 files changed, 36 insertions(+), 5 deletions(-)

diff --git a/sys/rump/net/lib/libtap/Makefile b/sys/rump/net/lib/libtap/Makefile
index c475477..ad91b05 100644
--- a/sys/rump/net/lib/libtap/Makefile
+++ b/sys/rump/net/lib/libtap/Makefile
@@ -6,6 +6,8 @@
 LIB=	rumpnet_tap
 
 SRCS=	if_tap.c
+#RG addition to support tun devices within tap component
+SRCS+=  if_tun.c
 
 SRCS+=	tap_component.c
 
diff --git a/sys/rump/net/lib/libtap/tap_component.c b/sys/rump/net/lib/libtap/tap_component.c
index 6d9a1f5..6672fe6 100644
--- a/sys/rump/net/lib/libtap/tap_component.c
+++ b/sys/rump/net/lib/libtap/tap_component.c
@@ -36,29 +36,58 @@ __KERNEL_RCSID(0, "$NetBSD: tap_component.c,v 1.1 2015/05/29 12:32:23 pooka Exp
 #include "rump_net_private.h"
 #include "rump_vfs_private.h"
 
+#include <rump/rumpuser.h>
+
 CFDRIVER_DECL(tap, DV_IFNET, NULL);
 
 void tapattach(int);
+void tunattach(int);
 
 RUMP_COMPONENT(RUMP_COMPONENT_NET_IF)
 {
+
+
 	extern const struct cdevsw tap_cdevsw;
-	devmajor_t bmaj, cmaj;
+	devmajor_t bmaj_tap, cmaj_tap;
 	int error;
 
 	config_cfdriver_attach(&tap_cd);
 	tapattach(0);
 
-	bmaj = cmaj = NODEVMAJOR;
-	error = devsw_attach("tap", NULL, &bmaj, &tap_cdevsw, &cmaj);
+	bmaj_tap = cmaj_tap = NODEVMAJOR;
+	error = devsw_attach("tap", NULL, &bmaj_tap, &tap_cdevsw, &cmaj_tap);
 	if (error != 0)
 		panic("tap devsw attach failed: %d", error);
 
-	error = rump_vfs_makeonedevnode(S_IFCHR, "/dev/tap", cmaj, 0xfffff);
+	error = rump_vfs_makeonedevnode(S_IFCHR, "/dev/tap", cmaj_tap, 0xfffff);
 	if (error != 0)
 		panic("cannot create tap device node: %d", error);
 
-	error = rump_vfs_makedevnodes(S_IFCHR, "/dev/tap", '0', cmaj, 0, 4);
+	error = rump_vfs_makedevnodes(S_IFCHR, "/dev/tap", '0', cmaj_tap, 0, 4);
 	if (error != 0)
 		panic("cannot create tap[0-4] device node: %d", error);
+
+	/* ----- TUN ----- */
+	/* RG: attepting to add tun to the tap component for rump */
+	rumpuser_dprintf("----- Hello! Greetings from the tap source code! -----\n");
+	rumpuser_dprintf("----- Attempting to make tun device node /dev/tun -----\n");
+
+	extern const struct cdevsw tun_cdevsw;
+	devmajor_t bmaj_tun, cmaj_tun;
+
+	//config_cfdriver_attach(&tap_cd);
+	tunattach(0);
+
+	bmaj_tun = cmaj_tun = NODEVMAJOR;
+	error = devsw_attach("tun", NULL, &bmaj_tun, &tun_cdevsw, &cmaj_tun);
+	if (error != 0)
+		panic("tun devsw attach failed: %d", error);
+
+	error = rump_vfs_makeonedevnode(S_IFCHR, "/dev/tun", cmaj_tun, 0xfffff);
+	if (error != 0)
+		panic("cannot create tun device node: %d", error);
+
+	error = rump_vfs_makedevnodes(S_IFCHR, "/dev/tun", '0', cmaj_tun, 0, 4);
+	if (error != 0)
+		panic("cannot create tun[0-4] device node: %d", error);
 }
-- 
2.5.0

