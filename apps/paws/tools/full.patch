From 485b20c4ab4f862e6b1a752aae1c41c08041ef07 Mon Sep 17 00:00:00 2001
From: Robert Gifford <robertgif@gmail.com>
Date: Fri, 10 Jun 2016 16:45:59 -0400
Subject: [PATCH 1/7] Added tun support

---
 sys/rump/net/lib/libtap/Makefile        |  2 ++
 sys/rump/net/lib/libtap/tap_component.c | 39 ++++++++++++++++++++++++++++-----
 2 files changed, 36 insertions(+), 5 deletions(-)

diff --git a/sys/rump/net/lib/libtap/Makefile b/sys/rump/net/lib/libtap/Makefile
index c475477..ad91b05 100644
--- a/sys/rump/net/lib/libtap/Makefile
+++ b/sys/rump/net/lib/libtap/Makefile
@@ -6,6 +6,8 @@
 LIB=	rumpnet_tap
 
 SRCS=	if_tap.c
+#RG addition to support tun devices within tap component
+SRCS+=  if_tun.c
 
 SRCS+=	tap_component.c
 
diff --git a/sys/rump/net/lib/libtap/tap_component.c b/sys/rump/net/lib/libtap/tap_component.c
index 6d9a1f5..6672fe6 100644
--- a/sys/rump/net/lib/libtap/tap_component.c
+++ b/sys/rump/net/lib/libtap/tap_component.c
@@ -36,29 +36,58 @@ __KERNEL_RCSID(0, "$NetBSD: tap_component.c,v 1.1 2015/05/29 12:32:23 pooka Exp
 #include "rump_net_private.h"
 #include "rump_vfs_private.h"
 
+#include <rump/rumpuser.h>
+
 CFDRIVER_DECL(tap, DV_IFNET, NULL);
 
 void tapattach(int);
+void tunattach(int);
 
 RUMP_COMPONENT(RUMP_COMPONENT_NET_IF)
 {
+
+
 	extern const struct cdevsw tap_cdevsw;
-	devmajor_t bmaj, cmaj;
+	devmajor_t bmaj_tap, cmaj_tap;
 	int error;
 
 	config_cfdriver_attach(&tap_cd);
 	tapattach(0);
 
-	bmaj = cmaj = NODEVMAJOR;
-	error = devsw_attach("tap", NULL, &bmaj, &tap_cdevsw, &cmaj);
+	bmaj_tap = cmaj_tap = NODEVMAJOR;
+	error = devsw_attach("tap", NULL, &bmaj_tap, &tap_cdevsw, &cmaj_tap);
 	if (error != 0)
 		panic("tap devsw attach failed: %d", error);
 
-	error = rump_vfs_makeonedevnode(S_IFCHR, "/dev/tap", cmaj, 0xfffff);
+	error = rump_vfs_makeonedevnode(S_IFCHR, "/dev/tap", cmaj_tap, 0xfffff);
 	if (error != 0)
 		panic("cannot create tap device node: %d", error);
 
-	error = rump_vfs_makedevnodes(S_IFCHR, "/dev/tap", '0', cmaj, 0, 4);
+	error = rump_vfs_makedevnodes(S_IFCHR, "/dev/tap", '0', cmaj_tap, 0, 4);
 	if (error != 0)
 		panic("cannot create tap[0-4] device node: %d", error);
+
+	/* ----- TUN ----- */
+	/* RG: attepting to add tun to the tap component for rump */
+	rumpuser_dprintf("----- Hello! Greetings from the tap source code! -----\n");
+	rumpuser_dprintf("----- Attempting to make tun device node /dev/tun -----\n");
+
+	extern const struct cdevsw tun_cdevsw;
+	devmajor_t bmaj_tun, cmaj_tun;
+
+	//config_cfdriver_attach(&tap_cd);
+	tunattach(0);
+
+	bmaj_tun = cmaj_tun = NODEVMAJOR;
+	error = devsw_attach("tun", NULL, &bmaj_tun, &tun_cdevsw, &cmaj_tun);
+	if (error != 0)
+		panic("tun devsw attach failed: %d", error);
+
+	error = rump_vfs_makeonedevnode(S_IFCHR, "/dev/tun", cmaj_tun, 0xfffff);
+	if (error != 0)
+		panic("cannot create tun device node: %d", error);
+
+	error = rump_vfs_makedevnodes(S_IFCHR, "/dev/tun", '0', cmaj_tun, 0, 4);
+	if (error != 0)
+		panic("cannot create tun[0-4] device node: %d", error);
 }
-- 
1.9.1


From f48af3ecc3f003838ccbef7e1339c6c4d13a475d Mon Sep 17 00:00:00 2001
From: lab176 <lbaier176@gmail.com>
Date: Tue, 28 Jun 2016 15:20:26 -0400
Subject: [PATCH 2/7] patch merge

---
 sys/net/if_cnic.c                       | 1098 +++++++++++++++++++++++++++++++
 sys/net/if_cnic.h                       |   44 ++
 sys/rump/net/lib/libtap/Makefile        |    2 +-
 sys/rump/net/lib/libtap/tap_component.c |   26 +-
 4 files changed, 1156 insertions(+), 14 deletions(-)
 create mode 100644 sys/net/if_cnic.c
 create mode 100644 sys/net/if_cnic.h

diff --git a/sys/net/if_cnic.c b/sys/net/if_cnic.c
new file mode 100644
index 0000000..b3344d9
--- /dev/null
+++ b/sys/net/if_cnic.c
@@ -0,0 +1,1098 @@
+/* All rights go the NetBSD, this is simply a copy of if_tun.c with tun namespace replaced with cnic */
+
+#include <sys/cdefs.h>
+
+#include "opt_inet.h"
+
+#include <sys/param.h>
+#include <sys/proc.h>
+#include <sys/systm.h>
+#include <sys/mbuf.h>
+#include <sys/buf.h>
+#include <sys/protosw.h>
+#include <sys/socket.h>
+#include <sys/ioctl.h>
+#include <sys/errno.h>
+#include <sys/syslog.h>
+#include <sys/select.h>
+#include <sys/poll.h>
+#include <sys/file.h>
+#include <sys/signalvar.h>
+#include <sys/conf.h>
+#include <sys/kauth.h>
+#include <sys/mutex.h>
+#include <sys/cpu.h>
+
+#include <net/if.h>
+#include <net/if_types.h>
+#include <net/netisr.h>
+#include <net/route.h>
+
+
+#ifdef INET
+#include <netinet/in.h>
+#include <netinet/in_systm.h>
+#include <netinet/in_var.h>
+#include <netinet/ip.h>
+#include <netinet/if_inarp.h>
+#endif
+
+
+#include <sys/time.h>
+#include <net/bpf.h>
+
+#include <net/if_cnic.h>
+
+#define CNICDEBUG	if (cnicdebug) printf
+int	cnicdebug = 0;
+
+extern int ifqmaxlen;
+void	cnicattach(int);
+
+static LIST_HEAD(, cnic_softc) cnic_softc_list;
+static LIST_HEAD(, cnic_softc) cnicz_softc_list;
+static kmutex_t cnic_softc_lock;
+
+static int	cnic_ioctl(struct ifnet *, u_long, void *);
+static int	cnic_output(struct ifnet *, struct mbuf *,
+			const struct sockaddr *, struct rtentry *rt);
+static int	cnic_clone_create(struct if_clone *, int);
+static int	cnic_clone_destroy(struct ifnet *);
+
+static struct if_clone cnic_cloner =
+    IF_CLONE_INITIALIZER("cnic", cnic_clone_create, cnic_clone_destroy);
+
+static void cnicattach0(struct cnic_softc *);
+static void cnicinit(struct cnic_softc *);
+static void cnic_i_softintr(void *);
+static void cnic_o_softintr(void *);
+#ifdef ALTQ
+static void cnicstart(struct ifnet *);
+#endif
+static struct cnic_softc *cnic_find_unit(dev_t);
+static struct cnic_softc *cnic_find_zunit(int);
+
+static dev_type_open(cnicopen);
+static dev_type_close(cnicclose);
+static dev_type_read(cnicread);
+static dev_type_write(cnicwrite);
+static dev_type_ioctl(cnicioctl);
+static dev_type_poll(cnicpoll);
+static dev_type_kqfilter(cnickqfilter);
+
+const struct cdevsw cnic_cdevsw = {
+	.d_open = cnicopen,
+	.d_close = cnicclose,
+	.d_read = cnicread,
+	.d_write = cnicwrite,
+	.d_ioctl = cnicioctl,
+	.d_stop = nostop,
+	.d_tty = notty,
+	.d_poll = cnicpoll,
+	.d_mmap = nommap,
+	.d_kqfilter = cnickqfilter,
+	.d_discard = nodiscard,
+	.d_flag = D_OTHER
+};
+
+void
+cnicattach(int unused)
+{
+
+	mutex_init(&cnic_softc_lock, MUTEX_DEFAULT, IPL_NET);
+	LIST_INIT(&cnic_softc_list);
+	LIST_INIT(&cnicz_softc_list);
+	if_clone_attach(&cnic_cloner);
+}
+
+/*
+ * Find driver instance from dev_t.
+ * Returns with tp locked (if found).
+ */
+static struct cnic_softc *
+cnic_find_unit(dev_t dev)
+{
+	struct cnic_softc *tp;
+	int unit = minor(dev);
+
+	mutex_enter(&cnic_softc_lock);
+	LIST_FOREACH(tp, &cnic_softc_list, cnic_list)
+		if (unit == tp->cnic_unit)
+			break;
+	if (tp)
+		mutex_enter(&tp->cnic_lock);
+	mutex_exit(&cnic_softc_lock);
+
+	return (tp);
+}
+
+/*
+ * Find zombie driver instance by unit number.
+ * Remove tp from list and return it unlocked (if found).
+ */
+static struct cnic_softc *
+cnic_find_zunit(int unit)
+{
+	struct cnic_softc *tp;
+
+	mutex_enter(&cnic_softc_lock);
+	LIST_FOREACH(tp, &cnicz_softc_list, cnic_list)
+		if (unit == tp->cnic_unit)
+			break;
+	if (tp)
+		LIST_REMOVE(tp, cnic_list);
+	mutex_exit(&cnic_softc_lock);
+#ifdef DIAGNOSTIC
+	if (tp != NULL && (tp->cnic_flags & (CNIC_INITED|CNIC_OPEN)) != CNIC_OPEN)
+		printf("cnic%d: inconsistent flags: %x\n", unit, tp->cnic_flags);
+#endif
+
+	return (tp);
+}
+
+static int
+cnic_clone_create(struct if_clone *ifc, int unit)
+{
+	struct cnic_softc *tp;
+
+	if ((tp = cnic_find_zunit(unit)) == NULL) {
+		/* Allocate a new instance */
+		tp = malloc(sizeof(*tp), M_DEVBUF, M_WAITOK|M_ZERO);
+
+		tp->cnic_unit = unit;
+		mutex_init(&tp->cnic_lock, MUTEX_DEFAULT, IPL_NET);
+		selinit(&tp->cnic_rsel);
+		selinit(&tp->cnic_wsel);
+	} else {
+		/* Revive cnicnel instance; clear ifp part */
+		(void)memset(&tp->cnic_if, 0, sizeof(struct ifnet));
+	}
+
+	if_initname(&tp->cnic_if, ifc->ifc_name, unit);
+	cnicattach0(tp);
+	tp->cnic_flags |= CNIC_INITED;
+	tp->cnic_osih = softint_establish(SOFTINT_CLOCK, cnic_o_softintr, tp);
+	tp->cnic_isih = softint_establish(SOFTINT_CLOCK, cnic_i_softintr, tp);
+
+	mutex_enter(&cnic_softc_lock);
+	LIST_INSERT_HEAD(&cnic_softc_list, tp, cnic_list);
+	mutex_exit(&cnic_softc_lock);
+
+	return (0);
+}
+
+static void
+cnicattach0(struct cnic_softc *tp)
+{
+	struct ifnet *ifp;
+
+	ifp = &tp->cnic_if;
+	ifp->if_softc = tp;
+	ifp->if_mtu = CNICMTU;
+	ifp->if_ioctl = cnic_ioctl;
+	ifp->if_output = cnic_output;
+#ifdef ALTQ
+	ifp->if_start = cnicstart;
+#endif
+	ifp->if_flags = IFF_POINTOPOINT;
+	ifp->if_type = IFT_TUNNEL;
+	ifp->if_snd.ifq_maxlen = ifqmaxlen;
+	ifp->if_collisions = 0;
+	ifp->if_ierrors = 0;
+	ifp->if_oerrors = 0;
+	ifp->if_ipackets = 0;
+	ifp->if_opackets = 0;
+	ifp->if_ibytes   = 0;
+	ifp->if_obytes   = 0;
+	ifp->if_dlt = DLT_NULL;
+	IFQ_SET_READY(&ifp->if_snd);
+	if_attach(ifp);
+	if_alloc_sadl(ifp);
+	bpf_attach(ifp, DLT_NULL, sizeof(uint32_t));
+}
+
+static int
+cnic_clone_destroy(struct ifnet *ifp)
+{
+	struct cnic_softc *tp = (void *)ifp;
+	int zombie = 0;
+
+	IF_PURGE(&ifp->if_snd);
+	ifp->if_flags &= ~IFF_RUNNING;
+
+	mutex_enter(&cnic_softc_lock);
+	mutex_enter(&tp->cnic_lock);
+	LIST_REMOVE(tp, cnic_list);
+	if (tp->cnic_flags & CNIC_OPEN) {
+		/* Hang on to storage until last close */
+		zombie = 1;
+		tp->cnic_flags &= ~CNIC_INITED;
+		LIST_INSERT_HEAD(&cnicz_softc_list, tp, cnic_list);
+	}
+	mutex_exit(&cnic_softc_lock);
+
+	if (tp->cnic_flags & CNIC_RWAIT) {
+		tp->cnic_flags &= ~CNIC_RWAIT;
+		wakeup((void *)tp);
+	}
+	selnotify(&tp->cnic_rsel, 0, 0);
+
+	mutex_exit(&tp->cnic_lock);
+
+	if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
+		fownsignal(tp->cnic_pgid, SIGIO, POLL_HUP, 0, NULL);
+
+	bpf_detach(ifp);
+	if_detach(ifp);
+
+	if (!zombie) {
+		seldestroy(&tp->cnic_rsel);
+		seldestroy(&tp->cnic_wsel);
+		softint_disestablish(tp->cnic_osih);
+		softint_disestablish(tp->cnic_isih);
+		mutex_destroy(&tp->cnic_lock);
+		free(tp, M_DEVBUF);
+	}
+
+	return (0);
+}
+
+/*
+ * cnicnel open - must be superuser & the device must be
+ * configured in
+ */
+static int
+cnicopen(dev_t dev, int flag, int mode, struct lwp *l)
+{
+	struct ifnet	*ifp;
+	struct cnic_softc *tp;
+	int	error;
+
+	error = kauth_authorize_network(l->l_cred, KAUTH_NETWORK_INTERFACE_TUN,
+	    KAUTH_REQ_NETWORK_INTERFACE_TUN_ADD, NULL, NULL, NULL);
+	if (error)
+		return (error);
+
+	tp = cnic_find_unit(dev);
+
+	if (tp == NULL) {
+		(void)cnic_clone_create(&cnic_cloner, minor(dev));
+		tp = cnic_find_unit(dev);
+		if (tp == NULL) {
+			error = ENXIO;
+			goto out_nolock;
+		}
+	}
+
+	if (tp->cnic_flags & CNIC_OPEN) {
+		error = EBUSY;
+		goto out;
+	}
+
+	ifp = &tp->cnic_if;
+	tp->cnic_flags |= CNIC_OPEN;
+	CNICDEBUG("%s: open\n", ifp->if_xname);
+out:
+	mutex_exit(&tp->cnic_lock);
+out_nolock:
+	return (error);
+}
+
+/*
+ * cnicclose - close the device - mark i/f down & delete
+ * routing info
+ */
+int
+cnicclose(dev_t dev, int flag, int mode,
+    struct lwp *l)
+{
+	struct cnic_softc *tp;
+	struct ifnet	*ifp;
+
+	if ((tp = cnic_find_zunit(minor(dev))) != NULL) {
+		/* interface was "destroyed" before the close */
+		seldestroy(&tp->cnic_rsel);
+		seldestroy(&tp->cnic_wsel);
+		softint_disestablish(tp->cnic_osih);
+		softint_disestablish(tp->cnic_isih);
+		mutex_destroy(&tp->cnic_lock);
+		free(tp, M_DEVBUF);
+		goto out_nolock;
+	}
+
+	if ((tp = cnic_find_unit(dev)) == NULL)
+		goto out_nolock;
+
+	ifp = &tp->cnic_if;
+
+	tp->cnic_flags &= ~CNIC_OPEN;
+
+	tp->cnic_pgid = 0;
+	selnotify(&tp->cnic_rsel, 0, 0);
+
+	CNICDEBUG ("%s: closed\n", ifp->if_xname);
+	mutex_exit(&tp->cnic_lock);
+
+	/*
+	 * junk all pending output
+	 */
+	IFQ_PURGE(&ifp->if_snd);
+
+	if (ifp->if_flags & IFF_UP) {
+		if_down(ifp);
+		if (ifp->if_flags & IFF_RUNNING) {
+			/* find internet addresses and delete routes */
+			struct ifaddr *ifa;
+			IFADDR_FOREACH(ifa, ifp) {
+#if defined(INET) || defined(INET6)
+				if (ifa->ifa_addr->sa_family == AF_INET ||
+				    ifa->ifa_addr->sa_family == AF_INET6) {
+					rtinit(ifa, (int)RTM_DELETE,
+					       tp->cnic_flags & CNIC_DSTADDR
+							? RTF_HOST
+							: 0);
+				}
+#endif
+			}
+		}
+	}
+out_nolock:
+	return (0);
+}
+
+/*
+ * Call at splnet().
+ */
+static void
+cnicinit(struct cnic_softc *tp)
+{
+	struct ifnet	*ifp = &tp->cnic_if;
+	struct ifaddr	*ifa;
+
+	CNICDEBUG("%s: cnicinit\n", ifp->if_xname);
+
+	mutex_enter(&tp->cnic_lock);
+	ifp->if_flags |= IFF_UP | IFF_RUNNING;
+
+	tp->cnic_flags &= ~(CNIC_IASET|CNIC_DSTADDR);
+	IFADDR_FOREACH(ifa, ifp) {
+#ifdef INET
+		if (ifa->ifa_addr->sa_family == AF_INET) {
+			struct sockaddr_in *sin;
+
+			sin = satosin(ifa->ifa_addr);
+			if (sin && sin->sin_addr.s_addr)
+				tp->cnic_flags |= CNIC_IASET;
+
+			if (ifp->if_flags & IFF_POINTOPOINT) {
+				sin = satosin(ifa->ifa_dstaddr);
+				if (sin && sin->sin_addr.s_addr)
+					tp->cnic_flags |= CNIC_DSTADDR;
+			}
+		}
+#endif
+#ifdef INET6
+		if (ifa->ifa_addr->sa_family == AF_INET6) {
+			struct sockaddr_in6 *sin;
+
+			sin = (struct sockaddr_in6 *)ifa->ifa_addr;
+			if (!IN6_IS_ADDR_UNSPECIFIED(&sin->sin6_addr))
+				tp->cnic_flags |= CNIC_IASET;
+
+			if (ifp->if_flags & IFF_POINTOPOINT) {
+				sin = (struct sockaddr_in6 *)ifa->ifa_dstaddr;
+				if (sin &&
+				    !IN6_IS_ADDR_UNSPECIFIED(&sin->sin6_addr))
+					tp->cnic_flags |= CNIC_DSTADDR;
+			} else
+				tp->cnic_flags &= ~CNIC_DSTADDR;
+		}
+#endif /* INET6 */
+	}
+	mutex_exit(&tp->cnic_lock);
+}
+
+/*
+ * Process an ioctl request.
+ */
+static int
+cnic_ioctl(struct ifnet *ifp, u_long cmd, void *data)
+{
+	int		error = 0, s;
+	struct cnic_softc *tp = (struct cnic_softc *)(ifp->if_softc);
+	struct ifreq *ifr = (struct ifreq *)data;
+	struct ifaddr *ifa = (struct ifaddr *)data;
+
+	s = splnet();
+
+	switch (cmd) {
+	case SIOCINITIFADDR:
+		cnicinit(tp);
+		ifa->ifa_rtrequest = p2p_rtrequest;
+		CNICDEBUG("%s: address set\n", ifp->if_xname);
+		break;
+	case SIOCSIFBRDADDR:
+		CNICDEBUG("%s: broadcast address set\n", ifp->if_xname);
+		break;
+	case SIOCSIFMTU:
+		if (ifr->ifr_mtu > CNICMTU || ifr->ifr_mtu < 576) {
+			error = EINVAL;
+			break;
+		}
+		CNICDEBUG("%s: interface mtu set\n", ifp->if_xname);
+		if ((error = ifioctl_common(ifp, cmd, data)) == ENETRESET)
+			error = 0;
+		break;
+	case SIOCADDMULTI:
+	case SIOCDELMULTI:
+		if (ifr == NULL) {
+	        	error = EAFNOSUPPORT;           /* XXX */
+			break;
+		}
+		switch (ifreq_getaddr(cmd, ifr)->sa_family) {
+#ifdef INET
+		case AF_INET:
+			break;
+#endif
+#ifdef INET6
+		case AF_INET6:
+			break;
+#endif
+		default:
+			error = EAFNOSUPPORT;
+			break;
+		}
+		break;
+	default:
+		error = ifioctl_common(ifp, cmd, data);
+	}
+
+	splx(s);
+	return (error);
+}
+
+/*
+ * cnic_output - queue packets from higher level ready to put out.
+ */
+static int
+cnic_output(struct ifnet *ifp, struct mbuf *m0, const struct sockaddr *dst,
+    struct rtentry *rt)
+{
+	struct cnic_softc *tp = ifp->if_softc;
+	int		s;
+	int		error;
+#if defined(INET) || defined(INET6)
+	int		mlen;
+	uint32_t	*af;
+#endif
+	ALTQ_DECL(struct altq_pktattr pktattr;)
+
+	s = splnet();
+	mutex_enter(&tp->cnic_lock);
+	CNICDEBUG ("%s: cnic_output\n", ifp->if_xname);
+
+	if ((tp->cnic_flags & CNIC_READY) != CNIC_READY) {
+		CNICDEBUG ("%s: not ready 0%o\n", ifp->if_xname,
+			  tp->cnic_flags);
+		error = EHOSTDOWN;
+		goto out;
+	}
+
+	/*
+	 * if the queueing discipline needs packet classification,
+	 * do it before prepending link headers.
+	 */
+	IFQ_CLASSIFY(&ifp->if_snd, m0, dst->sa_family, &pktattr);
+
+	bpf_mtap_af(ifp, dst->sa_family, m0);
+
+	switch(dst->sa_family) {
+#ifdef INET6
+	case AF_INET6:
+#endif
+#ifdef INET
+	case AF_INET:
+#endif
+#if defined(INET) || defined(INET6)
+		if (tp->cnic_flags & CNIC_PREPADDR) {
+			/* Simple link-layer header */
+			M_PREPEND(m0, dst->sa_len, M_DONTWAIT);
+			if (m0 == NULL) {
+				IF_DROP(&ifp->if_snd);
+				error = ENOBUFS;
+				goto out;
+			}
+			bcopy(dst, mtod(m0, char *), dst->sa_len);
+		}
+
+		if (tp->cnic_flags & CNIC_IFHEAD) {
+			/* Prepend the address family */
+			M_PREPEND(m0, sizeof(*af), M_DONTWAIT);
+			if (m0 == NULL) {
+				IF_DROP(&ifp->if_snd);
+				error = ENOBUFS;
+				goto out;
+			}
+			af = mtod(m0,uint32_t *);
+			*af = htonl(dst->sa_family);
+		} else {
+#ifdef INET
+			if (dst->sa_family != AF_INET)
+#endif
+			{
+				error = EAFNOSUPPORT;
+				goto out;
+			}
+		}
+		/* FALLTHROUGH */
+	case AF_UNSPEC:
+		IFQ_ENQUEUE(&ifp->if_snd, m0, &pktattr, error);
+		if (error) {
+			ifp->if_collisions++;
+			error = EAFNOSUPPORT;
+			m0 = NULL;
+			goto out;
+		}
+		mlen = m0->m_pkthdr.len;
+		ifp->if_opackets++;
+		ifp->if_obytes += mlen;
+		break;
+#endif
+	default:
+		error = EAFNOSUPPORT;
+		goto out;
+	}
+
+	if (tp->cnic_flags & CNIC_RWAIT) {
+		tp->cnic_flags &= ~CNIC_RWAIT;
+		wakeup((void *)tp);
+	}
+	if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
+		softint_schedule(tp->cnic_isih);
+
+	selnotify(&tp->cnic_rsel, 0, 0);
+out:
+	mutex_exit(&tp->cnic_lock);
+	splx(s);
+
+	if (error && m0) {
+		m_freem(m0);
+	}
+	return 0;
+}
+
+static void
+cnic_i_softintr(void *cookie)
+{
+	struct cnic_softc *tp = cookie;
+
+	if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
+		fownsignal(tp->cnic_pgid, SIGIO, POLL_IN, POLLIN|POLLRDNORM,
+		    NULL);
+}
+
+static void
+cnic_o_softintr(void *cookie)
+{
+	struct cnic_softc *tp = cookie;
+
+	if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
+		fownsignal(tp->cnic_pgid, SIGIO, POLL_OUT, POLLOUT|POLLWRNORM,
+		    NULL);
+}
+
+/*
+ * the cdevsw interface is now pretty minimal.
+ */
+int
+cnicioctl(dev_t dev, u_long cmd, void *data, int flag, struct lwp *l)
+{
+	struct cnic_softc *tp;
+	int s, error = 0;
+
+	s = splnet();
+	tp = cnic_find_unit(dev);
+
+	/* interface was "destroyed" already */
+	if (tp == NULL) {
+		error = ENXIO;
+		goto out_nolock;
+	}
+
+	switch (cmd) {
+	case CNICSDEBUG:
+		cnicdebug = *(int *)data;
+		break;
+
+	case CNICGDEBUG:
+		*(int *)data = cnicdebug;
+		break;
+
+	case CNICSIFMODE:
+		switch (*(int *)data & (IFF_POINTOPOINT|IFF_BROADCAST)) {
+		case IFF_POINTOPOINT:
+		case IFF_BROADCAST:
+			if (tp->cnic_if.if_flags & IFF_UP) {
+				error = EBUSY;
+				goto out;
+			}
+			tp->cnic_if.if_flags &=
+				~(IFF_BROADCAST|IFF_POINTOPOINT|IFF_MULTICAST);
+			tp->cnic_if.if_flags |= *(int *)data;
+			break;
+		default:
+			error = EINVAL;
+			goto out;
+		}
+		break;
+
+	case CNICSLMODE:
+		if (*(int *)data) {
+			tp->cnic_flags |= CNIC_PREPADDR;
+			tp->cnic_flags &= ~CNIC_IFHEAD;
+		} else
+			tp->cnic_flags &= ~CNIC_PREPADDR;
+		break;
+
+	case CNICSIFHEAD:
+		if (*(int *)data) {
+			tp->cnic_flags |= CNIC_IFHEAD;
+			tp->cnic_flags &= ~CNIC_PREPADDR;
+		} else
+			tp->cnic_flags &= ~CNIC_IFHEAD;
+		break;
+
+	case CNICGIFHEAD:
+		*(int *)data = (tp->cnic_flags & CNIC_IFHEAD);
+		break;
+
+	case FIONBIO:
+		if (*(int *)data)
+			tp->cnic_flags |= CNIC_NBIO;
+		else
+			tp->cnic_flags &= ~CNIC_NBIO;
+		break;
+
+	case FIOASYNC:
+		if (*(int *)data)
+			tp->cnic_flags |= CNIC_ASYNC;
+		else
+			tp->cnic_flags &= ~CNIC_ASYNC;
+		break;
+
+	case FIONREAD:
+		if (tp->cnic_if.if_snd.ifq_head)
+			*(int *)data = tp->cnic_if.if_snd.ifq_head->m_pkthdr.len;
+		else
+			*(int *)data = 0;
+		break;
+
+	case TIOCSPGRP:
+	case FIOSETOWN:
+		error = fsetown(&tp->cnic_pgid, cmd, data);
+		break;
+
+	case TIOCGPGRP:
+	case FIOGETOWN:
+		error = fgetown(tp->cnic_pgid, cmd, data);
+		break;
+
+	default:
+		error = ENOTTY;
+	}
+
+out:
+	mutex_exit(&tp->cnic_lock);
+out_nolock:
+	splx(s);
+	return (error);
+}
+
+/*
+ * The cdevsw read interface - reads a packet at a time, or at
+ * least as much of a packet as can be read.
+ */
+int
+cnicread(dev_t dev, struct uio *uio, int ioflag)
+{
+	struct cnic_softc *tp;
+	struct ifnet	*ifp;
+	struct mbuf	*m, *m0;
+	int		error = 0, len, s, index;
+
+	s = splnet();
+	tp = cnic_find_unit(dev);
+
+	/* interface was "destroyed" already */
+	if (tp == NULL) {
+		error = ENXIO;
+		goto out_nolock;
+	}
+
+	index = tp->cnic_if.if_index;
+	ifp = &tp->cnic_if;
+
+	CNICDEBUG ("%s: read\n", ifp->if_xname);
+	if ((tp->cnic_flags & CNIC_READY) != CNIC_READY) {
+		CNICDEBUG ("%s: not ready 0%o\n", ifp->if_xname, tp->cnic_flags);
+		error = EHOSTDOWN;
+		goto out;
+	}
+
+	tp->cnic_flags &= ~CNIC_RWAIT;
+
+	do {
+		IFQ_DEQUEUE(&ifp->if_snd, m0);
+		if (m0 == 0) {
+			if (tp->cnic_flags & CNIC_NBIO) {
+				error = EWOULDBLOCK;
+				goto out;
+			}
+			tp->cnic_flags |= CNIC_RWAIT;
+			if (mtsleep((void *)tp, PZERO|PCATCH|PNORELOCK,
+					"cnicread", 0, &tp->cnic_lock) != 0) {
+				error = EINTR;
+				goto out_nolock;
+			} else {
+				/*
+				 * Maybe the interface was destroyed while
+				 * we were sleeping, so let's ensure that
+				 * we're looking at the same (valid) cnic
+				 * interface before looping.
+				 */
+				tp = cnic_find_unit(dev);
+				if (tp == NULL) {
+					error = ENXIO;
+					goto out_nolock;
+				}
+				if (tp->cnic_if.if_index != index) {
+					error = ENXIO;
+					goto out;
+				}
+			}
+		}
+	} while (m0 == 0);
+
+	mutex_exit(&tp->cnic_lock);
+	splx(s);
+
+	/* Copy the mbuf chain */
+	while (m0 && uio->uio_resid > 0 && error == 0) {
+		len = min(uio->uio_resid, m0->m_len);
+		if (len != 0)
+			error = uiomove(mtod(m0, void *), len, uio);
+		MFREE(m0, m);
+		m0 = m;
+	}
+
+	if (m0) {
+		CNICDEBUG("Dropping mbuf\n");
+		m_freem(m0);
+	}
+	if (error)
+		ifp->if_ierrors++;
+
+	return (error);
+
+out:
+	mutex_exit(&tp->cnic_lock);
+out_nolock:
+	splx(s);
+	return (error);
+}
+
+/*
+ * the cdevsw write interface - an atomic write is a packet - or else!
+ */
+int
+cnicwrite(dev_t dev, struct uio *uio, int ioflag)
+{
+	struct cnic_softc *tp;
+	struct ifnet	*ifp;
+	struct mbuf	*top, **mp, *m;
+	pktqueue_t	*pktq;
+	struct sockaddr	dst;
+	int		error = 0, s, tlen, mlen;
+	uint32_t	family;
+
+	s = splnet();
+	tp = cnic_find_unit(dev);
+
+	/* interface was "destroyed" already */
+	if (tp == NULL) {
+		error = ENXIO;
+		goto out_nolock;
+	}
+
+	/* Unlock until we've got the data */
+	mutex_exit(&tp->cnic_lock);
+	splx(s);
+
+	ifp = &tp->cnic_if;
+
+	CNICDEBUG("%s: cnicwrite\n", ifp->if_xname);
+
+	if (tp->cnic_flags & CNIC_PREPADDR) {
+		if (uio->uio_resid < sizeof(dst)) {
+			error = EIO;
+			goto out0;
+		}
+		error = uiomove((void *)&dst, sizeof(dst), uio);
+		if (dst.sa_len > sizeof(dst)) {
+			/* Duh.. */
+			char discard;
+			int n = dst.sa_len - sizeof(dst);
+			while (n--)
+				if ((error = uiomove(&discard, 1, uio)) != 0) {
+					goto out0;
+				}
+		}
+	} else if (tp->cnic_flags & CNIC_IFHEAD) {
+		if (uio->uio_resid < sizeof(family)){
+			error = EIO;
+			goto out0;
+		}
+		error = uiomove((void *)&family, sizeof(family), uio);
+		dst.sa_family = ntohl(family);
+	} else {
+#ifdef INET
+		dst.sa_family = AF_INET;
+#endif
+	}
+
+	if (uio->uio_resid > CNICMTU) {
+		CNICDEBUG("%s: len=%lu!\n", ifp->if_xname,
+		    (unsigned long)uio->uio_resid);
+		error = EIO;
+		goto out0;
+	}
+
+	switch (dst.sa_family) {
+#ifdef INET
+	case AF_INET:
+		pktq = ip_pktq;
+		break;
+#endif
+#ifdef INET6
+	case AF_INET6:
+		pktq = ip6_pktq;
+		break;
+#endif
+	default:
+		error = EAFNOSUPPORT;
+		goto out0;
+	}
+
+	tlen = uio->uio_resid;
+
+	/* get a header mbuf */
+	MGETHDR(m, M_DONTWAIT, MT_DATA);
+	if (m == NULL) {
+		error = ENOBUFS;
+		goto out0;
+	}
+	mlen = MHLEN;
+
+	top = NULL;
+	mp = &top;
+	while (error == 0 && uio->uio_resid > 0) {
+		m->m_len = min(mlen, uio->uio_resid);
+		error = uiomove(mtod(m, void *), m->m_len, uio);
+		*mp = m;
+		mp = &m->m_next;
+		if (error == 0 && uio->uio_resid > 0) {
+			MGET(m, M_DONTWAIT, MT_DATA);
+			if (m == NULL) {
+				error = ENOBUFS;
+				break;
+			}
+			mlen = MLEN;
+		}
+	}
+	if (error) {
+		if (top != NULL)
+			m_freem (top);
+		ifp->if_ierrors++;
+		goto out0;
+	}
+
+	top->m_pkthdr.len = tlen;
+	top->m_pkthdr.rcvif = ifp;
+
+	bpf_mtap_af(ifp, dst.sa_family, top);
+
+	s = splnet();
+	mutex_enter(&tp->cnic_lock);
+	if ((tp->cnic_flags & CNIC_INITED) == 0) {
+		/* Interface was destroyed */
+		error = ENXIO;
+		goto out;
+	}
+	if (__predict_false(!pktq_enqueue(pktq, top, 0))) {
+		ifp->if_collisions++;
+		mutex_exit(&tp->cnic_lock);
+		error = ENOBUFS;
+		m_freem(top);
+		goto out_nolock;
+	}
+	ifp->if_ipackets++;
+	ifp->if_ibytes += tlen;
+out:
+	mutex_exit(&tp->cnic_lock);
+out_nolock:
+	splx(s);
+out0:
+	return (error);
+}
+
+#ifdef ALTQ
+/*
+ * Start packet transmission on the interface.
+ * when the interface queue is rate-limited by ALTQ or TBR,
+ * if_start is needed to drain packets from the queue in order
+ * to notify readers when outgoing packets become ready.
+ *
+ * Should be called at splnet.
+ */
+static void
+cnicstart(struct ifnet *ifp)
+{
+	struct cnic_softc *tp = ifp->if_softc;
+
+	if (!ALTQ_IS_ENABLED(&ifp->if_snd) && !TBR_IS_ENABLED(&ifp->if_snd))
+		return;
+
+	mutex_enter(&tp->cnic_lock);
+	if (!IF_IS_EMPTY(&ifp->if_snd)) {
+		if (tp->cnic_flags & CNIC_RWAIT) {
+			tp->cnic_flags &= ~CNIC_RWAIT;
+			wakeup((void *)tp);
+		}
+		if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
+			softint_schedule(tp->cnic_osih);
+
+		selnotify(&tp->cnic_rsel, 0, 0);
+	}
+	mutex_exit(&tp->cnic_lock);
+}
+#endif /* ALTQ */
+/*
+ * cnicpoll - the poll interface, this is only useful on reads
+ * really. The write detect always returns true, write never blocks
+ * anyway, it either accepts the packet or drops it.
+ */
+int
+cnicpoll(dev_t dev, int events, struct lwp *l)
+{
+	struct cnic_softc *tp;
+	struct ifnet	*ifp;
+	int		s, revents = 0;
+
+	s = splnet();
+	tp = cnic_find_unit(dev);
+
+	/* interface was "destroyed" already */
+	if (tp == NULL)
+		goto out_nolock;
+
+	ifp = &tp->cnic_if;
+
+	CNICDEBUG("%s: cnicpoll\n", ifp->if_xname);
+
+	if (events & (POLLIN | POLLRDNORM)) {
+		if (!IFQ_IS_EMPTY(&ifp->if_snd)) {
+			CNICDEBUG("%s: cnicpoll q=%d\n", ifp->if_xname,
+			    ifp->if_snd.ifq_len);
+			revents |= events & (POLLIN | POLLRDNORM);
+		} else {
+			CNICDEBUG("%s: cnicpoll waiting\n", ifp->if_xname);
+			selrecord(l, &tp->cnic_rsel);
+		}
+	}
+
+	if (events & (POLLOUT | POLLWRNORM))
+		revents |= events & (POLLOUT | POLLWRNORM);
+
+	mutex_exit(&tp->cnic_lock);
+out_nolock:
+	splx(s);
+	return (revents);
+}
+
+static void
+filt_cnicrdetach(struct knote *kn)
+{
+	struct cnic_softc *tp = kn->kn_hook;
+	int s;
+
+	s = splnet();
+	SLIST_REMOVE(&tp->cnic_rsel.sel_klist, kn, knote, kn_selnext);
+	splx(s);
+}
+
+static int
+filt_cnicread(struct knote *kn, long hint)
+{
+	struct cnic_softc *tp = kn->kn_hook;
+	struct ifnet *ifp = &tp->cnic_if;
+	struct mbuf *m;
+	int s;
+
+	s = splnet();
+	IF_POLL(&ifp->if_snd, m);
+	if (m == NULL) {
+		splx(s);
+		return (0);
+	}
+
+	for (kn->kn_data = 0; m != NULL; m = m->m_next)
+		kn->kn_data += m->m_len;
+
+	splx(s);
+	return (1);
+}
+
+static const struct filterops cnicread_filtops =
+	{ 1, NULL, filt_cnicrdetach, filt_cnicread };
+
+static const struct filterops cnic_seltrue_filtops =
+	{ 1, NULL, filt_cnicrdetach, filt_seltrue };
+
+int
+cnickqfilter(dev_t dev, struct knote *kn)
+{
+	struct cnic_softc *tp;
+	struct klist *klist;
+	int rv = 0, s;
+
+	s = splnet();
+	tp = cnic_find_unit(dev);
+	if (tp == NULL)
+		goto out_nolock;
+
+	switch (kn->kn_filter) {
+	case EVFILT_READ:
+		klist = &tp->cnic_rsel.sel_klist;
+		kn->kn_fop = &cnicread_filtops;
+		break;
+
+	case EVFILT_WRITE:
+		klist = &tp->cnic_rsel.sel_klist;
+		kn->kn_fop = &cnic_seltrue_filtops;
+		break;
+
+	default:
+		rv = EINVAL;
+		goto out;
+	}
+
+	kn->kn_hook = tp;
+
+	SLIST_INSERT_HEAD(klist, kn, kn_selnext);
+
+out:
+	mutex_exit(&tp->cnic_lock);
+out_nolock:
+	splx(s);
+	return (rv);
+}
diff --git a/sys/net/if_cnic.h b/sys/net/if_cnic.h
new file mode 100644
index 0000000..3dc220c
--- /dev/null
+++ b/sys/net/if_cnic.h
@@ -0,0 +1,44 @@
+#ifndef _NET_IF_CNIC_H_
+#define _NET_IF_CNIC_H_
+
+#ifdef _KERNEL
+struct cnic_softc {
+	struct	ifnet cnic_if;		/* the interface */
+
+	u_short	cnic_flags;		/* misc flags */
+#define	CNIC_OPEN	0x0001
+#define	CNIC_INITED	0x0002
+#define	CNIC_RCOLL	0x0004
+#define	CNIC_IASET	0x0008
+#define	CNIC_DSTADDR	0x0010
+#define	CNIC_RWAIT	0x0040
+#define	CNIC_ASYNC	0x0080
+#define	CNIC_NBIO	0x0100
+#define	CNIC_PREPADDR	0x0200
+#define	CNIC_IFHEAD	0x0400
+
+#define	CNIC_READY	(CNIC_OPEN | CNIC_INITED | CNIC_IASET)
+
+	pid_t	cnic_pgid;		/* PID or process group ID */
+	struct	selinfo	cnic_rsel;	/* read select */
+	struct	selinfo	cnic_wsel;	/* write select (not used) */
+	int	cnic_unit;		/* the tunnel unit number */
+	kmutex_t cnic_lock;		/* lock for this tunnel */
+	LIST_ENTRY(cnic_softc) cnic_list;	/* list of all tuns */
+	void	*cnic_osih;		/* soft interrupt handle */
+	void	*cnic_isih;		/* soft interrupt handle */
+};
+#endif	/* _KERNEL */
+
+/* Maximum packet size */
+#define	CNICMTU		1500
+
+/* ioctl's for get/set debug */
+#define	CNICSDEBUG	_IOW('t', 90, int)
+#define	CNICGDEBUG	_IOR('t', 89, int)
+#define	CNICSIFMODE	_IOW('t', 88, int)
+#define	CNICSLMODE	_IOW('t', 87, int)
+#define	CNICSIFHEAD	_IOW('t', 66, int)
+#define	CNICGIFHEAD	_IOR('t', 65, int)
+
+#endif /* !_NET_IF_TUN_H_ */
diff --git a/sys/rump/net/lib/libtap/Makefile b/sys/rump/net/lib/libtap/Makefile
index ad91b05..012e2c0 100644
--- a/sys/rump/net/lib/libtap/Makefile
+++ b/sys/rump/net/lib/libtap/Makefile
@@ -7,7 +7,7 @@ LIB=	rumpnet_tap
 
 SRCS=	if_tap.c
 #RG addition to support tun devices within tap component
-SRCS+=  if_tun.c
+SRCS+=  if_cnic.c
 
 SRCS+=	tap_component.c
 
diff --git a/sys/rump/net/lib/libtap/tap_component.c b/sys/rump/net/lib/libtap/tap_component.c
index 6672fe6..457e249 100644
--- a/sys/rump/net/lib/libtap/tap_component.c
+++ b/sys/rump/net/lib/libtap/tap_component.c
@@ -41,7 +41,7 @@ __KERNEL_RCSID(0, "$NetBSD: tap_component.c,v 1.1 2015/05/29 12:32:23 pooka Exp
 CFDRIVER_DECL(tap, DV_IFNET, NULL);
 
 void tapattach(int);
-void tunattach(int);
+void cnicattach(int);
 
 RUMP_COMPONENT(RUMP_COMPONENT_NET_IF)
 {
@@ -68,26 +68,26 @@ RUMP_COMPONENT(RUMP_COMPONENT_NET_IF)
 		panic("cannot create tap[0-4] device node: %d", error);
 
 	/* ----- TUN ----- */
-	/* RG: attepting to add tun to the tap component for rump */
+	/* RG: attepting to add cnic to the tap component for rump */
 	rumpuser_dprintf("----- Hello! Greetings from the tap source code! -----\n");
-	rumpuser_dprintf("----- Attempting to make tun device node /dev/tun -----\n");
+	rumpuser_dprintf("----- Attempting to make cnic device node /dev/cnic -----\n");
 
-	extern const struct cdevsw tun_cdevsw;
-	devmajor_t bmaj_tun, cmaj_tun;
+	extern const struct cdevsw cnic_cdevsw;
+	devmajor_t bmaj_cnic, cmaj_cnic;
 
 	//config_cfdriver_attach(&tap_cd);
-	tunattach(0);
+	cnicattach(0);
 
-	bmaj_tun = cmaj_tun = NODEVMAJOR;
-	error = devsw_attach("tun", NULL, &bmaj_tun, &tun_cdevsw, &cmaj_tun);
+	bmaj_cnic = cmaj_cnic = NODEVMAJOR;
+	error = devsw_attach("cnic", NULL, &bmaj_cnic, &cnic_cdevsw, &cmaj_cnic);
 	if (error != 0)
-		panic("tun devsw attach failed: %d", error);
+		panic("cnic devsw attach failed: %d", error);
 
-	error = rump_vfs_makeonedevnode(S_IFCHR, "/dev/tun", cmaj_tun, 0xfffff);
+	error = rump_vfs_makeonedevnode(S_IFCHR, "/dev/cnic", cmaj_cnic, 0xfffff);
 	if (error != 0)
-		panic("cannot create tun device node: %d", error);
+		panic("cannot create cnic device node: %d", error);
 
-	error = rump_vfs_makedevnodes(S_IFCHR, "/dev/tun", '0', cmaj_tun, 0, 4);
+	error = rump_vfs_makedevnodes(S_IFCHR, "/dev/cnic", '0', cmaj_cnic, 0, 4);
 	if (error != 0)
-		panic("cannot create tun[0-4] device node: %d", error);
+		panic("cannot create cnic[0-4] device node: %d", error);
 }
-- 
1.9.1


From c89ecab41358b2b129aa68edbf268eb7e20aa1ac Mon Sep 17 00:00:00 2001
From: lab176 <lbaier176@gmail.com>
Date: Thu, 30 Jun 2016 11:53:35 -0400
Subject: [PATCH 3/7] pulling phani's changes

---
 add_tun.patch                    |   94 +++
 cnic.patch                       | 1252 ++++++++++++++++++++++++++++++++++++++
 sys/rump/librump/rumpkern/rump.c |    4 +-
 3 files changed, 1349 insertions(+), 1 deletion(-)
 create mode 100644 add_tun.patch
 create mode 100644 cnic.patch

diff --git a/add_tun.patch b/add_tun.patch
new file mode 100644
index 0000000..1af771a
--- /dev/null
+++ b/add_tun.patch
@@ -0,0 +1,94 @@
+From f8765d4be9065f7cd3a0760a116b315d2b4ebad9 Mon Sep 17 00:00:00 2001
+From: Robert Gifford <robertgif@gmail.com>
+Date: Fri, 10 Jun 2016 16:45:59 -0400
+Subject: [PATCH] Added tun support
+
+---
+ sys/rump/net/lib/libtap/Makefile        |  2 ++
+ sys/rump/net/lib/libtap/tap_component.c | 39 ++++++++++++++++++++++++++++-----
+ 2 files changed, 36 insertions(+), 5 deletions(-)
+
+diff --git a/sys/rump/net/lib/libtap/Makefile b/sys/rump/net/lib/libtap/Makefile
+index c475477..ad91b05 100644
+--- a/sys/rump/net/lib/libtap/Makefile
++++ b/sys/rump/net/lib/libtap/Makefile
+@@ -6,6 +6,8 @@
+ LIB=	rumpnet_tap
+ 
+ SRCS=	if_tap.c
++#RG addition to support tun devices within tap component
++SRCS+=  if_tun.c
+ 
+ SRCS+=	tap_component.c
+ 
+diff --git a/sys/rump/net/lib/libtap/tap_component.c b/sys/rump/net/lib/libtap/tap_component.c
+index 6d9a1f5..6672fe6 100644
+--- a/sys/rump/net/lib/libtap/tap_component.c
++++ b/sys/rump/net/lib/libtap/tap_component.c
+@@ -36,29 +36,58 @@ __KERNEL_RCSID(0, "$NetBSD: tap_component.c,v 1.1 2015/05/29 12:32:23 pooka Exp
+ #include "rump_net_private.h"
+ #include "rump_vfs_private.h"
+ 
++#include <rump/rumpuser.h>
++
+ CFDRIVER_DECL(tap, DV_IFNET, NULL);
+ 
+ void tapattach(int);
++void tunattach(int);
+ 
+ RUMP_COMPONENT(RUMP_COMPONENT_NET_IF)
+ {
++
++
+ 	extern const struct cdevsw tap_cdevsw;
+-	devmajor_t bmaj, cmaj;
++	devmajor_t bmaj_tap, cmaj_tap;
+ 	int error;
+ 
+ 	config_cfdriver_attach(&tap_cd);
+ 	tapattach(0);
+ 
+-	bmaj = cmaj = NODEVMAJOR;
+-	error = devsw_attach("tap", NULL, &bmaj, &tap_cdevsw, &cmaj);
++	bmaj_tap = cmaj_tap = NODEVMAJOR;
++	error = devsw_attach("tap", NULL, &bmaj_tap, &tap_cdevsw, &cmaj_tap);
+ 	if (error != 0)
+ 		panic("tap devsw attach failed: %d", error);
+ 
+-	error = rump_vfs_makeonedevnode(S_IFCHR, "/dev/tap", cmaj, 0xfffff);
++	error = rump_vfs_makeonedevnode(S_IFCHR, "/dev/tap", cmaj_tap, 0xfffff);
+ 	if (error != 0)
+ 		panic("cannot create tap device node: %d", error);
+ 
+-	error = rump_vfs_makedevnodes(S_IFCHR, "/dev/tap", '0', cmaj, 0, 4);
++	error = rump_vfs_makedevnodes(S_IFCHR, "/dev/tap", '0', cmaj_tap, 0, 4);
+ 	if (error != 0)
+ 		panic("cannot create tap[0-4] device node: %d", error);
++
++	/* ----- TUN ----- */
++	/* RG: attepting to add tun to the tap component for rump */
++	rumpuser_dprintf("----- Hello! Greetings from the tap source code! -----\n");
++	rumpuser_dprintf("----- Attempting to make tun device node /dev/tun -----\n");
++
++	extern const struct cdevsw tun_cdevsw;
++	devmajor_t bmaj_tun, cmaj_tun;
++
++	//config_cfdriver_attach(&tap_cd);
++	tunattach(0);
++
++	bmaj_tun = cmaj_tun = NODEVMAJOR;
++	error = devsw_attach("tun", NULL, &bmaj_tun, &tun_cdevsw, &cmaj_tun);
++	if (error != 0)
++		panic("tun devsw attach failed: %d", error);
++
++	error = rump_vfs_makeonedevnode(S_IFCHR, "/dev/tun", cmaj_tun, 0xfffff);
++	if (error != 0)
++		panic("cannot create tun device node: %d", error);
++
++	error = rump_vfs_makedevnodes(S_IFCHR, "/dev/tun", '0', cmaj_tun, 0, 4);
++	if (error != 0)
++		panic("cannot create tun[0-4] device node: %d", error);
+ }
+-- 
+2.5.0
+
diff --git a/cnic.patch b/cnic.patch
new file mode 100644
index 0000000..56aa728
--- /dev/null
+++ b/cnic.patch
@@ -0,0 +1,1252 @@
+From 7df87509a6db2c3aceda423ec74d6b25dee2b8a8 Mon Sep 17 00:00:00 2001
+From: Robert Gifford <robertgif@gmail.com>
+Date: Fri, 24 Jun 2016 16:38:04 -0400
+Subject: [PATCH] Added cnic device
+
+---
+ sys/net/if_cnic.c                       | 1098 +++++++++++++++++++++++++++++++
+ sys/net/if_cnic.h                       |   44 ++
+ sys/rump/net/lib/libtap/Makefile        |    2 +
+ sys/rump/net/lib/libtap/tap_component.c |   39 +-
+ 4 files changed, 1178 insertions(+), 5 deletions(-)
+ create mode 100644 sys/net/if_cnic.c
+ create mode 100644 sys/net/if_cnic.h
+
+diff --git a/sys/net/if_cnic.c b/sys/net/if_cnic.c
+new file mode 100644
+index 0000000..b3344d9
+--- /dev/null
++++ b/sys/net/if_cnic.c
+@@ -0,0 +1,1098 @@
++/* All rights go the NetBSD, this is simply a copy of if_tun.c with tun namespace replaced with cnic */
++
++#include <sys/cdefs.h>
++
++#include "opt_inet.h"
++
++#include <sys/param.h>
++#include <sys/proc.h>
++#include <sys/systm.h>
++#include <sys/mbuf.h>
++#include <sys/buf.h>
++#include <sys/protosw.h>
++#include <sys/socket.h>
++#include <sys/ioctl.h>
++#include <sys/errno.h>
++#include <sys/syslog.h>
++#include <sys/select.h>
++#include <sys/poll.h>
++#include <sys/file.h>
++#include <sys/signalvar.h>
++#include <sys/conf.h>
++#include <sys/kauth.h>
++#include <sys/mutex.h>
++#include <sys/cpu.h>
++
++#include <net/if.h>
++#include <net/if_types.h>
++#include <net/netisr.h>
++#include <net/route.h>
++
++
++#ifdef INET
++#include <netinet/in.h>
++#include <netinet/in_systm.h>
++#include <netinet/in_var.h>
++#include <netinet/ip.h>
++#include <netinet/if_inarp.h>
++#endif
++
++
++#include <sys/time.h>
++#include <net/bpf.h>
++
++#include <net/if_cnic.h>
++
++#define CNICDEBUG	if (cnicdebug) printf
++int	cnicdebug = 0;
++
++extern int ifqmaxlen;
++void	cnicattach(int);
++
++static LIST_HEAD(, cnic_softc) cnic_softc_list;
++static LIST_HEAD(, cnic_softc) cnicz_softc_list;
++static kmutex_t cnic_softc_lock;
++
++static int	cnic_ioctl(struct ifnet *, u_long, void *);
++static int	cnic_output(struct ifnet *, struct mbuf *,
++			const struct sockaddr *, struct rtentry *rt);
++static int	cnic_clone_create(struct if_clone *, int);
++static int	cnic_clone_destroy(struct ifnet *);
++
++static struct if_clone cnic_cloner =
++    IF_CLONE_INITIALIZER("cnic", cnic_clone_create, cnic_clone_destroy);
++
++static void cnicattach0(struct cnic_softc *);
++static void cnicinit(struct cnic_softc *);
++static void cnic_i_softintr(void *);
++static void cnic_o_softintr(void *);
++#ifdef ALTQ
++static void cnicstart(struct ifnet *);
++#endif
++static struct cnic_softc *cnic_find_unit(dev_t);
++static struct cnic_softc *cnic_find_zunit(int);
++
++static dev_type_open(cnicopen);
++static dev_type_close(cnicclose);
++static dev_type_read(cnicread);
++static dev_type_write(cnicwrite);
++static dev_type_ioctl(cnicioctl);
++static dev_type_poll(cnicpoll);
++static dev_type_kqfilter(cnickqfilter);
++
++const struct cdevsw cnic_cdevsw = {
++	.d_open = cnicopen,
++	.d_close = cnicclose,
++	.d_read = cnicread,
++	.d_write = cnicwrite,
++	.d_ioctl = cnicioctl,
++	.d_stop = nostop,
++	.d_tty = notty,
++	.d_poll = cnicpoll,
++	.d_mmap = nommap,
++	.d_kqfilter = cnickqfilter,
++	.d_discard = nodiscard,
++	.d_flag = D_OTHER
++};
++
++void
++cnicattach(int unused)
++{
++
++	mutex_init(&cnic_softc_lock, MUTEX_DEFAULT, IPL_NET);
++	LIST_INIT(&cnic_softc_list);
++	LIST_INIT(&cnicz_softc_list);
++	if_clone_attach(&cnic_cloner);
++}
++
++/*
++ * Find driver instance from dev_t.
++ * Returns with tp locked (if found).
++ */
++static struct cnic_softc *
++cnic_find_unit(dev_t dev)
++{
++	struct cnic_softc *tp;
++	int unit = minor(dev);
++
++	mutex_enter(&cnic_softc_lock);
++	LIST_FOREACH(tp, &cnic_softc_list, cnic_list)
++		if (unit == tp->cnic_unit)
++			break;
++	if (tp)
++		mutex_enter(&tp->cnic_lock);
++	mutex_exit(&cnic_softc_lock);
++
++	return (tp);
++}
++
++/*
++ * Find zombie driver instance by unit number.
++ * Remove tp from list and return it unlocked (if found).
++ */
++static struct cnic_softc *
++cnic_find_zunit(int unit)
++{
++	struct cnic_softc *tp;
++
++	mutex_enter(&cnic_softc_lock);
++	LIST_FOREACH(tp, &cnicz_softc_list, cnic_list)
++		if (unit == tp->cnic_unit)
++			break;
++	if (tp)
++		LIST_REMOVE(tp, cnic_list);
++	mutex_exit(&cnic_softc_lock);
++#ifdef DIAGNOSTIC
++	if (tp != NULL && (tp->cnic_flags & (CNIC_INITED|CNIC_OPEN)) != CNIC_OPEN)
++		printf("cnic%d: inconsistent flags: %x\n", unit, tp->cnic_flags);
++#endif
++
++	return (tp);
++}
++
++static int
++cnic_clone_create(struct if_clone *ifc, int unit)
++{
++	struct cnic_softc *tp;
++
++	if ((tp = cnic_find_zunit(unit)) == NULL) {
++		/* Allocate a new instance */
++		tp = malloc(sizeof(*tp), M_DEVBUF, M_WAITOK|M_ZERO);
++
++		tp->cnic_unit = unit;
++		mutex_init(&tp->cnic_lock, MUTEX_DEFAULT, IPL_NET);
++		selinit(&tp->cnic_rsel);
++		selinit(&tp->cnic_wsel);
++	} else {
++		/* Revive cnicnel instance; clear ifp part */
++		(void)memset(&tp->cnic_if, 0, sizeof(struct ifnet));
++	}
++
++	if_initname(&tp->cnic_if, ifc->ifc_name, unit);
++	cnicattach0(tp);
++	tp->cnic_flags |= CNIC_INITED;
++	tp->cnic_osih = softint_establish(SOFTINT_CLOCK, cnic_o_softintr, tp);
++	tp->cnic_isih = softint_establish(SOFTINT_CLOCK, cnic_i_softintr, tp);
++
++	mutex_enter(&cnic_softc_lock);
++	LIST_INSERT_HEAD(&cnic_softc_list, tp, cnic_list);
++	mutex_exit(&cnic_softc_lock);
++
++	return (0);
++}
++
++static void
++cnicattach0(struct cnic_softc *tp)
++{
++	struct ifnet *ifp;
++
++	ifp = &tp->cnic_if;
++	ifp->if_softc = tp;
++	ifp->if_mtu = CNICMTU;
++	ifp->if_ioctl = cnic_ioctl;
++	ifp->if_output = cnic_output;
++#ifdef ALTQ
++	ifp->if_start = cnicstart;
++#endif
++	ifp->if_flags = IFF_POINTOPOINT;
++	ifp->if_type = IFT_TUNNEL;
++	ifp->if_snd.ifq_maxlen = ifqmaxlen;
++	ifp->if_collisions = 0;
++	ifp->if_ierrors = 0;
++	ifp->if_oerrors = 0;
++	ifp->if_ipackets = 0;
++	ifp->if_opackets = 0;
++	ifp->if_ibytes   = 0;
++	ifp->if_obytes   = 0;
++	ifp->if_dlt = DLT_NULL;
++	IFQ_SET_READY(&ifp->if_snd);
++	if_attach(ifp);
++	if_alloc_sadl(ifp);
++	bpf_attach(ifp, DLT_NULL, sizeof(uint32_t));
++}
++
++static int
++cnic_clone_destroy(struct ifnet *ifp)
++{
++	struct cnic_softc *tp = (void *)ifp;
++	int zombie = 0;
++
++	IF_PURGE(&ifp->if_snd);
++	ifp->if_flags &= ~IFF_RUNNING;
++
++	mutex_enter(&cnic_softc_lock);
++	mutex_enter(&tp->cnic_lock);
++	LIST_REMOVE(tp, cnic_list);
++	if (tp->cnic_flags & CNIC_OPEN) {
++		/* Hang on to storage until last close */
++		zombie = 1;
++		tp->cnic_flags &= ~CNIC_INITED;
++		LIST_INSERT_HEAD(&cnicz_softc_list, tp, cnic_list);
++	}
++	mutex_exit(&cnic_softc_lock);
++
++	if (tp->cnic_flags & CNIC_RWAIT) {
++		tp->cnic_flags &= ~CNIC_RWAIT;
++		wakeup((void *)tp);
++	}
++	selnotify(&tp->cnic_rsel, 0, 0);
++
++	mutex_exit(&tp->cnic_lock);
++
++	if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
++		fownsignal(tp->cnic_pgid, SIGIO, POLL_HUP, 0, NULL);
++
++	bpf_detach(ifp);
++	if_detach(ifp);
++
++	if (!zombie) {
++		seldestroy(&tp->cnic_rsel);
++		seldestroy(&tp->cnic_wsel);
++		softint_disestablish(tp->cnic_osih);
++		softint_disestablish(tp->cnic_isih);
++		mutex_destroy(&tp->cnic_lock);
++		free(tp, M_DEVBUF);
++	}
++
++	return (0);
++}
++
++/*
++ * cnicnel open - must be superuser & the device must be
++ * configured in
++ */
++static int
++cnicopen(dev_t dev, int flag, int mode, struct lwp *l)
++{
++	struct ifnet	*ifp;
++	struct cnic_softc *tp;
++	int	error;
++
++	error = kauth_authorize_network(l->l_cred, KAUTH_NETWORK_INTERFACE_TUN,
++	    KAUTH_REQ_NETWORK_INTERFACE_TUN_ADD, NULL, NULL, NULL);
++	if (error)
++		return (error);
++
++	tp = cnic_find_unit(dev);
++
++	if (tp == NULL) {
++		(void)cnic_clone_create(&cnic_cloner, minor(dev));
++		tp = cnic_find_unit(dev);
++		if (tp == NULL) {
++			error = ENXIO;
++			goto out_nolock;
++		}
++	}
++
++	if (tp->cnic_flags & CNIC_OPEN) {
++		error = EBUSY;
++		goto out;
++	}
++
++	ifp = &tp->cnic_if;
++	tp->cnic_flags |= CNIC_OPEN;
++	CNICDEBUG("%s: open\n", ifp->if_xname);
++out:
++	mutex_exit(&tp->cnic_lock);
++out_nolock:
++	return (error);
++}
++
++/*
++ * cnicclose - close the device - mark i/f down & delete
++ * routing info
++ */
++int
++cnicclose(dev_t dev, int flag, int mode,
++    struct lwp *l)
++{
++	struct cnic_softc *tp;
++	struct ifnet	*ifp;
++
++	if ((tp = cnic_find_zunit(minor(dev))) != NULL) {
++		/* interface was "destroyed" before the close */
++		seldestroy(&tp->cnic_rsel);
++		seldestroy(&tp->cnic_wsel);
++		softint_disestablish(tp->cnic_osih);
++		softint_disestablish(tp->cnic_isih);
++		mutex_destroy(&tp->cnic_lock);
++		free(tp, M_DEVBUF);
++		goto out_nolock;
++	}
++
++	if ((tp = cnic_find_unit(dev)) == NULL)
++		goto out_nolock;
++
++	ifp = &tp->cnic_if;
++
++	tp->cnic_flags &= ~CNIC_OPEN;
++
++	tp->cnic_pgid = 0;
++	selnotify(&tp->cnic_rsel, 0, 0);
++
++	CNICDEBUG ("%s: closed\n", ifp->if_xname);
++	mutex_exit(&tp->cnic_lock);
++
++	/*
++	 * junk all pending output
++	 */
++	IFQ_PURGE(&ifp->if_snd);
++
++	if (ifp->if_flags & IFF_UP) {
++		if_down(ifp);
++		if (ifp->if_flags & IFF_RUNNING) {
++			/* find internet addresses and delete routes */
++			struct ifaddr *ifa;
++			IFADDR_FOREACH(ifa, ifp) {
++#if defined(INET) || defined(INET6)
++				if (ifa->ifa_addr->sa_family == AF_INET ||
++				    ifa->ifa_addr->sa_family == AF_INET6) {
++					rtinit(ifa, (int)RTM_DELETE,
++					       tp->cnic_flags & CNIC_DSTADDR
++							? RTF_HOST
++							: 0);
++				}
++#endif
++			}
++		}
++	}
++out_nolock:
++	return (0);
++}
++
++/*
++ * Call at splnet().
++ */
++static void
++cnicinit(struct cnic_softc *tp)
++{
++	struct ifnet	*ifp = &tp->cnic_if;
++	struct ifaddr	*ifa;
++
++	CNICDEBUG("%s: cnicinit\n", ifp->if_xname);
++
++	mutex_enter(&tp->cnic_lock);
++	ifp->if_flags |= IFF_UP | IFF_RUNNING;
++
++	tp->cnic_flags &= ~(CNIC_IASET|CNIC_DSTADDR);
++	IFADDR_FOREACH(ifa, ifp) {
++#ifdef INET
++		if (ifa->ifa_addr->sa_family == AF_INET) {
++			struct sockaddr_in *sin;
++
++			sin = satosin(ifa->ifa_addr);
++			if (sin && sin->sin_addr.s_addr)
++				tp->cnic_flags |= CNIC_IASET;
++
++			if (ifp->if_flags & IFF_POINTOPOINT) {
++				sin = satosin(ifa->ifa_dstaddr);
++				if (sin && sin->sin_addr.s_addr)
++					tp->cnic_flags |= CNIC_DSTADDR;
++			}
++		}
++#endif
++#ifdef INET6
++		if (ifa->ifa_addr->sa_family == AF_INET6) {
++			struct sockaddr_in6 *sin;
++
++			sin = (struct sockaddr_in6 *)ifa->ifa_addr;
++			if (!IN6_IS_ADDR_UNSPECIFIED(&sin->sin6_addr))
++				tp->cnic_flags |= CNIC_IASET;
++
++			if (ifp->if_flags & IFF_POINTOPOINT) {
++				sin = (struct sockaddr_in6 *)ifa->ifa_dstaddr;
++				if (sin &&
++				    !IN6_IS_ADDR_UNSPECIFIED(&sin->sin6_addr))
++					tp->cnic_flags |= CNIC_DSTADDR;
++			} else
++				tp->cnic_flags &= ~CNIC_DSTADDR;
++		}
++#endif /* INET6 */
++	}
++	mutex_exit(&tp->cnic_lock);
++}
++
++/*
++ * Process an ioctl request.
++ */
++static int
++cnic_ioctl(struct ifnet *ifp, u_long cmd, void *data)
++{
++	int		error = 0, s;
++	struct cnic_softc *tp = (struct cnic_softc *)(ifp->if_softc);
++	struct ifreq *ifr = (struct ifreq *)data;
++	struct ifaddr *ifa = (struct ifaddr *)data;
++
++	s = splnet();
++
++	switch (cmd) {
++	case SIOCINITIFADDR:
++		cnicinit(tp);
++		ifa->ifa_rtrequest = p2p_rtrequest;
++		CNICDEBUG("%s: address set\n", ifp->if_xname);
++		break;
++	case SIOCSIFBRDADDR:
++		CNICDEBUG("%s: broadcast address set\n", ifp->if_xname);
++		break;
++	case SIOCSIFMTU:
++		if (ifr->ifr_mtu > CNICMTU || ifr->ifr_mtu < 576) {
++			error = EINVAL;
++			break;
++		}
++		CNICDEBUG("%s: interface mtu set\n", ifp->if_xname);
++		if ((error = ifioctl_common(ifp, cmd, data)) == ENETRESET)
++			error = 0;
++		break;
++	case SIOCADDMULTI:
++	case SIOCDELMULTI:
++		if (ifr == NULL) {
++	        	error = EAFNOSUPPORT;           /* XXX */
++			break;
++		}
++		switch (ifreq_getaddr(cmd, ifr)->sa_family) {
++#ifdef INET
++		case AF_INET:
++			break;
++#endif
++#ifdef INET6
++		case AF_INET6:
++			break;
++#endif
++		default:
++			error = EAFNOSUPPORT;
++			break;
++		}
++		break;
++	default:
++		error = ifioctl_common(ifp, cmd, data);
++	}
++
++	splx(s);
++	return (error);
++}
++
++/*
++ * cnic_output - queue packets from higher level ready to put out.
++ */
++static int
++cnic_output(struct ifnet *ifp, struct mbuf *m0, const struct sockaddr *dst,
++    struct rtentry *rt)
++{
++	struct cnic_softc *tp = ifp->if_softc;
++	int		s;
++	int		error;
++#if defined(INET) || defined(INET6)
++	int		mlen;
++	uint32_t	*af;
++#endif
++	ALTQ_DECL(struct altq_pktattr pktattr;)
++
++	s = splnet();
++	mutex_enter(&tp->cnic_lock);
++	CNICDEBUG ("%s: cnic_output\n", ifp->if_xname);
++
++	if ((tp->cnic_flags & CNIC_READY) != CNIC_READY) {
++		CNICDEBUG ("%s: not ready 0%o\n", ifp->if_xname,
++			  tp->cnic_flags);
++		error = EHOSTDOWN;
++		goto out;
++	}
++
++	/*
++	 * if the queueing discipline needs packet classification,
++	 * do it before prepending link headers.
++	 */
++	IFQ_CLASSIFY(&ifp->if_snd, m0, dst->sa_family, &pktattr);
++
++	bpf_mtap_af(ifp, dst->sa_family, m0);
++
++	switch(dst->sa_family) {
++#ifdef INET6
++	case AF_INET6:
++#endif
++#ifdef INET
++	case AF_INET:
++#endif
++#if defined(INET) || defined(INET6)
++		if (tp->cnic_flags & CNIC_PREPADDR) {
++			/* Simple link-layer header */
++			M_PREPEND(m0, dst->sa_len, M_DONTWAIT);
++			if (m0 == NULL) {
++				IF_DROP(&ifp->if_snd);
++				error = ENOBUFS;
++				goto out;
++			}
++			bcopy(dst, mtod(m0, char *), dst->sa_len);
++		}
++
++		if (tp->cnic_flags & CNIC_IFHEAD) {
++			/* Prepend the address family */
++			M_PREPEND(m0, sizeof(*af), M_DONTWAIT);
++			if (m0 == NULL) {
++				IF_DROP(&ifp->if_snd);
++				error = ENOBUFS;
++				goto out;
++			}
++			af = mtod(m0,uint32_t *);
++			*af = htonl(dst->sa_family);
++		} else {
++#ifdef INET
++			if (dst->sa_family != AF_INET)
++#endif
++			{
++				error = EAFNOSUPPORT;
++				goto out;
++			}
++		}
++		/* FALLTHROUGH */
++	case AF_UNSPEC:
++		IFQ_ENQUEUE(&ifp->if_snd, m0, &pktattr, error);
++		if (error) {
++			ifp->if_collisions++;
++			error = EAFNOSUPPORT;
++			m0 = NULL;
++			goto out;
++		}
++		mlen = m0->m_pkthdr.len;
++		ifp->if_opackets++;
++		ifp->if_obytes += mlen;
++		break;
++#endif
++	default:
++		error = EAFNOSUPPORT;
++		goto out;
++	}
++
++	if (tp->cnic_flags & CNIC_RWAIT) {
++		tp->cnic_flags &= ~CNIC_RWAIT;
++		wakeup((void *)tp);
++	}
++	if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
++		softint_schedule(tp->cnic_isih);
++
++	selnotify(&tp->cnic_rsel, 0, 0);
++out:
++	mutex_exit(&tp->cnic_lock);
++	splx(s);
++
++	if (error && m0) {
++		m_freem(m0);
++	}
++	return 0;
++}
++
++static void
++cnic_i_softintr(void *cookie)
++{
++	struct cnic_softc *tp = cookie;
++
++	if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
++		fownsignal(tp->cnic_pgid, SIGIO, POLL_IN, POLLIN|POLLRDNORM,
++		    NULL);
++}
++
++static void
++cnic_o_softintr(void *cookie)
++{
++	struct cnic_softc *tp = cookie;
++
++	if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
++		fownsignal(tp->cnic_pgid, SIGIO, POLL_OUT, POLLOUT|POLLWRNORM,
++		    NULL);
++}
++
++/*
++ * the cdevsw interface is now pretty minimal.
++ */
++int
++cnicioctl(dev_t dev, u_long cmd, void *data, int flag, struct lwp *l)
++{
++	struct cnic_softc *tp;
++	int s, error = 0;
++
++	s = splnet();
++	tp = cnic_find_unit(dev);
++
++	/* interface was "destroyed" already */
++	if (tp == NULL) {
++		error = ENXIO;
++		goto out_nolock;
++	}
++
++	switch (cmd) {
++	case CNICSDEBUG:
++		cnicdebug = *(int *)data;
++		break;
++
++	case CNICGDEBUG:
++		*(int *)data = cnicdebug;
++		break;
++
++	case CNICSIFMODE:
++		switch (*(int *)data & (IFF_POINTOPOINT|IFF_BROADCAST)) {
++		case IFF_POINTOPOINT:
++		case IFF_BROADCAST:
++			if (tp->cnic_if.if_flags & IFF_UP) {
++				error = EBUSY;
++				goto out;
++			}
++			tp->cnic_if.if_flags &=
++				~(IFF_BROADCAST|IFF_POINTOPOINT|IFF_MULTICAST);
++			tp->cnic_if.if_flags |= *(int *)data;
++			break;
++		default:
++			error = EINVAL;
++			goto out;
++		}
++		break;
++
++	case CNICSLMODE:
++		if (*(int *)data) {
++			tp->cnic_flags |= CNIC_PREPADDR;
++			tp->cnic_flags &= ~CNIC_IFHEAD;
++		} else
++			tp->cnic_flags &= ~CNIC_PREPADDR;
++		break;
++
++	case CNICSIFHEAD:
++		if (*(int *)data) {
++			tp->cnic_flags |= CNIC_IFHEAD;
++			tp->cnic_flags &= ~CNIC_PREPADDR;
++		} else
++			tp->cnic_flags &= ~CNIC_IFHEAD;
++		break;
++
++	case CNICGIFHEAD:
++		*(int *)data = (tp->cnic_flags & CNIC_IFHEAD);
++		break;
++
++	case FIONBIO:
++		if (*(int *)data)
++			tp->cnic_flags |= CNIC_NBIO;
++		else
++			tp->cnic_flags &= ~CNIC_NBIO;
++		break;
++
++	case FIOASYNC:
++		if (*(int *)data)
++			tp->cnic_flags |= CNIC_ASYNC;
++		else
++			tp->cnic_flags &= ~CNIC_ASYNC;
++		break;
++
++	case FIONREAD:
++		if (tp->cnic_if.if_snd.ifq_head)
++			*(int *)data = tp->cnic_if.if_snd.ifq_head->m_pkthdr.len;
++		else
++			*(int *)data = 0;
++		break;
++
++	case TIOCSPGRP:
++	case FIOSETOWN:
++		error = fsetown(&tp->cnic_pgid, cmd, data);
++		break;
++
++	case TIOCGPGRP:
++	case FIOGETOWN:
++		error = fgetown(tp->cnic_pgid, cmd, data);
++		break;
++
++	default:
++		error = ENOTTY;
++	}
++
++out:
++	mutex_exit(&tp->cnic_lock);
++out_nolock:
++	splx(s);
++	return (error);
++}
++
++/*
++ * The cdevsw read interface - reads a packet at a time, or at
++ * least as much of a packet as can be read.
++ */
++int
++cnicread(dev_t dev, struct uio *uio, int ioflag)
++{
++	struct cnic_softc *tp;
++	struct ifnet	*ifp;
++	struct mbuf	*m, *m0;
++	int		error = 0, len, s, index;
++
++	s = splnet();
++	tp = cnic_find_unit(dev);
++
++	/* interface was "destroyed" already */
++	if (tp == NULL) {
++		error = ENXIO;
++		goto out_nolock;
++	}
++
++	index = tp->cnic_if.if_index;
++	ifp = &tp->cnic_if;
++
++	CNICDEBUG ("%s: read\n", ifp->if_xname);
++	if ((tp->cnic_flags & CNIC_READY) != CNIC_READY) {
++		CNICDEBUG ("%s: not ready 0%o\n", ifp->if_xname, tp->cnic_flags);
++		error = EHOSTDOWN;
++		goto out;
++	}
++
++	tp->cnic_flags &= ~CNIC_RWAIT;
++
++	do {
++		IFQ_DEQUEUE(&ifp->if_snd, m0);
++		if (m0 == 0) {
++			if (tp->cnic_flags & CNIC_NBIO) {
++				error = EWOULDBLOCK;
++				goto out;
++			}
++			tp->cnic_flags |= CNIC_RWAIT;
++			if (mtsleep((void *)tp, PZERO|PCATCH|PNORELOCK,
++					"cnicread", 0, &tp->cnic_lock) != 0) {
++				error = EINTR;
++				goto out_nolock;
++			} else {
++				/*
++				 * Maybe the interface was destroyed while
++				 * we were sleeping, so let's ensure that
++				 * we're looking at the same (valid) cnic
++				 * interface before looping.
++				 */
++				tp = cnic_find_unit(dev);
++				if (tp == NULL) {
++					error = ENXIO;
++					goto out_nolock;
++				}
++				if (tp->cnic_if.if_index != index) {
++					error = ENXIO;
++					goto out;
++				}
++			}
++		}
++	} while (m0 == 0);
++
++	mutex_exit(&tp->cnic_lock);
++	splx(s);
++
++	/* Copy the mbuf chain */
++	while (m0 && uio->uio_resid > 0 && error == 0) {
++		len = min(uio->uio_resid, m0->m_len);
++		if (len != 0)
++			error = uiomove(mtod(m0, void *), len, uio);
++		MFREE(m0, m);
++		m0 = m;
++	}
++
++	if (m0) {
++		CNICDEBUG("Dropping mbuf\n");
++		m_freem(m0);
++	}
++	if (error)
++		ifp->if_ierrors++;
++
++	return (error);
++
++out:
++	mutex_exit(&tp->cnic_lock);
++out_nolock:
++	splx(s);
++	return (error);
++}
++
++/*
++ * the cdevsw write interface - an atomic write is a packet - or else!
++ */
++int
++cnicwrite(dev_t dev, struct uio *uio, int ioflag)
++{
++	struct cnic_softc *tp;
++	struct ifnet	*ifp;
++	struct mbuf	*top, **mp, *m;
++	pktqueue_t	*pktq;
++	struct sockaddr	dst;
++	int		error = 0, s, tlen, mlen;
++	uint32_t	family;
++
++	s = splnet();
++	tp = cnic_find_unit(dev);
++
++	/* interface was "destroyed" already */
++	if (tp == NULL) {
++		error = ENXIO;
++		goto out_nolock;
++	}
++
++	/* Unlock until we've got the data */
++	mutex_exit(&tp->cnic_lock);
++	splx(s);
++
++	ifp = &tp->cnic_if;
++
++	CNICDEBUG("%s: cnicwrite\n", ifp->if_xname);
++
++	if (tp->cnic_flags & CNIC_PREPADDR) {
++		if (uio->uio_resid < sizeof(dst)) {
++			error = EIO;
++			goto out0;
++		}
++		error = uiomove((void *)&dst, sizeof(dst), uio);
++		if (dst.sa_len > sizeof(dst)) {
++			/* Duh.. */
++			char discard;
++			int n = dst.sa_len - sizeof(dst);
++			while (n--)
++				if ((error = uiomove(&discard, 1, uio)) != 0) {
++					goto out0;
++				}
++		}
++	} else if (tp->cnic_flags & CNIC_IFHEAD) {
++		if (uio->uio_resid < sizeof(family)){
++			error = EIO;
++			goto out0;
++		}
++		error = uiomove((void *)&family, sizeof(family), uio);
++		dst.sa_family = ntohl(family);
++	} else {
++#ifdef INET
++		dst.sa_family = AF_INET;
++#endif
++	}
++
++	if (uio->uio_resid > CNICMTU) {
++		CNICDEBUG("%s: len=%lu!\n", ifp->if_xname,
++		    (unsigned long)uio->uio_resid);
++		error = EIO;
++		goto out0;
++	}
++
++	switch (dst.sa_family) {
++#ifdef INET
++	case AF_INET:
++		pktq = ip_pktq;
++		break;
++#endif
++#ifdef INET6
++	case AF_INET6:
++		pktq = ip6_pktq;
++		break;
++#endif
++	default:
++		error = EAFNOSUPPORT;
++		goto out0;
++	}
++
++	tlen = uio->uio_resid;
++
++	/* get a header mbuf */
++	MGETHDR(m, M_DONTWAIT, MT_DATA);
++	if (m == NULL) {
++		error = ENOBUFS;
++		goto out0;
++	}
++	mlen = MHLEN;
++
++	top = NULL;
++	mp = &top;
++	while (error == 0 && uio->uio_resid > 0) {
++		m->m_len = min(mlen, uio->uio_resid);
++		error = uiomove(mtod(m, void *), m->m_len, uio);
++		*mp = m;
++		mp = &m->m_next;
++		if (error == 0 && uio->uio_resid > 0) {
++			MGET(m, M_DONTWAIT, MT_DATA);
++			if (m == NULL) {
++				error = ENOBUFS;
++				break;
++			}
++			mlen = MLEN;
++		}
++	}
++	if (error) {
++		if (top != NULL)
++			m_freem (top);
++		ifp->if_ierrors++;
++		goto out0;
++	}
++
++	top->m_pkthdr.len = tlen;
++	top->m_pkthdr.rcvif = ifp;
++
++	bpf_mtap_af(ifp, dst.sa_family, top);
++
++	s = splnet();
++	mutex_enter(&tp->cnic_lock);
++	if ((tp->cnic_flags & CNIC_INITED) == 0) {
++		/* Interface was destroyed */
++		error = ENXIO;
++		goto out;
++	}
++	if (__predict_false(!pktq_enqueue(pktq, top, 0))) {
++		ifp->if_collisions++;
++		mutex_exit(&tp->cnic_lock);
++		error = ENOBUFS;
++		m_freem(top);
++		goto out_nolock;
++	}
++	ifp->if_ipackets++;
++	ifp->if_ibytes += tlen;
++out:
++	mutex_exit(&tp->cnic_lock);
++out_nolock:
++	splx(s);
++out0:
++	return (error);
++}
++
++#ifdef ALTQ
++/*
++ * Start packet transmission on the interface.
++ * when the interface queue is rate-limited by ALTQ or TBR,
++ * if_start is needed to drain packets from the queue in order
++ * to notify readers when outgoing packets become ready.
++ *
++ * Should be called at splnet.
++ */
++static void
++cnicstart(struct ifnet *ifp)
++{
++	struct cnic_softc *tp = ifp->if_softc;
++
++	if (!ALTQ_IS_ENABLED(&ifp->if_snd) && !TBR_IS_ENABLED(&ifp->if_snd))
++		return;
++
++	mutex_enter(&tp->cnic_lock);
++	if (!IF_IS_EMPTY(&ifp->if_snd)) {
++		if (tp->cnic_flags & CNIC_RWAIT) {
++			tp->cnic_flags &= ~CNIC_RWAIT;
++			wakeup((void *)tp);
++		}
++		if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
++			softint_schedule(tp->cnic_osih);
++
++		selnotify(&tp->cnic_rsel, 0, 0);
++	}
++	mutex_exit(&tp->cnic_lock);
++}
++#endif /* ALTQ */
++/*
++ * cnicpoll - the poll interface, this is only useful on reads
++ * really. The write detect always returns true, write never blocks
++ * anyway, it either accepts the packet or drops it.
++ */
++int
++cnicpoll(dev_t dev, int events, struct lwp *l)
++{
++	struct cnic_softc *tp;
++	struct ifnet	*ifp;
++	int		s, revents = 0;
++
++	s = splnet();
++	tp = cnic_find_unit(dev);
++
++	/* interface was "destroyed" already */
++	if (tp == NULL)
++		goto out_nolock;
++
++	ifp = &tp->cnic_if;
++
++	CNICDEBUG("%s: cnicpoll\n", ifp->if_xname);
++
++	if (events & (POLLIN | POLLRDNORM)) {
++		if (!IFQ_IS_EMPTY(&ifp->if_snd)) {
++			CNICDEBUG("%s: cnicpoll q=%d\n", ifp->if_xname,
++			    ifp->if_snd.ifq_len);
++			revents |= events & (POLLIN | POLLRDNORM);
++		} else {
++			CNICDEBUG("%s: cnicpoll waiting\n", ifp->if_xname);
++			selrecord(l, &tp->cnic_rsel);
++		}
++	}
++
++	if (events & (POLLOUT | POLLWRNORM))
++		revents |= events & (POLLOUT | POLLWRNORM);
++
++	mutex_exit(&tp->cnic_lock);
++out_nolock:
++	splx(s);
++	return (revents);
++}
++
++static void
++filt_cnicrdetach(struct knote *kn)
++{
++	struct cnic_softc *tp = kn->kn_hook;
++	int s;
++
++	s = splnet();
++	SLIST_REMOVE(&tp->cnic_rsel.sel_klist, kn, knote, kn_selnext);
++	splx(s);
++}
++
++static int
++filt_cnicread(struct knote *kn, long hint)
++{
++	struct cnic_softc *tp = kn->kn_hook;
++	struct ifnet *ifp = &tp->cnic_if;
++	struct mbuf *m;
++	int s;
++
++	s = splnet();
++	IF_POLL(&ifp->if_snd, m);
++	if (m == NULL) {
++		splx(s);
++		return (0);
++	}
++
++	for (kn->kn_data = 0; m != NULL; m = m->m_next)
++		kn->kn_data += m->m_len;
++
++	splx(s);
++	return (1);
++}
++
++static const struct filterops cnicread_filtops =
++	{ 1, NULL, filt_cnicrdetach, filt_cnicread };
++
++static const struct filterops cnic_seltrue_filtops =
++	{ 1, NULL, filt_cnicrdetach, filt_seltrue };
++
++int
++cnickqfilter(dev_t dev, struct knote *kn)
++{
++	struct cnic_softc *tp;
++	struct klist *klist;
++	int rv = 0, s;
++
++	s = splnet();
++	tp = cnic_find_unit(dev);
++	if (tp == NULL)
++		goto out_nolock;
++
++	switch (kn->kn_filter) {
++	case EVFILT_READ:
++		klist = &tp->cnic_rsel.sel_klist;
++		kn->kn_fop = &cnicread_filtops;
++		break;
++
++	case EVFILT_WRITE:
++		klist = &tp->cnic_rsel.sel_klist;
++		kn->kn_fop = &cnic_seltrue_filtops;
++		break;
++
++	default:
++		rv = EINVAL;
++		goto out;
++	}
++
++	kn->kn_hook = tp;
++
++	SLIST_INSERT_HEAD(klist, kn, kn_selnext);
++
++out:
++	mutex_exit(&tp->cnic_lock);
++out_nolock:
++	splx(s);
++	return (rv);
++}
+diff --git a/sys/net/if_cnic.h b/sys/net/if_cnic.h
+new file mode 100644
+index 0000000..3dc220c
+--- /dev/null
++++ b/sys/net/if_cnic.h
+@@ -0,0 +1,44 @@
++#ifndef _NET_IF_CNIC_H_
++#define _NET_IF_CNIC_H_
++
++#ifdef _KERNEL
++struct cnic_softc {
++	struct	ifnet cnic_if;		/* the interface */
++
++	u_short	cnic_flags;		/* misc flags */
++#define	CNIC_OPEN	0x0001
++#define	CNIC_INITED	0x0002
++#define	CNIC_RCOLL	0x0004
++#define	CNIC_IASET	0x0008
++#define	CNIC_DSTADDR	0x0010
++#define	CNIC_RWAIT	0x0040
++#define	CNIC_ASYNC	0x0080
++#define	CNIC_NBIO	0x0100
++#define	CNIC_PREPADDR	0x0200
++#define	CNIC_IFHEAD	0x0400
++
++#define	CNIC_READY	(CNIC_OPEN | CNIC_INITED | CNIC_IASET)
++
++	pid_t	cnic_pgid;		/* PID or process group ID */
++	struct	selinfo	cnic_rsel;	/* read select */
++	struct	selinfo	cnic_wsel;	/* write select (not used) */
++	int	cnic_unit;		/* the tunnel unit number */
++	kmutex_t cnic_lock;		/* lock for this tunnel */
++	LIST_ENTRY(cnic_softc) cnic_list;	/* list of all tuns */
++	void	*cnic_osih;		/* soft interrupt handle */
++	void	*cnic_isih;		/* soft interrupt handle */
++};
++#endif	/* _KERNEL */
++
++/* Maximum packet size */
++#define	CNICMTU		1500
++
++/* ioctl's for get/set debug */
++#define	CNICSDEBUG	_IOW('t', 90, int)
++#define	CNICGDEBUG	_IOR('t', 89, int)
++#define	CNICSIFMODE	_IOW('t', 88, int)
++#define	CNICSLMODE	_IOW('t', 87, int)
++#define	CNICSIFHEAD	_IOW('t', 66, int)
++#define	CNICGIFHEAD	_IOR('t', 65, int)
++
++#endif /* !_NET_IF_TUN_H_ */
+diff --git a/sys/rump/net/lib/libtap/Makefile b/sys/rump/net/lib/libtap/Makefile
+index c475477..012e2c0 100644
+--- a/sys/rump/net/lib/libtap/Makefile
++++ b/sys/rump/net/lib/libtap/Makefile
+@@ -6,6 +6,8 @@
+ LIB=	rumpnet_tap
+ 
+ SRCS=	if_tap.c
++#RG addition to support tun devices within tap component
++SRCS+=  if_cnic.c
+ 
+ SRCS+=	tap_component.c
+ 
+diff --git a/sys/rump/net/lib/libtap/tap_component.c b/sys/rump/net/lib/libtap/tap_component.c
+index 6d9a1f5..457e249 100644
+--- a/sys/rump/net/lib/libtap/tap_component.c
++++ b/sys/rump/net/lib/libtap/tap_component.c
+@@ -36,29 +36,58 @@ __KERNEL_RCSID(0, "$NetBSD: tap_component.c,v 1.1 2015/05/29 12:32:23 pooka Exp
+ #include "rump_net_private.h"
+ #include "rump_vfs_private.h"
+ 
++#include <rump/rumpuser.h>
++
+ CFDRIVER_DECL(tap, DV_IFNET, NULL);
+ 
+ void tapattach(int);
++void cnicattach(int);
+ 
+ RUMP_COMPONENT(RUMP_COMPONENT_NET_IF)
+ {
++
++
+ 	extern const struct cdevsw tap_cdevsw;
+-	devmajor_t bmaj, cmaj;
++	devmajor_t bmaj_tap, cmaj_tap;
+ 	int error;
+ 
+ 	config_cfdriver_attach(&tap_cd);
+ 	tapattach(0);
+ 
+-	bmaj = cmaj = NODEVMAJOR;
+-	error = devsw_attach("tap", NULL, &bmaj, &tap_cdevsw, &cmaj);
++	bmaj_tap = cmaj_tap = NODEVMAJOR;
++	error = devsw_attach("tap", NULL, &bmaj_tap, &tap_cdevsw, &cmaj_tap);
+ 	if (error != 0)
+ 		panic("tap devsw attach failed: %d", error);
+ 
+-	error = rump_vfs_makeonedevnode(S_IFCHR, "/dev/tap", cmaj, 0xfffff);
++	error = rump_vfs_makeonedevnode(S_IFCHR, "/dev/tap", cmaj_tap, 0xfffff);
+ 	if (error != 0)
+ 		panic("cannot create tap device node: %d", error);
+ 
+-	error = rump_vfs_makedevnodes(S_IFCHR, "/dev/tap", '0', cmaj, 0, 4);
++	error = rump_vfs_makedevnodes(S_IFCHR, "/dev/tap", '0', cmaj_tap, 0, 4);
+ 	if (error != 0)
+ 		panic("cannot create tap[0-4] device node: %d", error);
++
++	/* ----- TUN ----- */
++	/* RG: attepting to add cnic to the tap component for rump */
++	rumpuser_dprintf("----- Hello! Greetings from the tap source code! -----\n");
++	rumpuser_dprintf("----- Attempting to make cnic device node /dev/cnic -----\n");
++
++	extern const struct cdevsw cnic_cdevsw;
++	devmajor_t bmaj_cnic, cmaj_cnic;
++
++	//config_cfdriver_attach(&tap_cd);
++	cnicattach(0);
++
++	bmaj_cnic = cmaj_cnic = NODEVMAJOR;
++	error = devsw_attach("cnic", NULL, &bmaj_cnic, &cnic_cdevsw, &cmaj_cnic);
++	if (error != 0)
++		panic("cnic devsw attach failed: %d", error);
++
++	error = rump_vfs_makeonedevnode(S_IFCHR, "/dev/cnic", cmaj_cnic, 0xfffff);
++	if (error != 0)
++		panic("cannot create cnic device node: %d", error);
++
++	error = rump_vfs_makedevnodes(S_IFCHR, "/dev/cnic", '0', cmaj_cnic, 0, 4);
++	if (error != 0)
++		panic("cannot create cnic[0-4] device node: %d", error);
+ }
+-- 
+1.9.1
+
diff --git a/sys/rump/librump/rumpkern/rump.c b/sys/rump/librump/rumpkern/rump.c
index 22dc71f..3f8bc8d 100644
--- a/sys/rump/librump/rumpkern/rump.c
+++ b/sys/rump/librump/rumpkern/rump.c
@@ -246,7 +246,9 @@ rump_init(void)
 	long nsec;
 	struct lwp *l, *initlwp;
 	int i, numcpu;
-
+	extern int rump_vmid;
+	
+	rumpuser_dprintf("rump_init, vmid: %d\n", rump_vmid);
 	/* not reentrant */
 	if (rump_inited)
 		return 0;
-- 
1.9.1


From 46338f28e83cd78f22714dcbbef7c98d6f0e5a5b Mon Sep 17 00:00:00 2001
From: lab176 <lbaier176@gmail.com>
Date: Fri, 29 Jul 2016 11:51:12 -0400
Subject: [PATCH 4/7] Temporary commit to pull changes which will fix locking
 problem during ping/boot.

---
 sys/dev/pci/if_lmc.c                    |      1 +
 sys/kern/subr_devsw.c                   |      2 +-
 sys/net/.if_cnic.c.swo                  |    Bin 0 -> 40960 bytes
 sys/net/.if_cnic.c.swp                  |    Bin 0 -> 16384 bytes
 sys/net/.if_ethersubr.c.swp             |    Bin 0 -> 53248 bytes
 sys/net/Makefile                        |      8 +-
 sys/net/cscope.out                      | 345213 +++++++++++++++++++++++++++++
 sys/net/if_bridge.c                     |      1 +
 sys/net/if_cnic.c                       |     33 +-
 sys/net/if_ethersubr.c                  |      1 +
 sys/net/if_tap.c                        |      1 +
 sys/net/pktqueue.c                      |     43 +-
 sys/net/pktqueue.h                      |      2 +
 sys/net/route.c                         |      1 +
 sys/netinet/.ip_input.c.swp             |    Bin 0 -> 20480 bytes
 sys/netinet/ip_input.c                  |      5 +-
 sys/rump/net/lib/libtap/tap_component.c |      8 +-
 17 files changed, 345298 insertions(+), 21 deletions(-)
 create mode 100644 sys/net/.if_cnic.c.swo
 create mode 100644 sys/net/.if_cnic.c.swp
 create mode 100644 sys/net/.if_ethersubr.c.swp
 create mode 100644 sys/net/cscope.out
 create mode 100644 sys/netinet/.ip_input.c.swp

diff --git a/sys/dev/pci/if_lmc.c b/sys/dev/pci/if_lmc.c
index a2e67c0..3faafb3 100644
--- a/sys/dev/pci/if_lmc.c
+++ b/sys/dev/pci/if_lmc.c
@@ -3318,6 +3318,7 @@ rawip_detach(softc_t *sc)
 static void
 ifnet_input(struct ifnet *ifp, struct mbuf *mbuf)
   {
+  
   softc_t *sc = IFP2SC(ifp);
   pktqueue_t *pktq = NULL;
 
diff --git a/sys/kern/subr_devsw.c b/sys/kern/subr_devsw.c
index 51f0713..4a76e44 100644
--- a/sys/kern/subr_devsw.c
+++ b/sys/kern/subr_devsw.c
@@ -109,7 +109,7 @@ void (*biodone_vfs)(buf_t *) = (void *)nullop;
 void
 devsw_init(void)
 {
-
+	
 	KASSERT(sys_bdevsws < MAXDEVSW - 1);
 	KASSERT(sys_cdevsws < MAXDEVSW - 1);
 	mutex_init(&device_lock, MUTEX_DEFAULT, IPL_NONE);
diff --git a/sys/net/.if_cnic.c.swo b/sys/net/.if_cnic.c.swo
new file mode 100644
index 0000000000000000000000000000000000000000..3e51b4f910153b1ead0db54095c6bfc85edca9aa
GIT binary patch
literal 40960
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
E0KdVWB>(^b

literal 0
HcmV?d00001

diff --git a/sys/net/.if_cnic.c.swp b/sys/net/.if_cnic.c.swp
new file mode 100644
index 0000000000000000000000000000000000000000..1f43a3f9aa3615ace9b7f125a448841147c724e1
GIT binary patch
literal 16384
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
WOO>3yP2`rXMW@-wr$J`@UhbclB!X4|

literal 0
HcmV?d00001

diff --git a/sys/net/.if_ethersubr.c.swp b/sys/net/.if_ethersubr.c.swp
new file mode 100644
index 0000000000000000000000000000000000000000..2cf388c81aea98b4c6b18b518c93caf207f93152
GIT binary patch
literal 53248
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

literal 0
HcmV?d00001

diff --git a/sys/net/Makefile b/sys/net/Makefile
index 7ba90fa..057f810 100644
--- a/sys/net/Makefile
+++ b/sys/net/Makefile
@@ -1,6 +1,6 @@
 #	$NetBSD: Makefile,v 1.32 2012/10/27 22:36:14 alnsn Exp $
 
-INCSDIR= /usr/include/net
+INCSDIR= /usr/include/net 
 
 INCS=	bpf.h bpfjit.h bpfdesc.h dlt.h ethertypes.h if.h if_arc.h if_arp.h \
 	if_atm.h if_bridgevar.h if_dl.h if_ether.h if_etherip.h if_fddi.h if_gif.h \
@@ -8,10 +8,12 @@ INCS=	bpf.h bpfjit.h bpfdesc.h dlt.h ethertypes.h if.h if_arc.h if_arp.h \
 	if_pflog.h if_ppp.h if_pppoe.h if_sppp.h if_srt.h if_stf.h \
 	if_tap.h if_token.h if_tun.h if_types.h if_vlanvar.h net_stats.h \
 	netisr.h pfil.h pfkeyv2.h pfvar.h ppp-comp.h ppp_defs.h radix.h \
-	raw_cb.h route.h slcompress.h slip.h zlib.h
+	raw_cb.h route.h slcompress.h slip.h zlib.h rumpcalls.h  
+
+
 
 SUBDIR=	agr npf
 
-.include <bsd.kinc.mk>
+#include <bsd.kinc.mk>
 
 .PATH: ${NETBSDSRCDIR}/sys/dist/pf/net
diff --git a/sys/net/cscope.out b/sys/net/cscope.out
new file mode 100644
index 0000000..41f590b
--- /dev/null
+++ b/sys/net/cscope.out
@@ -0,0 +1,345213 @@
+cscope 15 $HOME/research/rump2cos/rumprun/src-netbsd/sys/net               0001726589
+	@agr/ieee8023_slowprotocols.h
+
+29 #ide
+_NET_AGR_IEEE8023_SLOWPROTOCOLS_H_
+
+
+30 
+	#_NET_AGR_IEEE8023_SLOWPROTOCOLS_H_
+
+
+	)
+
+40 
+	#SLOWPROTOCOLS_SUBTYPE_LACP
+ 1
+
+	)
+
+41 
+	#SLOWPROTOCOLS_SUBTYPE_MARKER
+ 2
+
+	)
+
+43 
+	sowhdr
+ {
+
+44 
+ut8_t
+ 
+	mh_subty
+;
+
+45 
+ut8_t
+ 
+	mh_vsi
+;
+
+46 } 
+	g__cked
+;
+
+	@agr/ieee8023_tlv.c
+
+29 
+	~<sys/cdefs.h
+>
+
+30 
+__KERNEL_RCSID
+(0, "$NetBSD: ieee8023_tlv.c,v 1.3 2007/02/21 23:00:06horpej Exp $");
+
+32 
+	~<sys/m.h
+>
+
+33 
+	~<sys/sym.h
+>
+
+35 
+	~<t/agr/8023_v.h
+>
+
+38 
+	$v_check
+(c *
+p
+, 
+size_t
+ 
+size
+, c 
+vhdr
+ *
+v
+,
+
+39 c 
+v_me
+ *
+tm
+, 
+bo
+ 
+check_ty
+)
+
+43 i((c *)
+v
+ - (c *)
+p
+ + (*v> 
+size
+) {
+
+44  
+EINVAL
+;
+
+46 i((
+check_ty
+ && 
+v
+->
+v_ty
+ !
+tm
+->
+tm_ty
+) ||
+
+47 
+v
+->
+v_ngth
+ !
+tm
+->
+tm_ngth
+) {
+
+48  
+EINVAL
+;
+
+50 i(
+tm
+->
+tm_ty
+ == 0) {
+
+53 
+v
+ = (c 
+vhdr
+ *)
+
+54 ((c *)
+v
+ +lv->
+v_ngth
+);
+
+55 
+tm
+++;
+
+59 
+	}
+}
+
+	@agr/ieee8023_tlv.h
+
+29 #ide
+_NET_AGR_IEEE8023_TLV_H_
+
+
+30 
+	#_NET_AGR_IEEE8023_TLV_H_
+
+
+	)
+
+36 
+	svhdr
+ {
+
+37 
+ut8_t
+ 
+	mv_ty
+;
+
+38 
+ut8_t
+ 
+	mv_ngth
+;
+
+40 } 
+	g__cked
+;
+
+46 
+	#TLV_SET
+(
+v
+, 
+ty
+, 
+ngth
+) \
+
+48 (
+v
+)->
+v_ty
+ = (
+ty
+); \
+
+49 (
+v
+)->
+v_ngth
+ = (*v+ (
+ngth
+); \
+
+50 }  0)
+
+	)
+
+52 
+	sv_me
+ {
+
+53 
+ut8_t
+ 
+	mtm_ty
+;
+
+54 
+ut8_t
+ 
+	mtm_ngth
+;
+
+57 
+v_check
+(c *, 
+size_t
+, c 
+vhdr
+ *,
+
+58 c 
+v_me
+ *, 
+bo
+);
+
+	@agr/ieee8023ad.h
+
+29 #ide
+_NET_AGR_IEEE8023AD_H_
+
+
+30 
+	#_NET_AGR_IEEE8023AD_H_
+
+
+	)
+
+36 
+8023ad_mk_put
+(
+i
+ *, 
+mbuf
+ *);
+
+37 
+8023ad__put
+(
+i
+ *, 
+mbuf
+ *);
+
+	@agr/ieee8023ad_impl.h
+
+29 #ide
+_NET_AGR_IEEE8023AD_INT_H_
+
+
+30 
+	#_NET_AGR_IEEE8023AD_INT_H_
+
+
+	)
+
+32 
+	s8023ad_soc
+ {
+
+33 
+_soc
+ 
+	misc_sc
+;
+
+34 
+out
+ 
+	misc_out
+;
+
+37 
+	s8023ad_pt
+ {
+
+38 
+_pt
+ 
+	mt_pt
+;
+
+41 
+	#IEEE8023AD_SOFTC
+(
+sc
+) \
+
+42 ((
+8023ad_soc
+ *)(
+sc
+)->
+sc_iive
+)
+
+	)
+
+43 
+	#IEEE8023AD_PORT
+(
+pt
+) \
+
+44 ((
+8023ad_pt
+ *)(
+pt
+)->
+pt_iive
+)
+
+	)
+
+46 
+	gagr_soc
+;
+
+48 
+8023ad_
+(
+agr_soc
+ *);
+
+49 
+8023ad_dt
+(
+agr_soc
+ *);
+
+50 
+8023ad_pt
+(
+agr_pt
+ *);
+
+51 
+8023ad_ptfi
+(
+agr_pt
+ *);
+
+52 
+agr_pt
+ *
+8023ad__tx_pt
+(
+agr_soc
+ *, 
+mbuf
+ *);
+
+53 
+8023ad__pick
+(
+agr_soc
+ *, 
+agr_pt
+ *);
+
+54 
+8023ad__pte
+(
+agr_pt
+ *);
+
+	@agr/ieee8023ad_lacp.c
+
+29 
+	~<sys/cdefs.h
+>
+
+30 
+__KERNEL_RCSID
+(0, "$NetBSD: ieee8023ad_lacp.c,v 1.10 2011/07/01 02:46:24 joerg Exp $");
+
+32 
+	~<sys/m.h
+>
+
+33 
+	~<sys/out.h
+>
+
+34 
+	~<sys/mbuf.h
+>
+
+35 
+	~<sys/sym.h
+>
+
+36 
+	~<sys/mloc.h
+>
+
+37 
+	~<sys/kl.h
+>
+
+39 
+	~<t/if.h
+>
+
+40 
+	~<t/if_dl.h
+>
+
+41 
+	~<t/if_h.h
+>
+
+42 
+	~<t/if_med.h
+>
+
+44 
+	~<t/agr/if_agrv_im.h
+>
+
+45 
+	~<t/agr/if_agrsubr.h
+>
+
+46 
+	~<t/agr/8023_owocs.h
+>
+
+47 
+	~<t/agr/8023_v.h
+>
+
+48 
+	~<t/agr/8023ad.h
+>
+
+49 
+	~<t/agr/8023ad_.h
+>
+
+50 
+	~<t/agr/8023ad__im.h
+>
+
+51 
+	~<t/agr/8023ad_im.h
+>
+
+52 
+	~<t/agr/8023ad__sm.h
+>
+
+53 
+	~<t/agr/8023ad__debug.h
+>
+
+55 
+_fl_afo
+(
+agr_pt
+ *, 
+_fo
+ *);
+
+57 
+ut64_t
+ 
+_aggg_bdwidth
+(
+_aggg
+ *);
+
+58 
+_suss_diributg
+(
+_soc
+ *,
+
+59 
+_aggg
+ *);
+
+60 
+_s_expe
+(*);
+
+61 
+__aive_aggg
+(
+_soc
+ *);
+
+62 
+ut16_t
+ 
+_compo_key
+(
+_pt
+ *);
+
+69 
+	#LACP_SYSTEM_PRIO
+ 0x8000
+
+	)
+
+70 
+	#LACP_PORT_PRIO
+ 0x8000
+
+	)
+
+72 c 
+v_me
+ 
+	g_fo_v_me
+[] = {
+
+73 { 
+LACP_TYPE_ACTORINFO
+,
+
+74 (
+vhdr
++ (
+_fo
+) },
+
+75 { 
+LACP_TYPE_PARTNERINFO
+,
+
+76 (
+vhdr
++ (
+_fo
+) },
+
+77 { 
+LACP_TYPE_COLLECTORINFO
+,
+
+78 (
+vhdr
++ (
+_cfo
+) },
+
+92 
+	$8023ad__put
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+)
+
+94 
+du
+ *
+du
+;
+
+95 
+agr_soc
+ *
+sc
+;
+
+96 
+agr_pt
+ *
+pt
+;
+
+97 
+_pt
+ *
+
+;
+
+98 
+r
+ = 0;
+
+100 
+pt
+ = 
+i
+->
+if_agrive
+;
+
+101 i(
+	`__edi_l
+(
+pt
+->
+pt_ags
+ & 
+AGRPORT_DETACHING
+)) {
+
+102 
+bad
+;
+
+105 
+sc
+ = 
+	`AGR_SC_FROM_PORT
+(
+pt
+);
+
+106 
+	`KASSERT
+(
+pt
+);
+
+109 i(
+	`AGR_STATIC
+(
+sc
+)) {
+
+111 
+bad
+;
+
+115 i(
+m
+->
+m_pkthdr
+.
+n
+ !(*
+du
+)) {
+
+116 
+bad
+;
+
+119 i((
+m
+->
+m_ags
+ & 
+M_MCAST
+) == 0) {
+
+120 
+bad
+;
+
+123 i(
+m
+->
+m_n
+ < (*
+du
+)) {
+
+124 
+m
+ = 
+	`m_puup
+(m, (*
+du
+));
+
+125 i(
+m
+ =
+NULL
+) {
+
+126  
+ENOMEM
+;
+
+130 
+du
+ = 
+	`mtod
+(
+m
+, 
+du
+ *);
+
+132 i(
+	`memcmp
+(&
+du
+->
+ldu_eh
+.
+h_dho
+,
+
+133 &
+hmuiaddr_owocs
+, 
+ETHER_ADDR_LEN
+)) {
+
+134 
+bad
+;
+
+137 
+	`KASSERT
+(
+du
+->
+ldu_h
+.
+h_subty
+ =
+SLOWPROTOCOLS_SUBTYPE_LACP
+);
+
+145 i(
+du
+->
+ldu_h
+.
+h_vsi
+ != 1) {
+
+146 
+bad
+;
+
+155 i(
+	`v_check
+(
+du
+, (*du), &du->
+ldu_v_a
+,
+
+156 
+_fo_v_me
+, 
+l
+)) {
+
+157 
+bad
+;
+
+160 
+	`AGR_LOCK
+(
+sc
+);
+
+161 
+
+ = 
+	`LACP_PORT
+(
+pt
+);
+
+163 #i
+	`defed
+(
+LACP_DEBUG
+)
+
+164 i(
+debug
+) {
+
+165 
+	`LACP_DPRINTF
+((
+
+, "lacpdueceive\n"));
+
+166 
+	`_dump_du
+(
+du
+);
+
+169 
+	`_sm_rx
+(
+
+, 
+du
+);
+
+171 
+	`AGR_UNLOCK
+(
+sc
+);
+
+173 
+	`m_m
+(
+m
+);
+
+175  
+r
+;
+
+177 
+bad
+:
+
+178 
+	`m_m
+(
+m
+);
+
+179  
+EINVAL
+;
+
+180 
+	}
+}
+
+183 
+	$_fl_afo
+(
+agr_pt
+ *
+pt
+, 
+_fo
+ *
+fo
+)
+
+185 
+_pt
+ *
+
+ = 
+	`LACP_PORT
+(
+pt
+);
+
+187 
+fo
+->
+l_syemid
+.
+lsi_io
+ = 
+	`htobe16
+(
+LACP_SYSTEM_PRIO
+);
+
+188 
+	`memy
+(&
+fo
+->
+l_syemid
+.
+lsi_mac
+,
+
+189 
+	`CLLADDR
+(
+pt
+->
+pt_i
+->
+if_dl
+), 
+ETHER_ADDR_LEN
+);
+
+190 
+fo
+->
+l_ptid
+.
+i_io
+ = 
+	`htobe16
+(
+LACP_PORT_PRIO
+);
+
+191 
+fo
+->
+l_ptid
+.
+i_po
+ = 
+	`htobe16
+(
+pt
+->
+pt_i
+->
+if_dex
+);
+
+192 
+fo
+->
+l_e
+ = 
+
+->
+_e
+;
+
+193 
+	}
+}
+
+196 
+	$_xm_du
+(
+_pt
+ *
+
+)
+
+198 
+agr_pt
+ *
+pt
+ = 
+
+->
+_agt
+;
+
+199 
+mbuf
+ *
+m
+;
+
+200 
+du
+ *
+du
+;
+
+201 
+r
+;
+
+204 i(
+	`AGR_STATIC
+(
+	`AGR_SC_FROM_PORT
+(
+pt
+))) {
+
+209 
+	`KDASSERT
+(
+MHLEN
+ >(*
+du
+));
+
+211 
+m
+ = 
+	`m_ghdr
+(
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+212 i(
+m
+ =
+NULL
+) {
+
+213  
+ENOMEM
+;
+
+215 
+m
+->
+m_n
+ = m->
+m_pkthdr
+.
+n
+ = (*
+du
+);
+
+217 
+du
+ = 
+	`mtod
+(
+m
+, 
+du
+ *);
+
+218 
+	`memt
+(
+du
+, 0, (*du));
+
+220 
+	`memy
+(&
+du
+->
+ldu_eh
+.
+h_dho
+, 
+hmuiaddr_owocs
+,
+
+221 
+ETHER_ADDR_LEN
+);
+
+222 
+	`memy
+(&
+du
+->
+ldu_eh
+.
+h_sho
+, &
+pt
+->
+pt_igaddr
+, 
+ETHER_ADDR_LEN
+);
+
+223 
+du
+->
+ldu_eh
+.
+h_ty
+ = 
+	`htobe16
+(
+ETHERTYPE_SLOWPROTOCOLS
+);
+
+225 
+du
+->
+ldu_h
+.
+h_subty
+ = 
+SLOWPROTOCOLS_SUBTYPE_LACP
+;
+
+226 
+du
+->
+ldu_h
+.
+h_vsi
+ = 1;
+
+228 
+	`TLV_SET
+(&
+du
+->
+ldu_v_a
+, 
+LACP_TYPE_ACTORINFO
+, (du->
+ldu_a
+));
+
+229 
+du
+->
+ldu_a
+ = 
+
+->
+_a
+;
+
+231 
+	`TLV_SET
+(&
+du
+->
+ldu_v_r
+, 
+LACP_TYPE_PARTNERINFO
+,
+
+232 (
+du
+->
+ldu_r
+));
+
+233 
+du
+->
+ldu_r
+ = 
+
+->
+_r
+;
+
+235 
+	`TLV_SET
+(&
+du
+->
+ldu_v_c
+, 
+LACP_TYPE_COLLECTORINFO
+,
+
+236 (
+du
+->
+ldu_c
+));
+
+237 
+du
+->
+ldu_c
+.
+lci_maxday
+ = 0;
+
+239 #i
+	`defed
+(
+LACP_DEBUG
+)
+
+240 i(
+debug
+) {
+
+241 
+	`LACP_DPRINTF
+((
+
+, "lacpduransmit\n"));
+
+242 
+	`_dump_du
+(
+du
+);
+
+246 
+m
+->
+m_ags
+ |
+M_MCAST
+;
+
+253 
+r
+ = 
+	`agr_xm_ame
+(
+pt
+->
+pt_i
+, 
+m
+);
+
+254  
+r
+;
+
+255 
+	}
+}
+
+258 
+	$8023ad__pte
+(
+agr_pt
+ *
+pt
+)
+
+260 
+_pt
+ *
+
+ = 
+	`LACP_PORT
+(
+pt
+);
+
+261 
+u_t
+ 
+med
+ = 
+pt
+->
+pt_med
+;
+
+262 
+ut8_t
+ 
+d_e
+;
+
+263 
+ut16_t
+ 
+d_key
+;
+
+265 
+	`AGR_ASSERT_LOCKED
+(
+	`AGR_SC_FROM_PORT
+(
+pt
+));
+
+267 
+	`LACP_DPRINTF
+((
+
+, "med chged 0x%x -> 0x%x\n",p->
+_med
+, 
+med
+));
+
+269 
+d_e
+ = 
+
+->
+_e
+;
+
+270 
+d_key
+ = 
+
+->
+_key
+;
+
+272 
+
+->
+_med
+ = 
+med
+;
+
+273 i((
+med
+ & 
+IFM_HDX
+) != 0) {
+
+274 
+
+->
+_e
+ &~
+LACP_STATE_AGGREGATION
+;
+
+276 
+
+->
+_e
+ |
+LACP_STATE_AGGREGATION
+;
+
+278 
+
+->
+_key
+ = 
+	`_compo_key
+(lp);
+
+280 i(
+d_e
+ !
+
+->
+_e
+ || 
+d_key
+ !->
+_key
+) {
+
+281 
+	`LACP_DPRINTF
+((
+
+, "-> UNSELECTED\n"));
+
+282 
+
+->
+_ed
+ = 
+LACP_UNSELECTED
+;
+
+284 
+	}
+}
+
+287 
+	$8023ad__pick
+(
+agr_soc
+ *
+sc
+, 
+agr_pt
+ *
+pt
+)
+
+289 
+_pt
+ *
+
+ = 
+	`LACP_PORT
+(
+pt
+);
+
+291 
+	`AGR_ASSERT_LOCKED
+(
+sc
+);
+
+293 
+	`_run_tims
+(
+
+);
+
+295 
+	`_
+(
+
+);
+
+296 
+	`_sm_mux
+(
+
+);
+
+297 
+	`_sm_tx
+(
+
+);
+
+298 
+	`_sm_x_tx_schedu
+(
+
+);
+
+299 
+	}
+}
+
+302 
+	$_pt
+(
+agr_pt
+ *
+pt
+)
+
+304 
+_pt
+ *
+
+ = 
+	`LACP_PORT
+(
+pt
+);
+
+305 
+bo
+ 
+aive
+ = 
+ue
+;
+
+306 
+bo
+ 
+
+ = 
+l
+;
+
+308 
+
+->
+_agt
+ = 
+pt
+;
+
+309 
+	`_fl_afo
+(
+pt
+, &
+
+->
+_a
+);
+
+310 
+
+->
+_e
+ =
+
+311 (
+aive
+ ? 
+LACP_STATE_ACTIVITY
+ : 0) |
+
+312 (
+
+ ? 
+LACP_STATE_TIMEOUT
+ : 0);
+
+313 
+
+->
+_aggg
+ = 
+NULL
+;
+
+314 
+
+->
+_med
+ = 
+pt
+->
+pt_med
+;
+
+315 
+
+->
+_key
+ = 
+	`_compo_key
+(lp);
+
+316 
+	`_sm_rx_t_exped
+(
+
+);
+
+317 
+	}
+}
+
+320 
+	$_ptfi
+(
+agr_pt
+ *
+pt
+)
+
+322 
+_pt
+ *
+
+ = 
+	`LACP_PORT
+(
+pt
+);
+
+323 
+_aggg
+ *
+
+ = 
+
+->
+_aggg
+;
+
+324 
+i
+;
+
+326 
+	`LACP_DPRINTF
+((
+
+, "portfini\n"));
+
+328 
+i
+ = 0; i < 
+LACP_NTIMER
+; i++) {
+
+329 
+	`LACP_TIMER_DISARM
+(
+
+, 
+i
+);
+
+332 i(
+
+ =
+NULL
+) {
+
+336 
+	`_dib_diributg
+(
+
+);
+
+337 
+	`_un
+(
+
+);
+
+338 
+	}
+}
+
+342 
+	$_dib_cg
+(
+_pt
+ *
+
+)
+
+344 
+agr_pt
+ *
+pt
+ = 
+
+->
+_agt
+;
+
+346 
+
+->
+_e
+ &~
+LACP_STATE_COLLECTING
+;
+
+347 
+pt
+->
+pt_ags
+ &~
+AGRPORT_COLLECTING
+;
+
+348 
+	}
+}
+
+351 
+	$_ab_cg
+(
+_pt
+ *
+
+)
+
+353 
+agr_pt
+ *
+pt
+ = 
+
+->
+_agt
+;
+
+355 
+
+->
+_e
+ |
+LACP_STATE_COLLECTING
+;
+
+356 
+pt
+->
+pt_ags
+ |
+AGRPORT_COLLECTING
+;
+
+357 
+	}
+}
+
+360 
+	$_dib_diributg
+(
+_pt
+ *
+
+)
+
+362 
+agr_pt
+ *
+pt
+ = 
+
+->
+_agt
+;
+
+363 
+_aggg
+ *
+
+ = 
+
+->
+_aggg
+;
+
+364 
+_soc
+ *
+lsc
+ = 
+	`LACP_SOFTC
+(
+	`AGR_SC_FROM_PORT
+(
+pt
+));
+
+365 #i
+	`defed
+(
+LACP_DEBUG
+)
+
+366 
+buf
+[
+LACP_LAGIDSTR_MAX
++1];
+
+369 i((
+
+->
+_e
+ & 
+LACP_STATE_DISTRIBUTING
+) == 0) {
+
+373 
+	`KASSERT
+(
+
+);
+
+374 
+	`KASSERT
+(!
+	`TAILQ_EMPTY
+(&
+
+->
+_pts
+));
+
+375 
+	`KASSERT
+(
+
+->
+_ts
+ > 0);
+
+376 
+	`KASSERT
+(
+
+->
+_ft
+ >->
+_ts
+);
+
+378 
+	`LACP_DPRINTF
+((
+
+, "disable distributing onggregator %s, "
+
+380 
+	`_fm_gid_aggg
+(
+
+, 
+buf
+, (buf)),
+
+381 
+
+->
+_ts
+,a->la_nports - 1));
+
+383 
+	`TAILQ_REMOVE
+(&
+
+->
+_pts
+, 
+
+, 
+_di_q
+);
+
+384 
+
+->
+_ts
+--;
+
+386 
+	`_suss_diributg
+(
+lsc
+, 
+
+);
+
+388 
+
+->
+_e
+ &~
+LACP_STATE_DISTRIBUTING
+;
+
+389 
+pt
+->
+pt_ags
+ &~
+AGRPORT_DISTRIBUTING
+;
+
+391 i(
+lsc
+->
+lsc_aive_aggg
+ =
+
+) {
+
+392 
+	`__aive_aggg
+(
+lsc
+);
+
+394 
+	}
+}
+
+397 
+	$_ab_diributg
+(
+_pt
+ *
+
+)
+
+399 
+agr_pt
+ *
+pt
+ = 
+
+->
+_agt
+;
+
+400 
+_aggg
+ *
+
+ = 
+
+->
+_aggg
+;
+
+401 
+_soc
+ *
+lsc
+ = 
+	`LACP_SOFTC
+(
+	`AGR_SC_FROM_PORT
+(
+pt
+));
+
+402 #i
+	`defed
+(
+LACP_DEBUG
+)
+
+403 
+buf
+[
+LACP_LAGIDSTR_MAX
++1];
+
+406 i((
+
+->
+_e
+ & 
+LACP_STATE_DISTRIBUTING
+) != 0) {
+
+410 
+	`KASSERT
+(
+
+);
+
+412 
+	`LACP_DPRINTF
+((
+
+, "enable distributing onggregator %s, "
+
+414 
+	`_fm_gid_aggg
+(
+
+, 
+buf
+, (buf)),
+
+415 
+
+->
+_ts
+,a->la_nports + 1));
+
+417 
+	`KASSERT
+(
+
+->
+_ft
+ >a->
+_ts
+);
+
+418 
+	`TAILQ_INSERT_HEAD
+(&
+
+->
+_pts
+, 
+
+, 
+_di_q
+);
+
+419 
+
+->
+_ts
+++;
+
+421 
+	`_suss_diributg
+(
+lsc
+, 
+
+);
+
+423 
+
+->
+_e
+ |
+LACP_STATE_DISTRIBUTING
+;
+
+424 
+pt
+->
+pt_ags
+ |
+AGRPORT_DISTRIBUTING
+;
+
+426 i(
+lsc
+->
+lsc_aive_aggg
+ !
+
+) {
+
+427 
+	`__aive_aggg
+(
+lsc
+);
+
+429 
+	}
+}
+
+432 
+	$_s_expe
+(*
+vp
+)
+
+434 
+agr_soc
+ *
+sc
+ = 
+vp
+;
+
+435 
+_soc
+ *
+lsc
+ = 
+	`LACP_SOFTC
+(
+sc
+);
+
+437 
+	`AGR_LOCK
+(
+sc
+);
+
+438 
+	`LACP_DPRINTF
+((
+NULL
+, "%s\n", 
+__func__
+));
+
+439 
+lsc
+->
+lsc_suss_diributg
+ = 
+l
+;
+
+440 
+	`AGR_UNLOCK
+(
+sc
+);
+
+441 
+	}
+}
+
+446 
+	$8023ad_pt
+(
+agr_pt
+ *
+pt
+)
+
+448 
+8023ad_pt
+ *
+t
+ = 
+	`IEEE8023AD_PORT
+(
+pt
+);
+
+450 
+	`memt
+(
+t
+, 0, (*iport));
+
+452 
+	`_pt
+(
+pt
+);
+
+453 
+	}
+}
+
+456 
+	$8023ad_ptfi
+(
+agr_pt
+ *
+pt
+)
+
+458 
+agr_soc
+ *
+sc
+ = 
+	`AGR_SC_FROM_PORT
+(
+pt
+);
+
+460 
+	`AGR_LOCK
+(
+sc
+);
+
+462 
+	`_ptfi
+(
+pt
+);
+
+464 
+	`AGR_UNLOCK
+(
+sc
+);
+
+465 
+	}
+}
+
+468 
+	$8023ad_
+(
+agr_soc
+ *
+sc
+)
+
+470 
+8023ad_soc
+ *
+isc
+ = 
+	`IEEE8023AD_SOFTC
+(
+sc
+);
+
+471 
+_soc
+ *
+lsc
+ = &
+isc
+->
+isc_sc
+;
+
+473 
+lsc
+->
+lsc_aive_aggg
+ = 
+NULL
+;
+
+474 
+	`TAILQ_INIT
+(&
+lsc
+->
+lsc_agggs
+);
+
+475 
+	`out_
+(&
+lsc
+->
+lsc_s_out
+, 0);
+
+476 
+	`out_tfunc
+(&
+lsc
+->
+lsc_s_out
+, 
+_s_expe
+, 
+sc
+);
+
+477 
+	}
+}
+
+480 
+	$8023ad_dt
+(
+agr_soc
+ *
+sc
+)
+
+482 
+8023ad_soc
+ *
+isc
+ = 
+	`IEEE8023AD_SOFTC
+(
+sc
+);
+
+483 
+_soc
+ *
+lsc
+ = &
+isc
+->
+isc_sc
+;
+
+485 
+	`LACP_DPRINTF
+((
+NULL
+, "%s\n", 
+__func__
+));
+
+487 
+	`out_
+(&
+lsc
+->
+lsc_s_out
+);
+
+488 
+	`KASSERT
+(
+	`TAILQ_EMPTY
+(&
+lsc
+->
+lsc_agggs
+));
+
+489 
+	`KASSERT
+(
+lsc
+->
+lsc_aive_aggg
+ =
+NULL
+);
+
+490 
+	}
+}
+
+494 
+agr_pt
+ *
+
+495 
+	$8023ad__tx_pt
+(
+agr_soc
+ *
+sc
+, 
+mbuf
+ *
+m
+)
+
+497 c 
+_soc
+ *
+lsc
+ = 
+	`LACP_SOFTC
+(
+sc
+);
+
+498 c 
+_aggg
+ *
+
+;
+
+499 c 
+_pt
+ *
+
+;
+
+500 
+ut32_t
+ 
+hash
+;
+
+501 
+ts
+;
+
+503 i(
+	`__edi_l
+(
+lsc
+->
+lsc_suss_diributg
+ &&
+
+504 !
+	`AGR_ROUNDROBIN
+(
+sc
+))) {
+
+505 
+	`LACP_DPRINTF
+((
+NULL
+, "%s: wagns\n", 
+__func__
+));
+
+506 
+sc
+->
+sc_if
+.
+if_clisis
+++;
+
+507  
+NULL
+;
+
+510 
+
+ = 
+lsc
+->
+lsc_aive_aggg
+;
+
+511 i(
+	`__edi_l
+(
+
+ =
+NULL
+)) {
+
+512 
+	`LACP_DPRINTF
+((
+NULL
+, "%s:aivaggg\n", 
+__func__
+));
+
+513  
+NULL
+;
+
+516 
+ts
+ = 
+
+->
+_ts
+;
+
+517 
+	`KASSERT
+(
+ts
+ > 0);
+
+519 i(
+	`AGR_ROUNDROBIN
+(
+sc
+)) {
+
+521 
+hash
+ = 
+sc
+->
+sc__cou
+++;
+
+523 
+hash
+ = (*
+sc
+->
+sc_i
+->
+i_hashmbuf
+)(sc, 
+m
+);
+
+525 
+hash
+ %
+ts
+;
+
+526 
+
+ = 
+	`TAILQ_FIRST
+(&
+
+->
+_pts
+);
+
+527 
+	`KASSERT
+(
+
+ !
+NULL
+);
+
+528 
+hash
+--) {
+
+529 
+
+ = 
+	`TAILQ_NEXT
+p, 
+_di_q
+);
+
+530 
+	`KASSERT
+(
+
+ !
+NULL
+);
+
+533 
+	`KASSERT
+((
+
+->
+_e
+ & 
+LACP_STATE_DISTRIBUTING
+) != 0);
+
+535  
+
+->
+_agt
+;
+
+536 
+	}
+}
+
+544 
+	$_suss_diributg
+(
+_soc
+ *
+lsc
+, 
+_aggg
+ *
+
+)
+
+547 i(
+lsc
+->
+lsc_aive_aggg
+ !
+
+) {
+
+551 
+	`LACP_DPRINTF
+((
+NULL
+, "%s\n", 
+__func__
+));
+
+552 
+lsc
+->
+lsc_suss_diributg
+ = 
+ue
+;
+
+554 
+	`out_schedu
+(&
+lsc
+->
+lsc_s_out
+,
+
+555 
+LACP_TRANSIT_DELAY
+ * 
+hz
+ / 1000);
+
+556 
+	}
+}
+
+561 
+	$_com_fo
+(c 
+_fo
+ *
+a
+,
+
+562 c 
+_fo
+ *
+b
+)
+
+565  
+	`memcmp
+(
+a
+, 
+b
+, 
+	`offtof
+(
+_fo
+, 
+l_e
+));
+
+566 
+	}
+}
+
+569 
+	$_com_syemid
+(c 
+_syemid
+ *
+a
+,
+
+570 c 
+_syemid
+ *
+b
+)
+
+573  
+	`memcmp
+(
+a
+, 
+b
+, (*a));
+
+574 
+	}
+}
+
+577 
+	$_com_ptid
+(c 
+_ptid
+ *
+a
+,
+
+578 c 
+_ptid
+ *
+b
+)
+
+581  
+	`memcmp
+(
+a
+, 
+b
+, (*a));
+
+582 
+	}
+}
+
+586 
+ut64_t
+
+
+587 
+	$_aggg_bdwidth
+(
+_aggg
+ *
+
+)
+
+589 
+_pt
+ *
+
+;
+
+590 
+ut64_t
+ 
+d
+;
+
+592 
+
+ = 
+	`TAILQ_FIRST
+(&
+
+->
+_pts
+);
+
+593 i(
+
+ =
+NULL
+) {
+
+597 
+d
+ = 
+	`ifmed_baud
+(
+
+->
+_med
+);
+
+598 
+d
+ *
+
+->
+_ts
+;
+
+599 i(
+d
+ == 0) {
+
+600 
+	`LACP_DPRINTF
+((
+
+, "speed 0? media=0x%xports=%d\n",
+
+601 
+
+->
+_med
+, 
+
+->
+_ts
+));
+
+604  
+d
+;
+
+605 
+	}
+}
+
+613 
+	$__aive_aggg
+(
+_soc
+ *
+lsc
+)
+
+615 
+_aggg
+ *
+
+;
+
+616 
+_aggg
+ *
+be_
+ = 
+NULL
+;
+
+617 
+ut64_t
+ 
+be_d
+ = 0;
+
+618 #i
+	`defed
+(
+LACP_DEBUG
+)
+
+619 
+buf
+[
+LACP_LAGIDSTR_MAX
++1];
+
+622 
+	`LACP_DPRINTF
+((
+NULL
+, "%s:\n", 
+__func__
+));
+
+624 
+	`TAILQ_FOREACH
+(
+
+, &
+lsc
+->
+lsc_agggs
+, 
+_q
+) {
+
+625 
+ut64_t
+ 
+d
+;
+
+627 i(
+
+->
+_ts
+ == 0) {
+
+631 
+d
+ = 
+	`_aggg_bdwidth
+(
+
+);
+
+632 
+	`LACP_DPRINTF
+((
+NULL
+, "%s, sed=%" 
+PRIu64
+ ",ports=%d\n",
+
+633 
+	`_fm_gid_aggg
+(
+
+, 
+buf
+, (buf)),
+
+634 
+d
+, 
+
+->
+_ts
+));
+
+635 i(
+d
+ > 
+be_d
+ ||
+
+636 (
+d
+ =
+be_d
+ &&
+
+637 
+
+ =
+lsc
+->
+lsc_aive_aggg
+)) {
+
+638 
+be_
+ = 
+
+;
+
+639 
+be_d
+ = 
+d
+;
+
+643 
+	`KASSERT
+(
+be_
+ =
+NULL
+ || be_->
+_ts
+ > 0);
+
+644 
+	`KASSERT
+(
+be_
+ =
+NULL
+ || !
+	`TAILQ_EMPTY
+(&be_->
+_pts
+));
+
+646 #i
+	`defed
+(
+LACP_DEBUG
+)
+
+647 i(
+lsc
+->
+lsc_aive_aggg
+ !
+be_
+) {
+
+648 
+	`LACP_DPRINTF
+((
+NULL
+, "activeggregator changed\n"));
+
+649 
+	`LACP_DPRINTF
+((
+NULL
+, "old %s\n",
+
+650 
+	`_fm_gid_aggg
+(
+lsc
+->
+lsc_aive_aggg
+,
+
+651 
+buf
+, (buf))));
+
+653 
+	`LACP_DPRINTF
+((
+NULL
+, "activeggregatorot changed\n"));
+
+655 
+	`LACP_DPRINTF
+((
+NULL
+, "new %s\n",
+
+656 
+	`_fm_gid_aggg
+(
+be_
+, 
+buf
+, (buf))));
+
+659 i(
+lsc
+->
+lsc_aive_aggg
+ !
+be_
+) {
+
+660 
+lsc
+->
+lsc_aive_aggg
+ = 
+be_
+;
+
+661 i(
+be_
+) {
+
+662 
+	`_suss_diributg
+(
+lsc
+, 
+be_
+);
+
+665 
+	}
+}
+
+667 
+ut16_t
+
+
+668 
+	$_compo_key
+(
+_pt
+ *
+
+)
+
+670 
+u_t
+ 
+med
+ = 
+
+->
+_med
+;
+
+671 
+ut16_t
+ 
+key
+;
+
+673 
+	`KASSERT
+(
+	`IFM_TYPE
+(
+med
+=
+IFM_ETHER
+);
+
+675 i(!(
+
+->
+_e
+ & 
+LACP_STATE_AGGREGATION
+)) {
+
+684 
+key
+ = 
+
+->
+_agt
+->
+pt_i
+->
+if_dex
+;
+
+686 
+key
+ |= 0x8000;
+
+688 
+u_t
+ 
+subty
+ = 
+	`IFM_SUBTYPE
+(
+med
+);
+
+690 
+	`KASSERT
+((
+med
+ & 
+IFM_HDX
+) == 0);
+
+691 
+	`KASSERT
+((
+subty
+ & 0x1f) == subtype);
+
+694 
+key
+ = 
+subty
+;
+
+696 
+key
+ |0x70 & ((
+
+->
+_agt
+->
+pt_agri
+->
+if_dex
+) << 5);
+
+700  
+	`htobe16
+(
+key
+);
+
+701 
+	}
+}
+
+	@agr/ieee8023ad_lacp.h
+
+29 #ide
+_NET_AGR_IEEE8023AD_LACP_H_
+
+
+30 
+	#_NET_AGR_IEEE8023AD_LACP_H_
+
+
+	)
+
+38 
+	s_syemid
+ {
+
+39 
+ut16_t
+ 
+	mlsi_io
+;
+
+40 
+ut8_t
+ 
+	mlsi_mac
+[6];
+
+41 } 
+	g__cked
+;
+
+43 
+	s_ptid
+ {
+
+44 
+ut16_t
+ 
+	mi_io
+;
+
+45 
+ut16_t
+ 
+	mi_po
+;
+
+46 } 
+	g__cked
+;
+
+48 
+	s_fo
+ {
+
+49 
+_syemid
+ 
+	ml_syemid
+;
+
+50 
+ut16_t
+ 
+	ml_key
+;
+
+51 
+_ptid
+ 
+	ml_ptid
+;
+
+52 
+ut8_t
+ 
+	ml_e
+;
+
+53 
+ut8_t
+ 
+	ml_sv
+[3];
+
+54 } 
+	g__cked
+;
+
+56 
+	#LACP_STATE_ACTIVITY
+ (1<<0)
+
+	)
+
+57 
+	#LACP_STATE_TIMEOUT
+ (1<<1)
+
+	)
+
+58 
+	#LACP_STATE_AGGREGATION
+ (1<<2)
+
+	)
+
+59 
+	#LACP_STATE_SYNC
+ (1<<3)
+
+	)
+
+60 
+	#LACP_STATE_COLLECTING
+ (1<<4)
+
+	)
+
+61 
+	#LACP_STATE_DISTRIBUTING
+ (1<<5)
+
+	)
+
+62 
+	#LACP_STATE_DEFAULTED
+ (1<<6)
+
+	)
+
+63 
+	#LACP_STATE_EXPIRED
+ (1<<7)
+
+	)
+
+66 
+	#LACP_STATE_BITS
+ \
+
+75 "b\7EXPIRED\0"
+
+	)
+
+77 
+	s_cfo
+ {
+
+78 
+ut16_t
+ 
+	mlci_maxday
+;
+
+79 
+ut8_t
+ 
+	mlci_sv
+[12];
+
+80 } 
+	g__cked
+;
+
+82 
+	sdu
+ {
+
+83 
+h_hd
+ 
+	mldu_eh
+;
+
+84 
+owhdr
+ 
+	mldu_h
+;
+
+86 
+vhdr
+ 
+	mldu_v_a
+;
+
+87 
+_fo
+ 
+	mldu_a
+;
+
+88 
+vhdr
+ 
+	mldu_v_r
+;
+
+89 
+_fo
+ 
+	mldu_r
+;
+
+90 
+vhdr
+ 
+	mldu_v_c
+;
+
+91 
+_cfo
+ 
+	mldu_c
+;
+
+92 
+vhdr
+ 
+	mldu_v_rm
+;
+
+93 
+ut8_t
+ 
+	mldu_sv
+[50];
+
+94 } 
+	g__cked
+;
+
+96 
+	#LACP_TYPE_ACTORINFO
+ 1
+
+	)
+
+97 
+	#LACP_TYPE_PARTNERINFO
+ 2
+
+	)
+
+98 
+	#LACP_TYPE_COLLECTORINFO
+ 3
+
+	)
+
+101 
+	#LACP_FAST_PERIODIC_TIME
+ (1)
+
+	)
+
+102 
+	#LACP_SLOW_PERIODIC_TIME
+ (30)
+
+	)
+
+103 
+	#LACP_SHORT_TIMEOUT_TIME
+ (3 * 
+LACP_FAST_PERIODIC_TIME
+)
+
+	)
+
+104 
+	#LACP_LONG_TIMEOUT_TIME
+ (3 * 
+LACP_SLOW_PERIODIC_TIME
+)
+
+	)
+
+105 
+	#LACP_CHURN_DETECTION_TIME
+ (60)
+
+	)
+
+106 
+	#LACP_AGGREGATE_WAIT_TIME
+ (2)
+
+	)
+
+	@agr/ieee8023ad_lacp_debug.c
+
+29 
+	~<sys/cdefs.h
+>
+
+30 
+__KERNEL_RCSID
+(0, "$NetBSD: ieee8023ad_lacp_debug.c,v 1.6 2011/07/17 20:54:52 joerg Exp $");
+
+32 
+	~<sys/m.h
+>
+
+33 
+	~<sys/sym.h
+>
+
+34 
+	~<sys/out.h
+>
+
+36 
+	~<t/if.h
+>
+
+37 
+	~<t/if_h.h
+>
+
+39 
+	~<t/agr/8023_owocs.h
+>
+
+40 
+	~<t/agr/8023_v.h
+>
+
+41 
+	~<t/agr/8023ad_.h
+>
+
+42 
+	~<t/agr/8023ad__im.h
+>
+
+43 
+	~<t/agr/8023ad__debug.h
+>
+
+45 #i
+defed
+(
+LACP_DEBUG
+)
+
+46 
+	gdebug
+ = 0;
+
+50 
+	$_fm_mac
+(c 
+ut8_t
+ *
+mac
+, *
+buf
+, 
+size_t
+ 
+bu
+)
+
+53 
+	`tf
+(
+buf
+, 
+bu
+, "%02X-%02X-%02X-%02X-%02X-%02X",
+
+54 ()
+mac
+[0],
+
+55 ()
+mac
+[1],
+
+56 ()
+mac
+[2],
+
+57 ()
+mac
+[3],
+
+58 ()
+mac
+[4],
+
+59 ()
+mac
+[5]);
+
+61  
+buf
+;
+
+62 
+	}
+}
+
+65 
+	$_fm_syemid
+(c 
+_syemid
+ *
+sysid
+,
+
+66 *
+buf
+, 
+size_t
+ 
+bu
+)
+
+68 
+macbuf
+[
+LACP_MACSTR_MAX
++1];
+
+70 
+	`tf
+(
+buf
+, 
+bu
+, "%04X,%s",
+
+71 
+	`be16toh
+(
+sysid
+->
+lsi_io
+),
+
+72 
+	`_fm_mac
+(
+sysid
+->
+lsi_mac
+, 
+macbuf
+, (macbuf)));
+
+74  
+buf
+;
+
+75 
+	}
+}
+
+78 
+	$_fm_ptid
+(c 
+_ptid
+ *
+ptid
+, *
+buf
+, 
+size_t
+ 
+bu
+)
+
+81 
+	`tf
+(
+buf
+, 
+bu
+, "%04X,%04X",
+
+82 
+	`be16toh
+(
+ptid
+->
+i_io
+),
+
+83 
+	`be16toh
+(
+ptid
+->
+i_po
+));
+
+85  
+buf
+;
+
+86 
+	}
+}
+
+89 
+	$_fm_r
+(c 
+_fo
+ *
+
+, *
+buf
+, 
+size_t
+ 
+bu
+)
+
+91 
+sysid
+[
+LACP_SYSTEMIDSTR_MAX
++1];
+
+92 
+ptid
+[
+LACP_PORTIDSTR_MAX
++1];
+
+94 
+	`tf
+(
+buf
+, 
+bu
+, "(%s,%04X,%s)",
+
+95 
+	`_fm_syemid
+(&
+
+->
+l_syemid
+, 
+sysid
+, (sysid)),
+
+96 
+	`be16toh
+(
+
+->
+l_key
+),
+
+97 
+	`_fm_ptid
+(&
+
+->
+l_ptid
+, 
+ptid
+, (portid)));
+
+99  
+buf
+;
+
+100 
+	}
+}
+
+103 
+	$_fm_gid
+(c 
+_fo
+ *
+a
+,
+
+104 c 
+_fo
+ *
+b
+, *
+buf
+, 
+size_t
+ 
+bu
+)
+
+106 
+ar
+[
+LACP_PARTNERSTR_MAX
++1];
+
+107 
+br
+[
+LACP_PARTNERSTR_MAX
++1];
+
+115 i(
+	`_com_fo
+(
+a
+, 
+b
+) > 0) {
+
+116 c 
+_fo
+ *
+t
+;
+
+118 
+t
+ = 
+a
+;
+
+119 
+a
+ = 
+b
+;
+
+120 
+b
+ = 
+t
+;
+
+124 
+	`tf
+(
+buf
+, 
+bu
+, "[%s,%s]",
+
+125 
+	`_fm_r
+(
+a
+, 
+ar
+, (astr)),
+
+126 
+	`_fm_r
+(
+b
+, 
+br
+, (bstr)));
+
+128  
+buf
+;
+
+129 
+	}
+}
+
+132 
+	$_fm_gid_aggg
+(c 
+_aggg
+ *
+
+,
+
+133 *
+buf
+, 
+size_t
+ 
+bu
+)
+
+136 i(
+
+ =
+NULL
+) {
+
+140  
+	`_fm_gid
+(&
+
+->
+_a
+, &->
+_r
+, 
+buf
+, 
+bu
+);
+
+141 
+	}
+}
+
+144 
+	$_fm_e
+(
+ut8_t
+ 
+e
+, *
+buf
+, 
+size_t
+ 
+bu
+)
+
+146 c 
+_e_bs
+[] = 
+LACP_STATE_BITS
+;
+
+148 
+	`tb
+(
+buf
+, 
+bu
+, 
+_e_bs
+, 
+e
+);
+
+150  
+buf
+;
+
+151 
+	}
+}
+
+154 
+	$_dump_du
+(c 
+du
+ *
+du
+)
+
+156 
+buf
+[
+LACP_PARTNERSTR_MAX
++1];
+
+157 
+buf2
+[
+LACP_STATESTR_MAX
++1];
+
+159 
+	`tf
+("actor=%s\n",
+
+160 
+	`_fm_r
+(&
+du
+->
+ldu_a
+, 
+buf
+, (buf)));
+
+161 
+	`tf
+("actor.state=%s\n",
+
+162 
+	`_fm_e
+(
+du
+->
+ldu_a
+.
+l_e
+, 
+buf2
+, (buf2)));
+
+163 
+	`tf
+("partner=%s\n",
+
+164 
+	`_fm_r
+(&
+du
+->
+ldu_r
+, 
+buf
+, (buf)));
+
+165 
+	`tf
+("partner.state=%s\n",
+
+166 
+	`_fm_e
+(
+du
+->
+ldu_r
+.
+l_e
+, 
+buf2
+, (buf2)));
+
+168 
+	`tf
+("maxday=%d\n", 
+	`be16toh
+(
+du
+->
+ldu_c
+.
+lci_maxday
+));
+
+169 
+	}
+}
+
+171 #i
+defed
+(
+LACP_DEBUG
+)
+
+172 
+	~<t/agr/if_agrv_im.h
+>
+
+175 
+	$_dtf
+(c 
+_pt
+ *
+
+, c *
+fmt
+, ...)
+
+177 
+va_li
+ 
+va
+;
+
+179 i(
+debug
+ == 0) {
+
+183 i(
+
+) {
+
+184 
+	`tf
+("%s: ", 
+
+->
+_agt
+->
+pt_i
+->
+if_xme
+);
+
+187 
+	`va_t
+(
+va
+, 
+fmt
+);
+
+188 
+	`vtf
+(
+fmt
+, 
+va
+);
+
+189 
+	`va_d
+(
+va
+);
+
+190 
+	}
+}
+
+	@agr/ieee8023ad_lacp_debug.h
+
+29 #ide
+_NET_AGR_IEEE8023AD_LACP_DEBUG_H_
+
+
+30 
+	#_NET_AGR_IEEE8023AD_LACP_DEBUG_H_
+
+
+	)
+
+32 
+	#LACP_DEBUG
+
+
+	)
+
+35 
+	#LACP_MACSTR_MAX
+ (2*6 + 5)
+
+	)
+
+36 
+	#LACP_SYSTEMPRIOSTR_MAX
+ (4)
+
+	)
+
+37 
+	#LACP_SYSTEMIDSTR_MAX
+ (
+LACP_SYSTEMPRIOSTR_MAX
+ + 1 + 
+LACP_MACSTR_MAX
+)
+
+	)
+
+38 
+	#LACP_PORTPRIOSTR_MAX
+ (4)
+
+	)
+
+39 
+	#LACP_PORTNOSTR_MAX
+ (4)
+
+	)
+
+40 
+	#LACP_PORTIDSTR_MAX
+ (
+LACP_PORTPRIOSTR_MAX
+ + 1 + 
+LACP_PORTNOSTR_MAX
+)
+
+	)
+
+41 
+	#LACP_KEYSTR_MAX
+ (4)
+
+	)
+
+42 
+	#LACP_PARTNERSTR_MAX
+ \
+
+43 (1 + 
+LACP_SYSTEMIDSTR_MAX
+ + 1 + 
+LACP_KEYSTR_MAX
+ + 1 \
+
+44 + 
+LACP_PORTIDSTR_MAX
+ + 1)
+
+	)
+
+45 
+	#LACP_LAGIDSTR_MAX
+ \
+
+46 (1 + 
+LACP_PARTNERSTR_MAX
+ + 1 + LACP_PARTNERSTR_MAX + 1)
+
+	)
+
+47 
+	#LACP_STATESTR_MAX
+ (255
+
+	)
+
+49 
+_dump_du
+(c 
+du
+ *);
+
+50 c *
+_fm_r
+(c 
+_fo
+ *, *, 
+size_t
+);
+
+51 c *
+_fm_gid
+(c 
+_fo
+ *,
+
+52 c 
+_fo
+ *, *, 
+size_t
+);
+
+53 c *
+_fm_gid_aggg
+(c 
+_aggg
+ *,
+
+54 *, 
+size_t
+);
+
+55 c *
+_fm_e
+(
+ut8_t
+, *, 
+size_t
+);
+
+56 c *
+_fm_mac
+(c 
+ut8_t
+ *, *, 
+size_t
+);
+
+57 c *
+_fm_syemid
+(c 
+_syemid
+ *, *, 
+size_t
+);
+
+58 c *
+_fm_ptid
+(c 
+_ptid
+ *, *, 
+size_t
+);
+
+60 #i
+defed
+(
+LACP_DEBUG
+)
+
+61 
+debug
+;
+
+62 
+	$_dtf
+(c 
+_pt
+ *, const *, ...)
+
+63 
+	`__ibu__
+((
+	`__fm__
+(
+__tf__
+, 2, 3)));
+
+64 
+	#LACP_DPRINTF
+(
+a
+i(
+debug
+
+_dtf
+ 
+	)
+a
+
+66 
+	#LACP_DPRINTF
+(
+a
+
+
+	)
+
+	@agr/ieee8023ad_lacp_impl.h
+
+29 #ide
+_NET_AGR_IEEE8023AD_LACP_IMPL_H_
+
+
+30 
+	#_NET_AGR_IEEE8023AD_LACP_IMPL_H_
+
+
+	)
+
+38 
+	~<sys/queue.h
+>
+
+40 
+	#LACP_TIMER_CURRENT_WHILE
+ 0
+
+	)
+
+41 
+	#LACP_TIMER_PERIODIC
+ 1
+
+	)
+
+42 
+	#LACP_TIMER_WAIT_WHILE
+ 2
+
+	)
+
+43 
+	#LACP_NTIMER
+ 3
+
+	)
+
+45 
+	#LACP_TIMER_ARM
+(
+pt
+, 
+tim
+, 
+v
+) \
+
+46 (
+pt
+)->
+_tim
+[(
+tim
+)] = (
+v
+)
+
+	)
+
+47 
+	#LACP_TIMER_DISARM
+(
+pt
+, 
+tim
+) \
+
+48 (
+pt
+)->
+_tim
+[(
+tim
+)] = 0
+
+	)
+
+49 
+	#LACP_TIMER_ISARMED
+(
+pt
+, 
+tim
+) \
+
+50 ((
+pt
+)->
+_tim
+[(
+tim
+)] > 0)
+
+	)
+
+52 
+	s_aggg
+ {
+
+53 
+TAILQ_ENTRY
+(
+_aggg
+
+	m_q
+;
+
+54 
+	m_ft
+;
+
+55 
+	m_ts
+;
+
+56 
+TAILQ_HEAD
+(, 
+_pt
+
+	m_pts
+;
+
+57 
+_fo
+ 
+	m_r
+;
+
+58 
+_fo
+ 
+	m_a
+;
+
+59 
+	m_ndg
+;
+
+62 
+	s_soc
+ {
+
+63 
+_aggg
+ *
+	mlsc_aive_aggg
+;
+
+64 
+TAILQ_HEAD
+(, 
+_aggg
+
+	mlsc_agggs
+;
+
+65 
+bo
+ 
+	mlsc_suss_diributg
+;
+
+66 
+out
+ 
+	mlsc_s_out
+;
+
+69 
+	#LACP_TRANSIT_DELAY
+ 1000
+
+	)
+
+71 
+	e_ed
+ {
+
+72 
+	mLACP_UNSELECTED
+,
+
+73 
+	mLACP_STANDBY
+,
+
+74 
+	mLACP_SELECTED
+,
+
+77 
+	e_mux_e
+ {
+
+78 
+	mLACP_MUX_DETACHED
+,
+
+79 
+	mLACP_MUX_WAITING
+,
+
+80 
+	mLACP_MUX_ATTACHED
+,
+
+81 
+	mLACP_MUX_COLLECTING
+,
+
+82 
+	mLACP_MUX_DISTRIBUTING
+,
+
+85 
+	s_pt
+ {
+
+86 
+TAILQ_ENTRY
+(
+_pt
+
+	m_di_q
+;
+
+87 
+agr_pt
+ *
+	m_agt
+;
+
+88 
+_fo
+ 
+	m_r
+;
+
+89 
+_fo
+ 
+	m_a
+;
+
+90 
+	#_e
+ 
+_a
+.
+l_e
+
+
+	)
+
+91 
+	#_key
+ 
+_a
+.
+l_key
+
+
+	)
+
+92 
+	m__du_
+;
+
+93 
+_mux_e
+ 
+	m_mux_e
+;
+
+94 
+_ed
+ 
+	m_ed
+;
+
+95 
+	m_ags
+;
+
+96 
+u_t
+ 
+	m_med
+;
+
+97 
+	m_tim
+[
+LACP_NTIMER
+];
+
+99 
+_aggg
+ *
+	m_aggg
+;
+
+102 
+	#LACPPORT_NTT
+ 1
+
+	)
+
+104 
+	#LACP_SOFTC
+(
+sc
+) \
+
+105 (&
+	`IEEE8023AD_SOFTC
+(
+sc
+)->
+isc_sc
+)
+
+	)
+
+106 
+	#LACP_PORT
+(
+pt
+) \
+
+107 (&
+	`IEEE8023AD_PORT
+(
+pt
+)->
+t_pt
+)
+
+	)
+
+109 
+_run_tims
+(
+_pt
+ *);
+
+110 
+_pt
+(
+agr_pt
+ *);
+
+111 
+_ptfi
+(
+agr_pt
+ *);
+
+112 
+_com_fo
+(c 
+_fo
+ *,
+
+113 c 
+_fo
+ *);
+
+114 
+_com_syemid
+(c 
+_syemid
+ *,
+
+115 c 
+_syemid
+ *);
+
+116 
+_com_ptid
+(c 
+_ptid
+ *,
+
+117 c 
+_ptid
+ *);
+
+119 
+_
+(
+_pt
+ *);
+
+120 
+_un
+(
+_pt
+ *);
+
+122 
+_dib_cg
+(
+_pt
+ *);
+
+123 
+_ab_cg
+(
+_pt
+ *);
+
+124 
+_dib_diributg
+(
+_pt
+ *);
+
+125 
+_ab_diributg
+(
+_pt
+ *);
+
+127 
+_xm_du
+(
+_pt
+ *);
+
+	@agr/ieee8023ad_lacp_select.c
+
+29 
+	~<sys/cdefs.h
+>
+
+30 
+__KERNEL_RCSID
+(0, "$NetBSD: ieee8023ad_lacp_select.c,v 1.5 2007/02/22 06:20:16horpej Exp $");
+
+32 
+	~<sys/m.h
+>
+
+33 
+	~<sys/out.h
+>
+
+34 
+	~<sys/mbuf.h
+>
+
+35 
+	~<sys/sym.h
+>
+
+37 
+	~<t/if.h
+>
+
+38 
+	~<t/if_h.h
+>
+
+40 
+	~<t/agr/if_agrv_im.h
+>
+
+41 
+	~<t/agr/8023_owocs.h
+>
+
+42 
+	~<t/agr/8023_v.h
+>
+
+43 
+	~<t/agr/8023ad_.h
+>
+
+44 
+	~<t/agr/8023ad__im.h
+>
+
+45 
+	~<t/agr/8023ad_im.h
+>
+
+46 
+	~<t/agr/8023ad__debug.h
+>
+
+50 
+_fl_aggg_id
+(
+_aggg
+ *,
+
+51 c 
+_pt
+ *);
+
+52 
+_fl_aggg_id_
+(
+_fo
+ *,
+
+53 c 
+_fo
+ *);
+
+54 
+bo
+ 
+_aggg_is_comtib
+(c 
+_aggg
+ *,
+
+55 c 
+_pt
+ *);
+
+56 
+bo
+ 
+_fo_is_comtib
+(c 
+_fo
+ *,
+
+57 c 
+_fo
+ *);
+
+59 
+_aggg
+ *
+_aggg_g
+(
+_soc
+ *,
+
+60 
+_pt
+ *);
+
+61 
+_aggg_addf
+(
+_soc
+ *,
+
+62 
+_aggg
+ *);
+
+63 
+_aggg_df
+(
+_soc
+ *,
+
+64 
+_aggg
+ *);
+
+67 
+	$_aggg_addf
+(
+_soc
+ *
+lsc
+, 
+_aggg
+ *
+
+)
+
+69 #i
+	`defed
+(
+LACP_DEBUG
+)
+
+70 
+buf
+[
+LACP_LAGIDSTR_MAX
++1];
+
+73 
+	`LACP_DPRINTF
+((
+NULL
+, "%s:agid=%s,efcnt %d -> %d\n",
+
+74 
+__func__
+,
+
+75 
+	`_fm_gid
+(&
+
+->
+_a
+, &->
+_r
+,
+
+76 
+buf
+, (buf)),
+
+77 
+
+->
+_ft
+,a->la_refcnt + 1));
+
+79 
+	`KASSERT
+(
+
+->
+_ft
+ > 0);
+
+80 
+
+->
+_ft
+++;
+
+81 
+	`KASSERT
+(
+
+->
+_ft
+ >a->
+_ts
+);
+
+82 
+	}
+}
+
+85 
+	$_aggg_df
+(
+_soc
+ *
+lsc
+, 
+_aggg
+ *
+
+)
+
+87 #i
+	`defed
+(
+LACP_DEBUG
+)
+
+88 
+buf
+[
+LACP_LAGIDSTR_MAX
++1];
+
+91 
+	`LACP_DPRINTF
+((
+NULL
+, "%s:agid=%s,efcnt %d -> %d\n",
+
+92 
+__func__
+,
+
+93 
+	`_fm_gid
+(&
+
+->
+_a
+, &->
+_r
+,
+
+94 
+buf
+, (buf)),
+
+95 
+
+->
+_ft
+,a->la_refcnt - 1));
+
+97 
+	`KASSERT
+(
+
+->
+_ft
+ >a->
+_ts
+);
+
+98 
+
+->
+_ft
+--;
+
+99 i(
+
+->
+_ft
+ > 0) {
+
+103 
+	`KASSERT
+(
+
+->
+_ft
+ == 0);
+
+104 
+	`KASSERT
+(
+lsc
+->
+lsc_aive_aggg
+ !
+
+);
+
+106 
+	`TAILQ_REMOVE
+(&
+lsc
+->
+lsc_agggs
+, 
+
+, 
+_q
+);
+
+108 
+	`
+(
+
+, 
+M_DEVBUF
+);
+
+109 
+	}
+}
+
+115 
+_aggg
+ *
+
+116 
+	$_aggg_g
+(
+_soc
+ *
+lsc
+, 
+_pt
+ *
+
+)
+
+118 
+_aggg
+ *
+
+;
+
+120 
+
+ = 
+	`mloc
+((*), 
+M_DEVBUF
+, 
+M_NOWAIT
+);
+
+121 i(
+
+) {
+
+122 
+
+->
+_ft
+ = 1;
+
+123 
+
+->
+_ts
+ = 0;
+
+124 
+	`TAILQ_INIT
+(&
+
+->
+_pts
+);
+
+125 
+
+->
+_ndg
+ = 0;
+
+126 
+	`TAILQ_INSERT_TAIL
+(&
+lsc
+->
+lsc_agggs
+, 
+
+, 
+_q
+);
+
+129  
+
+;
+
+130 
+	}
+}
+
+137 
+	$_fl_aggg_id
+(
+_aggg
+ *
+
+, c 
+_pt
+ *
+
+)
+
+140 
+	`_fl_aggg_id_
+(&
+
+->
+_r
+, &
+
+->
+_r
+);
+
+141 
+	`_fl_aggg_id_
+(&
+
+->
+_a
+, &
+
+->
+_a
+);
+
+143 
+
+->
+_a
+.
+l_e
+ = 
+
+->
+_e
+ & 
+LACP_STATE_AGGREGATION
+;
+
+144 
+	}
+}
+
+147 
+	$_fl_aggg_id_
+(
+_fo
+ *
+i_aggr
+,
+
+148 c 
+_fo
+ *
+i_pt
+)
+
+151 
+	`memt
+(
+i_aggr
+, 0, (*lpi_aggr));
+
+152 
+i_aggr
+->
+l_syemid
+ = 
+i_pt
+->lip_systemid;
+
+153 
+i_aggr
+->
+l_key
+ = 
+i_pt
+->lip_key;
+
+154 
+	}
+}
+
+160 
+bo
+
+
+161 
+	$_aggg_is_comtib
+(c 
+_aggg
+ *
+
+,
+
+162 c 
+_pt
+ *
+
+)
+
+165 i(!(
+
+->
+_e
+ & 
+LACP_STATE_AGGREGATION
+) ||
+
+166 !(
+
+->
+_r
+.
+l_e
+ & 
+LACP_STATE_AGGREGATION
+)) {
+
+167  
+l
+;
+
+170 i(!(
+
+->
+_a
+.
+l_e
+ & 
+LACP_STATE_AGGREGATION
+)) {
+
+171  
+l
+;
+
+174 i(!
+	`_fo_is_comtib
+(&
+
+->
+_r
+, &
+
+->
+_r
+)) {
+
+175  
+l
+;
+
+178 i(!
+	`_fo_is_comtib
+(&
+
+->
+_a
+, &
+
+->
+_a
+)) {
+
+179  
+l
+;
+
+182  
+ue
+;
+
+183 
+	}
+}
+
+185 
+bo
+
+
+186 
+	$_fo_is_comtib
+(c 
+_fo
+ *
+a
+,
+
+187 c 
+_fo
+ *
+b
+)
+
+190 i(
+	`memcmp
+(&
+a
+->
+l_syemid
+, &
+b
+->lip_systemid,
+
+191 (
+a
+->
+l_syemid
+))) {
+
+192  
+l
+;
+
+195 i(
+	`memcmp
+(&
+a
+->
+l_key
+, &
+b
+->lip_key, (a->lip_key))) {
+
+196  
+l
+;
+
+199  
+ue
+;
+
+200 
+	}
+}
+
+207 
+	$_
+(
+_pt
+ *
+
+)
+
+209 
+_soc
+ *
+lsc
+ = 
+	`LACP_SOFTC
+(
+	`AGR_SC_FROM_PORT
+(
+
+->
+_agt
+));
+
+210 
+_aggg
+ *
+
+;
+
+211 #i
+	`defed
+(
+LACP_DEBUG
+)
+
+212 
+buf
+[
+LACP_LAGIDSTR_MAX
++1];
+
+215 i(
+
+->
+_aggg
+) {
+
+219 
+	`KASSERT
+(!
+	`LACP_TIMER_ISARMED
+(
+
+, 
+LACP_TIMER_WAIT_WHILE
+));
+
+221 
+	`LACP_DPRINTF
+((
+
+, "portagid=%s\n",
+
+222 
+	`_fm_gid
+(&
+
+->
+_a
+, &->
+_r
+,
+
+223 
+buf
+, (buf))));
+
+225 
+	`TAILQ_FOREACH
+(
+
+, &
+lsc
+->
+lsc_agggs
+, 
+_q
+) {
+
+226 i(
+	`_aggg_is_comtib
+(
+
+, 
+
+)) {
+
+231 i(
+
+ =
+NULL
+) {
+
+232 
+
+ = 
+	`_aggg_g
+(
+lsc
+, 
+
+);
+
+233 i(
+
+ =
+NULL
+) {
+
+234 
+	`LACP_DPRINTF
+((
+
+, "aggregator creation failed\n"));
+
+242 
+	`_fl_aggg_id
+(
+
+, 
+
+);
+
+243 
+	`LACP_DPRINTF
+((
+
+, "aggregator created\n"));
+
+245 
+	`LACP_DPRINTF
+((
+
+, "compatibleggregator found\n"));
+
+246 
+	`_aggg_addf
+(
+lsc
+, 
+
+);
+
+249 
+	`LACP_DPRINTF
+((
+
+, "aggregatoragid=%s\n",
+
+250 
+	`_fm_gid
+(&
+
+->
+_a
+, &->
+_r
+,
+
+251 
+buf
+, (buf))));
+
+253 
+
+->
+_aggg
+ = 
+
+;
+
+254 
+
+->
+_ed
+ = 
+LACP_SELECTED
+;
+
+255 
+	}
+}
+
+262 
+	$_un
+(
+_pt
+ *
+
+)
+
+264 
+_soc
+ *
+lsc
+ = 
+	`LACP_SOFTC
+(
+	`AGR_SC_FROM_PORT
+(
+
+->
+_agt
+));
+
+265 
+_aggg
+ *
+
+ = 
+
+->
+_aggg
+;
+
+267 
+	`KASSERT
+(!
+	`LACP_TIMER_ISARMED
+(
+
+, 
+LACP_TIMER_WAIT_WHILE
+));
+
+269 i(
+
+ =
+NULL
+) {
+
+273 
+
+->
+_aggg
+ = 
+NULL
+;
+
+274 
+	`_aggg_df
+(
+lsc
+, 
+
+);
+
+275 
+	}
+}
+
+	@agr/ieee8023ad_lacp_sm.h
+
+29 #ide
+_NET_AGR_IEEE8023AD_LACP_SM_H_
+
+
+30 
+	#_NET_AGR_IEEE8023AD_LACP_SM_H_
+
+
+	)
+
+32 
+	#LACP_STATE_EQ
+(
+s1
+, 
+s2
+, 
+mask
+) \
+
+33 ((((
+s1
+^ (
+s2
+)& (
+mask
+)=0)
+
+	)
+
+37 
+_sm_rx
+(
+_pt
+ *, c 
+du
+ *);
+
+38 
+_sm_rx_tim
+(
+_pt
+ *);
+
+39 
+_sm_rx_t_exped
+(
+_pt
+ *);
+
+43 
+_sm_mux
+(
+_pt
+ *);
+
+44 
+_sm_mux_tim
+(
+_pt
+ *);
+
+48 
+_sm_x_upde_timeout
+(
+_pt
+ *, 
+ut8_t
+);
+
+49 
+_sm_x_tx_schedu
+(
+_pt
+ *);
+
+50 
+_sm_x_tim
+(
+_pt
+ *);
+
+54 
+_sm_tx
+(
+_pt
+ *);
+
+55 
+_sm_as_t
+(
+_pt
+ *);
+
+	@agr/ieee8023ad_lacp_sm_mux.c
+
+29 
+	~<sys/cdefs.h
+>
+
+30 
+__KERNEL_RCSID
+(0, "$NetBSD: ieee8023ad_lacp_sm_mux.c,v 1.4 2007/02/21 23:00:07horpej Exp $");
+
+32 
+	~<sys/m.h
+>
+
+33 
+	~<sys/out.h
+>
+
+34 
+	~<sys/mbuf.h
+>
+
+35 
+	~<sys/sym.h
+>
+
+37 
+	~<t/if.h
+>
+
+38 
+	~<t/if_h.h
+>
+
+40 
+	~<t/agr/8023_owocs.h
+>
+
+41 
+	~<t/agr/8023_v.h
+>
+
+42 
+	~<t/agr/8023ad_.h
+>
+
+43 
+	~<t/agr/8023ad__im.h
+>
+
+44 
+	~<t/agr/8023ad__sm.h
+>
+
+45 
+	~<t/agr/8023ad__debug.h
+>
+
+50 
+	$_sm_mux
+(
+_pt
+ *
+
+)
+
+52 
+_mux_e
+ 
+w_e
+;
+
+53 
+bo
+ 
+p_sync
+ =
+
+54 (
+
+->
+_r
+.
+l_e
+ & 
+LACP_STATE_SYNC
+) != 0;
+
+55 
+bo
+ 
+p_cg
+ =
+
+56 (
+
+->
+_r
+.
+l_e
+ & 
+LACP_STATE_COLLECTING
+) != 0;
+
+57 
+_ed
+ 
+ed
+ = 
+
+->
+_ed
+;
+
+58 
+_aggg
+ *
+
+;
+
+62 
+_ev
+:
+
+63 
+
+ = 
+
+->
+_aggg
+;
+
+64 
+	`KASSERT
+(
+
+->
+_mux_e
+ =
+LACP_MUX_DETACHED
+ || 
+
+ !
+NULL
+);
+
+65 
+w_e
+ = 
+
+->
+_mux_e
+;
+
+66 
+
+->
+_mux_e
+) {
+
+67 
+LACP_MUX_DETACHED
+:
+
+68 i(
+ed
+ !
+LACP_UNSELECTED
+) {
+
+69 
+w_e
+ = 
+LACP_MUX_WAITING
+;
+
+72 
+LACP_MUX_WAITING
+:
+
+73 
+	`KASSERT
+(
+
+->
+_ndg
+ > 0 ||
+
+74 !
+	`LACP_TIMER_ISARMED
+(
+
+, 
+LACP_TIMER_WAIT_WHILE
+));
+
+75 i(
+ed
+ =
+LACP_SELECTED
+ && 
+
+->
+_ndg
+ == 0) {
+
+76 
+w_e
+ = 
+LACP_MUX_ATTACHED
+;
+
+77 } i(
+ed
+ =
+LACP_UNSELECTED
+) {
+
+78 
+w_e
+ = 
+LACP_MUX_DETACHED
+;
+
+81 
+LACP_MUX_ATTACHED
+:
+
+82 i(
+ed
+ =
+LACP_SELECTED
+ && 
+p_sync
+) {
+
+83 
+w_e
+ = 
+LACP_MUX_COLLECTING
+;
+
+84 } i(
+ed
+ !
+LACP_SELECTED
+) {
+
+85 
+w_e
+ = 
+LACP_MUX_DETACHED
+;
+
+88 
+LACP_MUX_COLLECTING
+:
+
+89 i(
+ed
+ =
+LACP_SELECTED
+ && 
+p_sync
+ && 
+p_cg
+) {
+
+90 
+w_e
+ = 
+LACP_MUX_DISTRIBUTING
+;
+
+91 } i(
+ed
+ !
+LACP_SELECTED
+ || !
+p_sync
+) {
+
+92 
+w_e
+ = 
+LACP_MUX_ATTACHED
+;
+
+95 
+LACP_MUX_DISTRIBUTING
+:
+
+96 i(
+ed
+ !
+LACP_SELECTED
+ || !
+p_sync
+ || !
+p_cg
+) {
+
+97 
+w_e
+ = 
+LACP_MUX_COLLECTING
+;
+
+101 
+	`nic
+("%s: unknowe", 
+__func__
+);
+
+104 i(
+
+->
+_mux_e
+ =
+w_e
+) {
+
+108 
+w_e
+) {
+
+109 
+LACP_MUX_DETACHED
+:
+
+110 
+
+->
+_e
+ &~
+LACP_STATE_SYNC
+;
+
+111 
+	`_dib_diributg
+(
+
+);
+
+112 
+	`_dib_cg
+(
+
+);
+
+113 
+	`_sm_as_t
+(
+
+);
+
+115 i(
+	`LACP_TIMER_ISARMED
+(
+
+, 
+LACP_TIMER_WAIT_WHILE
+)) {
+
+116 
+	`KASSERT
+(
+
+->
+_ndg
+ > 0);
+
+117 
+
+->
+_ndg
+--;
+
+119 
+	`LACP_TIMER_DISARM
+(
+
+, 
+LACP_TIMER_WAIT_WHILE
+);
+
+120 
+	`_un
+(
+
+);
+
+122 
+LACP_MUX_WAITING
+:
+
+123 
+	`LACP_TIMER_ARM
+(
+
+, 
+LACP_TIMER_WAIT_WHILE
+,
+
+124 
+LACP_AGGREGATE_WAIT_TIME
+);
+
+125 
+
+->
+_ndg
+++;
+
+127 
+LACP_MUX_ATTACHED
+:
+
+128 
+
+->
+_e
+ |
+LACP_STATE_SYNC
+;
+
+129 
+	`_dib_cg
+(
+
+);
+
+130 
+	`_sm_as_t
+(
+
+);
+
+132 
+LACP_MUX_COLLECTING
+:
+
+133 
+	`_ab_cg
+(
+
+);
+
+134 
+
+->
+_e
+ |
+LACP_STATE_COLLECTING
+;
+
+135 
+	`_dib_diributg
+(
+
+);
+
+136 
+	`_sm_as_t
+(
+
+);
+
+138 
+LACP_MUX_DISTRIBUTING
+:
+
+139 
+	`_ab_diributg
+(
+
+);
+
+142 
+	`nic
+("%s: unknowe", 
+__func__
+);
+
+145 
+	`LACP_DPRINTF
+((
+
+, "mux_%d -> %d\n",p->
+_mux_e
+, 
+w_e
+));
+
+147 
+
+->
+_mux_e
+ = 
+w_e
+;
+
+148 
+_ev
+;
+
+149 
+	}
+}
+
+152 
+	$_sm_mux_tim
+(
+_pt
+ *
+
+)
+
+154 
+_aggg
+ *
+
+ = 
+
+->
+_aggg
+;
+
+155 #i
+	`defed
+(
+LACP_DEBUG
+)
+
+156 
+buf
+[
+LACP_LAGIDSTR_MAX
++1];
+
+159 
+	`KASSERT
+(
+
+);
+
+160 
+	`KASSERT
+(
+
+->
+_ndg
+ > 0);
+
+162 
+	`LACP_DPRINTF
+((
+
+, "%s:ggg %s,dg %d -> %d\n", 
+__func__
+,
+
+163 
+	`_fm_gid
+(&
+
+->
+_a
+, &->
+_r
+,
+
+164 
+buf
+, (buf)),
+
+165 
+
+->
+_ndg
+,a->la_pending - 1));
+
+167 
+
+->
+_ndg
+--;
+
+168 
+	}
+}
+
+	@agr/ieee8023ad_lacp_sm_ptx.c
+
+29 
+	~<sys/cdefs.h
+>
+
+30 
+__KERNEL_RCSID
+(0, "$NetBSD: ieee8023ad_lacp_sm_ptx.c,v 1.3 2005/12/11 12:24:54 christos Exp $");
+
+32 
+	~<sys/m.h
+>
+
+33 
+	~<sys/out.h
+>
+
+34 
+	~<sys/mbuf.h
+>
+
+35 
+	~<sys/sym.h
+>
+
+37 
+	~<t/if.h
+>
+
+38 
+	~<t/if_h.h
+>
+
+40 
+	~<t/agr/8023_owocs.h
+>
+
+41 
+	~<t/agr/8023_v.h
+>
+
+42 
+	~<t/agr/8023ad_.h
+>
+
+43 
+	~<t/agr/8023ad__im.h
+>
+
+44 
+	~<t/agr/8023ad__sm.h
+>
+
+45 
+	~<t/agr/8023ad__debug.h
+>
+
+50 
+	$_sm_x_upde_timeout
+(
+_pt
+ *
+
+, 
+ut8_t
+ 
+dpe
+)
+
+53 i(
+	`LACP_STATE_EQ
+(
+dpe
+, 
+
+->
+_r
+.
+l_e
+,
+
+54 
+LACP_STATE_TIMEOUT
+)) {
+
+58 
+	`LACP_DPRINTF
+((
+
+, "partnerimeout changed\n"));
+
+68 
+	`LACP_TIMER_DISARM
+(
+
+, 
+LACP_TIMER_PERIODIC
+);
+
+74 i((
+
+->
+_r
+.
+l_e
+ & 
+LACP_STATE_TIMEOUT
+)) {
+
+75 
+	`_sm_as_t
+(
+
+);
+
+77 
+	}
+}
+
+80 
+	$_sm_x_tx_schedu
+(
+_pt
+ *
+
+)
+
+82 
+timeout
+;
+
+84 i(!(
+
+->
+_e
+ & 
+LACP_STATE_ACTIVITY
+) &&
+
+85 !(
+
+->
+_r
+.
+l_e
+ & 
+LACP_STATE_ACTIVITY
+)) {
+
+91 
+	`LACP_TIMER_DISARM
+(
+
+, 
+LACP_TIMER_PERIODIC
+);
+
+95 i(
+	`LACP_TIMER_ISARMED
+(
+
+, 
+LACP_TIMER_PERIODIC
+)) {
+
+99 
+timeout
+ = (
+
+->
+_r
+.
+l_e
+ & 
+LACP_STATE_TIMEOUT
+) ?
+
+100 
+LACP_FAST_PERIODIC_TIME
+ : 
+LACP_SLOW_PERIODIC_TIME
+;
+
+102 
+	`LACP_TIMER_ARM
+(
+
+, 
+LACP_TIMER_PERIODIC
+, 
+timeout
+);
+
+103 
+	}
+}
+
+106 
+	$_sm_x_tim
+(
+_pt
+ *
+
+)
+
+109 
+	`_sm_as_t
+(
+
+);
+
+110 
+	}
+}
+
+	@agr/ieee8023ad_lacp_sm_rx.c
+
+29 
+	~<sys/cdefs.h
+>
+
+30 
+__KERNEL_RCSID
+(0, "$NetBSD: ieee8023ad_lacp_sm_rx.c,v 1.4 2007/02/21 23:00:07horpej Exp $");
+
+32 
+	~<sys/m.h
+>
+
+33 
+	~<sys/out.h
+>
+
+34 
+	~<sys/mbuf.h
+>
+
+35 
+	~<sys/sym.h
+>
+
+37 
+	~<t/if.h
+>
+
+38 
+	~<t/if_h.h
+>
+
+40 
+	~<t/agr/8023_owocs.h
+>
+
+41 
+	~<t/agr/8023_v.h
+>
+
+42 
+	~<t/agr/8023ad_.h
+>
+
+43 
+	~<t/agr/8023ad__im.h
+>
+
+44 
+	~<t/agr/8023ad__sm.h
+>
+
+45 
+	~<t/agr/8023ad__debug.h
+>
+
+49 
+_sm_rx_upde_t
+(
+_pt
+ *, c 
+du
+ *);
+
+50 
+_sm_rx_cd_pdu
+(
+_pt
+ *, c 
+du
+ *);
+
+51 
+_sm_rx_upde_ed
+(
+_pt
+ *, c 
+du
+ *);
+
+53 
+_sm_rx_cd_deu
+(
+_pt
+ *);
+
+54 
+_sm_rx_upde_deu_ed
+(
+_pt
+ *);
+
+56 
+_sm_rx_upde_ed_om_fo
+(
+_pt
+ *,
+
+57 c 
+_fo
+ *);
+
+64 c 
+_fo
+ 
+	g_r_adm
+ = {
+
+65 .
+l_syemid
+ = { .
+lsi_io
+ = 0xffff },
+
+66 .
+	gl_ptid
+ = { .
+i_io
+ = 0xffff },
+
+69 .
+	gl_e
+ = 
+LACP_STATE_SYNC
+ | 
+LACP_STATE_AGGREGATION
+ |
+
+70 
+LACP_STATE_COLLECTING
+ | 
+LACP_STATE_DISTRIBUTING
+,
+
+73 .
+	gl_e
+ = 0,
+
+78 
+	$_sm_rx
+(
+_pt
+ *
+
+, c 
+du
+ *
+du
+)
+
+80 
+timeout
+;
+
+86 i(!(
+
+->
+_e
+ & 
+LACP_STATE_AGGREGATION
+)) {
+
+94 i(!
+	`_com_syemid
+(&
+du
+->
+ldu_a
+.
+l_syemid
+,
+
+95 &
+
+->
+_a
+.
+l_syemid
+)) {
+
+103 
+	`_sm_rx_upde_ed
+(
+
+, 
+du
+);
+
+104 
+	`_sm_rx_upde_t
+(
+
+, 
+du
+);
+
+105 
+	`_sm_rx_cd_pdu
+(
+
+, 
+du
+);
+
+107 
+timeout
+ = (
+
+->
+_e
+ & 
+LACP_STATE_TIMEOUT
+) ?
+
+108 
+LACP_SHORT_TIMEOUT_TIME
+ : 
+LACP_LONG_TIMEOUT_TIME
+;
+
+109 
+	`LACP_TIMER_ARM
+(
+
+, 
+LACP_TIMER_CURRENT_WHILE
+, 
+timeout
+);
+
+111 
+
+->
+_e
+ &~
+LACP_STATE_EXPIRED
+;
+
+117 
+	`_sm_tx
+(
+
+);
+
+118 
+	}
+}
+
+121 
+	$_sm_rx_t_exped
+(
+_pt
+ *
+
+)
+
+124 
+
+->
+_r
+.
+l_e
+ &~
+LACP_STATE_SYNC
+;
+
+125 
+
+->
+_r
+.
+l_e
+ |
+LACP_STATE_TIMEOUT
+;
+
+126 
+	`LACP_TIMER_ARM
+(
+
+, 
+LACP_TIMER_CURRENT_WHILE
+, 
+LACP_SHORT_TIMEOUT_TIME
+);
+
+127 
+
+->
+_e
+ |
+LACP_STATE_EXPIRED
+;
+
+128 
+	}
+}
+
+131 
+	$_sm_rx_tim
+(
+_pt
+ *
+
+)
+
+134 i((
+
+->
+_e
+ & 
+LACP_STATE_EXPIRED
+) == 0) {
+
+136 
+	`LACP_DPRINTF
+((
+
+, "%s: CURRENT -> EXPIRED\n", 
+__func__
+));
+
+137 
+	`_sm_rx_t_exped
+(
+
+);
+
+140 
+	`LACP_DPRINTF
+((
+
+, "%s: EXPIRED -> DEFAULTED\n", 
+__func__
+));
+
+141 
+	`_sm_rx_upde_deu_ed
+(
+
+);
+
+142 
+	`_sm_rx_cd_deu
+(
+
+);
+
+143 
+
+->
+_e
+ &~
+LACP_STATE_EXPIRED
+;
+
+145 
+	}
+}
+
+148 
+	$_sm_rx_cd_pdu
+(
+_pt
+ *
+
+, c 
+du
+ *
+du
+)
+
+150 
+bo
+ 
+aive
+;
+
+151 
+ut8_t
+ 
+dpe
+;
+
+152 #i
+	`defed
+(
+LACP_DEBUG
+)
+
+153 
+buf
+[
+LACP_STATESTR_MAX
++1];
+
+158 
+dpe
+ = 
+
+->
+_r
+.
+l_e
+;
+
+160 
+aive
+ = (
+du
+->
+ldu_a
+.
+l_e
+ & 
+LACP_STATE_ACTIVITY
+)
+
+161 || ((
+
+->
+_e
+ & 
+LACP_STATE_ACTIVITY
+) &&
+
+162 (
+du
+->
+ldu_r
+.
+l_e
+ & 
+LACP_STATE_ACTIVITY
+));
+
+164 
+
+->
+_r
+ = 
+du
+->
+ldu_a
+;
+
+165 i(
+aive
+ &&
+
+166 ((
+	`LACP_STATE_EQ
+(
+
+->
+_e
+, 
+du
+->
+ldu_r
+.
+l_e
+,
+
+167 
+LACP_STATE_AGGREGATION
+) &&
+
+168 !
+	`_com_fo
+(&
+
+->
+_a
+, &
+du
+->
+ldu_r
+))
+
+169 || (
+du
+->
+ldu_r
+.
+l_e
+ & 
+LACP_STATE_AGGREGATION
+) == 0)) {
+
+172 
+
+->
+_r
+.
+l_e
+ &~
+LACP_STATE_SYNC
+;
+
+175 
+
+->
+_e
+ &~
+LACP_STATE_DEFAULTED
+;
+
+177 
+	`LACP_DPRINTF
+((
+
+, "oldstate %s\n",
+
+178 
+	`_fm_e
+(
+dpe
+, 
+buf
+, (buf))));
+
+179 
+	`LACP_DPRINTF
+((
+
+, "newstate %s\n",
+
+180 
+	`_fm_e
+(
+
+->
+_r
+.
+l_e
+, 
+buf
+, (buf))));
+
+182 
+	`_sm_x_upde_timeout
+(
+
+, 
+dpe
+);
+
+183 
+	}
+}
+
+186 
+	$_sm_rx_upde_t
+(
+_pt
+ *
+
+, c 
+du
+ *
+du
+)
+
+191 i(
+	`_com_fo
+(&
+
+->
+_a
+, &
+du
+->
+ldu_r
+) ||
+
+192 !
+	`LACP_STATE_EQ
+(
+
+->
+_e
+, 
+du
+->
+ldu_r
+.
+l_e
+,
+
+193 
+LACP_STATE_ACTIVITY
+ | 
+LACP_STATE_SYNC
+ | 
+LACP_STATE_AGGREGATION
+)) {
+
+194 
+	`LACP_DPRINTF
+((
+
+, "%s:s\n", 
+__func__
+));
+
+195 
+	`_sm_as_t
+(
+
+);
+
+197 
+	}
+}
+
+200 
+	$_sm_rx_cd_deu
+(
+_pt
+ *
+
+)
+
+202 
+ut8_t
+ 
+dpe
+;
+
+206 
+dpe
+ = 
+
+->
+_r
+.
+l_e
+;
+
+207 
+
+->
+_r
+ = 
+_r_adm
+;
+
+208 
+
+->
+_e
+ |
+LACP_STATE_DEFAULTED
+;
+
+209 
+	`_sm_x_upde_timeout
+(
+
+, 
+dpe
+);
+
+210 
+	}
+}
+
+213 
+	$_sm_rx_upde_ed_om_fo
+(
+_pt
+ *
+
+,
+
+214 c 
+_fo
+ *
+fo
+)
+
+219 i(
+	`_com_fo
+(&
+
+->
+_r
+, 
+fo
+) ||
+
+220 !
+	`LACP_STATE_EQ
+(
+
+->
+_r
+.
+l_e
+, 
+fo
+->lip_state,
+
+221 
+LACP_STATE_AGGREGATION
+)) {
+
+222 
+
+->
+_ed
+ = 
+LACP_UNSELECTED
+;
+
+225 
+	}
+}
+
+228 
+	$_sm_rx_upde_ed
+(
+_pt
+ *
+
+, c 
+du
+ *
+du
+)
+
+233 
+	`_sm_rx_upde_ed_om_fo
+(
+
+, &
+du
+->
+ldu_a
+);
+
+234 
+	}
+}
+
+237 
+	$_sm_rx_upde_deu_ed
+(
+_pt
+ *
+
+)
+
+242 
+	`_sm_rx_upde_ed_om_fo
+(
+
+, &
+_r_adm
+);
+
+243 
+	}
+}
+
+	@agr/ieee8023ad_lacp_sm_tx.c
+
+29 
+	~<sys/cdefs.h
+>
+
+30 
+__KERNEL_RCSID
+(0, "$NetBSD: ieee8023ad_lacp_sm_tx.c,v 1.3 2005/12/11 12:24:54 christos Exp $");
+
+32 
+	~<sys/m.h
+>
+
+33 
+	~<sys/out.h
+>
+
+34 
+	~<sys/mbuf.h
+>
+
+35 
+	~<sys/sym.h
+>
+
+36 
+	~<sys/kl.h
+>
+
+38 
+	~<t/if.h
+>
+
+39 
+	~<t/if_h.h
+>
+
+41 
+	~<t/agr/8023_owocs.h
+>
+
+42 
+	~<t/agr/8023_v.h
+>
+
+43 
+	~<t/agr/8023ad_.h
+>
+
+44 
+	~<t/agr/8023ad__im.h
+>
+
+45 
+	~<t/agr/8023ad__sm.h
+>
+
+46 
+	~<t/agr/8023ad__debug.h
+>
+
+51 
+	$_sm_tx
+(
+_pt
+ *
+
+)
+
+53 
+r
+;
+
+54 
+now
+;
+
+56 i(!(
+
+->
+_e
+ & 
+LACP_STATE_AGGREGATION
+)
+
+58 || (!(
+
+->
+_e
+ & 
+LACP_STATE_ACTIVITY
+)
+
+59 && !(
+
+->
+_r
+.
+l_e
+ & 
+LACP_STATE_ACTIVITY
+))
+
+62 
+
+->
+_ags
+ &~
+LACPPORT_NTT
+;
+
+65 i(!(
+
+->
+_ags
+ & 
+LACPPORT_NTT
+)) {
+
+70 
+now
+ = 
+hdock_ticks
+;
+
+71 i(()(
+now
+ - 
+
+->
+__du_
+) <=
+
+72 
+LACP_FAST_PERIODIC_TIME
+ * 
+hz
+ / 3) {
+
+75 
+
+->
+__du_
+ = 
+now
+;
+
+77 
+r
+ = 
+	`_xm_du
+(
+
+);
+
+79 i(
+r
+ == 0) {
+
+80 
+
+->
+_ags
+ &~
+LACPPORT_NTT
+;
+
+82 
+	`LACP_DPRINTF
+((
+
+, "lacpduransmit failure,rror %d\n",
+
+83 
+r
+));
+
+85 
+	}
+}
+
+88 
+	$_sm_as_t
+(
+_pt
+ *
+
+)
+
+91 
+
+->
+_ags
+ |
+LACPPORT_NTT
+;
+
+92 
+	}
+}
+
+	@agr/ieee8023ad_lacp_timer.c
+
+29 
+	~<sys/cdefs.h
+>
+
+30 
+__KERNEL_RCSID
+(0, "$NetBSD: ieee8023ad_lacp_timer.c,v 1.5 2006/10/22 03:39:43 uebayasi Exp $");
+
+32 
+	~<sys/m.h
+>
+
+33 
+	~<sys/out.h
+>
+
+34 
+	~<sys/sym.h
+>
+
+36 
+	~<t/if.h
+>
+
+37 
+	~<t/if_h.h
+>
+
+39 
+	~<t/agr/8023_owocs.h
+>
+
+40 
+	~<t/agr/8023_v.h
+>
+
+41 
+	~<t/agr/8023ad_.h
+>
+
+42 
+	~<t/agr/8023ad__im.h
+>
+
+43 
+	~<t/agr/8023ad__sm.h
+>
+
+45 (*
+	t_tim_func_t
+)(
+	t_pt
+ *);
+
+47 c 
+_tim_func_t
+ 
+_tim_funcs
+[
+LACP_NTIMER
+] = {
+
+48 [
+LACP_TIMER_CURRENT_WHILE
+] = 
+_sm_rx_tim
+,
+
+49 [
+LACP_TIMER_PERIODIC
+] = 
+_sm_x_tim
+,
+
+50 [
+LACP_TIMER_WAIT_WHILE
+] = 
+_sm_mux_tim
+,
+
+51 
+	}
+};
+
+54 
+	$_run_tims
+(
+_pt
+ *
+
+)
+
+56 
+i
+;
+
+58 
+i
+ = 0; i < 
+LACP_NTIMER
+; i++) {
+
+59 
+	`KASSERT
+(
+
+->
+_tim
+[
+i
+] >= 0);
+
+60 i(
+
+->
+_tim
+[
+i
+] == 0) {
+
+62 } i(--
+
+->
+_tim
+[
+i
+] <= 0) {
+
+63 i(
+_tim_funcs
+[
+i
+]) {
+
+64 (*
+_tim_funcs
+[
+i
+])(
+
+);
+
+68 
+	}
+}
+
+	@agr/ieee8023ad_marker.c
+
+29 
+	~<sys/cdefs.h
+>
+
+30 
+__KERNEL_RCSID
+(0, "$NetBSD: ieee8023ad_marker.c,v 1.4 2007/02/22 06:20:16horpej Exp $");
+
+32 
+	~<sys/m.h
+>
+
+33 
+	~<sys/out.h
+>
+
+34 
+	~<sys/mbuf.h
+>
+
+35 
+	~<sys/sym.h
+>
+
+37 
+	~<t/if.h
+>
+
+38 
+	~<t/if_h.h
+>
+
+40 
+	~<t/agr/if_agrv_im.h
+>
+
+41 
+	~<t/agr/8023_owocs.h
+>
+
+42 
+	~<t/agr/8023_v.h
+>
+
+43 
+	~<t/agr/8023ad.h
+>
+
+44 
+	~<t/agr/8023ad_mk.h
+>
+
+46 c 
+v_me
+ 
+	gmk_fo_v_me
+[] = {
+
+47 { 
+MARKER_TYPE_INFO
+, 16 },
+
+51 c 
+v_me
+ 
+	gmk__v_me
+[] = {
+
+52 { 
+MARKER_TYPE_RESPONSE
+, 16 },
+
+57 
+	$8023ad_mk_put
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+)
+
+59 
+mkdu
+ *
+mdu
+;
+
+60 
+agr_pt
+ *
+pt
+;
+
+61 
+r
+ = 0;
+
+63 
+pt
+ = 
+i
+->
+if_agrive
+;
+
+64 
+	`KASSERT
+(
+pt
+);
+
+65 i(
+	`__edi_l
+(
+pt
+->
+pt_ags
+ & 
+AGRPORT_DETACHING
+)) {
+
+66 
+bad
+;
+
+69 i(
+m
+->
+m_pkthdr
+.
+n
+ !(*
+mdu
+)) {
+
+70 
+bad
+;
+
+73 i((
+m
+->
+m_ags
+ & 
+M_MCAST
+) == 0) {
+
+74 
+bad
+;
+
+77 i(
+m
+->
+m_n
+ < (*
+mdu
+)) {
+
+78 
+m
+ = 
+	`m_puup
+(m, (*
+mdu
+));
+
+79 i(
+m
+ =
+NULL
+) {
+
+80  
+ENOMEM
+;
+
+84 
+mdu
+ = 
+	`mtod
+(
+m
+, 
+mkdu
+ *);
+
+86 i(
+	`memcmp
+(&
+mdu
+->
+mdu_eh
+.
+h_dho
+,
+
+87 &
+hmuiaddr_owocs
+, 
+ETHER_ADDR_LEN
+)) {
+
+88 
+bad
+;
+
+91 
+	`KASSERT
+(
+mdu
+->
+mdu_h
+.
+h_subty
+ =
+SLOWPROTOCOLS_SUBTYPE_MARKER
+);
+
+92 i(
+mdu
+->
+mdu_h
+.
+h_vsi
+ != 1) {
+
+93 
+bad
+;
+
+96 
+mdu
+->
+mdu_v
+.
+v_ty
+) {
+
+97 
+MARKER_TYPE_INFO
+:
+
+98 i(
+	`v_check
+(
+mdu
+, (*mdu), &mdu->
+mdu_v
+,
+
+99 
+mk_fo_v_me
+, 
+ue
+)) {
+
+100 
+bad
+;
+
+102 
+mdu
+->
+mdu_v
+.
+v_ty
+ = 
+MARKER_TYPE_RESPONSE
+;
+
+103 
+	`memy
+(&
+mdu
+->
+mdu_eh
+.
+h_dho
+,
+
+104 &
+hmuiaddr_owocs
+, 
+ETHER_ADDR_LEN
+);
+
+105 
+	`memy
+(&
+mdu
+->
+mdu_eh
+.
+h_sho
+,
+
+106 &
+pt
+->
+pt_igaddr
+, 
+ETHER_ADDR_LEN
+);
+
+107 
+r
+ = 
+	`agr_xm_ame
+(
+i
+, 
+m
+);
+
+110 
+MARKER_TYPE_RESPONSE
+:
+
+111 i(
+	`v_check
+(
+mdu
+, (*mdu), &mdu->
+mdu_v
+,
+
+112 
+mk__v_me
+, 
+ue
+)) {
+
+113 
+bad
+;
+
+121 
+bad
+;
+
+124  
+r
+;
+
+126 
+bad
+:
+
+127 
+	`m_m
+(
+m
+);
+
+128  
+EINVAL
+;
+
+129 
+	}
+}
+
+	@agr/ieee8023ad_marker.h
+
+29 #ide
+_NET_AGR_IEEE8023AD_MARKER_H_
+
+
+30 
+	#_NET_AGR_IEEE8023AD_MARKER_H_
+
+
+	)
+
+40 
+	smkdu
+ {
+
+41 
+h_hd
+ 
+	mmdu_eh
+;
+
+42 
+owhdr
+ 
+	mmdu_h
+;
+
+44 
+vhdr
+ 
+	mmdu_v
+;
+
+45 
+ut16_t
+ 
+	mmdu_rq_pt
+;
+
+46 
+ut8_t
+ 
+	mmdu_rq_syem
+[6];
+
+47 
+ut8_t
+ 
+	mmdu_rq_xid
+[4];
+
+48 
+ut8_t
+ 
+	mmdu_d
+[2];
+
+50 
+vhdr
+ 
+	mmdu_v_rm
+;
+
+51 
+ut8_t
+ 
+	mmdu_sv
+[90];
+
+52 } 
+	g__cked
+;
+
+54 
+	#MARKER_TYPE_INFO
+ 1
+
+	)
+
+55 
+	#MARKER_TYPE_RESPONSE
+ 2
+
+	)
+
+	@agr/if_agr.c
+
+29 
+	~<sys/cdefs.h
+>
+
+30 
+__KERNEL_RCSID
+(0, "$NetBSD: if_agr.c,v 1.31 2013/09/12 20:47:59 martin Exp $");
+
+32 
+	~"t_.h
+"
+
+34 
+	~<sys/m.h
+>
+
+35 
+	~<sys/out.h
+>
+
+36 
+	~<sys/mloc.h
+>
+
+37 
+	~<sys/mbuf.h
+>
+
+38 
+	~<sys/sym.h
+>
+
+39 
+	~<sys/tys.h
+>
+
+40 
+	~<sys/queue.h
+>
+
+41 
+	~<sys/sockio.h
+>
+
+42 
+	~<sys/oc.h
+>
+
+43 
+	~<sys/kauth.h
+>
+
+44 
+	~<sys/x.h
+>
+
+46 
+	~<t/bpf.h
+>
+
+47 
+	~<t/if.h
+>
+
+48 
+	~<t/if_dl.h
+>
+
+49 
+	~<t/if_tys.h
+>
+
+50 
+	~<t/if_h.h
+>
+
+52 #i
+defed
+(
+INET
+)
+
+53 
+	~<t/.h
+>
+
+54 
+	~<t/if_p.h
+>
+
+57 
+	~<t/agr/if_agrv.h
+>
+
+58 
+	~<t/agr/if_agrv_im.h
+>
+
+59 
+	~<t/agr/if_agriol.h
+>
+
+60 
+	~<t/agr/if_agrsubr.h
+>
+
+61 
+	~<t/agr/if_agthv.h
+>
+
+63 
+agach
+();
+
+65 
+agr_e_
+(
+if_e
+ *, );
+
+66 
+agr_e_deroy
+(
+i
+ *);
+
+67 
+agr_t
+(
+i
+ *);
+
+68 
+agr_tcfig
+(
+agr_soc
+ *, c 
+ageq
+ *);
+
+69 
+agr_gcfig
+(
+agr_soc
+ *, 
+ageq
+ *);
+
+70 
+agr_gpi
+(
+agr_soc
+ *, 
+ageq
+ *);
+
+71 
+agr_addpt
+(
+i
+ *, ifnet *);
+
+72 
+agr_mpt
+(
+i
+ *, ifnet *);
+
+73 
+ageq_cy
+(c *, 
+ageq
+ *);
+
+74 
+ageq_cyout
+(*, 
+ageq
+ *);
+
+75 
+agr_iol
+(
+i
+ *, 
+u_lg
+, *);
+
+76 
+agr_pt
+ *
+agr__tx_pt
+(
+agr_soc
+ *, 
+mbuf
+ *);
+
+77 
+agr_iol_fr
+(
+i
+ *, 
+u_lg
+, *);
+
+78 
+agr_t_iy
+(
+i
+ *);
+
+79 
+agr_cfig_omisc
+(
+agr_soc
+ *);
+
+80 
+agt_cfig_omisc_back
+(
+agr_pt
+ *, *);
+
+81 
+agt_cfig_omisc
+(
+agr_pt
+ *, 
+bo
+);
+
+82 
+agt_nup
+(
+agr_soc
+ *, 
+agr_pt
+ *);
+
+84 
+agr_r
+(
+agr_soc
+ *);
+
+85 
+agr_ex
+(
+agr_soc
+ *);
+
+86 
+agr_u
+(
+agr_soc
+ *);
+
+87 
+agr_evacue
+(
+agr_soc
+ *);
+
+88 
+agr_sync
+();
+
+89 
+agr_pts_lock
+(
+agr_soc
+ *);
+
+90 
+agr_pts_uock
+(
+agr_soc
+ *);
+
+91 
+bo
+ 
+agr_pts_r
+(
+agr_soc
+ *);
+
+92 
+agr_pts_ex
+(
+agr_soc
+ *);
+
+94 
+if_e
+ 
+	gagr_
+ =
+
+95 
+IF_CLONE_INITIALIZER
+("agr", 
+agr_e_
+, 
+agr_e_deroy
+);
+
+106 
+	$agach
+(
+cou
+)
+
+109 
+	`if_e_ch
+(&
+agr_
+);
+
+110 
+	}
+}
+
+117 
+	$agr_put
+(
+i
+ *
+i_pt
+, 
+mbuf
+ *
+m
+)
+
+119 
+agr_pt
+ *
+pt
+;
+
+120 
+i
+ *
+i
+;
+
+121 #i
+NVLAN
+ > 0
+
+122 
+m_g
+ *
+mg
+;
+
+125 
+pt
+ = 
+i_pt
+->
+if_agrive
+;
+
+126 
+	`KASSERT
+(
+pt
+);
+
+127 
+i
+ = 
+pt
+->
+pt_agri
+;
+
+128 i((
+pt
+->
+pt_ags
+ & 
+AGRPORT_COLLECTING
+) == 0) {
+
+129 
+	`m_m
+(
+m
+);
+
+130 
+i
+->
+if_s
+++;
+
+134 
+i
+->
+if_acks
+++;
+
+135 
+m
+->
+m_pkthdr
+.
+rcvif
+ = 
+i
+;
+
+137 
+	#DNH_DEBUG
+
+
+	)
+
+138 #i
+NVLAN
+ > 0
+
+140 i((
+mg
+ = 
+	`m_g_fd
+(
+m
+, 
+PACKET_TAG_VLAN
+, 
+NULL
+)) != NULL) {
+
+141 #ifde
+DNH_DEBUG
+
+
+142 
+	`tf
+("%s: vlanag %dttached\n",
+
+143 
+i
+->
+if_xme
+,
+
+144 
+	`hte16
+((*(
+u_t
+ *)(
+mg
+ + 1)) & 0xffff));
+
+145 
+	`tf
+("%s: vput\n", 
+i
+->
+if_xme
+);
+
+147 
+	`vn_put
+(
+i
+, 
+m
+);
+
+149 #ifde
+DNH_DEBUG
+
+
+151 
+hcom
+ *
+ec
+ = (*)
+i
+;
+
+152 
+	`tf
+("%s:o vlanagttached,c_nvlans=%d\n",
+
+153 
+i
+->
+if_xme
+, 
+ec
+->
+ec_nvns
+);
+
+158 
+	`bpf_mp
+(
+i
+, 
+m
+);
+
+159 (*
+i
+->
+if_put
+)(i, 
+m
+);
+
+160 
+	}
+}
+
+167 
+	$agr_lock
+(
+agr_soc
+ *
+sc
+)
+
+170 
+	`mux_r
+(&
+sc
+->
+sc_lock
+);
+
+171 
+	}
+}
+
+174 
+	$agr_uock
+(
+agr_soc
+ *
+sc
+)
+
+177 
+	`mux_ex
+(&
+sc
+->
+sc_lock
+);
+
+178 
+	}
+}
+
+185 
+	$agr_xm_ame
+(
+i
+ *
+i_pt
+, 
+mbuf
+ *
+m
+)
+
+187 
+r
+;
+
+189 
+sockaddr_age
+ 
+d0
+;
+
+190 
+sockaddr
+ *
+d
+;
+
+191 
+hd
+;
+
+198 
+hd
+ = 
+i_pt
+->
+if_hd
+;
+
+199 i(
+m
+->
+m_pkthdr
+.
+n
+ < 
+hd
+) {
+
+200 
+	`m_m
+(
+m
+);
+
+201  
+EINVAL
+;
+
+203 
+	`memt
+(&
+d0
+, 0, (dst0));
+
+204 
+d
+ = (
+sockaddr
+ *)&
+d0
+;
+
+205 
+d
+->
+_my
+ = 
+pudo_AF_HDRCMPLT
+;
+
+206 
+d
+->
+_n
+ = 
+hd
+;
+
+207 
+	`m_cyda
+(
+m
+, 0, 
+hd
+, &
+d
+->
+_da
+);
+
+208 
+	`m_adj
+(
+m
+, 
+hd
+);
+
+210 
+r
+ = (*
+i_pt
+->
+if_ouut
+)(i_pt, 
+m
+, 
+d
+, 
+NULL
+);
+
+212  
+r
+;
+
+213 
+	}
+}
+
+216 
+	$agt_iol
+(
+agr_pt
+ *
+pt
+, 
+u_lg
+ 
+cmd
+, *
+g
+)
+
+218 
+i
+ *
+i
+ = 
+pt
+->
+pt_i
+;
+
+220 
+	`KASSERT
+(
+i
+->
+if_agrive
+ =(*)
+pt
+);
+
+221 
+	`KASSERT
+(
+i
+->
+if_iol
+ =
+agr_iol_fr
+);
+
+223  (*
+pt
+->
+pt_iol
+)(
+i
+, 
+cmd
+, 
+g
+);
+
+224 
+	}
+}
+
+234 
+	$agr_vn_add
+(
+agr_pt
+ *
+pt
+, *
+g
+)
+
+236 
+i
+ *
+i
+ = 
+pt
+->
+pt_i
+;
+
+237 
+hcom
+ *
+ec_pt
+ = (*)
+i
+;
+
+238 
+r
+=0;
+
+240 i(
+ec_pt
+->
+ec_nvns
+++ == 0 &&
+
+241 (
+ec_pt
+->
+ec_bs
+ & 
+ETHERCAP_VLAN_MTU
+) != 0) {
+
+242 
+i
+ *
+p
+ = 
+pt
+->
+pt_i
+;
+
+246 
+ec_pt
+->
+ec_b
+ |
+ETHERCAP_VLAN_MTU
+;
+
+247 i(
+p
+->
+if_ags
+ & 
+IFF_UP
+) {
+
+248 
+r
+ = 
+	`if_ags_t
+(
+p
+,->
+if_ags
+);
+
+249 i(
+r
+) {
+
+250 i(
+ec_pt
+->
+ec_nvns
+-- == 1)
+
+251 
+ec_pt
+->
+ec_b
+ &=
+
+252 ~
+ETHERCAP_VLAN_MTU
+;
+
+253  (
+r
+);
+
+258  
+r
+;
+
+259 
+	}
+}
+
+265 
+	$agr_vn_d
+(
+agr_pt
+ *
+pt
+, *
+g
+)
+
+267 
+hcom
+ *
+ec_pt
+ = (*)
+pt
+->
+pt_i
+;
+
+270 i(
+ec_pt
+->
+ec_nvns
+-- == 1) {
+
+274 
+ec_pt
+->
+ec_b
+ &~
+ETHERCAP_VLAN_MTU
+;
+
+275 i(
+pt
+->
+pt_i
+->
+if_ags
+ & 
+IFF_UP
+) {
+
+276 ()
+	`if_ags_t
+(
+pt
+->
+pt_i
+,
+
+277 
+pt
+->
+pt_i
+->
+if_ags
+);
+
+282 
+	}
+}
+
+293 
+	$agr_vn_check
+(
+i
+ *
+i
+, 
+agr_soc
+ *
+sc
+)
+
+295 
+hcom
+ *
+ec
+ = (*)
+i
+;
+
+298 i(
+sc
+->
+sc_nvns
+ =
+ec
+->
+ec_nvns
+) {
+
+302 i(
+sc
+->
+sc_nvns
+ == 0) {
+
+304 
+	`agr_pt_fch
+(
+sc
+, 
+agr_vn_add
+, 
+NULL
+);
+
+305 
+sc
+->
+sc_nvns
+ = 
+ec
+->
+ec_nvns
+;
+
+306 } i(
+ec
+->
+ec_nvns
+ == 0) {
+
+308 
+	`agr_pt_fch
+(
+sc
+, 
+agr_vn_d
+, 
+NULL
+);
+
+309 
+sc
+->
+sc_nvns
+ = 0;
+
+311 
+	}
+}
+
+314 
+	$agr_e_
+(
+if_e
+ *
+ifc
+, 
+un
+)
+
+316 
+agr_soc
+ *
+sc
+;
+
+317 
+i
+ *
+i
+;
+
+319 
+sc
+ = 
+	`agr_loc_soc
+();
+
+320 
+	`TAILQ_INIT
+(&
+sc
+->
+sc_pts
+);
+
+321 
+	`mux_
+(&
+sc
+->
+sc_lock
+, 
+MUTEX_DEFAULT
+, 
+IPL_NET
+);
+
+322 
+	`mux_
+(&
+sc
+->
+sc_y_mtx
+, 
+MUTEX_DEFAULT
+, 
+IPL_NONE
+);
+
+323 
+	`cv_
+(&
+sc
+->
+sc_sc_cv
+, "agrsoftc");
+
+324 
+	`cv_
+(&
+sc
+->
+sc_pts_cv
+, "agrports");
+
+325 
+	`agim_
+(
+sc
+);
+
+326 
+i
+ = &
+sc
+->
+sc_if
+;
+
+327 
+	`tf
+(
+i
+->
+if_xme
+, (ifp->if_xname), "%s%d",
+
+328 
+ifc
+->
+ifc_me
+, 
+un
+);
+
+330 
+i
+->
+if_soc
+ = 
+sc
+;
+
+331 
+i
+->
+if_ags
+ = 
+IFF_BROADCAST
+ | 
+IFF_SIMPLEX
+ | 
+IFF_MULTICAST
+;
+
+332 
+i
+->
+if_t
+ = 
+agr_t
+;
+
+333 
+i
+->
+if_iol
+ = 
+agr_iol
+;
+
+334 
+	`IFQ_SET_READY
+(&
+i
+->
+if_d
+);
+
+336 
+	`if_ch
+(
+i
+);
+
+338 
+	`agr_t_iy
+(
+i
+);
+
+341 
+	}
+}
+
+344 
+	$agr_t_iy
+(
+i
+ *
+i
+)
+
+347 
+i
+->
+if_ty
+ = 
+IFT_OTHER
+;
+
+348 
+i
+->
+if_d
+ = 
+DLT_NULL
+;
+
+349 
+i
+->
+if_add
+ = 0;
+
+350 
+	`if_loc_dl
+(
+i
+);
+
+351 
+	}
+}
+
+354 
+	$agr_e_deroy
+(
+i
+ *
+i
+)
+
+356 
+agr_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+357 
+r
+;
+
+359 i((
+r
+ = 
+	`agr_u
+(
+sc
+)) != 0)
+
+360  
+r
+;
+
+362 
+	`if_dach
+(
+i
+);
+
+363 
+	`agim_deroy
+(
+sc
+);
+
+369 
+	`agr_evacue
+(
+sc
+);
+
+370 
+	`mux_deroy
+(&
+sc
+->
+sc_lock
+);
+
+371 
+	`mux_deroy
+(&
+sc
+->
+sc_y_mtx
+);
+
+372 
+	`cv_deroy
+(&
+sc
+->
+sc_sc_cv
+);
+
+373 
+	`cv_deroy
+(&
+sc
+->
+sc_pts_cv
+);
+
+374 
+	`agr__soc
+(
+sc
+);
+
+377 
+	}
+}
+
+379 
+agr_pt
+ *
+
+380 
+	$agr__tx_pt
+(
+agr_soc
+ *
+sc
+, 
+mbuf
+ *
+m
+)
+
+383  (*
+sc
+->
+sc_i
+->
+i__tx_pt
+)(sc, 
+m
+);
+
+384 
+	}
+}
+
+387 
+agr_pt
+ *
+
+388 
+	$agr__tx_pt
+(
+agr_soc
+ *
+sc
+, 
+mbuf
+ *
+m
+)
+
+390 
+agr_pt
+ *
+pt
+;
+
+391 
+ut32_t
+ 
+hash
+;
+
+393 
+hash
+ = (*
+sc
+->
+sc_i
+->
+i_hashmbuf
+)(sc, 
+m
+);
+
+394 i(
+sc
+->
+sc_ts
+ == 0)
+
+395  
+NULL
+;
+
+396 
+hash
+ %
+sc
+->
+sc_ts
+;
+
+397 
+pt
+ = 
+	`TAILQ_FIRST
+(&
+sc
+->
+sc_pts
+);
+
+398 
+	`KASSERT
+(
+pt
+ !
+NULL
+);
+
+399 
+hash
+--) {
+
+400 
+pt
+ = 
+	`TAILQ_NEXT
+t, 
+pt_q
+);
+
+401 
+	`KASSERT
+(
+pt
+ !
+NULL
+);
+
+404  
+pt
+;
+
+405 
+	}
+}
+
+409 
+	$agr_t
+(
+i
+ *
+i
+)
+
+411 
+agr_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+412 
+mbuf
+ *
+m
+;
+
+414 
+	`AGR_LOCK
+(
+sc
+);
+
+417 
+agr_pt
+ *
+pt
+;
+
+419 
+	`IFQ_DEQUEUE
+(&
+i
+->
+if_d
+, 
+m
+);
+
+420 i(
+m
+ =
+NULL
+) {
+
+423 
+	`bpf_mp
+(
+i
+, 
+m
+);
+
+424 
+pt
+ = 
+	`agr__tx_pt
+(
+sc
+, 
+m
+);
+
+425 i(
+pt
+) {
+
+426 
+r
+;
+
+428 
+r
+ = 
+	`agr_xm_ame
+(
+pt
+->
+pt_i
+, 
+m
+);
+
+429 i(
+r
+) {
+
+430 
+i
+->
+if_s
+++;
+
+432 
+i
+->
+if_acks
+++;
+
+435 
+	`m_m
+(
+m
+);
+
+436 
+i
+->
+if_s
+++;
+
+440 
+	`AGR_UNLOCK
+(
+sc
+);
+
+442 
+i
+->
+if_ags
+ &~
+IFF_OACTIVE
+;
+
+443 
+	}
+}
+
+446 
+	$agr_tcfig
+(
+agr_soc
+ *
+sc
+, c 
+ageq
+ *
+
+)
+
+448 
+i
+ *
+i
+ = &
+sc
+->
+sc_if
+;
+
+449 
+cmd
+ = 
+
+->
+_cmd
+;
+
+450 
+i
+ *
+i_pt
+;
+
+451 
+r
+ = 0;
+
+452 
+iame
+[
+IFNAMSIZ
+];
+
+454 
+	`memt
+(
+iame
+, 0, (ifname));
+
+455 
+r
+ = 
+	`cy
+(
+
+->
+_buf
+, 
+iame
+,
+
+456 
+	`MIN
+(
+
+->
+_bu
+, (
+iame
+) - 1));
+
+457 i(
+r
+) {
+
+458  
+r
+;
+
+460 
+i_pt
+ = 
+	`ifun
+(
+iame
+);
+
+461 i(
+i_pt
+ =
+NULL
+) {
+
+462  
+ENOENT
+;
+
+465 
+	`agr_pts_lock
+(
+sc
+);
+
+466 
+cmd
+) {
+
+467 
+AGRCMD_ADDPORT
+:
+
+468 
+r
+ = 
+	`agr_addpt
+(
+i
+, 
+i_pt
+);
+
+471 
+AGRCMD_REMPORT
+:
+
+472 
+r
+ = 
+	`agr_mpt
+(
+i
+, 
+i_pt
+);
+
+476 
+r
+ = 
+EINVAL
+;
+
+479 
+	`agr_pts_uock
+(
+sc
+);
+
+481  
+r
+;
+
+482 
+	}
+}
+
+485 
+	$agr_gpi
+(
+agr_soc
+ *
+sc
+, 
+ageq
+ *
+
+)
+
+487 
+agr_pt
+ *
+pt
+;
+
+488 
+agi
+ 
+l
+;
+
+489 
+agtfo
+ 
+i
+;
+
+490 *
+
+ = 
+
+->
+_buf
+;
+
+491 
+size_t
+ 
+bue
+ = (
+
+ =
+NULL
+? 0 : 
+
+->
+_bu
+;
+
+492 
+r
+;
+
+494 i(
+
+ !
+NULL
+) {
+
+495 
+	`memt
+(&
+l
+, 0, (apl));
+
+496 
+	`memt
+(&
+i
+, 0, (api));
+
+498 i(
+bue
+ < (
+l
+)) {
+
+499  
+E2BIG
+;
+
+501 
+l
+.
+l_ts
+ = 
+sc
+->
+sc_ts
+;
+
+502 
+r
+ = 
+	`cyout
+(&
+l
+, 
+
+, (apl));
+
+503 i(
+r
+) {
+
+504  
+r
+;
+
+506 
+
+ +(
+l
+);
+
+508 
+bue
+ -(
+l
+);
+
+510 
+	`TAILQ_FOREACH
+(
+pt
+, &
+sc
+->
+sc_pts
+, 
+pt_q
+) {
+
+511 i(
+
+ !
+NULL
+) {
+
+512 i(
+bue
+ < (
+i
+)) {
+
+513  
+E2BIG
+;
+
+515 
+	`memy
+(
+i
+.
+i_iame
+, 
+pt
+->
+pt_i
+->
+if_xme
+,
+
+516 (
+i
+.
+i_iame
+));
+
+517 
+i
+.
+i_ags
+ = 0;
+
+518 i(
+pt
+->
+pt_ags
+ & 
+AGRPORT_COLLECTING
+) {
+
+519 
+i
+.
+i_ags
+ |
+AGRPORTINFO_COLLECTING
+;
+
+521 i(
+pt
+->
+pt_ags
+ & 
+AGRPORT_DISTRIBUTING
+) {
+
+522 
+i
+.
+i_ags
+ |
+AGRPORTINFO_DISTRIBUTING
+;
+
+524 
+r
+ = 
+	`cyout
+(&
+i
+, 
+
+, (api));
+
+525 i(
+r
+) {
+
+526  
+r
+;
+
+528 
+
+ +(
+i
+);
+
+530 
+bue
+ -(
+i
+);
+
+533 i(
+
+ =
+NULL
+) {
+
+534 
+
+->
+_bu
+ = -
+bue
+;
+
+538 
+	}
+}
+
+541 
+	$agr_gcfig
+(
+agr_soc
+ *
+sc
+, 
+ageq
+ *
+
+)
+
+543 
+cmd
+ = 
+
+->
+_cmd
+;
+
+544 
+r
+;
+
+546 ()
+	`agr_pts_r
+(
+sc
+);
+
+547 
+cmd
+) {
+
+548 
+AGRCMD_PORTLIST
+:
+
+549 
+r
+ = 
+	`agr_gpi
+(
+sc
+, 
+
+);
+
+553 
+r
+ = 
+EINVAL
+;
+
+556 
+	`agr_pts_ex
+(
+sc
+);
+
+558  
+r
+;
+
+559 
+	}
+}
+
+562 
+	$agr_addpt
+(
+i
+ *
+i
+, i *
+i_pt
+)
+
+564 c 
+iddr
+ *
+i
+;
+
+565 
+agr_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+566 
+agr_pt
+ *
+pt
+ = 
+NULL
+;
+
+567 
+r
+ = 0;
+
+569 i(
+i_pt
+->
+if_iol
+ =
+NULL
+) {
+
+570 
+r
+ = 
+EOPNOTSUPP
+;
+
+571 
+out
+;
+
+574 i(
+i_pt
+->
+if_agrive
+) {
+
+575 
+r
+ = 
+EBUSY
+;
+
+576 
+out
+;
+
+579 i(
+i_pt
+->
+if_t
+ =
+agr_t
+) {
+
+580 
+r
+ = 
+EINVAL
+;
+
+581 
+out
+;
+
+584 
+pt
+ = 
+	`mloc
+((*pt+ 
+i_pt
+->
+if_add
+, 
+M_DEVBUF
+,
+
+585 
+M_WAITOK
+ | 
+M_ZERO
+);
+
+586 i(
+pt
+ =
+NULL
+) {
+
+587 
+r
+ = 
+ENOMEM
+;
+
+588 
+out
+;
+
+590 
+pt
+->
+pt_ags
+ = 
+AGRPORT_LARVAL
+;
+
+592 
+	`IFADDR_FOREACH
+(
+i
+, 
+i_pt
+) {
+
+593 i(
+i
+->
+i_addr
+->
+_my
+ !
+AF_LINK
+) {
+
+594 
+r
+ = 
+EBUSY
+;
+
+595 
+out
+;
+
+599 i(
+sc
+->
+sc_ts
+ == 0) {
+
+600 
+i_pt
+->
+if_ty
+) {
+
+601 
+IFT_ETHER
+:
+
+602 
+sc
+->
+sc_i
+ = &
+agth_s
+;
+
+606 
+r
+ = 
+EPROTONOSUPPORT
+;
+
+607 
+out
+;
+
+610 
+r
+ = (*
+sc
+->
+sc_i
+->
+i_
+)(sc, 
+i_pt
+);
+
+611 i(
+r
+)
+
+612 
+out
+;
+
+613 
+	`agim_t
+(
+sc
+);
+
+615 i(
+i
+->
+if_ty
+ !
+i_pt
+->if_type) {
+
+616 
+r
+ = 
+EINVAL
+;
+
+617 
+out
+;
+
+619 i(
+i
+->
+if_add
+ !
+i_pt
+->if_addrlen) {
+
+620 
+r
+ = 
+EINVAL
+;
+
+621 
+out
+;
+
+625 
+	`memy
+(
+pt
+->
+pt_igaddr
+, 
+	`CLLADDR
+(
+i_pt
+->
+if_dl
+),
+
+626 
+i_pt
+->
+if_add
+);
+
+638 
+r
+ = 
+	`if_addr_
+(
+i_pt
+, 
+i
+->
+if_dl
+, 
+ue
+);
+
+640 i(
+r
+) {
+
+641 
+	`tf
+("%s: if_addr_ %d\n", 
+__func__
+, 
+r
+);
+
+642 
+nup
+;
+
+644 
+pt
+->
+pt_ags
+ |
+AGRPORT_LADDRCHANGED
+;
+
+646 
+i
+->
+if_ty
+ = 
+i_pt
+->if_type;
+
+647 
+	`AGR_LOCK
+(
+sc
+);
+
+649 
+pt
+->
+pt_i
+ = 
+i_pt
+;
+
+650 
+i_pt
+->
+if_agrive
+ = 
+pt
+;
+
+651 
+pt
+->
+pt_agri
+ = 
+i
+;
+
+652 
+	`TAILQ_INSERT_TAIL
+(&
+sc
+->
+sc_pts
+, 
+pt
+, 
+pt_q
+);
+
+653 
+sc
+->
+sc_ts
+++;
+
+655 
+pt
+->
+pt_iol
+ = 
+i_pt
+->
+if_iol
+;
+
+656 
+i_pt
+->
+if_iol
+ = 
+agr_iol_fr
+;
+
+658 
+pt
+->
+pt_ags
+ |
+AGRPORT_ATTACHED
+;
+
+660 
+	`AGR_UNLOCK
+(
+sc
+);
+
+662 
+r
+ = (*
+sc
+->
+sc_i
+->
+i_pt
+)(sc, 
+pt
+);
+
+663 i(
+r
+) {
+
+664 
+	`tf
+("%s:t %d\n", 
+__func__
+, 
+r
+);
+
+665 
+nup
+;
+
+668 
+i
+->
+if_ags
+ |
+IFF_RUNNING
+;
+
+670 
+	`agt_cfig_omisc
+(
+pt
+, (
+i
+->
+if_ags
+ & 
+IFF_PROMISC
+) != 0);
+
+671 
+r
+ = (*
+sc
+->
+sc_i
+->
+i_cfigmui_pt
+)(sc, 
+pt
+, 
+ue
+);
+
+672 i(
+r
+) {
+
+673 
+	`tf
+("%s: cfigmur %d\n", 
+__func__
+, 
+r
+);
+
+674 
+nup
+;
+
+677 
+	`AGR_LOCK
+(
+sc
+);
+
+678 
+pt
+->
+pt_ags
+ &~
+AGRPORT_LARVAL
+;
+
+679 
+	`AGR_UNLOCK
+(
+sc
+);
+
+680 
+out
+:
+
+681 i(
+r
+ && 
+pt
+) {
+
+682 
+	`
+(
+pt
+, 
+M_DEVBUF
+);
+
+684  
+r
+;
+
+686 
+nup
+:
+
+687 i(
+	`agt_nup
+(
+sc
+, 
+pt
+)) {
+
+688 
+	`tf
+("%s: onup\n", 
+__func__
+);
+
+690 
+pt
+ = 
+NULL
+;
+
+693 i(
+sc
+->
+sc_ts
+ == 0) {
+
+694 
+	`KASSERT
+(
+	`TAILQ_EMPTY
+(&
+sc
+->
+sc_pts
+));
+
+695 
+	`agim_
+(
+sc
+);
+
+696 (*
+sc
+->
+sc_i
+->
+i_dt
+)(sc);
+
+697 
+sc
+->
+sc_i
+ = 
+NULL
+;
+
+698 
+	`agr_t_iy
+(
+i
+);
+
+700 
+	`KASSERT
+(!
+	`TAILQ_EMPTY
+(&
+sc
+->
+sc_pts
+));
+
+703 
+out
+;
+
+704 
+	}
+}
+
+707 
+	$agr_mpt
+(
+i
+ *
+i
+, i *
+i_pt
+)
+
+709 
+agr_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+710 
+agr_pt
+ *
+pt
+;
+
+711 
+r
+ = 0;
+
+713 i(
+i_pt
+->
+if_agrive
+ =
+NULL
+) {
+
+714 
+r
+ = 
+ENOENT
+;
+
+715  
+r
+;
+
+718 
+pt
+ = 
+i_pt
+->
+if_agrive
+;
+
+719 i(
+pt
+->
+pt_agri
+ !
+i
+) {
+
+720 
+r
+ = 
+EINVAL
+;
+
+721  
+r
+;
+
+724 
+	`KASSERT
+(
+sc
+->
+sc_ts
+ > 0);
+
+726 
+	`AGR_LOCK
+(
+sc
+);
+
+727 
+pt
+->
+pt_ags
+ |
+AGRPORT_DETACHING
+;
+
+728 
+	`AGR_UNLOCK
+(
+sc
+);
+
+730 
+r
+ = (*
+sc
+->
+sc_i
+->
+i_ptfi
+)(sc, 
+pt
+);
+
+731 i(
+r
+) {
+
+733 
+	`tf
+("%s:tfr %d\n", 
+__func__
+, 
+r
+);
+
+734 
+out
+;
+
+737 
+r
+ = (*
+sc
+->
+sc_i
+->
+i_cfigmui_pt
+)(sc, 
+pt
+, 
+l
+);
+
+738 i(
+r
+) {
+
+740 
+	`tf
+("%s: cfigmui_pr %d\n", 
+__func__
+, 
+r
+);
+
+741 
+out
+;
+
+744 
+r
+ = 
+	`agt_nup
+(
+sc
+, 
+pt
+);
+
+745 i(
+r
+) {
+
+747 
+	`tf
+("%s:gt_nur %d\n", 
+__func__
+, 
+r
+);
+
+748 
+out
+;
+
+751 
+	`
+(
+pt
+, 
+M_DEVBUF
+);
+
+753 
+out
+:
+
+754 i(
+sc
+->
+sc_ts
+ == 0) {
+
+755 
+	`KASSERT
+(
+	`TAILQ_EMPTY
+(&
+sc
+->
+sc_pts
+));
+
+756 
+	`agim_
+(
+sc
+);
+
+757 (*
+sc
+->
+sc_i
+->
+i_dt
+)(sc);
+
+758 
+sc
+->
+sc_i
+ = 
+NULL
+;
+
+760 
+	`agr_t_iy
+(
+i
+);
+
+762 
+	`KASSERT
+(!
+	`TAILQ_EMPTY
+(&
+sc
+->
+sc_pts
+));
+
+765  
+r
+;
+
+766 
+	}
+}
+
+769 
+	$agt_nup
+(
+agr_soc
+ *
+sc
+, 
+agr_pt
+ *
+pt
+)
+
+771 
+i
+ *
+i_pt
+ = 
+pt
+->
+pt_i
+;
+
+772 
+r
+;
+
+773 
+su
+ = 0;
+
+775 
+r
+ = 
+	`agt_cfig_omisc
+(
+pt
+, 
+l
+);
+
+776 i(
+r
+) {
+
+777 
+	`tf
+("%s: cfig_omisr %d\n", 
+__func__
+, 
+r
+);
+
+778 
+su
+ = 
+r
+;
+
+781 i((
+pt
+->
+pt_ags
+ & 
+AGRPORT_LADDRCHANGED
+)) {
+
+783 
+	`memy
+(
+	`LLADDR
+(
+i_pt
+->
+if_dl
+), 
+pt
+->
+pt_igaddr
+,
+
+784 
+i_pt
+->
+if_add
+);
+
+785 i(
+i_pt
+->
+if_
+ !
+NULL
+) {
+
+786 
+r
+ = (*
+i_pt
+->
+if_
+)(ifp_port);
+
+790 
+sockaddr
+ 
+
+;
+
+791 
+sockaddr_dl
+ 
+sdl
+;
+
+792 
+sockaddr_age
+ 
+ss
+;
+
+793 } 
+u
+;
+
+794 
+iddr
+ 
+i
+;
+
+796 
+	`sockaddr_dl_
+(&
+u
+.
+sdl
+, (u.
+ss
+),
+
+797 0, 
+i_pt
+->
+if_ty
+, 
+NULL
+, 0,
+
+798 
+pt
+->
+pt_igaddr
+, 
+i_pt
+->
+if_add
+);
+
+799 
+	`memt
+(&
+i
+, 0, (ifa));
+
+800 
+i
+.
+i_addr
+ = &
+u
+.
+
+;
+
+801 
+r
+ = 
+	`agt_iol
+(
+pt
+, 
+SIOCINITIFADDR
+, &
+i
+);
+
+803 i(
+r
+) {
+
+804 
+	`tf
+("%s: if_ %d\n", 
+__func__
+, 
+r
+);
+
+805 
+su
+ = 
+r
+;
+
+807 
+pt
+->
+pt_ags
+ &~
+AGRPORT_LADDRCHANGED
+;
+
+811 
+	`AGR_LOCK
+(
+sc
+);
+
+812 i((
+pt
+->
+pt_ags
+ & 
+AGRPORT_ATTACHED
+)) {
+
+813 
+i_pt
+->
+if_agrive
+ = 
+NULL
+;
+
+815 
+	`TAILQ_REMOVE
+(&
+sc
+->
+sc_pts
+, 
+pt
+, 
+pt_q
+);
+
+816 
+sc
+->
+sc_ts
+--;
+
+818 
+	`KASSERT
+(
+i_pt
+->
+if_iol
+ =
+agr_iol_fr
+);
+
+819 
+i_pt
+->
+if_iol
+ = 
+pt
+->
+pt_iol
+;
+
+821 
+pt
+->
+pt_ags
+ &~
+AGRPORT_ATTACHED
+;
+
+823 
+	`AGR_UNLOCK
+(
+sc
+);
+
+825  
+su
+;
+
+826 
+	}
+}
+
+829 
+	$agr_iol_mui
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, 
+ieq
+ *
+i
+)
+
+831 
+agr_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+832 
+r
+;
+
+834 
+r
+ = (*
+sc
+->
+sc_i
+->
+i_cfigmui_ieq
+)(sc, 
+i
+,
+
+835 (
+cmd
+ =
+SIOCADDMULTI
+));
+
+837  
+r
+;
+
+838 
+	}
+}
+
+848 
+	$agr_iol_fr
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+g
+)
+
+850 
+agr_pt
+ *
+pt
+ = 
+i
+->
+if_agrive
+;
+
+851 
+r
+;
+
+853 
+	`KASSERT
+(
+pt
+);
+
+855 
+cmd
+) {
+
+856 
+SIOCADDMULTI
+:
+
+857 
+SIOCAIFADDR
+:
+
+858 
+SIOCALIFADDR
+:
+
+859 
+SIOCDELMULTI
+:
+
+860 
+SIOCDIFADDR
+:
+
+861 
+SIOCDIFPHYADDR
+:
+
+862 
+SIOCDLIFADDR
+:
+
+863 
+SIOCINITIFADDR
+:
+
+864 
+SIOCSDRVSPEC
+:
+
+865 
+SIOCSIFADDR
+:
+
+866 
+SIOCSIFBRDADDR
+:
+
+867 
+SIOCSIFDSTADDR
+:
+
+868 
+SIOCSIFGENERIC
+:
+
+869 
+SIOCSIFMEDIA
+:
+
+870 
+SIOCSIFMETRIC
+:
+
+871 
+SIOCSIFMTU
+:
+
+872 
+SIOCSIFNETMASK
+:
+
+873 
+SIOCSIFPHYADDR
+:
+
+874 
+SIOCSLIFPHYADDR
+:
+
+875 
+SIOCSVH
+:
+
+876 
+r
+ = 
+EBUSY
+;
+
+878 
+SIOCSIFCAP
+:
+
+879 
+SIOCSIFFLAGS
+:
+
+881 
+r
+ = 
+	`agt_iol
+(
+pt
+, 
+cmd
+, 
+g
+);
+
+884  
+r
+;
+
+885 
+	}
+}
+
+888 
+	$ageq_cy
+(c *
+ubuf
+, 
+ageq
+ *
+
+)
+
+890 
+r
+;
+
+892 
+r
+ = 
+	`cy
+(
+ubuf
+, 
+
+, (*ar));
+
+893 i(
+r
+) {
+
+894  
+r
+;
+
+897 i(
+
+->
+_vsi
+ !
+AGRREQ_VERSION
+) {
+
+898  
+EINVAL
+;
+
+902 
+	}
+}
+
+905 
+	$ageq_cyout
+(*
+ubuf
+, 
+ageq
+ *
+
+)
+
+907 
+r
+;
+
+909 
+	`KASSERT
+(
+
+->
+_vsi
+ =
+AGRREQ_VERSION
+);
+
+911 
+r
+ = 
+	`cyout
+(
+
+, 
+ubuf
+, (*ar));
+
+912 i(
+r
+) {
+
+913  
+r
+;
+
+917 
+	}
+}
+
+921 
+	$agr_sync
+()
+
+923 
+ut64_t
+ 
+h
+;
+
+925 i(!
+mp_le
+)
+
+928 
+h
+ = 
+	`xc_brd
+(0, (
+xcfunc_t
+)
+nu
+, 
+NULL
+, NULL);
+
+929 
+	`xc_wa
+(
+h
+);
+
+930 
+	}
+}
+
+933 
+	$agr_u
+(
+agr_soc
+ *
+sc
+)
+
+935 
+r
+;
+
+937 
+	`mux_r
+(&
+sc
+->
+sc_y_mtx
+);
+
+938 i((
+r
+ = 
+sc
+->
+sc_nry
+) != 0)
+
+939 
+out
+;
+
+941 
+sc
+->
+sc_nry
+ = 
+EBUSY
+;
+
+943 
+sc
+->
+sc_sc
+ != 0)
+
+944 
+	`cv_wa
+(&
+sc
+->
+sc_sc_cv
+, &sc->
+sc_y_mtx
+);
+
+946 i(
+sc
+->
+sc_ts
+ == 0) {
+
+947 
+sc
+->
+sc_nry
+ = 
+ENXIO
+;
+
+949 
+sc
+->
+sc_nry
+ = 0;
+
+950 
+r
+ = 
+EBUSY
+;
+
+952 
+	`cv_brd
+(&
+sc
+->
+sc_sc_cv
+);
+
+953 
+out
+:
+
+954 
+	`mux_ex
+(&
+sc
+->
+sc_y_mtx
+);
+
+955  
+r
+;
+
+956 
+	}
+}
+
+959 
+	$agr_evacue
+(
+agr_soc
+ *
+sc
+)
+
+961 
+	`mux_r
+(&
+sc
+->
+sc_y_mtx
+);
+
+962 
+	`cv_brd
+(&
+sc
+->
+sc_sc_cv
+);
+
+963 
+sc
+->
+sc_sc
+ !0 || sc->
+sc_ud
+ != 0)
+
+964 
+	`cv_wa
+(&
+sc
+->
+sc_sc_cv
+, &sc->
+sc_y_mtx
+);
+
+965 
+	`mux_ex
+(&
+sc
+->
+sc_y_mtx
+);
+
+967 
+	`agr_sync
+();
+
+968 
+	}
+}
+
+971 
+	$agr_r
+(
+agr_soc
+ *
+sc
+)
+
+973 
+r
+;
+
+975 
+	`mux_r
+(&
+sc
+->
+sc_y_mtx
+);
+
+976 
+sc
+->
+sc_ud
+++;
+
+977 (
+r
+ = 
+sc
+->
+sc_nry
+=
+EBUSY
+)
+
+978 
+	`cv_wa
+(&
+sc
+->
+sc_sc_cv
+, &sc->
+sc_y_mtx
+);
+
+979 
+sc
+->
+sc_ud
+--;
+
+980 i(
+r
+ == 0)
+
+981 
+sc
+->
+sc_sc
+++;
+
+982 
+	`mux_ex
+(&
+sc
+->
+sc_y_mtx
+);
+
+984  
+r
+;
+
+985 
+	}
+}
+
+988 
+	$agr_ex
+(
+agr_soc
+ *
+sc
+)
+
+990 
+	`mux_r
+(&
+sc
+->
+sc_y_mtx
+);
+
+991 i(--
+sc
+->
+sc_sc
+ == 0)
+
+992 
+	`cv_sigl
+(&
+sc
+->
+sc_sc_cv
+);
+
+993 
+	`mux_ex
+(&
+sc
+->
+sc_y_mtx
+);
+
+994 
+	}
+}
+
+996 
+bo
+
+
+997 
+	$agr_pts_r
+(
+agr_soc
+ *
+sc
+)
+
+999 
+	`mux_r
+(&
+sc
+->
+sc_y_mtx
+);
+
+1000 
+sc
+->
+sc_wts
+)
+
+1001 
+	`cv_wa
+(&
+sc
+->
+sc_pts_cv
+, &sc->
+sc_y_mtx
+);
+
+1002 
+sc
+->
+sc_rdpts
+++;
+
+1003 
+	`mux_ex
+(&
+sc
+->
+sc_y_mtx
+);
+
+1005  
+ue
+;
+
+1006 
+	}
+}
+
+1009 
+	$agr_pts_ex
+(
+agr_soc
+ *
+sc
+)
+
+1011 
+	`mux_r
+(&
+sc
+->
+sc_y_mtx
+);
+
+1012 i(--
+sc
+->
+sc_rdpts
+ == 0)
+
+1013 
+	`cv_sigl
+(&
+sc
+->
+sc_pts_cv
+);
+
+1014 
+	`mux_ex
+(&
+sc
+->
+sc_y_mtx
+);
+
+1015 
+	}
+}
+
+1018 
+	$agr_pts_lock
+(
+agr_soc
+ *
+sc
+)
+
+1020 
+	`mux_r
+(&
+sc
+->
+sc_y_mtx
+);
+
+1021 
+sc
+->
+sc_rdpts
+ != 0)
+
+1022 
+	`cv_wa
+(&
+sc
+->
+sc_pts_cv
+, &sc->
+sc_y_mtx
+);
+
+1023 
+sc
+->
+sc_wts
+ = 
+ue
+;
+
+1024 
+	`mux_ex
+(&
+sc
+->
+sc_y_mtx
+);
+
+1025 
+	}
+}
+
+1028 
+	$agr_pts_uock
+(
+agr_soc
+ *
+sc
+)
+
+1030 
+	`mux_r
+(&
+sc
+->
+sc_y_mtx
+);
+
+1031 
+sc
+->
+sc_wts
+ = 
+l
+;
+
+1032 
+	`cv_sigl
+(&
+sc
+->
+sc_pts_cv
+);
+
+1033 
+	`mux_ex
+(&
+sc
+->
+sc_y_mtx
+);
+
+1034 
+	}
+}
+
+1037 
+	$agr_iol
+(
+i
+ *
+i
+, c 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+1039 
+agr_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+1040 
+ieq
+ *
+i
+ = (ieq *)
+da
+;
+
+1041 
+iddr
+ *
+i
+ = (idd*)
+da
+;
+
+1042 
+ageq
+ 
+
+;
+
+1043 
+r
+;
+
+1044 
+bo
+ 
+_pts
+ = 
+l
+;
+
+1045 
+s
+;
+
+1047 i((
+r
+ = 
+	`agr_r
+(
+sc
+)) != 0)
+
+1048  
+r
+;
+
+1050 
+s
+ = 
+	`
+();
+
+1052 
+cmd
+) {
+
+1053 
+SIOCINITIFADDR
+:
+
+1054 
+_pts
+ = 
+	`agr_pts_r
+(
+sc
+);
+
+1055 i(
+sc
+->
+sc_ts
+ == 0) {
+
+1056 
+r
+ = 
+EINVAL
+;
+
+1059 
+i
+->
+if_ags
+ |
+IFF_UP
+;
+
+1060 
+i
+->
+i_addr
+->
+_my
+) {
+
+1061 #i
+	`defed
+(
+INET
+)
+
+1062 
+AF_INET
+:
+
+1063 
+	`p_if
+(
+i
+, 
+i
+);
+
+1072 
+SIOCSIFMTU
+:
+
+1075 
+SIOCSIFFLAGS
+:
+
+1081 
+	`agr_vn_check
+(
+i
+, 
+sc
+);
+
+1083 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)) != 0)
+
+1085 
+	`agr_cfig_omisc
+(
+sc
+);
+
+1088 
+SIOCSETAGR
+:
+
+1089 
+	`lx
+(
+s
+);
+
+1090 
+r
+ = 
+	`kauth_authize_twk
+(
+	`kauth_ed_g
+(),
+
+1091 
+KAUTH_NETWORK_INTERFACE
+,
+
+1092 
+KAUTH_REQ_NETWORK_INTERFACE_SETPRIV
+, 
+i
+, (*)
+cmd
+,
+
+1093 
+NULL
+);
+
+1094 i(!
+r
+) {
+
+1095 
+r
+ = 
+	`ageq_cy
+(
+i
+->
+i_da
+, &
+
+);
+
+1097 i(!
+r
+) {
+
+1098 
+r
+ = 
+	`agr_tcfig
+(
+sc
+, &
+
+);
+
+1100 
+s
+ = 
+	`
+();
+
+1103 
+SIOCGETAGR
+:
+
+1104 
+	`lx
+(
+s
+);
+
+1105 
+r
+ = 
+	`ageq_cy
+(
+i
+->
+i_da
+, &
+
+);
+
+1106 i(!
+r
+) {
+
+1107 
+r
+ = 
+	`agr_gcfig
+(
+sc
+, &
+
+);
+
+1109 i(!
+r
+) {
+
+1110 
+r
+ = 
+	`ageq_cyout
+(
+i
+->
+i_da
+, &
+
+);
+
+1112 
+s
+ = 
+	`
+();
+
+1115 
+SIOCADDMULTI
+:
+
+1116 
+SIOCDELMULTI
+:
+
+1117 
+_pts
+ = 
+	`agr_pts_r
+(
+sc
+);
+
+1118 i(
+sc
+->
+sc_ts
+ == 0)
+
+1119 
+r
+ = 
+EINVAL
+;
+
+1121 
+r
+ = 
+	`agr_iol_mui
+(
+i
+, 
+cmd
+, 
+i
+);
+
+1125 
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+);
+
+1129 i(
+_pts
+)
+
+1130 
+	`agr_pts_ex
+(
+sc
+);
+
+1132 
+	`lx
+(
+s
+);
+
+1134 
+	`agr_ex
+(
+sc
+);
+
+1136  
+r
+;
+
+1137 
+	}
+}
+
+1140 
+	$agr_cfig_omisc
+(
+agr_soc
+ *
+sc
+)
+
+1142 
+r
+;
+
+1144 
+	`agr_pt_fch
+(
+sc
+, 
+agt_cfig_omisc_back
+, &
+r
+);
+
+1146  
+r
+;
+
+1147 
+	}
+}
+
+1150 
+	$agt_cfig_omisc_back
+(
+agr_pt
+ *
+pt
+, *
+g
+)
+
+1152 
+agr_soc
+ *
+sc
+ = 
+	`AGR_SC_FROM_PORT
+(
+pt
+);
+
+1153 *
+rp
+ = 
+g
+;
+
+1154 
+r
+;
+
+1155 
+bo
+ 
+omisc
+;
+
+1157 
+omisc
+ = (
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_PROMISC
+) != 0;
+
+1159 
+r
+ = 
+	`agt_cfig_omisc
+(
+pt
+, 
+omisc
+);
+
+1160 i(
+r
+) {
+
+1161 *
+rp
+ = 
+r
+;
+
+1165 
+	}
+}
+
+1168 
+	$agt_cfig_omisc
+(
+agr_pt
+ *
+pt
+, 
+bo
+ 
+omisc
+)
+
+1170 
+r
+;
+
+1172 i(
+omisc
+ && (
+pt
+->
+pt_ags
+ & 
+AGRPORT_PROMISC
+) != 0) ||
+
+1173 (!
+omisc
+ && (
+pt
+->
+pt_ags
+ & 
+AGRPORT_PROMISC
+) == 0)) {
+
+1177 
+r
+ = 
+	`iromisc
+(
+pt
+->
+pt_i
+, 
+omisc
+);
+
+1178 i(
+r
+ == 0) {
+
+1179 i(
+omisc
+) {
+
+1180 
+pt
+->
+pt_ags
+ |
+AGRPORT_PROMISC
+;
+
+1182 
+pt
+->
+pt_ags
+ &~
+AGRPORT_PROMISC
+;
+
+1186  
+r
+;
+
+1187 
+	}
+}
+
+	@agr/if_agrether.c
+
+29 
+	~<sys/cdefs.h
+>
+
+30 
+__KERNEL_RCSID
+(0, "$NetBSD: if_agrether.c,v 1.9 2011/10/19 01:49:50 dyoung Exp $");
+
+32 
+	~<sys/m.h
+>
+
+33 
+	~<sys/out.h
+>
+
+34 
+	~<sys/mbuf.h
+>
+
+35 
+	~<sys/sockio.h
+>
+
+37 
+	~<t/if.h
+>
+
+38 
+	~<t/if_dl.h
+>
+
+39 
+	~<t/if_h.h
+>
+
+40 
+	~<t/if_med.h
+>
+
+42 
+	~<t/agr/if_agrv_im.h
+>
+
+43 
+	~<t/agr/if_agthv.h
+>
+
+44 
+	~<t/agr/if_agrsubr.h
+>
+
+46 
+	~<t/agr/8023_owocs.h
+>
+
+47 
+	~<t/agr/8023_v.h
+>
+
+48 
+	~<t/agr/8023ad.h
+>
+
+49 
+	~<t/agr/8023ad_.h
+>
+
+50 
+	~<t/agr/8023ad__im.h
+>
+
+51 
+	~<t/agr/8023ad_im.h
+>
+
+53 
+agth_
+(
+agr_soc
+ *, 
+i
+ *);
+
+54 
+agth_dt
+(
+agr_soc
+ *);
+
+55 
+agth_pt
+(
+agr_soc
+ *, 
+agr_pt
+ *);
+
+56 
+agth_ptfi
+(
+agr_soc
+ *, 
+agr_pt
+ *);
+
+57 
+agr_pt
+ *
+agth__tx_pt
+(
+agr_soc
+ *,
+
+58 
+mbuf
+ *);
+
+59 
+agth_cfigmui_pt
+(
+agr_soc
+ *, 
+agr_pt
+ *,
+
+60 
+bo
+);
+
+61 
+agth_cfigmui_ieq
+(
+agr_soc
+ *, 
+ieq
+ *,
+
+62 
+bo
+);
+
+64 c 
+agr_iy_s
+ 
+	gagth_s
+ = {
+
+65 .
+i_tick
+ = 
+NULL
+,
+
+66 .
+	gi_pick
+ = 
+8023ad__pick
+,
+
+67 .
+	gi_pte
+ = 
+8023ad__pte
+,
+
+68 .
+	gi_
+ = 
+agth_
+,
+
+69 .
+	gi_dt
+ = 
+agth_dt
+,
+
+70 .
+	gi_pt
+ = 
+agth_pt
+,
+
+71 .
+	gi_ptfi
+ = 
+agth_ptfi
+,
+
+72 .
+	gi_hashmbuf
+ = 
+agth_hashmbuf
+,
+
+73 .
+	gi__tx_pt
+ = 
+agth__tx_pt
+,
+
+74 .
+	gi_cfigmui_pt
+ = 
+agth_cfigmui_pt
+,
+
+75 .
+	gi_cfigmui_ieq
+ = 
+agth_cfigmui_ieq
+
+
+78 
+	sagth_ive
+ {
+
+79 
+8023ad_soc
+ 
+	mp_8023ad_soc
+;
+
+80 
+agr_muddrs
+ 
+	mp_muddrs
+;
+
+83 
+	sagth_pt_ive
+ {
+
+84 
+8023ad_pt
+ 
+	m_8023ad_pt
+;
+
+88 
+	$agth_
+(
+agr_soc
+ *
+sc
+, 
+i
+ *
+i_pt
+)
+
+90 
+i
+ *
+i
+ = &
+sc
+->
+sc_if
+;
+
+91 
+hcom
+ *
+ec
+ = (*)
+i
+;
+
+92 
+agth_ive
+ *
+iv
+;
+
+94 
+iv
+ = 
+	`mloc
+((*iv), 
+M_DEVBUF
+, 
+M_NOWAIT
+ | 
+M_ZERO
+);
+
+95 i(!
+iv
+)
+
+96  
+ENOMEM
+;
+
+98 
+	`agr_mc_
+(
+sc
+, &
+iv
+->
+p_muddrs
+);
+
+100 
+sc
+->
+sc_iive
+ = 
+iv
+;
+
+107 
+i
+->
+if_bs
+ = 
+i_pt
+->if_capabilities &
+
+108 (
+IFCAP_TSOv4
+ | 
+IFCAP_TSOv6
+ |
+
+109 
+IFCAP_CSUM_IPv4_Tx
+ | 
+IFCAP_CSUM_IPv4_Rx
+ |
+
+110 
+IFCAP_CSUM_TCPv4_Tx
+ | 
+IFCAP_CSUM_TCPv4_Rx
+ |
+
+111 
+IFCAP_CSUM_UDPv4_Tx
+ | 
+IFCAP_CSUM_UDPv4_Rx
+ |
+
+112 
+IFCAP_CSUM_TCPv6_Tx
+ | 
+IFCAP_CSUM_TCPv6_Rx
+ |
+
+113 
+IFCAP_CSUM_UDPv6_Tx
+ | 
+IFCAP_CSUM_UDPv6_Rx
+);
+
+115 
+	`h_iach
+(
+i
+, 
+	`CLLADDR
+(
+i_pt
+->
+if_dl
+));
+
+116 
+ec
+->
+ec_bs
+ =
+
+117 
+ETHERCAP_VLAN_MTU
+ | 
+ETHERCAP_VLAN_HWTAGGING
+ | 
+ETHERCAP_JUMBO_MTU
+;
+
+119 
+	`8023ad_
+(
+sc
+);
+
+122 
+	}
+}
+
+125 
+	$agth_dt
+(
+agr_soc
+ *
+sc
+)
+
+127 
+agth_ive
+ *
+iv
+ = 
+sc
+->
+sc_iive
+;
+
+129 i(
+iv
+ =
+NULL
+) {
+
+133 
+	`8023ad_dt
+(
+sc
+);
+
+134 
+	`agr_mc_purg
+(
+sc
+, &
+iv
+->
+p_muddrs
+);
+
+135 
+	`
+(
+iv
+, 
+M_DEVBUF
+);
+
+136 
+sc
+->
+sc_iive
+ = 
+NULL
+;
+
+137 
+	}
+}
+
+140 
+	$agth_pt
+(
+agr_soc
+ *
+sc
+, 
+agr_pt
+ *
+pt
+)
+
+142 
+ieq
+ 
+i
+;
+
+143 
+agth_pt_ive
+ *
+iv
+;
+
+144 
+r
+;
+
+145 
+hcom
+ *
+ec
+ = (*)&
+sc
+->
+sc_if
+;
+
+146 
+hcom
+ *
+ec_pt
+ = (*)
+pt
+->
+pt_i
+;
+
+148 
+pt
+->
+pt_med
+ = 
+IFM_ETHER
+ | 
+IFM_NONE
+;
+
+157 i(
+ec
+->
+ec_bs
+ &
+
+158 ~
+ec_pt
+->
+ec_bs
+ &
+
+159 (
+ETHERCAP_VLAN_MTU
+ | 
+ETHERCAP_VLAN_HWTAGGING
+)) {
+
+160 i(
+ec
+->
+ec_nvns
+ > 0) {
+
+161  
+EINVAL
+;
+
+163 
+ec
+->
+ec_bs
+ &=
+
+164 
+ec_pt
+->
+ec_bs
+ |
+
+165 ~(
+ETHERCAP_VLAN_MTU
+ | 
+ETHERCAP_VLAN_HWTAGGING
+);
+
+169 i((
+ec
+->
+ec_nvns
+ > 0) &&
+
+170 
+ec_pt
+->
+ec_nvns
+++ == 0 &&
+
+171 (
+ec_pt
+->
+ec_bs
+ & 
+ETHERCAP_VLAN_MTU
+) != 0) {
+
+172 
+i
+ *
+p
+ = 
+pt
+->
+pt_i
+;
+
+176 
+ec_pt
+->
+ec_b
+ |
+ETHERCAP_VLAN_MTU
+;
+
+177 i(
+p
+->
+if_ags
+ & 
+IFF_UP
+) {
+
+178 
+r
+ = 
+	`if_ags_t
+(
+p
+,->
+if_ags
+);
+
+179 i(
+r
+) {
+
+180 i(
+ec_pt
+->
+ec_nvns
+-- == 1)
+
+181 
+ec_pt
+->
+ec_b
+ &=
+
+182 ~
+ETHERCAP_VLAN_MTU
+;
+
+183  (
+r
+);
+
+189 
+iv
+ = 
+	`mloc
+((*iv), 
+M_DEVBUF
+, 
+M_WAITOK
+ | 
+M_ZERO
+);
+
+190 i(
+iv
+ =
+NULL
+) {
+
+191  
+ENOMEM
+;
+
+194 
+pt
+->
+pt_iive
+ = 
+iv
+;
+
+196 
+	`memt
+(&
+i
+, 0, (ifr));
+
+197 
+i
+.
+i_addr
+.
+_n
+ = (ifr.ifr_addr);
+
+198 
+i
+.
+i_addr
+.
+_my
+ = 
+AF_UNSPEC
+;
+
+199 
+	`KASSERT
+((
+i
+.
+i_addr
+) >=
+
+200 (
+hmuiaddr_owocs
+));
+
+201 
+	`memy
+(&
+i
+.
+i_addr
+.
+_da
+,
+
+202 &
+hmuiaddr_owocs
+,
+
+203 (
+hmuiaddr_owocs
+));
+
+204 
+r
+ = 
+	`agt_iol
+(
+pt
+, 
+SIOCADDMULTI
+, (*)&
+i
+);
+
+205 i(
+r
+) {
+
+206 
+	`
+(
+pt
+->
+pt_iive
+, 
+M_DEVBUF
+);
+
+207 
+pt
+->
+pt_iive
+ = 
+NULL
+;
+
+208  
+r
+;
+
+211 
+	`8023ad_pt
+(
+pt
+);
+
+213  
+r
+;
+
+214 
+	}
+}
+
+217 
+	$agth_ptfi
+(
+agr_soc
+ *
+sc
+, 
+agr_pt
+ *
+pt
+)
+
+219 
+ieq
+ 
+i
+;
+
+220 
+hcom
+ *
+ec_pt
+ = (*)
+pt
+->
+pt_i
+;
+
+221 
+r
+;
+
+223 i(
+pt
+->
+pt_iive
+ =
+NULL
+) {
+
+227 i(
+ec_pt
+->
+ec_nvns
+ > 0) {
+
+229 
+ec_pt
+->
+ec_nvns
+ = 0;
+
+233 
+ec_pt
+->
+ec_b
+ &~
+ETHERCAP_VLAN_MTU
+;
+
+234 i(
+pt
+->
+pt_i
+->
+if_ags
+ & 
+IFF_UP
+) {
+
+235 ()
+	`if_ags_t
+(
+pt
+->
+pt_i
+,
+
+236 
+pt
+->
+pt_i
+->
+if_ags
+);
+
+240 
+	`memt
+(&
+i
+, 0, (ifr));
+
+241 
+i
+.
+i_addr
+.
+_n
+ = (ifr.ifr_addr);
+
+242 
+i
+.
+i_addr
+.
+_my
+ = 
+AF_UNSPEC
+;
+
+243 
+	`KASSERT
+((
+i
+.
+i_addr
+) >=
+
+244 (
+hmuiaddr_owocs
+));
+
+245 
+	`memy
+(&
+i
+.
+i_addr
+.
+_da
+,
+
+246 &
+hmuiaddr_owocs
+,
+
+247 (
+hmuiaddr_owocs
+));
+
+248 
+r
+ = 
+	`agt_iol
+(
+pt
+, 
+SIOCDELMULTI
+, (*)&
+i
+);
+
+249 i(
+r
+) {
+
+250  
+r
+;
+
+253 
+	`8023ad_ptfi
+(
+pt
+);
+
+255 
+	`
+(
+pt
+->
+pt_iive
+, 
+M_DEVBUF
+);
+
+256 
+pt
+->
+pt_iive
+ = 
+NULL
+;
+
+258  
+r
+;
+
+259 
+	}
+}
+
+262 
+	$agth_cfigmui_pt
+(
+agr_soc
+ *
+sc
+, 
+agr_pt
+ *
+pt
+,
+
+263 
+bo
+ 
+add
+)
+
+265 
+agth_ive
+ *
+iv
+ = 
+sc
+->
+sc_iive
+;
+
+267  
+	`agr_cfigmui_pt
+(&
+iv
+->
+p_muddrs
+, 
+pt
+, 
+add
+);
+
+268 
+	}
+}
+
+271 
+	$agth_cfigmui_ieq
+(
+agr_soc
+ *
+sc
+, 
+ieq
+ *
+i
+,
+
+272 
+bo
+ 
+add
+)
+
+274 
+agth_ive
+ *
+iv
+ = 
+sc
+->
+sc_iive
+;
+
+276  
+	`agr_cfigmui_ieq
+(
+sc
+, &
+iv
+->
+p_muddrs
+, 
+i
+, 
+add
+);
+
+277 
+	}
+}
+
+281 
+agr_pt
+ *
+
+282 
+	$agth__tx_pt
+(
+agr_soc
+ *
+sc
+, 
+mbuf
+ *
+m
+)
+
+285  
+	`8023ad__tx_pt
+(
+sc
+, 
+m
+);
+
+286 
+	}
+}
+
+	@agr/if_agrether_hash.c
+
+29 
+	~<sys/cdefs.h
+>
+
+30 
+__KERNEL_RCSID
+(0, "$NetBSD: if_agrether_hash.c,v 1.3 2007/05/05 18:23:23 yamt Exp $");
+
+32 
+	~<sys/m.h
+>
+
+33 
+	~<sys/mbuf.h
+>
+
+34 
+	~<sys/hash.h
+>
+
+36 
+	~<t/if.h
+>
+
+37 
+	~<t/if_dl.h
+>
+
+38 
+	~<t/if_h.h
+>
+
+39 
+	~<t/if_vnv.h
+>
+
+41 
+	~<t/agr/if_agthv.h
+>
+
+43 
+	~<t/.h
+>
+
+44 
+	~<t/_sym.h
+>
+
+45 
+	~<t/.h
+>
+
+46 
+	~<t/6.h
+>
+
+48 
+	#HASH
+(
+p
+, 
+l
+, 
+h
+
+	`hash32_buf
+(), (l), (h))
+
+	)
+
+50 c *
+agr_m_exa
+(
+mbuf
+ *, , , *);
+
+53 
+	$agr_m_exa
+(
+mbuf
+ *
+m
+, 
+off
+, 
+n
+, *
+buf
+)
+
+55 c *
+su
+;
+
+57 
+	`KASSERT
+((
+m
+->
+m_ags
+ & 
+M_PKTHDR
+) != 0);
+
+59 i(
+m
+->
+m_pkthdr
+.
+n
+ < 
+off
+ +en) {
+
+60 
+su
+ = 
+NULL
+;
+
+61 } i(
+m
+->
+m_n
+ >
+off
+ + 
+n
+) {
+
+62 
+su
+ = 
+	`mtod
+(
+m
+, *+ 
+off
+;
+
+64 
+	`m_cyda
+(
+m
+, 
+off
+, 
+n
+, 
+buf
+);
+
+65 
+su
+ = 
+buf
+;
+
+68  
+su
+;
+
+69 
+	}
+}
+
+71 
+ut32_t
+
+
+72 
+	$agth_hashmbuf
+(
+agr_soc
+ *
+sc
+, 
+mbuf
+ *
+m
+)
+
+74 
+h_hd
+ 
+eh_e
+;
+
+75 c 
+h_hd
+ *
+eh
+;
+
+76 
+ut32_t
+ 
+hash
+ = 
+HASH32_BUF_INIT
+;
+
+77 
+off
+ = 0;
+
+78 
+ut16_t
+ 
+tci
+;
+
+79 
+ut16_t
+ 
+y
+;
+
+80 
+m_g
+ *
+mg
+;
+
+82 
+eh
+ = 
+	`agr_m_exa
+(
+m
+, 
+off
+, (*eh), &
+eh_e
+);
+
+83 i(
+eh
+ =
+NULL
+) {
+
+84  
+hash
+;
+
+87 
+hash
+ = 
+	`HASH
+(&
+eh
+->
+h_dho
+, (eh->ether_dhost), hash);
+
+88 
+hash
+ = 
+	`HASH
+(&
+eh
+->
+h_sho
+, (eh->ether_shost), hash);
+
+89 
+y
+ = 
+eh
+->
+h_ty
+;
+
+91 i(
+y
+ =
+	`htobe16
+(
+ETHERTYPE_VLAN
+)) {
+
+92 
+h_vn_hd
+ 
+vnhdr_e
+;
+
+93 c 
+h_vn_hd
+ *
+vnhdr
+;
+
+95 
+vnhdr
+ = 
+	`agr_m_exa
+(
+m
+, 
+off
+, (*vlanhdr),
+
+96 &
+vnhdr_e
+);
+
+97 i(
+vnhdr
+ =
+NULL
+) {
+
+98  
+hash
+;
+
+101 
+tci
+ = 
+vnhdr
+->
+evl_g
+;
+
+102 
+y
+ = 
+vnhdr
+->
+evl_o
+;
+
+103 
+off
+ +(*
+vnhdr
+- (*
+eh
+);
+
+104 } i((
+mg
+ = 
+	`m_g_fd
+(
+m
+, 
+PACKET_TAG_VLAN
+, 
+NULL
+)) != NULL) {
+
+105 
+tci
+ = 
+	`hte16
+((*(
+u_t
+ *)(
+mg
+ + 1)) & 0xffff);
+
+107 
+tci
+ = 0;
+
+109 
+hash
+ = 
+	`HASH
+(&
+tci
+, (tci), hash);
+
+111 
+off
+ +(*
+eh
+);
+
+112 i(
+y
+ =
+	`htobe16
+(
+ETHERTYPE_IP
+)) {
+
+113 
+
+ 
+_e
+;
+
+114 c 
+
+ *ip;
+
+116 
+
+ = 
+	`agr_m_exa
+(
+m
+, 
+off
+, (*), &
+_e
+);
+
+117 i(
+
+ =
+NULL
+) {
+
+118  
+hash
+;
+
+121 
+hash
+ = 
+	`HASH
+(&
+
+->
+_c
+, (ip->ip_src), hash);
+
+122 
+hash
+ = 
+	`HASH
+(&
+
+->
+_d
+, (ip->ip_dst), hash);
+
+123 
+hash
+ = 
+	`HASH
+(&
+
+->
+_p
+, (ip->ip_p), hash);
+
+127 } i(
+y
+ =
+	`htobe16
+(
+ETHERTYPE_IPV6
+)) {
+
+128 
+6_hdr
+ 
+6_e
+;
+
+129 c 
+6_hdr
+ *
+6
+;
+
+130 
+ut32_t
+ 
+owb
+;
+
+132 
+6
+ = 
+	`agr_m_exa
+(
+m
+, 
+off
+, (*6), &
+6_e
+);
+
+133 i(
+6
+ =
+NULL
+) {
+
+134  
+hash
+;
+
+137 
+hash
+ = 
+	`HASH
+(&
+6
+->
+6_c
+, (ip6->ip6_src), hash);
+
+138 
+hash
+ = 
+	`HASH
+(&
+6
+->
+6_d
+, (ip6->ip6_dst), hash);
+
+141 
+owb
+ = 
+6
+->
+6_ow
+ & 
+IPV6_FLOWLABEL_MASK
+;
+
+142 
+hash
+ = 
+	`HASH
+(&
+owb
+, (flowlabel), hash);
+
+147  
+hash
+;
+
+148 
+	}
+}
+
+	@agr/if_agrethervar.h
+
+29 #ide
+_NET_AGR_IF_AGRETHERVAR_H_
+
+
+30 
+	#_NET_AGR_IF_AGRETHERVAR_H_
+
+
+	)
+
+32 
+	gagr_soc
+;
+
+38 c 
+agr_iy_s
+ 
+agth_s
+;
+
+39 
+ut32_t
+ 
+agth_hashmbuf
+(
+agr_soc
+ *, 
+mbuf
+ *);
+
+	@agr/if_agrioctl.h
+
+29 #ide
+_NET_AGR_IF_AGRIOCTL_H_
+
+
+30 
+	#_NET_AGR_IF_AGRIOCTL_H_
+
+
+	)
+
+38 
+	sageq
+ {
+
+39 
+	m_vsi
+;
+
+40 
+	m_cmd
+;
+
+41 *
+	m_buf
+;
+
+42 
+size_t
+ 
+	m_bu
+;
+
+45 
+	#AGRREQ_VERSION
+ 2
+
+	)
+
+48 
+	#AGRCMD_ADDPORT
+ 1
+
+	)
+
+49 
+	#AGRCMD_REMPORT
+ 2
+
+	)
+
+51 
+	#SIOCSETAGR
+ 
+SIOCSIFGENERIC
+
+
+	)
+
+54 
+	#AGRCMD_PORTLIST
+ 3
+
+	)
+
+56 
+	#SIOCGETAGR
+ 
+SIOCGIFGENERIC
+
+
+	)
+
+58 
+	sagtfo
+ {
+
+59 
+	mi_iame
+[
+IFNAMSIZ
+];
+
+60 
+	mi_ags
+;
+
+62 
+	#AGRPORTINFO_COLLECTING
+ 1
+
+	)
+
+63 
+	#AGRPORTINFO_DISTRIBUTING
+ 2
+
+	)
+
+64 
+	#AGRPORTINFO_BITS
+ \
+
+67 "b\0DISTRIBUTING\0"
+
+	)
+
+69 
+	sagi
+ {
+
+70 
+	ml_ts
+;
+
+	@agr/if_agrmonitor.c
+
+29 
+	~<sys/cdefs.h
+>
+
+30 
+__KERNEL_RCSID
+(0, "$NetBSD: if_agrmonitor.c,v 1.4 2008/03/24 09:14:52 yamt Exp $");
+
+32 
+	~<sys/m.h
+>
+
+33 
+	~<sys/out.h
+>
+
+34 
+	~<sys/sym.h
+>
+
+36 
+	~<t/if.h
+>
+
+37 
+	~<t/if_med.h
+>
+
+39 
+	~<t/agr/if_agrv_im.h
+>
+
+40 
+	~<t/agr/if_agrsubr.h
+>
+
+43 
+	$agt_m
+(
+agr_pt
+ *
+pt
+)
+
+45 
+agr_soc
+ *
+sc
+ = 
+	`AGR_SC_FROM_PORT
+(
+pt
+);
+
+46 
+u_t
+ 
+med
+;
+
+47 
+u_t
+ 
+us
+;
+
+55 
+med
+ = 
+IFM_ETHER
+ | 
+IFM_NONE
+;
+
+56 
+us
+ = 
+IFM_AVALID
+;
+
+57 i((~
+pt
+->
+pt_i
+->
+if_ags
+ & (
+IFF_RUNNING
+ | 
+IFF_UP
+))
+
+59 
+r
+;
+
+61 
+r
+ = 
+	`agr_pt_gmed
+(
+pt
+, &
+med
+, &
+us
+);
+
+62 i(
+r
+) {
+
+63 #i
+	`defed
+(
+DEBUG
+)
+
+64 
+	`tf
+("gmed: %d\n", 
+r
+);
+
+69 i((
+us
+ & (
+IFM_AVALID
+ | 
+IFM_ACTIVE
+)) == IFM_AVALID) {
+
+70 
+med
+ = 
+IFM_ETHER
+ | 
+IFM_NONE
+;
+
+73 i(
+med
+ =
+IFM_NONE
+) {
+
+77 #i
+	`defed
+(
+DEBUG
+)
+
+78 
+	`tf
+("%s: IFM_NONE\n", 
+__func__
+);
+
+80 
+med
+ = 
+IFM_ETHER
+ | 
+IFM_NONE
+;
+
+83 i(
+pt
+->
+pt_med
+ =
+med
+) {
+
+87 
+pt
+->
+pt_med
+ = 
+med
+;
+
+88 i(
+sc
+->
+sc_i
+->
+i_pte
+) {
+
+89 (*
+sc
+->
+sc_i
+->
+i_pte
+)(
+pt
+);
+
+91 
+	}
+}
+
+	@agr/if_agrsoftc.c
+
+29 
+	~<sys/cdefs.h
+>
+
+30 
+__KERNEL_RCSID
+(0, "$NetBSD: if_agrsoftc.c,v 1.4 2009/03/15 21:23:31 cegger Exp $");
+
+32 
+	~<sys/m.h
+>
+
+33 
+	~<sys/out.h
+>
+
+34 
+	~<sys/mloc.h
+>
+
+36 
+	~<t/if.h
+>
+
+37 
+	~<t/if_h.h
+>
+
+39 
+	~<t/agr/if_agrv_im.h
+>
+
+45 
+agr_soc
+ *
+
+46 
+	$agr_loc_soc
+()
+
+48 
+agr_soc
+ *
+sc
+;
+
+50 
+i
+ 
+u_if
+;
+
+51 
+hcom
+ 
+u_ec
+;
+
+52 } *
+u
+;
+
+58 
+sc
+ = 
+	`mloc
+((*sc- (sc->
+sc_if
++ (*
+u
+),
+
+59 
+M_DEVBUF
+, 
+M_WAITOK
+ | 
+M_ZERO
+);
+
+61  
+sc
+;
+
+62 
+	}
+}
+
+65 
+	$agr__soc
+(
+agr_soc
+ *
+sc
+)
+
+68 
+	`
+(
+sc
+, 
+M_DEVBUF
+);
+
+69 
+	}
+}
+
+	@agr/if_agrsubr.c
+
+29 
+	~<sys/cdefs.h
+>
+
+30 
+__KERNEL_RCSID
+(0, "$NetBSD: if_agrsubr.c,v 1.9 2010/01/19 22:08:17ooka Exp $");
+
+32 
+	~"t_.h
+"
+
+34 
+	~<sys/m.h
+>
+
+35 
+	~<sys/out.h
+>
+
+36 
+	~<sys/mloc.h
+>
+
+37 
+	~<sys/sym.h
+>
+
+38 
+	~<sys/tys.h
+>
+
+39 
+	~<sys/queue.h
+>
+
+40 
+	~<sys/sockio.h
+>
+
+42 
+	~<t/if.h
+>
+
+44 
+	~<t/agr/if_agrv_im.h
+>
+
+45 
+	~<t/agr/if_agrsubr.h
+>
+
+47 
+	sagr_mc_y
+ {
+
+48 
+TAILQ_ENTRY
+(
+agr_mc_y
+
+	mame_q
+;
+
+49 
+	mame_ft
+;
+
+50 
+agr_ieq
+ 
+	mame_i
+;
+
+53 
+agr_mc_y
+ *
+agr_mc_lookup
+(
+agr_muddrs
+ *,
+
+54 c 
+sockaddr
+ *);
+
+55 
+agt_mc_add_back
+(
+agr_pt
+ *, *);
+
+56 
+agt_mc_d_back
+(
+agr_pt
+ *, *);
+
+57 
+agrmc_mc_add_back
+(
+agr_mc_y
+ *, *);
+
+58 
+agrmc_mc_d_back
+(
+agr_mc_y
+ *, *);
+
+60 
+agr_mc_add
+(
+agr_muddrs
+ *, c 
+sockaddr
+ *);
+
+61 
+agr_mc_d
+(
+agr_muddrs
+ *, c 
+sockaddr
+ *);
+
+64 
+	$agr_mc_purg
+(
+agr_soc
+ *
+sc
+, 
+agr_muddrs
+ *
+ama
+)
+
+66 
+agr_mc_y
+ *
+ame
+;
+
+67 
+r
+ = 0;
+
+69 (
+ame
+ = 
+	`TAILQ_FIRST
+(&
+ama
+->
+ama_addrs
+)!
+NULL
+) {
+
+70 
+r
+ = 
+	`agr_pt_fch
+(
+sc
+,
+
+71 
+agt_mc_d_back
+, &
+ame
+->
+ame_i
+);
+
+72 i(
+r
+) {
+
+74 
+	`tf
+("%s: %d\n", 
+__func__
+, 
+r
+);
+
+76 
+	`TAILQ_REMOVE
+(&
+ama
+->
+ama_addrs
+, 
+ame
+, 
+ame_q
+);
+
+77 
+	`
+(
+ame
+, 
+M_DEVBUF
+);
+
+80  
+r
+;
+
+81 
+	}
+}
+
+84 
+	$agr_mc_
+(
+agr_soc
+ *
+sc
+, 
+agr_muddrs
+ *
+ama
+)
+
+87 
+	`TAILQ_INIT
+(&
+ama
+->
+ama_addrs
+);
+
+90 
+	}
+}
+
+94 
+agr_mc_y
+ *
+
+95 
+	$agr_mc_lookup
+(
+agr_muddrs
+ *
+ama
+, c 
+sockaddr
+ *
+
+)
+
+97 
+agr_mc_y
+ *
+ame
+;
+
+99 
+	`TAILQ_FOREACH
+(
+ame
+, &
+ama
+->
+ama_addrs
+, 
+ame_q
+) {
+
+100 i(!
+	`memcmp
+(&
+ame
+->
+ame_i
+.
+i_ss
+, 
+
+, sa->
+_n
+))
+
+101  
+ame
+;
+
+104  
+NULL
+;
+
+105 
+	}
+}
+
+108 
+agr_mc_fch
+(
+agr_muddrs
+ *
+ama
+,
+
+109 (*
+func
+)(
+agr_mc_y
+ *, *), *
+g
+)
+
+111 
+agr_mc_y
+ *
+ame
+;
+
+112 
+r
+ = 0;
+
+114 
+	`TAILQ_FOREACH
+(
+ame
+, &
+ama
+->
+ama_addrs
+, 
+ame_q
+) {
+
+115 
+r
+ = (*
+func
+)(
+ame
+, 
+g
+);
+
+116 i(
+r
+) {
+
+125  
+r
+;
+
+126 
+	}
+}
+
+129 
+	$agr_mc_add
+(
+agr_muddrs
+ *
+ama
+, c 
+sockaddr
+ *
+
+)
+
+131 
+agr_mc_y
+ *
+ame
+;
+
+133 
+ame
+ = 
+	`agr_mc_lookup
+(
+ama
+, 
+
+);
+
+134 i(
+ame
+) {
+
+135 
+ame
+->
+ame_ft
+++;
+
+139 
+ame
+ = 
+	`mloc
+((*ame), 
+M_DEVBUF
+, 
+M_NOWAIT
+ | 
+M_ZERO
+);
+
+140 i(
+ame
+ =
+NULL
+)
+
+141  
+ENOMEM
+;
+
+143 
+	`memy
+(&
+ame
+->
+ame_i
+.
+i_ss
+, 
+
+, sa->
+_n
+);
+
+144 
+ame
+->
+ame_ft
+ = 1;
+
+145 
+	`TAILQ_INSERT_TAIL
+(&
+ama
+->
+ama_addrs
+, 
+ame
+, 
+ame_q
+);
+
+147  
+ENETRESET
+;
+
+148 
+	}
+}
+
+151 
+	$agr_mc_d
+(
+agr_muddrs
+ *
+ama
+, c 
+sockaddr
+ *
+
+)
+
+153 
+agr_mc_y
+ *
+ame
+;
+
+155 
+ame
+ = 
+	`agr_mc_lookup
+(
+ama
+, 
+
+);
+
+156 i(
+ame
+ =
+NULL
+)
+
+157  
+ENOENT
+;
+
+159 
+ame
+->
+ame_ft
+--;
+
+160 i(
+ame
+->
+ame_ft
+ > 0)
+
+163 
+	`TAILQ_REMOVE
+(&
+ama
+->
+ama_addrs
+, 
+ame
+, 
+ame_q
+);
+
+164 
+	`
+(
+ame
+, 
+M_DEVBUF
+);
+
+166  
+ENETRESET
+;
+
+167 
+	}
+}
+
+172 
+agr_pt_fch
+(
+agr_soc
+ *
+sc
+,
+
+173 (*
+func
+)(
+agr_pt
+ *, *), *
+g
+)
+
+175 
+agr_pt
+ *
+pt
+;
+
+176 
+r
+ = 0;
+
+178 
+	`TAILQ_FOREACH
+(
+pt
+, &
+sc
+->
+sc_pts
+, 
+pt_q
+) {
+
+179 i((
+pt
+->
+pt_ags
+ & (
+AGRPORT_LARVAL
+ | 
+AGRPORT_DETACHING
+))) {
+
+182 
+r
+ = (
+func
+)(
+pt
+, 
+g
+);
+
+183 i(
+r
+) {
+
+192  
+r
+;
+
+193 
+	}
+}
+
+198 
+	$agrmc_mc_add_back
+(
+agr_mc_y
+ *
+ame
+, *
+g
+)
+
+201  
+	`agt_mc_add_back
+(
+g
+, &
+ame
+->
+ame_i
+);
+
+202 
+	}
+}
+
+205 
+	$agrmc_mc_d_back
+(
+agr_mc_y
+ *
+ame
+, *
+g
+)
+
+208  
+	`agt_mc_d_back
+(
+g
+, &
+ame
+->
+ame_i
+);
+
+209 
+	}
+}
+
+212 
+	$agr_cfigmui_pt
+(
+agr_muddrs
+ *
+ama
+, 
+agr_pt
+ *
+pt
+,
+
+213 
+bo
+ 
+add
+)
+
+216  
+	`agr_mc_fch
+(
+ama
+,
+
+217 
+add
+ ? 
+agrmc_mc_add_back
+ : 
+agrmc_mc_d_back
+, 
+pt
+);
+
+218 
+	}
+}
+
+223 
+	$agt_mc_add_back
+(
+agr_pt
+ *
+pt
+, *
+g
+)
+
+226  
+	`agt_iol
+(
+pt
+, 
+SIOCADDMULTI
+, 
+g
+);
+
+227 
+	}
+}
+
+230 
+	$agt_mc_d_back
+(
+agr_pt
+ *
+pt
+, *
+g
+)
+
+233  
+	`agt_iol
+(
+pt
+, 
+SIOCDELMULTI
+, 
+g
+);
+
+234 
+	}
+}
+
+237 
+	$agr_cfigmui_ieq
+(
+agr_soc
+ *
+sc
+, 
+agr_muddrs
+ *
+ama
+,
+
+238 
+ieq
+ *
+i
+, 
+bo
+ 
+add
+)
+
+240 
+r
+;
+
+242 i(
+add
+)
+
+243 
+r
+ = 
+	`agr_mc_add
+(
+ama
+, 
+	`ieq_gaddr
+(
+SIOCADDMULTI
+, 
+i
+));
+
+245 
+r
+ = 
+	`agr_mc_d
+(
+ama
+, 
+	`ieq_gaddr
+(
+SIOCDELMULTI
+, 
+i
+));
+
+247 i(
+r
+ !
+ENETRESET
+)
+
+248  
+r
+;
+
+250  
+	`agr_pt_fch
+(
+sc
+,
+
+251 
+add
+ ? 
+agt_mc_add_back
+ : 
+agt_mc_d_back
+, 
+i
+);
+
+252 
+	}
+}
+
+257 
+	$agr_pt_gmed
+(
+agr_pt
+ *
+pt
+, 
+u_t
+ *
+med
+, u_*
+us
+)
+
+259 
+ifmedq
+ 
+ifmr
+;
+
+260 
+r
+;
+
+262 
+	`memt
+(&
+ifmr
+, 0, (ifmr));
+
+263 
+ifmr
+.
+ifm_cou
+ = 0;
+
+264 
+r
+ = 
+	`agt_iol
+(
+pt
+, 
+SIOCGIFMEDIA
+, (*)&
+ifmr
+);
+
+266 i(
+r
+ == 0) {
+
+267 *
+med
+ = 
+ifmr
+.
+ifm_aive
+;
+
+268 *
+us
+ = 
+ifmr
+.
+ifm_us
+;
+
+271  
+r
+;
+
+272 
+	}
+}
+
+	@agr/if_agrsubr.h
+
+29 #ide
+_NET_AGR_IF_AGRSUBR_H_
+
+
+30 
+	#_NET_AGR_IF_AGRSUBR_H_
+
+
+	)
+
+32 
+	~<sys/queue.h
+>
+
+34 
+	gagr_mc_y
+;
+
+36 
+	sagr_muddrs
+ {
+
+37 
+TAILQ_HEAD
+(, 
+agr_mc_y
+
+	mama_addrs
+;
+
+40 
+agr_mc_
+(
+agr_soc
+ *, 
+agr_muddrs
+ *);
+
+41 
+agr_mc_purg
+(
+agr_soc
+ *, 
+agr_muddrs
+ *);
+
+43 
+agr_mc_fch
+(
+agr_muddrs
+ *,
+
+44 (*)(
+agr_mc_y
+ *, *), *);
+
+45 
+	`agr_pt_fch
+(
+agr_soc
+ *, (*)(
+agr_pt
+ *, *),
+
+48 
+	`agr_cfigmui_pt
+(
+agr_muddrs
+ *, 
+agr_pt
+ *, 
+bo
+);
+
+49 
+	`agr_cfigmui_ieq
+(
+agr_soc
+ *, 
+agr_muddrs
+ *,
+
+50 
+ieq
+ *, 
+bo
+);
+
+52 
+	`agr_pt_gmed
+(
+agr_pt
+ *, 
+u_t
+ *, u_int *);
+
+	@agr/if_agrtimer.c
+
+29 
+	~<sys/cdefs.h
+>
+
+30 
+__KERNEL_RCSID
+(0, "$NetBSD: if_agrtimer.c,v 1.6 2010/02/08 17:59:06 dyoung Exp $");
+
+32 
+	~<sys/m.h
+>
+
+33 
+	~<sys/out.h
+>
+
+34 
+	~<sys/sym.h
+>
+
+35 
+	~<sys/kl.h
+>
+
+37 
+	~<t/if.h
+>
+
+39 
+	~<t/agr/if_agrv_im.h
+>
+
+40 
+	~<t/agr/if_agrsubr.h
+>
+
+42 
+agim_tick
+(*);
+
+43 
+agim_pt_tick
+(
+agr_pt
+ *, *);
+
+46 
+	$agim_
+(
+agr_soc
+ *
+sc
+)
+
+49 
+	`out_
+(&
+sc
+->
+sc_out
+, 0);
+
+50 
+	`out_tfunc
+(&
+sc
+->
+sc_out
+, 
+agim_tick
+, sc);
+
+51 
+	}
+}
+
+54 
+	$agim_deroy
+(
+agr_soc
+ *
+sc
+)
+
+57 
+	`out_deroy
+(&
+sc
+->
+sc_out
+);
+
+58 
+	}
+}
+
+61 
+	$agim_t
+(
+agr_soc
+ *
+sc
+)
+
+64 
+	`out_schedu
+(&
+sc
+->
+sc_out
+, 0);
+
+65 
+	}
+}
+
+68 
+	$agim_
+(
+agr_soc
+ *
+sc
+)
+
+71 
+	`out_
+(&
+sc
+->
+sc_out
+);
+
+72 
+	}
+}
+
+75 
+	$agim_tick
+(*
+g
+)
+
+77 
+agr_soc
+ *
+sc
+ = 
+g
+;
+
+78 c 
+agr_iy_s
+ *
+i
+ = 
+sc
+->
+sc_i
+;
+
+80 
+	`KASSERT
+(
+i
+);
+
+82 
+	`AGR_LOCK
+(
+sc
+);
+
+83 i(
+i
+->
+i_tick
+) {
+
+84 (*
+i
+->
+i_tick
+)(
+sc
+);
+
+86 i(
+i
+->
+i_pick
+) {
+
+87 
+	`agr_pt_fch
+(
+sc
+, 
+agim_pt_tick
+, sc);
+
+89 
+	`out_schedu
+(&
+sc
+->
+sc_out
+, 
+hz
+);
+
+90 
+	`AGR_UNLOCK
+(
+sc
+);
+
+91 
+	}
+}
+
+94 
+	$agim_pt_tick
+(
+agr_pt
+ *
+pt
+, *
+g
+)
+
+96 
+agr_soc
+ *
+sc
+ = 
+g
+;
+
+98 
+	`agt_m
+(
+pt
+);
+
+99 (*
+sc
+->
+sc_i
+->
+i_pick
+)(sc, 
+pt
+);
+
+102 
+	}
+}
+
+	@agr/if_agrvar.h
+
+29 #ide
+_NET_AGR_IF_AGRVAR_H_
+
+
+30 
+	#_NET_AGR_IF_AGRVAR_H_
+
+
+	)
+
+36 
+agr_put
+(
+i
+ *, 
+mbuf
+ *);
+
+	@agr/if_agrvar_impl.h
+
+29 #ide
+_NET_AGR_IF_AGRVAR_IMPL_H_
+
+
+30 
+	#_NET_AGR_IF_AGRVAR_IMPL_H_
+
+
+	)
+
+36 
+	~<sys/mux.h
+>
+
+37 
+	~<sys/queue.h
+>
+
+39 
+	gagr_pt
+;
+
+40 
+	gagr_soc
+;
+
+42 
+	sagr_pt
+ {
+
+43 
+i
+ *
+	mpt_agri
+;
+
+44 
+i
+ *
+	mpt_i
+;
+
+45 
+TAILQ_ENTRY
+(
+agr_pt
+
+	mpt_q
+;
+
+46 (*
+	mpt_iol
+)(
+	mi
+ *, 
+	mu_lg
+, *);
+
+47 *
+	mpt_iive
+;
+
+48 
+	mpt_ags
+;
+
+49 
+u_t
+ 
+	mpt_med
+;
+
+50 
+	mpt_igaddr
+[0];
+
+52 
+	#AGRPORT_COLLECTING
+ 0x00000001
+
+	)
+
+53 
+	#AGRPORT_DISTRIBUTING
+ 0x00000002
+
+	)
+
+54 
+	#AGRPORT_PROMISC
+ 0x00000004
+
+	)
+
+55 
+	#AGRPORT_LADDRCHANGED
+ 0x00000008
+
+	)
+
+56 
+	#AGRPORT_ATTACHED
+ 0x00000010
+
+	)
+
+57 
+	#AGRPORT_LARVAL
+ 0x00000020
+
+	)
+
+58 
+	#AGRPORT_DETACHING
+ 0x00000040
+
+	)
+
+60 
+	sagr_iy_s
+ {
+
+62 (*
+	mi_tick
+)(
+	magr_soc
+ *);
+
+63 (*
+	mi_pick
+)(
+	magr_soc
+ *, 
+	magr_pt
+ *);
+
+64 (*
+	mi_pte
+)(
+	magr_pt
+ *);
+
+73 (*
+	mi_
+)(
+	magr_soc
+ *, 
+	mi
+ *);
+
+75 (*
+	mi_dt
+)(
+	magr_soc
+ *);
+
+82 (*
+	mi_pt
+)(
+	magr_soc
+ *, 
+	magr_pt
+ *);
+
+88 (*
+	mi_ptfi
+)(
+	magr_soc
+ *, 
+	magr_pt
+ *);
+
+90 
+	magr_pt
+ *(*
+	mi__tx_pt
+)(
+	magr_soc
+ *,
+
+91 
+	mmbuf
+ *);
+
+92 
+ut32_t
+ (*
+i_hashmbuf
+)(
+	magr_soc
+ *, 
+	mmbuf
+ *);
+
+94 (*
+	mi_cfigmui_pt
+)(
+	magr_soc
+ *, 
+	magr_pt
+ *,
+
+95 
+	mbo
+);
+
+96 (*
+	mi_cfigmui_ieq
+)(
+	magr_soc
+ *, 
+	mieq
+ *,
+
+97 
+	mbo
+);
+
+100 
+	sagr_ieq
+ {
+
+101 
+	mi_me
+[
+IFNAMSIZ
+];
+
+102 
+sockaddr_age
+ 
+	mi_ss
+;
+
+105 
+	sagr_soc
+ {
+
+106 
+kmux_t
+ 
+	msc_y_mtx
+;
+
+107 
+kmux_t
+ 
+	msc_lock
+;
+
+108 
+kcdv_t
+ 
+	msc_pts_cv
+;
+
+109 
+kcdv_t
+ 
+	msc_sc_cv
+;
+
+110 v
+	msc_nry
+;
+
+111 v
+	msc_sc
+;
+
+112 v
+bo
+ 
+	msc_wts
+;
+
+113 v
+	msc_rdpts
+;
+
+114 v
+	msc_ud
+;
+
+115 
+out
+ 
+	msc_out
+;
+
+116 
+	msc_ts
+;
+
+117 
+TAILQ_HEAD
+(, 
+agr_pt
+
+	msc_pts
+;
+
+118 c 
+agr_iy_s
+ *
+	msc_i
+;
+
+119 
+ut32_t
+ 
+	msc__cou
+;
+
+120 *
+	msc_iive
+;
+
+121 
+	msc_nvns
+;
+
+122 
+i
+ 
+	msc_if
+;
+
+125 
+	#AGR_SC_FROM_PORT
+(
+pt
+) \
+
+126 ((
+agr_soc
+ *)(
+pt
+)->
+pt_agri
+->
+if_soc
+)
+
+	)
+
+128 
+	#AGR_LOCK
+(
+sc
+
+	`agr_lock
+(sc)
+
+	)
+
+129 
+	#AGR_UNLOCK
+(
+sc
+
+	`agr_uock
+(sc)
+
+	)
+
+130 
+	#AGR_ASSERT_LOCKED
+(
+sc
+
+	`KASSERT
+(
+	`mux_owd
+(&(sc)->
+sc_lock
+))
+
+	)
+
+132 
+agr_lock
+(
+agr_soc
+ *);
+
+133 
+agr_uock
+(
+agr_soc
+ *);
+
+135 
+agt_iol
+(
+agr_pt
+ *, 
+u_lg
+, *);
+
+137 
+agr_soc
+ *
+agr_loc_soc
+();
+
+138 
+agr__soc
+(
+agr_soc
+ *);
+
+140 
+agr_xm_ame
+(
+i
+ *, 
+mbuf
+ *);
+
+142 
+	#AGR_ROUNDROBIN
+(
+sc
+(((sc)->
+sc_if
+.
+if_ags
+ & 
+IFF_LINK0
+!0)
+
+	)
+
+143 
+	#AGR_STATIC
+(
+sc
+(((sc)->
+sc_if
+.
+if_ags
+ & 
+IFF_LINK1
+!0)
+
+	)
+
+145 
+agim_
+(
+agr_soc
+ *);
+
+146 
+agim_deroy
+(
+agr_soc
+ *);
+
+147 
+agim_t
+(
+agr_soc
+ *);
+
+148 
+agim_
+(
+agr_soc
+ *);
+
+150 
+agt_m
+(
+agr_pt
+ *);
+
+	@bpf.c
+
+41 
+	~<sys/cdefs.h
+>
+
+42 
+__KERNEL_RCSID
+(0, "$NetBSD: bpf.c,v 1.190 2014/12/29 13:38:13 ozaki-r Exp $");
+
+44 #i
+defed
+(
+_KERNEL_OPT
+)
+
+45 
+	~"t_bpf.h
+"
+
+46 
+	~".h
+"
+
+47 
+	~"r.h
+"
+
+50 
+	~<sys/m.h
+>
+
+51 
+	~<sys/sym.h
+>
+
+52 
+	~<sys/mbuf.h
+>
+
+53 
+	~<sys/buf.h
+>
+
+54 
+	~<sys/time.h
+>
+
+55 
+	~<sys/oc.h
+>
+
+56 
+	~<sys/iol.h
+>
+
+57 
+	~<sys/cf.h
+>
+
+58 
+	~<sys/vnode.h
+>
+
+59 
+	~<sys/queue.h
+>
+
+60 
+	~<sys/.h
+>
+
+61 
+	~<sys/modu.h
+>
+
+62 
+	~<sys/.h
+>
+
+63 
+	~<sys/omic.h
+>
+
+65 
+	~<sys/fe.h
+>
+
+66 
+	~<sys/fedesc.h
+>
+
+67 
+	~<sys/y.h
+>
+
+68 
+	~<sys/uio.h
+>
+
+70 
+	~<sys/osw.h
+>
+
+71 
+	~<sys/sock.h
+>
+
+72 
+	~<sys/o.h
+>
+
+73 
+	~<sys/kl.h
+>
+
+74 
+	~<sys/pl.h
+>
+
+75 
+	~<sys/sysl.h
+>
+
+76 
+	~<sys/kauth.h
+>
+
+78 
+	~<t/if.h
+>
+
+79 
+	~<t/.h
+>
+
+81 
+	~<t/bpf.h
+>
+
+82 
+	~<t/bpfdesc.h
+>
+
+83 
+	~<t/bpfj.h
+>
+
+85 
+	~<t/if_c.h
+>
+
+86 
+	~<t/if_h.h
+>
+
+88 
+	~<t/.h
+>
+
+89 
+	~<t/if_p.h
+>
+
+92 
+	~<comt/sys/sockio.h
+>
+
+94 #ide
+BPF_BUFSIZE
+
+
+99 
+	#BPF_BUFSIZE
+ 32768
+
+	)
+
+102 
+	#PRINET
+ 26
+
+	)
+
+109 
+	gbpf_bufsize
+ = 
+BPF_BUFSIZE
+;
+
+110 
+	gbpf_maxbufsize
+ = 
+BPF_DFLTBUFSIZE
+;
+
+111 
+bo
+ 
+	gbpf_j
+ = 
+l
+;
+
+113 
+bpfj_s
+ 
+	gbpfj_modu_s
+ = {
+
+114 .
+bj_ge_code
+ = 
+NULL
+,
+
+115 .
+	gbj__code
+ = 
+NULL
+
+
+121 
+bpf_
+ 
+	gbpf_gs
+;
+
+127 
+kmux_t
+ 
+	gbpf_mtx
+;
+
+133 
+bpf_if
+ *
+	gbpf_ii
+;
+
+134 
+	$LIST_HEAD
+(, 
+bpf_d
+
+bpf_li
+;
+
+136 
+	`bpf_locbufs
+(
+bpf_d
+ *);
+
+137 
+	`bpf_div
+(
+bpf_if
+ *,
+
+138 *(*
+
+)(*, c *, 
+size_t
+),
+
+139 *, 
+u_t
+, u_t, c 
+bo
+);
+
+140 
+	`bpf_d
+(
+bpf_d
+ *);
+
+141 
+	`bpf_iame
+(
+i
+ *, 
+ieq
+ *);
+
+142 *
+	`bpf_my
+(*, c *, 
+size_t
+);
+
+143 
+	`bpf_move
+(
+uio
+ *, , 
+ut64_t
+,
+
+144 
+mbuf
+ **, 
+sockaddr
+ *);
+
+145 
+	`bpf_chd
+(
+bpf_d
+ *, 
+bpf_if
+ *);
+
+146 
+	`bpf_dachd
+(
+bpf_d
+ *);
+
+147 
+	`bpf_tif
+(
+bpf_d
+ *, 
+ieq
+ *);
+
+148 
+	`bpf_timed_out
+(*);
+
+149 
+le
+ 
+
+150 
+	`bpf_wakeup
+(
+bpf_d
+ *);
+
+151 
+	`bpf_hd
+(
+bpf_d
+ *);
+
+152 
+	`tchck
+(
+bpf_d
+ *, 
+u_ch
+ *, 
+u_t
+, u_int,
+
+153 *(*)(*, c *, 
+size_t
+), 
+timeec
+ *);
+
+154 
+	`t_d
+(
+bpf_d
+ *);
+
+155 
+	`bpf_gdli
+(
+bpf_d
+ *, 
+bpf_dli
+ *);
+
+156 
+	`bpf_td
+(
+bpf_d
+ *, 
+u_t
+);
+
+158 
+	`bpf_ad
+(
+fe
+ *, 
+off_t
+ *, 
+uio
+ *, 
+kauth_ed_t
+,
+
+160 
+	`bpf_wre
+(
+fe
+ *, 
+off_t
+ *, 
+uio
+ *, 
+kauth_ed_t
+,
+
+162 
+	`bpf_iol
+(
+fe
+ *, 
+u_lg
+, *);
+
+163 
+	`bpf_pl
+(
+fe
+ *, );
+
+164 
+	`bpf_
+(
+fe
+ *, 
+
+ *);
+
+165 
+	`bpf_o
+(
+fe
+ *);
+
+166 
+	`bpf_kqfr
+(
+fe
+ *, 
+kne
+ *);
+
+167 
+	`bpf_so
+(*);
+
+169 c 
+fes
+ 
+bpf_fes
+ = {
+
+170 .
+fo_ad
+ = 
+bpf_ad
+,
+
+171 .
+fo_wre
+ = 
+bpf_wre
+,
+
+172 .
+fo_iol
+ = 
+bpf_iol
+,
+
+173 .
+fo_f
+ = 
+u_f
+,
+
+174 .
+fo_pl
+ = 
+bpf_pl
+,
+
+175 .
+fo_
+ = 
+bpf_
+,
+
+176 .
+fo_o
+ = 
+bpf_o
+,
+
+177 .
+fo_kqfr
+ = 
+bpf_kqfr
+,
+
+178 .
+fo_t
+ = 
+u_t
+,
+
+179 
+	}
+};
+
+181 
+dev_ty_
+(
+bpf
+);
+
+183 c 
+cdevsw
+ 
+	gbpf_cdevsw
+ = {
+
+184 .
+d_
+ = 
+bpf
+,
+
+185 .
+	gd_o
+ = 
+noo
+,
+
+186 .
+	gd_ad
+ = 
+nd
+,
+
+187 .
+	gd_wre
+ = 
+nowre
+,
+
+188 .
+	gd_iol
+ = 
+noiol
+,
+
+189 .
+	gd_
+ = 
+no
+,
+
+190 .
+	gd_y
+ = 
+nty
+,
+
+191 .
+	gd_pl
+ = 
+nl
+,
+
+192 .
+	gd_mm
+ = 
+nomm
+,
+
+193 .
+	gd_kqfr
+ = 
+nokqfr
+,
+
+194 .
+	gd_disrd
+ = 
+nodisrd
+,
+
+195 .
+	gd_ag
+ = 
+D_OTHER
+
+
+198 
+bpfj_func_t
+
+
+199 
+	$bpf_j_ge
+(
+bpf_x_t
+ *
+bc
+, *
+code
+, 
+size_t
+ 
+size
+)
+
+202 
+	`memb_csum
+();
+
+203 i(
+bpfj_modu_s
+.
+bj_ge_code
+ !
+NULL
+) {
+
+204  
+bpfj_modu_s
+.
+	`bj_ge_code
+(
+bc
+, 
+code
+, 
+size
+);
+
+206  
+NULL
+;
+
+207 
+	}
+}
+
+210 
+	$bpf_j_code
+(
+bpfj_func_t
+ 
+jcode
+)
+
+212 
+	`KASSERT
+(
+bpfj_modu_s
+.
+bj__code
+ !
+NULL
+);
+
+213 
+bpfj_modu_s
+.
+	`bj__code
+(
+jcode
+);
+
+214 
+	}
+}
+
+217 
+	$bpf_move
+(
+uio
+ *uio, 
+lkty
+, 
+ut64_t
+ 
+mtu
+, 
+mbuf
+ **
+mp
+,
+
+218 
+sockaddr
+ *
+sockp
+)
+
+220 
+mbuf
+ *
+m
+;
+
+221 
+r
+;
+
+222 
+size_t
+ 
+n
+;
+
+223 
+size_t
+ 
+hn
+;
+
+224 
+size_t
+ 
+ign
+;
+
+235 
+lkty
+) {
+
+237 
+DLT_SLIP
+:
+
+238 
+sockp
+->
+_my
+ = 
+AF_INET
+;
+
+239 
+hn
+ = 0;
+
+240 
+ign
+ = 0;
+
+243 
+DLT_PPP
+:
+
+244 
+sockp
+->
+_my
+ = 
+AF_UNSPEC
+;
+
+245 
+hn
+ = 0;
+
+246 
+ign
+ = 0;
+
+249 
+DLT_EN10MB
+:
+
+250 
+sockp
+->
+_my
+ = 
+AF_UNSPEC
+;
+
+253 
+hn
+ = (
+h_hd
+);
+
+254 
+ign
+ = 2;
+
+257 
+DLT_ARCNET
+:
+
+258 
+sockp
+->
+_my
+ = 
+AF_UNSPEC
+;
+
+259 
+hn
+ = 
+ARC_HDRLEN
+;
+
+260 
+ign
+ = 5;
+
+263 
+DLT_FDDI
+:
+
+264 
+sockp
+->
+_my
+ = 
+AF_LINK
+;
+
+266 
+hn
+ = 16;
+
+267 
+ign
+ = 0;
+
+270 
+DLT_ECONET
+:
+
+271 
+sockp
+->
+_my
+ = 
+AF_UNSPEC
+;
+
+272 
+hn
+ = 6;
+
+273 
+ign
+ = 2;
+
+276 
+DLT_NULL
+:
+
+277 
+sockp
+->
+_my
+ = 
+AF_UNSPEC
+;
+
+278 
+hn
+ = 0;
+
+279 
+ign
+ = 0;
+
+283  (
+EIO
+);
+
+286 
+n
+ = 
+uio
+->
+uio_sid
+;
+
+291 i(
+n
+ - 
+hn
+ > 
+mtu
+)
+
+292  (
+EMSGSIZE
+);
+
+299 i(
+n
+ + 
+ign
+ > 
+MCLBYTES
+)
+
+300  (
+EIO
+);
+
+302 
+m
+ = 
+	`m_ghdr
+(
+M_WAIT
+, 
+MT_DATA
+);
+
+303 
+m
+->
+m_pkthdr
+.
+rcvif
+ = 
+NULL
+;
+
+304 
+m
+->
+m_pkthdr
+.
+n
+ = () - 
+hn
+);
+
+305 i(
+n
+ + 
+ign
+ > 
+MHLEN
+) {
+
+306 
+	`m_g
+(
+m
+, 
+M_WAIT
+);
+
+307 i((
+m
+->
+m_ags
+ & 
+M_EXT
+) == 0) {
+
+308 
+r
+ = 
+ENOBUFS
+;
+
+309 
+bad
+;
+
+314 i(
+ign
+ > 0) {
+
+315 
+m
+->
+m_da
+ +
+ign
+;
+
+316 
+m
+->
+m_n
+ -()
+ign
+;
+
+319 
+r
+ = 
+	`uiomove
+(
+	`mtod
+(
+m
+, *), 
+n
+, 
+uio
+);
+
+320 i(
+r
+)
+
+321 
+bad
+;
+
+322 i(
+hn
+ != 0) {
+
+323 
+	`memy
+(
+sockp
+->
+_da
+, 
+	`mtod
+(
+m
+, *), 
+hn
+);
+
+324 
+m
+->
+m_da
+ +
+hn
+;
+
+325 
+n
+ -
+hn
+;
+
+327 
+m
+->
+m_n
+ = ()
+n
+;
+
+328 *
+mp
+ = 
+m
+;
+
+331 
+bad
+:
+
+332 
+	`m_m
+(
+m
+);
+
+333  (
+r
+);
+
+334 
+	}
+}
+
+341 
+	$bpf_chd
+(
+bpf_d
+ *
+d
+, 
+bpf_if
+ *
+bp
+)
+
+348 
+d
+->
+bd_bif
+ = 
+bp
+;
+
+349 
+d
+->
+bd_xt
+ = 
+bp
+->
+bif_dli
+;
+
+350 
+bp
+->
+bif_dli
+ = 
+d
+;
+
+352 *
+bp
+->
+bif_drivp
+ = bp;
+
+353 
+	}
+}
+
+359 
+	$bpf_dachd
+(
+bpf_d
+ *
+d
+)
+
+361 
+bpf_d
+ **
+p
+;
+
+362 
+bpf_if
+ *
+bp
+;
+
+364 
+bp
+ = 
+d
+->
+bd_bif
+;
+
+369 i(
+d
+->
+bd_omisc
+) {
+
+370 
+r
+ 
+__dgud
+;
+
+372 
+d
+->
+bd_omisc
+ = 0;
+
+380 
+r
+ = 
+	`iromisc
+(
+bp
+->
+bif_i
+, 0);
+
+381 #ifde
+DIAGNOSTIC
+
+
+382 i(
+r
+)
+
+383 
+	`tf
+("%s: iromised: %d", 
+__func__
+, 
+r
+);
+
+387 
+p
+ = &
+bp
+->
+bif_dli
+;
+
+388 *
+p
+ !
+d
+) {
+
+389 
+p
+ = &(*p)->
+bd_xt
+;
+
+390 i(*
+p
+ =
+NULL
+)
+
+391 
+	`nic
+("%s: dest ili", 
+__func__
+);
+
+393 *
+p
+ = (*p)->
+bd_xt
+;
+
+394 i(
+bp
+->
+bif_dli
+ =
+NULL
+)
+
+398 *
+d
+->
+bd_bif
+->
+bif_drivp
+ = 
+NULL
+;
+
+399 
+d
+->
+bd_bif
+ = 
+NULL
+;
+
+400 
+	}
+}
+
+403 
+	$do
+()
+
+406 
+	`mux_
+(&
+bpf_mtx
+, 
+MUTEX_DEFAULT
+, 
+IPL_NONE
+);
+
+408 
+	`LIST_INIT
+(&
+bpf_li
+);
+
+410 
+bpf_gs
+.
+bs_cv
+ = 0;
+
+411 
+bpf_gs
+.
+bs_dr
+ = 0;
+
+412 
+bpf_gs
+.
+bs_
+ = 0;
+
+415 
+	}
+}
+
+422 
+	$bpfach
+(
+n
+)
+
+424 
+	`ONCE_DECL
+(
+c
+);
+
+426 
+	`RUN_ONCE
+(&
+c
+, 
+do
+);
+
+427 
+	}
+}
+
+434 
+	$bpf
+(
+dev_t
+ 
+dev
+, 
+ag
+, 
+mode
+, 
+lwp
+ *
+l
+)
+
+436 
+bpf_d
+ *
+d
+;
+
+437 
+fe
+ *
+
+;
+
+438 
+r
+, 
+fd
+;
+
+441 i((
+r
+ = 
+	`fd_locfe
+(&
+
+, &
+fd
+)) != 0)
+
+442  
+r
+;
+
+444 
+d
+ = 
+	`mloc
+((*d), 
+M_DEVBUF
+, 
+M_WAITOK
+|
+M_ZERO
+);
+
+445 
+d
+->
+bd_bufsize
+ = 
+bpf_bufsize
+;
+
+446 
+d
+->
+bd_e
+ = 1;
+
+447 
+d
+->
+bd_edback
+ = 0;
+
+448 
+d
+->
+bd_pid
+ = 
+l
+->
+l_oc
+->
+p_pid
+;
+
+449 #ifde
+_LP64
+
+
+450 i(
+curoc
+->
+p_ag
+ & 
+PK_32
+)
+
+451 
+d
+->
+bd_comt32
+ = 1;
+
+453 
+	`gnime
+(&
+d
+->
+bd_btime
+);
+
+454 
+d
+->
+bd_ime
+ = d->
+bd_mtime
+ = d->
+bd_btime
+;
+
+455 
+	`out_
+(&
+d
+->
+bd_out
+, 0);
+
+456 
+	`l
+(&
+d
+->
+bd_l
+);
+
+457 
+d
+->
+bd_sih
+ = 
+	`sot_eablish
+(
+SOFTINT_CLOCK
+, 
+bpf_so
+, d);
+
+458 
+d
+->
+bd_jcode
+ = 
+NULL
+;
+
+460 
+	`mux_r
+(&
+bpf_mtx
+);
+
+461 
+	`LIST_INSERT_HEAD
+(&
+bpf_li
+, 
+d
+, 
+bd_li
+);
+
+462 
+	`mux_ex
+(&
+bpf_mtx
+);
+
+464  
+	`fd_e
+(
+
+, 
+fd
+, 
+ag
+, &
+bpf_fes
+, 
+d
+);
+
+465 
+	}
+}
+
+473 
+	$bpf_o
+(
+fe
+ *
+
+)
+
+475 
+bpf_d
+ *
+d
+ = 
+
+->
+f_bpf
+;
+
+476 
+s
+;
+
+478 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+483 
+d
+->
+bd_pid
+ = 
+curoc
+->
+p_pid
+;
+
+485 
+s
+ = 
+	`
+();
+
+486 i(
+d
+->
+bd_e
+ =
+BPF_WAITING
+)
+
+487 
+	`out_
+(&
+d
+->
+bd_out
+);
+
+488 
+d
+->
+bd_e
+ = 
+BPF_IDLE
+;
+
+489 i(
+d
+->
+bd_bif
+)
+
+490 
+	`bpf_dachd
+(
+d
+);
+
+491 
+	`lx
+(
+s
+);
+
+492 
+	`bpf_d
+(
+d
+);
+
+493 
+	`mux_r
+(&
+bpf_mtx
+);
+
+494 
+	`LIST_REMOVE
+(
+d
+, 
+bd_li
+);
+
+495 
+	`mux_ex
+(&
+bpf_mtx
+);
+
+496 
+	`out_deroy
+(&
+d
+->
+bd_out
+);
+
+497 
+	`lderoy
+(&
+d
+->
+bd_l
+);
+
+498 
+	`sot_diablish
+(
+d
+->
+bd_sih
+);
+
+499 
+	`
+(
+d
+, 
+M_DEVBUF
+);
+
+500 
+
+->
+f_bpf
+ = 
+NULL
+;
+
+502 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+505 
+	}
+}
+
+512 
+	#ROTATE_BUFFERS
+(
+d
+) \
+
+513 (
+d
+)->
+bd_hbuf
+ = (d)->
+bd_sbuf
+; \
+
+514 (
+d
+)->
+bd_hn
+ = (d)->
+bd_
+; \
+
+515 (
+d
+)->
+bd_sbuf
+ = (d)->
+bd_fbuf
+; \
+
+516 (
+d
+)->
+bd_
+ = 0; \
+
+517 (
+d
+)->
+bd_fbuf
+ = 
+NULL
+;
+
+	)
+
+522 
+	$bpf_ad
+(
+fe
+ *
+
+, 
+off_t
+ *
+of
+, 
+uio
+ *uio,
+
+523 
+kauth_ed_t
+ 
+ed
+, 
+ags
+)
+
+525 
+bpf_d
+ *
+d
+ = 
+
+->
+f_bpf
+;
+
+526 
+timed_out
+;
+
+527 
+r
+;
+
+528 
+s
+;
+
+530 
+	`gnime
+(&
+d
+->
+bd_ime
+);
+
+535 i(
+uio
+->
+uio_sid
+ !
+d
+->
+bd_bufsize
+)
+
+536  (
+EINVAL
+);
+
+538 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+539 
+s
+ = 
+	`
+();
+
+540 i(
+d
+->
+bd_e
+ =
+BPF_WAITING
+)
+
+541 
+	`out_
+(&
+d
+->
+bd_out
+);
+
+542 
+timed_out
+ = (
+d
+->
+bd_e
+ =
+BPF_TIMED_OUT
+);
+
+543 
+d
+->
+bd_e
+ = 
+BPF_IDLE
+;
+
+549 
+d
+->
+bd_hbuf
+ =
+NULL
+) {
+
+550 i(
+
+->
+f_ag
+ & 
+FNONBLOCK
+) {
+
+551 i(
+d
+->
+bd_
+ == 0) {
+
+552 
+	`lx
+(
+s
+);
+
+553 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+554  (
+EWOULDBLOCK
+);
+
+556 
+	`ROTATE_BUFFERS
+(
+d
+);
+
+560 i((
+d
+->
+bd_immed
+ || 
+timed_out
+&& d->
+bd_
+ != 0) {
+
+566 
+	`ROTATE_BUFFERS
+(
+d
+);
+
+569 
+r
+ = 
+	`tp
+(
+d
+, 
+PRINET
+|
+PCATCH
+, "bpf",
+
+570 
+d
+->
+bd_out
+);
+
+571 i(
+r
+ =
+EINTR
+ || =
+ERESTART
+) {
+
+572 
+	`lx
+(
+s
+);
+
+573 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+574  (
+r
+);
+
+576 i(
+r
+ =
+EWOULDBLOCK
+) {
+
+582 i(
+d
+->
+bd_hbuf
+)
+
+590 i(
+d
+->
+bd_
+ == 0) {
+
+591 
+	`lx
+(
+s
+);
+
+592 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+595 
+	`ROTATE_BUFFERS
+(
+d
+);
+
+598 i(
+r
+ != 0)
+
+599 
+de
+;
+
+604 
+	`lx
+(
+s
+);
+
+611 
+r
+ = 
+	`uiomove
+(
+d
+->
+bd_hbuf
+, d->
+bd_hn
+, 
+uio
+);
+
+613 
+s
+ = 
+	`
+();
+
+614 
+d
+->
+bd_fbuf
+ = d->
+bd_hbuf
+;
+
+615 
+d
+->
+bd_hbuf
+ = 
+NULL
+;
+
+616 
+d
+->
+bd_hn
+ = 0;
+
+617 
+de
+:
+
+618 
+	`lx
+(
+s
+);
+
+619 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+620  (
+r
+);
+
+621 
+	}
+}
+
+627 
+le
+ 
+
+628 
+	$bpf_wakeup
+(
+bpf_d
+ *
+d
+)
+
+630 
+	`wakeup
+(
+d
+);
+
+631 i(
+d
+->
+bd_async
+)
+
+632 
+	`sot_schedu
+(
+d
+->
+bd_sih
+);
+
+633 
+	`ify
+(&
+d
+->
+bd_l
+, 0, 0);
+
+634 
+	}
+}
+
+637 
+	$bpf_so
+(*
+cook
+)
+
+639 
+bpf_d
+ *
+d
+;
+
+641 
+d
+ = 
+cook
+;
+
+642 i(
+d
+->
+bd_async
+)
+
+643 
+	`fownsigl
+(
+d
+->
+bd_pgid
+, 
+SIGIO
+, 0, 0, 
+NULL
+);
+
+644 
+	}
+}
+
+647 
+	$bpf_timed_out
+(*
+g
+)
+
+649 
+bpf_d
+ *
+d
+ = 
+g
+;
+
+650 
+s
+;
+
+652 
+s
+ = 
+	`
+();
+
+653 i(
+d
+->
+bd_e
+ =
+BPF_WAITING
+) {
+
+654 
+d
+->
+bd_e
+ = 
+BPF_TIMED_OUT
+;
+
+655 i(
+d
+->
+bd_
+ != 0)
+
+656 
+	`bpf_wakeup
+(
+d
+);
+
+658 
+	`lx
+(
+s
+);
+
+659 
+	}
+}
+
+663 
+	$bpf_wre
+(
+fe
+ *
+
+, 
+off_t
+ *
+of
+, 
+uio
+ *uio,
+
+664 
+kauth_ed_t
+ 
+ed
+, 
+ags
+)
+
+666 
+bpf_d
+ *
+d
+ = 
+
+->
+f_bpf
+;
+
+667 
+i
+ *
+i
+;
+
+668 
+mbuf
+ *
+m
+, *
+mc
+;
+
+669 
+r
+, 
+s
+;
+
+670 
+sockaddr_age
+ 
+d
+;
+
+672 
+m
+ = 
+NULL
+;
+
+674 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+676 i(
+d
+->
+bd_bif
+ =
+NULL
+) {
+
+677 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+678  (
+ENXIO
+);
+
+680 
+	`gnime
+(&
+d
+->
+bd_mtime
+);
+
+682 
+i
+ = 
+d
+->
+bd_bif
+->
+bif_i
+;
+
+684 i(
+uio
+->
+uio_sid
+ == 0) {
+
+685 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+689 
+r
+ = 
+	`bpf_move
+(
+uio
+, ()
+d
+->
+bd_bif
+->
+bif_d
+, 
+i
+->
+if_mtu
+, &
+m
+,
+
+690 (
+sockaddr
+ *&
+d
+);
+
+691 i(
+r
+) {
+
+692 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+693  (
+r
+);
+
+696 i(
+m
+->
+m_pkthdr
+.
+n
+ > 
+i
+->
+if_mtu
+) {
+
+697 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+698 
+	`m_m
+(
+m
+);
+
+699  (
+EMSGSIZE
+);
+
+702 i(
+d
+->
+bd_hdrcmt
+)
+
+703 
+d
+.
+ss_my
+ = 
+pudo_AF_HDRCMPLT
+;
+
+705 i(
+d
+->
+bd_edback
+) {
+
+706 
+mc
+ = 
+	`m_dup
+(
+m
+, 0, 
+M_COPYALL
+, 
+M_NOWAIT
+);
+
+707 i(
+mc
+ !
+NULL
+)
+
+708 
+mc
+->
+m_pkthdr
+.
+rcvif
+ = 
+i
+;
+
+711 
+m
+->
+m_ags
+ |
+M_PROMISC
+;
+
+713 
+mc
+ = 
+NULL
+;
+
+715 
+s
+ = 
+	`lsot
+();
+
+716 
+r
+ = (*
+i
+->
+if_ouut
+)(i, 
+m
+, (
+sockaddr
+ *&
+d
+, 
+NULL
+);
+
+718 i(
+mc
+ !
+NULL
+) {
+
+719 i(
+r
+ == 0)
+
+720 (*
+i
+->
+if_put
+)(i, 
+mc
+);
+
+721 
+	`m_m
+(
+mc
+);
+
+723 
+	`lx
+(
+s
+);
+
+724 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+728  (
+r
+);
+
+729 
+	}
+}
+
+736 
+	$t_d
+(
+bpf_d
+ *
+d
+)
+
+738 i(
+d
+->
+bd_hbuf
+) {
+
+740 
+d
+->
+bd_fbuf
+ = d->
+bd_hbuf
+;
+
+741 
+d
+->
+bd_hbuf
+ = 
+NULL
+;
+
+743 
+d
+->
+bd_
+ = 0;
+
+744 
+d
+->
+bd_hn
+ = 0;
+
+745 
+d
+->
+bd_rcou
+ = 0;
+
+746 
+d
+->
+bd_dcou
+ = 0;
+
+747 
+d
+->
+bd_ccou
+ = 0;
+
+748 
+	}
+}
+
+773 
+	$bpf_iol
+(
+fe
+ *
+
+, 
+u_lg
+ 
+cmd
+, *
+addr
+)
+
+775 
+bpf_d
+ *
+d
+ = 
+
+->
+f_bpf
+;
+
+776 
+s
+, 
+r
+ = 0;
+
+781 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+782 
+d
+->
+bd_pid
+ = 
+curoc
+->
+p_pid
+;
+
+783 #ifde
+_LP64
+
+
+784 i(
+curoc
+->
+p_ag
+ & 
+PK_32
+)
+
+785 
+d
+->
+bd_comt32
+ = 1;
+
+787 
+d
+->
+bd_comt32
+ = 0;
+
+790 
+s
+ = 
+	`
+();
+
+791 i(
+d
+->
+bd_e
+ =
+BPF_WAITING
+)
+
+792 
+	`out_
+(&
+d
+->
+bd_out
+);
+
+793 
+d
+->
+bd_e
+ = 
+BPF_IDLE
+;
+
+794 
+	`lx
+(
+s
+);
+
+796 
+cmd
+) {
+
+799 
+r
+ = 
+EINVAL
+;
+
+805 
+FIONREAD
+:
+
+807 
+n
+;
+
+809 
+s
+ = 
+	`
+();
+
+810 
+n
+ = 
+d
+->
+bd_
+;
+
+811 i(
+d
+->
+bd_hbuf
+)
+
+812 
+n
+ +
+d
+->
+bd_hn
+;
+
+813 
+	`lx
+(
+s
+);
+
+815 *(*)
+addr
+ = 
+n
+;
+
+822 
+BIOCGBLEN
+:
+
+823 *(
+u_t
+ *)
+addr
+ = 
+d
+->
+bd_bufsize
+;
+
+829 
+BIOCSBLEN
+:
+
+830 i(
+d
+->
+bd_bif
+ !
+NULL
+)
+
+831 
+r
+ = 
+EINVAL
+;
+
+833 
+u_t
+ 
+size
+ = *(u_*)
+addr
+;
+
+835 i(
+size
+ > 
+bpf_maxbufsize
+)
+
+836 *(
+u_t
+ *)
+addr
+ = 
+size
+ = 
+bpf_maxbufsize
+;
+
+837 i(
+size
+ < 
+BPF_MINBUFSIZE
+)
+
+838 *(
+u_t
+ *)
+addr
+ = 
+size
+ = 
+BPF_MINBUFSIZE
+;
+
+839 
+d
+->
+bd_bufsize
+ = 
+size
+;
+
+846 
+BIOCSETF
+:
+
+847 
+r
+ = 
+	`bpf_tf
+(
+d
+, 
+addr
+);
+
+853 
+BIOCFLUSH
+:
+
+854 
+s
+ = 
+	`
+();
+
+855 
+	`t_d
+(
+d
+);
+
+856 
+	`lx
+(
+s
+);
+
+862 
+BIOCPROMISC
+:
+
+863 i(
+d
+->
+bd_bif
+ =
+NULL
+) {
+
+867 
+r
+ = 
+EINVAL
+;
+
+870 
+s
+ = 
+	`
+();
+
+871 i(
+d
+->
+bd_omisc
+ == 0) {
+
+872 
+r
+ = 
+	`iromisc
+(
+d
+->
+bd_bif
+->
+bif_i
+, 1);
+
+873 i(
+r
+ == 0)
+
+874 
+d
+->
+bd_omisc
+ = 1;
+
+876 
+	`lx
+(
+s
+);
+
+882 
+BIOCGDLT
+:
+
+883 i(
+d
+->
+bd_bif
+ =
+NULL
+)
+
+884 
+r
+ = 
+EINVAL
+;
+
+886 *(
+u_t
+ *)
+addr
+ = 
+d
+->
+bd_bif
+->
+bif_d
+;
+
+892 
+BIOCGDLTLIST
+:
+
+893 i(
+d
+->
+bd_bif
+ =
+NULL
+)
+
+894 
+r
+ = 
+EINVAL
+;
+
+896 
+r
+ = 
+	`bpf_gdli
+(
+d
+, 
+addr
+);
+
+902 
+BIOCSDLT
+:
+
+903 i(
+d
+->
+bd_bif
+ =
+NULL
+)
+
+904 
+r
+ = 
+EINVAL
+;
+
+906 
+r
+ = 
+	`bpf_td
+(
+d
+, *(
+u_t
+ *)
+addr
+);
+
+912 #ifde
+OBIOCGETIF
+
+
+913 
+OBIOCGETIF
+:
+
+915 
+BIOCGETIF
+:
+
+916 i(
+d
+->
+bd_bif
+ =
+NULL
+)
+
+917 
+r
+ = 
+EINVAL
+;
+
+919 
+	`bpf_iame
+(
+d
+->
+bd_bif
+->
+bif_i
+, 
+addr
+);
+
+925 #ifde
+OBIOCSETIF
+
+
+926 
+OBIOCSETIF
+:
+
+928 
+BIOCSETIF
+:
+
+929 
+r
+ = 
+	`bpf_tif
+(
+d
+, 
+addr
+);
+
+935 
+BIOCSRTIMEOUT
+:
+
+937 
+timev
+ *
+tv
+ = 
+addr
+;
+
+940 
+d
+->
+bd_out
+ = 
+tv
+->
+tv_c
+ * 
+hz
+ +v->
+tv_uc
+ / 
+tick
+;
+
+941 i((
+d
+->
+bd_out
+ =0&& (
+tv
+->
+tv_uc
+ != 0))
+
+942 
+d
+->
+bd_out
+ = 1;
+
+946 #ifde
+BIOCGORTIMEOUT
+
+
+950 
+BIOCGORTIMEOUT
+:
+
+952 
+timev50
+ *
+tv
+ = 
+addr
+;
+
+954 
+tv
+->
+tv_c
+ = 
+d
+->
+bd_out
+ / 
+hz
+;
+
+955 
+tv
+->
+tv_uc
+ = (
+d
+->
+bd_out
+ % 
+hz
+* 
+tick
+;
+
+960 #ifde
+BIOCSORTIMEOUT
+
+
+964 
+BIOCSORTIMEOUT
+:
+
+966 
+timev50
+ *
+tv
+ = 
+addr
+;
+
+969 
+d
+->
+bd_out
+ = 
+tv
+->
+tv_c
+ * 
+hz
+ +v->
+tv_uc
+ / 
+tick
+;
+
+970 i((
+d
+->
+bd_out
+ =0&& (
+tv
+->
+tv_uc
+ != 0))
+
+971 
+d
+->
+bd_out
+ = 1;
+
+979 
+BIOCGRTIMEOUT
+:
+
+981 
+timev
+ *
+tv
+ = 
+addr
+;
+
+983 
+tv
+->
+tv_c
+ = 
+d
+->
+bd_out
+ / 
+hz
+;
+
+984 
+tv
+->
+tv_uc
+ = (
+d
+->
+bd_out
+ % 
+hz
+* 
+tick
+;
+
+990 
+BIOCGSTATS
+:
+
+992 
+bpf_
+ *
+bs
+ = 
+addr
+;
+
+994 
+bs
+->
+bs_cv
+ = 
+d
+->
+bd_rcou
+;
+
+995 
+bs
+->
+bs_dr
+ = 
+d
+->
+bd_dcou
+;
+
+996 
+bs
+->
+bs_
+ = 
+d
+->
+bd_ccou
+;
+
+1000 
+BIOCGSTATSOLD
+:
+
+1002 
+bpf__d
+ *
+bs
+ = 
+addr
+;
+
+1004 
+bs
+->
+bs_cv
+ = 
+d
+->
+bd_rcou
+;
+
+1005 
+bs
+->
+bs_dr
+ = 
+d
+->
+bd_dcou
+;
+
+1012 
+BIOCIMMEDIATE
+:
+
+1013 
+d
+->
+bd_immed
+ = *(
+u_t
+ *)
+addr
+;
+
+1016 
+BIOCVERSION
+:
+
+1018 
+bpf_vsi
+ *
+bv
+ = 
+addr
+;
+
+1020 
+bv
+->
+bv_maj
+ = 
+BPF_MAJOR_VERSION
+;
+
+1021 
+bv
+->
+bv_m
+ = 
+BPF_MINOR_VERSION
+;
+
+1025 
+BIOCGHDRCMPLT
+:
+
+1026 *(
+u_t
+ *)
+addr
+ = 
+d
+->
+bd_hdrcmt
+;
+
+1029 
+BIOCSHDRCMPLT
+:
+
+1030 
+d
+->
+bd_hdrcmt
+ = *(
+u_t
+ *)
+addr
+ ? 1 : 0;
+
+1036 
+BIOCGSEESENT
+:
+
+1037 *(
+u_t
+ *)
+addr
+ = 
+d
+->
+bd_e
+;
+
+1043 
+BIOCSSEESENT
+:
+
+1044 
+d
+->
+bd_e
+ = *(
+u_t
+ *)
+addr
+;
+
+1050 
+BIOCSFEEDBACK
+:
+
+1051 
+d
+->
+bd_edback
+ = *(
+u_t
+ *)
+addr
+;
+
+1057 
+BIOCGFEEDBACK
+:
+
+1058 *(
+u_t
+ *)
+addr
+ = 
+d
+->
+bd_edback
+;
+
+1061 
+FIONBIO
+:
+
+1069 
+FIOASYNC
+:
+
+1070 
+d
+->
+bd_async
+ = *(*)
+addr
+;
+
+1073 
+TIOCSPGRP
+:
+
+1074 
+FIOSETOWN
+:
+
+1075 
+r
+ = 
+	`ftown
+(&
+d
+->
+bd_pgid
+, 
+cmd
+, 
+addr
+);
+
+1078 
+TIOCGPGRP
+:
+
+1079 
+FIOGETOWN
+:
+
+1080 
+r
+ = 
+	`fgown
+(
+d
+->
+bd_pgid
+, 
+cmd
+, 
+addr
+);
+
+1083 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+1084  (
+r
+);
+
+1085 
+	}
+}
+
+1092 
+	$bpf_tf
+(
+bpf_d
+ *
+d
+, 
+bpf_ogm
+ *
+
+)
+
+1094 
+bpf_
+ *
+fcode
+, *
+d
+;
+
+1095 
+bpfj_func_t
+ 
+jcode
+, 
+dj
+;
+
+1096 
+size_t
+ 
+
+, 
+size
+;
+
+1097 
+s
+;
+
+1099 
+jcode
+ = 
+NULL
+;
+
+1100 
+
+ = 
+
+->
+bf_n
+;
+
+1102 i((
+
+->
+bf_s
+ =
+NULL
+ && 
+
+|| f> 
+BPF_MAXINSNS
+) {
+
+1103  
+EINVAL
+;
+
+1106 i(
+
+) {
+
+1111 
+size
+ = 
+
+ * (*
+
+->
+bf_s
+);
+
+1112 
+fcode
+ = 
+	`mloc
+(
+size
+, 
+M_DEVBUF
+, 
+M_WAITOK
+);
+
+1113 i(
+	`cy
+(
+
+->
+bf_s
+, 
+fcode
+, 
+size
+) != 0 ||
+
+1114 !
+	`bpf_vide
+(
+fcode
+, ()
+
+)) {
+
+1115 
+	`
+(
+fcode
+, 
+M_DEVBUF
+);
+
+1116  
+EINVAL
+;
+
+1118 
+	`memb_csum
+();
+
+1119 i(
+bpf_j
+)
+
+1120 
+jcode
+ = 
+	`bpf_j_ge
+(
+NULL
+, 
+fcode
+, 
+
+);
+
+1122 
+fcode
+ = 
+NULL
+;
+
+1125 
+s
+ = 
+	`
+();
+
+1126 
+d
+ = 
+d
+->
+bd_fr
+;
+
+1127 
+d
+->
+bd_fr
+ = 
+fcode
+;
+
+1128 
+dj
+ = 
+d
+->
+bd_jcode
+;
+
+1129 
+d
+->
+bd_jcode
+ = 
+jcode
+;
+
+1130 
+	`t_d
+(
+d
+);
+
+1131 
+	`lx
+(
+s
+);
+
+1133 i(
+d
+) {
+
+1134 
+	`
+(
+d
+, 
+M_DEVBUF
+);
+
+1136 i(
+dj
+) {
+
+1137 
+	`bpf_j_code
+(
+dj
+);
+
+1141 
+	}
+}
+
+1149 
+	$bpf_tif
+(
+bpf_d
+ *
+d
+, 
+ieq
+ *
+i
+)
+
+1151 
+bpf_if
+ *
+bp
+;
+
+1152 *
+
+;
+
+1153 
+un_
+, 
+i
+, 
+s
+, 
+r
+;
+
+1160 
+un_
+ = 0;
+
+1161 
+
+ = 
+i
+->
+i_me
+;
+
+1162 
+
+[(
+i
+->
+i_me
+) - 1] = '\0';
+
+1163 *
+
+++)
+
+1164 i(*
+
+ >= '0' && *cp <= '9')
+
+1165 
+un_
+ = 1;
+
+1166 i(!
+un_
+) {
+
+1168 
+i
+ = 0; i < (
+IFNAMSIZ
+ - 1); ++i) {
+
+1169 i((
+i
+->
+i_me
+[
+i
+] >= 'a' &&
+
+1170 
+i
+->
+i_me
+[
+i
+] <= 'z') ||
+
+1171 (
+i
+->
+i_me
+[
+i
+] >= 'A' &&
+
+1172 
+i
+->
+i_me
+[
+i
+] <= 'Z'))
+
+1174 
+i
+->
+i_me
+[
+i
+] = '0';
+
+1181 
+bp
+ = 
+bpf_ii
+; b!
+NULL
+; bbp->
+bif_xt
+) {
+
+1182 
+i
+ *
+i
+ = 
+bp
+->
+bif_i
+;
+
+1184 i(
+i
+ =
+NULL
+ ||
+
+1185 
+	`rcmp
+(
+i
+->
+if_xme
+, 
+i
+->
+i_me
+) != 0)
+
+1188 i(
+bp
+->
+bif_drivp
+ !&
+i
+->
+if_bpf
+)
+
+1196 i(
+d
+->
+bd_sbuf
+ =
+NULL
+) {
+
+1197 
+r
+ = 
+	`bpf_locbufs
+(
+d
+);
+
+1198 i(
+r
+ != 0)
+
+1199  (
+r
+);
+
+1201 
+s
+ = 
+	`
+();
+
+1202 i(
+bp
+ !
+d
+->
+bd_bif
+) {
+
+1203 i(
+d
+->
+bd_bif
+)
+
+1207 
+	`bpf_dachd
+(
+d
+);
+
+1209 
+	`bpf_chd
+(
+d
+, 
+bp
+);
+
+1211 
+	`t_d
+(
+d
+);
+
+1212 
+	`lx
+(
+s
+);
+
+1216  (
+ENXIO
+);
+
+1217 
+	}
+}
+
+1223 
+	$bpf_iame
+(
+i
+ *
+i
+, 
+ieq
+ *
+i
+)
+
+1225 
+	`memy
+(
+i
+->
+i_me
+, 
+i
+->
+if_xme
+, 
+IFNAMSIZ
+);
+
+1226 
+	}
+}
+
+1229 
+	$bpf_
+(
+fe
+ *
+
+, 
+
+ *
+
+)
+
+1231 
+bpf_d
+ *
+d
+ = 
+
+->
+f_bpf
+;
+
+1233 ()
+	`memt
+(
+
+, 0, (*st));
+
+1234 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+1235 
+
+->
+_dev
+ = 
+	`makedev
+(
+	`cdevsw_lookup_maj
+(&
+bpf_cdevsw
+), 
+d
+->
+bd_pid
+);
+
+1236 
+
+->
+_imeec
+ = 
+d
+->
+bd_ime
+;
+
+1237 
+
+->
+_mtimeec
+ = 
+d
+->
+bd_mtime
+;
+
+1238 
+
+->
+_imeec
+ = st->
+_bthtimeec
+ = 
+d
+->
+bd_btime
+;
+
+1239 
+
+->
+_uid
+ = 
+	`kauth_ed_geuid
+(
+
+->
+f_ed
+);
+
+1240 
+
+->
+_gid
+ = 
+	`kauth_ed_gegid
+(
+
+->
+f_ed
+);
+
+1241 
+
+->
+_mode
+ = 
+S_IFCHR
+;
+
+1242 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+1244 
+	}
+}
+
+1255 
+	$bpf_pl
+(
+fe
+ *
+
+, 
+evts
+)
+
+1257 
+bpf_d
+ *
+d
+ = 
+
+->
+f_bpf
+;
+
+1258 
+s
+ = 
+	`
+();
+
+1259 
+vts
+;
+
+1264 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+1265 
+d
+->
+bd_pid
+ = 
+curoc
+->
+p_pid
+;
+
+1267 
+vts
+ = 
+evts
+ & (
+POLLOUT
+ | 
+POLLWRNORM
+);
+
+1268 i(
+evts
+ & (
+POLLIN
+ | 
+POLLRDNORM
+)) {
+
+1272 i(
+d
+->
+bd_hn
+ != 0 ||
+
+1273 ((
+d
+->
+bd_immed
+ || d->
+bd_e
+ =
+BPF_TIMED_OUT
+) &&
+
+1274 
+d
+->
+bd_
+ != 0)) {
+
+1275 
+vts
+ |
+evts
+ & (
+POLLIN
+ | 
+POLLRDNORM
+);
+
+1277 
+	`ecd
+(
+cuwp
+, &
+d
+->
+bd_l
+);
+
+1279 i(
+d
+->
+bd_out
+ > 0 && d->
+bd_e
+ =
+BPF_IDLE
+) {
+
+1280 
+	`out_t
+(&
+d
+->
+bd_out
+, d->
+bd_out
+,
+
+1281 
+bpf_timed_out
+, 
+d
+);
+
+1282 
+d
+->
+bd_e
+ = 
+BPF_WAITING
+;
+
+1287 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+1288 
+	`lx
+(
+s
+);
+
+1289  (
+vts
+);
+
+1290 
+	}
+}
+
+1293 
+	$ft_bpdach
+(
+kne
+ *
+kn
+)
+
+1295 
+bpf_d
+ *
+d
+ = 
+kn
+->
+kn_hook
+;
+
+1296 
+s
+;
+
+1298 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+1299 
+s
+ = 
+	`
+();
+
+1300 
+	`SLIST_REMOVE
+(&
+d
+->
+bd_l
+.
+l_kli
+, 
+kn
+, 
+kne
+, 
+kn_ext
+);
+
+1301 
+	`lx
+(
+s
+);
+
+1302 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+1303 
+	}
+}
+
+1306 
+	$ft_bpd
+(
+kne
+ *
+kn
+, 
+ht
+)
+
+1308 
+bpf_d
+ *
+d
+ = 
+kn
+->
+kn_hook
+;
+
+1309 
+rv
+;
+
+1311 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+1312 
+kn
+->
+kn_da
+ = 
+d
+->
+bd_hn
+;
+
+1313 i(
+d
+->
+bd_immed
+)
+
+1314 
+kn
+->
+kn_da
+ +
+d
+->
+bd_
+;
+
+1315 
+rv
+ = (
+kn
+->
+kn_da
+ > 0);
+
+1316 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+1317  
+rv
+;
+
+1318 
+	}
+}
+
+1320 c 
+frs
+ 
+	gbpd_fts
+ =
+
+1321 { 1, 
+NULL
+, 
+ft_bpdach
+, 
+ft_bpd
+ };
+
+1324 
+	$bpf_kqfr
+(
+fe
+ *
+
+, 
+kne
+ *
+kn
+)
+
+1326 
+bpf_d
+ *
+d
+ = 
+
+->
+f_bpf
+;
+
+1327 
+kli
+ *klist;
+
+1328 
+s
+;
+
+1330 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+1332 
+kn
+->
+kn_fr
+) {
+
+1333 
+EVFILT_READ
+:
+
+1334 
+kli
+ = &
+d
+->
+bd_l
+.
+l_kli
+;
+
+1335 
+kn
+->
+kn_f
+ = &
+bpd_fts
+;
+
+1339 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+1340  (
+EINVAL
+);
+
+1343 
+kn
+->
+kn_hook
+ = 
+d
+;
+
+1345 
+s
+ = 
+	`
+();
+
+1346 
+	`SLIST_INSERT_HEAD
+(
+kli
+, 
+kn
+, 
+kn_ext
+);
+
+1347 
+	`lx
+(
+s
+);
+
+1348 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+1351 
+	}
+}
+
+1358 
+	$bpf_my
+(*
+d_g
+, c *
+c_g
+, 
+size_t
+ 
+n
+)
+
+1360 c 
+mbuf
+ *
+m
+;
+
+1361 
+u_t
+ 
+cou
+;
+
+1362 
+u_ch
+ *
+d
+;
+
+1364 
+m
+ = 
+c_g
+;
+
+1365 
+d
+ = 
+d_g
+;
+
+1366 
+n
+ > 0) {
+
+1367 i(
+m
+ =
+NULL
+)
+
+1368 
+	`nic
+("bpf_mcpy");
+
+1369 
+cou
+ = 
+	`m
+(
+m
+->
+m_n
+, 
+n
+);
+
+1370 
+	`memy
+(
+d
+, 
+	`mtod
+(
+m
+, c *), 
+cou
+);
+
+1371 
+m
+ = m->
+m_xt
+;
+
+1372 
+d
+ +
+cou
+;
+
+1373 
+n
+ -
+cou
+;
+
+1375  
+d_g
+;
+
+1376 
+	}
+}
+
+1387 
+le
+ 
+
+1388 
+bpf_div
+(
+bpf_if
+ *
+bp
+, *(*
+
+)(*, c *, 
+size_t
+),
+
+1389 *
+pkt
+, 
+u_t
+ 
+pk
+, u_
+bu
+, c 
+bo
+ 
+rcv
+)
+
+1391 
+ut32_t
+ 
+	gmem
+[
+BPF_MEMWORDS
+];
+
+1392 
+bpf_gs_t
+ 
+	ggs
+ = {
+
+1393 .
+pkt
+ = (c 
+ut8_t
+ *)pkt,
+
+1394 .
+	gw
+ = 
+pk
+,
+
+1395 .
+	gbu
+ = 
+bu
+,
+
+1396 .
+	gmem
+ = 
+mem
+,
+
+1397 .
+	gg
+ = 
+NULL
+
+
+1399 
+bo
+ 
+	ggtime
+ = 
+l
+;
+
+1400 
+timeec
+ 
+	gts
+;
+
+1407 
+bpf_d
+ *
+	gd
+ = 
+bp
+->
+bif_dli
+; d !
+NULL
+; d = 
+d
+->
+bd_xt
+) {
+
+1408 
+u_t
+ 
+
+;
+
+1410 i(!
+	gd
+->
+	gbd_e
+ && !
+	grcv
+) {
+
+1413 
+	gd
+->
+	gbd_rcou
+++;
+
+1414 
+	gbpf_gs
+.
+	gbs_cv
+++;
+
+1416 i(
+	gd
+->
+	gbd_jcode
+)
+
+1417 
+	g
+ = 
+d
+->
+bd_jcode
+(
+NULL
+, &
+gs
+);
+
+1419 
+	g
+ = 
+bpf_fr_ext
+(
+NULL
+, 
+d
+->
+bd_fr
+, &
+gs
+);
+
+1421 i(!
+	g
+) {
+
+1424 i(!
+	ggtime
+) {
+
+1425 
+	ggtime
+ = 
+ue
+;
+
+1426 
+nime
+(&
+ts
+);
+
+1428 
+tchck
+(
+d
+, 
+pkt
+, 
+pk
+, 
+
+, 
+
+, &
+ts
+);
+
+1439 
+	$_bpf_p
+(
+bpf_if
+ *
+bp
+, 
+u_ch
+ *
+pkt
+, 
+u_t
+ 
+pk
+)
+
+1442 
+	`bpf_div
+(
+bp
+, 
+memy
+, 
+pkt
+, 
+pk
+,k, 
+ue
+);
+
+1443 
+	}
+}
+
+1450 
+	$_bpf_mp2
+(
+bpf_if
+ *
+bp
+, *
+da
+, 
+u_t
+ 
+dn
+, 
+mbuf
+ *
+m
+)
+
+1452 
+u_t
+ 
+pk
+;
+
+1453 
+mbuf
+ 
+mb
+;
+
+1456 i((
+m
+->
+m_ags
+ & 
+M_PROMISC
+!0 && m->
+m_pkthdr
+.
+rcvif
+ =
+NULL
+) {
+
+1457 
+m
+->
+m_ags
+ &~
+M_PROMISC
+;
+
+1461 
+pk
+ = 
+	`m_ngth
+(
+m
++ 
+dn
+;
+
+1468 ()
+	`memt
+(&
+mb
+, 0, (mb));
+
+1469 
+mb
+.
+m_xt
+ = 
+m
+;
+
+1470 
+mb
+.
+m_da
+ = 
+da
+;
+
+1471 
+mb
+.
+m_n
+ = 
+dn
+;
+
+1473 
+	`bpf_div
+(
+bp
+, 
+bpf_my
+, &
+mb
+, 
+pk
+, 0, 
+m
+->
+m_pkthdr
+.
+rcvif
+ !
+NULL
+);
+
+1474 
+	}
+}
+
+1480 
+	$_bpf_mp
+(
+bpf_if
+ *
+bp
+, 
+mbuf
+ *
+m
+)
+
+1482 *(*
+
+)(*, c *, 
+size_t
+);
+
+1483 
+u_t
+ 
+pk
+, 
+bu
+;
+
+1484 *
+mg
+;
+
+1487 i((
+m
+->
+m_ags
+ & 
+M_PROMISC
+!0 && m->
+m_pkthdr
+.
+rcvif
+ =
+NULL
+) {
+
+1488 
+m
+->
+m_ags
+ &~
+M_PROMISC
+;
+
+1492 
+pk
+ = 
+	`m_ngth
+(
+m
+);
+
+1494 i(
+pk
+ =
+m
+->
+m_n
+) {
+
+1495 
+
+ = (*)
+memy
+;
+
+1496 
+mg
+ = 
+	`mtod
+(
+m
+, *);
+
+1497 
+bu
+ = 
+pk
+;
+
+1499 
+
+ = 
+bpf_my
+;
+
+1500 
+mg
+ = 
+m
+;
+
+1501 
+bu
+ = 0;
+
+1504 
+	`bpf_div
+(
+bp
+, 
+
+, 
+mg
+, 
+pk
+, 
+bu
+, 
+m
+->
+m_pkthdr
+.
+rcvif
+ !
+NULL
+);
+
+1505 
+	}
+}
+
+1515 
+	$_bpf_mp_af
+(
+bpf_if
+ *
+bp
+, 
+ut32_t
+ 
+af
+, 
+mbuf
+ *
+m
+)
+
+1517 
+mbuf
+ 
+m0
+;
+
+1519 
+m0
+.
+m_ags
+ = 0;
+
+1520 
+m0
+.
+m_xt
+ = 
+m
+;
+
+1521 
+m0
+.
+m_n
+ = 4;
+
+1522 
+m0
+.
+m_da
+ = (*)&
+af
+;
+
+1524 
+	`_bpf_mp
+(
+bp
+, &
+m0
+);
+
+1525 
+	}
+}
+
+1534 
+	$_bpf_mp__
+(
+bpf_if
+ *
+bp
+, 
+u_ch
+ *
+chdr
+, 
+mbuf
+ **
+m
+)
+
+1536 
+s
+;
+
+1537 
+u_ch
+ *
+hp
+;
+
+1539 
+	`M_PREPEND
+(*
+m
+, 
+SLIP_HDRLEN
+, 
+M_DONTWAIT
+);
+
+1540 i(*
+m
+ =
+NULL
+)
+
+1543 
+hp
+ = 
+	`mtod
+(*
+m
+, 
+u_ch
+ *);
+
+1544 
+hp
+[
+SLX_DIR
+] = 
+SLIPDIR_IN
+;
+
+1545 ()
+	`memy
+(&
+hp
+[
+SLX_CHDR
+], 
+chdr
+, 
+CHDR_LEN
+);
+
+1547 
+s
+ = 
+	`
+();
+
+1548 
+	`_bpf_mp
+(
+bp
+, *
+m
+);
+
+1549 
+	`lx
+(
+s
+);
+
+1551 
+	`m_adj
+(*
+m
+, 
+SLIP_HDRLEN
+);
+
+1552 
+	}
+}
+
+1560 
+	$_bpf_mp__out
+(
+bpf_if
+ *
+bp
+, 
+u_ch
+ *
+chdr
+, 
+mbuf
+ *
+m
+)
+
+1562 
+mbuf
+ 
+m0
+;
+
+1563 
+u_ch
+ *
+hp
+;
+
+1564 
+s
+;
+
+1566 
+m0
+.
+m_ags
+ = 0;
+
+1567 
+m0
+.
+m_xt
+ = 
+m
+;
+
+1568 
+m0
+.
+m_da
+ = m0.
+m_d
+;
+
+1569 
+m0
+.
+m_n
+ = 
+SLIP_HDRLEN
+;
+
+1571 
+hp
+ = 
+	`mtod
+(&
+m0
+, 
+u_ch
+ *);
+
+1573 
+hp
+[
+SLX_DIR
+] = 
+SLIPDIR_OUT
+;
+
+1574 ()
+	`memy
+(&
+hp
+[
+SLX_CHDR
+], 
+chdr
+, 
+CHDR_LEN
+);
+
+1576 
+s
+ = 
+	`
+();
+
+1577 
+	`_bpf_mp
+(
+bp
+, &
+m0
+);
+
+1578 
+	`lx
+(
+s
+);
+
+1579 
+	`m_m
+(
+m
+);
+
+1580 
+	}
+}
+
+1583 
+	$bpf_hd
+(
+bpf_d
+ *
+d
+)
+
+1585 
+hd
+ = 
+d
+->
+bd_bif
+->
+bif_hd
+;
+
+1592 #ifde
+_LP64
+
+
+1593 i(
+d
+->
+bd_comt32
+)
+
+1594  (
+	`BPF_WORDALIGN32
+(
+hd
+ + 
+SIZEOF_BPF_HDR32
+) - hdrlen);
+
+1597  (
+	`BPF_WORDALIGN
+(
+hd
+ + 
+SIZEOF_BPF_HDR
+) - hdrlen);
+
+1598 
+	}
+}
+
+1609 
+tchck
+(
+bpf_d
+ *
+d
+, 
+u_ch
+ *
+pkt
+, 
+u_t
+ 
+pk
+, u_
+n
+,
+
+1610 *(*
+
+)(*, c *, 
+size_t
+), 
+timeec
+ *
+ts
+)
+
+1612 *
+	gh
+;
+
+1613 
+	gtn
+, 
+	gcu
+, 
+	g
+;
+
+1614 
+	ghd
+ = 
+bpf_hd
+(
+d
+);
+
+1615 
+	gdo_wakeup
+ = 0;
+
+1617 ++
+	gd
+->
+	gbd_ccou
+;
+
+1618 ++
+	gbpf_gs
+.
+	gbs_
+;
+
+1625 
+	gtn
+ = 
+hd
+ + 
+m
+(
+n
+, 
+pk
+);
+
+1626 i(
+	gtn
+ > 
+	gd
+->
+	gbd_bufsize
+)
+
+1627 
+	gtn
+ = 
+d
+->
+bd_bufsize
+;
+
+1632 
+	g
+ = 
+tn
+ - 
+hd
+;
+
+1633 i(
+	g
+ < 0)
+
+1634 
+	g
+ = 0;
+
+1639 #ifde
+_LP64
+
+
+1640 i(
+	gd
+->
+	gbd_comt32
+)
+
+1641 
+	gcu
+ = 
+BPF_WORDALIGN32
+(
+d
+->
+bd_
+);
+
+1644 
+	gcu
+ = 
+BPF_WORDALIGN
+(
+d
+->
+bd_
+);
+
+1645 i(
+	gcu
+ + 
+	gtn
+ > 
+	gd
+->
+	gbd_bufsize
+) {
+
+1651 i(
+	gd
+->
+	gbd_fbuf
+ =
+NULL
+) {
+
+1656 ++
+d
+->
+bd_dcou
+;
+
+1657 ++
+	gbpf_gs
+.
+	gbs_dr
+;
+
+1660 
+ROTATE_BUFFERS
+(
+d
+);
+
+1661 
+	gdo_wakeup
+ = 1;
+
+1662 
+	gcu
+ = 0;
+
+1663 } i(
+	gd
+->
+	gbd_immed
+ || d->
+	gbd_e
+ =
+BPF_TIMED_OUT
+) {
+
+1669 
+do_wakeup
+ = 1;
+
+1675 
+	gh
+ = (*)
+d
+->
+bd_sbuf
+ + 
+cu
+;
+
+1676 #ifde
+_LP64
+
+
+1677 i(
+	gd
+->
+	gbd_comt32
+) {
+
+1678 
+bpf_hdr32
+ *
+	ghp32
+;
+
+1680 
+	ghp32
+ = (
+bpf_hdr32
+ *)
+h
+;
+
+1681 
+	ghp32
+->
+	gbh_tamp
+.
+	gtv_c
+ = 
+ts
+->
+tv_c
+;
+
+1682 
+	ghp32
+->
+	gbh_tamp
+.
+	gtv_uc
+ = 
+ts
+->
+tv_nc
+ / 1000;
+
+1683 
+	ghp32
+->
+	gbh_d
+ = 
+pk
+;
+
+1684 
+	ghp32
+->
+	gbh_hd
+ = 
+hd
+;
+
+1685 
+	ghp32
+->
+	gbh_
+ = 
+
+;
+
+1689 
+bpf_hdr
+ *
+	ghp
+;
+
+1691 
+	ghp
+ = (
+bpf_hdr
+ *)
+h
+;
+
+1692 
+	ghp
+->
+	gbh_tamp
+.
+	gtv_c
+ = 
+ts
+->
+tv_c
+;
+
+1693 
+	ghp
+->
+	gbh_tamp
+.
+	gtv_uc
+ = 
+ts
+->
+tv_nc
+ / 1000;
+
+1694 
+	ghp
+->
+	gbh_d
+ = 
+pk
+;
+
+1695 
+	ghp
+->
+	gbh_hd
+ = 
+hd
+;
+
+1696 
+	ghp
+->
+	gbh_
+ = 
+
+;
+
+1702 (*
+	g
+)(
+	gh
+ + 
+	ghd
+, 
+	gpkt
+, 
+	g
+);
+
+1703 
+	gd
+->
+	gbd_
+ = 
+cu
+ + 
+tn
+;
+
+1709 i(
+	gdo_wakeup
+)
+
+1710 
+bpf_wakeup
+(
+d
+);
+
+1717 
+	$bpf_locbufs
+(
+bpf_d
+ *
+d
+)
+
+1720 
+d
+->
+bd_fbuf
+ = 
+	`mloc
+(d->
+bd_bufsize
+, 
+M_DEVBUF
+, 
+M_WAITOK
+ | 
+M_CANFAIL
+);
+
+1721 i(!
+d
+->
+bd_fbuf
+)
+
+1722  (
+ENOBUFS
+);
+
+1723 
+d
+->
+bd_sbuf
+ = 
+	`mloc
+(d->
+bd_bufsize
+, 
+M_DEVBUF
+, 
+M_WAITOK
+ | 
+M_CANFAIL
+);
+
+1724 i(!
+d
+->
+bd_sbuf
+) {
+
+1725 
+	`
+(
+d
+->
+bd_fbuf
+, 
+M_DEVBUF
+);
+
+1726  (
+ENOBUFS
+);
+
+1728 
+d
+->
+bd_
+ = 0;
+
+1729 
+d
+->
+bd_hn
+ = 0;
+
+1731 
+	}
+}
+
+1738 
+	$bpf_d
+(
+bpf_d
+ *
+d
+)
+
+1745 i(
+d
+->
+bd_sbuf
+ !
+NULL
+) {
+
+1746 
+	`
+(
+d
+->
+bd_sbuf
+, 
+M_DEVBUF
+);
+
+1747 i(
+d
+->
+bd_hbuf
+ !
+NULL
+)
+
+1748 
+	`
+(
+d
+->
+bd_hbuf
+, 
+M_DEVBUF
+);
+
+1749 i(
+d
+->
+bd_fbuf
+ !
+NULL
+)
+
+1750 
+	`
+(
+d
+->
+bd_fbuf
+, 
+M_DEVBUF
+);
+
+1752 i(
+d
+->
+bd_fr
+)
+
+1753 
+	`
+(
+d
+->
+bd_fr
+, 
+M_DEVBUF
+);
+
+1755 i(
+d
+->
+bd_jcode
+ !
+NULL
+) {
+
+1756 
+	`bpf_j_code
+(
+d
+->
+bd_jcode
+);
+
+1758 
+	}
+}
+
+1766 
+	$_bpach
+(
+i
+ *
+i
+, 
+u_t
+ 
+d
+, u_
+hd
+, 
+bpf_if
+ **
+drivp
+)
+
+1768 
+bpf_if
+ *
+bp
+;
+
+1769 
+bp
+ = 
+	`mloc
+((*bp), 
+M_DEVBUF
+, 
+M_DONTWAIT
+);
+
+1770 i(
+bp
+ =
+NULL
+)
+
+1771 
+	`nic
+("bpfattach");
+
+1773 
+bp
+->
+bif_dli
+ = 
+NULL
+;
+
+1774 
+bp
+->
+bif_drivp
+ = 
+drivp
+;
+
+1775 
+bp
+->
+bif_i
+ = 
+i
+;
+
+1776 
+bp
+->
+bif_d
+ = 
+d
+;
+
+1778 
+bp
+->
+bif_xt
+ = 
+bpf_ii
+;
+
+1779 
+bpf_ii
+ = 
+bp
+;
+
+1781 *
+bp
+->
+bif_drivp
+ = 
+NULL
+;
+
+1783 
+bp
+->
+bif_hd
+ = 
+hd
+;
+
+1785 
+	`tf
+("bpf: %ched\n", 
+i
+->
+if_xme
+);
+
+1787 
+	}
+}
+
+1793 
+	$_bpfdach
+(
+i
+ *
+i
+)
+
+1795 
+bpf_if
+ *
+bp
+, **
+pbp
+;
+
+1796 
+bpf_d
+ *
+d
+;
+
+1797 
+s
+;
+
+1800 
+	`LIST_FOREACH
+(
+d
+, &
+bpf_li
+, 
+bd_li
+) {
+
+1801 i(
+d
+->
+bd_bif
+ !
+NULL
+ && d->bd_bif->
+bif_i
+ =
+i
+) {
+
+1806 
+s
+ = 
+	`
+();
+
+1807 
+d
+->
+bd_omisc
+ = 0;
+
+1808 
+	`bpf_dachd
+(
+d
+);
+
+1809 
+	`lx
+(
+s
+);
+
+1813 
+aga
+:
+
+1814 
+bp
+ = 
+bpf_ii
+, 
+pbp
+ = &bpf_iflist;
+
+1815 
+bp
+ !
+NULL
+; 
+pbp
+ = &bp->
+bif_xt
+, bp = bp->bif_next) {
+
+1816 i(
+bp
+->
+bif_i
+ =
+i
+) {
+
+1817 *
+pbp
+ = 
+bp
+->
+bif_xt
+;
+
+1818 
+	`
+(
+bp
+, 
+M_DEVBUF
+);
+
+1819 
+aga
+;
+
+1822 
+	}
+}
+
+1828 
+	$_bpf_chge_ty
+(
+i
+ *
+i
+, 
+u_t
+ 
+d
+, u_
+hd
+)
+
+1830 
+bpf_if
+ *
+bp
+;
+
+1832 
+bp
+ = 
+bpf_ii
+; b!
+NULL
+; bbp->
+bif_xt
+) {
+
+1833 i(
+bp
+->
+bif_drivp
+ =&
+i
+->
+if_bpf
+)
+
+1836 i(
+bp
+ =
+NULL
+)
+
+1837 
+	`nic
+("bpf_change_type");
+
+1839 
+bp
+->
+bif_d
+ = 
+d
+;
+
+1841 
+bp
+->
+bif_hd
+ = 
+hd
+;
+
+1842 
+	}
+}
+
+1848 
+	$bpf_gdli
+(
+bpf_d
+ *
+d
+, 
+bpf_dli
+ *
+b
+)
+
+1850 
+n
+, 
+r
+;
+
+1851 
+i
+ *
+i
+;
+
+1852 
+bpf_if
+ *
+bp
+;
+
+1854 
+i
+ = 
+d
+->
+bd_bif
+->
+bif_i
+;
+
+1855 
+n
+ = 0;
+
+1856 
+r
+ = 0;
+
+1857 
+bp
+ = 
+bpf_ii
+; b!
+NULL
+; bbp->
+bif_xt
+) {
+
+1858 i(
+bp
+->
+bif_i
+ !
+i
+)
+
+1860 i(
+b
+->
+b_li
+ !
+NULL
+) {
+
+1861 i(
+n
+ >
+b
+->
+b_n
+)
+
+1862  
+ENOMEM
+;
+
+1863 
+r
+ = 
+	`cyout
+(&
+bp
+->
+bif_d
+,
+
+1864 
+b
+->
+b_li
+ + 
+n
+, (
+u_t
+));
+
+1866 
+n
+++;
+
+1868 
+b
+->
+b_n
+ = 
+n
+;
+
+1869  
+r
+;
+
+1870 
+	}
+}
+
+1876 
+	$bpf_td
+(
+bpf_d
+ *
+d
+, 
+u_t
+ 
+d
+)
+
+1878 
+s
+, 
+r
+, 
+romisc
+;
+
+1879 
+i
+ *
+i
+;
+
+1880 
+bpf_if
+ *
+bp
+;
+
+1882 i(
+d
+->
+bd_bif
+->
+bif_d
+ =
+d
+)
+
+1884 
+i
+ = 
+d
+->
+bd_bif
+->
+bif_i
+;
+
+1885 
+bp
+ = 
+bpf_ii
+; b!
+NULL
+; bbp->
+bif_xt
+) {
+
+1886 i(
+bp
+->
+bif_i
+ =
+i
+ && bp->
+bif_d
+ =
+d
+)
+
+1889 i(
+bp
+ =
+NULL
+)
+
+1890  
+EINVAL
+;
+
+1891 
+s
+ = 
+	`
+();
+
+1892 
+romisc
+ = 
+d
+->
+bd_omisc
+;
+
+1893 
+	`bpf_dachd
+(
+d
+);
+
+1894 
+	`bpf_chd
+(
+d
+, 
+bp
+);
+
+1895 
+	`t_d
+(
+d
+);
+
+1896 i(
+romisc
+) {
+
+1897 
+r
+ = 
+	`iromisc
+(
+bp
+->
+bif_i
+, 1);
+
+1898 i(
+r
+)
+
+1899 
+	`tf
+("%s: bpf_setdlt: ifpromisc failed (%d)\n",
+
+1900 
+bp
+->
+bif_i
+->
+if_xme
+, 
+r
+);
+
+1902 
+d
+->
+bd_omisc
+ = 1;
+
+1904 
+	`lx
+(
+s
+);
+
+1906 
+	}
+}
+
+1909 
+	$sysl_t_bpf_maxbufsize
+(
+SYSCTLFN_ARGS
+)
+
+1911 
+wsize
+, 
+r
+;
+
+1912 
+sysode
+ 
+node
+;
+
+1914 
+node
+ = *
+ode
+;
+
+1915 
+node
+.
+sysl_da
+ = &
+wsize
+;
+
+1916 
+wsize
+ = 
+bpf_maxbufsize
+;
+
+1917 
+r
+ = 
+	`sysl_lookup
+(
+	`SYSCTLFN_CALL
+(&
+node
+));
+
+1918 i(
+r
+ || 
+wp
+ =
+NULL
+)
+
+1919  (
+r
+);
+
+1921 i(
+wsize
+ < 
+BPF_MINBUFSIZE
+ ||ewsiz> 
+BPF_MAXBUFSIZE
+)
+
+1922  (
+EINVAL
+);
+
+1924 
+bpf_maxbufsize
+ = 
+wsize
+;
+
+1927 
+	}
+}
+
+1929 #i
+defed
+(
+MODULAR
+|| defed(
+BPFJIT
+)
+
+1931 
+	$sysl_t_bpf_j
+(
+SYSCTLFN_ARGS
+)
+
+1933 
+bo
+ 
+wv
+;
+
+1934 
+r
+;
+
+1935 
+sysode
+ 
+node
+;
+
+1937 
+node
+ = *
+ode
+;
+
+1938 
+node
+.
+sysl_da
+ = &
+wv
+;
+
+1939 
+wv
+ = 
+bpf_j
+;
+
+1940 
+r
+ = 
+	`sysl_lookup
+(
+	`SYSCTLFN_CALL
+(&
+node
+));
+
+1941 i(
+r
+ !0 || 
+wp
+ =
+NULL
+)
+
+1942  
+r
+;
+
+1944 
+bpf_j
+ = 
+wv
+;
+
+1950 
+	`memb_sync
+();
+
+1952 i(
+wv
+ && 
+bpfj_modu_s
+.
+bj_ge_code
+ =
+NULL
+) {
+
+1953 
+	`tf
+("JIT compilation isostponed "
+
+1958 
+	}
+}
+
+1962 
+	$sysl_t_bpf_s
+(
+SYSCTLFN_ARGS
+)
+
+1964 
+r
+, 
+em_cou
+;
+
+1965 
+bpf_d
+ *
+dp
+;
+
+1966 
+bpf_d_ext
+ 
+d
+;
+
+1967 
+size_t
+ 
+n
+, 
+eded
+, 
+em_size
+, 
+out_size
+;
+
+1968 *
+
+;
+
+1970 i(
+m
+ =1 && 
+me
+[0] =
+CTL_QUERY
+)
+
+1971  (
+	`sysl_quy
+(
+	`SYSCTLFN_CALL
+(
+ode
+)));
+
+1973 i(
+m
+ != 2)
+
+1974  (
+EINVAL
+);
+
+1977 
+r
+ = 
+	`kauth_authize_twk
+(
+l
+->
+l_ed
+, 
+KAUTH_NETWORK_INTERFACE
+,
+
+1978 
+KAUTH_REQ_NETWORK_INTERFACE_GETPRIV
+, 
+NULL
+, NULL, NULL);
+
+1979 i(
+r
+)
+
+1980  (
+EPERM
+);
+
+1982 
+n
+ = (
+dp
+ !
+NULL
+? *
+d
+ : 0;
+
+1983 
+
+ = 
+dp
+;
+
+1984 
+em_size
+ = 
+me
+[0];
+
+1985 
+em_cou
+ = 
+me
+[1];
+
+1986 
+out_size
+ = 
+	`MIN
+((
+d
+), 
+em_size
+);
+
+1987 
+eded
+ = 0;
+
+1989 i(
+em_size
+ < 1 || 
+em_cou
+ < 0)
+
+1990  (
+EINVAL
+);
+
+1992 
+	`mux_r
+(&
+bpf_mtx
+);
+
+1993 
+	`LIST_FOREACH
+(
+dp
+, &
+bpf_li
+, 
+bd_li
+) {
+
+1994 i(
+n
+ >
+em_size
+ && 
+em_cou
+ > 0) {
+
+1995 
+	#BPF_EXT
+(
+fld
+
+d
+.
+bde_
+ ## fld = 
+dp
+->
+bd_
+ ## 
+	)
+field
+
+1996 
+	`BPF_EXT
+(
+bufsize
+);
+
+1997 
+	`BPF_EXT
+(
+omisc
+);
+
+1998 
+	`BPF_EXT
+(
+e
+);
+
+1999 
+	`BPF_EXT
+(
+immed
+);
+
+2000 
+	`BPF_EXT
+(
+hdrcmt
+);
+
+2001 
+	`BPF_EXT
+(
+e
+);
+
+2002 
+	`BPF_EXT
+(
+pid
+);
+
+2003 
+	`BPF_EXT
+(
+rcou
+);
+
+2004 
+	`BPF_EXT
+(
+dcou
+);
+
+2005 
+	`BPF_EXT
+(
+ccou
+);
+
+2006 #unde
+BPF_EXT
+
+
+2007 i(
+dp
+->
+bd_bif
+)
+
+2008 ()
+	`y
+(
+d
+.
+bde_iame
+,
+
+2009 
+dp
+->
+bd_bif
+->
+bif_i
+->
+if_xme
+,
+
+2010 
+IFNAMSIZ
+ - 1);
+
+2012 
+d
+.
+bde_iame
+[0] = '\0';
+
+2014 
+r
+ = 
+	`cyout
+(&
+d
+, 
+
+, 
+out_size
+);
+
+2015 i(
+r
+)
+
+2017 
+
+ +
+em_size
+;
+
+2018 
+n
+ -
+em_size
+;
+
+2020 
+eded
+ +
+em_size
+;
+
+2021 i(
+em_cou
+ > 0 &&m_cou !
+INT_MAX
+)
+
+2022 
+em_cou
+--;
+
+2024 
+	`mux_ex
+(&
+bpf_mtx
+);
+
+2026 *
+d
+ = 
+eded
+;
+
+2028  (
+r
+);
+
+2029 
+	}
+}
+
+2031 
+sysog
+ *
+	gbpf_sysog
+;
+
+2033 
+	$sysl_t_bpf_tup
+()
+
+2035 c 
+sysode
+ *
+node
+;
+
+2037 
+node
+ = 
+NULL
+;
+
+2038 
+	`sysl_v
+(&
+bpf_sysog
+, 0, 
+NULL
+, &
+node
+,
+
+2039 
+CTLFLAG_PERMANENT
+,
+
+2040 
+CTLTYPE_NODE
+, "bpf",
+
+2041 
+	`SYSCTL_DESCR
+("BPF options"),
+
+2042 
+NULL
+, 0, NULL, 0,
+
+2043 
+CTL_NET
+, 
+CTL_CREATE
+, 
+CTL_EOL
+);
+
+2044 i(
+node
+ !
+NULL
+) {
+
+2045 #i
+	`defed
+(
+MODULAR
+|| defed(
+BPFJIT
+)
+
+2046 
+	`sysl_v
+(&
+bpf_sysog
+, 0, 
+NULL
+, NULL,
+
+2047 
+CTLFLAG_PERMANENT
+|
+CTLFLAG_READWRITE
+,
+
+2048 
+CTLTYPE_BOOL
+, "jit",
+
+2049 
+	`SYSCTL_DESCR
+("Toggle Just-In-Time compilation"),
+
+2050 
+sysl_t_bpf_j
+, 0, &
+bpf_j
+, 0,
+
+2051 
+CTL_NET
+, 
+node
+->
+sysl_num
+, 
+CTL_CREATE
+, 
+CTL_EOL
+);
+
+2053 
+	`sysl_v
+(&
+bpf_sysog
+, 0, 
+NULL
+, NULL,
+
+2054 
+CTLFLAG_PERMANENT
+|
+CTLFLAG_READWRITE
+,
+
+2055 
+CTLTYPE_INT
+, "maxbufsize",
+
+2056 
+	`SYSCTL_DESCR
+("Maximum size for data capture buffer"),
+
+2057 
+sysl_t_bpf_maxbufsize
+, 0, &
+bpf_maxbufsize
+, 0,
+
+2058 
+CTL_NET
+, 
+node
+->
+sysl_num
+, 
+CTL_CREATE
+, 
+CTL_EOL
+);
+
+2059 
+	`sysl_v
+(&
+bpf_sysog
+, 0, 
+NULL
+, NULL,
+
+2060 
+CTLFLAG_PERMANENT
+,
+
+2061 
+CTLTYPE_STRUCT
+, "stats",
+
+2062 
+	`SYSCTL_DESCR
+("BPF stats"),
+
+2063 
+NULL
+, 0, &
+bpf_gs
+, (bpf_gstats),
+
+2064 
+CTL_NET
+, 
+node
+->
+sysl_num
+, 
+CTL_CREATE
+, 
+CTL_EOL
+);
+
+2065 
+	`sysl_v
+(&
+bpf_sysog
+, 0, 
+NULL
+, NULL,
+
+2066 
+CTLFLAG_PERMANENT
+,
+
+2067 
+CTLTYPE_STRUCT
+, "peers",
+
+2068 
+	`SYSCTL_DESCR
+("BPFeers"),
+
+2069 
+sysl_t_bpf_s
+, 0, 
+NULL
+, 0,
+
+2070 
+CTL_NET
+, 
+node
+->
+sysl_num
+, 
+CTL_CREATE
+, 
+CTL_EOL
+);
+
+2073 
+	}
+}
+
+2075 
+bpf_s
+ 
+	gbpf_s_kl
+ = {
+
+2076 .
+bpf_ch
+ = 
+_bpach
+,
+
+2077 .
+	gbpf_dach
+ = 
+_bpfdach
+,
+
+2078 .
+	gbpf_chge_ty
+ = 
+_bpf_chge_ty
+,
+
+2080 .
+	gbpf_p
+ = 
+_bpf_p
+,
+
+2081 .
+	gbpf_mp
+ = 
+_bpf_mp
+,
+
+2082 .
+	gbpf_mp2
+ = 
+_bpf_mp2
+,
+
+2083 .
+	gbpf_mp_af
+ = 
+_bpf_mp_af
+,
+
+2084 .
+	gbpf_mp__
+ = 
+_bpf_mp__
+,
+
+2085 .
+	gbpf_mp__out
+ = 
+_bpf_mp__out
+,
+
+2088 
+MODULE
+(
+MODULE_CLASS_DRIVER
+, 
+bpf
+, 
+NULL
+);
+
+2091 
+	$bpf_modcmd
+(
+modcmd_t
+ 
+cmd
+, *
+g
+)
+
+2093 
+devmaj_t
+ 
+bmaj
+, 
+cmaj
+;
+
+2094 
+r
+;
+
+2096 
+bmaj
+ = 
+cmaj
+ = 
+NODEVMAJOR
+;
+
+2098 
+cmd
+) {
+
+2099 
+MODULE_CMD_INIT
+:
+
+2100 
+	`bpfach
+(0);
+
+2101 
+r
+ = 
+	`devsw_ch
+("bpf", 
+NULL
+, &
+bmaj
+,
+
+2102 &
+bpf_cdevsw
+, &
+cmaj
+);
+
+2103 i(
+r
+ =
+EEXIST
+)
+
+2104 
+r
+ = 0;
+
+2105 i(
+r
+)
+
+2108 
+	`bpf_s_hdov_r
+(&
+bpf_s_kl
+);
+
+2109 
+	`omic_sw_r
+(&
+bpf_s
+, &
+bpf_s_kl
+);
+
+2110 
+	`bpf_s_hdov_ex
+();
+
+2111 
+	`sysl_t_bpf_tup
+();
+
+2114 
+MODULE_CMD_FINI
+:
+
+2135 
+r
+ = 
+EOPNOTSUPP
+;
+
+2140 
+r
+ = 
+ENOTTY
+;
+
+2144  
+r
+;
+
+2145 
+	}
+}
+
+	@bpf.h
+
+40 #ide
+_NET_BPF_H_
+
+
+41 
+	#_NET_BPF_H_
+
+
+	)
+
+43 
+	~<sys/time.h
+>
+
+46 
+	#BPF_RELEASE
+ 199606
+
+	)
+
+49 
+	#BPF_COP_EXTMEM_RELEASE
+ 20140624
+
+	)
+
+51 
+__BEGIN_DECLS
+
+
+53 
+	tbpf_t32
+;
+
+54 
+u_t
+ 
+	tbpf_u_t32
+;
+
+60 
+	#BPF_ALIGNMENT
+ ()
+
+	)
+
+61 
+	#BPF_ALIGNMENT32
+ ()
+
+	)
+
+63 
+	#BPF_WORDALIGN
+(
+x
+(((x)+(
+BPF_ALIGNMENT
+-1))&~(BPF_ALIGNMENT-1))
+
+	)
+
+64 
+	#BPF_WORDALIGN32
+(
+x
+(((x)+(
+BPF_ALIGNMENT32
+-1))&~(BPF_ALIGNMENT32-1))
+
+	)
+
+66 
+	#BPF_MAXINSNS
+ 512
+
+	)
+
+67 
+	#BPF_DFLTBUFSIZE
+ (1024*1024
+
+	)
+
+68 
+	#BPF_MAXBUFSIZE
+ (1024*1024*16
+
+	)
+
+69 
+	#BPF_MINBUFSIZE
+ 32
+
+	)
+
+74 
+	sbpf_ogm
+ {
+
+75 
+u_t
+ 
+	mbf_n
+;
+
+76 
+bpf_
+ *
+	mbf_s
+;
+
+82 
+	sbpf_
+ {
+
+83 
+ut64_t
+ 
+	mbs_cv
+;
+
+84 
+ut64_t
+ 
+	mbs_dr
+;
+
+85 
+ut64_t
+ 
+	mbs_
+;
+
+86 
+ut64_t
+ 
+	mbs_ddg
+[13];
+
+92 
+	sbpf__d
+ {
+
+93 
+u_t
+ 
+	mbs_cv
+;
+
+94 
+u_t
+ 
+	mbs_dr
+;
+
+108 
+	sbpf_vsi
+ {
+
+109 
+u_sht
+ 
+	mbv_maj
+;
+
+110 
+u_sht
+ 
+	mbv_m
+;
+
+113 
+	#BPF_MAJOR_VERSION
+ 1
+
+	)
+
+114 
+	#BPF_MINOR_VERSION
+ 1
+
+	)
+
+123 
+	#BIOCGBLEN
+ 
+	`_IOR
+('B',102, 
+u_t
+)
+
+	)
+
+124 
+	#BIOCSBLEN
+ 
+	`_IOWR
+('B',102, 
+u_t
+)
+
+	)
+
+125 
+	#BIOCSETF
+ 
+	`_IOW
+('B',103, 
+bpf_ogm
+)
+
+	)
+
+126 
+	#BIOCFLUSH
+ 
+	`_IO
+('B',104)
+
+	)
+
+127 
+	#BIOCPROMISC
+ 
+	`_IO
+('B',105)
+
+	)
+
+128 
+	#BIOCGDLT
+ 
+	`_IOR
+('B',106, 
+u_t
+)
+
+	)
+
+129 
+	#BIOCGETIF
+ 
+	`_IOR
+('B',107, 
+ieq
+)
+
+	)
+
+130 
+	#BIOCSETIF
+ 
+	`_IOW
+('B',108, 
+ieq
+)
+
+	)
+
+131 #ifde
+COMPAT_50
+
+
+132 
+	~<comt/sys/time.h
+>
+
+133 
+	#BIOCSORTIMEOUT
+ 
+	`_IOW
+('B',109, 
+timev50
+)
+
+	)
+
+134 
+	#BIOCGORTIMEOUT
+ 
+	`_IOR
+('B',110, 
+timev50
+)
+
+	)
+
+136 
+	#BIOCGSTATS
+ 
+	`_IOR
+('B',111, 
+bpf_
+)
+
+	)
+
+137 
+	#BIOCGSTATSOLD
+ 
+	`_IOR
+('B',111, 
+bpf__d
+)
+
+	)
+
+138 
+	#BIOCIMMEDIATE
+ 
+	`_IOW
+('B',112, 
+u_t
+)
+
+	)
+
+139 
+	#BIOCVERSION
+ 
+	`_IOR
+('B',113, 
+bpf_vsi
+)
+
+	)
+
+140 
+	#BIOCSTCPF
+ 
+	`_IOW
+('B',114, 
+bpf_ogm
+)
+
+	)
+
+141 
+	#BIOCSUDPF
+ 
+	`_IOW
+('B',115, 
+bpf_ogm
+)
+
+	)
+
+142 
+	#BIOCGHDRCMPLT
+ 
+	`_IOR
+('B',116, 
+u_t
+)
+
+	)
+
+143 
+	#BIOCSHDRCMPLT
+ 
+	`_IOW
+('B',117, 
+u_t
+)
+
+	)
+
+144 
+	#BIOCSDLT
+ 
+	`_IOW
+('B',118, 
+u_t
+)
+
+	)
+
+145 
+	#BIOCGDLTLIST
+ 
+	`_IOWR
+('B',119, 
+bpf_dli
+)
+
+	)
+
+146 
+	#BIOCGSEESENT
+ 
+	`_IOR
+('B',120, 
+u_t
+)
+
+	)
+
+147 
+	#BIOCSSEESENT
+ 
+	`_IOW
+('B',121, 
+u_t
+)
+
+	)
+
+148 
+	#BIOCSRTIMEOUT
+ 
+	`_IOW
+('B',122, 
+timev
+)
+
+	)
+
+149 
+	#BIOCGRTIMEOUT
+ 
+	`_IOR
+('B',123, 
+timev
+)
+
+	)
+
+150 
+	#BIOCGFEEDBACK
+ 
+	`_IOR
+('B',124, 
+u_t
+)
+
+	)
+
+151 
+	#BIOCSFEEDBACK
+ 
+	`_IOW
+('B',125, 
+u_t
+)
+
+	)
+
+152 
+	#BIOCFEEDBACK
+ 
+BIOCSFEEDBACK
+
+
+	)
+
+158 
+	sbpf_timev
+ {
+
+159 
+	mtv_c
+;
+
+160 
+	mtv_uc
+;
+
+163 
+	sbpf_timev32
+ {
+
+164 
+t32_t
+ 
+	mtv_c
+;
+
+165 
+t32_t
+ 
+	mtv_uc
+;
+
+168 
+	sbpf_hdr
+ {
+
+169 
+bpf_timev
+ 
+	mbh_tamp
+;
+
+170 
+ut32_t
+ 
+	mbh_
+;
+
+171 
+ut32_t
+ 
+	mbh_d
+;
+
+172 
+ut16_t
+ 
+	mbh_hd
+;
+
+176 
+	sbpf_hdr32
+ {
+
+177 
+bpf_timev32
+ 
+	mbh_tamp
+;
+
+178 
+ut32_t
+ 
+	mbh_
+;
+
+179 
+ut32_t
+ 
+	mbh_d
+;
+
+180 
+ut16_t
+ 
+	mbh_hd
+;
+
+191 #ifde
+_KERNEL
+
+
+192 #i
+defed
+(
+__m32__
+|| defed(
+__i386__
+|| defed(
+__m68k__
+) || \
+
+193 
+defed
+(
+__ms__
+|| defed(
+__ns32k__
+|| defed(
+__vax__
+) || \
+
+194 
+defed
+(
+__sh__
+|| (defed(
+__c__
+&& !
+	$defed
+(
+__c64__
+))
+
+195 
+	#SIZEOF_BPF_HDR
+ 18
+
+	)
+
+196 
+	#SIZEOF_BPF_HDR32
+ 18
+
+	)
+
+198 
+	#SIZEOF_BPF_HDR
+ (
+bpf_hdr
+)
+
+	)
+
+199 
+	#SIZEOF_BPF_HDR32
+ (
+bpf_hdr32
+)
+
+	)
+
+204 
+	~<t/d.h
+>
+
+210 
+	#BPF_CLASS
+(
+code
+((code& 0x07)
+
+	)
+
+211 
+	#BPF_LD
+ 0x00
+
+	)
+
+212 
+	#BPF_LDX
+ 0x01
+
+	)
+
+213 
+	#BPF_ST
+ 0x02
+
+	)
+
+214 
+	#BPF_STX
+ 0x03
+
+	)
+
+215 
+	#BPF_ALU
+ 0x04
+
+	)
+
+216 
+	#BPF_JMP
+ 0x05
+
+	)
+
+217 
+	#BPF_RET
+ 0x06
+
+	)
+
+218 
+	#BPF_MISC
+ 0x07
+
+	)
+
+221 
+	#BPF_SIZE
+(
+code
+((code& 0x18)
+
+	)
+
+222 
+	#BPF_W
+ 0x00
+
+	)
+
+223 
+	#BPF_H
+ 0x08
+
+	)
+
+224 
+	#BPF_B
+ 0x10
+
+	)
+
+226 
+	#BPF_MODE
+(
+code
+((code& 0xe0)
+
+	)
+
+227 
+	#BPF_IMM
+ 0x00
+
+	)
+
+228 
+	#BPF_ABS
+ 0x20
+
+	)
+
+229 
+	#BPF_IND
+ 0x40
+
+	)
+
+230 
+	#BPF_MEM
+ 0x60
+
+	)
+
+231 
+	#BPF_LEN
+ 0x80
+
+	)
+
+232 
+	#BPF_MSH
+ 0xa0
+
+	)
+
+237 
+	#BPF_OP
+(
+code
+((code& 0xf0)
+
+	)
+
+238 
+	#BPF_ADD
+ 0x00
+
+	)
+
+239 
+	#BPF_SUB
+ 0x10
+
+	)
+
+240 
+	#BPF_MUL
+ 0x20
+
+	)
+
+241 
+	#BPF_DIV
+ 0x30
+
+	)
+
+242 
+	#BPF_OR
+ 0x40
+
+	)
+
+243 
+	#BPF_AND
+ 0x50
+
+	)
+
+244 
+	#BPF_LSH
+ 0x60
+
+	)
+
+245 
+	#BPF_RSH
+ 0x70
+
+	)
+
+246 
+	#BPF_NEG
+ 0x80
+
+	)
+
+247 
+	#BPF_MOD
+ 0x90
+
+	)
+
+248 
+	#BPF_XOR
+ 0xa0
+
+	)
+
+254 
+	#BPF_JA
+ 0x00
+
+	)
+
+255 
+	#BPF_JEQ
+ 0x10
+
+	)
+
+256 
+	#BPF_JGT
+ 0x20
+
+	)
+
+257 
+	#BPF_JGE
+ 0x30
+
+	)
+
+258 
+	#BPF_JSET
+ 0x40
+
+	)
+
+270 
+	#BPF_SRC
+(
+code
+((code& 0x08)
+
+	)
+
+271 
+	#BPF_K
+ 0x00
+
+	)
+
+272 
+	#BPF_X
+ 0x08
+
+	)
+
+275 
+	#BPF_RVAL
+(
+code
+((code& 0x18)
+
+	)
+
+276 
+	#BPF_A
+ 0x10
+
+	)
+
+280 
+	#BPF_MISCOP
+(
+code
+((code& 0xf8)
+
+	)
+
+281 
+	#BPF_TAX
+ 0x00
+
+	)
+
+284 
+	#BPF_COP
+ 0x20
+
+	)
+
+288 
+	#BPF_COPX
+ 0x40
+
+	)
+
+296 
+	#BPF_TXA
+ 0x80
+
+	)
+
+316 
+	sbpf_
+ {
+
+317 
+ut16_t
+ 
+code
+;
+
+318 
+u_ch
+ 
+jt
+;
+
+319 
+u_ch
+ 
+jf
+;
+
+320 
+ut32_t
+ 
+k
+;
+
+326 
+	#BPF_STMT
+(
+code
+, 
+k
+{ (
+ut16_t
+)(code), 0, 0, k 
+	}
+
+	)
+}
+
+327 
+	#BPF_JUMP
+(
+code
+, 
+k
+, 
+jt
+, 
+jf
+{ (
+ut16_t
+)(code), jt, jf, k }
+
+	)
+
+332 
+	#BPF_MEMWORDS
+ 16
+
+	)
+
+338 
+ut32_t
+ 
+	tbpf_memwd__t
+;
+
+339 
+	#BPF_MEMWORD_INIT
+(
+k
+(
+	`UINT32_C
+(1<< (k))
+
+	)
+
+342 
+__CTASSERT
+(
+BPF_MEMWORDS
+ + 2 <(
+bpf_memwd__t
+* 
+NBBY
+);
+
+344 #ifde
+_KERNEL
+
+
+348 
+	#BPF_MAX_MEMWORDS
+ 30
+
+	)
+
+350 
+__CTASSERT
+(
+BPF_MAX_MEMWORDS
+ >
+BPF_MEMWORDS
+);
+
+351 
+__CTASSERT
+(
+BPF_MAX_MEMWORDS
+ + 2 <(
+bpf_memwd__t
+* 
+NBBY
+);
+
+357 
+	sbpf_dli
+ {
+
+358 
+u_t
+ 
+	mb_n
+;
+
+359 
+u_t
+ *
+	mb_li
+;
+
+362 
+	gbpf_x
+;
+
+363 
+bpf_x
+ 
+	tbpf_x_t
+;
+
+365 
+	sbpf_gs
+ {
+
+366 c 
+ut8_t
+ * 
+	mpkt
+;
+
+367 
+size_t
+ 
+	mw
+;
+
+368 
+size_t
+ 
+	mbu
+;
+
+377 
+ut32_t
+ * 
+	mmem
+;
+
+378 * 
+	mg
+;
+
+379 } 
+	tbpf_gs_t
+;
+
+381 #i
+defed
+(
+_KERNEL
+|| defed(
+__BPF_PRIVATE
+)
+
+383 
+	$ut32_t
+ (*
+	tbpf_cfunc_t
+)(c 
+	tbpf_x_t
+ *, 
+	tbpf_gs_t
+ *, 
+	tut32_t
+);
+
+385 
+	sbpf_x
+ {
+
+389 c 
+bpf_cfunc_t
+ * 
+cfuncs
+;
+
+390 
+size_t
+ 
+nfuncs
+;
+
+398 
+size_t
+ 
+extwds
+;
+
+404 
+bpf_memwd__t
+ 
+eed
+;
+
+408 #ifde
+_KERNEL
+
+
+409 
+	~<t/bpfj.h
+>
+
+410 
+	~<t/if.h
+>
+
+412 
+bpf_if
+;
+
+414 
+	sbpf_s
+ {
+
+415 (*
+bpf_ch
+)(
+i
+ *, 
+u_t
+, u_t, 
+bpf_if
+ **);
+
+416 (*
+bpf_dach
+)(
+i
+ *);
+
+417 (*
+bpf_chge_ty
+)(
+i
+ *, 
+u_t
+, u_int);
+
+419 (*
+bpf_p
+)(
+bpf_if
+ *, 
+u_ch
+ *, 
+u_t
+);
+
+420 (*
+bpf_mp
+)(
+bpf_if
+ *, 
+mbuf
+ *);
+
+421 (*
+bpf_mp2
+)(
+bpf_if
+ *, *, 
+u_t
+, 
+mbuf
+ *);
+
+422 (*
+bpf_mp_af
+)(
+bpf_if
+ *, 
+ut32_t
+, 
+mbuf
+ *);
+
+423 (*
+bpf_mp__
+)(
+bpf_if
+ *, 
+u_ch
+ *, 
+mbuf
+ **);
+
+424 (*
+bpf_mp__out
+)(
+bpf_if
+ *, 
+u_ch
+ *, 
+mbuf
+ *);
+
+427 
+bpf_s
+ *bpf_ops;
+
+429 
+le
+ 
+
+430 
+	$bpf_ch
+(
+i
+ *
+_i
+, 
+u_t
+ 
+_d
+, u_
+_hd
+)
+
+432 
+bpf_s
+->
+	`bpf_ch
+(
+_i
+, 
+_d
+, 
+_hd
+, &_i->
+if_bpf
+);
+
+433 
+	}
+}
+
+435 
+le
+ 
+
+436 
+	$bpf_ch2
+(
+i
+ *
+_i
+, 
+u_t
+ 
+_d
+, u_
+_hd
+, 
+bpf_if
+ **
+_dp
+)
+
+438 
+bpf_s
+->
+	`bpf_ch
+(
+_i
+, 
+_d
+, 
+_hd
+, 
+_dp
+);
+
+439 
+	}
+}
+
+441 
+le
+ 
+
+442 
+	$bpf_p
+(
+i
+ *
+_i
+, 
+u_ch
+ *
+_pkt
+, 
+u_t
+ 
+_n
+)
+
+444 i(
+_i
+->
+if_bpf
+)
+
+445 
+bpf_s
+->
+	`bpf_p
+(
+_i
+->
+if_bpf
+, 
+_pkt
+, 
+_n
+);
+
+446 
+	}
+}
+
+448 
+le
+ 
+
+449 
+	$bpf_mp
+(
+i
+ *
+_i
+, 
+mbuf
+ *
+_m
+)
+
+451 i(
+_i
+->
+if_bpf
+)
+
+452 
+bpf_s
+->
+	`bpf_mp
+(
+_i
+->
+if_bpf
+, 
+_m
+);
+
+453 
+	}
+}
+
+455 
+le
+ 
+
+456 
+	$bpf_mp2
+(
+bpf_if
+ *
+_bpf
+, *
+_da
+, 
+u_t
+ 
+_dn
+, 
+mbuf
+ *
+_m
+)
+
+458 
+bpf_s
+->
+	`bpf_mp2
+(
+_bpf
+, 
+_da
+, 
+_dn
+, 
+_m
+);
+
+459 
+	}
+}
+
+461 
+le
+ 
+
+462 
+	$bpf_mp3
+(
+bpf_if
+ *
+_bpf
+, 
+mbuf
+ *
+_m
+)
+
+464 i(
+_bpf
+)
+
+465 
+bpf_s
+->
+	`bpf_mp
+(
+_bpf
+, 
+_m
+);
+
+466 
+	}
+}
+
+468 
+le
+ 
+
+469 
+	$bpf_mp_af
+(
+i
+ *
+_i
+, 
+ut32_t
+ 
+_af
+, 
+mbuf
+ *
+_m
+)
+
+471 i(
+_i
+->
+if_bpf
+)
+
+472 
+bpf_s
+->
+	`bpf_mp_af
+(
+_i
+->
+if_bpf
+, 
+_af
+, 
+_m
+);
+
+473 
+	}
+}
+
+475 
+le
+ 
+
+476 
+	$bpf_chge_ty
+(
+i
+ *
+_i
+, 
+u_t
+ 
+_d
+, u_
+_hd
+)
+
+478 
+bpf_s
+->
+	`bpf_chge_ty
+(
+_i
+, 
+_d
+, 
+_hd
+);
+
+479 
+	}
+}
+
+481 
+le
+ 
+
+482 
+	$bpf_dach
+(
+i
+ *
+_i
+)
+
+484 
+bpf_s
+->
+	`bpf_dach
+(
+_i
+);
+
+485 
+	}
+}
+
+487 
+le
+ 
+
+488 
+	$bpf_mp__
+(
+i
+ *
+_i
+, 
+u_ch
+ *
+_hdr
+, 
+mbuf
+ **
+_m
+)
+
+490 
+bpf_s
+->
+	`bpf_mp__
+(
+_i
+->
+if_bpf
+, 
+_hdr
+, 
+_m
+);
+
+491 
+	}
+}
+
+493 
+le
+ 
+
+494 
+	$bpf_mp__out
+(
+i
+ *
+_i
+, 
+u_ch
+ *
+_hdr
+, 
+mbuf
+ *
+_m
+)
+
+496 i(
+_i
+->
+if_bpf
+)
+
+497 
+bpf_s
+->
+	`bpf_mp__out
+(
+_i
+->
+if_bpf
+, 
+_hdr
+, 
+_m
+);
+
+498 
+	}
+}
+
+501 
+bpf_ts
+();
+
+503 
+bpf_s_hdov_r
+(
+bpf_s
+ *);
+
+504 
+bpf_s_hdov_ex
+();
+
+506 
+bpfach
+();
+
+508 
+bpf_x_t
+ *
+bpf_
+();
+
+509 
+bpf_deroy
+(
+bpf_x_t
+ *);
+
+511 
+bpf_t_c
+(
+bpf_x_t
+ *, c 
+bpf_cfunc_t
+ *, 
+size_t
+);
+
+512 
+bpf_t_extmem
+(
+bpf_x_t
+ *, 
+size_t
+, 
+bpf_memwd__t
+);
+
+513 
+u_t
+ 
+bpf_fr_ext
+(c 
+bpf_x_t
+ *, c 
+bpf_
+ *, 
+bpf_gs_t
+ *);
+
+514 
+bpf_vide_ext
+(c 
+bpf_x_t
+ *, c 
+bpf_
+ *, );
+
+516 
+bpfj_func_t
+ 
+bpf_j_ge
+(
+bpf_x_t
+ *, *, 
+size_t
+);
+
+517 
+bpf_j_code
+(
+bpfj_func_t
+);
+
+521 
+bpf_vide
+(c 
+bpf_
+ *, );
+
+522 
+u_t
+ 
+bpf_fr
+(c 
+bpf_
+ *, c 
+u_ch
+ *, u_int, u_int);
+
+524 
+	g__END_DECLS
+
+
+	@bpf_filter.c
+
+39 
+	~<sys/cdefs.h
+>
+
+40 
+__KERNEL_RCSID
+(0, "$NetBSD: bpf_filter.c,v 1.70 2015/02/11 12:53:15lnsn Exp $");
+
+43 #i!(
+defed
+(
+lt
+|| defed(
+KERNEL
+))
+
+44 c 
+	grcsid
+[] =
+
+49 
+	~<sys/m.h
+>
+
+50 
+	~<sys/time.h
+>
+
+51 
+	~<sys/kmem.h
+>
+
+52 
+	~<sys/dn.h
+>
+
+54 
+	#__BPF_PRIVATE
+
+
+	)
+
+55 
+	~<t/bpf.h
+>
+
+57 #ifde
+_KERNEL
+
+
+59 
+bpf_x_t
+ *
+
+60 
+	$bpf_
+()
+
+62  
+	`kmem_zloc
+((
+bpf_x_t
+), 
+KM_SLEEP
+);
+
+63 
+	}
+}
+
+66 
+	$bpf_deroy
+(
+bpf_x_t
+ *
+bc
+)
+
+68 
+	`kmem_
+(
+bc
+, (
+bpf_x_t
+));
+
+69 
+	}
+}
+
+72 
+	$bpf_t_c
+(
+bpf_x_t
+ *
+bc
+, c 
+bpf_cfunc_t
+ *
+funcs
+, 
+size_t
+ 
+n
+)
+
+74 
+bc
+->
+cfuncs
+ = 
+funcs
+;
+
+75 
+bc
+->
+nfuncs
+ = 
+n
+;
+
+77 
+	}
+}
+
+80 
+	$bpf_t_extmem
+(
+bpf_x_t
+ *
+bc
+, 
+size_t
+ 
+nwds
+, 
+bpf_memwd__t
+ 
+eed
+)
+
+82 i(
+nwds
+ > 
+BPF_MAX_MEMWORDS
+ || (
+eed
+ >>words) != 0) {
+
+83  
+EINVAL
+;
+
+85 
+bc
+->
+extwds
+ = 
+nwds
+;
+
+86 
+bc
+->
+eed
+ =reinited;
+
+88 
+	}
+}
+
+92 
+	#EXTRACT_SHORT
+(
+p
+
+	`be16dec
+)
+
+	)
+
+93 
+	#EXTRACT_LONG
+(
+p
+
+	`be32dec
+)
+
+	)
+
+95 #ifde
+_KERNEL
+
+
+96 
+	~<sys/mbuf.h
+>
+
+97 
+	#MINDEX
+(
+n
+, 
+m
+, 
+k
+) \
+
+99 
+n
+ = 
+m
+->
+m_n
+; \
+
+100 
+k
+ >
+n
+) { \
+
+101 
+k
+ -
+n
+; \
+
+102 
+m
+ = m->
+m_xt
+; \
+
+103 i(
+m
+ == 0) \
+
+105 
+n
+ = 
+m
+->
+m_n
+; \
+
+107 }
+
+	)
+
+109 
+ut32_t
+ 
+m_xwd
+(c 
+mbuf
+ *, uint32_t, *);
+
+110 
+ut32_t
+ 
+m_xhf
+(c 
+mbuf
+ *, uint32_t, *);
+
+111 
+ut32_t
+ 
+m_xby
+(c 
+mbuf
+ *, uint32_t, *);
+
+113 
+	#xwd
+(
+p
+, 
+k
+, 
+r
+
+	`m_xwd
+((c 
+mbuf
+ *)), (k), (r))
+
+	)
+
+114 
+	#xhf
+(
+p
+, 
+k
+, 
+r
+
+	`m_xhf
+((c 
+mbuf
+ *)), (k), (r))
+
+	)
+
+115 
+	#xby
+(
+p
+, 
+k
+, 
+r
+
+	`m_xby
+((c 
+mbuf
+ *)), (k), (r))
+
+	)
+
+117 
+ut32_t
+
+
+118 
+	$m_xwd
+(c 
+mbuf
+ *
+m
+, 
+ut32_t
+ 
+k
+, *
+r
+)
+
+120 
+n
+;
+
+121 
+u_ch
+ *
+
+, *
+
+;
+
+122 
+mbuf
+ *
+m0
+;
+
+124 *
+r
+ = 1;
+
+125 
+	`MINDEX
+(
+n
+, 
+m
+, 
+k
+);
+
+126 
+
+ = 
+	`mtod
+(
+m
+, 
+u_ch
+ *+ 
+k
+;
+
+127 i(
+n
+ - 
+k
+ >= 4) {
+
+128 *
+r
+ = 0;
+
+129  
+	`EXTRACT_LONG
+(
+
+);
+
+131 
+m0
+ = 
+m
+->
+m_xt
+;
+
+132 i(
+m0
+ =0 || (
+n
+ - 
+k
++ m0->
+m_n
+ < 4)
+
+134 *
+r
+ = 0;
+
+135 
+
+ = 
+	`mtod
+(
+m0
+, 
+u_ch
+ *);
+
+137 
+n
+ - 
+k
+) {
+
+139  (
+
+[0] << 24| (
+
+[0] << 16) | (np[1] << 8) |p[2];
+
+141  (
+
+[0] << 24| ([1] << 16| (
+
+[0] << 8) |p[1];
+
+143  (
+
+[0] << 24| ([1] << 16| ([2] << 8| 
+
+[0];
+
+145 
+	}
+}
+
+147 
+ut32_t
+
+
+148 
+	$m_xhf
+(c 
+mbuf
+ *
+m
+, 
+ut32_t
+ 
+k
+, *
+r
+)
+
+150 
+n
+;
+
+151 
+u_ch
+ *
+
+;
+
+152 
+mbuf
+ *
+m0
+;
+
+154 *
+r
+ = 1;
+
+155 
+	`MINDEX
+(
+n
+, 
+m
+, 
+k
+);
+
+156 
+
+ = 
+	`mtod
+(
+m
+, 
+u_ch
+ *+ 
+k
+;
+
+157 i(
+n
+ - 
+k
+ >= 2) {
+
+158 *
+r
+ = 0;
+
+159  
+	`EXTRACT_SHORT
+(
+
+);
+
+161 
+m0
+ = 
+m
+->
+m_xt
+;
+
+162 i(
+m0
+ == 0)
+
+164 *
+r
+ = 0;
+
+165  (
+
+[0] << 8| 
+	`mtod
+(
+m0
+, 
+u_ch
+ *)[0];
+
+166 
+	}
+}
+
+168 
+ut32_t
+
+
+169 
+	$m_xby
+(c 
+mbuf
+ *
+m
+, 
+ut32_t
+ 
+k
+, *
+r
+)
+
+171 
+n
+;
+
+173 *
+r
+ = 1;
+
+174 
+	`MINDEX
+(
+n
+, 
+m
+, 
+k
+);
+
+175 *
+r
+ = 0;
+
+176  
+	`mtod
+(
+m
+, 
+u_ch
+ *)[
+k
+];
+
+177 
+	}
+}
+
+179 
+	~<dlib.h
+>
+
+182 
+	~<t/bpf.h
+>
+
+189 #ifde
+_KERNEL
+
+
+191 
+u_t
+
+
+192 
+	$bpf_fr
+(c 
+bpf_
+ *
+pc
+, c 
+u_ch
+ *
+p
+, 
+u_t
+ 
+w
+,
+
+193 
+u_t
+ 
+bu
+)
+
+195 
+ut32_t
+ 
+mem
+[
+BPF_MEMWORDS
+];
+
+196 
+bpf_gs_t
+ 
+gs
+ = {
+
+197 .
+pkt
+ = 
+p
+,
+
+198 .
+w
+ = wirelen,
+
+199 .
+bu
+ = buflen,
+
+200 .
+mem
+ = mem,
+
+201 .
+g
+ = 
+NULL
+
+
+204  
+	`bpf_fr_ext
+(
+NULL
+, 
+pc
+, &
+gs
+);
+
+205 
+	}
+}
+
+207 
+u_t
+
+
+208 
+	$bpf_fr_ext
+(c 
+bpf_x_t
+ *
+bc
+, c 
+bpf_
+ *
+pc
+, 
+bpf_gs_t
+ *
+gs
+)
+
+210 
+u_t
+
+
+211 
+	$bpf_fr
+(c 
+bpf_
+ *
+pc
+, c 
+u_ch
+ *
+p
+, 
+u_t
+ 
+w
+,
+
+212 
+u_t
+ 
+bu
+)
+
+215 
+ut32_t
+ 
+A
+, 
+X
+, 
+k
+;
+
+216 #ide
+_KERNEL
+
+
+217 
+ut32_t
+ 
+mem
+[
+BPF_MEMWORDS
+];
+
+218 
+bpf_gs_t
+ 
+gs_e
+ = {
+
+219 .
+pkt
+ = 
+p
+,
+
+220 .
+w
+ = wirelen,
+
+221 .
+bu
+ = buflen,
+
+222 .
+mem
+ = mem,
+
+223 .
+g
+ = 
+NULL
+
+
+225 
+bpf_gs_t
+ * c 
+gs
+ = &
+gs_e
+;
+
+227 c 
+ut8_t
+ * c 
+p
+ = 
+gs
+->
+pkt
+;
+
+229 i(
+pc
+ == 0) {
+
+233  (
+u_t
+)-1;
+
+240 
+A
+ = 0;
+
+241 
+X
+ = 0;
+
+242 --
+pc
+;
+
+245 ++
+pc
+;
+
+246 
+pc
+->
+code
+) {
+
+249 #ifde
+_KERNEL
+
+
+252 
+	`abt
+();
+
+255 
+BPF_RET
+|
+BPF_K
+:
+
+256  (
+u_t
+)
+pc
+->
+k
+;
+
+258 
+BPF_RET
+|
+BPF_A
+:
+
+259  (
+u_t
+)
+A
+;
+
+261 
+BPF_LD
+|
+BPF_W
+|
+BPF_ABS
+:
+
+262 
+k
+ = 
+pc
+->k;
+
+263 i(
+k
+ > 
+gs
+->
+bu
+ ||
+
+264 (
+t32_t
+> 
+gs
+->
+bu
+ - 
+k
+) {
+
+265 #ifde
+_KERNEL
+
+
+266 
+mr
+;
+
+268 i(
+gs
+->
+bu
+ != 0)
+
+270 
+A
+ = 
+	`xwd
+(
+gs
+->
+pkt
+, 
+k
+, &
+mr
+);
+
+271 i(
+mr
+ != 0)
+
+278 
+A
+ = 
+	`EXTRACT_LONG
+(&
+p
+[
+k
+]);
+
+281 
+BPF_LD
+|
+BPF_H
+|
+BPF_ABS
+:
+
+282 
+k
+ = 
+pc
+->k;
+
+283 i(
+k
+ > 
+gs
+->
+bu
+ ||
+
+284 (
+t16_t
+> 
+gs
+->
+bu
+ - 
+k
+) {
+
+285 #ifde
+_KERNEL
+
+
+286 
+mr
+;
+
+288 i(
+gs
+->
+bu
+ != 0)
+
+290 
+A
+ = 
+	`xhf
+(
+gs
+->
+pkt
+, 
+k
+, &
+mr
+);
+
+291 i(
+mr
+ != 0)
+
+298 
+A
+ = 
+	`EXTRACT_SHORT
+(&
+p
+[
+k
+]);
+
+301 
+BPF_LD
+|
+BPF_B
+|
+BPF_ABS
+:
+
+302 
+k
+ = 
+pc
+->k;
+
+303 i(
+k
+ >
+gs
+->
+bu
+) {
+
+304 #ifde
+_KERNEL
+
+
+305 
+mr
+;
+
+307 i(
+gs
+->
+bu
+ != 0)
+
+309 
+A
+ = 
+	`xby
+(
+gs
+->
+pkt
+, 
+k
+, &
+mr
+);
+
+310 i(
+mr
+ != 0)
+
+317 
+A
+ = 
+p
+[
+k
+];
+
+320 
+BPF_LD
+|
+BPF_W
+|
+BPF_LEN
+:
+
+321 
+A
+ = 
+gs
+->
+w
+;
+
+324 
+BPF_LDX
+|
+BPF_W
+|
+BPF_LEN
+:
+
+325 
+X
+ = 
+gs
+->
+w
+;
+
+328 
+BPF_LD
+|
+BPF_W
+|
+BPF_IND
+:
+
+329 
+k
+ = 
+X
+ + 
+pc
+->k;
+
+330 i(
+k
+ < 
+X
+ || k >
+gs
+->
+bu
+ ||
+
+331 (
+t32_t
+> 
+gs
+->
+bu
+ - 
+k
+) {
+
+332 #ifde
+_KERNEL
+
+
+333 
+mr
+;
+
+335 i(
+k
+ < 
+X
+ || 
+gs
+->
+bu
+ != 0)
+
+337 
+A
+ = 
+	`xwd
+(
+gs
+->
+pkt
+, 
+k
+, &
+mr
+);
+
+338 i(
+mr
+ != 0)
+
+345 
+A
+ = 
+	`EXTRACT_LONG
+(&
+p
+[
+k
+]);
+
+348 
+BPF_LD
+|
+BPF_H
+|
+BPF_IND
+:
+
+349 
+k
+ = 
+X
+ + 
+pc
+->k;
+
+350 i(
+k
+ < 
+X
+ || k >
+gs
+->
+bu
+ ||
+
+351 (
+t16_t
+> 
+gs
+->
+bu
+ - 
+k
+) {
+
+352 #ifde
+_KERNEL
+
+
+353 
+mr
+;
+
+355 i(
+k
+ < 
+X
+ || 
+gs
+->
+bu
+ != 0)
+
+357 
+A
+ = 
+	`xhf
+(
+gs
+->
+pkt
+, 
+k
+, &
+mr
+);
+
+358 i(
+mr
+ != 0)
+
+365 
+A
+ = 
+	`EXTRACT_SHORT
+(&
+p
+[
+k
+]);
+
+368 
+BPF_LD
+|
+BPF_B
+|
+BPF_IND
+:
+
+369 
+k
+ = 
+X
+ + 
+pc
+->k;
+
+370 i(
+k
+ < 
+X
+ || k >
+gs
+->
+bu
+) {
+
+371 #ifde
+_KERNEL
+
+
+372 
+mr
+;
+
+374 i(
+k
+ < 
+X
+ || 
+gs
+->
+bu
+ != 0)
+
+376 
+A
+ = 
+	`xby
+(
+gs
+->
+pkt
+, 
+k
+, &
+mr
+);
+
+377 i(
+mr
+ != 0)
+
+384 
+A
+ = 
+p
+[
+k
+];
+
+387 
+BPF_LDX
+|
+BPF_MSH
+|
+BPF_B
+:
+
+388 
+k
+ = 
+pc
+->k;
+
+389 i(
+k
+ >
+gs
+->
+bu
+) {
+
+390 #ifde
+_KERNEL
+
+
+391 
+mr
+;
+
+393 i(
+gs
+->
+bu
+ != 0)
+
+395 
+X
+ = (
+	`xby
+(
+gs
+->
+pkt
+, 
+k
+, &
+mr
+) & 0xf) << 2;
+
+396 i(
+mr
+ != 0)
+
+403 
+X
+ = (
+p
+[
+pc
+->
+k
+] & 0xf) << 2;
+
+406 
+BPF_LD
+|
+BPF_IMM
+:
+
+407 
+A
+ = 
+pc
+->
+k
+;
+
+410 
+BPF_LDX
+|
+BPF_IMM
+:
+
+411 
+X
+ = 
+pc
+->
+k
+;
+
+414 
+BPF_LD
+|
+BPF_MEM
+:
+
+415 
+A
+ = 
+gs
+->
+mem
+[
+pc
+->
+k
+];
+
+418 
+BPF_LDX
+|
+BPF_MEM
+:
+
+419 
+X
+ = 
+gs
+->
+mem
+[
+pc
+->
+k
+];
+
+422 
+BPF_ST
+:
+
+423 
+gs
+->
+mem
+[
+pc
+->
+k
+] = 
+A
+;
+
+426 
+BPF_STX
+:
+
+427 
+gs
+->
+mem
+[
+pc
+->
+k
+] = 
+X
+;
+
+430 
+BPF_JMP
+|
+BPF_JA
+:
+
+431 
+pc
+ +pc->
+k
+;
+
+434 
+BPF_JMP
+|
+BPF_JGT
+|
+BPF_K
+:
+
+435 
+pc
+ +(
+A
+ >c->
+k
+?c->
+jt
+ :c->
+jf
+;
+
+438 
+BPF_JMP
+|
+BPF_JGE
+|
+BPF_K
+:
+
+439 
+pc
+ +(
+A
+ >pc->
+k
+?c->
+jt
+ :c->
+jf
+;
+
+442 
+BPF_JMP
+|
+BPF_JEQ
+|
+BPF_K
+:
+
+443 
+pc
+ +(
+A
+ =pc->
+k
+?c->
+jt
+ :c->
+jf
+;
+
+446 
+BPF_JMP
+|
+BPF_JSET
+|
+BPF_K
+:
+
+447 
+pc
+ +(
+A
+ &c->
+k
+?c->
+jt
+ :c->
+jf
+;
+
+450 
+BPF_JMP
+|
+BPF_JGT
+|
+BPF_X
+:
+
+451 
+pc
+ +(
+A
+ > 
+X
+?c->
+jt
+ :c->
+jf
+;
+
+454 
+BPF_JMP
+|
+BPF_JGE
+|
+BPF_X
+:
+
+455 
+pc
+ +(
+A
+ >
+X
+?c->
+jt
+ :c->
+jf
+;
+
+458 
+BPF_JMP
+|
+BPF_JEQ
+|
+BPF_X
+:
+
+459 
+pc
+ +(
+A
+ =
+X
+?c->
+jt
+ :c->
+jf
+;
+
+462 
+BPF_JMP
+|
+BPF_JSET
+|
+BPF_X
+:
+
+463 
+pc
+ +(
+A
+ & 
+X
+?c->
+jt
+ :c->
+jf
+;
+
+466 
+BPF_ALU
+|
+BPF_ADD
+|
+BPF_X
+:
+
+467 
+A
+ +
+X
+;
+
+470 
+BPF_ALU
+|
+BPF_SUB
+|
+BPF_X
+:
+
+471 
+A
+ -
+X
+;
+
+474 
+BPF_ALU
+|
+BPF_MUL
+|
+BPF_X
+:
+
+475 
+A
+ *
+X
+;
+
+478 
+BPF_ALU
+|
+BPF_DIV
+|
+BPF_X
+:
+
+479 i(
+X
+ == 0)
+
+481 
+A
+ /
+X
+;
+
+484 
+BPF_ALU
+|
+BPF_MOD
+|
+BPF_X
+:
+
+485 i(
+X
+ == 0)
+
+487 
+A
+ %
+X
+;
+
+490 
+BPF_ALU
+|
+BPF_AND
+|
+BPF_X
+:
+
+491 
+A
+ &
+X
+;
+
+494 
+BPF_ALU
+|
+BPF_OR
+|
+BPF_X
+:
+
+495 
+A
+ |
+X
+;
+
+498 
+BPF_ALU
+|
+BPF_XOR
+|
+BPF_X
+:
+
+499 
+A
+ ^
+X
+;
+
+502 
+BPF_ALU
+|
+BPF_LSH
+|
+BPF_X
+:
+
+503 
+A
+ <<
+X
+;
+
+506 
+BPF_ALU
+|
+BPF_RSH
+|
+BPF_X
+:
+
+507 
+A
+ >>
+X
+;
+
+510 
+BPF_ALU
+|
+BPF_ADD
+|
+BPF_K
+:
+
+511 
+A
+ +
+pc
+->
+k
+;
+
+514 
+BPF_ALU
+|
+BPF_SUB
+|
+BPF_K
+:
+
+515 
+A
+ -
+pc
+->
+k
+;
+
+518 
+BPF_ALU
+|
+BPF_MUL
+|
+BPF_K
+:
+
+519 
+A
+ *
+pc
+->
+k
+;
+
+522 
+BPF_ALU
+|
+BPF_DIV
+|
+BPF_K
+:
+
+523 
+A
+ /
+pc
+->
+k
+;
+
+526 
+BPF_ALU
+|
+BPF_MOD
+|
+BPF_K
+:
+
+527 
+A
+ %
+pc
+->
+k
+;
+
+530 
+BPF_ALU
+|
+BPF_AND
+|
+BPF_K
+:
+
+531 
+A
+ &
+pc
+->
+k
+;
+
+534 
+BPF_ALU
+|
+BPF_OR
+|
+BPF_K
+:
+
+535 
+A
+ |
+pc
+->
+k
+;
+
+538 
+BPF_ALU
+|
+BPF_XOR
+|
+BPF_K
+:
+
+539 
+A
+ ^
+pc
+->
+k
+;
+
+542 
+BPF_ALU
+|
+BPF_LSH
+|
+BPF_K
+:
+
+543 
+A
+ <<
+pc
+->
+k
+;
+
+546 
+BPF_ALU
+|
+BPF_RSH
+|
+BPF_K
+:
+
+547 
+A
+ >>
+pc
+->
+k
+;
+
+550 
+BPF_ALU
+|
+BPF_NEG
+:
+
+551 
+A
+ = -A;
+
+554 
+BPF_MISC
+|
+BPF_TAX
+:
+
+555 
+X
+ = 
+A
+;
+
+558 
+BPF_MISC
+|
+BPF_TXA
+:
+
+559 
+A
+ = 
+X
+;
+
+562 
+BPF_MISC
+|
+BPF_COP
+:
+
+563 #ifde
+_KERNEL
+
+
+564 i(
+pc
+->
+k
+ < 
+bc
+->
+nfuncs
+) {
+
+565 c 
+bpf_cfunc_t
+ 
+
+ = 
+bc
+->
+cfuncs
+[
+pc
+->
+k
+];
+
+566 
+A
+ = 
+	`
+(
+bc
+, 
+gs
+, A);
+
+572 
+BPF_MISC
+|
+BPF_COPX
+:
+
+573 #ifde
+_KERNEL
+
+
+574 i(
+X
+ < 
+bc
+->
+nfuncs
+) {
+
+575 c 
+bpf_cfunc_t
+ 
+
+ = 
+bc
+->
+cfuncs
+[
+X
+];
+
+576 
+A
+ = 
+	`
+(
+bc
+, 
+gs
+, A);
+
+583 
+	}
+}
+
+597 #i
+defed
+(
+KERNEL
+|| defed(
+_KERNEL
+)
+
+600 
+	$bpf_vide
+(c 
+bpf_
+ *
+f
+, 
+sigd_n
+)
+
+602  
+	`bpf_vide_ext
+(
+NULL
+, 
+f
+, 
+sigd_n
+);
+
+603 
+	}
+}
+
+606 
+	$bpf_vide_ext
+(c 
+bpf_x_t
+ *
+bc
+, c 
+bpf_
+ *
+f
+, 
+sigd_n
+)
+
+609 
+	$bpf_vide
+(c 
+bpf_
+ *
+f
+, 
+sigd_n
+)
+
+612 
+u_t
+ 
+i
+, 
+om
+, 
+n
+, 
+ok
+ = 0;
+
+613 c 
+bpf_
+ *
+p
+;
+
+614 #i
+	`defed
+(
+KERNEL
+|| defed(
+_KERNEL
+)
+
+615 
+bpf_memwd__t
+ *
+mem
+, 
+vid
+;
+
+616 
+size_t
+ 
+size
+;
+
+617 c 
+size_t
+ 
+extwds
+ = 
+bc
+ ? bc->extwords : 0;
+
+618 c 
+size_t
+ 
+memwds
+ = 
+extwds
+ ?xtwd: 
+BPF_MEMWORDS
+;
+
+619 c 
+bpf_memwd__t
+ 
+eed
+ = 
+extwds
+ ? 
+bc
+->preinited : 0;
+
+621 c 
+size_t
+ 
+memwds
+ = 
+BPF_MEMWORDS
+;
+
+624 
+n
+ = (
+u_t
+)
+sigd_n
+;
+
+625 i(
+n
+ < 1)
+
+627 #i
+	`defed
+(
+KERNEL
+|| defed(
+_KERNEL
+)
+
+628 i(
+n
+ > 
+BPF_MAXINSNS
+)
+
+631 i(
+f
+[
+n
+ - 1].
+code
+ !(
+BPF_RET
+|
+BPF_K
+) &&
+
+632 
+f
+[
+n
+ - 1].
+code
+ !(
+BPF_RET
+|
+BPF_A
+)) {
+
+636 #i
+	`defed
+(
+KERNEL
+|| defed(
+_KERNEL
+)
+
+638 
+mem
+ = 
+	`kmem_zloc
+(
+size
+ = (*mem* 
+n
+, 
+KM_SLEEP
+);
+
+639 
+vid
+ = ~
+eed
+;
+
+642 
+i
+ = 0; i < 
+n
+; ++i) {
+
+643 #i
+	`defed
+(
+KERNEL
+|| defed(
+_KERNEL
+)
+
+645 
+vid
+ |
+mem
+[
+i
+];
+
+647 
+p
+ = &
+f
+[
+i
+];
+
+648 
+	`BPF_CLASS
+(
+p
+->
+code
+)) {
+
+652 
+BPF_LD
+:
+
+653 
+BPF_LDX
+:
+
+654 
+	`BPF_MODE
+(
+p
+->
+code
+)) {
+
+655 
+BPF_MEM
+:
+
+661 #i
+	`defed
+(
+KERNEL
+|| defed(
+_KERNEL
+)
+
+666 i(
+p
+->
+k
+ >
+memwds
+)
+
+667 
+out
+;
+
+669 i(
+vid
+ & 
+	`BPF_MEMWORD_INIT
+(
+p
+->
+k
+))
+
+670 
+out
+;
+
+673 
+BPF_ABS
+:
+
+674 
+BPF_IND
+:
+
+675 
+BPF_MSH
+:
+
+676 
+BPF_IMM
+:
+
+677 
+BPF_LEN
+:
+
+680 
+out
+;
+
+683 
+BPF_ST
+:
+
+684 
+BPF_STX
+:
+
+685 i(
+p
+->
+k
+ >
+memwds
+)
+
+686 
+out
+;
+
+687 #i
+	`defed
+(
+KERNEL
+|| defed(
+_KERNEL
+)
+
+689 
+vid
+ &~
+	`BPF_MEMWORD_INIT
+(
+p
+->
+k
+);
+
+692 
+BPF_ALU
+:
+
+693 
+	`BPF_OP
+(
+p
+->
+code
+)) {
+
+694 
+BPF_ADD
+:
+
+695 
+BPF_SUB
+:
+
+696 
+BPF_MUL
+:
+
+697 
+BPF_OR
+:
+
+698 
+BPF_XOR
+:
+
+699 
+BPF_AND
+:
+
+700 
+BPF_LSH
+:
+
+701 
+BPF_RSH
+:
+
+702 
+BPF_NEG
+:
+
+704 
+BPF_DIV
+:
+
+705 
+BPF_MOD
+:
+
+709 i(
+	`BPF_SRC
+(
+p
+->
+code
+=
+BPF_K
+ &&->
+k
+ == 0)
+
+710 
+out
+;
+
+713 
+out
+;
+
+716 
+BPF_JMP
+:
+
+743 
+om
+ = 
+i
+ + 1;
+
+744 
+	`BPF_OP
+(
+p
+->
+code
+)) {
+
+745 
+BPF_JA
+:
+
+746 i(
+om
+ + 
+p
+->
+k
+ >
+n
+)
+
+747 
+out
+;
+
+748 #i
+	`defed
+(
+KERNEL
+|| defed(
+_KERNEL
+)
+
+749 i(
+om
+ + 
+p
+->
+k
+ < from)
+
+750 
+out
+;
+
+755 
+mem
+[
+om
+ + 
+p
+->
+k
+] |
+vid
+;
+
+756 
+vid
+ = 0;
+
+759 
+BPF_JEQ
+:
+
+760 
+BPF_JGT
+:
+
+761 
+BPF_JGE
+:
+
+762 
+BPF_JSET
+:
+
+763 i(
+om
+ + 
+p
+->
+jt
+ >
+n
+ || from +->
+jf
+ >=en)
+
+764 
+out
+;
+
+765 #i
+	`defed
+(
+KERNEL
+|| defed(
+_KERNEL
+)
+
+770 
+mem
+[
+om
+ + 
+p
+->
+jt
+] |
+vid
+;
+
+771 
+mem
+[
+om
+ + 
+p
+->
+jf
+] |
+vid
+;
+
+772 
+vid
+ = 0;
+
+776 
+out
+;
+
+779 
+BPF_RET
+:
+
+781 
+BPF_MISC
+:
+
+782 
+	`BPF_MISCOP
+(
+p
+->
+code
+)) {
+
+783 
+BPF_COP
+:
+
+784 
+BPF_COPX
+:
+
+786 #i
+	`defed
+(
+KERNEL
+|| defed(
+_KERNEL
+)
+
+787 i(
+bc
+ =
+NULL
+ || bc->
+cfuncs
+ == NULL)
+
+788 
+out
+;
+
+789 i(
+	`BPF_MISCOP
+(
+p
+->
+code
+=
+BPF_COP
+ &&
+
+790 
+p
+->
+k
+ >
+bc
+->
+nfuncs
+) {
+
+791 
+out
+;
+
+795 
+out
+;
+
+802 
+out
+;
+
+805 
+ok
+ = 1;
+
+806 
+out
+:
+
+807 #i
+	`defed
+(
+KERNEL
+|| defed(
+_KERNEL
+)
+
+808 
+	`kmem_
+(
+mem
+, 
+size
+);
+
+810  
+ok
+;
+
+811 
+	}
+}
+
+	@bpf_stub.c
+
+29 
+	~<sys/cdefs.h
+>
+
+30 
+__KERNEL_RCSID
+(0, "$NetBSD: bpf_stub.c,v 1.6 2012/01/30 23:31:27 matt Exp $");
+
+32 
+	~<sys/m.h
+>
+
+33 
+	~<sys/kmem.h
+>
+
+34 
+	~<sys/mbuf.h
+>
+
+36 
+	~<t/bpf.h
+>
+
+38 
+	sgli
+ {
+
+39 
+i
+ *
+	mg_i
+;
+
+40 
+u_t
+ 
+	mg_d
+;
+
+41 
+u_t
+ 
+	mg_hn
+;
+
+42 
+bpf_if
+ **
+	mg_drvp
+;
+
+44 
+TAILQ_ENTRY
+(
+gli
+
+	mg_s
+;
+
+47 
+	$TAILQ_HEAD
+(, 
+gli
+
+gdrvs
+ = 
+	`TAILQ_HEAD_INITIALIZER
+(lagdrvs);
+
+49 
+	`bpf_ub_ch
+(
+i
+ *, 
+u_t
+, u_t, 
+bpf_if
+ **);
+
+50 
+	`bpf_ub_dach
+(
+i
+ *);
+
+52 
+	`bpf_ub_nu
+();
+
+53 
+	`bpf_ub_wn
+();
+
+55 
+kmux_t
+ 
+hdovmtx
+;
+
+56 
+kcdv_t
+ 
+hdovcv
+;
+
+57 
+bo
+ 
+hdov
+;
+
+59 
+bpf_s
+ 
+bpf_s_ub
+ = {
+
+60 .
+bpf_ch
+ = 
+bpf_ub_ch
+,
+
+61 .
+bpf_dach
+ = 
+bpf_ub_dach
+,
+
+62 .
+bpf_chge_ty
+ = (*)
+bpf_ub_nu
+,
+
+64 .
+bpf_p
+ = (*)
+bpf_ub_wn
+,
+
+65 .
+bpf_mp
+ = (*)
+bpf_ub_wn
+,
+
+66 .
+bpf_mp2
+ = (*)
+bpf_ub_wn
+,
+
+67 .
+bpf_mp_af
+ = (*)
+bpf_ub_wn
+,
+
+68 .
+bpf_mp__
+ = (*)
+bpf_ub_wn
+,
+
+69 .
+bpf_mp__out
+ = (*)
+bpf_ub_wn
+,
+
+70 
+	}
+};
+
+71 
+bpf_s
+ *
+	gbpf_s
+;
+
+74 
+	$bpf_ub_ch
+(
+i
+ *
+i
+, 
+u_t
+ 
+d
+, u_
+hn
+, 
+bpf_if
+ **
+drvp
+)
+
+76 
+gli
+ *
+g
+;
+
+77 
+bo
+ 
+ach
+ = 
+ue
+;
+
+79 
+g
+ = 
+	`kmem_loc
+((*g), 
+KM_SLEEP
+);
+
+80 
+g
+->
+g_i
+ = 
+i
+;
+
+81 
+g
+->
+g_d
+ = 
+d
+;
+
+82 
+g
+->
+g_hn
+ = 
+hn
+;
+
+83 
+g
+->
+g_drvp
+ = 
+drvp
+;
+
+85 
+	`mux_r
+(&
+hdovmtx
+);
+
+90 
+hdov
+) {
+
+91 
+ach
+ = 
+l
+;
+
+92 
+	`cv_wa
+(&
+hdovcv
+, &
+hdovmtx
+);
+
+95 i(
+ach
+ =
+l
+) {
+
+96 
+	`mux_ex
+(&
+hdovmtx
+);
+
+97 
+	`kmem_
+(
+g
+, (*lag));
+
+98 
+	`KASSERT
+(
+bpf_s
+ !&
+bpf_s_ub
+);
+
+99 
+bpf_s
+->
+	`bpf_ch
+(
+i
+, 
+d
+, 
+hn
+, 
+drvp
+);
+
+101 *
+drvp
+ = 
+NULL
+;
+
+102 
+	`TAILQ_INSERT_TAIL
+(&
+gdrvs
+, 
+g
+, 
+g_s
+);
+
+103 
+	`mux_ex
+(&
+hdovmtx
+);
+
+105 
+	}
+}
+
+108 
+	$bpf_ub_dach
+(
+i
+ *
+i
+)
+
+110 
+	`TAILQ_HEAD
+(, 
+gli
+
+rmli
+;
+
+111 
+gli
+ *
+g
+, *
+g_xt
+;
+
+112 
+bo
+ 
+didhd
+;
+
+114 
+	`TAILQ_INIT
+(&
+rmli
+);
+
+116 
+didhd
+ = 
+l
+;
+
+117 
+	`mux_r
+(&
+hdovmtx
+);
+
+118 
+hdov
+) {
+
+119 
+didhd
+ = 
+ue
+;
+
+120 
+	`cv_wa
+(&
+hdovcv
+, &
+hdovmtx
+);
+
+123 i(
+didhd
+ =
+l
+) {
+
+125 
+g
+ = 
+	`TAILQ_FIRST
+(&
+gdrvs
+);ag;ag = 
+g_xt
+) {
+
+126 
+g_xt
+ = 
+	`TAILQ_NEXT
+(
+g
+, 
+g_s
+);
+
+127 i(
+g
+->
+g_i
+ =
+i
+) {
+
+128 
+	`TAILQ_REMOVE
+(&
+gdrvs
+, 
+g
+, 
+g_s
+);
+
+129 
+	`TAILQ_INSERT_HEAD
+(&
+rmli
+, 
+g
+, 
+g_s
+);
+
+132 
+	`mux_ex
+(&
+hdovmtx
+);
+
+133 (
+g
+ = 
+	`TAILQ_FIRST
+(&
+rmli
+)!
+NULL
+) {
+
+134 
+	`TAILQ_REMOVE
+(&
+rmli
+, 
+g
+, 
+g_s
+);
+
+135 
+	`kmem_
+(
+g
+, (*lag));
+
+138 
+	`mux_ex
+(&
+hdovmtx
+);
+
+139 
+	`KASSERT
+(
+bpf_s
+ !&
+bpf_s_ub
+);
+
+140 
+bpf_s
+->
+	`bpf_dach
+(
+i
+);
+
+142 
+	}
+}
+
+145 
+	$bpf_ub_nu
+()
+
+148 
+	}
+}
+
+151 
+	$bpf_ub_wn
+()
+
+154 #ifde
+DEBUG
+
+
+155 
+	`nic
+("bpf method called withoutttached bpf_if");
+
+157 #ifde
+DIAGNOSTIC
+
+
+158 
+	`tf
+("bpf method called withoutttached bpf_if\n");
+
+160 
+	}
+}
+
+163 
+	$bpf_ts
+()
+
+166 
+	`mux_
+(&
+hdovmtx
+, 
+MUTEX_DEFAULT
+, 
+IPL_NONE
+);
+
+167 
+	`cv_
+(&
+hdovcv
+, "bpfops");
+
+168 
+bpf_s
+ = &
+bpf_s_ub
+;
+
+169 
+	}
+}
+
+180 
+	$bpf_s_hdov_r
+(
+bpf_s
+ *
+ws
+)
+
+182 
+gli
+ *
+g
+;
+
+184 
+	`mux_r
+(&
+hdovmtx
+);
+
+185 
+hdov
+ = 
+ue
+;
+
+187 (
+g
+ = 
+	`TAILQ_FIRST
+(&
+gdrvs
+)!
+NULL
+) {
+
+188 
+	`TAILQ_REMOVE
+(&
+gdrvs
+, 
+g
+, 
+g_s
+);
+
+189 
+	`mux_ex
+(&
+hdovmtx
+);
+
+190 
+ws
+->
+	`bpf_ch
+(
+g
+->
+g_i
+,ag->
+g_d
+,
+
+191 
+g
+->
+g_hn
+,ag->
+g_drvp
+);
+
+192 
+	`kmem_
+(
+g
+, (*lag));
+
+193 
+	`mux_r
+(&
+hdovmtx
+);
+
+195 
+	`mux_ex
+(&
+hdovmtx
+);
+
+196 
+	}
+}
+
+200 
+	$bpf_s_hdov_ex
+()
+
+203 
+	`mux_r
+(&
+hdovmtx
+);
+
+204 
+hdov
+ = 
+l
+;
+
+205 
+	`cv_brd
+(&
+hdovcv
+);
+
+206 
+	`mux_ex
+(&
+hdovmtx
+);
+
+207 
+	}
+}
+
+	@bpfdesc.h
+
+41 #ide
+_NET_BPFDESC_H_
+
+
+42 
+	#_NET_BPFDESC_H_
+
+
+	)
+
+44 
+	~<sys/out.h
+>
+
+45 
+	~<sys/lfo.h
+>
+
+46 
+	~<t/if.h
+>
+
+47 
+	~<t/bpfj.h
+>
+
+52 
+	sbpf_d
+ {
+
+53 
+bpf_d
+ *
+	mbd_xt
+;
+
+63 * 
+	mbd_sbuf
+;
+
+64 * 
+	mbd_hbuf
+;
+
+65 * 
+	mbd_fbuf
+;
+
+66 
+	mbd_
+;
+
+67 
+	mbd_hn
+;
+
+69 
+	mbd_bufsize
+;
+
+71 
+bpf_if
+ * 
+	mbd_bif
+;
+
+72 
+u_lg
+ 
+	mbd_out
+;
+
+73 
+bpf_
+ *
+	mbd_fr
+;
+
+74 
+u_lg
+ 
+	mbd_rcou
+;
+
+75 
+u_lg
+ 
+	mbd_dcou
+;
+
+76 
+u_lg
+ 
+	mbd_ccou
+;
+
+78 
+u_ch
+ 
+	mbd_omisc
+;
+
+79 
+u_ch
+ 
+	mbd_e
+;
+
+80 
+u_ch
+ 
+	mbd_immed
+;
+
+81 
+	mbd_hdrcmt
+;
+
+82 
+	mbd_e
+;
+
+83 
+	mbd_edback
+;
+
+84 
+	mbd_async
+;
+
+85 
+pid_t
+ 
+	mbd_pgid
+;
+
+86 #i
+BSD
+ < 199103
+
+87 
+u_ch
+ 
+	mbd_lcl
+;
+
+88 
+	mbd_timedout
+;
+
+89 
+oc
+ * 
+	mbd_roc
+;
+
+91 
+u_ch
+ 
+	mbd_d
+;
+
+92 
+lfo
+ 
+	mbd_l
+;
+
+94 
+out_t
+ 
+	mbd_out
+;
+
+95 
+pid_t
+ 
+	mbd_pid
+;
+
+96 
+LIST_ENTRY
+(
+bpf_d
+
+	mbd_li
+;
+
+97 *
+	mbd_sih
+;
+
+98 
+timeec
+ 
+	mbd_ime
+;
+
+99 
+timeec
+ 
+	mbd_mtime
+;
+
+100 
+timeec
+ 
+	mbd_btime
+;
+
+101 #ifde
+_LP64
+
+
+102 
+	mbd_comt32
+;
+
+104 
+bpfj_func_t
+ 
+	mbd_jcode
+;
+
+109 
+	#BPF_IDLE
+ 0
+
+	)
+
+110 
+	#BPF_WAITING
+ 1
+
+	)
+
+111 
+	#BPF_TIMED_OUT
+ 2
+
+	)
+
+117 
+	sbpf_d_ext
+ {
+
+118 
+t32_t
+ 
+	mbde_bufsize
+;
+
+119 
+ut8_t
+ 
+	mbde_omisc
+;
+
+120 
+ut8_t
+ 
+	mbde_e
+;
+
+121 
+ut8_t
+ 
+	mbde_immed
+;
+
+122 
+t32_t
+ 
+	mbde_hdrcmt
+;
+
+123 
+t32_t
+ 
+	mbde_e
+;
+
+124 
+pid_t
+ 
+	mbde_pid
+;
+
+125 
+ut64_t
+ 
+	mbde_rcou
+;
+
+126 
+ut64_t
+ 
+	mbde_dcou
+;
+
+127 
+ut64_t
+ 
+	mbde_ccou
+;
+
+128 
+	mbde_iame
+[
+IFNAMSIZ
+];
+
+135 
+	sbpf_if
+ {
+
+136 
+bpf_if
+ *
+	mbif_xt
+;
+
+137 
+bpf_d
+ *
+	mbif_dli
+;
+
+138 
+bpf_if
+ **
+	mbif_drivp
+;
+
+139 
+u_t
+ 
+	mbif_d
+;
+
+140 
+u_t
+ 
+	mbif_hd
+;
+
+141 
+i
+ *
+	mbif_i
+;
+
+144 #ifde
+_KERNEL
+
+
+145 
+bpf_tf
+(
+bpf_d
+ *, 
+bpf_ogm
+ *);
+
+	@bpfjit.c
+
+32 
+	~<sys/cdefs.h
+>
+
+33 #ifde
+_KERNEL
+
+
+34 
+__KERNEL_RCSID
+(0, "$NetBSD: bpfjit.c,v 1.43 2015/02/14 21:32:46lnsn Exp $");
+
+36 
+__RCSID
+("$NetBSD: bpfjit.c,v 1.43 2015/02/14 21:32:46lnsn Exp $");
+
+39 
+	~<sys/tys.h
+>
+
+40 
+	~<sys/queue.h
+>
+
+42 #ide
+_KERNEL
+
+
+43 
+	~<as.h
+>
+
+44 
+	#BJ_ASSERT
+(
+c
+
+	`as
+(c)
+
+	)
+
+46 
+	#BJ_ASSERT
+(
+c
+
+	`KASSERT
+(c)
+
+	)
+
+49 #ide
+_KERNEL
+
+
+50 
+	~<dlib.h
+>
+
+51 
+	#BJ_ALLOC
+(
+sz
+
+	`mloc
+(sz)
+
+	)
+
+52 
+	#BJ_FREE
+(
+p
+, 
+sz
+
+	`
+)
+
+	)
+
+54 
+	~<sys/kmem.h
+>
+
+55 
+	#BJ_ALLOC
+(
+sz
+
+	`kmem_loc
+(sz, 
+KM_SLEEP
+)
+
+	)
+
+56 
+	#BJ_FREE
+(
+p
+, 
+sz
+
+	`kmem_
+, sz)
+
+	)
+
+59 #ide
+_KERNEL
+
+
+60 
+	~<lims.h
+>
+
+61 
+	~<dbo.h
+>
+
+62 
+	~<ddef.h
+>
+
+63 
+	~<dt.h
+>
+
+65 
+	~<sys/omic.h
+>
+
+66 
+	~<sys/modu.h
+>
+
+69 
+	#__BPF_PRIVATE
+
+
+	)
+
+70 
+	~<t/bpf.h
+>
+
+71 
+	~<t/bpfj.h
+>
+
+72 
+	~<jL.h
+>
+
+74 #i!
+defed
+(
+_KERNEL
+&& defed(
+SLJIT_VERBOSE
+) && SLJIT_VERBOSE
+
+75 
+	~<dio.h
+>
+
+83 
+	#BJ_CTX_ARG
+ 
+SLJIT_SAVED_REG1
+
+
+	)
+
+84 
+	#BJ_ARGS
+ 
+SLJIT_SAVED_REG2
+
+
+	)
+
+89 
+	#BJ_BUF
+ 
+SLJIT_SAVED_REG1
+
+
+	)
+
+91 
+	#BJ_BUFLEN
+ 
+SLJIT_SAVED_REG3
+
+
+	)
+
+92 
+	#BJ_AREG
+ 
+SLJIT_SCRATCH_REG1
+
+
+	)
+
+93 
+	#BJ_TMP1REG
+ 
+SLJIT_SCRATCH_REG2
+
+
+	)
+
+94 
+	#BJ_TMP2REG
+ 
+SLJIT_SCRATCH_REG3
+
+
+	)
+
+95 
+	#BJ_XREG
+ 
+SLJIT_TEMPORARY_EREG1
+
+
+	)
+
+96 
+	#BJ_TMP3REG
+ 
+SLJIT_TEMPORARY_EREG2
+
+
+	)
+
+98 #ifde
+_KERNEL
+
+
+99 
+	#MAX_MEMWORDS
+ 
+BPF_MAX_MEMWORDS
+
+
+	)
+
+101 
+	#MAX_MEMWORDS
+ 
+BPF_MEMWORDS
+
+
+	)
+
+104 
+	#BJ_INIT_NOBITS
+ ((
+bpf_memwd__t
+)0)
+
+	)
+
+105 
+	#BJ_INIT_MBIT
+(
+k
+
+	`BPF_MEMWORD_INIT
+(k)
+
+	)
+
+106 
+	#BJ_INIT_ABIT
+ 
+	`BJ_INIT_MBIT
+(
+MAX_MEMWORDS
+)
+
+	)
+
+107 
+	#BJ_INIT_XBIT
+ 
+	`BJ_INIT_MBIT
+(
+MAX_MEMWORDS
+ + 1)
+
+	)
+
+112 
+	#GET_EXTWORDS
+(
+bc
+((bc? (bc)->
+extwds
+ : 0)
+
+	)
+
+113 
+	#GET_MEMWORDS
+(
+bc
+(
+	`GET_EXTWORDS
+(bc? GET_EXTWORDS(bc: 
+BPF_MEMWORDS
+)
+
+	)
+
+118 
+	tbpfj_ht_t
+;
+
+119 
+	#BJ_HINT_ABS
+ 0x01
+
+	)
+
+120 
+	#BJ_HINT_IND
+ 0x02
+
+	)
+
+121 
+	#BJ_HINT_MSH
+ 0x04
+
+	)
+
+122 
+	#BJ_HINT_COP
+ 0x08
+
+	)
+
+123 
+	#BJ_HINT_COPX
+ 0x10
+
+	)
+
+124 
+	#BJ_HINT_XREG
+ 0x20
+
+	)
+
+125 
+	#BJ_HINT_LDX
+ 0x40
+
+	)
+
+126 
+	#BJ_HINT_PKT
+ (
+BJ_HINT_ABS
+|
+BJ_HINT_IND
+|
+BJ_HINT_MSH
+)
+
+	)
+
+131 
+ut64_t
+ 
+	tbpfj_abc_ngth_t
+;
+
+132 
+	#MAX_ABC_LENGTH
+ (
+UINT32_MAX
+ + 
+	`UINT64_C
+(4)
+
+	)
+
+134 
+	sbpfj_ack
+
+
+136 
+bpf_x_t
+ *
+	mx
+;
+
+137 
+ut32_t
+ *
+	mextmem
+;
+
+138 
+ut32_t
+ 
+	mg
+;
+
+139 #ifde
+_KERNEL
+
+
+140 
+	mr
+;
+
+142 
+ut32_t
+ 
+	mmem
+[
+BPF_MEMWORDS
+];
+
+149 
+	gbpfj_jump_da
+;
+
+154 
+	sbpfj_jump
+ {
+
+155 
+j_jump
+ *
+	msjump
+;
+
+156 
+SLIST_ENTRY
+(
+bpfj_jump
+
+	ms
+;
+
+157 
+bpfj_jump_da
+ *
+	mjda
+;
+
+163 
+	sbpfj_jump_da
+ {
+
+169 
+bpfj_jump
+ 
+	mjtf
+[2];
+
+173 
+bpfj_abc_ngth_t
+ 
+	mabc_ngth
+;
+
+177 
+bpfj_abc_ngth_t
+ 
+	mchecked_ngth
+;
+
+184 
+	sbpfj_ad_pkt_da
+ {
+
+188 
+bpfj_abc_ngth_t
+ 
+	mabc_ngth
+;
+
+194 
+bpfj_abc_ngth_t
+ 
+	mcheck_ngth
+;
+
+200 
+	sbpfj__da
+ {
+
+202 
+SLIST_HEAD
+(, 
+bpfj_jump
+
+	mbjumps
+;
+
+205 
+bpfj_jump_da
+ 
+	mjda
+;
+
+206 
+bpfj_ad_pkt_da
+ 
+	mrda
+;
+
+207 } 
+	mu
+;
+
+209 
+bpf_memwd__t
+ 
+	mvid
+;
+
+210 
+bo
+ 
+	muchab
+;
+
+213 #ifde
+_KERNEL
+
+
+215 
+ut32_t
+ 
+m_xwd
+(c 
+mbuf
+ *, uint32_t, *);
+
+216 
+ut32_t
+ 
+m_xhf
+(c 
+mbuf
+ *, uint32_t, *);
+
+217 
+ut32_t
+ 
+m_xby
+(c 
+mbuf
+ *, uint32_t, *);
+
+219 
+MODULE
+(
+MODULE_CLASS_MISC
+, 
+bpfj
+, "sljit")
+
+222 
+	$bpfj_modcmd
+(
+modcmd_t
+ 
+cmd
+, *
+g
+)
+
+225 
+cmd
+) {
+
+226 
+MODULE_CMD_INIT
+:
+
+227 
+bpfj_modu_s
+.
+bj__code
+ = &
+bpfj__code
+;
+
+228 
+	`memb_odur
+();
+
+229 
+bpfj_modu_s
+.
+bj_ge_code
+ = &
+bpfj_ge_code
+;
+
+230 
+	`memb_odur
+();
+
+233 
+MODULE_CMD_FINI
+:
+
+234  
+EOPNOTSUPP
+;
+
+237  
+ENOTTY
+;
+
+239 
+	}
+}
+
+246 
+j_si
+
+
+247 
+	$nsches
+(
+bpfj_ht_t
+ 
+hts
+)
+
+249 
+j_si
+ 
+rv
+ = 2;
+
+251 #ifde
+_KERNEL
+
+
+252 i(
+hts
+ & 
+BJ_HINT_PKT
+)
+
+253 
+rv
+ = 3;
+
+256 i(
+hts
+ & 
+BJ_HINT_IND
+)
+
+257 
+rv
+ = 3;
+
+259 i(
+hts
+ & 
+BJ_HINT_COP
+)
+
+260 
+rv
+ = 3;
+
+262 i(
+hts
+ & 
+BJ_HINT_XREG
+)
+
+263 
+rv
+ = 4;
+
+265 #ifde
+_KERNEL
+
+
+266 i(
+hts
+ & 
+BJ_HINT_LDX
+)
+
+267 
+rv
+ = 5;
+
+270 i(
+hts
+ & 
+BJ_HINT_COPX
+)
+
+271 
+rv
+ = 5;
+
+273  
+rv
+;
+
+274 
+	}
+}
+
+280 
+j_si
+
+
+281 
+	$nveds
+(
+bpfj_ht_t
+ 
+hts
+)
+
+283 
+j_si
+ 
+rv
+ = 3;
+
+285  
+rv
+;
+
+286 
+	}
+}
+
+288 
+ut32_t
+
+
+289 
+	$ad_width
+(c 
+bpf_
+ *
+pc
+)
+
+292 
+	`BPF_SIZE
+(
+pc
+->
+code
+)) {
+
+293 
+BPF_W
+:  4;
+
+294 
+BPF_H
+:  2;
+
+295 
+BPF_B
+:  1;
+
+298 
+	}
+}
+
+305 
+	$ld_buf_bu
+(
+j_comp
+ *
+comp
+)
+
+307 
+us
+;
+
+309 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+310 
+SLJIT_MOV_P
+,
+
+311 
+BJ_BUF
+, 0,
+
+312 
+	`SLJIT_MEM1
+(
+BJ_ARGS
+),
+
+313 
+	`offtof
+(
+bpf_gs
+, 
+pkt
+));
+
+314 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+315  
+us
+;
+
+317 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+318 
+SLJIT_MOV
+,
+
+319 
+BJ_BUFLEN
+, 0,
+
+320 
+	`SLJIT_MEM1
+(
+BJ_ARGS
+),
+
+321 
+	`offtof
+(
+bpf_gs
+, 
+bu
+));
+
+323  
+us
+;
+
+324 
+	}
+}
+
+326 
+bo
+
+
+327 
+	$grow_jumps
+(
+j_jump
+ ***
+jumps
+, 
+size_t
+ *
+size
+)
+
+329 
+j_jump
+ **
+wr
+;
+
+330 c 
+size_t
+ 
+emsz
+ = (
+j_jump
+ *);
+
+331 
+size_t
+ 
+d_size
+ = *
+size
+;
+
+332 
+size_t
+ 
+w_size
+ = 2 * 
+d_size
+;
+
+334 i(
+w_size
+ < 
+d_size
+ ||ew_siz> 
+SIZE_MAX
+ / 
+emsz
+)
+
+335  
+l
+;
+
+337 
+wr
+ = 
+	`BJ_ALLOC
+(
+w_size
+ * 
+emsz
+);
+
+338 i(
+wr
+ =
+NULL
+)
+
+339  
+l
+;
+
+341 
+	`memy
+(
+wr
+, *
+jumps
+, 
+d_size
+ * 
+emsz
+);
+
+342 
+	`BJ_FREE
+(*
+jumps
+, 
+d_size
+ * 
+emsz
+);
+
+344 *
+jumps
+ = 
+wr
+;
+
+345 *
+size
+ = 
+w_size
+;
+
+346  
+ue
+;
+
+347 
+	}
+}
+
+349 
+bo
+
+
+350 
+	$nd_jump
+(
+j_jump
+ *
+jump
+, j_jum***
+jumps
+,
+
+351 
+size_t
+ *
+size
+, size_*
+max_size
+)
+
+353 i(*
+size
+ =*
+max_size
+ && !
+	`grow_jumps
+(
+jumps
+, max_size))
+
+354  
+l
+;
+
+356 (*
+jumps
+)[(*
+size
+)++] = 
+jump
+;
+
+357  
+ue
+;
+
+358 
+	}
+}
+
+364 
+	$em_ad8
+(
+j_comp
+ *
+comp
+, 
+j_si
+ 
+c
+, 
+ut32_t
+ 
+k
+)
+
+367  
+	`j_em_1
+(
+comp
+,
+
+368 
+SLJIT_MOV_UB
+,
+
+369 
+BJ_AREG
+, 0,
+
+370 
+	`SLJIT_MEM1
+(
+c
+), 
+k
+);
+
+371 
+	}
+}
+
+377 
+	$em_ad16
+(
+j_comp
+ *
+comp
+, 
+j_si
+ 
+c
+, 
+ut32_t
+ 
+k
+)
+
+379 
+us
+;
+
+381 
+	`BJ_ASSERT
+(
+k
+ <
+UINT32_MAX
+ - 1);
+
+384 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+385 
+SLJIT_MOV_UB
+,
+
+386 
+BJ_AREG
+, 0,
+
+387 
+	`SLJIT_MEM1
+(
+c
+), 
+k
+);
+
+388 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+389  
+us
+;
+
+392 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+393 
+SLJIT_MOV_UB
+,
+
+394 
+BJ_TMP1REG
+, 0,
+
+395 
+	`SLJIT_MEM1
+(
+c
+), 
+k
++1);
+
+396 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+397  
+us
+;
+
+400 
+us
+ = 
+	`j_em_2
+(
+comp
+,
+
+401 
+SLJIT_SHL
+,
+
+402 
+BJ_AREG
+, 0,
+
+403 
+BJ_AREG
+, 0,
+
+404 
+SLJIT_IMM
+, 8);
+
+405 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+406  
+us
+;
+
+409 
+us
+ = 
+	`j_em_2
+(
+comp
+,
+
+410 
+SLJIT_ADD
+,
+
+411 
+BJ_AREG
+, 0,
+
+412 
+BJ_AREG
+, 0,
+
+413 
+BJ_TMP1REG
+, 0);
+
+414  
+us
+;
+
+415 
+	}
+}
+
+421 
+	$em_ad32
+(
+j_comp
+ *
+comp
+, 
+j_si
+ 
+c
+, 
+ut32_t
+ 
+k
+)
+
+423 
+us
+;
+
+425 
+	`BJ_ASSERT
+(
+k
+ <
+UINT32_MAX
+ - 3);
+
+428 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+429 
+SLJIT_MOV_UB
+,
+
+430 
+BJ_AREG
+, 0,
+
+431 
+	`SLJIT_MEM1
+(
+c
+), 
+k
+);
+
+432 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+433  
+us
+;
+
+436 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+437 
+SLJIT_MOV_UB
+,
+
+438 
+BJ_TMP1REG
+, 0,
+
+439 
+	`SLJIT_MEM1
+(
+c
+), 
+k
++1);
+
+440 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+441  
+us
+;
+
+444 
+us
+ = 
+	`j_em_2
+(
+comp
+,
+
+445 
+SLJIT_SHL
+,
+
+446 
+BJ_AREG
+, 0,
+
+447 
+BJ_AREG
+, 0,
+
+448 
+SLJIT_IMM
+, 8);
+
+449 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+450  
+us
+;
+
+453 
+us
+ = 
+	`j_em_2
+(
+comp
+,
+
+454 
+SLJIT_ADD
+,
+
+455 
+BJ_AREG
+, 0,
+
+456 
+BJ_AREG
+, 0,
+
+457 
+BJ_TMP1REG
+, 0);
+
+458 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+459  
+us
+;
+
+462 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+463 
+SLJIT_MOV_UB
+,
+
+464 
+BJ_TMP1REG
+, 0,
+
+465 
+	`SLJIT_MEM1
+(
+c
+), 
+k
++2);
+
+466 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+467  
+us
+;
+
+470 
+us
+ = 
+	`j_em_2
+(
+comp
+,
+
+471 
+SLJIT_SHL
+,
+
+472 
+BJ_AREG
+, 0,
+
+473 
+BJ_AREG
+, 0,
+
+474 
+SLJIT_IMM
+, 8);
+
+475 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+476  
+us
+;
+
+479 
+us
+ = 
+	`j_em_2
+(
+comp
+,
+
+480 
+SLJIT_ADD
+,
+
+481 
+BJ_AREG
+, 0,
+
+482 
+BJ_AREG
+, 0,
+
+483 
+BJ_TMP1REG
+, 0);
+
+484 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+485  
+us
+;
+
+488 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+489 
+SLJIT_MOV_UB
+,
+
+490 
+BJ_TMP1REG
+, 0,
+
+491 
+	`SLJIT_MEM1
+(
+c
+), 
+k
++3);
+
+492 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+493  
+us
+;
+
+496 
+us
+ = 
+	`j_em_2
+(
+comp
+,
+
+497 
+SLJIT_SHL
+,
+
+498 
+BJ_AREG
+, 0,
+
+499 
+BJ_AREG
+, 0,
+
+500 
+SLJIT_IMM
+, 8);
+
+501 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+502  
+us
+;
+
+505 
+us
+ = 
+	`j_em_2
+(
+comp
+,
+
+506 
+SLJIT_ADD
+,
+
+507 
+BJ_AREG
+, 0,
+
+508 
+BJ_AREG
+, 0,
+
+509 
+BJ_TMP1REG
+, 0);
+
+510  
+us
+;
+
+511 
+	}
+}
+
+513 #ifde
+_KERNEL
+
+
+526 
+em_x
+(
+j_comp
+ *
+comp
+, 
+bpfj_ht_t
+ 
+hts
+,
+
+527 c 
+bpf_
+ *
+pc
+, 
+d
+, 
+j_jump
+ ***
+t0
+,
+
+528 
+size_t
+ *
+t0_size
+, size_*
+t0_maxsize
+,
+
+529 
+	$ut32_t
+ (*
+
+)(c 
+mbuf
+ *, 
+ut32_t
+, *))
+
+531 #i
+BJ_XREG
+ =
+SLJIT_RETURN_REG
+ || \
+
+532 
+BJ_XREG
+ =
+SLJIT_SCRATCH_REG1
+ || \
+
+533 
+BJ_XREG
+ =
+SLJIT_SCRATCH_REG2
+ || \
+
+534 
+BJ_XREG
+ =
+SLJIT_SCRATCH_REG3
+
+
+537 
+j_jump
+ *
+jump
+;
+
+538 
+j_si
+ 
+ve_g
+;
+
+539 
+us
+;
+
+541 
+ve_g
+ = (
+	`BPF_CLASS
+(
+pc
+->
+code
+=
+BPF_LDX
+? 
+BJ_AREG
+ : 
+BJ_XREG
+;
+
+543 i(
+ve_g
+ =
+BJ_AREG
+ || (
+hts
+ & 
+BJ_HINT_XREG
+)) {
+
+545 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+546 
+SLJIT_MOV_UI
+,
+
+547 
+	`SLJIT_MEM1
+(
+SLJIT_LOCALS_REG
+),
+
+548 
+	`offtof
+(
+bpfj_ack
+, 
+g
+),
+
+549 
+ve_g
+, 0);
+
+550 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+551  
+us
+;
+
+557 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+558 
+SLJIT_MOV
+,
+
+559 
+SLJIT_SCRATCH_REG1
+, 0,
+
+560 
+BJ_BUF
+, 0);
+
+561 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+562  
+us
+;
+
+564 i(
+	`BPF_CLASS
+(
+pc
+->
+code
+=
+BPF_LD
+ && 
+	`BPF_MODE
+c->code=
+BPF_IND
+) {
+
+565 i(
+pc
+->
+k
+ == 0) {
+
+567 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+568 
+SLJIT_MOV
+,
+
+569 
+SLJIT_SCRATCH_REG2
+, 0,
+
+570 
+BJ_XREG
+, 0);
+
+571 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+572  
+us
+;
+
+575 
+jump
+ = 
+	`j_em_cmp
+(
+comp
+,
+
+576 
+SLJIT_C_GREATER
+,
+
+577 
+BJ_XREG
+, 0,
+
+578 
+SLJIT_IMM
+, 
+UINT32_MAX
+ - 
+pc
+->
+k
+);
+
+579 i(
+jump
+ =
+NULL
+)
+
+580  
+SLJIT_ERR_ALLOC_FAILED
+;
+
+581 i(!
+	`nd_jump
+(
+jump
+, 
+t0
+, 
+t0_size
+, 
+t0_maxsize
+))
+
+582  
+SLJIT_ERR_ALLOC_FAILED
+;
+
+585 
+us
+ = 
+	`j_em_2
+(
+comp
+,
+
+586 
+SLJIT_ADD
+,
+
+587 
+SLJIT_SCRATCH_REG2
+, 0,
+
+588 
+BJ_XREG
+, 0,
+
+589 
+SLJIT_IMM
+, (
+ut32_t
+)
+pc
+->
+k
+);
+
+590 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+591  
+us
+;
+
+595 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+596 
+SLJIT_MOV
+,
+
+597 
+SLJIT_SCRATCH_REG2
+, 0,
+
+598 
+SLJIT_IMM
+, (
+ut32_t
+)
+pc
+->
+k
+);
+
+599 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+600  
+us
+;
+
+606 
+us
+ = 
+	`j_g_lol_ba
+(
+comp
+,
+
+607 
+SLJIT_SCRATCH_REG3
+, 0,
+
+608 
+	`offtof
+(
+bpfj_ack
+, 
+r
+));
+
+609 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+610  
+us
+;
+
+613 
+us
+ = 
+	`j_em_ijump
+(
+comp
+,
+
+614 
+SLJIT_CALL3
+,
+
+615 
+SLJIT_IMM
+, 
+	`SLJIT_FUNC_OFFSET
+(
+
+));
+
+616 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+617  
+us
+;
+
+619 i(
+d
+ !
+SLJIT_RETURN_REG
+) {
+
+621 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+622 
+SLJIT_MOV
+,
+
+623 
+d
+, 0,
+
+624 
+SLJIT_RETURN_REG
+, 0);
+
+625 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+626  
+us
+;
+
+630 
+jump
+ = 
+	`j_em_cmp
+(
+comp
+,
+
+631 
+SLJIT_C_NOT_EQUAL
+|
+SLJIT_INT_OP
+,
+
+632 
+	`SLJIT_MEM1
+(
+SLJIT_LOCALS_REG
+),
+
+633 
+	`offtof
+(
+bpfj_ack
+, 
+r
+),
+
+634 
+SLJIT_IMM
+, 0);
+
+635 i(
+jump
+ =
+NULL
+)
+
+636  
+SLJIT_ERR_ALLOC_FAILED
+;
+
+638 i(!
+	`nd_jump
+(
+jump
+, 
+t0
+, 
+t0_size
+, 
+t0_maxsize
+))
+
+639  
+SLJIT_ERR_ALLOC_FAILED
+;
+
+641 i(
+ve_g
+ =
+BJ_AREG
+ || (
+hts
+ & 
+BJ_HINT_XREG
+)) {
+
+643 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+644 
+SLJIT_MOV_UI
+,
+
+645 
+ve_g
+, 0,
+
+646 
+	`SLJIT_MEM1
+(
+SLJIT_LOCALS_REG
+),
+
+647 
+	`offtof
+(
+bpfj_ack
+, 
+g
+));
+
+648 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+649  
+us
+;
+
+652  
+SLJIT_SUCCESS
+;
+
+653 
+	}
+}
+
+660 
+	$em_c
+(
+j_comp
+ *
+comp
+, 
+bpfj_ht_t
+ 
+hts
+,
+
+661 c 
+bpf_x_t
+ *
+bc
+, c 
+bpf_
+ *
+pc
+,
+
+662 
+j_jump
+ ***
+t0
+, 
+size_t
+ *
+t0_size
+, size_*
+t0_maxsize
+)
+
+664 #i
+BJ_XREG
+ =
+SLJIT_RETURN_REG
+ || \
+
+665 
+BJ_XREG
+ =
+SLJIT_SCRATCH_REG1
+ || \
+
+666 
+BJ_XREG
+ =
+SLJIT_SCRATCH_REG2
+ || \
+
+667 
+BJ_XREG
+ =
+SLJIT_SCRATCH_REG3
+ || \
+
+668 
+BJ_TMP3REG
+ =
+SLJIT_SCRATCH_REG1
+ || \
+
+669 
+BJ_TMP3REG
+ =
+SLJIT_SCRATCH_REG2
+ || \
+
+670 
+BJ_TMP3REG
+ =
+SLJIT_SCRATCH_REG3
+
+
+674 
+j_jump
+ *
+jump
+;
+
+675 
+j_si
+ 
+_g
+;
+
+676 
+j_sw
+ 
+_off
+;
+
+677 
+us
+;
+
+679 
+	`BJ_ASSERT
+(
+bc
+ !
+NULL
+ && bc->
+cfuncs
+ != NULL);
+
+681 i(
+hts
+ & 
+BJ_HINT_LDX
+) {
+
+683 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+684 
+SLJIT_MOV_UI
+,
+
+685 
+	`SLJIT_MEM1
+(
+SLJIT_LOCALS_REG
+),
+
+686 
+	`offtof
+(
+bpfj_ack
+, 
+g
+),
+
+687 
+BJ_XREG
+, 0);
+
+688 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+689  
+us
+;
+
+692 i(
+	`BPF_MISCOP
+(
+pc
+->
+code
+=
+BPF_COP
+) {
+
+693 
+_g
+ = 
+SLJIT_IMM
+;
+
+694 
+_off
+ = 
+	`SLJIT_FUNC_OFFSET
+(
+bc
+->
+cfuncs
+[
+pc
+->
+k
+]);
+
+697 
+jump
+ = 
+	`j_em_cmp
+(
+comp
+,
+
+698 
+SLJIT_C_GREATER_EQUAL
+,
+
+699 
+BJ_XREG
+, 0,
+
+700 
+SLJIT_IMM
+, 
+bc
+->
+nfuncs
+);
+
+701 i(
+jump
+ =
+NULL
+)
+
+702  
+SLJIT_ERR_ALLOC_FAILED
+;
+
+703 i(!
+	`nd_jump
+(
+jump
+, 
+t0
+, 
+t0_size
+, 
+t0_maxsize
+))
+
+704  
+SLJIT_ERR_ALLOC_FAILED
+;
+
+707 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+708 
+SLJIT_MOV_P
+,
+
+709 
+BJ_TMP1REG
+, 0,
+
+710 
+	`SLJIT_MEM1
+(
+SLJIT_LOCALS_REG
+),
+
+711 
+	`offtof
+(
+bpfj_ack
+, 
+x
+));
+
+712 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+713  
+us
+;
+
+716 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+717 
+SLJIT_MOV_P
+,
+
+718 
+BJ_TMP1REG
+, 0,
+
+719 
+	`SLJIT_MEM1
+(
+BJ_TMP1REG
+),
+
+720 
+	`offtof
+(
+bpf_x
+, 
+cfuncs
+));
+
+721 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+722  
+us
+;
+
+725 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+726 
+SLJIT_MOV
+,
+
+727 
+BJ_TMP2REG
+, 0,
+
+728 
+BJ_XREG
+, 0);
+
+729 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+730  
+us
+;
+
+733 
+_g
+ = 
+BJ_TMP3REG
+;
+
+734 
+_off
+ = 0;
+
+735 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+736 
+SLJIT_MOV_P
+,
+
+737 
+_g
+, 
+_off
+,
+
+738 
+	`SLJIT_MEM2
+(
+BJ_TMP1REG
+, 
+BJ_TMP2REG
+),
+
+739 
+SLJIT_WORD_SHIFT
+);
+
+740 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+741  
+us
+;
+
+747 #i
+BJ_AREG
+ !
+SLJIT_SCRATCH_REG3
+
+
+748 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+749 
+SLJIT_MOV_UI
+,
+
+750 
+SLJIT_SCRATCH_REG3
+, 0,
+
+751 
+BJ_AREG
+, 0);
+
+752 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+753  
+us
+;
+
+756 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+757 
+SLJIT_MOV_P
+,
+
+758 
+SLJIT_SCRATCH_REG1
+, 0,
+
+759 
+	`SLJIT_MEM1
+(
+SLJIT_LOCALS_REG
+),
+
+760 
+	`offtof
+(
+bpfj_ack
+, 
+x
+));
+
+761 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+762  
+us
+;
+
+764 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+765 
+SLJIT_MOV_P
+,
+
+766 
+SLJIT_SCRATCH_REG2
+, 0,
+
+767 
+BJ_ARGS
+, 0);
+
+768 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+769  
+us
+;
+
+771 
+us
+ = 
+	`j_em_ijump
+(
+comp
+,
+
+772 
+SLJIT_CALL3
+, 
+_g
+, 
+_off
+);
+
+773 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+774  
+us
+;
+
+776 #i
+BJ_AREG
+ !
+SLJIT_RETURN_REG
+
+
+777 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+778 
+SLJIT_MOV
+,
+
+779 
+BJ_AREG
+, 0,
+
+780 
+SLJIT_RETURN_REG
+, 0);
+
+781 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+782  
+us
+;
+
+785 i(
+hts
+ & 
+BJ_HINT_LDX
+) {
+
+787 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+788 
+SLJIT_MOV_UI
+,
+
+789 
+BJ_XREG
+, 0,
+
+790 
+	`SLJIT_MEM1
+(
+SLJIT_LOCALS_REG
+),
+
+791 
+	`offtof
+(
+bpfj_ack
+, 
+g
+));
+
+792 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+793  
+us
+;
+
+796  
+SLJIT_SUCCESS
+;
+
+797 
+	}
+}
+
+809 
+	$em_pkt_ad
+(
+j_comp
+ *
+comp
+, 
+bpfj_ht_t
+ 
+hts
+,
+
+810 c 
+bpf_
+ *
+pc
+, 
+j_jump
+ *
+to_mcha_jump
+,
+
+811 
+j_jump
+ ***
+t0
+, 
+size_t
+ *
+t0_size
+, size_*
+t0_maxsize
+)
+
+813 
+us
+ = 
+SLJIT_ERR_ALLOC_FAILED
+;
+
+814 
+ut32_t
+ 
+width
+;
+
+815 
+j_si
+ 
+ld_g
+;
+
+816 
+j_jump
+ *
+jump
+;
+
+817 #ifde
+_KERNEL
+
+
+818 
+j_b
+ *
+b
+;
+
+819 
+j_jump
+ *
+ov_mcha_jump
+;
+
+820 c 
+bo
+ 
+check_zo_bu
+ = (
+to_mcha_jump
+ !
+NULL
+);
+
+822 c 
+ut32_t
+ 
+k
+ = 
+pc
+->k;
+
+824 #ifde
+_KERNEL
+
+
+825 i(
+to_mcha_jump
+ =
+NULL
+) {
+
+826 
+to_mcha_jump
+ = 
+	`j_em_cmp
+(
+comp
+,
+
+827 
+SLJIT_C_EQUAL
+,
+
+828 
+BJ_BUFLEN
+, 0,
+
+829 
+SLJIT_IMM
+, 0);
+
+830 i(
+to_mcha_jump
+ =
+NULL
+)
+
+831  
+SLJIT_ERR_ALLOC_FAILED
+;
+
+835 
+ld_g
+ = 
+BJ_BUF
+;
+
+836 
+width
+ = 
+	`ad_width
+(
+pc
+);
+
+837 i(
+width
+ == 0)
+
+838  
+SLJIT_ERR_ALLOC_FAILED
+;
+
+840 i(
+	`BPF_MODE
+(
+pc
+->
+code
+=
+BPF_IND
+) {
+
+842 
+us
+ = 
+	`j_em_2
+(
+comp
+,
+
+843 
+SLJIT_SUB
+,
+
+844 
+BJ_TMP1REG
+, 0,
+
+845 
+BJ_BUFLEN
+, 0,
+
+846 
+SLJIT_IMM
+, 
+k
+ + 
+width
+);
+
+847 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+848  
+us
+;
+
+851 
+ld_g
+ = 
+BJ_TMP2REG
+;
+
+852 
+us
+ = 
+	`j_em_2
+(
+comp
+,
+
+853 
+SLJIT_ADD
+,
+
+854 
+ld_g
+, 0,
+
+855 
+BJ_BUF
+, 0,
+
+856 
+BJ_XREG
+, 0);
+
+857 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+858  
+us
+;
+
+861 
+jump
+ = 
+	`j_em_cmp
+(
+comp
+,
+
+862 
+SLJIT_C_LESS
+,
+
+863 
+BJ_TMP1REG
+, 0,
+
+864 
+BJ_XREG
+, 0);
+
+865 i(
+jump
+ =
+NULL
+)
+
+866  
+SLJIT_ERR_ALLOC_FAILED
+;
+
+867 i(!
+	`nd_jump
+(
+jump
+, 
+t0
+, 
+t0_size
+, 
+t0_maxsize
+))
+
+868  
+SLJIT_ERR_ALLOC_FAILED
+;
+
+876 i(
+k
+ <
+UINT32_MAX
+ - 
+width
+ + 1) {
+
+877 
+width
+) {
+
+879 
+us
+ = 
+	`em_ad32
+(
+comp
+, 
+ld_g
+, 
+k
+);
+
+882 
+us
+ = 
+	`em_ad16
+(
+comp
+, 
+ld_g
+, 
+k
+);
+
+885 
+us
+ = 
+	`em_ad8
+(
+comp
+, 
+ld_g
+, 
+k
+);
+
+889 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+890  
+us
+;
+
+893 #ifde
+_KERNEL
+
+
+894 
+ov_mcha_jump
+ = 
+	`j_em_jump
+(
+comp
+, 
+SLJIT_JUMP
+);
+
+895 i(
+ov_mcha_jump
+ =
+NULL
+)
+
+896  
+SLJIT_ERR_ALLOC_FAILED
+;
+
+899 
+b
+ = 
+	`j_em_b
+(
+comp
+);
+
+900 i(
+b
+ =
+NULL
+)
+
+901  
+SLJIT_ERR_ALLOC_FAILED
+;
+
+902 
+	`j_t_b
+(
+to_mcha_jump
+, 
+b
+);
+
+904 i(
+check_zo_bu
+) {
+
+906 
+jump
+ = 
+	`j_em_cmp
+(
+comp
+,
+
+907 
+SLJIT_C_NOT_EQUAL
+,
+
+908 
+BJ_BUFLEN
+, 0,
+
+909 
+SLJIT_IMM
+, 0);
+
+910 i(
+jump
+ =
+NULL
+)
+
+911  
+SLJIT_ERR_ALLOC_FAILED
+;
+
+912 i(!
+	`nd_jump
+(
+jump
+, 
+t0
+, 
+t0_size
+, 
+t0_maxsize
+))
+
+913  
+SLJIT_ERR_ALLOC_FAILED
+;
+
+916 
+width
+) {
+
+918 
+us
+ = 
+	`em_x
+(
+comp
+, 
+hts
+, 
+pc
+, 
+BJ_AREG
+,
+
+919 
+t0
+, 
+t0_size
+, 
+t0_maxsize
+, &
+m_xwd
+);
+
+922 
+us
+ = 
+	`em_x
+(
+comp
+, 
+hts
+, 
+pc
+, 
+BJ_AREG
+,
+
+923 
+t0
+, 
+t0_size
+, 
+t0_maxsize
+, &
+m_xhf
+);
+
+926 
+us
+ = 
+	`em_x
+(
+comp
+, 
+hts
+, 
+pc
+, 
+BJ_AREG
+,
+
+927 
+t0
+, 
+t0_size
+, 
+t0_maxsize
+, &
+m_xby
+);
+
+931 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+932  
+us
+;
+
+934 
+b
+ = 
+	`j_em_b
+(
+comp
+);
+
+935 i(
+b
+ =
+NULL
+)
+
+936  
+SLJIT_ERR_ALLOC_FAILED
+;
+
+937 
+	`j_t_b
+(
+ov_mcha_jump
+, 
+b
+);
+
+940  
+SLJIT_SUCCESS
+;
+
+941 
+	}
+}
+
+944 
+	$em_memld
+(
+j_comp
+ *
+comp
+,
+
+945 
+j_si
+ 
+d
+, 
+ut32_t
+ 
+k
+, 
+size_t
+ 
+extwds
+)
+
+947 
+us
+;
+
+948 
+j_si
+ 
+c
+;
+
+949 
+j_sw
+ 
+cw
+;
+
+951 
+cw
+ = 
+k
+ * (
+ut32_t
+);
+
+953 i(
+extwds
+ == 0) {
+
+954 
+c
+ = 
+	`SLJIT_MEM1
+(
+SLJIT_LOCALS_REG
+);
+
+955 
+cw
+ +
+	`offtof
+(
+bpfj_ack
+, 
+mem
+);
+
+958 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+959 
+SLJIT_MOV_P
+,
+
+960 
+BJ_TMP1REG
+, 0,
+
+961 
+	`SLJIT_MEM1
+(
+SLJIT_LOCALS_REG
+),
+
+962 
+	`offtof
+(
+bpfj_ack
+, 
+extmem
+));
+
+963 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+964  
+us
+;
+
+965 
+c
+ = 
+	`SLJIT_MEM1
+(
+BJ_TMP1REG
+);
+
+968  
+	`j_em_1
+(
+comp
+, 
+SLJIT_MOV_UI
+, 
+d
+, 0, 
+c
+, 
+cw
+);
+
+969 
+	}
+}
+
+972 
+	$em_meme
+(
+j_comp
+ *
+comp
+,
+
+973 
+j_si
+ 
+c
+, 
+ut32_t
+ 
+k
+, 
+size_t
+ 
+extwds
+)
+
+975 
+us
+;
+
+976 
+j_si
+ 
+d
+;
+
+977 
+j_sw
+ 
+dw
+;
+
+979 
+dw
+ = 
+k
+ * (
+ut32_t
+);
+
+981 i(
+extwds
+ == 0) {
+
+982 
+d
+ = 
+	`SLJIT_MEM1
+(
+SLJIT_LOCALS_REG
+);
+
+983 
+dw
+ +
+	`offtof
+(
+bpfj_ack
+, 
+mem
+);
+
+986 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+987 
+SLJIT_MOV_P
+,
+
+988 
+BJ_TMP1REG
+, 0,
+
+989 
+	`SLJIT_MEM1
+(
+SLJIT_LOCALS_REG
+),
+
+990 
+	`offtof
+(
+bpfj_ack
+, 
+extmem
+));
+
+991 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+992  
+us
+;
+
+993 
+d
+ = 
+	`SLJIT_MEM1
+(
+BJ_TMP1REG
+);
+
+996  
+	`j_em_1
+(
+comp
+, 
+SLJIT_MOV_UI
+, 
+d
+, 
+dw
+, 
+c
+, 0);
+
+997 
+	}
+}
+
+1003 
+	$em_msh
+(
+j_comp
+ *
+comp
+, 
+bpfj_ht_t
+ 
+hts
+,
+
+1004 c 
+bpf_
+ *
+pc
+, 
+j_jump
+ *
+to_mcha_jump
+,
+
+1005 
+j_jump
+ ***
+t0
+, 
+size_t
+ *
+t0_size
+, size_*
+t0_maxsize
+)
+
+1007 
+us
+;
+
+1008 #ifde
+_KERNEL
+
+
+1009 
+j_b
+ *
+b
+;
+
+1010 
+j_jump
+ *
+jump
+, *
+ov_mcha_jump
+;
+
+1011 c 
+bo
+ 
+check_zo_bu
+ = (
+to_mcha_jump
+ !
+NULL
+);
+
+1013 c 
+ut32_t
+ 
+k
+ = 
+pc
+->k;
+
+1015 #ifde
+_KERNEL
+
+
+1016 i(
+to_mcha_jump
+ =
+NULL
+) {
+
+1017 
+to_mcha_jump
+ = 
+	`j_em_cmp
+(
+comp
+,
+
+1018 
+SLJIT_C_EQUAL
+,
+
+1019 
+BJ_BUFLEN
+, 0,
+
+1020 
+SLJIT_IMM
+, 0);
+
+1021 i(
+to_mcha_jump
+ =
+NULL
+)
+
+1022  
+SLJIT_ERR_ALLOC_FAILED
+;
+
+1027 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+1028 
+SLJIT_MOV_UB
+,
+
+1029 
+BJ_TMP1REG
+, 0,
+
+1030 
+	`SLJIT_MEM1
+(
+BJ_BUF
+), 
+k
+);
+
+1031 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1032  
+us
+;
+
+1034 #ifde
+_KERNEL
+
+
+1035 
+ov_mcha_jump
+ = 
+	`j_em_jump
+(
+comp
+, 
+SLJIT_JUMP
+);
+
+1036 i(
+ov_mcha_jump
+ =
+NULL
+)
+
+1037  
+SLJIT_ERR_ALLOC_FAILED
+;
+
+1040 
+b
+ = 
+	`j_em_b
+(
+comp
+);
+
+1041 i(
+b
+ =
+NULL
+)
+
+1042  
+SLJIT_ERR_ALLOC_FAILED
+;
+
+1043 
+	`j_t_b
+(
+to_mcha_jump
+, 
+b
+);
+
+1045 i(
+check_zo_bu
+) {
+
+1047 
+jump
+ = 
+	`j_em_cmp
+(
+comp
+,
+
+1048 
+SLJIT_C_NOT_EQUAL
+,
+
+1049 
+BJ_BUFLEN
+, 0,
+
+1050 
+SLJIT_IMM
+, 0);
+
+1051 i(
+jump
+ =
+NULL
+)
+
+1052  
+SLJIT_ERR_ALLOC_FAILED
+;
+
+1053 i(!
+	`nd_jump
+(
+jump
+, 
+t0
+, 
+t0_size
+, 
+t0_maxsize
+))
+
+1054  
+SLJIT_ERR_ALLOC_FAILED
+;
+
+1057 
+us
+ = 
+	`em_x
+(
+comp
+, 
+hts
+, 
+pc
+, 
+BJ_TMP1REG
+,
+
+1058 
+t0
+, 
+t0_size
+, 
+t0_maxsize
+, &
+m_xby
+);
+
+1059 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1060  
+us
+;
+
+1062 
+b
+ = 
+	`j_em_b
+(
+comp
+);
+
+1063 i(
+b
+ =
+NULL
+)
+
+1064  
+SLJIT_ERR_ALLOC_FAILED
+;
+
+1065 
+	`j_t_b
+(
+ov_mcha_jump
+, 
+b
+);
+
+1069 
+us
+ = 
+	`j_em_2
+(
+comp
+,
+
+1070 
+SLJIT_AND
+,
+
+1071 
+BJ_TMP1REG
+, 0,
+
+1072 
+BJ_TMP1REG
+, 0,
+
+1073 
+SLJIT_IMM
+, 0xf);
+
+1074 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1075  
+us
+;
+
+1078 
+us
+ = 
+	`j_em_2
+(
+comp
+,
+
+1079 
+SLJIT_SHL
+,
+
+1080 
+BJ_XREG
+, 0,
+
+1081 
+BJ_TMP1REG
+, 0,
+
+1082 
+SLJIT_IMM
+, 2);
+
+1083 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1084  
+us
+;
+
+1086  
+SLJIT_SUCCESS
+;
+
+1087 
+	}
+}
+
+1094 
+	$em_pow2_moddiv
+(
+j_comp
+ *
+comp
+, c 
+bpf_
+ *
+pc
+)
+
+1096 
+ut32_t
+ 
+k
+ = 
+pc
+->k;
+
+1097 
+us
+ = 
+SLJIT_SUCCESS
+;
+
+1099 
+	`BJ_ASSERT
+(
+k
+ != 0 && (k & (k - 1)) == 0);
+
+1101 i(
+	`BPF_OP
+(
+pc
+->
+code
+=
+BPF_MOD
+) {
+
+1102 
+us
+ = 
+	`j_em_2
+(
+comp
+,
+
+1103 
+SLJIT_AND
+,
+
+1104 
+BJ_AREG
+, 0,
+
+1105 
+BJ_AREG
+, 0,
+
+1106 
+SLJIT_IMM
+, 
+k
+ - 1);
+
+1108 
+shi
+ = 0;
+
+1114 
+k
+ > 1) {
+
+1115 
+k
+ >>= 1;
+
+1116 
+shi
+++;
+
+1119 i(
+shi
+ != 0) {
+
+1120 
+us
+ = 
+	`j_em_2
+(
+comp
+,
+
+1121 
+SLJIT_LSHR
+|
+SLJIT_INT_OP
+,
+
+1122 
+BJ_AREG
+, 0,
+
+1123 
+BJ_AREG
+, 0,
+
+1124 
+SLJIT_IMM
+, 
+shi
+);
+
+1128  
+us
+;
+
+1129 
+	}
+}
+
+1131 #i!
+defed
+(
+BPFJIT_USE_UDIV
+)
+
+1132 
+j_uw
+
+
+1133 
+	$divide
+(
+j_uw
+ 
+x
+, slj_uw 
+y
+)
+
+1136  (
+ut32_t
+)
+x
+ / (ut32_t)
+y
+;
+
+1137 
+	}
+}
+
+1139 
+j_uw
+
+
+1140 
+	$modulus
+(
+j_uw
+ 
+x
+, slj_uw 
+y
+)
+
+1143  (
+ut32_t
+)
+x
+ % (ut32_t)
+y
+;
+
+1144 
+	}
+}
+
+1152 
+	$em_moddiv
+(
+j_comp
+ *
+comp
+, c 
+bpf_
+ *
+pc
+)
+
+1154 
+us
+;
+
+1155 c 
+bo
+ 
+xdiv
+ = 
+	`BPF_OP
+(
+pc
+->
+code
+=
+BPF_DIV
+;
+
+1156 c 
+bo
+ 
+xg
+ = 
+	`BPF_SRC
+(
+pc
+->
+code
+=
+BPF_X
+;
+
+1158 #i
+BJ_XREG
+ =
+SLJIT_RETURN_REG
+ || \
+
+1159 
+BJ_XREG
+ =
+SLJIT_SCRATCH_REG1
+ || \
+
+1160 
+BJ_XREG
+ =
+SLJIT_SCRATCH_REG2
+ || \
+
+1161 
+BJ_AREG
+ =
+SLJIT_SCRATCH_REG2
+
+
+1165 #i
+BJ_AREG
+ !
+SLJIT_SCRATCH_REG1
+
+
+1166 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+1167 
+SLJIT_MOV
+,
+
+1168 
+SLJIT_SCRATCH_REG1
+, 0,
+
+1169 
+BJ_AREG
+, 0);
+
+1170 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1171  
+us
+;
+
+1174 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+1175 
+SLJIT_MOV
+,
+
+1176 
+SLJIT_SCRATCH_REG2
+, 0,
+
+1177 
+xg
+ ? 
+BJ_XREG
+ : 
+SLJIT_IMM
+,
+
+1178 
+xg
+ ? 0 : (
+ut32_t
+)
+pc
+->
+k
+);
+
+1179 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1180  
+us
+;
+
+1182 #i
+	`defed
+(
+BPFJIT_USE_UDIV
+)
+
+1183 
+us
+ = 
+	`j_em_0
+(
+comp
+, 
+SLJIT_UDIV
+|
+SLJIT_INT_OP
+);
+
+1185 i(
+	`BPF_OP
+(
+pc
+->
+code
+=
+BPF_DIV
+) {
+
+1186 #i
+BJ_AREG
+ !
+SLJIT_SCRATCH_REG1
+
+
+1187 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+1188 
+SLJIT_MOV
+,
+
+1189 
+BJ_AREG
+, 0,
+
+1190 
+SLJIT_SCRATCH_REG1
+, 0);
+
+1193 #i
+BJ_AREG
+ !
+SLJIT_SCRATCH_REG2
+
+
+1195 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+1196 
+SLJIT_MOV
+,
+
+1197 
+BJ_AREG
+, 0,
+
+1198 
+SLJIT_SCRATCH_REG2
+, 0);
+
+1202 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1203  
+us
+;
+
+1205 
+us
+ = 
+	`j_em_ijump
+(
+comp
+,
+
+1206 
+SLJIT_CALL2
+,
+
+1207 
+SLJIT_IMM
+, 
+xdiv
+ ? 
+	`SLJIT_FUNC_OFFSET
+(
+divide
+) :
+
+1208 
+	`SLJIT_FUNC_OFFSET
+(
+modulus
+));
+
+1210 #i
+BJ_AREG
+ !
+SLJIT_RETURN_REG
+
+
+1211 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+1212 
+SLJIT_MOV
+,
+
+1213 
+BJ_AREG
+, 0,
+
+1214 
+SLJIT_RETURN_REG
+, 0);
+
+1215 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1216  
+us
+;
+
+1220  
+us
+;
+
+1221 
+	}
+}
+
+1228 
+bo
+
+
+1229 
+	$ad_pkt_
+(c 
+bpf_
+ *
+pc
+, 
+bpfj_abc_ngth_t
+ *
+ngth
+)
+
+1231 
+bo
+ 
+rv
+;
+
+1232 
+bpfj_abc_ngth_t
+ 
+width
+ = 0;
+
+1234 
+	`BPF_CLASS
+(
+pc
+->
+code
+)) {
+
+1236 
+rv
+ = 
+l
+;
+
+1239 
+BPF_LD
+:
+
+1240 
+rv
+ = 
+	`BPF_MODE
+(
+pc
+->
+code
+=
+BPF_ABS
+ ||
+
+1241 
+	`BPF_MODE
+(
+pc
+->
+code
+=
+BPF_IND
+;
+
+1242 i(
+rv
+) {
+
+1243 
+width
+ = 
+	`ad_width
+(
+pc
+);
+
+1244 
+rv
+ = (
+width
+ != 0);
+
+1248 
+BPF_LDX
+:
+
+1249 
+rv
+ = 
+	`BPF_MODE
+(
+pc
+->
+code
+=
+BPF_MSH
+ &&
+
+1250 
+	`BPF_SIZE
+(
+pc
+->
+code
+=
+BPF_B
+;
+
+1251 
+width
+ = 1;
+
+1255 i(
+rv
+ && 
+ngth
+ !
+NULL
+) {
+
+1260 *
+ngth
+ = (
+ut32_t
+)
+pc
+->
+k
+ + 
+width
+;
+
+1263  
+rv
+;
+
+1264 
+	}
+}
+
+1267 
+	$timize_
+(
+bpfj__da
+ *
+_d
+, 
+size_t
+ 
+_cou
+)
+
+1269 
+size_t
+ 
+i
+;
+
+1271 
+i
+ = 0; i < 
+_cou
+; i++) {
+
+1272 
+	`SLIST_INIT
+(&
+_d
+[
+i
+].
+bjumps
+);
+
+1273 
+_d
+[
+i
+].
+vid
+ = 
+BJ_INIT_NOBITS
+;
+
+1275 
+	}
+}
+
+1288 
+bo
+
+
+1289 
+	$timize_ss1
+(c 
+bpf_x_t
+ *
+bc
+, c 
+bpf_
+ *
+s
+,
+
+1290 
+bpfj__da
+ *
+_d
+, 
+size_t
+ 
+_cou
+,
+
+1291 
+bpf_memwd__t
+ *
+mask
+, 
+bpfj_ht_t
+ *
+hts
+)
+
+1293 
+bpfj_jump
+ *
+jtf
+;
+
+1294 
+size_t
+ 
+i
+;
+
+1295 
+ut32_t
+ 
+jt
+, 
+jf
+;
+
+1296 
+bpfj_abc_ngth_t
+ 
+ngth
+;
+
+1297 
+bpf_memwd__t
+ 
+vid
+;
+
+1298 
+bo
+ 
+uchab
+;
+
+1300 c 
+size_t
+ 
+memwds
+ = 
+	`GET_MEMWORDS
+(
+bc
+);
+
+1302 *
+hts
+ = 0;
+
+1303 *
+mask
+ = 
+BJ_INIT_NOBITS
+;
+
+1305 
+uchab
+ = 
+l
+;
+
+1306 
+vid
+ = ~
+BJ_INIT_NOBITS
+;
+
+1308 
+i
+ = 0; i < 
+_cou
+; i++) {
+
+1309 i(!
+	`SLIST_EMPTY
+(&
+_d
+[
+i
+].
+bjumps
+))
+
+1310 
+uchab
+ = 
+l
+;
+
+1311 
+_d
+[
+i
+].
+uchab
+ = unreachable;
+
+1313 i(
+uchab
+)
+
+1316 
+vid
+ |
+_d
+[
+i
+].invalid;
+
+1318 i(
+	`ad_pkt_
+(&
+s
+[
+i
+], &
+ngth
+&&gth > 
+UINT32_MAX
+)
+
+1319 
+uchab
+ = 
+ue
+;
+
+1321 
+	`BPF_CLASS
+(
+s
+[
+i
+].
+code
+)) {
+
+1322 
+BPF_RET
+:
+
+1323 i(
+	`BPF_RVAL
+(
+s
+[
+i
+].
+code
+=
+BPF_A
+)
+
+1324 *
+mask
+ |
+vid
+ & 
+BJ_INIT_ABIT
+;
+
+1326 
+uchab
+ = 
+ue
+;
+
+1329 
+BPF_LD
+:
+
+1330 i(
+	`BPF_MODE
+(
+s
+[
+i
+].
+code
+=
+BPF_ABS
+)
+
+1331 *
+hts
+ |
+BJ_HINT_ABS
+;
+
+1333 i(
+	`BPF_MODE
+(
+s
+[
+i
+].
+code
+=
+BPF_IND
+) {
+
+1334 *
+hts
+ |
+BJ_HINT_IND
+ | 
+BJ_HINT_XREG
+;
+
+1335 *
+mask
+ |
+vid
+ & 
+BJ_INIT_XBIT
+;
+
+1338 i(
+	`BPF_MODE
+(
+s
+[
+i
+].
+code
+=
+BPF_MEM
+ &&
+
+1339 (
+ut32_t
+)
+s
+[
+i
+].
+k
+ < 
+memwds
+) {
+
+1340 *
+mask
+ |
+vid
+ & 
+	`BJ_INIT_MBIT
+(
+s
+[
+i
+].
+k
+);
+
+1343 
+vid
+ &~
+BJ_INIT_ABIT
+;
+
+1346 
+BPF_LDX
+:
+
+1347 *
+hts
+ |
+BJ_HINT_XREG
+ | 
+BJ_HINT_LDX
+;
+
+1349 i(
+	`BPF_MODE
+(
+s
+[
+i
+].
+code
+=
+BPF_MEM
+ &&
+
+1350 (
+ut32_t
+)
+s
+[
+i
+].
+k
+ < 
+memwds
+) {
+
+1351 *
+mask
+ |
+vid
+ & 
+	`BJ_INIT_MBIT
+(
+s
+[
+i
+].
+k
+);
+
+1354 i(
+	`BPF_MODE
+(
+s
+[
+i
+].
+code
+=
+BPF_MSH
+ &&
+
+1355 
+	`BPF_SIZE
+(
+s
+[
+i
+].
+code
+=
+BPF_B
+) {
+
+1356 *
+hts
+ |
+BJ_HINT_MSH
+;
+
+1359 
+vid
+ &~
+BJ_INIT_XBIT
+;
+
+1362 
+BPF_ST
+:
+
+1363 *
+mask
+ |
+vid
+ & 
+BJ_INIT_ABIT
+;
+
+1365 i((
+ut32_t
+)
+s
+[
+i
+].
+k
+ < 
+memwds
+)
+
+1366 
+vid
+ &~
+	`BJ_INIT_MBIT
+(
+s
+[
+i
+].
+k
+);
+
+1370 
+BPF_STX
+:
+
+1371 *
+hts
+ |
+BJ_HINT_XREG
+;
+
+1372 *
+mask
+ |
+vid
+ & 
+BJ_INIT_XBIT
+;
+
+1374 i((
+ut32_t
+)
+s
+[
+i
+].
+k
+ < 
+memwds
+)
+
+1375 
+vid
+ &~
+	`BJ_INIT_MBIT
+(
+s
+[
+i
+].
+k
+);
+
+1379 
+BPF_ALU
+:
+
+1380 *
+mask
+ |
+vid
+ & 
+BJ_INIT_ABIT
+;
+
+1382 i(
+s
+[
+i
+].
+code
+ !(
+BPF_ALU
+|
+BPF_NEG
+) &&
+
+1383 
+	`BPF_SRC
+(
+s
+[
+i
+].
+code
+=
+BPF_X
+) {
+
+1384 *
+hts
+ |
+BJ_HINT_XREG
+;
+
+1385 *
+mask
+ |
+vid
+ & 
+BJ_INIT_XBIT
+;
+
+1388 
+vid
+ &~
+BJ_INIT_ABIT
+;
+
+1391 
+BPF_MISC
+:
+
+1392 
+	`BPF_MISCOP
+(
+s
+[
+i
+].
+code
+)) {
+
+1393 
+BPF_TAX
+:
+
+1394 *
+hts
+ |
+BJ_HINT_XREG
+;
+
+1395 *
+mask
+ |
+vid
+ & 
+BJ_INIT_ABIT
+;
+
+1396 
+vid
+ &~
+BJ_INIT_XBIT
+;
+
+1399 
+BPF_TXA
+:
+
+1400 *
+hts
+ |
+BJ_HINT_XREG
+;
+
+1401 *
+mask
+ |
+vid
+ & 
+BJ_INIT_XBIT
+;
+
+1402 
+vid
+ &~
+BJ_INIT_ABIT
+;
+
+1405 
+BPF_COPX
+:
+
+1406 *
+hts
+ |
+BJ_HINT_XREG
+ | 
+BJ_HINT_COPX
+;
+
+1409 
+BPF_COP
+:
+
+1410 *
+hts
+ |
+BJ_HINT_COP
+;
+
+1411 *
+mask
+ |
+vid
+ & 
+BJ_INIT_ABIT
+;
+
+1412 
+vid
+ &~
+BJ_INIT_ABIT
+;
+
+1418 
+BPF_JMP
+:
+
+1420 
+_d
+[
+i
+].
+u
+.
+jda
+.
+abc_ngth
+ = 
+MAX_ABC_LENGTH
+;
+
+1422 *
+mask
+ |
+vid
+ & 
+BJ_INIT_ABIT
+;
+
+1424 i(
+	`BPF_SRC
+(
+s
+[
+i
+].
+code
+=
+BPF_X
+) {
+
+1425 *
+hts
+ |
+BJ_HINT_XREG
+;
+
+1426 *
+mask
+ |
+vid
+ & 
+BJ_INIT_XBIT
+;
+
+1429 i(
+	`BPF_OP
+(
+s
+[
+i
+].
+code
+=
+BPF_JA
+) {
+
+1430 
+jt
+ = 
+jf
+ = 
+s
+[
+i
+].
+k
+;
+
+1432 
+jt
+ = 
+s
+[
+i
+].jt;
+
+1433 
+jf
+ = 
+s
+[
+i
+].jf;
+
+1436 i(
+jt
+ >
+_cou
+ - (
+i
+ + 1) ||
+
+1437 
+jf
+ >
+_cou
+ - (
+i
+ + 1)) {
+
+1438  
+l
+;
+
+1441 i(
+jt
+ > 0 && 
+jf
+ > 0)
+
+1442 
+uchab
+ = 
+ue
+;
+
+1444 
+jt
+ +
+i
+ + 1;
+
+1445 
+jf
+ +
+i
+ + 1;
+
+1447 
+jtf
+ = 
+_d
+[
+i
+].
+u
+.
+jda
+.jtf;
+
+1449 
+jtf
+[0].
+jda
+ = &
+_d
+[
+i
+].
+u
+.jdata;
+
+1450 
+	`SLIST_INSERT_HEAD
+(&
+_d
+[
+jt
+].
+bjumps
+,
+
+1451 &
+jtf
+[0], 
+s
+);
+
+1453 i(
+jf
+ !
+jt
+) {
+
+1454 
+jtf
+[1].
+jda
+ = &
+_d
+[
+i
+].
+u
+.jdata;
+
+1455 
+	`SLIST_INSERT_HEAD
+(&
+_d
+[
+jf
+].
+bjumps
+,
+
+1456 &
+jtf
+[1], 
+s
+);
+
+1459 
+_d
+[
+jf
+].
+vid
+ |= invalid;
+
+1460 
+_d
+[
+jt
+].
+vid
+ |= invalid;
+
+1461 
+vid
+ = 0;
+
+1467  
+ue
+;
+
+1468 
+	}
+}
+
+1474 
+	$timize_ss2
+(c 
+bpf_x_t
+ *
+bc
+, c 
+bpf_
+ *
+s
+,
+
+1475 
+bpfj__da
+ *
+_d
+, 
+size_t
+ 
+_cou
+)
+
+1477 
+bpfj_jump
+ *
+jmp
+;
+
+1478 c 
+bpf_
+ *
+pc
+;
+
+1479 
+bpfj__da
+ *
+pd
+;
+
+1480 
+size_t
+ 
+i
+;
+
+1481 
+bpfj_abc_ngth_t
+ 
+ngth
+, 
+abc_ngth
+ = 0;
+
+1483 c 
+size_t
+ 
+extwds
+ = 
+	`GET_EXTWORDS
+(
+bc
+);
+
+1485 
+i
+ = 
+_cou
+; i != 0; i--) {
+
+1486 
+pc
+ = &
+s
+[
+i
+-1];
+
+1487 
+pd
+ = &
+_d
+[
+i
+-1];
+
+1489 i(
+pd
+->
+uchab
+)
+
+1492 
+	`BPF_CLASS
+(
+pc
+->
+code
+)) {
+
+1493 
+BPF_RET
+:
+
+1511 i(
+	`BPF_RVAL
+(
+pc
+->
+code
+=
+BPF_K
+ &&c->
+k
+ == 0)
+
+1512 
+abc_ngth
+ = 
+MAX_ABC_LENGTH
+;
+
+1514 
+abc_ngth
+ = 0;
+
+1517 
+BPF_MISC
+:
+
+1518 i(
+	`BPF_MISCOP
+(
+pc
+->
+code
+=
+BPF_COP
+ ||
+
+1519 
+	`BPF_MISCOP
+(
+pc
+->
+code
+=
+BPF_COPX
+) {
+
+1521 
+abc_ngth
+ = 0;
+
+1525 
+BPF_ST
+:
+
+1526 
+BPF_STX
+:
+
+1527 i(
+extwds
+ != 0) {
+
+1529 
+abc_ngth
+ = 0;
+
+1533 
+BPF_JMP
+:
+
+1534 
+abc_ngth
+ = 
+pd
+->
+u
+.
+jda
+.abc_length;
+
+1538 i(
+	`ad_pkt_
+(
+pc
+, &
+ngth
+)) {
+
+1539 i(
+abc_ngth
+ < 
+ngth
+)
+
+1540 
+abc_ngth
+ = 
+ngth
+;
+
+1541 
+pd
+->
+u
+.
+rda
+.
+abc_ngth
+ =bc_length;
+
+1546 
+	`SLIST_FOREACH
+(
+jmp
+, &
+pd
+->
+bjumps
+, 
+s
+) {
+
+1547 i(
+jmp
+->
+jda
+->
+abc_ngth
+ >bc_length)
+
+1548 
+jmp
+->
+jda
+->
+abc_ngth
+ =bc_length;
+
+1551 
+	}
+}
+
+1554 
+	$timize_ss3
+(c 
+bpf_
+ *
+s
+,
+
+1555 
+bpfj__da
+ *
+_d
+, 
+size_t
+ 
+_cou
+)
+
+1557 
+bpfj_jump
+ *
+jmp
+;
+
+1558 
+size_t
+ 
+i
+;
+
+1559 
+bpfj_abc_ngth_t
+ 
+checked_ngth
+ = 0;
+
+1561 
+i
+ = 0; i < 
+_cou
+; i++) {
+
+1562 i(
+_d
+[
+i
+].
+uchab
+)
+
+1565 
+	`SLIST_FOREACH
+(
+jmp
+, &
+_d
+[
+i
+].
+bjumps
+, 
+s
+) {
+
+1566 i(
+jmp
+->
+jda
+->
+checked_ngth
+ < checked_length)
+
+1567 
+checked_ngth
+ = 
+jmp
+->
+jda
+->checked_length;
+
+1570 i(
+	`BPF_CLASS
+(
+s
+[
+i
+].
+code
+=
+BPF_JMP
+) {
+
+1571 
+_d
+[
+i
+].
+u
+.
+jda
+.
+checked_ngth
+ = checked_length;
+
+1572 } i(
+	`ad_pkt_
+(&
+s
+[
+i
+], 
+NULL
+)) {
+
+1573 
+bpfj_ad_pkt_da
+ *
+rda
+ =
+
+1574 &
+_d
+[
+i
+].
+u
+.
+rda
+;
+
+1575 
+rda
+->
+check_ngth
+ = 0;
+
+1576 i(
+checked_ngth
+ < 
+rda
+->
+abc_ngth
+) {
+
+1577 
+checked_ngth
+ = 
+rda
+->
+abc_ngth
+;
+
+1578 
+rda
+->
+check_ngth
+ = 
+checked_ngth
+;
+
+1582 
+	}
+}
+
+1584 
+bo
+
+
+1585 
+	$timize
+(c 
+bpf_x_t
+ *
+bc
+, c 
+bpf_
+ *
+s
+,
+
+1586 
+bpfj__da
+ *
+_d
+, 
+size_t
+ 
+_cou
+,
+
+1587 
+bpf_memwd__t
+ *
+mask
+, 
+bpfj_ht_t
+ *
+hts
+)
+
+1590 
+	`timize_
+(
+_d
+, 
+_cou
+);
+
+1592 i(!
+	`timize_ss1
+(
+bc
+, 
+s
+, 
+_d
+, 
+_cou
+, 
+mask
+, 
+hts
+))
+
+1593  
+l
+;
+
+1595 
+	`timize_ss2
+(
+bc
+, 
+s
+, 
+_d
+, 
+_cou
+);
+
+1596 
+	`timize_ss3
+(
+s
+, 
+_d
+, 
+_cou
+);
+
+1598  
+ue
+;
+
+1599 
+	}
+}
+
+1605 
+	$bpf_u_to_j_
+(c 
+bpf_
+ *
+pc
+)
+
+1607 c 
+bad
+ = 
+SLJIT_UNUSED
+;
+
+1608 c 
+ut32_t
+ 
+k
+ = 
+pc
+->k;
+
+1614 
+	`BPF_OP
+(
+pc
+->
+code
+)) {
+
+1615 
+BPF_ADD
+:  
+SLJIT_ADD
+;
+
+1616 
+BPF_SUB
+:  
+SLJIT_SUB
+;
+
+1617 
+BPF_MUL
+:  
+SLJIT_MUL
+|
+SLJIT_INT_OP
+;
+
+1618 
+BPF_OR
+:  
+SLJIT_OR
+;
+
+1619 
+BPF_XOR
+:  
+SLJIT_XOR
+;
+
+1620 
+BPF_AND
+:  
+SLJIT_AND
+;
+
+1621 
+BPF_LSH
+:  (
+k
+ > 31? 
+bad
+ : 
+SLJIT_SHL
+;
+
+1622 
+BPF_RSH
+:  (
+k
+ > 31? 
+bad
+ : 
+SLJIT_LSHR
+|
+SLJIT_INT_OP
+;
+
+1624  
+bad
+;
+
+1626 
+	}
+}
+
+1632 
+	$bpf_jmp_to_j_cd
+(c 
+bpf_
+ *
+pc
+, 
+bo
+ 
+ge
+)
+
+1638 
+rv
+ = 
+SLJIT_INT_OP
+;
+
+1640 
+	`BPF_OP
+(
+pc
+->
+code
+)) {
+
+1641 
+BPF_JGT
+:
+
+1642 
+rv
+ |
+ge
+ ? 
+SLJIT_C_LESS_EQUAL
+ : 
+SLJIT_C_GREATER
+;
+
+1644 
+BPF_JGE
+:
+
+1645 
+rv
+ |
+ge
+ ? 
+SLJIT_C_LESS
+ : 
+SLJIT_C_GREATER_EQUAL
+;
+
+1647 
+BPF_JEQ
+:
+
+1648 
+rv
+ |
+ge
+ ? 
+SLJIT_C_NOT_EQUAL
+ : 
+SLJIT_C_EQUAL
+;
+
+1650 
+BPF_JSET
+:
+
+1651 
+rv
+ |
+ge
+ ? 
+SLJIT_C_EQUAL
+ : 
+SLJIT_C_NOT_EQUAL
+;
+
+1654 
+	`BJ_ASSERT
+(
+l
+);
+
+1657  
+rv
+;
+
+1658 
+	}
+}
+
+1664 
+	$kx_to_g
+(c 
+bpf_
+ *
+pc
+)
+
+1667 
+	`BPF_SRC
+(
+pc
+->
+code
+)) {
+
+1668 
+BPF_K
+:  
+SLJIT_IMM
+;
+
+1669 
+BPF_X
+:  
+BJ_XREG
+;
+
+1671 
+	`BJ_ASSERT
+(
+l
+);
+
+1674 
+	}
+}
+
+1676 
+j_sw
+
+
+1677 
+	$kx_to_g_g
+(c 
+bpf_
+ *
+pc
+)
+
+1680 
+	`BPF_SRC
+(
+pc
+->
+code
+)) {
+
+1681 
+BPF_K
+:  (
+ut32_t
+)
+pc
+->
+k
+;
+
+1682 
+BPF_X
+:  0;
+
+1684 
+	`BJ_ASSERT
+(
+l
+);
+
+1687 
+	}
+}
+
+1689 
+bo
+
+
+1690 
+	$ge__code
+(
+j_comp
+ *
+comp
+, 
+bpfj_ht_t
+ 
+hts
+,
+
+1691 c 
+bpf_x_t
+ *
+bc
+, c 
+bpf_
+ *
+s
+,
+
+1692 
+bpfj__da
+ *
+_d
+, 
+size_t
+ 
+_cou
+)
+
+1695 
+j_jump
+ **
+t0
+;
+
+1696 
+size_t
+ 
+t0_size
+, 
+t0_maxsize
+;
+
+1698 
+j_jump
+ *
+jump
+;
+
+1699 
+j_b
+ *
+b
+;
+
+1700 c 
+bpf_
+ *
+pc
+;
+
+1701 
+bpfj_jump
+ *
+bjump
+, *
+jtf
+;
+
+1702 
+j_jump
+ *
+to_mcha_jump
+;
+
+1704 
+size_t
+ 
+i
+;
+
+1705 
+us
+;
+
+1706 
+bnchg
+, 
+ge
+;
+
+1707 
+rv
+, 
+mode
+, 
+c
+, 
+
+;
+
+1708 
+ut32_t
+ 
+jt
+, 
+jf
+;
+
+1710 
+bo
+ 
+uncdi_t
+;
+
+1711 
+bo
+ 
+rv
+;
+
+1713 c 
+size_t
+ 
+extwds
+ = 
+	`GET_EXTWORDS
+(
+bc
+);
+
+1714 c 
+size_t
+ 
+memwds
+ = 
+	`GET_MEMWORDS
+(
+bc
+);
+
+1716 
+t0
+ = 
+NULL
+;
+
+1717 
+rv
+ = 
+l
+;
+
+1719 
+t0_size
+ = 0;
+
+1720 
+t0_maxsize
+ = 64;
+
+1721 
+t0
+ = 
+	`BJ_ALLOC
+(
+t0_maxsize
+ * (ret0[0]));
+
+1722 i(
+t0
+ =
+NULL
+)
+
+1723 
+
+;
+
+1726 
+i
+ = 0; i < 
+_cou
+; i++) {
+
+1727 i(
+_d
+[
+i
+].
+uchab
+ ||
+
+1728 
+	`BPF_CLASS
+(
+s
+[
+i
+].
+code
+!
+BPF_JMP
+) {
+
+1732 
+jtf
+ = 
+_d
+[
+i
+].
+u
+.
+jda
+.jtf;
+
+1733 
+jtf
+[0].
+sjump
+ = jtf[1].sjum
+NULL
+;
+
+1737 
+i
+ = 0; i < 
+_cou
+; i++) {
+
+1738 i(
+_d
+[
+i
+].
+uchab
+)
+
+1744 
+b
+ = 
+NULL
+;
+
+1745 
+	`SLIST_FOREACH
+(
+bjump
+, &
+_d
+[
+i
+].
+bjumps
+, 
+s
+) {
+
+1746 i(
+bjump
+->
+sjump
+ !
+NULL
+) {
+
+1747 i(
+b
+ =
+NULL
+)
+
+1748 
+b
+ = 
+	`j_em_b
+(
+comp
+);
+
+1749 i(
+b
+ =
+NULL
+)
+
+1750 
+
+;
+
+1751 
+	`j_t_b
+(
+bjump
+->
+sjump
+, 
+b
+);
+
+1755 
+to_mcha_jump
+ = 
+NULL
+;
+
+1756 
+uncdi_t
+ = 
+l
+;
+
+1758 i(
+	`ad_pkt_
+(&
+s
+[
+i
+], 
+NULL
+)) {
+
+1759 i(
+_d
+[
+i
+].
+u
+.
+rda
+.
+check_ngth
+ > 
+UINT32_MAX
+) {
+
+1761 
+uncdi_t
+ = 
+ue
+;
+
+1762 
+jump
+ = 
+	`j_em_jump
+(
+comp
+, 
+SLJIT_JUMP
+);
+
+1763 i(
+jump
+ =
+NULL
+)
+
+1764 
+
+;
+
+1765 i(!
+	`nd_jump
+(
+jump
+, &
+t0
+,
+
+1766 &
+t0_size
+, &
+t0_maxsize
+))
+
+1767 
+
+;
+
+1768 } i(
+_d
+[
+i
+].
+u
+.
+rda
+.
+check_ngth
+ > 0) {
+
+1770 
+jump
+ = 
+	`j_em_cmp
+(
+comp
+,
+
+1771 
+SLJIT_C_LESS
+,
+
+1772 
+BJ_BUFLEN
+, 0,
+
+1773 
+SLJIT_IMM
+,
+
+1774 
+_d
+[
+i
+].
+u
+.
+rda
+.
+check_ngth
+);
+
+1775 i(
+jump
+ =
+NULL
+)
+
+1776 
+
+;
+
+1777 #ifde
+_KERNEL
+
+
+1778 
+to_mcha_jump
+ = 
+jump
+;
+
+1780 i(!
+	`nd_jump
+(
+jump
+, &
+t0
+,
+
+1781 &
+t0_size
+, &
+t0_maxsize
+))
+
+1782 
+
+;
+
+1787 
+pc
+ = &
+s
+[
+i
+];
+
+1788 
+	`BPF_CLASS
+(
+pc
+->
+code
+)) {
+
+1791 
+
+;
+
+1793 
+BPF_LD
+:
+
+1795 i(
+pc
+->
+code
+ =(
+BPF_LD
+|
+BPF_IMM
+)) {
+
+1796 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+1797 
+SLJIT_MOV
+,
+
+1798 
+BJ_AREG
+, 0,
+
+1799 
+SLJIT_IMM
+, (
+ut32_t
+)
+pc
+->
+k
+);
+
+1800 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1801 
+
+;
+
+1807 i(
+pc
+->
+code
+ =(
+BPF_LD
+|
+BPF_MEM
+)) {
+
+1808 i((
+ut32_t
+)
+pc
+->
+k
+ >
+memwds
+)
+
+1809 
+
+;
+
+1810 
+us
+ = 
+	`em_memld
+(
+comp
+,
+
+1811 
+BJ_AREG
+, 
+pc
+->
+k
+, 
+extwds
+);
+
+1812 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1813 
+
+;
+
+1819 i(
+pc
+->
+code
+ =(
+BPF_LD
+|
+BPF_W
+|
+BPF_LEN
+)) {
+
+1820 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+1821 
+SLJIT_MOV
+,
+
+1822 
+BJ_AREG
+, 0,
+
+1823 
+	`SLJIT_MEM1
+(
+BJ_ARGS
+),
+
+1824 
+	`offtof
+(
+bpf_gs
+, 
+w
+));
+
+1825 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1826 
+
+;
+
+1831 
+mode
+ = 
+	`BPF_MODE
+(
+pc
+->
+code
+);
+
+1832 i(
+mode
+ !
+BPF_ABS
+ && mod!
+BPF_IND
+)
+
+1833 
+
+;
+
+1835 i(
+uncdi_t
+)
+
+1838 
+us
+ = 
+	`em_pkt_ad
+(
+comp
+, 
+hts
+, 
+pc
+,
+
+1839 
+to_mcha_jump
+, &
+t0
+, &
+t0_size
+, &
+t0_maxsize
+);
+
+1840 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1841 
+
+;
+
+1845 
+BPF_LDX
+:
+
+1846 
+mode
+ = 
+	`BPF_MODE
+(
+pc
+->
+code
+);
+
+1849 i(
+mode
+ =
+BPF_IMM
+) {
+
+1850 i(
+	`BPF_SIZE
+(
+pc
+->
+code
+!
+BPF_W
+)
+
+1851 
+
+;
+
+1852 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+1853 
+SLJIT_MOV
+,
+
+1854 
+BJ_XREG
+, 0,
+
+1855 
+SLJIT_IMM
+, (
+ut32_t
+)
+pc
+->
+k
+);
+
+1856 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1857 
+
+;
+
+1863 i(
+mode
+ =
+BPF_LEN
+) {
+
+1864 i(
+	`BPF_SIZE
+(
+pc
+->
+code
+!
+BPF_W
+)
+
+1865 
+
+;
+
+1866 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+1867 
+SLJIT_MOV
+,
+
+1868 
+BJ_XREG
+, 0,
+
+1869 
+	`SLJIT_MEM1
+(
+BJ_ARGS
+),
+
+1870 
+	`offtof
+(
+bpf_gs
+, 
+w
+));
+
+1871 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1872 
+
+;
+
+1878 i(
+mode
+ =
+BPF_MEM
+) {
+
+1879 i(
+	`BPF_SIZE
+(
+pc
+->
+code
+!
+BPF_W
+)
+
+1880 
+
+;
+
+1881 i((
+ut32_t
+)
+pc
+->
+k
+ >
+memwds
+)
+
+1882 
+
+;
+
+1883 
+us
+ = 
+	`em_memld
+(
+comp
+,
+
+1884 
+BJ_XREG
+, 
+pc
+->
+k
+, 
+extwds
+);
+
+1885 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1886 
+
+;
+
+1892 i(
+mode
+ !
+BPF_MSH
+ || 
+	`BPF_SIZE
+(
+pc
+->
+code
+!
+BPF_B
+)
+
+1893 
+
+;
+
+1895 i(
+uncdi_t
+)
+
+1898 
+us
+ = 
+	`em_msh
+(
+comp
+, 
+hts
+, 
+pc
+,
+
+1899 
+to_mcha_jump
+, &
+t0
+, &
+t0_size
+, &
+t0_maxsize
+);
+
+1900 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1901 
+
+;
+
+1905 
+BPF_ST
+:
+
+1906 i(
+pc
+->
+code
+ !
+BPF_ST
+ ||
+
+1907 (
+ut32_t
+)
+pc
+->
+k
+ >
+memwds
+) {
+
+1908 
+
+;
+
+1911 
+us
+ = 
+	`em_meme
+(
+comp
+,
+
+1912 
+BJ_AREG
+, 
+pc
+->
+k
+, 
+extwds
+);
+
+1913 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1914 
+
+;
+
+1918 
+BPF_STX
+:
+
+1919 i(
+pc
+->
+code
+ !
+BPF_STX
+ ||
+
+1920 (
+ut32_t
+)
+pc
+->
+k
+ >
+memwds
+) {
+
+1921 
+
+;
+
+1924 
+us
+ = 
+	`em_meme
+(
+comp
+,
+
+1925 
+BJ_XREG
+, 
+pc
+->
+k
+, 
+extwds
+);
+
+1926 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1927 
+
+;
+
+1931 
+BPF_ALU
+:
+
+1932 i(
+pc
+->
+code
+ =(
+BPF_ALU
+|
+BPF_NEG
+)) {
+
+1933 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+1934 
+SLJIT_NEG
+,
+
+1935 
+BJ_AREG
+, 0,
+
+1936 
+BJ_AREG
+, 0);
+
+1937 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1938 
+
+;
+
+1943 
+
+ = 
+	`BPF_OP
+(
+pc
+->
+code
+);
+
+1944 i(
+
+ !
+BPF_DIV
+ && o!
+BPF_MOD
+) {
+
+1945 c 
+2
+ = 
+	`bpf_u_to_j_
+(
+pc
+);
+
+1947 i(
+2
+ =
+SLJIT_UNUSED
+)
+
+1948 
+
+;
+
+1949 
+us
+ = 
+	`j_em_2
+(
+comp
+,
+
+1950 
+2
+, 
+BJ_AREG
+, 0, BJ_AREG, 0,
+
+1951 
+	`kx_to_g
+(
+pc
+), 
+	`kx_to_g_g
+(pc));
+
+1952 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1953 
+
+;
+
+1960 
+c
+ = 
+	`BPF_SRC
+(
+pc
+->
+code
+);
+
+1961 i(
+c
+ !
+BPF_X
+ && sr!
+BPF_K
+)
+
+1962 
+
+;
+
+1965 i(
+c
+ =
+BPF_X
+) {
+
+1966 
+jump
+ = 
+	`j_em_cmp
+(
+comp
+,
+
+1967 
+SLJIT_C_EQUAL
+|
+SLJIT_INT_OP
+,
+
+1968 
+BJ_XREG
+, 0,
+
+1969 
+SLJIT_IMM
+, 0);
+
+1970 i(
+jump
+ =
+NULL
+)
+
+1971 
+
+;
+
+1972 i(!
+	`nd_jump
+(
+jump
+, &
+t0
+,
+
+1973 &
+t0_size
+, &
+t0_maxsize
+))
+
+1974 
+
+;
+
+1975 } i(
+pc
+->
+k
+ == 0) {
+
+1976 
+jump
+ = 
+	`j_em_jump
+(
+comp
+, 
+SLJIT_JUMP
+);
+
+1977 i(
+jump
+ =
+NULL
+)
+
+1978 
+
+;
+
+1979 i(!
+	`nd_jump
+(
+jump
+, &
+t0
+,
+
+1980 &
+t0_size
+, &
+t0_maxsize
+))
+
+1981 
+
+;
+
+1984 i(
+c
+ =
+BPF_X
+) {
+
+1985 
+us
+ = 
+	`em_moddiv
+(
+comp
+, 
+pc
+);
+
+1986 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1987 
+
+;
+
+1988 } i(
+pc
+->
+k
+ != 0) {
+
+1989 i(
+pc
+->
+k
+ & (pc->k - 1)) {
+
+1990 
+us
+ = 
+	`em_moddiv
+(
+comp
+, 
+pc
+);
+
+1992 
+us
+ = 
+	`em_pow2_moddiv
+(
+comp
+, 
+pc
+);
+
+1994 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+1995 
+
+;
+
+2000 
+BPF_JMP
+:
+
+2001 
+
+ = 
+	`BPF_OP
+(
+pc
+->
+code
+);
+
+2002 i(
+
+ =
+BPF_JA
+) {
+
+2003 
+jt
+ = 
+jf
+ = 
+pc
+->
+k
+;
+
+2005 
+jt
+ = 
+pc
+->jt;
+
+2006 
+jf
+ = 
+pc
+->jf;
+
+2009 
+ge
+ = (
+jt
+ == 0) ? 1 : 0;
+
+2010 
+bnchg
+ = (
+jt
+ =
+jf
+) ? 0 : 1;
+
+2011 
+jtf
+ = 
+_d
+[
+i
+].
+u
+.
+jda
+.jtf;
+
+2013 i(
+bnchg
+) {
+
+2014 i(
+
+ !
+BPF_JSET
+) {
+
+2015 
+jump
+ = 
+	`j_em_cmp
+(
+comp
+,
+
+2016 
+	`bpf_jmp_to_j_cd
+(
+pc
+, 
+ge
+),
+
+2017 
+BJ_AREG
+, 0,
+
+2018 
+	`kx_to_g
+(
+pc
+), 
+	`kx_to_g_g
+(pc));
+
+2020 
+us
+ = 
+	`j_em_2
+(
+comp
+,
+
+2021 
+SLJIT_AND
+,
+
+2022 
+BJ_TMP1REG
+, 0,
+
+2023 
+BJ_AREG
+, 0,
+
+2024 
+	`kx_to_g
+(
+pc
+), 
+	`kx_to_g_g
+(pc));
+
+2025 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+2026 
+
+;
+
+2028 
+jump
+ = 
+	`j_em_cmp
+(
+comp
+,
+
+2029 
+	`bpf_jmp_to_j_cd
+(
+pc
+, 
+ge
+),
+
+2030 
+BJ_TMP1REG
+, 0,
+
+2031 
+SLJIT_IMM
+, 0);
+
+2034 i(
+jump
+ =
+NULL
+)
+
+2035 
+
+;
+
+2037 
+	`BJ_ASSERT
+(
+jtf
+[
+ge
+].
+sjump
+ =
+NULL
+);
+
+2038 
+jtf
+[
+ge
+].
+sjump
+ = 
+jump
+;
+
+2041 i(!
+bnchg
+ || (
+jt
+ !0 && 
+jf
+ != 0)) {
+
+2042 
+jump
+ = 
+	`j_em_jump
+(
+comp
+, 
+SLJIT_JUMP
+);
+
+2043 i(
+jump
+ =
+NULL
+)
+
+2044 
+
+;
+
+2046 
+	`BJ_ASSERT
+(
+jtf
+[
+bnchg
+].
+sjump
+ =
+NULL
+);
+
+2047 
+jtf
+[
+bnchg
+].
+sjump
+ = 
+jump
+;
+
+2052 
+BPF_RET
+:
+
+2053 
+rv
+ = 
+	`BPF_RVAL
+(
+pc
+->
+code
+);
+
+2054 i(
+rv
+ =
+BPF_X
+)
+
+2055 
+
+;
+
+2058 i(
+rv
+ =
+BPF_K
+) {
+
+2059 
+us
+ = 
+	`j_em_tu
+(
+comp
+,
+
+2060 
+SLJIT_MOV_UI
+,
+
+2061 
+SLJIT_IMM
+, (
+ut32_t
+)
+pc
+->
+k
+);
+
+2062 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+2063 
+
+;
+
+2067 i(
+rv
+ =
+BPF_A
+) {
+
+2068 
+us
+ = 
+	`j_em_tu
+(
+comp
+,
+
+2069 
+SLJIT_MOV_UI
+,
+
+2070 
+BJ_AREG
+, 0);
+
+2071 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+2072 
+
+;
+
+2077 
+BPF_MISC
+:
+
+2078 
+	`BPF_MISCOP
+(
+pc
+->
+code
+)) {
+
+2079 
+BPF_TAX
+:
+
+2080 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+2081 
+SLJIT_MOV_UI
+,
+
+2082 
+BJ_XREG
+, 0,
+
+2083 
+BJ_AREG
+, 0);
+
+2084 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+2085 
+
+;
+
+2089 
+BPF_TXA
+:
+
+2090 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+2091 
+SLJIT_MOV
+,
+
+2092 
+BJ_AREG
+, 0,
+
+2093 
+BJ_XREG
+, 0);
+
+2094 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+2095 
+
+;
+
+2099 
+BPF_COP
+:
+
+2100 
+BPF_COPX
+:
+
+2101 i(
+bc
+ =
+NULL
+ || bc->
+cfuncs
+ == NULL)
+
+2102 
+
+;
+
+2103 i(
+	`BPF_MISCOP
+(
+pc
+->
+code
+=
+BPF_COP
+ &&
+
+2104 (
+ut32_t
+)
+pc
+->
+k
+ >
+bc
+->
+nfuncs
+) {
+
+2105 
+
+;
+
+2108 
+us
+ = 
+	`em_c
+(
+comp
+, 
+hts
+, 
+bc
+, 
+pc
+,
+
+2109 &
+t0
+, &
+t0_size
+, &
+t0_maxsize
+);
+
+2110 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+2111 
+
+;
+
+2116 
+
+;
+
+2120 
+	`BJ_ASSERT
+(
+t0_size
+ <
+t0_maxsize
+);
+
+2122 i(
+t0_size
+ > 0) {
+
+2123 
+b
+ = 
+	`j_em_b
+(
+comp
+);
+
+2124 i(
+b
+ =
+NULL
+)
+
+2125 
+
+;
+
+2126 
+i
+ = 0; i < 
+t0_size
+; i++)
+
+2127 
+	`j_t_b
+(
+t0
+[
+i
+], 
+b
+);
+
+2130 
+us
+ = 
+	`j_em_tu
+(
+comp
+,
+
+2131 
+SLJIT_MOV_UI
+,
+
+2132 
+SLJIT_IMM
+, 0);
+
+2133 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+2134 
+
+;
+
+2136 
+rv
+ = 
+ue
+;
+
+2138 
+
+:
+
+2139 i(
+t0
+ !
+NULL
+)
+
+2140 
+	`BJ_FREE
+(
+t0
+, 
+t0_maxsize
+ * (ret0[0]));
+
+2142  
+rv
+;
+
+2143 
+	}
+}
+
+2145 
+bpfj_func_t
+
+
+2146 
+	$bpfj_ge_code
+(c 
+bpf_x_t
+ *
+bc
+,
+
+2147 c 
+bpf_
+ *
+s
+, 
+size_t
+ 
+_cou
+)
+
+2149 *
+rv
+;
+
+2150 
+j_comp
+ *
+comp
+;
+
+2152 
+size_t
+ 
+i
+;
+
+2153 
+us
+;
+
+2156 
+bpf_memwd__t
+ 
+mask
+;
+
+2157 
+bpfj_ht_t
+ 
+hts
+;
+
+2160 
+j_si
+ 
+mem_g
+;
+
+2161 
+j_sw
+ 
+mem_off
+;
+
+2163 
+bpfj__da
+ *
+_d
+;
+
+2165 c 
+size_t
+ 
+extwds
+ = 
+	`GET_EXTWORDS
+(
+bc
+);
+
+2166 c 
+size_t
+ 
+memwds
+ = 
+	`GET_MEMWORDS
+(
+bc
+);
+
+2167 c 
+bpf_memwd__t
+ 
+eed
+ = 
+extwds
+ ? 
+bc
+->preinited : 0;
+
+2169 
+rv
+ = 
+NULL
+;
+
+2170 
+comp
+ = 
+NULL
+;
+
+2171 
+_d
+ = 
+NULL
+;
+
+2173 i(
+memwds
+ > 
+MAX_MEMWORDS
+)
+
+2174 
+
+;
+
+2176 i(
+_cou
+ =0 || in_cou > 
+SIZE_MAX
+ / (
+_d
+[0]))
+
+2177 
+
+;
+
+2179 
+_d
+ = 
+	`BJ_ALLOC
+(
+_cou
+ * (insn_dat[0]));
+
+2180 i(
+_d
+ =
+NULL
+)
+
+2181 
+
+;
+
+2183 i(!
+	`timize
+(
+bc
+, 
+s
+, 
+_d
+, 
+_cou
+, &
+mask
+, &
+hts
+))
+
+2184 
+
+;
+
+2186 
+comp
+ = 
+	`j__comp
+();
+
+2187 i(
+comp
+ =
+NULL
+)
+
+2188 
+
+;
+
+2190 #i!
+	`defed
+(
+_KERNEL
+&& defed(
+SLJIT_VERBOSE
+) && SLJIT_VERBOSE
+
+2191 
+	`j_comp_vbo
+(
+comp
+, 
+dr
+);
+
+2194 
+us
+ = 
+	`j_em_r
+(
+comp
+,
+
+2195 2, 
+	`nsches
+(
+hts
+), 
+	`nveds
+(hts), (
+bpfj_ack
+));
+
+2196 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+2197 
+
+;
+
+2199 i(
+hts
+ & 
+BJ_HINT_COP
+) {
+
+2201 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+2202 
+SLJIT_MOV_P
+,
+
+2203 
+	`SLJIT_MEM1
+(
+SLJIT_LOCALS_REG
+),
+
+2204 
+	`offtof
+(
+bpfj_ack
+, 
+x
+),
+
+2205 
+BJ_CTX_ARG
+, 0);
+
+2206 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+2207 
+
+;
+
+2210 i(
+extwds
+ == 0) {
+
+2211 
+mem_g
+ = 
+	`SLJIT_MEM1
+(
+SLJIT_LOCALS_REG
+);
+
+2212 
+mem_off
+ = 
+	`offtof
+(
+bpfj_ack
+, 
+mem
+);
+
+2215 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+2216 
+SLJIT_MOV_P
+,
+
+2217 
+BJ_TMP1REG
+, 0,
+
+2218 
+	`SLJIT_MEM1
+(
+BJ_ARGS
+), 
+	`offtof
+(
+bpf_gs
+, 
+mem
+));
+
+2219 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+2220 
+
+;
+
+2222 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+2223 
+SLJIT_MOV_P
+,
+
+2224 
+	`SLJIT_MEM1
+(
+SLJIT_LOCALS_REG
+),
+
+2225 
+	`offtof
+(
+bpfj_ack
+, 
+extmem
+),
+
+2226 
+BJ_TMP1REG
+, 0);
+
+2227 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+2228 
+
+;
+
+2230 
+mem_g
+ = 
+	`SLJIT_MEM1
+(
+BJ_TMP1REG
+);
+
+2231 
+mem_off
+ = 0;
+
+2239 
+mask
+ &~
+eed
+ | 
+BJ_INIT_ABIT
+ | 
+BJ_INIT_XBIT
+;
+
+2241 #i
+	`defed
+(
+_KERNEL
+)
+
+2243 
+	`BJ_ASSERT
+((
+mask
+ & (
+	`BJ_INIT_MBIT
+(
+memwds
+) - 1)) == 0);
+
+2245 
+i
+ = 0; i < 
+memwds
+; i++) {
+
+2246 i(
+mask
+ & 
+	`BJ_INIT_MBIT
+(
+i
+)) {
+
+2248 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+2249 
+SLJIT_MOV_UI
+,
+
+2250 
+mem_g
+, 
+mem_off
+ + 
+i
+ * (
+ut32_t
+),
+
+2251 
+SLJIT_IMM
+, 0);
+
+2252 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+2253 
+
+;
+
+2257 i(
+mask
+ & 
+BJ_INIT_ABIT
+) {
+
+2259 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+2260 
+SLJIT_MOV
+,
+
+2261 
+BJ_AREG
+, 0,
+
+2262 
+SLJIT_IMM
+, 0);
+
+2263 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+2264 
+
+;
+
+2267 i(
+mask
+ & 
+BJ_INIT_XBIT
+) {
+
+2269 
+us
+ = 
+	`j_em_1
+(
+comp
+,
+
+2270 
+SLJIT_MOV
+,
+
+2271 
+BJ_XREG
+, 0,
+
+2272 
+SLJIT_IMM
+, 0);
+
+2273 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+2274 
+
+;
+
+2277 
+us
+ = 
+	`ld_buf_bu
+(
+comp
+);
+
+2278 i(
+us
+ !
+SLJIT_SUCCESS
+)
+
+2279 
+
+;
+
+2281 i(!
+	`ge__code
+(
+comp
+, 
+hts
+,
+
+2282 
+bc
+, 
+s
+, 
+_d
+, 
+_cou
+)) {
+
+2283 
+
+;
+
+2286 
+rv
+ = 
+	`j_ge_code
+(
+comp
+);
+
+2288 
+
+:
+
+2289 i(
+comp
+ !
+NULL
+)
+
+2290 
+	`j__comp
+(
+comp
+);
+
+2292 i(
+_d
+ !
+NULL
+)
+
+2293 
+	`BJ_FREE
+(
+_d
+, 
+_cou
+ * (insn_dat[0]));
+
+2295  (
+bpfj_func_t
+)
+rv
+;
+
+2296 
+	}
+}
+
+2299 
+	$bpfj__code
+(
+bpfj_func_t
+ 
+code
+)
+
+2302 
+	`j__code
+((*)
+code
+);
+
+2303 
+	}
+}
+
+	@bpfjit.h
+
+32 #ide
+_NET_BPFJIT_H_
+
+
+33 
+	#_NET_BPFJIT_H_
+
+
+	)
+
+35 #ide
+_KERNEL
+
+
+36 
+	~<ddef.h
+>
+
+37 
+	~<dt.h
+>
+
+40 
+	~<sys/tys.h
+>
+
+42 #ifde
+__lux
+
+
+43 
+	~<pp-bpf.h
+>
+
+45 
+	~<t/bpf.h
+>
+
+55 (*
+	tbpfj_func_t
+)(c 
+	tbpf_x_t
+ *, 
+	tbpf_gs_t
+ *);
+
+57 
+bpfj_func_t
+ 
+	`bpfj_ge_code
+(c 
+bpf_x_t
+ *,
+
+58 c 
+bpf_
+ *, 
+size_t
+);
+
+59 
+	`bpfj__code
+(
+bpfj_func_t
+);
+
+61 #ifde
+_KERNEL
+
+
+62 
+	sbpfj_s
+ {
+
+63 
+	`bpfj_func_t
+ (*
+bj_ge_code
+)(c 
+bpf_x_t
+ *,
+
+64 c 
+bpf_
+ *, 
+size_t
+);
+
+65 (*
+bj__code
+)(
+bpfj_func_t
+);
+
+68 
+bpfj_s
+ 
+bpfj_modu_s
+;
+
+	@bridgestp.c
+
+42 
+	~<sys/cdefs.h
+>
+
+43 
+__KERNEL_RCSID
+(0, "$NetBSD: bridgestp.c,v 1.18 2014/12/31 17:36:24 ozaki-r Exp $");
+
+45 
+	~<sys/m.h
+>
+
+46 
+	~<sys/sym.h
+>
+
+47 
+	~<sys/mbuf.h
+>
+
+48 
+	~<sys/sock.h
+>
+
+49 
+	~<sys/iol.h
+>
+
+50 
+	~<sys/devi.h
+>
+
+51 
+	~<sys/kl.h
+>
+
+52 
+	~<sys/out.h
+>
+
+54 
+	~<t/if.h
+>
+
+55 
+	~<t/if_dl.h
+>
+
+56 
+	~<t/if_tys.h
+>
+
+57 
+	~<t/if_c.h
+>
+
+59 
+	~<t/if_h.h
+>
+
+60 
+	~<t/if_bridgev.h
+>
+
+63 
+	#BSTP_MSGTYPE_CFG
+ 0x00
+
+	)
+
+64 
+	#BSTP_MSGTYPE_TCN
+ 0x80
+
+	)
+
+67 
+	#BSTP_FLAG_TC
+ 0x01
+
+	)
+
+68 
+	#BSTP_FLAG_TCA
+ 0x80
+
+	)
+
+70 
+	#BSTP_MESSAGE_AGE_INCR
+ (1 * 256
+
+	)
+
+71 
+	#BSTP_TICK_VAL
+ (1 * 256
+
+	)
+
+80 
+	sbp_cbpdu
+ {
+
+81 
+ut8_t
+ 
+	mcbu_dp
+;
+
+82 
+ut8_t
+ 
+	mcbu_sp
+;
+
+83 
+ut8_t
+ 
+	mcbu_l
+;
+
+84 
+ut16_t
+ 
+	mcbu_oid
+;
+
+85 
+ut8_t
+ 
+	mcbu_ov
+;
+
+86 
+ut8_t
+ 
+	mcbu_bpduty
+;
+
+87 
+ut8_t
+ 
+	mcbu_ags
+;
+
+90 
+ut16_t
+ 
+	mcbu_roi
+;
+
+91 
+ut8_t
+ 
+	mcbu_roaddr
+[6];
+
+93 
+ut32_t
+ 
+	mcbu_rothco
+;
+
+96 
+ut16_t
+ 
+	mcbu_bridgri
+;
+
+97 
+ut8_t
+ 
+	mcbu_bridgddr
+[6];
+
+99 
+ut16_t
+ 
+	mcbu_ptid
+;
+
+100 
+ut16_t
+ 
+	mcbu_mesgge
+;
+
+101 
+ut16_t
+ 
+	mcbu_maxage
+;
+
+102 
+ut16_t
+ 
+	mcbu_hlime
+;
+
+103 
+ut16_t
+ 
+	mcbu_fwdday
+;
+
+104 } 
+	g__cked
+;
+
+107 
+	sbp_tbpdu
+ {
+
+108 
+ut8_t
+ 
+	mtbu_dp
+;
+
+109 
+ut8_t
+ 
+	mtbu_sp
+;
+
+110 
+ut8_t
+ 
+	mtbu_l
+;
+
+111 
+ut16_t
+ 
+	mtbu_oid
+;
+
+112 
+ut8_t
+ 
+	mtbu_ov
+;
+
+113 
+ut8_t
+ 
+	mtbu_bpduty
+;
+
+114 } 
+	g__cked
+;
+
+116 c 
+ut8_t
+ 
+	gbp_haddr
+[] = { 0x01, 0x80, 0xc2, 0x00, 0x00, 0x00 };
+
+118 
+bp_lize_pt
+(
+bridge_soc
+ *, 
+bridge_ii
+ *);
+
+119 
+bp_ifupdus
+(
+bridge_soc
+ *, 
+bridge_ii
+ *);
+
+120 
+bp_ab_pt
+(
+bridge_soc
+ *, 
+bridge_ii
+ *);
+
+121 
+bp_dib_pt
+(
+bridge_soc
+ *, 
+bridge_ii
+ *);
+
+122 
+bp_ro_bridge
+(
+bridge_soc
+ *
+sc
+);
+
+123 
+bp_surdes_pt_fo
+(
+bridge_soc
+ *,
+
+124 
+bridge_ii
+ *,
+
+125 
+bp_cfig_un
+ *);
+
+126 
+bp_desigd_pt
+(
+bridge_soc
+ *, 
+bridge_ii
+ *);
+
+127 
+bp_desigd_f_some_pt
+(
+bridge_soc
+ *);
+
+128 
+bp_sm_cfig
+(
+bridge_soc
+ *, 
+bridge_ii
+ *);
+
+129 
+bp_sm_t
+(
+bridge_soc
+ *);
+
+130 
+bp_ived_cfig_bpdu
+(
+bridge_soc
+ *,
+
+131 
+bridge_ii
+ *,
+
+132 
+bp_cfig_un
+ *);
+
+133 
+bp_ived_t_bpdu
+(
+bridge_soc
+ *, 
+bridge_ii
+ *,
+
+134 
+bp_t_un
+ *);
+
+135 
+bp_cd_cfig_fmi
+(
+bridge_soc
+ *,
+
+136 
+bridge_ii
+ *,
+
+137 
+bp_cfig_un
+ *);
+
+138 
+bp_cd_cfig_timeout_vues
+(
+bridge_soc
+ *,
+
+139 
+bp_cfig_un
+ *);
+
+140 
+bp_cfig_bpdu_gi
+(
+bridge_soc
+ *);
+
+141 
+bp_nd_cfig_bpdu
+(
+bridge_soc
+ *, 
+bridge_ii
+ *,
+
+142 
+bp_cfig_un
+ *);
+
+143 
+bp_cfiguti_upde
+(
+bridge_soc
+ *);
+
+144 
+bp_ro_i
+(
+bridge_soc
+ *);
+
+145 
+bp_desigd_pt_i
+(
+bridge_soc
+ *);
+
+146 
+bp_become_desigd_pt
+(
+bridge_soc
+ *,
+
+147 
+bridge_ii
+ *);
+
+148 
+bp_pt_e_i
+(
+bridge_soc
+ *);
+
+149 
+bp_make_fwdg
+(
+bridge_soc
+ *, 
+bridge_ii
+ *);
+
+150 
+bp_make_blockg
+(
+bridge_soc
+ *, 
+bridge_ii
+ *);
+
+151 
+bp_t_pt_e
+(
+bridge_ii
+ *, 
+ut8_t
+);
+
+152 #i
+nud
+
+
+153 
+bp_t_bridge_iy
+(
+bridge_soc
+ *, 
+ut64_t
+);
+
+154 
+bp_t_pt_iy
+(
+bridge_soc
+ *, 
+bridge_ii
+ *,
+
+155 
+ut16_t
+);
+
+156 
+bp_t_th_co
+(
+bridge_soc
+ *, 
+bridge_ii
+ *,
+
+157 
+ut32_t
+);
+
+159 
+bp_togy_chge_dei
+(
+bridge_soc
+ *);
+
+160 
+bp_togy_chge_acknowdged
+(
+bridge_soc
+ *);
+
+161 
+bp_acknowdge_togy_chge
+(
+bridge_soc
+ *,
+
+162 
+bridge_ii
+ *);
+
+164 
+bp_tick
+(*);
+
+165 
+bp_tim_t
+(
+bridge_tim
+ *, 
+ut16_t
+);
+
+166 
+bp_tim_
+(
+bridge_tim
+ *);
+
+167 
+bp_tim_exped
+(
+bridge_tim
+ *, 
+ut16_t
+);
+
+169 
+bp_hd_tim_expy
+(
+bridge_soc
+ *, 
+bridge_ii
+ *);
+
+170 
+bp_mesge_age_tim_expy
+(
+bridge_soc
+ *,
+
+171 
+bridge_ii
+ *);
+
+172 
+bp_fwd_day_tim_expy
+(
+bridge_soc
+ *,
+
+173 
+bridge_ii
+ *);
+
+174 
+bp_togy_chge_tim_expy
+(
+bridge_soc
+ *);
+
+175 
+bp_t_tim_expy
+(
+bridge_soc
+ *);
+
+176 
+bp_hlo_tim_expy
+(
+bridge_soc
+ *);
+
+179 
+	$bp_sm_cfig
+(
+bridge_soc
+ *
+sc
+, 
+bridge_ii
+ *
+bif
+)
+
+181 i(
+bif
+->
+bif_hd_tim
+.
+aive
+) {
+
+182 
+bif
+->
+bif_cfig_ndg
+ = 1;
+
+186 
+bif
+->
+bif_cfig_bpdu
+.
+cu_mesge_ty
+ = 
+BSTP_MSGTYPE_CFG
+;
+
+187 
+bif
+->
+bif_cfig_bpdu
+.
+cu_roid
+ = 
+sc
+->
+sc_desigd_ro
+;
+
+188 
+bif
+->
+bif_cfig_bpdu
+.
+cu_ro_th_co
+ = 
+sc
+->
+sc_ro_th_co
+;
+
+189 
+bif
+->
+bif_cfig_bpdu
+.
+cu_bridge_id
+ = 
+sc
+->
+sc_bridge_id
+;
+
+190 
+bif
+->
+bif_cfig_bpdu
+.
+cu_pt_id
+ = bif->
+bif_pt_id
+;
+
+192 i(
+	`bp_ro_bridge
+(
+sc
+))
+
+193 
+bif
+->
+bif_cfig_bpdu
+.
+cu_mesge_age
+ = 0;
+
+195 
+bif
+->
+bif_cfig_bpdu
+.
+cu_mesge_age
+ =
+
+196 
+sc
+->
+sc_ro_pt
+->
+bif_mesge_age_tim
+.
+vue
+ +
+
+197 
+BSTP_MESSAGE_AGE_INCR
+;
+
+199 
+bif
+->
+bif_cfig_bpdu
+.
+cu_max_age
+ = 
+sc
+->
+sc_max_age
+;
+
+200 
+bif
+->
+bif_cfig_bpdu
+.
+cu_hlo_time
+ = 
+sc
+->
+sc_hlo_time
+;
+
+201 
+bif
+->
+bif_cfig_bpdu
+.
+cu_fwd_day
+ = 
+sc
+->
+sc_fwd_day
+;
+
+202 
+bif
+->
+bif_cfig_bpdu
+.
+cu_togy_chge_acknowdgmt
+
+
+203 
+bif
+->
+bif_togy_chge_acknowdge
+;
+
+204 
+bif
+->
+bif_cfig_bpdu
+.
+cu_togy_chge
+ = 
+sc
+->
+sc_togy_chge
+;
+
+206 i(
+bif
+->
+bif_cfig_bpdu
+.
+cu_mesge_age
+ < 
+sc
+->
+sc_max_age
+) {
+
+207 
+bif
+->
+bif_togy_chge_acknowdge
+ = 0;
+
+208 
+bif
+->
+bif_cfig_ndg
+ = 0;
+
+209 
+	`bp_nd_cfig_bpdu
+(
+sc
+, 
+bif
+, &bif->
+bif_cfig_bpdu
+);
+
+210 
+	`bp_tim_t
+(&
+bif
+->
+bif_hd_tim
+, 0);
+
+212 
+	}
+}
+
+215 
+	$bp_nd_cfig_bpdu
+(
+bridge_soc
+ *
+sc
+, 
+bridge_ii
+ *
+bif
+,
+
+216 
+bp_cfig_un
+ *
+cu
+)
+
+218 
+i
+ *
+i
+;
+
+219 
+mbuf
+ *
+m
+;
+
+220 
+h_hd
+ *
+eh
+;
+
+221 
+bp_cbpdu
+ 
+bpdu
+;
+
+222 
+s
+;
+
+224 
+	`KASSERT
+(
+	`BRIDGE_INTR_LOCKED
+(
+sc
+));
+
+226 
+i
+ = 
+bif
+->
+bif_i
+;
+
+228 i((
+i
+->
+if_ags
+ & 
+IFF_RUNNING
+) == 0)
+
+231 
+	`MGETHDR
+(
+m
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+232 i(
+m
+ =
+NULL
+)
+
+235 
+eh
+ = 
+	`mtod
+(
+m
+, 
+h_hd
+ *);
+
+237 
+m
+->
+m_pkthdr
+.
+rcvif
+ = 
+i
+;
+
+238 
+m
+->
+m_pkthdr
+.
+n
+ = (*
+eh
++ (
+bpdu
+);
+
+239 
+m
+->
+m_n
+ = m->
+m_pkthdr
+.
+n
+;
+
+241 
+bpdu
+.
+cbu_sp
+ = bpdu.
+cbu_dp
+ = 
+LLC_8021D_LSAP
+;
+
+242 
+bpdu
+.
+cbu_l
+ = 
+LLC_UI
+;
+
+243 
+bpdu
+.
+cbu_oid
+ = 
+	`hts
+(0);
+
+244 
+bpdu
+.
+cbu_ov
+ = 0;
+
+245 
+bpdu
+.
+cbu_bpduty
+ = 
+cu
+->
+cu_mesge_ty
+;
+
+246 
+bpdu
+.
+cbu_ags
+ = (
+cu
+->
+cu_togy_chge
+ ? 
+BSTP_FLAG_TC
+ : 0) |
+
+247 (
+cu
+->
+cu_togy_chge_acknowdgmt
+ ? 
+BSTP_FLAG_TCA
+ : 0);
+
+249 
+bpdu
+.
+cbu_roi
+ = 
+	`hts
+(
+cu
+->
+cu_roid
+ >> 48);
+
+250 
+bpdu
+.
+cbu_roaddr
+[0] = 
+cu
+->
+cu_roid
+ >> 40;
+
+251 
+bpdu
+.
+cbu_roaddr
+[1] = 
+cu
+->
+cu_roid
+ >> 32;
+
+252 
+bpdu
+.
+cbu_roaddr
+[2] = 
+cu
+->
+cu_roid
+ >> 24;
+
+253 
+bpdu
+.
+cbu_roaddr
+[3] = 
+cu
+->
+cu_roid
+ >> 16;
+
+254 
+bpdu
+.
+cbu_roaddr
+[4] = 
+cu
+->
+cu_roid
+ >> 8;
+
+255 
+bpdu
+.
+cbu_roaddr
+[5] = 
+cu
+->
+cu_roid
+ >> 0;
+
+257 
+bpdu
+.
+cbu_rothco
+ = 
+	`htl
+(
+cu
+->
+cu_ro_th_co
+);
+
+259 
+bpdu
+.
+cbu_bridgri
+ = 
+	`hts
+(
+cu
+->
+cu_roid
+ >> 48);
+
+260 
+bpdu
+.
+cbu_bridgddr
+[0] = 
+cu
+->
+cu_roid
+ >> 40;
+
+261 
+bpdu
+.
+cbu_bridgddr
+[1] = 
+cu
+->
+cu_roid
+ >> 32;
+
+262 
+bpdu
+.
+cbu_bridgddr
+[2] = 
+cu
+->
+cu_roid
+ >> 24;
+
+263 
+bpdu
+.
+cbu_bridgddr
+[3] = 
+cu
+->
+cu_roid
+ >> 16;
+
+264 
+bpdu
+.
+cbu_bridgddr
+[4] = 
+cu
+->
+cu_roid
+ >> 8;
+
+265 
+bpdu
+.
+cbu_bridgddr
+[5] = 
+cu
+->
+cu_roid
+ >> 0;
+
+267 
+bpdu
+.
+cbu_ptid
+ = 
+	`hts
+(
+cu
+->
+cu_pt_id
+);
+
+268 
+bpdu
+.
+cbu_mesgge
+ = 
+	`hts
+(
+cu
+->
+cu_mesge_age
+);
+
+269 
+bpdu
+.
+cbu_maxage
+ = 
+	`hts
+(
+cu
+->
+cu_max_age
+);
+
+270 
+bpdu
+.
+cbu_hlime
+ = 
+	`hts
+(
+cu
+->
+cu_hlo_time
+);
+
+271 
+bpdu
+.
+cbu_fwdday
+ = 
+	`hts
+(
+cu
+->
+cu_fwd_day
+);
+
+273 
+	`memy
+(
+eh
+->
+h_sho
+, 
+	`CLLADDR
+(
+i
+->
+if_dl
+), 
+ETHER_ADDR_LEN
+);
+
+274 
+	`memy
+(
+eh
+->
+h_dho
+, 
+bp_haddr
+, 
+ETHER_ADDR_LEN
+);
+
+275 
+eh
+->
+h_ty
+ = 
+	`hts
+((
+bpdu
+));
+
+277 
+	`memy
+(
+	`mtod
+(
+m
+, *+ (*
+eh
+), &
+bpdu
+, (bpdu));
+
+279 
+	`BRIDGE_INTR_UNLOCK
+(
+sc
+);
+
+280 
+s
+ = 
+	`
+();
+
+281 
+	`bridge_queue
+(
+sc
+, 
+i
+, 
+m
+, 0);
+
+282 
+	`lx
+(
+s
+);
+
+283 
+	`BRIDGE_INTR_LOCK
+(
+sc
+);
+
+284 
+	}
+}
+
+287 
+	$bp_ro_bridge
+(
+bridge_soc
+ *
+sc
+)
+
+289  (
+sc
+->
+sc_desigd_ro
+ =sc->
+sc_bridge_id
+);
+
+290 
+	}
+}
+
+293 
+	$bp_surdes_pt_fo
+(
+bridge_soc
+ *
+sc
+, 
+bridge_ii
+ *
+bif
+,
+
+294 
+bp_cfig_un
+ *
+cu
+)
+
+296 i(
+cu
+->
+cu_roid
+ < 
+bif
+->
+bif_desigd_ro
+)
+
+298 i(
+cu
+->
+cu_roid
+ > 
+bif
+->
+bif_desigd_ro
+)
+
+301 i(
+cu
+->
+cu_ro_th_co
+ < 
+bif
+->
+bif_desigd_co
+)
+
+303 i(
+cu
+->
+cu_ro_th_co
+ > 
+bif
+->
+bif_desigd_co
+)
+
+306 i(
+cu
+->
+cu_bridge_id
+ < 
+bif
+->
+bif_desigd_bridge
+)
+
+308 i(
+cu
+->
+cu_bridge_id
+ > 
+bif
+->
+bif_desigd_bridge
+)
+
+311 i(
+sc
+->
+sc_bridge_id
+ !
+cu
+->
+cu_bridge_id
+)
+
+313 i(
+cu
+->
+cu_pt_id
+ <
+bif
+->
+bif_desigd_pt
+)
+
+316 
+	}
+}
+
+319 
+	$bp_cd_cfig_fmi
+(
+bridge_soc
+ *
+sc
+,
+
+320 
+bridge_ii
+ *
+bif
+, 
+bp_cfig_un
+ *
+cu
+)
+
+322 
+bif
+->
+bif_desigd_ro
+ = 
+cu
+->
+cu_roid
+;
+
+323 
+bif
+->
+bif_desigd_co
+ = 
+cu
+->
+cu_ro_th_co
+;
+
+324 
+bif
+->
+bif_desigd_bridge
+ = 
+cu
+->
+cu_bridge_id
+;
+
+325 
+bif
+->
+bif_desigd_pt
+ = 
+cu
+->
+cu_pt_id
+;
+
+326 
+	`bp_tim_t
+(&
+bif
+->
+bif_mesge_age_tim
+, 
+cu
+->
+cu_mesge_age
+);
+
+327 
+	}
+}
+
+330 
+	$bp_cd_cfig_timeout_vues
+(
+bridge_soc
+ *
+sc
+,
+
+331 
+bp_cfig_un
+ *
+cfig
+)
+
+333 
+sc
+->
+sc_max_age
+ = 
+cfig
+->
+cu_max_age
+;
+
+334 
+sc
+->
+sc_hlo_time
+ = 
+cfig
+->
+cu_hlo_time
+;
+
+335 
+sc
+->
+sc_fwd_day
+ = 
+cfig
+->
+cu_fwd_day
+;
+
+336 
+sc
+->
+sc_togy_chge
+ = 
+cfig
+->
+cu_togy_chge
+;
+
+337 
+	}
+}
+
+340 
+	$bp_cfig_bpdu_gi
+(
+bridge_soc
+ *
+sc
+)
+
+342 
+bridge_ii
+ *
+bif
+;
+
+344 
+	`LIST_FOREACH
+(
+bif
+, &
+sc
+->
+sc_ii
+, 
+bif_xt
+) {
+
+345 i((
+bif
+->
+bif_ags
+ & 
+IFBIF_STP
+) == 0)
+
+347 i(
+	`bp_desigd_pt
+(
+sc
+, 
+bif
+) &&
+
+348 (
+bif
+->
+bif_e
+ !
+BSTP_IFSTATE_DISABLED
+))
+
+349 
+	`bp_sm_cfig
+(
+sc
+, 
+bif
+);
+
+351 
+	}
+}
+
+354 
+	$bp_desigd_pt
+(
+bridge_soc
+ *
+sc
+, 
+bridge_ii
+ *
+bif
+)
+
+356  ((
+bif
+->
+bif_desigd_bridge
+ =
+sc
+->
+sc_bridge_id
+)
+
+357 && (
+bif
+->
+bif_desigd_pt
+ =bif->
+bif_pt_id
+));
+
+358 
+	}
+}
+
+361 
+	$bp_sm_t
+(
+bridge_soc
+ *
+sc
+)
+
+363 
+bp_tbpdu
+ 
+bpdu
+;
+
+364 
+bridge_ii
+ *
+bif
+ = 
+sc
+->
+sc_ro_pt
+;
+
+365 
+i
+ *
+i
+;
+
+366 
+h_hd
+ *
+eh
+;
+
+367 
+mbuf
+ *
+m
+;
+
+368 
+s
+;
+
+370 
+	`KASSERT
+(
+	`BRIDGE_INTR_LOCKED
+(
+sc
+));
+
+372 
+	`KASSERT
+(
+bif
+ !
+NULL
+);
+
+373 
+i
+ = 
+bif
+->
+bif_i
+;
+
+374 i((
+i
+->
+if_ags
+ & 
+IFF_RUNNING
+) == 0)
+
+377 
+	`MGETHDR
+(
+m
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+378 i(
+m
+ =
+NULL
+)
+
+381 
+m
+->
+m_pkthdr
+.
+rcvif
+ = 
+i
+;
+
+382 
+m
+->
+m_pkthdr
+.
+n
+ = (*
+eh
++ (
+bpdu
+);
+
+383 
+m
+->
+m_n
+ = m->
+m_pkthdr
+.
+n
+;
+
+385 
+eh
+ = 
+	`mtod
+(
+m
+, 
+h_hd
+ *);
+
+387 
+	`memy
+(
+eh
+->
+h_sho
+, 
+	`CLLADDR
+(
+i
+->
+if_dl
+), 
+ETHER_ADDR_LEN
+);
+
+388 
+	`memy
+(
+eh
+->
+h_dho
+, 
+bp_haddr
+, 
+ETHER_ADDR_LEN
+);
+
+389 
+eh
+->
+h_ty
+ = 
+	`hts
+((
+bpdu
+));
+
+391 
+bpdu
+.
+tbu_sp
+ = bpdu.
+tbu_dp
+ = 
+LLC_8021D_LSAP
+;
+
+392 
+bpdu
+.
+tbu_l
+ = 
+LLC_UI
+;
+
+393 
+bpdu
+.
+tbu_oid
+ = 0;
+
+394 
+bpdu
+.
+tbu_ov
+ = 0;
+
+395 
+bpdu
+.
+tbu_bpduty
+ = 
+BSTP_MSGTYPE_TCN
+;
+
+397 
+	`memy
+(
+	`mtod
+(
+m
+, *+ (*
+eh
+), &
+bpdu
+, (bpdu));
+
+399 
+	`BRIDGE_INTR_UNLOCK
+(
+sc
+);
+
+400 
+s
+ = 
+	`
+();
+
+401 
+	`bridge_queue
+(
+sc
+, 
+i
+, 
+m
+, 0);
+
+402 
+	`lx
+(
+s
+);
+
+403 
+	`BRIDGE_INTR_LOCK
+(
+sc
+);
+
+404 
+	}
+}
+
+407 
+	$bp_cfiguti_upde
+(
+bridge_soc
+ *
+sc
+)
+
+409 
+	`bp_ro_i
+(
+sc
+);
+
+410 
+	`bp_desigd_pt_i
+(
+sc
+);
+
+411 
+	}
+}
+
+414 
+	$bp_ro_i
+(
+bridge_soc
+ *
+sc
+)
+
+416 
+bridge_ii
+ *
+ro_pt
+ = 
+NULL
+, *
+bif
+;
+
+418 
+	`LIST_FOREACH
+(
+bif
+, &
+sc
+->
+sc_ii
+, 
+bif_xt
+) {
+
+419 i((
+bif
+->
+bif_ags
+ & 
+IFBIF_STP
+) == 0)
+
+421 i(
+	`bp_desigd_pt
+(
+sc
+, 
+bif
+))
+
+423 i(
+bif
+->
+bif_e
+ =
+BSTP_IFSTATE_DISABLED
+)
+
+425 i(
+bif
+->
+bif_desigd_ro
+ >
+sc
+->
+sc_bridge_id
+)
+
+427 i(
+ro_pt
+ =
+NULL
+)
+
+428 
+t_pt
+;
+
+430 i(
+bif
+->
+bif_desigd_ro
+ < 
+ro_pt
+->bif_designated_root)
+
+431 
+t_pt
+;
+
+432 i(
+bif
+->
+bif_desigd_ro
+ > 
+ro_pt
+->bif_designated_root)
+
+435 i((
+bif
+->
+bif_desigd_co
+ + bif->
+bif_th_co
+) <
+
+436 (
+ro_pt
+->
+bif_desigd_co
+ +o_pt->
+bif_th_co
+))
+
+437 
+t_pt
+;
+
+438 i((
+bif
+->
+bif_desigd_co
+ + bif->
+bif_th_co
+) >
+
+439 (
+ro_pt
+->
+bif_desigd_co
+ +o_pt->
+bif_th_co
+))
+
+442 i(
+bif
+->
+bif_desigd_bridge
+ <
+
+443 
+ro_pt
+->
+bif_desigd_bridge
+)
+
+444 
+t_pt
+;
+
+445 i(
+bif
+->
+bif_desigd_bridge
+ >
+
+446 
+ro_pt
+->
+bif_desigd_bridge
+)
+
+449 i(
+bif
+->
+bif_desigd_pt
+ < 
+ro_pt
+->bif_designated_port)
+
+450 
+t_pt
+;
+
+451 i(
+bif
+->
+bif_desigd_pt
+ > 
+ro_pt
+->bif_designated_port)
+
+454 i(
+bif
+->
+bif_pt_id
+ >
+ro_pt
+->bif_port_id)
+
+456 
+t_pt
+:
+
+457 
+ro_pt
+ = 
+bif
+;
+
+460 
+sc
+->
+sc_ro_pt
+ = 
+ro_pt
+;
+
+461 i(
+ro_pt
+ =
+NULL
+) {
+
+462 
+sc
+->
+sc_desigd_ro
+ = sc->
+sc_bridge_id
+;
+
+463 
+sc
+->
+sc_ro_th_co
+ = 0;
+
+465 
+sc
+->
+sc_desigd_ro
+ = 
+ro_pt
+->
+bif_desigd_ro
+;
+
+466 
+sc
+->
+sc_ro_th_co
+ = 
+ro_pt
+->
+bif_desigd_co
+ +
+
+467 
+ro_pt
+->
+bif_th_co
+;
+
+469 
+	}
+}
+
+472 
+	$bp_desigd_pt_i
+(
+bridge_soc
+ *
+sc
+)
+
+474 
+bridge_ii
+ *
+bif
+;
+
+476 
+	`LIST_FOREACH
+(
+bif
+, &
+sc
+->
+sc_ii
+, 
+bif_xt
+) {
+
+477 i((
+bif
+->
+bif_ags
+ & 
+IFBIF_STP
+) == 0)
+
+479 i(
+	`bp_desigd_pt
+(
+sc
+, 
+bif
+))
+
+480 
+desigd
+;
+
+481 i(
+bif
+->
+bif_desigd_ro
+ !
+sc
+->
+sc_desigd_ro
+)
+
+482 
+desigd
+;
+
+484 i(
+sc
+->
+sc_ro_th_co
+ < 
+bif
+->
+bif_desigd_co
+)
+
+485 
+desigd
+;
+
+486 i(
+sc
+->
+sc_ro_th_co
+ > 
+bif
+->
+bif_desigd_co
+)
+
+489 i(
+sc
+->
+sc_bridge_id
+ < 
+bif
+->
+bif_desigd_bridge
+)
+
+490 
+desigd
+;
+
+491 i(
+sc
+->
+sc_bridge_id
+ > 
+bif
+->
+bif_desigd_bridge
+)
+
+494 i(
+bif
+->
+bif_pt_id
+ > bif->
+bif_desigd_pt
+)
+
+496 
+desigd
+:
+
+497 
+	`bp_become_desigd_pt
+(
+sc
+, 
+bif
+);
+
+499 
+	}
+}
+
+502 
+	$bp_become_desigd_pt
+(
+bridge_soc
+ *
+sc
+, 
+bridge_ii
+ *
+bif
+)
+
+504 
+bif
+->
+bif_desigd_ro
+ = 
+sc
+->
+sc_desigd_ro
+;
+
+505 
+bif
+->
+bif_desigd_co
+ = 
+sc
+->
+sc_ro_th_co
+;
+
+506 
+bif
+->
+bif_desigd_bridge
+ = 
+sc
+->
+sc_bridge_id
+;
+
+507 
+bif
+->
+bif_desigd_pt
+ = bif->
+bif_pt_id
+;
+
+508 
+	}
+}
+
+511 
+	$bp_pt_e_i
+(
+bridge_soc
+ *
+sc
+)
+
+513 
+bridge_ii
+ *
+bif
+;
+
+515 
+	`LIST_FOREACH
+(
+bif
+, &
+sc
+->
+sc_ii
+, 
+bif_xt
+) {
+
+516 i((
+bif
+->
+bif_ags
+ & 
+IFBIF_STP
+) == 0)
+
+518 i(
+bif
+ =
+sc
+->
+sc_ro_pt
+) {
+
+519 
+bif
+->
+bif_cfig_ndg
+ = 0;
+
+520 
+bif
+->
+bif_togy_chge_acknowdge
+ = 0;
+
+521 
+	`bp_make_fwdg
+(
+sc
+, 
+bif
+);
+
+522 } i(
+	`bp_desigd_pt
+(
+sc
+, 
+bif
+)) {
+
+523 
+	`bp_tim_
+(&
+bif
+->
+bif_mesge_age_tim
+);
+
+524 
+	`bp_make_fwdg
+(
+sc
+, 
+bif
+);
+
+526 
+bif
+->
+bif_cfig_ndg
+ = 0;
+
+527 
+bif
+->
+bif_togy_chge_acknowdge
+ = 0;
+
+528 
+	`bp_make_blockg
+(
+sc
+, 
+bif
+);
+
+531 
+	}
+}
+
+534 
+	$bp_make_fwdg
+(
+bridge_soc
+ *
+sc
+,
+
+535 
+bridge_ii
+ *
+bif
+)
+
+537 i(
+bif
+->
+bif_e
+ =
+BSTP_IFSTATE_BLOCKING
+) {
+
+538 
+	`bp_t_pt_e
+(
+bif
+, 
+BSTP_IFSTATE_LISTENING
+);
+
+539 
+	`bp_tim_t
+(&
+bif
+->
+bif_fwd_day_tim
+, 0);
+
+541 
+	}
+}
+
+544 
+	$bp_make_blockg
+(
+bridge_soc
+ *
+sc
+, 
+bridge_ii
+ *
+bif
+)
+
+546 i((
+bif
+->
+bif_e
+ !
+BSTP_IFSTATE_DISABLED
+) &&
+
+547 (
+bif
+->
+bif_e
+ !
+BSTP_IFSTATE_BLOCKING
+)) {
+
+548 i((
+bif
+->
+bif_e
+ =
+BSTP_IFSTATE_FORWARDING
+) ||
+
+549 (
+bif
+->
+bif_e
+ =
+BSTP_IFSTATE_LEARNING
+)) {
+
+550 i(
+bif
+->
+bif_chge_dei_abd
+) {
+
+551 
+	`bp_togy_chge_dei
+(
+sc
+);
+
+554 
+	`bp_t_pt_e
+(
+bif
+, 
+BSTP_IFSTATE_BLOCKING
+);
+
+555 
+	`bp_tim_
+(&
+bif
+->
+bif_fwd_day_tim
+);
+
+557 
+	}
+}
+
+560 
+	$bp_t_pt_e
+(
+bridge_ii
+ *
+bif
+, 
+ut8_t
+ 
+e
+)
+
+562 
+bif
+->
+bif_e
+ = 
+e
+;
+
+563 
+	}
+}
+
+566 
+	$bp_togy_chge_dei
+(
+bridge_soc
+ *
+sc
+)
+
+568 i(
+	`bp_ro_bridge
+(
+sc
+)) {
+
+569 
+sc
+->
+sc_togy_chge
+ = 1;
+
+570 
+	`bp_tim_t
+(&
+sc
+->
+sc_togy_chge_tim
+, 0);
+
+571 } i(!
+sc
+->
+sc_togy_chge_deed
+) {
+
+572 
+	`bp_sm_t
+(
+sc
+);
+
+573 
+	`bp_tim_t
+(&
+sc
+->
+sc_t_tim
+, 0);
+
+575 
+sc
+->
+sc_togy_chge_deed
+ = 1;
+
+576 
+	}
+}
+
+579 
+	$bp_togy_chge_acknowdged
+(
+bridge_soc
+ *
+sc
+)
+
+581 
+sc
+->
+sc_togy_chge_deed
+ = 0;
+
+582 
+	`bp_tim_
+(&
+sc
+->
+sc_t_tim
+);
+
+583 
+	}
+}
+
+586 
+	$bp_acknowdge_togy_chge
+(
+bridge_soc
+ *
+sc
+,
+
+587 
+bridge_ii
+ *
+bif
+)
+
+589 
+bif
+->
+bif_togy_chge_acknowdge
+ = 1;
+
+590 
+	`bp_sm_cfig
+(
+sc
+, 
+bif
+);
+
+591 
+	}
+}
+
+594 
+	$bp_put
+(
+bridge_soc
+ *
+sc
+, 
+bridge_ii
+ *
+bif
+, 
+mbuf
+ *
+m
+)
+
+596 
+h_hd
+ *
+eh
+;
+
+597 
+bp_tbpdu
+ 
+du
+;
+
+598 
+bp_cbpdu
+ 
+du
+;
+
+599 
+bp_cfig_un
+ 
+cu
+;
+
+600 
+bp_t_un
+ 
+tu
+;
+
+601 
+ut16_t
+ 
+n
+;
+
+603 #ifde
+BRIDGE_MPSAFE
+
+
+604 
+	`KASSERT
+(
+bif
+->
+bif_fs
+ > 0);
+
+607 
+eh
+ = 
+	`mtod
+(
+m
+, 
+h_hd
+ *);
+
+609 i((
+bif
+->
+bif_ags
+ & 
+IFBIF_STP
+) == 0)
+
+610 
+out
+;
+
+612 
+n
+ = 
+	`ohs
+(
+eh
+->
+h_ty
+);
+
+613 i(
+n
+ < (
+du
+))
+
+614 
+out
+;
+
+616 
+	`m_adj
+(
+m
+, 
+ETHER_HDR_LEN
+);
+
+618 i(
+m
+->
+m_pkthdr
+.
+n
+ >en)
+
+619 
+	`m_adj
+(
+m
+, 
+n
+ - m->
+m_pkthdr
+.len);
+
+620 i(
+m
+->
+m_n
+ < (
+du
+) &&
+
+621 (
+m
+ = 
+	`m_puup
+(m, (
+du
+))=
+NULL
+)
+
+622 
+out
+;
+
+624 
+	`memy
+(&
+du
+, 
+	`mtod
+(
+m
+, *), (tpdu));
+
+626 i(
+du
+.
+tbu_dp
+ !
+LLC_8021D_LSAP
+ ||
+
+627 
+du
+.
+tbu_sp
+ !
+LLC_8021D_LSAP
+ ||
+
+628 
+du
+.
+tbu_l
+ !
+LLC_UI
+)
+
+629 
+out
+;
+
+630 i(
+du
+.
+tbu_oid
+ !0 ||pdu.
+tbu_ov
+ != 0)
+
+631 
+out
+;
+
+633 
+du
+.
+tbu_bpduty
+) {
+
+634 
+BSTP_MSGTYPE_TCN
+:
+
+635 
+tu
+.
+tu_mesge_ty
+ = 
+du
+.
+tbu_bpduty
+;
+
+637 
+	`BRIDGE_INTR_LOCK
+(
+sc
+);
+
+638 
+	`bp_ived_t_bpdu
+(
+sc
+, 
+bif
+, &
+tu
+);
+
+639 
+	`BRIDGE_INTR_UNLOCK
+(
+sc
+);
+
+642 
+BSTP_MSGTYPE_CFG
+:
+
+643 i(
+m
+->
+m_n
+ < (
+du
+) &&
+
+644 (
+m
+ = 
+	`m_puup
+(m, (
+du
+))=
+NULL
+)
+
+645 
+out
+;
+
+646 
+	`memy
+(&
+du
+, 
+	`mtod
+(
+m
+, *), (cpdu));
+
+648 
+cu
+.
+cu_roid
+ =
+
+649 (((
+ut64_t
+)
+	`ohs
+(
+du
+.
+cbu_roi
+)) << 48) |
+
+650 (((
+ut64_t
+)
+du
+.
+cbu_roaddr
+[0]) << 40) |
+
+651 (((
+ut64_t
+)
+du
+.
+cbu_roaddr
+[1]) << 32) |
+
+652 (((
+ut64_t
+)
+du
+.
+cbu_roaddr
+[2]) << 24) |
+
+653 (((
+ut64_t
+)
+du
+.
+cbu_roaddr
+[3]) << 16) |
+
+654 (((
+ut64_t
+)
+du
+.
+cbu_roaddr
+[4]) << 8) |
+
+655 (((
+ut64_t
+)
+du
+.
+cbu_roaddr
+[5]) << 0);
+
+657 
+cu
+.
+cu_bridge_id
+ =
+
+658 (((
+ut64_t
+)
+	`ohs
+(
+du
+.
+cbu_bridgri
+)) << 48) |
+
+659 (((
+ut64_t
+)
+du
+.
+cbu_bridgddr
+[0]) << 40) |
+
+660 (((
+ut64_t
+)
+du
+.
+cbu_bridgddr
+[1]) << 32) |
+
+661 (((
+ut64_t
+)
+du
+.
+cbu_bridgddr
+[2]) << 24) |
+
+662 (((
+ut64_t
+)
+du
+.
+cbu_bridgddr
+[3]) << 16) |
+
+663 (((
+ut64_t
+)
+du
+.
+cbu_bridgddr
+[4]) << 8) |
+
+664 (((
+ut64_t
+)
+du
+.
+cbu_bridgddr
+[5]) << 0);
+
+666 
+cu
+.
+cu_ro_th_co
+ = 
+	`ohl
+(
+du
+.
+cbu_rothco
+);
+
+667 
+cu
+.
+cu_mesge_age
+ = 
+	`ohs
+(
+du
+.
+cbu_mesgge
+);
+
+668 
+cu
+.
+cu_max_age
+ = 
+	`ohs
+(
+du
+.
+cbu_maxage
+);
+
+669 
+cu
+.
+cu_hlo_time
+ = 
+	`ohs
+(
+du
+.
+cbu_hlime
+);
+
+670 
+cu
+.
+cu_fwd_day
+ = 
+	`ohs
+(
+du
+.
+cbu_fwdday
+);
+
+671 
+cu
+.
+cu_pt_id
+ = 
+	`ohs
+(
+du
+.
+cbu_ptid
+);
+
+672 
+cu
+.
+cu_mesge_ty
+ = 
+du
+.
+cbu_bpduty
+;
+
+673 
+cu
+.
+cu_togy_chge_acknowdgmt
+ =
+
+674 (
+du
+.
+cbu_ags
+ & 
+BSTP_FLAG_TCA
+) ? 1 : 0;
+
+675 
+cu
+.
+cu_togy_chge
+ =
+
+676 (
+du
+.
+cbu_ags
+ & 
+BSTP_FLAG_TC
+) ? 1 : 0;
+
+678 
+	`BRIDGE_INTR_LOCK
+(
+sc
+);
+
+679 
+	`bp_ived_cfig_bpdu
+(
+sc
+, 
+bif
+, &
+cu
+);
+
+680 
+	`BRIDGE_INTR_UNLOCK
+(
+sc
+);
+
+684 
+out
+;
+
+687 
+out
+:
+
+688 i(
+m
+)
+
+689 
+	`m_m
+(
+m
+);
+
+691 
+	}
+}
+
+694 
+	$bp_ived_cfig_bpdu
+(
+bridge_soc
+ *
+sc
+, 
+bridge_ii
+ *
+bif
+,
+
+695 
+bp_cfig_un
+ *
+cu
+)
+
+697 
+ro
+;
+
+699 
+ro
+ = 
+	`bp_ro_bridge
+(
+sc
+);
+
+701 i(
+bif
+->
+bif_e
+ !
+BSTP_IFSTATE_DISABLED
+) {
+
+702 i(
+	`bp_surdes_pt_fo
+(
+sc
+, 
+bif
+, 
+cu
+)) {
+
+703 
+	`bp_cd_cfig_fmi
+(
+sc
+, 
+bif
+, 
+cu
+);
+
+704 
+	`bp_cfiguti_upde
+(
+sc
+);
+
+705 
+	`bp_pt_e_i
+(
+sc
+);
+
+707 i((
+	`bp_ro_bridge
+(
+sc
+=0&& 
+ro
+) {
+
+708 
+	`bp_tim_
+(&
+sc
+->
+sc_hlo_tim
+);
+
+710 i(
+sc
+->
+sc_togy_chge_deed
+) {
+
+711 
+	`bp_tim_
+(
+
+712 &
+sc
+->
+sc_togy_chge_tim
+);
+
+713 
+	`bp_sm_t
+(
+sc
+);
+
+714 
+	`bp_tim_t
+(&
+sc
+->
+sc_t_tim
+, 0);
+
+718 i(
+bif
+ =
+sc
+->
+sc_ro_pt
+) {
+
+719 
+	`bp_cd_cfig_timeout_vues
+(
+sc
+, 
+cu
+);
+
+720 
+	`bp_cfig_bpdu_gi
+(
+sc
+);
+
+722 i(
+cu
+->
+cu_togy_chge_acknowdgmt
+)
+
+723 
+	`bp_togy_chge_acknowdged
+(
+sc
+);
+
+725 } i(
+	`bp_desigd_pt
+(
+sc
+, 
+bif
+))
+
+726 
+	`bp_sm_cfig
+(
+sc
+, 
+bif
+);
+
+728 
+	}
+}
+
+731 
+	$bp_ived_t_bpdu
+(
+bridge_soc
+ *
+sc
+, 
+bridge_ii
+ *
+bif
+,
+
+732 
+bp_t_un
+ *
+t
+)
+
+734 i(
+bif
+->
+bif_e
+ !
+BSTP_IFSTATE_DISABLED
+ &&
+
+735 
+	`bp_desigd_pt
+(
+sc
+, 
+bif
+)) {
+
+736 
+	`bp_togy_chge_dei
+(
+sc
+);
+
+737 
+	`bp_acknowdge_togy_chge
+(
+sc
+, 
+bif
+);
+
+739 
+	}
+}
+
+742 
+	$bp_hlo_tim_expy
+(
+bridge_soc
+ *
+sc
+)
+
+744 
+	`bp_cfig_bpdu_gi
+(
+sc
+);
+
+745 
+	`bp_tim_t
+(&
+sc
+->
+sc_hlo_tim
+, 0);
+
+746 
+	}
+}
+
+749 
+	$bp_mesge_age_tim_expy
+(
+bridge_soc
+ *
+sc
+,
+
+750 
+bridge_ii
+ *
+bif
+)
+
+752 
+ro
+;
+
+754 
+ro
+ = 
+	`bp_ro_bridge
+(
+sc
+);
+
+755 
+	`bp_become_desigd_pt
+(
+sc
+, 
+bif
+);
+
+756 
+	`bp_cfiguti_upde
+(
+sc
+);
+
+757 
+	`bp_pt_e_i
+(
+sc
+);
+
+759 i((
+	`bp_ro_bridge
+(
+sc
+)&& (
+ro
+ == 0)) {
+
+760 
+sc
+->
+sc_max_age
+ = sc->
+sc_bridge_max_age
+;
+
+761 
+sc
+->
+sc_hlo_time
+ = sc->
+sc_bridge_hlo_time
+;
+
+762 
+sc
+->
+sc_fwd_day
+ = sc->
+sc_bridge_fwd_day
+;
+
+764 
+	`bp_togy_chge_dei
+(
+sc
+);
+
+765 
+	`bp_tim_
+(&
+sc
+->
+sc_t_tim
+);
+
+766 
+	`bp_cfig_bpdu_gi
+(
+sc
+);
+
+767 
+	`bp_tim_t
+(&
+sc
+->
+sc_hlo_tim
+, 0);
+
+769 
+	}
+}
+
+772 
+	$bp_fwd_day_tim_expy
+(
+bridge_soc
+ *
+sc
+,
+
+773 
+bridge_ii
+ *
+bif
+)
+
+775 i(
+bif
+->
+bif_e
+ =
+BSTP_IFSTATE_LISTENING
+) {
+
+776 
+	`bp_t_pt_e
+(
+bif
+, 
+BSTP_IFSTATE_LEARNING
+);
+
+777 
+	`bp_tim_t
+(&
+bif
+->
+bif_fwd_day_tim
+, 0);
+
+778 } i(
+bif
+->
+bif_e
+ =
+BSTP_IFSTATE_LEARNING
+) {
+
+779 
+	`bp_t_pt_e
+(
+bif
+, 
+BSTP_IFSTATE_FORWARDING
+);
+
+780 i(
+	`bp_desigd_f_some_pt
+(
+sc
+) &&
+
+781 
+bif
+->
+bif_chge_dei_abd
+)
+
+782 
+	`bp_togy_chge_dei
+(
+sc
+);
+
+784 
+	}
+}
+
+787 
+	$bp_desigd_f_some_pt
+(
+bridge_soc
+ *
+sc
+)
+
+790 
+bridge_ii
+ *
+bif
+;
+
+792 
+	`LIST_FOREACH
+(
+bif
+, &
+sc
+->
+sc_ii
+, 
+bif_xt
+) {
+
+793 i((
+bif
+->
+bif_ags
+ & 
+IFBIF_STP
+) == 0)
+
+795 i(
+bif
+->
+bif_desigd_bridge
+ =
+sc
+->
+sc_bridge_id
+)
+
+799 
+	}
+}
+
+802 
+	$bp_t_tim_expy
+(
+bridge_soc
+ *
+sc
+)
+
+804 
+	`bp_sm_t
+(
+sc
+);
+
+805 
+	`bp_tim_t
+(&
+sc
+->
+sc_t_tim
+, 0);
+
+806 
+	}
+}
+
+809 
+	$bp_togy_chge_tim_expy
+(
+bridge_soc
+ *
+sc
+)
+
+811 
+sc
+->
+sc_togy_chge_deed
+ = 0;
+
+812 
+sc
+->
+sc_togy_chge
+ = 0;
+
+813 
+	}
+}
+
+816 
+	$bp_hd_tim_expy
+(
+bridge_soc
+ *
+sc
+, 
+bridge_ii
+ *
+bif
+)
+
+818 i(
+bif
+->
+bif_cfig_ndg
+)
+
+819 
+	`bp_sm_cfig
+(
+sc
+, 
+bif
+);
+
+820 
+	}
+}
+
+823 
+	$bp_lizi
+(
+bridge_soc
+ *
+sc
+)
+
+825 
+bridge_ii
+ *
+bif
+, *
+mif
+;
+
+827 
+mif
+ = 
+NULL
+;
+
+829 
+	`BRIDGE_INTR_LOCK
+(
+sc
+);
+
+831 
+	`LIST_FOREACH
+(
+bif
+, &
+sc
+->
+sc_ii
+, 
+bif_xt
+) {
+
+832 i((
+bif
+->
+bif_ags
+ & 
+IFBIF_STP
+) == 0)
+
+834 i(
+bif
+->
+bif_i
+->
+if_ty
+ !
+IFT_ETHER
+)
+
+836 
+bif
+->
+bif_pt_id
+ = (bif->
+bif_iy
+ << 8) |
+
+837 (
+bif
+->
+bif_i
+->
+if_dex
+ & 0xff);
+
+839 i(
+mif
+ =
+NULL
+) {
+
+840 
+mif
+ = 
+bif
+;
+
+843 i(
+	`memcmp
+(
+	`CLLADDR
+(
+bif
+->
+bif_i
+->
+if_dl
+),
+
+844 
+	`CLLADDR
+(
+mif
+->
+bif_i
+->
+if_dl
+), 
+ETHER_ADDR_LEN
+) < 0) {
+
+845 
+mif
+ = 
+bif
+;
+
+850 i(
+mif
+ =
+NULL
+) {
+
+851 
+	`BRIDGE_INTR_UNLOCK
+(
+sc
+);
+
+852 
+	`bp_
+(
+sc
+);
+
+856 
+sc
+->
+sc_bridge_id
+ =
+
+857 (((
+ut64_t
+)
+sc
+->
+sc_bridge_iy
+) << 48) |
+
+858 (((
+ut64_t
+)(
+ut8_t
+)
+	`CLLADDR
+(
+mif
+->
+bif_i
+->
+if_dl
+)[0]) << 40) |
+
+859 (((
+ut64_t
+)(
+ut8_t
+)
+	`CLLADDR
+(
+mif
+->
+bif_i
+->
+if_dl
+)[1]) << 32) |
+
+860 (((
+ut64_t
+)(
+ut8_t
+)
+	`CLLADDR
+(
+mif
+->
+bif_i
+->
+if_dl
+)[2]) << 24) |
+
+861 (((
+ut64_t
+)(
+ut8_t
+)
+	`CLLADDR
+(
+mif
+->
+bif_i
+->
+if_dl
+)[3]) << 16) |
+
+862 (((
+ut64_t
+)(
+ut8_t
+)
+	`CLLADDR
+(
+mif
+->
+bif_i
+->
+if_dl
+)[4]) << 8) |
+
+863 (((
+ut64_t
+)(
+ut8_t
+)
+	`CLLADDR
+(
+mif
+->
+bif_i
+->
+if_dl
+)[5]) << 0);
+
+865 
+	`BRIDGE_INTR_UNLOCK
+(
+sc
+);
+
+867 
+sc
+->
+sc_desigd_ro
+ = sc->
+sc_bridge_id
+;
+
+868 
+sc
+->
+sc_ro_th_co
+ = 0;
+
+869 
+sc
+->
+sc_ro_pt
+ = 
+NULL
+;
+
+871 
+sc
+->
+sc_max_age
+ = sc->
+sc_bridge_max_age
+;
+
+872 
+sc
+->
+sc_hlo_time
+ = sc->
+sc_bridge_hlo_time
+;
+
+873 
+sc
+->
+sc_fwd_day
+ = sc->
+sc_bridge_fwd_day
+;
+
+874 
+sc
+->
+sc_togy_chge_deed
+ = 0;
+
+875 
+sc
+->
+sc_togy_chge
+ = 0;
+
+876 
+	`bp_tim_
+(&
+sc
+->
+sc_t_tim
+);
+
+877 
+	`bp_tim_
+(&
+sc
+->
+sc_togy_chge_tim
+);
+
+879 i(
+	`out_ndg
+(&
+sc
+->
+sc_bpout
+) == 0)
+
+880 
+	`out_t
+(&
+sc
+->
+sc_bpout
+, 
+hz
+,
+
+881 
+bp_tick
+, 
+sc
+);
+
+883 
+	`BRIDGE_INTR_LOCK
+(
+sc
+);
+
+885 
+	`LIST_FOREACH
+(
+bif
+, &
+sc
+->
+sc_ii
+, 
+bif_xt
+) {
+
+886 i(
+bif
+->
+bif_ags
+ & 
+IFBIF_STP
+)
+
+887 
+	`bp_ab_pt
+(
+sc
+, 
+bif
+);
+
+889 
+	`bp_dib_pt
+(
+sc
+, 
+bif
+);
+
+892 
+	`bp_pt_e_i
+(
+sc
+);
+
+893 
+	`bp_cfig_bpdu_gi
+(
+sc
+);
+
+894 
+	`bp_tim_t
+(&
+sc
+->
+sc_hlo_tim
+, 0);
+
+896 
+	`BRIDGE_INTR_UNLOCK
+(
+sc
+);
+
+897 
+	}
+}
+
+900 
+	$bp_
+(
+bridge_soc
+ *
+sc
+)
+
+902 
+bridge_ii
+ *
+bif
+;
+
+904 
+	`BRIDGE_INTR_LOCK
+(
+sc
+);
+
+905 
+	`LIST_FOREACH
+(
+bif
+, &
+sc
+->
+sc_ii
+, 
+bif_xt
+) {
+
+906 
+	`bp_t_pt_e
+(
+bif
+, 
+BSTP_IFSTATE_DISABLED
+);
+
+907 
+	`bp_tim_
+(&
+bif
+->
+bif_hd_tim
+);
+
+908 
+	`bp_tim_
+(&
+bif
+->
+bif_mesge_age_tim
+);
+
+909 
+	`bp_tim_
+(&
+bif
+->
+bif_fwd_day_tim
+);
+
+911 
+	`BRIDGE_INTR_UNLOCK
+(
+sc
+);
+
+913 
+	`out_
+(&
+sc
+->
+sc_bpout
+);
+
+915 
+	`bp_tim_
+(&
+sc
+->
+sc_togy_chge_tim
+);
+
+916 
+	`bp_tim_
+(&
+sc
+->
+sc_t_tim
+);
+
+917 
+	`bp_tim_
+(&
+sc
+->
+sc_hlo_tim
+);
+
+919 
+	}
+}
+
+922 
+	$bp_lize_pt
+(
+bridge_soc
+ *
+sc
+, 
+bridge_ii
+ *
+bif
+)
+
+924 
+	`bp_become_desigd_pt
+(
+sc
+, 
+bif
+);
+
+925 
+	`bp_t_pt_e
+(
+bif
+, 
+BSTP_IFSTATE_BLOCKING
+);
+
+926 
+bif
+->
+bif_togy_chge_acknowdge
+ = 0;
+
+927 
+bif
+->
+bif_cfig_ndg
+ = 0;
+
+928 
+bif
+->
+bif_chge_dei_abd
+ = 1;
+
+929 
+	`bp_tim_
+(&
+bif
+->
+bif_mesge_age_tim
+);
+
+930 
+	`bp_tim_
+(&
+bif
+->
+bif_fwd_day_tim
+);
+
+931 
+	`bp_tim_
+(&
+bif
+->
+bif_hd_tim
+);
+
+932 
+	}
+}
+
+935 
+	$bp_ab_pt
+(
+bridge_soc
+ *
+sc
+, 
+bridge_ii
+ *
+bif
+)
+
+937 
+	`bp_lize_pt
+(
+sc
+, 
+bif
+);
+
+938 
+	`bp_pt_e_i
+(
+sc
+);
+
+939 
+	}
+}
+
+942 
+	$bp_dib_pt
+(
+bridge_soc
+ *
+sc
+, 
+bridge_ii
+ *
+bif
+)
+
+944 
+ro
+;
+
+946 
+ro
+ = 
+	`bp_ro_bridge
+(
+sc
+);
+
+947 
+	`bp_become_desigd_pt
+(
+sc
+, 
+bif
+);
+
+948 
+	`bp_t_pt_e
+(
+bif
+, 
+BSTP_IFSTATE_DISABLED
+);
+
+949 
+bif
+->
+bif_togy_chge_acknowdge
+ = 0;
+
+950 
+bif
+->
+bif_cfig_ndg
+ = 0;
+
+951 
+	`bp_tim_
+(&
+bif
+->
+bif_mesge_age_tim
+);
+
+952 
+	`bp_tim_
+(&
+bif
+->
+bif_fwd_day_tim
+);
+
+953 
+	`bp_cfiguti_upde
+(
+sc
+);
+
+954 
+	`bp_pt_e_i
+(
+sc
+);
+
+956 i(
+	`bp_ro_bridge
+(
+sc
+&& (
+ro
+ == 0)) {
+
+957 
+sc
+->
+sc_max_age
+ = sc->
+sc_bridge_max_age
+;
+
+958 
+sc
+->
+sc_hlo_time
+ = sc->
+sc_bridge_hlo_time
+;
+
+959 
+sc
+->
+sc_fwd_day
+ = sc->
+sc_bridge_fwd_day
+;
+
+961 
+	`bp_togy_chge_dei
+(
+sc
+);
+
+962 
+	`bp_tim_
+(&
+sc
+->
+sc_t_tim
+);
+
+963 
+	`bp_cfig_bpdu_gi
+(
+sc
+);
+
+964 
+	`bp_tim_t
+(&
+sc
+->
+sc_hlo_tim
+, 0);
+
+966 
+	}
+}
+
+968 #i
+nud
+
+
+970 
+	$bp_t_bridge_iy
+(
+bridge_soc
+ *
+sc
+, 
+ut64_t
+ 
+w_bridge_id
+)
+
+972 
+bridge_ii
+ *
+bif
+;
+
+973 
+ro
+;
+
+975 
+ro
+ = 
+	`bp_ro_bridge
+(
+sc
+);
+
+977 
+	`LIST_FOREACH
+(
+bif
+, &
+sc
+->
+sc_ii
+, 
+bif_xt
+) {
+
+978 i((
+bif
+->
+bif_ags
+ & 
+IFBIF_STP
+) == 0)
+
+980 i(
+	`bp_desigd_pt
+(
+sc
+, 
+bif
+))
+
+981 
+bif
+->
+bif_desigd_bridge
+ = 
+w_bridge_id
+;
+
+984 
+sc
+->
+sc_bridge_id
+ = 
+w_bridge_id
+;
+
+986 
+	`bp_cfiguti_upde
+(
+sc
+);
+
+987 
+	`bp_pt_e_i
+(
+sc
+);
+
+989 i(
+	`bp_ro_bridge
+(
+sc
+&& (
+ro
+ == 0)) {
+
+990 
+sc
+->
+sc_max_age
+ = sc->
+sc_bridge_max_age
+;
+
+991 
+sc
+->
+sc_hlo_time
+ = sc->
+sc_bridge_hlo_time
+;
+
+992 
+sc
+->
+sc_fwd_day
+ = sc->
+sc_bridge_fwd_day
+;
+
+994 
+	`bp_togy_chge_dei
+(
+sc
+);
+
+995 
+	`bp_tim_
+(&
+sc
+->
+sc_t_tim
+);
+
+996 
+	`bp_cfig_bpdu_gi
+(
+sc
+);
+
+997 
+	`bp_tim_t
+(&
+sc
+->
+sc_hlo_tim
+, 0);
+
+999 
+	}
+}
+
+1002 
+	$bp_t_pt_iy
+(
+bridge_soc
+ *
+sc
+, 
+bridge_ii
+ *
+bif
+,
+
+1003 
+ut16_t
+ 
+w_pt_id
+)
+
+1005 i(
+	`bp_desigd_pt
+(
+sc
+, 
+bif
+))
+
+1006 
+bif
+->
+bif_desigd_pt
+ = 
+w_pt_id
+;
+
+1008 
+bif
+->
+bif_pt_id
+ = 
+w_pt_id
+;
+
+1010 i((
+sc
+->
+sc_bridge_id
+ =
+bif
+->
+bif_desigd_bridge
+) &&
+
+1011 (
+bif
+->
+bif_pt_id
+ < bif->
+bif_desigd_pt
+)) {
+
+1012 
+	`bp_become_desigd_pt
+(
+sc
+, 
+bif
+);
+
+1013 
+	`bp_pt_e_i
+(
+sc
+);
+
+1015 
+	}
+}
+
+1018 
+	$bp_t_th_co
+(
+bridge_soc
+ *
+sc
+, 
+bridge_ii
+ *
+bif
+,
+
+1019 
+ut32_t
+ 
+th_co
+)
+
+1021 
+bif
+->
+bif_th_co
+ = 
+th_co
+;
+
+1022 
+	`bp_cfiguti_upde
+(
+sc
+);
+
+1023 
+	`bp_pt_e_i
+(
+sc
+);
+
+1024 
+	}
+}
+
+1028 
+	$bp_ifupdus
+(
+bridge_soc
+ *
+sc
+, 
+bridge_ii
+ *
+bif
+)
+
+1030 
+i
+ *
+i
+ = 
+bif
+->
+bif_i
+;
+
+1032 i(
+i
+->
+if_ags
+ & 
+IFF_UP
+) {
+
+1033 
+i
+->
+if_lk_e
+) {
+
+1034 
+LINK_STATE_UNKNOWN
+:
+
+1039 i(
+bif
+->
+bif_e
+ =
+BSTP_IFSTATE_DISABLED
+)
+
+1040 
+	`bp_ab_pt
+(
+sc
+, 
+bif
+);
+
+1043 
+LINK_STATE_UP
+:
+
+1044 i(
+bif
+->
+bif_e
+ =
+BSTP_IFSTATE_DISABLED
+)
+
+1045 
+	`bp_ab_pt
+(
+sc
+, 
+bif
+);
+
+1048 
+LINK_STATE_DOWN
+:
+
+1049 i(
+bif
+->
+bif_e
+ !
+BSTP_IFSTATE_DISABLED
+)
+
+1050 
+	`bp_dib_pt
+(
+sc
+, 
+bif
+);
+
+1056 i(
+bif
+->
+bif_e
+ !
+BSTP_IFSTATE_DISABLED
+)
+
+1057 
+	`bp_dib_pt
+(
+sc
+, 
+bif
+);
+
+1058 
+	}
+}
+
+1061 
+	$bp_tick
+(*
+g
+)
+
+1063 
+bridge_soc
+ *
+sc
+ = 
+g
+;
+
+1064 
+bridge_ii
+ *
+bif
+;
+
+1065 
+s
+;
+
+1067 
+s
+ = 
+	`
+();
+
+1068 
+	`BRIDGE_INTR_LOCK
+(
+sc
+);
+
+1070 
+	`LIST_FOREACH
+(
+bif
+, &
+sc
+->
+sc_ii
+, 
+bif_xt
+) {
+
+1071 i((
+bif
+->
+bif_ags
+ & 
+IFBIF_STP
+) == 0)
+
+1080 
+	`bp_ifupdus
+(
+sc
+, 
+bif
+);
+
+1083 i(
+	`bp_tim_exped
+(&
+sc
+->
+sc_hlo_tim
+, sc->
+sc_hlo_time
+))
+
+1084 
+	`bp_hlo_tim_expy
+(
+sc
+);
+
+1086 i(
+	`bp_tim_exped
+(&
+sc
+->
+sc_t_tim
+, sc->
+sc_bridge_hlo_time
+))
+
+1087 
+	`bp_t_tim_expy
+(
+sc
+);
+
+1089 i(
+	`bp_tim_exped
+(&
+sc
+->
+sc_togy_chge_tim
+,
+
+1090 
+sc
+->
+sc_togy_chge_time
+))
+
+1091 
+	`bp_togy_chge_tim_expy
+(
+sc
+);
+
+1093 
+	`LIST_FOREACH
+(
+bif
+, &
+sc
+->
+sc_ii
+, 
+bif_xt
+) {
+
+1094 i((
+bif
+->
+bif_ags
+ & 
+IFBIF_STP
+) == 0)
+
+1096 i(
+	`bp_tim_exped
+(&
+bif
+->
+bif_mesge_age_tim
+,
+
+1097 
+sc
+->
+sc_max_age
+))
+
+1098 
+	`bp_mesge_age_tim_expy
+(
+sc
+, 
+bif
+);
+
+1101 
+	`LIST_FOREACH
+(
+bif
+, &
+sc
+->
+sc_ii
+, 
+bif_xt
+) {
+
+1102 i((
+bif
+->
+bif_ags
+ & 
+IFBIF_STP
+) == 0)
+
+1104 i(
+	`bp_tim_exped
+(&
+bif
+->
+bif_fwd_day_tim
+,
+
+1105 
+sc
+->
+sc_fwd_day
+))
+
+1106 
+	`bp_fwd_day_tim_expy
+(
+sc
+, 
+bif
+);
+
+1108 i(
+	`bp_tim_exped
+(&
+bif
+->
+bif_hd_tim
+,
+
+1109 
+sc
+->
+sc_hd_time
+))
+
+1110 
+	`bp_hd_tim_expy
+(
+sc
+, 
+bif
+);
+
+1113 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_RUNNING
+)
+
+1114 
+	`out_t
+(&
+sc
+->
+sc_bpout
+, 
+hz
+, 
+bp_tick
+, sc);
+
+1116 
+	`BRIDGE_INTR_UNLOCK
+(
+sc
+);
+
+1117 
+	`lx
+(
+s
+);
+
+1118 
+	}
+}
+
+1121 
+	$bp_tim_t
+(
+bridge_tim
+ *
+t
+, 
+ut16_t
+ 
+v
+)
+
+1123 
+t
+->
+vue
+ = 
+v
+;
+
+1124 
+t
+->
+aive
+ = 1;
+
+1125 
+	}
+}
+
+1128 
+	$bp_tim_
+(
+bridge_tim
+ *
+t
+)
+
+1130 
+t
+->
+vue
+ = 0;
+
+1131 
+t
+->
+aive
+ = 0;
+
+1132 
+	}
+}
+
+1135 
+	$bp_tim_exped
+(
+bridge_tim
+ *
+t
+, 
+ut16_t
+ 
+v
+)
+
+1137 i(
+t
+->
+aive
+ == 0)
+
+1139 
+t
+->
+vue
+ +
+BSTP_TICK_VAL
+;
+
+1140 i(
+t
+->
+vue
+ >
+v
+) {
+
+1141 
+	`bp_tim_
+(
+t
+);
+
+1146 
+	}
+}
+
+	@bsd-comp.c
+
+43 
+	~<sys/cdefs.h
+>
+
+44 
+__KERNEL_RCSID
+(0, "$NetBSD: bsd-comp.c,v 1.20 2008/11/29 23:15:20 cube Exp $");
+
+46 
+	~<sys/m.h
+>
+
+47 
+	~<sys/sym.h
+>
+
+48 
+	~<sys/mbuf.h
+>
+
+49 
+	~<sys/sock.h
+>
+
+50 
+	~<sys/modu.h
+>
+
+51 
+	~<t/if.h
+>
+
+52 
+	~<t/if_tys.h
+>
+
+53 
+	~<t/p_defs.h
+>
+
+54 
+	~<t/if_p.h
+>
+
+56 
+	#PACKETPTR
+ 
+mbuf
+ *
+
+	)
+
+57 
+	~<t/p-comp.h
+>
+
+59 #i
+DO_BSD_COMPRESS
+
+
+85 
+	sbsd_db
+ {
+
+86 
+	mtn
+;
+
+87 
+u_t
+ 
+	mhsize
+;
+
+88 
+u_ch
+ 
+	mhshi
+;
+
+89 
+u_ch
+ 
+	mn_bs
+;
+
+90 
+u_ch
+ 
+	mmaxbs
+;
+
+91 
+u_ch
+ 
+	mdebug
+;
+
+92 
+u_ch
+ 
+	mun
+;
+
+93 
+ut16_t
+ 
+	mqno
+;
+
+94 
+u_t
+ 
+	mhd
+;
+
+95 
+u_t
+ 
+	mmru
+;
+
+96 
+u_t
+ 
+	mmaxmaxcode
+;
+
+97 
+u_t
+ 
+	mmax_t
+;
+
+98 
+u_t
+ 
+	m_cou
+;
+
+99 
+u_t
+ 
+	mbys_out
+;
+
+100 
+u_t
+ 
+	mtio
+;
+
+101 
+u_t
+ 
+	mcheckpot
+;
+
+102 
+u_t
+ 
+	mr_cou
+;
+
+103 
+u_t
+ 
+	mcomp_cou
+;
+
+104 
+u_t
+ 
+	mcomp_bys
+;
+
+105 
+u_t
+ 
+	muncomp_cou
+;
+
+106 
+u_t
+ 
+	muncomp_bys
+;
+
+107 
+u_t
+ 
+	mcomp_cou
+;
+
+108 
+u_t
+ 
+	mcomp_bys
+;
+
+109 
+ut16_t
+ *
+	mns
+;
+
+110 
+	sbsd_di
+ {
+
+112 
+ut32_t
+ 
+	mfcode
+;
+
+114 #i
+BYTE_ORDER
+ =
+LITTLE_ENDIAN
+
+
+115 
+ut16_t
+ 
+	mefix
+;
+
+116 
+u_ch
+ 
+	msuffix
+;
+
+117 
+u_ch
+ 
+	md
+;
+
+119 
+u_ch
+ 
+	md
+;
+
+120 
+u_ch
+ 
+	msuffix
+;
+
+121 
+ut16_t
+ 
+	mefix
+;
+
+123 } 
+	mhs
+;
+
+124 } 
+	mf
+;
+
+125 
+ut16_t
+ 
+	mcodem1
+;
+
+126 
+ut16_t
+ 
+	m
+;
+
+127 } 
+	mdi
+[1];
+
+130 
+	#BSD_OVHD
+ 2
+
+	)
+
+131 
+	#BSD_INIT_BITS
+ 
+BSD_MIN_BITS
+
+
+	)
+
+133 *
+bsd_comp_loc
+(
+u_ch
+ *
+tis
+, 
+t_n
+);
+
+134 *
+bsd_decomp_loc
+(
+u_ch
+ *
+tis
+, 
+t_n
+);
+
+135 
+bsd_
+(*
+e
+);
+
+136 
+bsd_comp_
+(*
+e
+, 
+u_ch
+ *
+tis
+, 
+t_n
+,
+
+137 
+un
+, 
+hd
+, 
+debug
+);
+
+138 
+bsd_decomp_
+(*
+e
+, 
+u_ch
+ *
+tis
+, 
+t_n
+,
+
+139 
+un
+, 
+hd
+, 
+mru
+, 
+debug
+);
+
+140 
+bsd_comess
+(*
+e
+, 
+mbuf
+ **
+mt
+,
+
+141 
+mbuf
+ *
+mp
+, 
+
+, 
+max
+);
+
+142 
+bsd_comp
+(*
+e
+, 
+mbuf
+ *
+dmsg
+);
+
+143 
+bsd_decomess
+(*
+e
+, 
+mbuf
+ *
+cmp
+,
+
+144 
+mbuf
+ **
+dm
+);
+
+145 
+bsd_t
+(*
+e
+);
+
+146 
+bsd_comp_s
+(*
+e
+, 
+comp
+ *
+s
+);
+
+151 
+comess
+ 
+	gp_bsd_comess
+ = {
+
+152 .
+comess_o
+ = 
+CI_BSD_COMPRESS
+,
+
+153 .
+	gcomp_loc
+ = 
+bsd_comp_loc
+,
+
+154 .
+	gcomp_
+ = 
+bsd_
+,
+
+155 .
+	gcomp_
+ = 
+bsd_comp_
+,
+
+156 .
+	gcomp_t
+ = 
+bsd_t
+,
+
+157 .
+	gcomess
+ = 
+bsd_comess
+,
+
+158 .
+	gcomp_
+ = 
+bsd_comp_s
+,
+
+159 .
+	gdecomp_loc
+ = 
+bsd_decomp_loc
+,
+
+160 .
+	gdecomp_
+ = 
+bsd_
+,
+
+161 .
+	gdecomp_
+ = 
+bsd_decomp_
+,
+
+162 .
+	gdecomp_t
+ = 
+bsd_t
+,
+
+163 .
+	gdecomess
+ = 
+bsd_decomess
+,
+
+164 .
+	gcomp
+ = 
+bsd_comp
+,
+
+165 .
+	gdecomp_
+ = 
+bsd_comp_s
+,
+
+172 
+	#CLEAR
+ 256
+
+	)
+
+173 
+	#FIRST
+ 257
+
+	)
+
+174 
+	#LAST
+ 255
+
+	)
+
+176 
+	#MAXCODE
+(
+b
+((1 << (b)- 1)
+
+	)
+
+177 
+	#BADCODEM1
+ 
+	`MAXCODE
+(
+BSD_MAX_BITS
+)
+
+	)
+
+179 
+	#BSD_HASH
+(
+efix
+,
+suffix
+,
+hshi
+((((
+ut32_t
+)(suffix)) << (hshift)) \
+
+180 ^ (
+ut32_t
+)(
+efix
+))
+
+	)
+
+181 
+	#BSD_KEY
+(
+efix
+,
+suffix
+((((
+ut32_t
+)(suffix)) << 16) \
+
+182 + (
+ut32_t
+)(
+efix
+))
+
+	)
+
+184 
+	#CHECK_GAP
+ 10000
+
+	)
+
+186 
+	#RATIO_SCALE_LOG
+ 8
+
+	)
+
+187 
+	#RATIO_SCALE
+ (1<<
+RATIO_SCALE_LOG
+)
+
+	)
+
+188 
+	#RATIO_MAX
+ (0x7fffffff>>
+RATIO_SCALE_LOG
+)
+
+	)
+
+190 
+bsd_r
+(
+bsd_db
+ *);
+
+191 
+bsd_check
+(
+bsd_db
+ *);
+
+192 *
+bsd_loc
+(
+u_ch
+ *, , );
+
+193 
+bsd_
+(
+bsd_db
+ *, 
+u_ch
+ *, , , , ,
+
+200 
+	$bsd_r
+(
+bsd_db
+ *
+db
+)
+
+202 
+db
+->
+r_cou
+++;
+
+203 
+db
+->
+max_t
+ = 
+FIRST
+-1;
+
+204 
+db
+->
+n_bs
+ = 
+BSD_INIT_BITS
+;
+
+205 
+db
+->
+tio
+ = 0;
+
+206 
+db
+->
+bys_out
+ = 0;
+
+207 
+db
+->
+_cou
+ = 0;
+
+208 
+db
+->
+checkpot
+ = 
+CHECK_GAP
+;
+
+209 
+	}
+}
+
+225 
+	$bsd_check
+(
+bsd_db
+ *
+db
+)
+
+227 
+u_t
+ 
+w_tio
+;
+
+229 i(
+db
+->
+_cou
+ >db->
+checkpot
+) {
+
+231 i(
+db
+->
+_cou
+ >
+RATIO_MAX
+
+
+232 || 
+db
+->
+bys_out
+ >
+RATIO_MAX
+) {
+
+233 
+db
+->
+_cou
+ -= db->in_count/4;
+
+234 
+db
+->
+bys_out
+ -= db->bytes_out/4;
+
+237 
+db
+->
+checkpot
+ = db->
+_cou
+ + 
+CHECK_GAP
+;
+
+239 i(
+db
+->
+max_t
+ >db->
+maxmaxcode
+) {
+
+247 
+w_tio
+ = 
+db
+->
+_cou
+ << 
+RATIO_SCALE_LOG
+;
+
+248 i(
+db
+->
+bys_out
+ != 0)
+
+249 
+w_tio
+ /
+db
+->
+bys_out
+;
+
+251 i(
+w_tio
+ < 
+db
+->
+tio
+ ||ew_ti< 1 * 
+RATIO_SCALE
+) {
+
+252 
+	`bsd_r
+(
+db
+);
+
+255 
+db
+->
+tio
+ = 
+w_tio
+;
+
+259 
+	}
+}
+
+265 
+	$bsd_comp_s
+(*
+e
+, 
+comp
+ *
+s
+)
+
+267 
+bsd_db
+ *
+db
+ = (bsd_db *
+e
+;
+
+268 
+u_t
+ 
+out
+;
+
+270 
+s
+->
+unc_bys
+ = 
+db
+->
+uncomp_bys
+;
+
+271 
+s
+->
+unc_cks
+ = 
+db
+->
+uncomp_cou
+;
+
+272 
+s
+->
+comp_bys
+ = 
+db
+->comp_bytes;
+
+273 
+s
+->
+comp_cks
+ = 
+db
+->
+comp_cou
+;
+
+274 
+s
+->
+c_bys
+ = 
+db
+->
+comp_bys
+;
+
+275 
+s
+->
+c_cks
+ = 
+db
+->
+comp_cou
+;
+
+276 
+s
+->
+tio
+ = 
+db
+->
+_cou
+;
+
+277 
+out
+ = 
+db
+->
+bys_out
+;
+
+278 i(
+s
+->
+tio
+ <= 0x7fffff)
+
+279 
+s
+->
+tio
+ <<= 8;
+
+281 
+out
+ >>= 8;
+
+282 i(
+out
+ != 0)
+
+283 
+s
+->
+tio
+ /
+out
+;
+
+284 
+	}
+}
+
+290 
+	$bsd_t
+(*
+e
+)
+
+292 
+bsd_db
+ *
+db
+ = (bsd_db *
+e
+;
+
+294 
+db
+->
+qno
+ = 0;
+
+295 
+	`bsd_r
+(
+db
+);
+
+296 
+db
+->
+r_cou
+ = 0;
+
+297 
+	}
+}
+
+303 
+	$bsd_loc
+(
+u_ch
+ *
+tis
+, 
+t_n
+, 
+decomp
+)
+
+305 
+bs
+;
+
+306 
+u_t
+ 
+wn
+, 
+hsize
+, 
+hshi
+, 
+maxmaxcode
+;
+
+307 
+bsd_db
+ *
+db
+;
+
+309 i(
+t_n
+ < 
+CILEN_BSD_COMPRESS
+ || 
+tis
+[0] !
+CI_BSD_COMPRESS
+
+
+310 || 
+tis
+[1] !
+CILEN_BSD_COMPRESS
+
+
+311 || 
+	`BSD_VERSION
+(
+tis
+[2]!
+BSD_CURRENT_VERSION
+)
+
+312  
+NULL
+;
+
+313 
+bs
+ = 
+	`BSD_NBITS
+(
+tis
+[2]);
+
+314 
+bs
+) {
+
+319 
+hsize
+ = 5003;
+
+320 
+hshi
+ = 4;
+
+323 
+hsize
+ = 9001;
+
+324 
+hshi
+ = 5;
+
+327 
+hsize
+ = 18013;
+
+328 
+hshi
+ = 6;
+
+331 
+hsize
+ = 35023;
+
+332 
+hshi
+ = 7;
+
+339  
+NULL
+;
+
+342 
+maxmaxcode
+ = 
+	`MAXCODE
+(
+bs
+);
+
+343 
+wn
+ = (*
+db
++ (
+hsize
+-1* ((db->
+di
+[0]));
+
+344 
+db
+ = 
+	`mloc
+(
+wn
+, 
+M_DEVBUF
+, 
+M_NOWAIT
+|
+M_ZERO
+);
+
+345 i(!
+db
+)
+
+346  
+NULL
+;
+
+348 i(!
+decomp
+) {
+
+349 
+db
+->
+ns
+ = 
+NULL
+;
+
+351 
+db
+->
+ns
+ = 
+	`mloc
+((
+maxmaxcode
++1) * (db->lens[0]),
+
+352 
+M_DEVBUF
+, 
+M_NOWAIT
+);
+
+353 i(!
+db
+->
+ns
+) {
+
+354 
+	`
+(
+db
+, 
+M_DEVBUF
+);
+
+355  
+NULL
+;
+
+359 
+db
+->
+tn
+ = 
+wn
+;
+
+360 
+db
+->
+hsize
+ = hsize;
+
+361 
+db
+->
+hshi
+ = hshift;
+
+362 
+db
+->
+maxmaxcode
+ = maxmaxcode;
+
+363 
+db
+->
+maxbs
+ = 
+bs
+;
+
+365  (*
+db
+;
+
+366 
+	}
+}
+
+369 
+	$bsd_
+(*
+e
+)
+
+371 
+bsd_db
+ *
+db
+ = (bsd_db *
+e
+;
+
+373 i(
+db
+->
+ns
+)
+
+374 
+	`
+(
+db
+->
+ns
+, 
+M_DEVBUF
+);
+
+375 
+	`
+(
+db
+, 
+M_DEVBUF
+);
+
+376 
+	}
+}
+
+379 
+	$bsd_comp_loc
+(
+u_ch
+ *
+tis
+, 
+t_n
+)
+
+381  
+	`bsd_loc
+(
+tis
+, 
+t_n
+, 0);
+
+382 
+	}
+}
+
+385 
+	$bsd_decomp_loc
+(
+u_ch
+ *
+tis
+, 
+t_n
+)
+
+387  
+	`bsd_loc
+(
+tis
+, 
+t_n
+, 1);
+
+388 
+	}
+}
+
+394 
+	$bsd_
+(
+bsd_db
+ *
+db
+, 
+u_ch
+ *
+tis
+, 
+t_n
+, 
+un
+, 
+hd
+,
+
+395 
+mru
+, 
+debug
+, 
+decomp
+)
+
+397 
+i
+;
+
+399 i(
+t_n
+ < 
+CILEN_BSD_COMPRESS
+ || 
+tis
+[0] !
+CI_BSD_COMPRESS
+
+
+400 || 
+tis
+[1] !
+CILEN_BSD_COMPRESS
+
+
+401 || 
+	`BSD_VERSION
+(
+tis
+[2]!
+BSD_CURRENT_VERSION
+
+
+402 || 
+	`BSD_NBITS
+(
+tis
+[2]!
+db
+->
+maxbs
+
+
+403 || (
+decomp
+ && 
+db
+->
+ns
+ =
+NULL
+))
+
+406 i(
+decomp
+) {
+
+407 
+i
+ = 
+LAST
++1;
+
+408 
+i
+ != 0)
+
+409 
+db
+->
+ns
+[--
+i
+] = 1;
+
+411 
+i
+ = 
+db
+->
+hsize
+;
+
+412 
+i
+ != 0) {
+
+413 
+db
+->
+di
+[--
+i
+].
+codem1
+ = 
+BADCODEM1
+;
+
+414 
+db
+->
+di
+[
+i
+].
+
+ = 0;
+
+417 
+db
+->
+un
+ = unit;
+
+418 
+db
+->
+hd
+ = hdrlen;
+
+419 
+db
+->
+mru
+ = mru;
+
+420 #ide
+DEBUG
+
+
+421 i(
+debug
+)
+
+423 
+db
+->
+debug
+ = 1;
+
+425 
+	`bsd_t
+(
+db
+);
+
+428 
+	}
+}
+
+431 
+	$bsd_comp_
+(*
+e
+, 
+u_ch
+ *
+tis
+, 
+t_n
+, 
+un
+, 
+hd
+,
+
+432 
+debug
+)
+
+434  
+	`bsd_
+((
+bsd_db
+ *
+e
+, 
+tis
+, 
+t_n
+,
+
+435 
+un
+, 
+hd
+, 0, 
+debug
+, 0);
+
+436 
+	}
+}
+
+439 
+	$bsd_decomp_
+(*
+e
+, 
+u_ch
+ *
+tis
+, 
+t_n
+, 
+un
+, 
+hd
+,
+
+440 
+mru
+, 
+debug
+)
+
+442  
+	`bsd_
+((
+bsd_db
+ *
+e
+, 
+tis
+, 
+t_n
+,
+
+443 
+un
+, 
+hd
+, 
+mru
+, 
+debug
+, 1);
+
+444 
+	}
+}
+
+453 
+	$bsd_comess
+(*
+e
+,
+
+454 
+mbuf
+ **
+mt
+ ,
+
+455 
+mbuf
+ *
+mp
+ ,
+
+456 
+
+, 
+max
+)
+
+458 
+bsd_db
+ *
+db
+ = (bsd_db *
+e
+;
+
+459 
+hshi
+ = 
+db
+->hshift;
+
+460 
+u_t
+ 
+max_t
+ = 
+db
+->max_ent;
+
+461 
+u_t
+ 
+n_bs
+ = 
+db
+->n_bits;
+
+462 
+u_t
+ 
+bno
+ = 32;
+
+463 
+ut32_t
+ 
+accm
+ = 0, 
+fcode
+;
+
+464 
+bsd_di
+ *
+dip
+;
+
+465 
+u_ch
+ 
+c
+;
+
+466 
+hv
+, 
+di
+, 
+t
+, 
+
+;
+
+467 
+u_ch
+ *
+
+, *
+wr
+;
+
+468 
+u_ch
+ *
+_d
+;
+
+469 
+
+;
+
+470 
+mbuf
+ *
+m
+;
+
+472 
+	#PUTBYTE
+(
+v
+) { \
+
+473 ++
+
+; \
+
+474 i(
+wr
+) { \
+
+475 *
+wr
+++ = (
+v
+); \
+
+476 i(
+wr
+ >
+_d
+) { \
+
+477 
+m
+->
+m_n
+ = 
+wr
+ - 
+	`mtod
+(m, 
+u_ch
+ *); \
+
+478 
+	`MGET
+(
+m
+->
+m_xt
+, 
+M_DONTWAIT
+, 
+MT_DATA
+); \
+
+479 
+m
+ = m->
+m_xt
+; \
+
+480 i(
+m
+) { \
+
+481 
+m
+->
+m_n
+ = 0; \
+
+482 i(
+max
+ - 
+
+ > 
+MLEN
+) \
+
+483 
+	`MCLGET
+(
+m
+, 
+M_DONTWAIT
+); \
+
+484 
+wr
+ = 
+	`mtod
+(
+m
+, 
+u_ch
+ *); \
+
+485 
+_d
+ = 
+wr
+ + 
+	`M_TRAILINGSPACE
+(
+m
+); \
+
+487 
+wr
+ = 
+NULL
+; \
+
+490 }
+
+	)
+
+492 
+	#OUTPUT
+(
+t
+) { \
+
+493 
+bno
+ -
+n_bs
+; \
+
+494 
+accm
+ |((
+t
+<< 
+bno
+); \
+
+496 
+	`PUTBYTE
+(
+accm
+ >> 24); \
+
+497 
+accm
+ <<= 8; \
+
+498 
+bno
+ += 8; \
+
+499 } 
+bno
+ <= 24); \
+
+500 }
+
+	)
+
+507 
+
+ = 
+	`mtod
+(
+mp
+, 
+u_ch
+ *);
+
+508 
+t
+ = 
+	`PPP_PROTOCOL
+(
+
+);
+
+509 i(
+t
+ < 0x21 ||nt > 0xf9) {
+
+510 *
+mt
+ = 
+NULL
+;
+
+511  
+
+;
+
+516 i(
+max
+ > 
+
+)
+
+517 
+max
+ = 
+
+;
+
+520 
+	`MGET
+(
+m
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+521 *
+mt
+ = 
+m
+;
+
+522 i(
+m
+ !
+NULL
+) {
+
+523 
+m
+->
+m_n
+ = 0;
+
+524 i(
+max
+ + 
+db
+->
+hd
+ > 
+MLEN
+)
+
+525 
+	`MCLGET
+(
+m
+, 
+M_DONTWAIT
+);
+
+526 
+m
+->
+m_da
+ +
+db
+->
+hd
+;
+
+527 
+wr
+ = 
+	`mtod
+(
+m
+, 
+u_ch
+ *);
+
+528 
+_d
+ = 
+wr
+ + 
+	`M_TRAILINGSPACE
+(
+m
+);
+
+530 
+wr
+ = 
+_d
+ = 
+NULL
+;
+
+536 i(
+wr
+) {
+
+537 *
+wr
+++ = 
+	`PPP_ADDRESS
+(
+
+);
+
+538 *
+wr
+++ = 
+	`PPP_CONTROL
+(
+
+);
+
+539 *
+wr
+++ = 0;
+
+540 *
+wr
+++ = 
+PPP_COMP
+;
+
+541 *
+wr
+++ = 
+db
+->
+qno
+ >> 8;
+
+542 *
+wr
+++ = 
+db
+->
+qno
+;
+
+544 ++
+db
+->
+qno
+;
+
+546 
+
+ = 0;
+
+547 
+
+ +
+PPP_HDRLEN
+;
+
+548 
+
+ = 
+mp
+->
+m_n
+ - 
+PPP_HDRLEN
+;
+
+549 
+
+ = 
+
+ + 1;
+
+551 i(
+
+ <= 0) {
+
+552 
+mp
+ = mp->
+m_xt
+;
+
+553 i(!
+mp
+)
+
+555 
+
+ = 
+	`mtod
+(
+mp
+, 
+u_ch
+ *);
+
+556 
+
+ = 
+mp
+->
+m_n
+;
+
+557 i(!
+
+)
+
+559 
+
+ +
+
+;
+
+562 
+
+--;
+
+563 
+c
+ = *
+
+++;
+
+564 
+fcode
+ = 
+	`BSD_KEY
+(
+t
+, 
+c
+);
+
+565 
+hv
+ = 
+	`BSD_HASH
+(
+t
+, 
+c
+, 
+hshi
+);
+
+566 
+dip
+ = &
+db
+->
+di
+[
+hv
+];
+
+569 i(
+dip
+->
+codem1
+ >
+max_t
+)
+
+570 
+nomch
+;
+
+571 i(
+dip
+->
+f
+.
+fcode
+ == fcode) {
+
+572 
+t
+ = 
+dip
+->
+codem1
++1;
+
+577 
+di
+ = (
+hv
+ == 0) ? 1 : hval;
+
+579 
+hv
+ +
+di
+;
+
+580 i(
+hv
+ >
+db
+->
+hsize
+)
+
+581 
+hv
+ -
+db
+->
+hsize
+;
+
+582 
+dip
+ = &
+db
+->
+di
+[
+hv
+];
+
+583 i(
+dip
+->
+codem1
+ >
+max_t
+)
+
+584 
+nomch
+;
+
+585 } 
+dip
+->
+f
+.
+fcode
+ != fcode);
+
+586 
+t
+ = 
+dip
+->
+codem1
+ + 1;
+
+589 
+nomch
+:
+
+590 
+	`OUTPUT
+(
+t
+);
+
+593 i(
+max_t
+ < 
+db
+->
+maxmaxcode
+) {
+
+594 
+bsd_di
+ *
+dip2
+;
+
+596 i(
+max_t
+ >
+	`MAXCODE
+(
+n_bs
+))
+
+597 
+db
+->
+n_bs
+ = ++n_bits;
+
+602 
+dip2
+ = &
+db
+->
+di
+[
+max_t
++1];
+
+603 i(
+db
+->
+di
+[
+dip2
+->
+
+].
+codem1
+ =
+max_t
+)
+
+604 
+db
+->
+di
+[
+dip2
+->
+
+].
+codem1
+ = 
+BADCODEM1
+;
+
+605 
+dip2
+->
+
+ = 
+hv
+;
+
+606 
+dip
+->
+codem1
+ = 
+max_t
+;
+
+607 
+dip
+->
+f
+.
+fcode
+ = fcode;
+
+609 
+db
+->
+max_t
+ = ++max_ent;
+
+611 
+t
+ = 
+c
+;
+
+614 
+	`OUTPUT
+(
+t
+);
+
+615 
+db
+->
+bys_out
+ +
+
+;
+
+616 
+db
+->
+_cou
+ +
+
+;
+
+617 i(
+bno
+ < 32)
+
+618 ++
+db
+->
+bys_out
+;
+
+620 i(
+	`bsd_check
+(
+db
+))
+
+621 
+	`OUTPUT
+(
+CLEAR
+);
+
+627 i(
+bno
+ != 32)
+
+628 
+	`PUTBYTE
+((
+accm
+ | (0xf<< (
+bno
+-8))) >> 24);
+
+630 i(
+m
+ !
+NULL
+) {
+
+631 
+m
+->
+m_n
+ = 
+wr
+ - 
+	`mtod
+(m, 
+u_ch
+ *);
+
+632 
+m
+->
+m_xt
+ = 
+NULL
+;
+
+639 i(
+max_t
+ >
+	`MAXCODE
+(
+n_bs
+&& max_< 
+db
+->
+maxmaxcode
+)
+
+640 
+db
+->
+n_bs
+++;
+
+642 
+db
+->
+uncomp_bys
+ +
+
+;
+
+643 ++
+db
+->
+uncomp_cou
+;
+
+644 i(
+
+ + 
+PPP_HDRLEN
+ + 
+BSD_OVHD
+ > 
+max
+) {
+
+646 i(*
+mt
+ !
+NULL
+) {
+
+647 
+	`m_m
+(*
+mt
+);
+
+648 *
+mt
+ = 
+NULL
+;
+
+650 ++
+db
+->
+comp_cou
+;
+
+651 
+db
+->
+comp_bys
+ +
+
+;
+
+653 ++
+db
+->
+comp_cou
+;
+
+654 
+db
+->
+comp_bys
+ +
+
+ + 
+BSD_OVHD
+;
+
+657  
+
+ + 
+PPP_HDRLEN
+ + 
+BSD_OVHD
+;
+
+658 #unde
+OUTPUT
+
+
+659 #unde
+PUTBYTE
+
+
+660 
+	}
+}
+
+668 
+	$bsd_comp
+(*
+e
+, 
+mbuf
+ *
+dmsg
+)
+
+670 
+bsd_db
+ *
+db
+ = (bsd_db *
+e
+;
+
+671 
+u_t
+ 
+hshi
+ = 
+db
+->hshift;
+
+672 
+u_t
+ 
+max_t
+ = 
+db
+->max_ent;
+
+673 
+u_t
+ 
+n_bs
+ = 
+db
+->n_bits;
+
+674 
+bsd_di
+ *
+dip
+;
+
+675 
+ut32_t
+ 
+fcode
+;
+
+676 
+u_ch
+ 
+c
+;
+
+677 
+ut32_t
+ 
+hv
+, 
+di
+;
+
+678 
+
+, 
+
+;
+
+679 
+u_t
+ 
+bno
+ = 7;
+
+680 
+u_ch
+ *
+
+;
+
+681 
+u_t
+ 
+t
+;
+
+688 
+
+ = 
+	`mtod
+(
+dmsg
+, 
+u_ch
+ *);
+
+689 
+t
+ = 
+	`PPP_PROTOCOL
+(
+
+);
+
+690 i(
+t
+ < 0x21 ||nt > 0xf9)
+
+693 
+db
+->
+qno
+++;
+
+694 
+
+ = 1;
+
+695 
+
+ +
+PPP_HDRLEN
+;
+
+696 
+
+ = 
+dmsg
+->
+m_n
+ - 
+PPP_HDRLEN
+;
+
+698 i(
+
+ <= 0) {
+
+699 
+dmsg
+ = dmsg->
+m_xt
+;
+
+700 i(!
+dmsg
+)
+
+702 
+
+ = 
+	`mtod
+(
+dmsg
+, 
+u_ch
+ *);
+
+703 
+
+ = 
+dmsg
+->
+m_n
+;
+
+706 
+
+ +
+
+;
+
+709 
+c
+ = *
+
+++;
+
+710 
+fcode
+ = 
+	`BSD_KEY
+(
+t
+, 
+c
+);
+
+711 
+hv
+ = 
+	`BSD_HASH
+(
+t
+, 
+c
+, 
+hshi
+);
+
+712 
+dip
+ = &
+db
+->
+di
+[
+hv
+];
+
+715 i(
+dip
+->
+codem1
+ >
+max_t
+)
+
+716 
+nomch
+;
+
+717 i(
+dip
+->
+f
+.
+fcode
+ == fcode) {
+
+718 
+t
+ = 
+dip
+->
+codem1
++1;
+
+723 
+di
+ = (
+hv
+ == 0) ? 1 : hval;
+
+725 
+hv
+ +
+di
+;
+
+726 i(
+hv
+ >
+db
+->
+hsize
+)
+
+727 
+hv
+ -
+db
+->
+hsize
+;
+
+728 
+dip
+ = &
+db
+->
+di
+[
+hv
+];
+
+729 i(
+dip
+->
+codem1
+ >
+max_t
+)
+
+730 
+nomch
+;
+
+731 } 
+dip
+->
+f
+.
+fcode
+ != fcode);
+
+732 
+t
+ = 
+dip
+->
+codem1
++1;
+
+735 
+nomch
+:
+
+736 
+bno
+ +
+n_bs
+;
+
+739 i(
+max_t
+ < 
+db
+->
+maxmaxcode
+) {
+
+740 
+bsd_di
+ *
+dip2
+;
+
+742 i(
+max_t
+ >
+	`MAXCODE
+(
+n_bs
+))
+
+743 
+db
+->
+n_bs
+ = ++n_bits;
+
+748 
+dip2
+ = &
+db
+->
+di
+[
+max_t
++1];
+
+749 i(
+db
+->
+di
+[
+dip2
+->
+
+].
+codem1
+ =
+max_t
+)
+
+750 
+db
+->
+di
+[
+dip2
+->
+
+].
+codem1
+ = 
+BADCODEM1
+;
+
+751 
+dip2
+->
+
+ = 
+hv
+;
+
+752 
+dip
+->
+codem1
+ = 
+max_t
+;
+
+753 
+dip
+->
+f
+.
+fcode
+ = fcode;
+
+755 
+db
+->
+max_t
+ = ++max_ent;
+
+756 
+db
+->
+ns
+[
+max_t
+] = db->ns[
+t
+]+1;
+
+758 
+t
+ = 
+c
+;
+
+759 } --
+
+ != 0);
+
+761 
+bno
+ +
+n_bs
+;
+
+762 
+db
+->
+bys_out
+ +
+bno
+/8;
+
+763 
+db
+->
+_cou
+ +
+
+;
+
+764 ()
+	`bsd_check
+(
+db
+);
+
+766 ++
+db
+->
+comp_cou
+;
+
+767 
+db
+->
+comp_bys
+ +
+
+;
+
+768 ++
+db
+->
+uncomp_cou
+;
+
+769 
+db
+->
+uncomp_bys
+ +
+
+;
+
+774 i(
+max_t
+ >
+	`MAXCODE
+(
+n_bs
+&& max_< 
+db
+->
+maxmaxcode
+)
+
+775 
+db
+->
+n_bs
+++;
+
+776 
+	}
+}
+
+796 
+	$bsd_decomess
+(*
+e
+, 
+mbuf
+ *
+cmp
+, mbu**
+dm
+)
+
+798 
+bsd_db
+ *
+db
+ = (bsd_db *
+e
+;
+
+799 
+u_t
+ 
+max_t
+ = 
+db
+->max_ent;
+
+800 
+ut32_t
+ 
+accm
+ = 0;
+
+801 
+u_t
+ 
+bno
+ = 32;
+
+802 
+u_t
+ 
+n_bs
+ = 
+db
+->n_bits;
+
+803 
+u_t
+ 
+tgtbno
+ = 32-
+n_bs
+;
+
+804 
+bsd_di
+ *
+dip
+;
+
+805 
+ex
+, 
+i
+, 
+q
+, 
+n
+;
+
+806 
+u_t
+ 
+code
+, 
+dcode
+, 
+fch
+;
+
+807 
+u_ch
+ *
+p
+, *
+
+, *
+wr
+;
+
+808 
+mbuf
+ *
+m
+, *
+dmp
+, *
+mt
+;
+
+809 
+adrs
+, 
+
+, 
+
+;
+
+810 
+a
+, 
+cod
+, 
+exa
+;
+
+816 *
+dm
+ = 
+NULL
+;
+
+817 
+
+ = 
+	`mtod
+(
+cmp
+, 
+u_ch
+ *);
+
+818 
+adrs
+ = 
+	`PPP_ADDRESS
+(
+
+);
+
+819 
+
+ = 
+	`PPP_CONTROL
+(
+
+);
+
+820 
+
+ +
+PPP_HDRLEN
+;
+
+821 
+n
+ = 
+cmp
+->
+m_n
+ - 
+PPP_HDRLEN
+;
+
+822 
+q
+ = 0;
+
+823 
+i
+ = 0; i < 2; ++i) {
+
+824 
+n
+ <= 0) {
+
+825 
+cmp
+ = cmp->
+m_xt
+;
+
+826 i(
+cmp
+ =
+NULL
+)
+
+827  
+DECOMP_ERROR
+;
+
+828 
+
+ = 
+	`mtod
+(
+cmp
+, 
+u_ch
+ *);
+
+829 
+n
+ = 
+cmp
+->
+m_n
+;
+
+831 
+q
+ = (q << 8+ *
+
+++;
+
+832 --
+n
+;
+
+839 i(
+q
+ !
+db
+->
+qno
+) {
+
+840 i(
+db
+->
+debug
+)
+
+841 
+	`tf
+("bsd_decomp%d: bad sequence # %d,xpected %d\n",
+
+842 
+db
+->
+un
+, 
+q
+, db->
+qno
+ - 1);
+
+843  
+DECOMP_ERROR
+;
+
+845 ++
+db
+->
+qno
+;
+
+850 
+	`MGETHDR
+(
+dmp
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+851 i(
+dmp
+ =
+NULL
+)
+
+852  
+DECOMP_ERROR
+;
+
+853 
+mt
+ = 
+dmp
+;
+
+854 
+dmp
+->
+m_n
+ = 0;
+
+855 
+dmp
+->
+m_xt
+ = 
+NULL
+;
+
+856 
+	`MCLGET
+(
+dmp
+, 
+M_DONTWAIT
+);
+
+857 
+dmp
+->
+m_da
+ +
+db
+->
+hd
+;
+
+858 
+wr
+ = 
+	`mtod
+(
+dmp
+, 
+u_ch
+ *);
+
+859 
+a
+ = 
+	`M_TRAILINGSPACE
+(
+dmp
+- 
+PPP_HDRLEN
+ + 1;
+
+865 
+wr
+[0] = 
+adrs
+;
+
+866 
+wr
+[1] = 
+
+;
+
+867 
+wr
+[2] = 0;
+
+868 
+wr
+ +
+PPP_HDRLEN
+ - 1;
+
+870 
+
+ = 
+n
+;
+
+871 
+dcode
+ = 
+CLEAR
+;
+
+872 
+ex
+ = 0;
+
+874 i(
+n
+ == 0) {
+
+875 
+cmp
+ = cmp->
+m_xt
+;
+
+876 i(!
+cmp
+)
+
+878 
+
+ = 
+	`mtod
+(
+cmp
+, 
+u_ch
+ *);
+
+879 
+n
+ = 
+cmp
+->
+m_n
+;
+
+880 
+
+ +
+n
+;
+
+889 
+bno
+ -= 8;
+
+890 
+accm
+ |*
+
+++ << 
+bno
+;
+
+891 --
+n
+;
+
+892 i(
+tgtbno
+ < 
+bno
+)
+
+894 
+code
+ = 
+accm
+ >> 
+tgtbno
+;
+
+895 
+accm
+ <<
+n_bs
+;
+
+896 
+bno
+ +
+n_bs
+;
+
+898 i(
+code
+ =
+CLEAR
+) {
+
+904 i(
+n
+ > 0 || 
+cmp
+->
+m_xt
+ !
+NULL
+) {
+
+905 (
+cmp
+ = cmp->
+m_xt
+!
+NULL
+)
+
+906 
+n
+ +
+cmp
+->
+m_n
+;
+
+907 i(
+n
+ > 0) {
+
+908 
+	`m_m
+(
+mt
+);
+
+909 i(
+db
+->
+debug
+)
+
+910 
+	`tf
+("bsd_decomp%d: bad CLEAR\n", 
+db
+->
+un
+);
+
+911  
+DECOMP_FATALERROR
+;
+
+914 
+	`bsd_r
+(
+db
+);
+
+915 
+ex
+ = 
+
+ = 0;
+
+919 i(
+code
+ > 
+max_t
+ + 2 || incod> 
+db
+->
+maxmaxcode
+
+
+920 || (
+code
+ > 
+max_t
+ && 
+dcode
+ =
+CLEAR
+)) {
+
+921 
+	`m_m
+(
+mt
+);
+
+922 i(
+db
+->
+debug
+) {
+
+923 
+	`tf
+("bsd_decomp%d: bad code 0x%x oldcode=0x%x ",
+
+924 
+db
+->
+un
+, 
+code
+, 
+dcode
+);
+
+925 
+	`tf
+("max_ent=0x%xxplen=%d seqno=%d\n",
+
+926 
+max_t
+, 
+ex
+, 
+db
+->
+qno
+);
+
+928  
+DECOMP_FATALERROR
+;
+
+932 i(
+code
+ > 
+max_t
+) {
+
+933 
+fch
+ = 
+dcode
+;
+
+934 
+exa
+ = 1;
+
+936 
+fch
+ = 
+code
+;
+
+937 
+exa
+ = 0;
+
+940 
+cod
+ = 
+db
+->
+ns
+[
+fch
+];
+
+941 
+ex
+ +
+cod
+ + 
+exa
+;
+
+942 i(
+ex
+ > 
+db
+->
+mru
+ + 1) {
+
+943 
+	`m_m
+(
+mt
+);
+
+944 i(
+db
+->
+debug
+) {
+
+945 
+	`tf
+("bsd_decomp%d: ouomru\n", 
+db
+->
+un
+);
+
+946 #ifde
+DEBUG
+
+
+947 (
+cmp
+ = cmp->
+m_xt
+!
+NULL
+)
+
+948 
+n
+ +
+cmp
+->
+m_n
+;
+
+949 
+	`tf
+("en=%d, finchar=0x%x, codelen=%d,xplen=%d\n",
+
+950 
+n
+, 
+fch
+, 
+cod
+, 
+ex
+);
+
+953  
+DECOMP_FATALERROR
+;
+
+960 i((
+a
+ -
+cod
+ + 
+exa
+) < 0) {
+
+961 
+dmp
+->
+m_n
+ = 
+wr
+ - 
+	`mtod
+(dmp, 
+u_ch
+ *);
+
+962 
+	`MGET
+(
+m
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+963 i(
+m
+ =
+NULL
+) {
+
+964 
+	`m_m
+(
+mt
+);
+
+965  
+DECOMP_ERROR
+;
+
+967 
+m
+->
+m_n
+ = 0;
+
+968 
+m
+->
+m_xt
+ = 
+NULL
+;
+
+969 
+dmp
+->
+m_xt
+ = 
+m
+;
+
+970 
+	`MCLGET
+(
+m
+, 
+M_DONTWAIT
+);
+
+971 
+a
+ = 
+	`M_TRAILINGSPACE
+(
+m
+- (
+cod
+ + 
+exa
+);
+
+972 i(
+a
+ < 0) {
+
+974 
+	`m_m
+(
+mt
+);
+
+975  
+DECOMP_ERROR
+;
+
+977 
+dmp
+ = 
+m
+;
+
+978 
+wr
+ = 
+	`mtod
+(
+dmp
+, 
+u_ch
+ *);
+
+984 
+p
+ = (
+wr
+ +
+cod
+);
+
+985 
+fch
+ > 
+LAST
+) {
+
+986 
+dip
+ = &
+db
+->
+di
+[db->di[
+fch
+].
+
+];
+
+987 #ifde
+DEBUG
+
+
+988 i(--
+cod
+ <0 || 
+dip
+->
+codem1
+ !
+fch
+-1)
+
+989 
+bad
+;
+
+991 *--
+p
+ = 
+dip
+->
+f
+.
+hs
+.
+suffix
+;
+
+992 
+fch
+ = 
+dip
+->
+f
+.
+hs
+.
+efix
+;
+
+994 *--
+p
+ = 
+fch
+;
+
+996 #ifde
+DEBUG
+
+
+997 i(--
+cod
+ != 0)
+
+998 
+	`tf
+("bsd_decomp%d: short by %dfter code 0x%x, max_ent=0x%x\n",
+
+999 
+db
+->
+un
+, 
+cod
+, 
+code
+, 
+max_t
+);
+
+1002 i(
+exa
+)
+
+1003 *
+wr
+++ = 
+fch
+;
+
+1012 i(
+dcode
+ !
+CLEAR
+ && 
+max_t
+ < 
+db
+->
+maxmaxcode
+) {
+
+1013 
+bsd_di
+ *
+dip2
+;
+
+1014 
+ut32_t
+ 
+fcode
+;
+
+1015 
+ut32_t
+ 
+hv
+, 
+di
+;
+
+1017 
+fcode
+ = 
+	`BSD_KEY
+(
+dcode
+,
+fch
+);
+
+1018 
+hv
+ = 
+	`BSD_HASH
+(
+dcode
+,
+fch
+,
+db
+->
+hshi
+);
+
+1019 
+dip
+ = &
+db
+->
+di
+[
+hv
+];
+
+1022 i(
+dip
+->
+codem1
+ < 
+max_t
+) {
+
+1023 
+di
+ = (
+hv
+ == 0) ? 1 : hval;
+
+1025 
+hv
+ +
+di
+;
+
+1026 i(
+hv
+ >
+db
+->
+hsize
+)
+
+1027 
+hv
+ -
+db
+->
+hsize
+;
+
+1028 
+dip
+ = &
+db
+->
+di
+[
+hv
+];
+
+1029 } 
+dip
+->
+codem1
+ < 
+max_t
+);
+
+1036 
+dip2
+ = &
+db
+->
+di
+[
+max_t
++1];
+
+1037 i(
+db
+->
+di
+[
+dip2
+->
+
+].
+codem1
+ =
+max_t
+) {
+
+1038 
+db
+->
+di
+[
+dip2
+->
+
+].
+codem1
+ = 
+BADCODEM1
+;
+
+1040 
+dip2
+->
+
+ = 
+hv
+;
+
+1041 
+dip
+->
+codem1
+ = 
+max_t
+;
+
+1042 
+dip
+->
+f
+.
+fcode
+ = fcode;
+
+1044 
+db
+->
+max_t
+ = ++max_ent;
+
+1045 
+db
+->
+ns
+[
+max_t
+] = db->ns[
+dcode
+]+1;
+
+1048 i(
+max_t
+ >
+	`MAXCODE
+(
+n_bs
+&& max_< 
+db
+->
+maxmaxcode
+) {
+
+1049 
+db
+->
+n_bs
+ = ++n_bits;
+
+1050 
+tgtbno
+ = 32-
+n_bs
+;
+
+1053 
+dcode
+ = 
+code
+;
+
+1055 
+dmp
+->
+m_n
+ = 
+wr
+ - 
+	`mtod
+(dmp, 
+u_ch
+ *);
+
+1061 
+db
+->
+bys_out
+ +
+
+;
+
+1062 
+db
+->
+_cou
+ +
+ex
+;
+
+1063 i(
+	`bsd_check
+(
+db
+&& db->
+debug
+) {
+
+1064 
+	`tf
+("bsd_decomp%d:eer should have cleared dictionary\n",
+
+1065 
+db
+->
+un
+);
+
+1068 ++
+db
+->
+comp_cou
+;
+
+1069 
+db
+->
+comp_bys
+ +
+
+ + 
+BSD_OVHD
+;
+
+1070 ++
+db
+->
+uncomp_cou
+;
+
+1071 
+db
+->
+uncomp_bys
+ +
+ex
+;
+
+1073 *
+dm
+ = 
+mt
+;
+
+1074  
+DECOMP_OK
+;
+
+1076 #ifde
+DEBUG
+
+
+1077 
+bad
+:
+
+1078 i(
+cod
+ <= 0) {
+
+1079 
+	`tf
+("bsd_decomp%d: fofd ocha ", 
+db
+->
+un
+);
+
+1080 
+	`tf
+("0x%xt 0x%x by 0x%x, max_ent=0x%x\n",
+
+1081 
+code
+, 
+fch
+, 
+db
+->
+di
+[fch].
+
+, 
+max_t
+);
+
+1082 } i(
+dip
+->
+codem1
+ !
+fch
+-1) {
+
+1083 
+	`tf
+("bsd_decomp%d: bad code chain 0x%x finchar=0x%x ",
+
+1084 
+db
+->
+un
+, 
+code
+, 
+fch
+);
+
+1085 
+	`tf
+("dcode=0x%x cr=0x%x codem1=0x%x\n", 
+dcode
+,
+
+1086 
+db
+->
+di
+[
+fch
+].
+
+, 
+dip
+->
+codem1
+);
+
+1088 
+	`m_m
+(
+mt
+);
+
+1089  
+DECOMP_FATALERROR
+;
+
+1091 
+	}
+}
+
+1093 
+MODULE
+(
+MODULE_CLASS_MISC
+, 
+p_bsdcomp
+, 
+NULL
+);
+
+1096 
+	$p_bsdcomp_modcmd
+(
+modcmd_t
+ 
+cmd
+, *
+g
+)
+
+1099 
+cmd
+) {
+
+1100 
+MODULE_CMD_INIT
+:
+
+1101  
+	`p_gi_comess
+(&
+p_bsd_comess
+, 1);
+
+1102 
+MODULE_CMD_FINI
+:
+
+1103  
+	`p_uegi_comess
+(&
+p_bsd_comess
+, 1);
+
+1104 
+MODULE_CMD_STAT
+:
+
+1107  
+ENOTTY
+;
+
+1110  
+ENOTTY
+;
+
+1111 
+	}
+}
+
+	@dl_print.c
+
+28 
+	~<sys/cdefs.h
+>
+
+29 
+	~<sys/tys.h
+>
+
+31 #ifde
+_KERNEL
+
+
+32 
+__KERNEL_RCSID
+(0, "$NetBSD: dl_print.c,v 1.2 2014/12/02 19:34:33 christos Exp $");
+
+33 
+	~<sys/sym.h
+>
+
+35 
+__RCSID
+("$NetBSD: dl_print.c,v 1.2 2014/12/02 19:34:33 christos Exp $");
+
+36 
+	~<dio.h
+>
+
+37 c 
+ut8_t
+ 
+	ghexdigs
+[] = "0123456789abcdef";
+
+39 
+	~<t/if_dl.h
+>
+
+42 
+	$dl_t
+(*
+buf
+, 
+size_t
+ 
+n
+, c 
+dl_addr
+ *
+dl
+)
+
+44 c 
+ut8_t
+ *
+
+ = (c ut8_*)
+dl
+->
+dl_da
+;
+
+45 
+abuf
+[256 * 3], *
+
+, *
+e
+;
+
+47 
+
+ +
+dl
+->
+dl_
+;
+
+48 
+
+ = 
+abuf
+;
+
+49 
+e
+ = 
+abuf
+ + (abuf);
+
+51 
+	#ADDC
+(
+c
+) do { \
+
+52 i(
+
+ >
+e
+) {\
+
+53 
+
+++; \
+
+55 *
+
+++ = ()(
+c
+); \
+
+56 }  0)
+
+	)
+
+58 
+	#ADDX
+(
+v
+) do { \
+
+59 
+ut8_t
+ 
+n
+ = 
+hexdigs
+[(
+v
+)]; \
+
+60 
+	`ADDC
+(
+n
+); \
+
+61 }  0)
+
+	)
+
+63 
+size_t
+ 
+i
+ = 0; i < 
+dl
+->
+dl_
+; i++) {
+
+64 
+	`ADDX
+((
+u_t
+)
+
+[
+i
+] >> 4);
+
+65 
+	`ADDX
+(
+
+[
+i
+] & 0xf);
+
+66 
+	`ADDC
+(':');
+
+68 i(
+
+ > 
+abuf
+)
+
+69 --
+
+;
+
+70 i(
+e
+ > 
+abuf
+) {
+
+71 i(
+
+ < 
+e
+)
+
+72 *
+
+ = '\0';
+
+74 *--
+e
+ = '\0';
+
+76  
+	`tf
+(
+buf
+, 
+n
+, "%.*s/%hhu#%s",
+
+77 ()
+dl
+->
+dl_
+, dl->
+dl_da
+, dl->
+dl_ty
+, 
+abuf
+);
+
+78 
+	}
+}
+
+81 
+	$sdl_t
+(*
+buf
+, 
+size_t
+ 
+n
+, c *
+v
+)
+
+83 c 
+sockaddr_dl
+ *
+sdl
+ = 
+v
+;
+
+84 
+abuf
+[
+LINK_ADDRSTRLEN
+];
+
+86 
+	`dl_t
+(
+abuf
+, buf), &
+sdl
+->
+sdl_addr
+);
+
+87  
+	`tf
+(
+buf
+, 
+n
+, "[%s]:%hu", 
+abuf
+, 
+sdl
+->
+sdl_dex
+);
+
+88 
+	}
+}
+
+	@dlt.h
+
+45 #ide
+_NET_DLT_H_
+
+
+46 
+	#_NET_DLT_H_
+
+
+	)
+
+69 
+	#DLT_NULL
+ 0
+
+	)
+
+70 
+	#DLT_EN10MB
+ 1
+
+	)
+
+71 
+	#DLT_EN3MB
+ 2
+
+	)
+
+72 
+	#DLT_AX25
+ 3
+
+	)
+
+73 
+	#DLT_PRONET
+ 4
+
+	)
+
+74 
+	#DLT_CHAOS
+ 5
+
+	)
+
+75 
+	#DLT_IEEE802
+ 6
+
+	)
+
+76 
+	#DLT_ARCNET
+ 7
+
+	)
+
+77 
+	#DLT_SLIP
+ 8
+
+	)
+
+78 
+	#DLT_PPP
+ 9
+
+	)
+
+79 
+	#DLT_FDDI
+ 10
+
+	)
+
+90 
+	#DLT_ATM_RFC1483
+ 11
+
+	)
+
+92 #ifde
+__OnBSD__
+
+
+93 
+	#DLT_RAW
+ 14
+
+	)
+
+95 
+	#DLT_RAW
+ 12
+
+	)
+
+104 #i
+defed
+(
+__NBSD__
+|| defed(
+__FeBSD__
+)
+
+105 #ide
+DLT_SLIP_BSDOS
+
+
+106 
+	#DLT_SLIP_BSDOS
+ 13
+
+	)
+
+107 
+	#DLT_PPP_BSDOS
+ 14
+
+	)
+
+108 
+	#DLT_HIPPI
+ 15
+
+	)
+
+109 
+	#DLT_HDLC
+ 16
+
+	)
+
+112 
+	#DLT_SLIP_BSDOS
+ 15
+
+	)
+
+113 
+	#DLT_PPP_BSDOS
+ 16
+
+	)
+
+129 #i
+defed
+(
+__OnBSD__
+|| defed(
+__NBSD__
+)
+
+130 
+	#DLT_OLD_PFLOG
+ 17
+
+	)
+
+147 #i
+defed
+(
+__OnBSD__
+|| defed(
+__NBSD__
+|| defed(
+__DgFly__
+|| defed(
+__APPLE__
+)
+
+148 
+	#DLT_PFSYNC
+ 18
+
+	)
+
+151 
+	#DLT_ATM_CLIP
+ 19
+
+	)
+
+157 
+	#DLT_REDBACK_SMARTEDGE
+ 32
+
+	)
+
+164 
+	#DLT_PPP_SERIAL
+ 50
+
+	)
+
+165 
+	#DLT_PPP_ETHER
+ 51
+
+	)
+
+174 
+	#DLT_SYMANTEC_FIREWALL
+ 99
+
+	)
+
+193 
+	#DLT_MATCHING_MIN
+ 104
+
+	)
+
+209 
+	#DLT_C_HDLC
+ 104
+
+	)
+
+210 
+	#DLT_CHDLC
+ 
+DLT_C_HDLC
+
+
+	)
+
+212 
+	#DLT_IEEE802_11
+ 105
+
+	)
+
+227 
+	#DLT_FRELAY
+ 107
+
+	)
+
+236 #ifde
+__OnBSD__
+
+
+237 
+	#DLT_LOOP
+ 12
+
+	)
+
+239 
+	#DLT_LOOP
+ 108
+
+	)
+
+247 #ifde
+__OnBSD__
+
+
+248 
+	#DLT_ENC
+ 13
+
+	)
+
+250 
+	#DLT_ENC
+ 109
+
+	)
+
+263 
+	#DLT_LINUX_SLL
+ 113
+
+	)
+
+268 
+	#DLT_LTALK
+ 114
+
+	)
+
+273 
+	#DLT_ECONET
+ 115
+
+	)
+
+278 
+	#DLT_IPFILTER
+ 116
+
+	)
+
+283 
+	#DLT_PFLOG
+ 117
+
+	)
+
+288 
+	#DLT_CISCO_IOS
+ 118
+
+	)
+
+295 
+	#DLT_PRISM_HEADER
+ 119
+
+	)
+
+301 
+	#DLT_AIRONET_HEADER
+ 120
+
+	)
+
+341 #ifde
+__FeBSD__
+
+
+342 
+	#DLT_PFSYNC
+ 121
+
+	)
+
+344 
+	#DLT_HHDLC
+ 121
+
+	)
+
+355 
+	#DLT_IP_OVER_FC
+ 122
+
+	)
+
+371 
+	#DLT_SUNATM
+ 123
+
+	)
+
+377 
+	#DLT_RIO
+ 124
+
+	)
+
+378 
+	#DLT_PCI_EXP
+ 125
+
+	)
+
+379 
+	#DLT_AURORA
+ 126
+
+	)
+
+386 
+	#DLT_IEEE802_11_RADIO
+ 127
+
+	)
+
+396 
+	#DLT_TZSP
+ 128
+
+	)
+
+409 
+	#DLT_ARCNET_LINUX
+ 129
+
+	)
+
+417 
+	#DLT_JUNIPER_MLPPP
+ 130
+
+	)
+
+418 
+	#DLT_JUNIPER_MLFR
+ 131
+
+	)
+
+419 
+	#DLT_JUNIPER_ES
+ 132
+
+	)
+
+420 
+	#DLT_JUNIPER_GGSN
+ 133
+
+	)
+
+421 
+	#DLT_JUNIPER_MFR
+ 134
+
+	)
+
+422 
+	#DLT_JUNIPER_ATM2
+ 135
+
+	)
+
+423 
+	#DLT_JUNIPER_SERVICES
+ 136
+
+	)
+
+424 
+	#DLT_JUNIPER_ATM1
+ 137
+
+	)
+
+441 
+	#DLT_APPLE_IP_OVER_IEEE1394
+ 138
+
+	)
+
+447 
+	#DLT_MTP2_WITH_PHDR
+ 139
+
+	)
+
+448 
+	#DLT_MTP2
+ 140
+
+	)
+
+449 
+	#DLT_MTP3
+ 141
+
+	)
+
+450 
+	#DLT_SCCP
+ 142
+
+	)
+
+455 
+	#DLT_DOCSIS
+ 143
+
+	)
+
+472 
+	#DLT_LINUX_IRDA
+ 144
+
+	)
+
+477 
+	#DLT_IBM_SP
+ 145
+
+	)
+
+478 
+	#DLT_IBM_SN
+ 146
+
+	)
+
+505 
+	#DLT_USER0
+ 147
+
+	)
+
+506 
+	#DLT_USER1
+ 148
+
+	)
+
+507 
+	#DLT_USER2
+ 149
+
+	)
+
+508 
+	#DLT_USER3
+ 150
+
+	)
+
+509 
+	#DLT_USER4
+ 151
+
+	)
+
+510 
+	#DLT_USER5
+ 152
+
+	)
+
+511 
+	#DLT_USER6
+ 153
+
+	)
+
+512 
+	#DLT_USER7
+ 154
+
+	)
+
+513 
+	#DLT_USER8
+ 155
+
+	)
+
+514 
+	#DLT_USER9
+ 156
+
+	)
+
+515 
+	#DLT_USER10
+ 157
+
+	)
+
+516 
+	#DLT_USER11
+ 158
+
+	)
+
+517 
+	#DLT_USER12
+ 159
+
+	)
+
+518 
+	#DLT_USER13
+ 160
+
+	)
+
+519 
+	#DLT_USER14
+ 161
+
+	)
+
+520 
+	#DLT_USER15
+ 162
+
+	)
+
+532 
+	#DLT_IEEE802_11_RADIO_AVS
+ 163
+
+	)
+
+540 
+	#DLT_JUNIPER_MONITOR
+ 164
+
+	)
+
+545 
+	#DLT_BACNET_MS_TP
+ 165
+
+	)
+
+561 
+	#DLT_PPP_PPPD
+ 166
+
+	)
+
+567 
+	#DLT_PPP_WITH_DIRECTION
+ 
+DLT_PPP_PPPD
+
+
+	)
+
+568 
+	#DLT_LINUX_PPP_WITHDIRECTION
+ 
+DLT_PPP_PPPD
+
+
+	)
+
+576 
+	#DLT_JUNIPER_PPPOE
+ 167
+
+	)
+
+577 
+	#DLT_JUNIPER_PPPOE_ATM
+ 168
+
+	)
+
+579 
+	#DLT_GPRS_LLC
+ 169
+
+	)
+
+580 
+	#DLT_GPF_T
+ 170
+
+	)
+
+581 
+	#DLT_GPF_F
+ 171
+
+	)
+
+587 
+	#DLT_GCOM_T1E1
+ 172
+
+	)
+
+588 
+	#DLT_GCOM_SERIAL
+ 173
+
+	)
+
+595 
+	#DLT_JUNIPER_PIC_PEER
+ 174
+
+	)
+
+603 
+	#DLT_ERF_ETH
+ 175
+
+	)
+
+604 
+	#DLT_ERF_POS
+ 176
+
+	)
+
+612 
+	#DLT_LINUX_LAPD
+ 177
+
+	)
+
+621 
+	#DLT_JUNIPER_ETHER
+ 178
+
+	)
+
+622 
+	#DLT_JUNIPER_PPP
+ 179
+
+	)
+
+623 
+	#DLT_JUNIPER_FRELAY
+ 180
+
+	)
+
+624 
+	#DLT_JUNIPER_CHDLC
+ 181
+
+	)
+
+629 
+	#DLT_MFR
+ 182
+
+	)
+
+637 
+	#DLT_JUNIPER_VP
+ 183
+
+	)
+
+646 
+	#DLT_A429
+ 184
+
+	)
+
+653 
+	#DLT_A653_ICM
+ 185
+
+	)
+
+659 
+	#DLT_USB
+ 186
+
+	)
+
+665 
+	#DLT_BLUETOOTH_HCI_H4
+ 187
+
+	)
+
+671 
+	#DLT_IEEE802_16_MAC_CPS
+ 188
+
+	)
+
+677 
+	#DLT_USB_LINUX
+ 189
+
+	)
+
+686 
+	#DLT_CAN20B
+ 190
+
+	)
+
+692 
+	#DLT_IEEE802_15_4_LINUX
+ 191
+
+	)
+
+698 
+	#DLT_PPI
+ 192
+
+	)
+
+704 
+	#DLT_IEEE802_16_MAC_CPS_RADIO
+ 193
+
+	)
+
+712 
+	#DLT_JUNIPER_ISM
+ 194
+
+	)
+
+720 
+	#DLT_IEEE802_15_4
+ 195
+
+	)
+
+726 
+	#DLT_SITA
+ 196
+
+	)
+
+733 
+	#DLT_ERF
+ 197
+
+	)
+
+740 
+	#DLT_RAIF1
+ 198
+
+	)
+
+747 
+	#DLT_IPMB
+ 199
+
+	)
+
+754 
+	#DLT_JUNIPER_ST
+ 200
+
+	)
+
+760 
+	#DLT_BLUETOOTH_HCI_H4_WITH_PHDR
+ 201
+
+	)
+
+769 
+	#DLT_AX25_KISS
+ 202
+
+	)
+
+776 
+	#DLT_LAPD
+ 203
+
+	)
+
+784 
+	#DLT_PPP_WITH_DIR
+ 204
+
+	)
+
+785 
+	#DLT_C_HDLC_WITH_DIR
+ 205
+
+	)
+
+786 
+	#DLT_FRELAY_WITH_DIR
+ 206
+
+	)
+
+787 
+	#DLT_LAPB_WITH_DIR
+ 207
+
+	)
+
+798 
+	#DLT_IPMB_LINUX
+ 209
+
+	)
+
+804 
+	#DLT_FLEXRAY
+ 210
+
+	)
+
+811 
+	#DLT_MOST
+ 211
+
+	)
+
+818 
+	#DLT_LIN
+ 212
+
+	)
+
+824 
+	#DLT_X2E_SERIAL
+ 213
+
+	)
+
+830 
+	#DLT_X2E_XORAYA
+ 214
+
+	)
+
+841 
+	#DLT_IEEE802_15_4_NONASK_PHY
+ 215
+
+	)
+
+849 
+	#DLT_LINUX_EVDEV
+ 216
+
+	)
+
+856 
+	#DLT_GSMTAP_UM
+ 217
+
+	)
+
+857 
+	#DLT_GSMTAP_ABIS
+ 218
+
+	)
+
+864 
+	#DLT_MPLS
+ 219
+
+	)
+
+870 
+	#DLT_USB_LINUX_MMAPPED
+ 220
+
+	)
+
+876 
+	#DLT_DECT
+ 221
+
+	)
+
+887 
+	#DLT_AOS
+ 222
+
+	)
+
+896 
+	#DLT_WIHART
+ 223
+
+	)
+
+902 
+	#DLT_FC_2
+ 224
+
+	)
+
+916 
+	#DLT_FC_2_WITH_FRAME_DELIMS
+ 225
+
+	)
+
+964 
+	#DLT_IPNET
+ 226
+
+	)
+
+973 
+	#DLT_CAN_SOCKETCAN
+ 227
+
+	)
+
+979 
+	#DLT_IPV4
+ 228
+
+	)
+
+980 
+	#DLT_IPV6
+ 229
+
+	)
+
+987 
+	#DLT_IEEE802_15_4_NOFCS
+ 230
+
+	)
+
+1005 
+	#DLT_DBUS
+ 231
+
+	)
+
+1011 
+	#DLT_JUNIPER_VS
+ 232
+
+	)
+
+1012 
+	#DLT_JUNIPER_SRX_E2E
+ 233
+
+	)
+
+1013 
+	#DLT_JUNIPER_FIBRECHANNEL
+ 234
+
+	)
+
+1025 
+	#DLT_DVB_CI
+ 235
+
+	)
+
+1032 
+	#DLT_MUX27010
+ 236
+
+	)
+
+1038 
+	#DLT_STANAG_5066_D_PDU
+ 237
+
+	)
+
+1044 
+	#DLT_JUNIPER_ATM_CEMIC
+ 238
+
+	)
+
+1052 
+	#DLT_NFLOG
+ 239
+
+	)
+
+1062 
+	#DLT_NETANALYZER
+ 240
+
+	)
+
+1073 
+	#DLT_NETANALYZER_TRANSPARENT
+ 241
+
+	)
+
+1080 
+	#DLT_IPOIB
+ 242
+
+	)
+
+1087 
+	#DLT_MPEG_2_TS
+ 243
+
+	)
+
+1095 
+	#DLT_NG40
+ 244
+
+	)
+
+1105 
+	#DLT_NFC_LLCP
+ 245
+
+	)
+
+1114 #i!
+defed
+(
+__FeBSD__
+&& !defed(
+__OnBSD__
+&& !defed(
+__NBSD__
+&& !defed(
+__DgFly__
+&& !defed(
+__APPLE__
+)
+
+1115 
+	#DLT_PFSYNC
+ 246
+
+	)
+
+1124 
+	#DLT_INFINIBAND
+ 247
+
+	)
+
+1131 
+	#DLT_SCTP
+ 248
+
+	)
+
+1138 
+	#DLT_USBPCAP
+ 249
+
+	)
+
+1146 
+	#DLT_RTAC_SERIAL
+ 250
+
+	)
+
+1153 
+	#DLT_BLUETOOTH_LE_LL
+ 251
+
+	)
+
+1166 
+	#DLT_WIRESHARK_UPPER_PDU
+ 252
+
+	)
+
+1171 
+	#DLT_NETLINK
+ 253
+
+	)
+
+1176 
+	#DLT_BLUETOOTH_LINUX_MONITOR
+ 254
+
+	)
+
+1182 
+	#DLT_BLUETOOTH_BREDR_BB
+ 255
+
+	)
+
+1187 
+	#DLT_BLUETOOTH_LE_LL_WITH_PHDR
+ 256
+
+	)
+
+1192 
+	#DLT_PROFIBUS_DL
+ 257
+
+	)
+
+1238 #ifde
+__APPLE__
+
+
+1239 
+	#DLT_PKTAP
+ 
+DLT_USER2
+
+
+	)
+
+1241 
+	#DLT_PKTAP
+ 258
+
+	)
+
+1249 
+	#DLT_EPON
+ 259
+
+	)
+
+1255 
+	#DLT_IPMI_HPM_2
+ 260
+
+	)
+
+1260 
+	#DLT_ZWAVE_R1_R2
+ 261
+
+	)
+
+1261 
+	#DLT_ZWAVE_R3
+ 262
+
+	)
+
+1267 
+	#DLT_WATTSTOPPER_DLM
+ 263
+
+	)
+
+1269 
+	#DLT_MATCHING_MAX
+ 263
+
+	)
+
+1276 
+	#DLT_CLASS
+(
+x
+((x& 0x03ff0000)
+
+	)
+
+1285 
+	#DLT_CLASS_NETBSD_RAWAF
+ 0x02240000
+
+	)
+
+1286 
+	#DLT_NETBSD_RAWAF
+(
+af
+(
+DLT_CLASS_NETBSD_RAWAF
+ | (af))
+
+	)
+
+1287 
+	#DLT_NETBSD_RAWAF_AF
+(
+x
+((x& 0x0000ffff)
+
+	)
+
+1288 
+	#DLT_IS_NETBSD_RAWAF
+(
+x
+(
+	`DLT_CLASS
+(x=
+DLT_CLASS_NETBSD_RAWAF
+)
+
+	)
+
+	@ethertypes.h
+
+49 #ide
+_NET_ETHERTYPES_H_
+
+
+50 
+	#_NET_ETHERTYPES_H_
+
+
+	)
+
+57 
+	#ETHERTYPE_8023
+ 0x0004
+
+	)
+
+59 
+	#ETHERTYPE_PUP
+ 0x0200
+
+	)
+
+60 
+	#ETHERTYPE_PUPAT
+ 0x0200
+
+	)
+
+61 
+	#ETHERTYPE_SPRITE
+ 0x0500
+
+	)
+
+63 
+	#ETHERTYPE_NS
+ 0x0600
+
+	)
+
+64 
+	#ETHERTYPE_NSAT
+ 0x0601
+
+	)
+
+65 
+	#ETHERTYPE_DLOG1
+ 0x0660
+
+	)
+
+66 
+	#ETHERTYPE_DLOG2
+ 0x0661
+
+	)
+
+67 
+	#ETHERTYPE_IP
+ 0x0800
+
+	)
+
+68 
+	#ETHERTYPE_X75
+ 0x0801
+
+	)
+
+69 
+	#ETHERTYPE_NBS
+ 0x0802
+
+	)
+
+70 
+	#ETHERTYPE_ECMA
+ 0x0803
+
+	)
+
+71 
+	#ETHERTYPE_CHAOS
+ 0x0804
+
+	)
+
+72 
+	#ETHERTYPE_X25
+ 0x0805
+
+	)
+
+73 
+	#ETHERTYPE_ARP
+ 0x0806
+
+	)
+
+74 
+	#ETHERTYPE_NSCOMPAT
+ 0x0807
+
+	)
+
+75 
+	#ETHERTYPE_FRARP
+ 0x0808
+
+	)
+
+78 
+	#ETHERTYPE_UBDEBUG
+ 0x0900
+
+	)
+
+79 
+	#ETHERTYPE_IEEEPUP
+ 0x0A00
+
+	)
+
+80 
+	#ETHERTYPE_IEEEPUPAT
+ 0x0A01
+
+	)
+
+81 
+	#ETHERTYPE_VINES
+ 0x0BAD
+
+	)
+
+82 
+	#ETHERTYPE_VINESLOOP
+ 0x0BAE
+
+	)
+
+83 
+	#ETHERTYPE_VINESECHO
+ 0x0BAF
+
+	)
+
+91 
+	#ETHERTYPE_TRAIL
+ 0x1000
+
+	)
+
+92 
+	#ETHERTYPE_NTRAILER
+ 16
+
+	)
+
+94 
+	#ETHERTYPE_DCA
+ 0x1234
+
+	)
+
+95 
+	#ETHERTYPE_VALID
+ 0x1600
+
+	)
+
+96 
+	#ETHERTYPE_DOGFIGHT
+ 0x1989
+
+	)
+
+97 
+	#ETHERTYPE_RCL
+ 0x1995
+
+	)
+
+101 
+	#ETHERTYPE_NBPVCD
+ 0x3C00
+
+	)
+
+102 
+	#ETHERTYPE_NBPSCD
+ 0x3C01
+
+	)
+
+103 
+	#ETHERTYPE_NBPCREQ
+ 0x3C02
+
+	)
+
+104 
+	#ETHERTYPE_NBPCRSP
+ 0x3C03
+
+	)
+
+105 
+	#ETHERTYPE_NBPCC
+ 0x3C04
+
+	)
+
+106 
+	#ETHERTYPE_NBPCLREQ
+ 0x3C05
+
+	)
+
+107 
+	#ETHERTYPE_NBPCLRSP
+ 0x3C06
+
+	)
+
+108 
+	#ETHERTYPE_NBPDG
+ 0x3C07
+
+	)
+
+109 
+	#ETHERTYPE_NBPDGB
+ 0x3C08
+
+	)
+
+110 
+	#ETHERTYPE_NBPCLAIM
+ 0x3C09
+
+	)
+
+111 
+	#ETHERTYPE_NBPDLTE
+ 0x3C0A
+
+	)
+
+112 
+	#ETHERTYPE_NBPRAS
+ 0x3C0B
+
+	)
+
+113 
+	#ETHERTYPE_NBPRAR
+ 0x3C0C
+
+	)
+
+114 
+	#ETHERTYPE_NBPRST
+ 0x3C0D
+
+	)
+
+116 
+	#ETHERTYPE_PCS
+ 0x4242
+
+	)
+
+117 
+	#ETHERTYPE_IMLBLDIAG
+ 0x424C
+
+	)
+
+118 
+	#ETHERTYPE_DIDDLE
+ 0x4321
+
+	)
+
+119 
+	#ETHERTYPE_IMLBL
+ 0x4C42
+
+	)
+
+120 
+	#ETHERTYPE_SIMNET
+ 0x5208
+
+	)
+
+121 
+	#ETHERTYPE_DECEXPER
+ 0x6000
+
+	)
+
+122 
+	#ETHERTYPE_MOPDL
+ 0x6001
+
+	)
+
+123 
+	#ETHERTYPE_MOPRC
+ 0x6002
+
+	)
+
+124 
+	#ETHERTYPE_DECt
+ 0x6003
+
+	)
+
+125 
+	#ETHERTYPE_DN
+ 
+ETHERTYPE_DECt
+
+
+	)
+
+126 
+	#ETHERTYPE_LAT
+ 0x6004
+
+	)
+
+127 
+	#ETHERTYPE_DECDIAG
+ 0x6005
+
+	)
+
+128 
+	#ETHERTYPE_DECCUST
+ 0x6006
+
+	)
+
+129 
+	#ETHERTYPE_SCA
+ 0x6007
+
+	)
+
+130 
+	#ETHERTYPE_AMBER
+ 0x6008
+
+	)
+
+131 
+	#ETHERTYPE_DECMUMPS
+ 0x6009
+
+	)
+
+133 
+	#ETHERTYPE_TRANSETHER
+ 0x6558
+
+	)
+
+134 
+	#ETHERTYPE_RAWFR
+ 0x6559
+
+	)
+
+135 
+	#ETHERTYPE_UBDL
+ 0x7000
+
+	)
+
+136 
+	#ETHERTYPE_UBNIU
+ 0x7001
+
+	)
+
+137 
+	#ETHERTYPE_UBDIAGLOOP
+ 0x7002
+
+	)
+
+138 
+	#ETHERTYPE_UBNMC
+ 0x7003
+
+	)
+
+139 
+	#ETHERTYPE_UBBST
+ 0x7005
+
+	)
+
+140 
+	#ETHERTYPE_OS9
+ 0x7007
+
+	)
+
+141 
+	#ETHERTYPE_OS9NET
+ 0x7009
+
+	)
+
+143 
+	#ETHERTYPE_RACAL
+ 0x7030
+
+	)
+
+144 
+	#ETHERTYPE_PRIMENTS
+ 0x7031
+
+	)
+
+145 
+	#ETHERTYPE_CABLETRON
+ 0x7034
+
+	)
+
+146 
+	#ETHERTYPE_CRONUSVLN
+ 0x8003
+
+	)
+
+147 
+	#ETHERTYPE_CRONUS
+ 0x8004
+
+	)
+
+148 
+	#ETHERTYPE_HP
+ 0x8005
+
+	)
+
+149 
+	#ETHERTYPE_NESTAR
+ 0x8006
+
+	)
+
+150 
+	#ETHERTYPE_ATTSTANFORD
+ 0x8008
+
+	)
+
+151 
+	#ETHERTYPE_EXCELAN
+ 0x8010
+
+	)
+
+152 
+	#ETHERTYPE_SG_DIAG
+ 0x8013
+
+	)
+
+153 
+	#ETHERTYPE_SG_NETGAMES
+ 0x8014
+
+	)
+
+154 
+	#ETHERTYPE_SG_RESV
+ 0x8015
+
+	)
+
+155 
+	#ETHERTYPE_SG_BOUNCE
+ 0x8016
+
+	)
+
+156 
+	#ETHERTYPE_APOLLODOMAIN
+ 0x8019
+
+	)
+
+157 
+	#ETHERTYPE_TYMSHARE
+ 0x802E
+
+	)
+
+158 
+	#ETHERTYPE_TIGAN
+ 0x802F
+
+	)
+
+159 
+	#ETHERTYPE_REVARP
+ 0x8035
+
+	)
+
+160 
+	#ETHERTYPE_AEONIC
+ 0x8036
+
+	)
+
+161 
+	#ETHERTYPE_IPXNEW
+ 0x8037
+
+	)
+
+162 
+	#ETHERTYPE_LANBRIDGE
+ 0x8038
+
+	)
+
+163 
+	#ETHERTYPE_DSMD
+ 0x8039
+
+	)
+
+164 
+	#ETHERTYPE_ARGONAUT
+ 0x803A
+
+	)
+
+165 
+	#ETHERTYPE_VAXELN
+ 0x803B
+
+	)
+
+166 
+	#ETHERTYPE_DECDNS
+ 0x803C
+
+	)
+
+167 
+	#ETHERTYPE_ENCRYPT
+ 0x803D
+
+	)
+
+168 
+	#ETHERTYPE_DECDTS
+ 0x803E
+
+	)
+
+169 
+	#ETHERTYPE_DECLTM
+ 0x803F
+
+	)
+
+170 
+	#ETHERTYPE_DECNETBIOS
+ 0x8040
+
+	)
+
+171 
+	#ETHERTYPE_DECLAST
+ 0x8041
+
+	)
+
+173 
+	#ETHERTYPE_PLANNING
+ 0x8044
+
+	)
+
+175 
+	#ETHERTYPE_DECAM
+ 0x8048
+
+	)
+
+176 
+	#ETHERTYPE_EXPERDATA
+ 0x8049
+
+	)
+
+177 
+	#ETHERTYPE_VEXP
+ 0x805B
+
+	)
+
+178 
+	#ETHERTYPE_VPROD
+ 0x805C
+
+	)
+
+179 
+	#ETHERTYPE_ES
+ 0x805D
+
+	)
+
+180 
+	#ETHERTYPE_LITTLE
+ 0x8060
+
+	)
+
+181 
+	#ETHERTYPE_COUNTERPOINT
+ 0x8062
+
+	)
+
+183 
+	#ETHERTYPE_VEECO
+ 0x8067
+
+	)
+
+184 
+	#ETHERTYPE_GENDYN
+ 0x8068
+
+	)
+
+185 
+	#ETHERTYPE_ATT
+ 0x8069
+
+	)
+
+186 
+	#ETHERTYPE_AUTOPHON
+ 0x806A
+
+	)
+
+187 
+	#ETHERTYPE_COMDESIGN
+ 0x806C
+
+	)
+
+188 
+	#ETHERTYPE_COMPUGRAPHIC
+ 0x806D
+
+	)
+
+190 
+	#ETHERTYPE_MATRA
+ 0x807A
+
+	)
+
+191 
+	#ETHERTYPE_DDE
+ 0x807B
+
+	)
+
+192 
+	#ETHERTYPE_MERIT
+ 0x807C
+
+	)
+
+194 
+	#ETHERTYPE_VLTLMAN
+ 0x8080
+
+	)
+
+197 
+	#ETHERTYPE_ATALK
+ 0x809B
+
+	)
+
+198 
+	#ETHERTYPE_AT
+ 
+ETHERTYPE_ATALK
+
+
+	)
+
+199 
+	#ETHERTYPE_APPLETALK
+ 
+ETHERTYPE_ATALK
+
+
+	)
+
+201 
+	#ETHERTYPE_SPIDER
+ 0x809F
+
+	)
+
+206 
+	#ETHERTYPE_PACER
+ 0x80C6
+
+	)
+
+207 
+	#ETHERTYPE_APPLITEK
+ 0x80C7
+
+	)
+
+212 
+	#ETHERTYPE_SNA
+ 0x80D5
+
+	)
+
+213 
+	#ETHERTYPE_VARIAN
+ 0x80DD
+
+	)
+
+217 
+	#ETHERTYPE_RETIX
+ 0x80F2
+
+	)
+
+218 
+	#ETHERTYPE_AARP
+ 0x80F3
+
+	)
+
+220 
+	#ETHERTYPE_APOLLO
+ 0x80F7
+
+	)
+
+221 
+	#ETHERTYPE_VLAN
+ 0x8100
+
+	)
+
+223 
+	#ETHERTYPE_BOFL
+ 0x8102
+
+	)
+
+224 
+	#ETHERTYPE_WELLFLEET
+ 0x8103
+
+	)
+
+226 
+	#ETHERTYPE_TALARIS
+ 0x812B
+
+	)
+
+227 
+	#ETHERTYPE_WATERLOO
+ 0x8130
+
+	)
+
+228 
+	#ETHERTYPE_HAYES
+ 0x8130
+
+	)
+
+229 
+	#ETHERTYPE_VGLAB
+ 0x8131
+
+	)
+
+231 
+	#ETHERTYPE_IPX
+ 0x8137
+
+	)
+
+232 
+	#ETHERTYPE_NOVELL
+ 0x8138
+
+	)
+
+234 
+	#ETHERTYPE_MUMPS
+ 0x813F
+
+	)
+
+235 
+	#ETHERTYPE_AMOEBA
+ 0x8145
+
+	)
+
+236 
+	#ETHERTYPE_FLIP
+ 0x8146
+
+	)
+
+237 
+	#ETHERTYPE_VURESERVED
+ 0x8147
+
+	)
+
+238 
+	#ETHERTYPE_LOGICRAFT
+ 0x8148
+
+	)
+
+239 
+	#ETHERTYPE_NCD
+ 0x8149
+
+	)
+
+240 
+	#ETHERTYPE_ALPHA
+ 0x814A
+
+	)
+
+241 
+	#ETHERTYPE_SNMP
+ 0x814C
+
+	)
+
+243 
+	#ETHERTYPE_TEC
+ 0x814F
+
+	)
+
+244 
+	#ETHERTYPE_RATIONAL
+ 0x8150
+
+	)
+
+248 
+	#ETHERTYPE_XTP
+ 0x817D
+
+	)
+
+249 
+	#ETHERTYPE_SGITW
+ 0x817E
+
+	)
+
+250 
+	#ETHERTYPE_HIPPI_FP
+ 0x8180
+
+	)
+
+251 
+	#ETHERTYPE_STP
+ 0x8181
+
+	)
+
+254 
+	#ETHERTYPE_MOTOROLA
+ 0x818D
+
+	)
+
+255 
+	#ETHERTYPE_NETBEUI
+ 0x8191
+
+	)
+
+272 
+	#ETHERTYPE_ACCTON
+ 0x8390
+
+	)
+
+273 
+	#ETHERTYPE_TALARISMC
+ 0x852B
+
+	)
+
+274 
+	#ETHERTYPE_KALPANA
+ 0x8582
+
+	)
+
+278 
+	#ETHERTYPE_SECTRA
+ 0x86DB
+
+	)
+
+279 
+	#ETHERTYPE_IPV6
+ 0x86DD
+
+	)
+
+280 
+	#ETHERTYPE_DELTACON
+ 0x86DE
+
+	)
+
+281 
+	#ETHERTYPE_ATOMIC
+ 0x86DF
+
+	)
+
+284 
+	#ETHERTYPE_RDP
+ 0x8739
+
+	)
+
+285 
+	#ETHERTYPE_MICP
+ 0x873A
+
+	)
+
+287 
+	#ETHERTYPE_TCPCOMP
+ 0x876B
+
+	)
+
+288 
+	#ETHERTYPE_IPAS
+ 0x876C
+
+	)
+
+289 
+	#ETHERTYPE_SECUREDATA
+ 0x876D
+
+	)
+
+290 
+	#ETHERTYPE_FLOWCONTROL
+ 0x8808
+
+	)
+
+291 
+	#ETHERTYPE_SLOWPROTOCOLS
+ 0x8809
+
+	)
+
+292 
+	#ETHERTYPE_PPP
+ 0x880B
+
+	)
+
+293 
+	#ETHERTYPE_HITACHI
+ 0x8820
+
+	)
+
+294 
+	#ETHERTYPE_MPLS
+ 0x8847
+
+	)
+
+295 
+	#ETHERTYPE_MPLS_MCAST
+ 0x8848
+
+	)
+
+296 
+	#ETHERTYPE_AXIS
+ 0x8856
+
+	)
+
+297 
+	#ETHERTYPE_PPPOEDISC
+ 0x8863
+
+	)
+
+298 
+	#ETHERTYPE_PPPOE
+ 0x8864
+
+	)
+
+299 
+	#ETHERTYPE_LANPROBE
+ 0x8888
+
+	)
+
+300 
+	#ETHERTYPE_PAE
+ 0x888
+
+	)
+
+301 
+	#ETHERTYPE_AOE
+ 0x88a2
+
+	)
+
+302 
+	#ETHERTYPE_FCOE
+ 0x8906
+
+	)
+
+303 
+	#ETHERTYPE_LOOPBACK
+ 0x9000
+
+	)
+
+304 
+	#ETHERTYPE_LBACK
+ 
+ETHERTYPE_LOOPBACK
+
+
+	)
+
+305 
+	#ETHERTYPE_XNSSM
+ 0x9001
+
+	)
+
+306 
+	#ETHERTYPE_TCPSM
+ 0x9002
+
+	)
+
+307 
+	#ETHERTYPE_BCLOOP
+ 0x9003
+
+	)
+
+308 
+	#ETHERTYPE_DEBNI
+ 0xAAAA
+
+	)
+
+309 
+	#ETHERTYPE_SONIX
+ 0xFAF5
+
+	)
+
+310 
+	#ETHERTYPE_VITAL
+ 0xFF00
+
+	)
+
+313 
+	#ETHERTYPE_MAX
+ 0xFFFF
+
+	)
+
+	@if.c
+
+92 
+	~<sys/cdefs.h
+>
+
+93 
+__KERNEL_RCSID
+(0, "$NetBSD: if.c,v 1.315 2015/05/18 06:38:59 martin Exp $");
+
+95 #i
+defed
+(
+_KERNEL_OPT
+)
+
+96 
+	~"t_.h
+"
+
+98 
+	~"t_k.h
+"
+
+99 
+	~"t_tm.h
+"
+
+100 
+	~"t_wn.h
+"
+
+101 
+	~"t_t_mp.h
+"
+
+104 
+	~<sys/m.h
+>
+
+105 
+	~<sys/mbuf.h
+>
+
+106 
+	~<sys/sym.h
+>
+
+107 
+	~<sys/out.h
+>
+
+108 
+	~<sys/oc.h
+>
+
+109 
+	~<sys/sock.h
+>
+
+110 
+	~<sys/sockv.h
+>
+
+111 
+	~<sys/doma.h
+>
+
+112 
+	~<sys/osw.h
+>
+
+113 
+	~<sys/kl.h
+>
+
+114 
+	~<sys/iol.h
+>
+
+115 
+	~<sys/sysl.h
+>
+
+116 
+	~<sys/syog.h
+>
+
+117 
+	~<sys/kauth.h
+>
+
+118 
+	~<sys/kmem.h
+>
+
+119 
+	~<sys/x.h
+>
+
+121 
+	~<t/if.h
+>
+
+122 
+	~<t/if_dl.h
+>
+
+123 
+	~<t/if_h.h
+>
+
+124 
+	~<t/if_med.h
+>
+
+125 
+	~<t80211/80211.h
+>
+
+126 
+	~<t80211/80211_iol.h
+>
+
+127 
+	~<t/if_tys.h
+>
+
+128 
+	~<t/dix.h
+>
+
+129 
+	~<t/rou.h
+>
+
+130 
+	~<t/ti.h
+>
+
+131 
+	~<sys/modu.h
+>
+
+132 #ifde
+NETATALK
+
+
+133 
+	~<lk/_ex.h
+>
+
+134 
+	~<lk/.h
+>
+
+136 
+	~<t/pf.h
+>
+
+137 
+	~<t/.h
+>
+
+138 
+	~<t/_v.h
+>
+
+140 #ifde
+INET6
+
+
+141 
+	~<t6/6_v.h
+>
+
+142 
+	~<t6/nd6.h
+>
+
+145 
+	~"h.h
+"
+
+146 
+	~"fddi.h
+"
+
+147 
+	~"tok.h
+"
+
+149 
+	~".h
+"
+
+150 #i
+NCARP
+ > 0
+
+151 
+	~<t/_.h
+>
+
+154 
+	~<comt/sys/sockio.h
+>
+
+155 
+	~<comt/sys/sock.h
+>
+
+157 
+MALLOC_DEFINE
+(
+M_IFADDR
+, "ifaddr", "interfaceddress");
+
+158 
+MALLOC_DEFINE
+(
+M_IFMADDR
+, "ether_multi", "link-level multicastddress");
+
+163 
+i_hd
+ 
+	gi_li
+;
+
+164 
+i_t
+ ** 
+	gifdex2i
+ = 
+NULL
+;
+
+166 
+u_t
+ 
+	gif_dex
+ = 1;
+
+167 
+size_t
+ 
+	gif_dexlim
+ = 0;
+
+168 
+ut64_t
+ 
+	gdex_g
+;
+
+169 
+kmux_t
+ 
+	gdex_g_mtx
+;
+
+170 
+kmux_t
+ 
+	gif_e_mtx
+;
+
+172 
+iddr
+ ** 
+	gi_addrs
+ = 
+NULL
+;
+
+174 
+i
+ *
+	glo0i
+;
+
+175 
+	gifqmaxn
+ = 
+IFQ_MAXLEN
+;
+
+177 
+if__wk
+(
+y
+ *, *);
+
+179 
+if_e
+ *
+if_e_lookup
+(const *, *);
+
+181 
+	$LIST_HEAD
+(, 
+if_e
+
+if_s
+ = 
+	`LIST_HEAD_INITIALIZER
+(if_cloners);
+
+182 
+if_s_cou
+;
+
+185 
+pf_hd_t
+ * 
+if_pf
+;
+
+187 
+kauth_li_t
+ 
+if_li
+;
+
+189 
+	`doifiol
+(
+sock
+ *, 
+u_lg
+, *, 
+lwp
+ *);
+
+190 
+	`ifiol_ch
+(
+i
+ *);
+
+191 
+	`ifiol_dach
+(
+i
+ *);
+
+192 
+	`i_lock_r
+(
+i_lock
+ *);
+
+193 
+	`i_lock_ex
+(
+i_lock
+ *);
+
+194 
+	`if_dach_queues
+(
+i
+ *, 
+ifqueue
+ *);
+
+195 
+	`sysl_dq_tup
+(
+sysog
+ **, const *,
+
+196 
+iq
+ *);
+
+197 
+	`if_owtimo
+(*);
+
+198 
+	`if__dl
+(
+i
+ *);
+
+199 
+	`if_chdoma1
+(
+i
+ *);
+
+200 
+	`ifcf
+(
+u_lg
+, *);
+
+201 
+	`if_e_
+(const *);
+
+202 
+	`if_e_deroy
+(const *);
+
+204 #i
+	`defed
+(
+INET
+|| defed(
+INET6
+)
+
+205 
+	`sysl_t_pktq_tup
+(
+sysog
+ **, );
+
+209 
+	$if_li_cb
+(
+kauth_ed_t
+ 
+ed
+, 
+kauth_ai_t
+ 
+ai
+, *
+cook
+,
+
+210 *
+g0
+, *
+g1
+, *
+g2
+, *
+g3
+)
+
+212 
+su
+;
+
+213 
+kauth_twk_q
+ 
+q
+;
+
+215 
+su
+ = 
+KAUTH_RESULT_DEFER
+;
+
+216 
+q
+ = (
+kauth_twk_q
+)
+g1
+;
+
+218 i(
+ai
+ !
+KAUTH_NETWORK_INTERFACE
+)
+
+219  
+su
+;
+
+221 i((
+q
+ =
+KAUTH_REQ_NETWORK_INTERFACE_GET
+) ||
+
+222 (
+q
+ =
+KAUTH_REQ_NETWORK_INTERFACE_SET
+))
+
+223 
+su
+ = 
+KAUTH_RESULT_ALLOW
+;
+
+225  
+su
+;
+
+226 
+	}
+}
+
+235 
+	$if
+()
+
+237 #i
+	`defed
+(
+INET
+)
+
+238 
+	`sysl_t_pktq_tup
+(
+NULL
+, 
+PF_INET
+);
+
+240 #ifde
+INET6
+
+
+241 i(
+6_e
+)
+
+242 
+	`sysl_t_pktq_tup
+(
+NULL
+, 
+PF_INET6
+);
+
+245 
+if_li
+ = 
+	`kauth_li_sce
+(
+KAUTH_SCOPE_NETWORK
+,
+
+246 
+if_li_cb
+, 
+NULL
+);
+
+249 
+ifiol
+ = 
+doifiol
+;
+
+250 
+	}
+}
+
+257 
+	$if1
+()
+
+259 
+	`mux_
+(&
+dex_g_mtx
+, 
+MUTEX_DEFAULT
+, 
+IPL_NONE
+);
+
+260 
+	`mux_
+(&
+if_e_mtx
+, 
+MUTEX_DEFAULT
+, 
+IPL_NONE
+);
+
+261 
+	`TAILQ_INIT
+(&
+i_li
+);
+
+262 
+if_dexlim
+ = 8;
+
+264 
+if_pf
+ = 
+	`pf_hd_
+(
+PFIL_TYPE_IFNET
+, 
+NULL
+);
+
+265 
+	`KASSERT
+(
+if_pf
+ !
+NULL
+);
+
+267 #i
+NETHER
+ > 0 || 
+NFDDI
+ > 0 || 
+	`defed
+(
+NETATALK
+|| 
+NTOKEN
+ > 0 || defed(
+WLAN
+)
+
+268 
+	`h
+();
+
+270 
+	}
+}
+
+272 
+i_t
+ *
+
+273 
+	$if_loc
+(
+u_ch
+ 
+ty
+)
+
+275  
+	`kmem_zloc
+((
+i_t
+), 
+KM_SLEEP
+);
+
+276 
+	}
+}
+
+279 
+	$if_
+(
+i_t
+ *
+i
+)
+
+281 
+	`kmem_
+(
+i
+, (
+i_t
+));
+
+282 
+	}
+}
+
+285 
+	$if_me
+(
+i
+ *
+i
+, c *
+me
+, 
+un
+)
+
+287 ()
+	`tf
+(
+i
+->
+if_xme
+, (ifp->if_xname),
+
+288 "%s%d", 
+me
+, 
+un
+);
+
+289 
+	}
+}
+
+297 
+	$if_nuouut
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+,
+
+298 c 
+sockaddr
+ *
+so
+, 
+y
+ *
+
+)
+
+301  
+ENXIO
+;
+
+302 
+	}
+}
+
+305 
+	$if_nuput
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+)
+
+309 
+	}
+}
+
+312 
+	$if_nut
+(
+i
+ *
+i
+)
+
+316 
+	}
+}
+
+319 
+	$if_nuiol
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+325 
+	`cv_sigl
+(&
+i
+->
+if_iol_lock
+->
+_emd
+);
+
+326  
+ENXIO
+;
+
+327 
+	}
+}
+
+330 
+	$if_nu
+(
+i
+ *
+i
+)
+
+333  
+ENXIO
+;
+
+334 
+	}
+}
+
+337 
+	$if_nu
+(
+i
+ *
+i
+, 
+dib
+)
+
+341 
+	}
+}
+
+344 
+	$if_nuowtimo
+(
+i
+ *
+i
+)
+
+348 
+	}
+}
+
+351 
+	$if_nud
+(
+i
+ *
+i
+)
+
+355 
+	}
+}
+
+358 
+	$if_t_dl
+(
+i
+ *
+i
+, c *
+a
+, 
+u_ch
+ 
+add
+, 
+bo
+ 
+y
+)
+
+360 
+iddr
+ *
+i
+;
+
+361 
+sockaddr_dl
+ *
+sdl
+;
+
+363 
+i
+->
+if_add
+ = 
+add
+;
+
+364 
+	`if_loc_dl
+(
+i
+);
+
+365 
+i
+ = 
+i
+->
+if_dl
+;
+
+366 
+sdl
+ = 
+	`tosdl
+(
+i
+->
+i_addr
+);
+
+368 ()
+	`sockaddr_dl_ddr
+(
+sdl
+, sdl->
+sdl_n
+, 
+a
+, 
+i
+->
+if_add
+);
+
+369 i(
+y
+) {
+
+370 
+i
+->
+if_hwdl
+ = i->
+if_dl
+;
+
+371 
+	`if
+(
+i
+->
+if_hwdl
+);
+
+374 
+	}
+}
+
+376 
+iddr
+ *
+
+377 
+	$if_dl_
+(c 
+i
+ *
+i
+, c 
+sockaddr_dl
+ **
+sd
+)
+
+379 
+socksize
+, 
+isize
+;
+
+380 
+add
+, 
+m
+;
+
+381 
+sockaddr_dl
+ *
+mask
+, *
+sdl
+;
+
+382 
+iddr
+ *
+i
+;
+
+384 
+m
+ = 
+	`
+(
+i
+->
+if_xme
+);
+
+385 
+add
+ = 
+i
+->
+if_add
+;
+
+386 
+socksize
+ = 
+	`roundup
+(
+	`sockaddr_dl_msu
+(
+m
+, 
+add
+), ());
+
+387 
+isize
+ = (*
+i
++ 2 * 
+socksize
+;
+
+388 
+i
+ = (
+iddr
+ *)
+	`mloc
+(
+isize
+, 
+M_IFADDR
+, 
+M_WAITOK
+|
+M_ZERO
+);
+
+390 
+sdl
+ = (
+sockaddr_dl
+ *)(
+i
+ + 1);
+
+391 
+mask
+ = (
+sockaddr_dl
+ *)(
+socksize
+ + (*)
+sdl
+);
+
+393 
+	`sockaddr_dl_
+(
+sdl
+, 
+socksize
+, 
+i
+->
+if_dex
+, i->
+if_ty
+,
+
+394 
+i
+->
+if_xme
+, 
+m
+, 
+NULL
+, 
+add
+);
+
+395 
+mask
+->
+sdl_n
+ = 
+	`sockaddr_dl_msu
+(
+m
+, 0);
+
+396 
+	`memt
+(&
+mask
+->
+sdl_da
+[0], 0xff, 
+m
+);
+
+397 
+i
+->
+i_que
+ = 
+lk_que
+;
+
+398 
+i
+->
+i_addr
+ = (
+sockaddr
+ *)
+sdl
+;
+
+399 
+i
+->
+i_tmask
+ = (
+sockaddr
+ *)
+mask
+;
+
+401 *
+sd
+ = 
+sdl
+;
+
+403  
+i
+;
+
+404 
+	}
+}
+
+407 
+	$if_dl_efs
+(
+i
+ *
+i
+, 
+iddr
+ *
+i
+)
+
+409 c 
+sockaddr_dl
+ *
+sdl
+;
+
+410 
+i_addrs
+[
+i
+->
+if_dex
+] = 
+i
+;
+
+411 
+	`if
+(
+i
+);
+
+412 
+i
+->
+if_dl
+ = 
+i
+;
+
+413 
+	`if
+(
+i
+);
+
+414 
+sdl
+ = 
+	`tosdl
+(
+i
+->
+i_addr
+);
+
+415 
+i
+->
+if_dl
+ = 
+sdl
+;
+
+416 
+	}
+}
+
+425 
+	$if_loc_dl
+(
+i
+ *
+i
+)
+
+427 
+iddr
+ *
+i
+;
+
+428 c 
+sockaddr_dl
+ *
+sdl
+;
+
+435 i(
+i
+->
+if_dl
+ !
+NULL
+)
+
+436 
+	`if__dl
+(
+i
+);
+
+438 
+i
+ = 
+	`if_dl_
+(
+i
+, &
+sdl
+);
+
+440 
+	`i_
+(
+i
+, 
+i
+);
+
+441 
+	`if_dl_efs
+(
+i
+, 
+i
+);
+
+442 
+	}
+}
+
+445 
+	$if_dive_dl
+(
+i
+ *
+i
+)
+
+447 
+iddr
+ *
+i
+;
+
+449 
+	`KASSERT
+(
+i
+->
+if_dl
+ !
+NULL
+);
+
+451 
+i
+ = 
+i
+->
+if_dl
+;
+
+453 
+i
+->
+if_dl
+ = 
+NULL
+;
+
+455 
+i_addrs
+[
+i
+->
+if_dex
+] = 
+NULL
+;
+
+456 
+	`i
+(
+i
+);
+
+457 
+i
+->
+if_dl
+ = 
+NULL
+;
+
+458 
+	`i
+(
+i
+);
+
+459 
+	}
+}
+
+462 
+	$if_aive_dl
+(
+i
+ *
+i
+, 
+iddr
+ *
+i
+,
+
+463 c 
+sockaddr_dl
+ *
+sdl
+)
+
+465 
+s
+;
+
+467 
+s
+ = 
+	`
+();
+
+469 
+	`if_dive_dl
+(
+i
+);
+
+471 
+	`if_dl_efs
+(
+i
+, 
+i
+);
+
+472 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+)
+
+473 
+	`
+(
+i
+, 
+RTM_LLINFO_UPD
+, 0);
+
+474 
+	`lx
+(
+s
+);
+
+475 
+	}
+}
+
+482 
+	$if__dl
+(
+i
+ *
+i
+)
+
+484 
+iddr
+ *
+i
+;
+
+485 
+s
+;
+
+487 
+i
+ = 
+i_addrs
+[
+i
+->
+if_dex
+];
+
+488 i(
+i
+ =
+NULL
+) {
+
+489 
+	`KASSERT
+(
+i
+->
+if_dl
+ =
+NULL
+);
+
+490 
+	`KASSERT
+(
+i
+->
+if_dl
+ =
+NULL
+);
+
+494 
+	`KASSERT
+(
+i
+->
+if_dl
+ !
+NULL
+);
+
+495 
+	`KASSERT
+(
+i
+->
+if_dl
+ !
+NULL
+);
+
+497 
+s
+ = 
+	`
+();
+
+498 
+	`
+(
+i
+, 
+RTM_DELETE
+, 0);
+
+499 
+	`i_move
+(
+i
+, 
+i
+);
+
+500 
+	`if_dive_dl
+(
+i
+);
+
+501 i(
+i
+->
+if_hwdl
+ =
+i
+) {
+
+502 
+	`i
+(
+i
+);
+
+503 
+i
+->
+if_hwdl
+ = 
+NULL
+;
+
+505 
+	`lx
+(
+s
+);
+
+506 
+	}
+}
+
+509 
+	$if_gdex
+(
+i_t
+ *
+i
+)
+
+511 
+bo
+ 
+hlim
+ = 
+l
+;
+
+513 
+	`mux_r
+(&
+dex_g_mtx
+);
+
+514 
+i
+->
+if_dex_g
+ = 
+dex_g
+++;
+
+515 
+	`mux_ex
+(&
+dex_g_mtx
+);
+
+517 
+i
+->
+if_dex
+ = if_index;
+
+518 i(
+ifdex2i
+ =
+NULL
+) {
+
+519 
+if_dex
+++;
+
+520 
+sk
+;
+
+522 
+	`if_bydex
+(
+i
+->
+if_dex
+)) {
+
+531 i(++
+if_dex
+ == 0) {
+
+532 
+if_dex
+ = 1;
+
+533 } i(
+if_dex
+ =
+USHRT_MAX
+) {
+
+540 i(
+hlim
+) {
+
+541 
+	`nic
+("too many interfaces");
+
+543 
+hlim
+ = 
+ue
+;
+
+544 
+if_dex
+ = 1;
+
+546 
+i
+->
+if_dex
+ = if_index;
+
+548 
+sk
+:
+
+555 i(
+i_addrs
+ =
+NULL
+ || 
+ifdex2i
+ == NULL ||
+
+556 
+i
+->
+if_dex
+ >
+if_dexlim
+) {
+
+557 
+size_t
+ 
+m
+, 
+n
+, 
+dlim
+;
+
+558 *
+q
+;
+
+560 
+dlim
+ = 
+if_dexlim
+;
+
+561 
+i
+->
+if_dex
+ >
+if_dexlim
+)
+
+562 
+if_dexlim
+ <<= 1;
+
+565 
+m
+ = 
+dlim
+ * (
+iddr
+ *);
+
+566 
+n
+ = 
+if_dexlim
+ * (
+iddr
+ *);
+
+567 
+q
+ = 
+	`mloc
+(
+n
+, 
+M_IFADDR
+, 
+M_WAITOK
+|
+M_ZERO
+);
+
+568 i(
+i_addrs
+ !
+NULL
+) {
+
+569 
+	`memy
+(
+q
+, 
+i_addrs
+, 
+m
+);
+
+570 
+	`
+(
+i_addrs
+, 
+M_IFADDR
+);
+
+572 
+i_addrs
+ = (
+iddr
+ **)
+q
+;
+
+575 
+m
+ = 
+dlim
+ * (
+i
+ *);
+
+576 
+n
+ = 
+if_dexlim
+ * (
+i
+ *);
+
+577 
+q
+ = 
+	`mloc
+(
+n
+, 
+M_IFADDR
+, 
+M_WAITOK
+|
+M_ZERO
+);
+
+578 i(
+ifdex2i
+ !
+NULL
+) {
+
+579 
+	`memy
+(
+q
+, 
+ifdex2i
+, 
+m
+);
+
+580 
+	`
+(
+ifdex2i
+, 
+M_IFADDR
+);
+
+582 
+ifdex2i
+ = (
+i
+ **)
+q
+;
+
+584 
+ifdex2i
+[
+i
+->
+if_dex
+] = ifp;
+
+585 
+	}
+}
+
+599 
+	$if_lize
+(
+i_t
+ *
+i
+)
+
+601 
+	`KASSERT
+(
+if_dexlim
+ > 0);
+
+602 
+	`TAILQ_INIT
+(&
+i
+->
+if_addi
+);
+
+609 i(
+i
+->
+if_d
+.
+ifq_maxn
+ == 0)
+
+610 
+i
+->
+if_d
+.
+ifq_maxn
+ = 
+ifqmaxn
+;
+
+612 
+i
+->
+if_brdaddr
+ = 0;
+
+614 
+i
+->
+if_lk_e
+ = 
+LINK_STATE_UNKNOWN
+;
+
+616 
+i
+->
+if_b
+ = 0;
+
+617 
+i
+->
+if_csum_ags_tx
+ = 0;
+
+618 
+i
+->
+if_csum_ags_rx
+ = 0;
+
+620 #ifde
+ALTQ
+
+
+621 
+i
+->
+if_d
+.
+tq_ty
+ = 0;
+
+622 
+i
+->
+if_d
+.
+tq_disc
+ = 
+NULL
+;
+
+623 
+i
+->
+if_d
+.
+tq_ags
+ &
+ALTQF_CANTCHANGE
+;
+
+624 
+i
+->
+if_d
+.
+tq_tbr
+ = 
+NULL
+;
+
+625 
+i
+->
+if_d
+.
+tq_i
+ = ifp;
+
+628 #ifde
+NET_MPSAFE
+
+
+629 
+i
+->
+if_d
+.
+ifq_lock
+ = 
+	`mux_obj_loc
+(
+MUTEX_DEFAULT
+, 
+IPL_NET
+);
+
+631 
+i
+->
+if_d
+.
+ifq_lock
+ = 
+NULL
+;
+
+634 
+i
+->
+if_pf
+ = 
+	`pf_hd_
+(
+PFIL_TYPE_IFNET
+, ifp);
+
+635 ()
+	`pf_run_hooks
+(
+if_pf
+,
+
+636 (
+mbuf
+ **)
+PFIL_IFNET_ATTACH
+, 
+i
+, 
+PFIL_IFNET
+);
+
+638 
+	`if_gdex
+(
+i
+);
+
+639 
+	}
+}
+
+645 
+	$if_gi
+(
+i_t
+ *
+i
+)
+
+647 i(
+	`ifiol_ch
+(
+i
+) != 0)
+
+648 
+	`nic
+("%s: ifiol_ch(ed", 
+__func__
+);
+
+650 
+	`sysl_dq_tup
+(&
+i
+->
+if_sysl_log
+, i->
+if_xme
+, &i->
+if_d
+);
+
+652 i(!
+	`STAILQ_EMPTY
+(&
+domas
+))
+
+653 
+	`if_chdoma1
+(
+i
+);
+
+656 
+	`_iounmsg
+(
+i
+, 
+IFAN_ARRIVAL
+);
+
+658 i(
+i
+->
+if_owtimo
+ !
+NULL
+) {
+
+659 
+i
+->
+if_owtimo_ch
+ =
+
+660 
+	`kmem_zloc
+((*
+i
+->
+if_owtimo_ch
+), 
+KM_SLEEP
+);
+
+661 
+	`out_
+(
+i
+->
+if_owtimo_ch
+, 0);
+
+662 
+	`out_tfunc
+(
+i
+->
+if_owtimo_ch
+, 
+if_owtimo
+, ifp);
+
+663 
+	`if_owtimo
+(
+i
+);
+
+666 
+	`TAILQ_INSERT_TAIL
+(&
+i_li
+, 
+i
+, 
+if_li
+);
+
+667 
+	}
+}
+
+674 
+	$if_ch
+(
+i_t
+ *
+i
+)
+
+676 
+	`if_lize
+(
+i
+);
+
+677 
+	`if_gi
+(
+i
+);
+
+678 
+	}
+}
+
+681 
+	$if_chdoma
+()
+
+683 
+i
+ *
+i
+;
+
+684 
+s
+;
+
+686 
+s
+ = 
+	`
+();
+
+687 
+	`IFNET_FOREACH
+(
+i
+)
+
+688 
+	`if_chdoma1
+(
+i
+);
+
+689 
+	`lx
+(
+s
+);
+
+690 
+	}
+}
+
+693 
+	$if_chdoma1
+(
+i
+ *
+i
+)
+
+695 
+doma
+ *
+dp
+;
+
+696 
+s
+;
+
+698 
+s
+ = 
+	`
+();
+
+701 
+	`memt
+(
+i
+->
+if_afda
+, 0, (ifp->if_afdata));
+
+702 
+	`DOMAIN_FOREACH
+(
+dp
+) {
+
+703 i(
+dp
+->
+dom_iach
+ !
+NULL
+)
+
+704 
+i
+->
+if_afda
+[
+dp
+->
+dom_my
+] =
+
+705 (*
+dp
+->
+dom_iach
+)(
+i
+);
+
+708 
+	`lx
+(
+s
+);
+
+709 
+	}
+}
+
+716 
+	$if_dive
+(
+i
+ *
+i
+)
+
+718 
+s
+;
+
+720 
+s
+ = 
+	`
+();
+
+722 
+i
+->
+if_ouut
+ = 
+if_nuouut
+;
+
+723 
+i
+->
+if_put
+ = 
+if_nuput
+;
+
+724 
+i
+->
+if_t
+ = 
+if_nut
+;
+
+725 
+i
+->
+if_iol
+ = 
+if_nuiol
+;
+
+726 
+i
+->
+if_
+ = 
+if_nu
+;
+
+727 
+i
+->
+if_
+ = 
+if_nu
+;
+
+728 
+i
+->
+if_owtimo
+ = 
+if_nuowtimo
+;
+
+729 
+i
+->
+if_d
+ = 
+if_nud
+;
+
+732 
+i
+->
+if_d
+.
+ifq_maxn
+ = 0;
+
+734 
+	`lx
+(
+s
+);
+
+735 
+	}
+}
+
+738 
+if_purgddrs
+(
+i
+ *
+i
+, 
+my
+, (*
+purgddr
+)(
+iddr
+ *))
+
+740 
+iddr
+ *
+i
+, *
+ni
+;
+
+742 
+	`IFADDR_FOREACH_SAFE
+(
+i
+, 
+i
+, 
+ni
+) {
+
+743 i(
+i
+->
+i_addr
+->
+_my
+ !
+my
+)
+
+745 (*
+purgddr
+)(
+i
+);
+
+747 
+	}
+}
+
+757 
+	$if_dach
+(
+i
+ *
+i
+)
+
+759 
+sock
+ 
+so
+;
+
+760 
+iddr
+ *
+i
+;
+
+761 #ifde
+IFAREF_DEBUG
+
+
+762 
+iddr
+ *
+_i
+ = 
+NULL
+;
+
+764 
+doma
+ *
+dp
+;
+
+765 c 
+osw
+ *
+
+;
+
+766 
+s
+, 
+i
+, 
+my
+, 
+purged
+;
+
+767 
+ut64_t
+ 
+xc
+;
+
+773 
+	`memt
+(&
+so
+, 0, (so));
+
+775 
+s
+ = 
+	`
+();
+
+777 i(
+i
+->
+if_owtimo
+ !
+NULL
+) {
+
+778 
+i
+->
+if_owtimo
+ = 
+NULL
+;
+
+779 
+	`out_ht
+(
+i
+->
+if_owtimo_ch
+, 
+NULL
+);
+
+780 
+	`out_deroy
+(
+i
+->
+if_owtimo_ch
+);
+
+781 
+	`kmem_
+(
+i
+->
+if_owtimo_ch
+, (*ifp->if_slowtimo_ch));
+
+787 
+	`if_down
+(
+i
+);
+
+789 #ifde
+ALTQ
+
+
+790 i(
+	`ALTQ_IS_ENABLED
+(&
+i
+->
+if_d
+))
+
+791 
+	`tq_dib
+(&
+i
+->
+if_d
+);
+
+792 i(
+	`ALTQ_IS_ATTACHED
+(&
+i
+->
+if_d
+))
+
+793 
+	`tq_dach
+(&
+i
+->
+if_d
+);
+
+796 i(
+i
+->
+if_d
+.
+ifq_lock
+)
+
+797 
+	`mux_obj_
+(
+i
+->
+if_d
+.
+ifq_lock
+);
+
+799 
+	`sysl_down
+(&
+i
+->
+if_sysl_log
+);
+
+801 #i
+NCARP
+ > 0
+
+803 i(
+i
+->
+if_
+ !
+NULL
+ && i->
+if_ty
+ !
+IFT_CARP
+)
+
+804 
+	`_ifdach
+(
+i
+);
+
+820 
+aga
+:
+
+821 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+) {
+
+822 
+my
+ = 
+i
+->
+i_addr
+->
+_my
+;
+
+823 #ifde
+IFAREF_DEBUG
+
+
+824 
+	`tf
+("if_detach: ifaddr %p, family %d,efcnt %d\n",
+
+825 
+i
+, 
+my
+, i->
+i_ft
+);
+
+826 i(
+_i
+ !
+NULL
+ && 
+i
+ ==ast_ifa)
+
+827 
+	`nic
+("if_detach:oop detected");
+
+828 
+_i
+ = 
+i
+;
+
+830 i(
+my
+ =
+AF_LINK
+)
+
+832 
+dp
+ = 
+	`pffddoma
+(
+my
+);
+
+833 #ifde
+DIAGNOSTIC
+
+
+834 i(
+dp
+ =
+NULL
+)
+
+835 
+	`nic
+("if_detach:o domain for AF %d",
+
+836 
+my
+);
+
+845 
+purged
+ = 0;
+
+846 
+
+ = 
+dp
+->
+dom_osw
+;
+
+847 
+
+ < 
+dp
+->
+dom_oswNPROTOSW
+;r++) {
+
+848 
+so
+.
+so_o
+ = 
+
+;
+
+849 i(
+
+->
+_uqs
+) {
+
+850 ((*
+
+->
+_uqs
+->
+_purgeif
+)(&
+so
+, 
+i
+);
+
+851 
+purged
+ = 1;
+
+854 i(
+purged
+ == 0) {
+
+859 
+	`tf
+("if_detach: WARNING: AF %doturged\n",
+
+860 
+my
+);
+
+861 
+	`i_move
+(
+i
+, 
+i
+);
+
+863 
+aga
+;
+
+866 
+	`if__dl
+(
+i
+);
+
+869 
+i
+ = 0; i <
+AF_MAX
+; i++) {
+
+870 
+	`_wk
+(
+i
+, 
+if__wk
+, 
+i
+=
+ERESTART
+)
+
+874 
+	`DOMAIN_FOREACH
+(
+dp
+) {
+
+875 i(
+dp
+->
+dom_ifdach
+ !
+NULL
+ && 
+i
+->
+if_afda
+[dp->
+dom_my
+])
+
+877 *
+p
+ = 
+i
+->
+if_afda
+[
+dp
+->
+dom_my
+];
+
+878 i(
+p
+) {
+
+879 
+i
+->
+if_afda
+[
+dp
+->
+dom_my
+] = 
+NULL
+;
+
+880 (*
+dp
+->
+dom_ifdach
+)(
+i
+, 
+p
+);
+
+897 
+
+ = 
+dp
+->
+dom_osw
+;< dp->
+dom_oswNPROTOSW
+;r++) {
+
+898 
+so
+.
+so_o
+ = 
+
+;
+
+899 i(
+
+->
+_uqs
+ &&r->
+_ags
+ & 
+PR_PURGEIF
+)
+
+900 ()(*
+
+->
+_uqs
+->
+_purgeif
+)(&
+so
+, 
+i
+);
+
+904 ()
+	`pf_run_hooks
+(
+if_pf
+,
+
+905 (
+mbuf
+ **)
+PFIL_IFNET_DETACH
+, 
+i
+, 
+PFIL_IFNET
+);
+
+906 ()
+	`pf_hd_deroy
+(
+i
+->
+if_pf
+);
+
+909 
+	`_iounmsg
+(
+i
+, 
+IFAN_DEPARTURE
+);
+
+911 
+ifdex2i
+[
+i
+->
+if_dex
+] = 
+NULL
+;
+
+913 
+	`TAILQ_REMOVE
+(&
+i_li
+, 
+i
+, 
+if_li
+);
+
+915 
+	`ifiol_dach
+(
+i
+);
+
+920 
+	`DOMAIN_FOREACH
+(
+dp
+) {
+
+921 
+i
+ = 0; i < 
+	`__ycou
+(
+dp
+->
+dom_ifqueues
+); i++) {
+
+922 
+ifqueue
+ *
+iq
+ = 
+dp
+->
+dom_ifqueues
+[
+i
+];
+
+923 i(
+iq
+ =
+NULL
+)
+
+925 
+dp
+->
+dom_ifqueues
+[
+i
+] = 
+NULL
+;
+
+926 
+	`if_dach_queues
+(
+i
+, 
+iq
+);
+
+935 #ifde
+INET
+
+
+936 
+	`pktq_brr
+(
+_pktq
+);
+
+938 #ifde
+INET6
+
+
+939 i(
+6_e
+)
+
+940 
+	`pktq_brr
+(
+6_pktq
+);
+
+942 
+xc
+ = 
+	`xc_brd
+(0, (
+xcfunc_t
+)
+nu
+, 
+NULL
+, NULL);
+
+943 
+	`xc_wa
+(
+xc
+);
+
+945 
+	`lx
+(
+s
+);
+
+946 
+	}
+}
+
+949 
+	$if_dach_queues
+(
+i
+ *
+i
+, 
+ifqueue
+ *
+q
+)
+
+951 
+mbuf
+ *
+m
+, *
+ev
+, *
+xt
+;
+
+953 
+ev
+ = 
+NULL
+;
+
+954 
+m
+ = 
+q
+->
+ifq_hd
+; m !
+NULL
+; m = 
+xt
+) {
+
+955 
+	`KASSERT
+((
+m
+->
+m_ags
+ & 
+M_PKTHDR
+) != 0);
+
+957 
+xt
+ = 
+m
+->
+m_xkt
+;
+
+958 i(
+m
+->
+m_pkthdr
+.
+rcvif
+ !
+i
+) {
+
+959 
+ev
+ = 
+m
+;
+
+963 i(
+ev
+ !
+NULL
+)
+
+964 
+ev
+->
+m_xkt
+ = 
+m
+->m_nextpkt;
+
+966 
+q
+->
+ifq_hd
+ = 
+m
+->
+m_xkt
+;
+
+967 i(
+q
+->
+ifq_
+ =
+m
+)
+
+968 
+q
+->
+ifq_
+ = 
+ev
+;
+
+969 
+q
+->
+ifq_n
+--;
+
+971 
+m
+->
+m_xkt
+ = 
+NULL
+;
+
+972 
+	`m_m
+(
+m
+);
+
+973 
+	`IF_DROP
+(
+q
+);
+
+975 
+	}
+}
+
+982 
+	$if__wk
+(
+y
+ *
+
+, *
+v
+)
+
+984 
+i
+ *
+i
+ = (i *)
+v
+;
+
+985 
+r
+;
+
+987 i(
+
+->
+_i
+ !
+i
+)
+
+991 ++
+
+->
+_ft
+;
+
+992 
+r
+ = 
+	`que
+(
+RTM_DELETE
+, 
+	`_gkey
+(
+
+),t->
+_geway
+,
+
+993 
+	`_mask
+(
+
+),t->
+_ags
+, 
+NULL
+);
+
+994 
+	`KASSERT
+((
+
+->
+_ags
+ & 
+RTF_UP
+) == 0);
+
+995 
+
+->
+_i
+ = 
+NULL
+;
+
+996 
+	`
+(
+
+);
+
+997 i(
+r
+ != 0)
+
+998 
+	`tf
+("%s: warning: unableo deletetentry @ %p, "
+
+999 "r = %d\n", 
+i
+->
+if_xme
+, 
+
+, 
+r
+);
+
+1000  
+ERESTART
+;
+
+1001 
+	}
+}
+
+1007 
+	$if_e_
+(c *
+me
+)
+
+1009 
+if_e
+ *
+ifc
+;
+
+1010 
+un
+;
+
+1012 
+ifc
+ = 
+	`if_e_lookup
+(
+me
+, &
+un
+);
+
+1013 i(
+ifc
+ =
+NULL
+)
+
+1014  
+EINVAL
+;
+
+1016 i(
+	`ifun
+(
+me
+!
+NULL
+)
+
+1017  
+EEXIST
+;
+
+1019  (*
+ifc
+->
+ifc_
+)(ifc, 
+un
+);
+
+1020 
+	}
+}
+
+1026 
+	$if_e_deroy
+(c *
+me
+)
+
+1028 
+if_e
+ *
+ifc
+;
+
+1029 
+i
+ *
+i
+;
+
+1031 
+ifc
+ = 
+	`if_e_lookup
+(
+me
+, 
+NULL
+);
+
+1032 i(
+ifc
+ =
+NULL
+)
+
+1033  
+EINVAL
+;
+
+1035 
+i
+ = 
+	`ifun
+(
+me
+);
+
+1036 i(
+i
+ =
+NULL
+)
+
+1037  
+ENXIO
+;
+
+1039 i(
+ifc
+->
+ifc_deroy
+ =
+NULL
+)
+
+1040  
+EOPNOTSUPP
+;
+
+1042  (*
+ifc
+->
+ifc_deroy
+)(
+i
+);
+
+1043 
+	}
+}
+
+1048 
+if_e
+ *
+
+1049 
+	$if_e_lookup
+(c *
+me
+, *
+unp
+)
+
+1051 
+if_e
+ *
+ifc
+;
+
+1052 c *
+
+;
+
+1053 *
+dp
+, 
+iame
+[
+IFNAMSIZ
+ + 3];
+
+1054 
+un
+;
+
+1056 
+	`ry
+(
+iame
+, "if_");
+
+1058 
+dp
+ = 
+iame
+ + 3, 
+
+ = 
+me
+; c-am< 
+IFNAMSIZ
+ &&
+
+1059 *
+
+ && (*cp < '0' || *cp > '9');)
+
+1060 *
+dp
+++ = *
+
+++;
+
+1062 i(
+
+ =
+me
+ || c-am=
+IFNAMSIZ
+ || !*cp)
+
+1063  
+NULL
+;
+
+1064 *
+dp
+++ = '\0';
+
+1066 
+aga
+:
+
+1067 
+	`LIST_FOREACH
+(
+ifc
+, &
+if_s
+, 
+ifc_li
+) {
+
+1068 i(
+	`rcmp
+(
+iame
+ + 3, 
+ifc
+->
+ifc_me
+) == 0)
+
+1072 i(
+ifc
+ =
+NULL
+) {
+
+1073 i(*
+iame
+ == '\0' ||
+
+1074 
+	`modu_autd
+(
+iame
+, 
+MODULE_CLASS_DRIVER
+))
+
+1075  
+NULL
+;
+
+1076 *
+iame
+ = '\0';
+
+1077 
+aga
+;
+
+1080 
+un
+ = 0;
+
+1081 
+
+ - 
+me
+ < 
+IFNAMSIZ
+ && *cp) {
+
+1082 i(*
+
+ < '0' || * > '9' || 
+un
+ >
+INT_MAX
+ / 10) {
+
+1084  
+NULL
+;
+
+1086 
+un
+ = (un * 10+ (*
+
+++ - '0');
+
+1089 i(
+unp
+ !
+NULL
+)
+
+1090 *
+unp
+ = 
+un
+;
+
+1091  
+ifc
+;
+
+1092 
+	}
+}
+
+1098 
+	$if_e_ch
+(
+if_e
+ *
+ifc
+)
+
+1101 
+	`LIST_INSERT_HEAD
+(&
+if_s
+, 
+ifc
+, 
+ifc_li
+);
+
+1102 
+if_s_cou
+++;
+
+1103 
+	}
+}
+
+1109 
+	$if_e_dach
+(
+if_e
+ *
+ifc
+)
+
+1112 
+	`LIST_REMOVE
+(
+ifc
+, 
+ifc_li
+);
+
+1113 
+if_s_cou
+--;
+
+1114 
+	}
+}
+
+1120 
+	$if_e_li
+(
+buf_cou
+, *
+bufr
+, *
+t
+)
+
+1122 
+outbuf
+[
+IFNAMSIZ
+], *
+d
+;
+
+1123 
+if_e
+ *
+ifc
+;
+
+1124 
+cou
+, 
+r
+ = 0;
+
+1126 *
+t
+ = 
+if_s_cou
+;
+
+1127 i((
+d
+ = 
+bufr
+=
+NULL
+) {
+
+1132 i(
+buf_cou
+ < 0)
+
+1133  
+EINVAL
+;
+
+1135 
+cou
+ = (
+if_s_cou
+ < 
+buf_cou
+) ?
+
+1136 
+if_s_cou
+ : 
+buf_cou
+;
+
+1138 
+ifc
+ = 
+	`LIST_FIRST
+(&
+if_s
+); if!
+NULL
+ && 
+cou
+ != 0;
+
+1139 
+ifc
+ = 
+	`LIST_NEXT
+(ifc, 
+ifc_li
+), 
+cou
+--, 
+d
+ +
+IFNAMSIZ
+) {
+
+1140 ()
+	`y
+(
+outbuf
+, 
+ifc
+->
+ifc_me
+, (outbuf));
+
+1141 i(
+outbuf
+[(outbuf) - 1] != '\0')
+
+1142  
+ENAMETOOLONG
+;
+
+1143 
+r
+ = 
+	`cyout
+(
+outbuf
+, 
+d
+, (outbuf));
+
+1144 i(
+r
+ != 0)
+
+1148  
+r
+;
+
+1149 
+	}
+}
+
+1152 
+	$if
+(
+iddr
+ *
+i
+)
+
+1154 
+i
+->
+i_ft
+++;
+
+1155 
+	}
+}
+
+1158 
+	$i
+(
+iddr
+ *
+i
+)
+
+1160 
+	`KASSERT
+(
+i
+ !
+NULL
+);
+
+1161 
+	`KASSERT
+(
+i
+->
+i_ft
+ > 0);
+
+1163 i(--
+i
+->
+i_ft
+ == 0) {
+
+1164 
+	`
+(
+i
+, 
+M_IFADDR
+);
+
+1166 
+	}
+}
+
+1169 
+	$i_
+(
+i
+ *
+i
+, 
+iddr
+ *
+i
+)
+
+1171 
+i
+->
+i_i
+ = 
+i
+;
+
+1172 
+	`TAILQ_INSERT_TAIL
+(&
+i
+->
+if_addi
+, 
+i
+, 
+i_li
+);
+
+1173 
+	`if
+(
+i
+);
+
+1174 
+	}
+}
+
+1177 
+	$i_move
+(
+i
+ *
+i
+, 
+iddr
+ *
+i
+)
+
+1179 
+	`KASSERT
+(
+i
+->
+i_i
+ =
+i
+);
+
+1180 
+	`TAILQ_REMOVE
+(&
+i
+->
+if_addi
+, 
+i
+, 
+i_li
+);
+
+1181 
+	`i
+(
+i
+);
+
+1182 
+	}
+}
+
+1184 
+le
+ 
+
+1185 
+	$equ
+(c 
+sockaddr
+ *
+1
+, c sockadd*
+2
+)
+
+1187  
+	`sockaddr_cmp
+(
+1
+, 
+2
+) == 0;
+
+1188 
+	}
+}
+
+1194 
+iddr
+ *
+
+1195 
+	$i_ifwhaddr
+(c 
+sockaddr
+ *
+addr
+)
+
+1197 
+i
+ *
+i
+;
+
+1198 
+iddr
+ *
+i
+;
+
+1200 
+	`IFNET_FOREACH
+(
+i
+) {
+
+1201 i(
+i
+->
+if_ouut
+ =
+if_nuouut
+)
+
+1203 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+) {
+
+1204 i(
+i
+->
+i_addr
+->
+_my
+ !
+addr
+->sa_family)
+
+1206 i(
+	`equ
+(
+addr
+, 
+i
+->
+i_addr
+))
+
+1207  
+i
+;
+
+1208 i((
+i
+->
+if_ags
+ & 
+IFF_BROADCAST
+) &&
+
+1209 
+i
+->
+i_brdaddr
+ &&
+
+1211 
+i
+->
+i_brdaddr
+->
+_n
+ != 0 &&
+
+1212 
+	`equ
+(
+i
+->
+i_brdaddr
+, 
+addr
+))
+
+1213  
+i
+;
+
+1216  
+NULL
+;
+
+1217 
+	}
+}
+
+1223 
+iddr
+ *
+
+1224 
+	$i_ifwhdaddr
+(c 
+sockaddr
+ *
+addr
+)
+
+1226 
+i
+ *
+i
+;
+
+1227 
+iddr
+ *
+i
+;
+
+1229 
+	`IFNET_FOREACH
+(
+i
+) {
+
+1230 i(
+i
+->
+if_ouut
+ =
+if_nuouut
+)
+
+1232 i((
+i
+->
+if_ags
+ & 
+IFF_POINTOPOINT
+) == 0)
+
+1234 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+) {
+
+1235 i(
+i
+->
+i_addr
+->
+_my
+ !
+addr
+->sa_family ||
+
+1236 
+i
+->
+i_daddr
+ =
+NULL
+)
+
+1238 i(
+	`equ
+(
+addr
+, 
+i
+->
+i_daddr
+))
+
+1239  
+i
+;
+
+1242  
+NULL
+;
+
+1243 
+	}
+}
+
+1249 
+iddr
+ *
+
+1250 
+	$i_ifwht
+(c 
+sockaddr
+ *
+addr
+)
+
+1252 
+i
+ *
+i
+;
+
+1253 
+iddr
+ *
+i
+;
+
+1254 c 
+sockaddr_dl
+ *
+sdl
+;
+
+1255 
+iddr
+ *
+i_maybe
+ = 0;
+
+1256 
+u_t
+ 
+af
+ = 
+addr
+->
+_my
+;
+
+1257 c *
+addr_da
+ = 
+addr
+->
+_da
+, *
+lim
+;
+
+1259 i(
+af
+ =
+AF_LINK
+) {
+
+1260 
+sdl
+ = 
+	`tocsdl
+(
+addr
+);
+
+1261 i(
+sdl
+->
+sdl_dex
+ && sdl->sdl_dex < 
+if_dexlim
+ &&
+
+1262 
+ifdex2i
+[
+sdl
+->
+sdl_dex
+] &&
+
+1263 
+ifdex2i
+[
+sdl
+->
+sdl_dex
+]->
+if_ouut
+ !
+if_nuouut
+)
+
+1264  
+i_addrs
+[
+sdl
+->
+sdl_dex
+];
+
+1266 #ifde
+NETATALK
+
+
+1267 i(
+af
+ =
+AF_APPLETALK
+) {
+
+1268 c 
+sockaddr_
+ *
+t
+, *
+t2
+;
+
+1269 
+t
+ = (c 
+sockaddr_
+ *)
+addr
+;
+
+1270 
+	`IFNET_FOREACH
+(
+i
+) {
+
+1271 i(
+i
+->
+if_ouut
+ =
+if_nuouut
+)
+
+1273 
+i
+ = 
+	`_iwht
+((c 
+sockaddr_
+ *)
+addr
+, 
+i
+);
+
+1274 i(
+i
+ =
+NULL
+)
+
+1276 
+t2
+ = (
+sockaddr_
+ *)
+i
+->
+i_addr
+;
+
+1277 i(
+t2
+->
+t_addr
+.
+s_t
+ =
+t
+->sat_addr.s_net)
+
+1278  
+i
+;
+
+1279 i(
+i_maybe
+ =
+NULL
+) {
+
+1281 
+i_maybe
+ = 
+i
+;
+
+1284  
+i_maybe
+;
+
+1287 
+	`IFNET_FOREACH
+(
+i
+) {
+
+1288 i(
+i
+->
+if_ouut
+ =
+if_nuouut
+)
+
+1290 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+) {
+
+1291 c *
+
+, *
+2
+, *
+3
+;
+
+1293 i(
+i
+->
+i_addr
+->
+_my
+ !
+af
+ ||
+
+1294 
+i
+->
+i_tmask
+ =
+NULL
+)
+
+1295 
+xt
+: ;
+
+1296 
+
+ = 
+addr_da
+;
+
+1297 
+2
+ = 
+i
+->
+i_addr
+->
+_da
+;
+
+1298 
+3
+ = 
+i
+->
+i_tmask
+->
+_da
+;
+
+1299 
+lim
+ = (c *)
+i
+->
+i_tmask
+ +
+
+1300 
+i
+->
+i_tmask
+->
+_n
+;
+
+1301 
+3
+ < 
+lim
+) {
+
+1302 i((*
+
+++ ^ *
+2
+++& *
+3
+++) {
+
+1304 
+xt
+;
+
+1307 i(
+i_maybe
+ =
+NULL
+ ||
+
+1308 
+	`_fes
+((*)
+i
+->
+i_tmask
+,
+
+1309 (*)
+i_maybe
+->
+i_tmask
+))
+
+1310 
+i_maybe
+ = 
+i
+;
+
+1313  
+i_maybe
+;
+
+1314 
+	}
+}
+
+1319 
+iddr
+ *
+
+1320 
+	$i_ifwhddr
+(c 
+sockaddr
+ *
+addr
+)
+
+1322 
+iddr
+ *
+
+;
+
+1324 i((
+
+ = 
+	`i_ifwhaddr
+(
+addr
+)|| ( = 
+	`i_ifwhdaddr
+(addr)) ||
+
+1325 (
+
+ = 
+	`i_ifwht
+(
+addr
+)))
+
+1326  
+
+;
+
+1327  
+NULL
+;
+
+1328 
+	}
+}
+
+1333 
+iddr
+ *
+
+1334 
+	$i_ifwhaf
+(
+af
+)
+
+1336 
+i
+ *
+i
+;
+
+1337 
+iddr
+ *
+i
+;
+
+1339 
+	`IFNET_FOREACH
+(
+i
+) {
+
+1340 i(
+i
+->
+if_ouut
+ =
+if_nuouut
+)
+
+1342 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+) {
+
+1343 i(
+i
+->
+i_addr
+->
+_my
+ =
+af
+)
+
+1344  
+i
+;
+
+1347  
+NULL
+;
+
+1348 
+	}
+}
+
+1354 
+iddr
+ *
+
+1355 
+	$iof_ifaddr
+(c 
+sockaddr
+ *
+addr
+, 
+i
+ *
+i
+)
+
+1357 
+iddr
+ *
+i
+;
+
+1358 c *
+
+, *
+2
+, *
+3
+;
+
+1359 c *
+lim
+;
+
+1360 
+iddr
+ *
+i_maybe
+ = 0;
+
+1361 
+u_t
+ 
+af
+ = 
+addr
+->
+_my
+;
+
+1363 i(
+i
+->
+if_ouut
+ =
+if_nuouut
+)
+
+1364  
+NULL
+;
+
+1366 i(
+af
+ >
+AF_MAX
+)
+
+1367  
+NULL
+;
+
+1369 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+) {
+
+1370 i(
+i
+->
+i_addr
+->
+_my
+ !
+af
+)
+
+1372 
+i_maybe
+ = 
+i
+;
+
+1373 i(
+i
+->
+i_tmask
+ =
+NULL
+) {
+
+1374 i(
+	`equ
+(
+addr
+, 
+i
+->
+i_addr
+) ||
+
+1375 (
+i
+->
+i_daddr
+ &&
+
+1376 
+	`equ
+(
+addr
+, 
+i
+->
+i_daddr
+)))
+
+1377  
+i
+;
+
+1380 
+
+ = 
+addr
+->
+_da
+;
+
+1381 
+2
+ = 
+i
+->
+i_addr
+->
+_da
+;
+
+1382 
+3
+ = 
+i
+->
+i_tmask
+->
+_da
+;
+
+1383 
+lim
+ = 
+i
+->
+i_tmask
+->
+_n
+ + (*)ifa->ifa_netmask;
+
+1384 ; 
+3
+ < 
+lim
+; cp3++) {
+
+1385 i((*
+
+++ ^ *
+2
+++& *
+3
+)
+
+1388 i(
+3
+ =
+lim
+)
+
+1389  
+i
+;
+
+1391  
+i_maybe
+;
+
+1392 
+	}
+}
+
+1400 
+	$lk_que
+(
+cmd
+, 
+y
+ *
+
+, c 
+_addrfo
+ *
+fo
+)
+
+1402 
+iddr
+ *
+i
+;
+
+1403 c 
+sockaddr
+ *
+d
+;
+
+1404 
+i
+ *
+i
+;
+
+1406 i(
+cmd
+ !
+RTM_ADD
+ || (
+i
+ = 
+
+->
+_i
+=
+NULL
+ ||
+
+1407 (
+i
+ = 
+i
+->
+i_i
+=
+NULL
+ || (
+d
+ = 
+	`_gkey
+(
+
+)) == NULL)
+
+1409 i((
+i
+ = 
+	`iof_ifaddr
+(
+d
+, 
+i
+)!
+NULL
+) {
+
+1410 
+	`_a_i
+(
+
+, 
+i
+);
+
+1411 i(
+i
+->
+i_que
+ && i->i_que !
+lk_que
+)
+
+1412 
+i
+->
+	`i_que
+(
+cmd
+, 
+
+, 
+fo
+);
+
+1414 
+	}
+}
+
+1422 
+	$if_lk_e_chge
+(
+i
+ *
+i
+, 
+lk_e
+)
+
+1424 
+s
+;
+
+1425 
+d_lk_e
+;
+
+1426 
+doma
+ *
+dp
+;
+
+1428 
+s
+ = 
+	`
+();
+
+1429 i(
+i
+->
+if_lk_e
+ =
+lk_e
+) {
+
+1430 
+	`lx
+(
+s
+);
+
+1434 
+d_lk_e
+ = 
+i
+->
+if_lk_e
+;
+
+1435 
+i
+->
+if_lk_e
+ = 
+lk_e
+;
+
+1436 #ifde
+DEBUG
+
+
+1437 
+	`log
+(
+LOG_DEBUG
+, "%s:k s %(wa%s)\n", 
+i
+->
+if_xme
+,
+
+1438 
+lk_e
+ =
+LINK_STATE_UP
+ ? "UP" :
+
+1439 
+lk_e
+ =
+LINK_STATE_DOWN
+ ? "DOWN" :
+
+1441 
+d_lk_e
+ =
+LINK_STATE_UP
+ ? "UP" :
+
+1442 
+d_lk_e
+ =
+LINK_STATE_DOWN
+ ? "DOWN" :
+
+1455 i(
+lk_e
+ =
+LINK_STATE_UP
+ &&
+
+1456 
+d_lk_e
+ =
+LINK_STATE_UNKNOWN
+)
+
+1458 
+	`DOMAIN_FOREACH
+(
+dp
+) {
+
+1459 i(
+dp
+->
+dom_if_lk_e_chge
+ !
+NULL
+)
+
+1460 
+dp
+->
+	`dom_if_lk_e_chge
+(
+i
+,
+
+1461 
+LINK_STATE_DOWN
+);
+
+1466 
+	`_ifmsg
+(
+i
+);
+
+1468 #i
+NCARP
+ > 0
+
+1469 i(
+i
+->
+if_
+)
+
+1470 
+	`_dev_e
+(
+i
+);
+
+1473 
+	`DOMAIN_FOREACH
+(
+dp
+) {
+
+1474 i(
+dp
+->
+dom_if_lk_e_chge
+ !
+NULL
+)
+
+1475 
+dp
+->
+	`dom_if_lk_e_chge
+(
+i
+, 
+lk_e
+);
+
+1478 
+	`lx
+(
+s
+);
+
+1479 
+	}
+}
+
+1486 
+	$p2p_que
+(
+q
+, 
+y
+ *
+
+,
+
+1487 
+__unud
+ c 
+_addrfo
+ *
+fo
+)
+
+1489 
+i
+ *
+i
+ = 
+
+->
+_i
+;
+
+1490 
+iddr
+ *
+i
+, *
+lo0i
+;
+
+1492 
+q
+) {
+
+1493 
+RTM_ADD
+:
+
+1494 i((
+
+->
+_ags
+ & 
+RTF_LOCAL
+) == 0)
+
+1497 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+) {
+
+1498 i(
+	`equ
+(
+	`_gkey
+(
+
+), 
+i
+->
+i_addr
+))
+
+1501 i(
+i
+ =
+NULL
+)
+
+1507 
+	`IFADDR_FOREACH
+(
+lo0i
+, 
+lo0i
+) {
+
+1508 i(
+lo0i
+->
+i_addr
+->
+_my
+ ==
+
+1509 
+i
+->
+i_addr
+->
+_my
+)
+
+1512 i(
+lo0i
+ =
+NULL
+)
+
+1515 
+
+->
+_i
+ = 
+lo0i
+;
+
+1516 
+
+->
+_ags
+ &~
+RTF_LLINFO
+;
+
+1523 i(
+i
+ !
+
+->
+_i
+)
+
+1524 
+	`_a_i
+(
+
+, 
+i
+);
+
+1526 
+RTM_DELETE
+:
+
+1527 
+RTM_RESOLVE
+:
+
+1531 
+	}
+}
+
+1539 
+	$if_down
+(
+i
+ *
+i
+)
+
+1541 
+iddr
+ *
+i
+;
+
+1542 
+doma
+ *
+dp
+;
+
+1544 
+i
+->
+if_ags
+ &~
+IFF_UP
+;
+
+1545 
+	`nime
+(&
+i
+->
+if_chge
+);
+
+1546 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+)
+
+1547 
+	`pflput
+(
+PRC_IFDOWN
+, 
+i
+->
+i_addr
+);
+
+1548 
+	`IFQ_PURGE
+(&
+i
+->
+if_d
+);
+
+1549 #i
+NCARP
+ > 0
+
+1550 i(
+i
+->
+if_
+)
+
+1551 
+	`_dev_e
+(
+i
+);
+
+1553 
+	`_ifmsg
+(
+i
+);
+
+1554 
+	`DOMAIN_FOREACH
+(
+dp
+) {
+
+1555 i(
+dp
+->
+dom_if_down
+)
+
+1556 
+dp
+->
+	`dom_if_down
+(
+i
+);
+
+1558 
+	}
+}
+
+1566 
+	$if_up
+(
+i
+ *
+i
+)
+
+1568 #ifde
+ny
+
+
+1569 
+iddr
+ *
+i
+;
+
+1571 
+doma
+ *
+dp
+;
+
+1573 
+i
+->
+if_ags
+ |
+IFF_UP
+;
+
+1574 
+	`nime
+(&
+i
+->
+if_chge
+);
+
+1575 #ifde
+ny
+
+
+1577 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+)
+
+1578 
+	`pflput
+(
+PRC_IFUP
+, 
+i
+->
+i_addr
+);
+
+1580 #i
+NCARP
+ > 0
+
+1581 i(
+i
+->
+if_
+)
+
+1582 
+	`_dev_e
+(
+i
+);
+
+1584 
+	`_ifmsg
+(
+i
+);
+
+1585 
+	`DOMAIN_FOREACH
+(
+dp
+) {
+
+1586 i(
+dp
+->
+dom_if_up
+)
+
+1587 
+dp
+->
+	`dom_if_up
+(
+i
+);
+
+1589 
+	}
+}
+
+1597 
+	$if_owtimo
+(*
+g
+)
+
+1599 (*
+owtimo
+)(
+i
+ *);
+
+1600 
+i
+ *
+i
+ = 
+g
+;
+
+1601 
+s
+;
+
+1603 
+owtimo
+ = 
+i
+->
+if_owtimo
+;
+
+1604 i(
+	`__edi_l
+(
+owtimo
+ =
+NULL
+))
+
+1607 
+s
+ = 
+	`
+();
+
+1608 i(
+i
+->
+if_tim
+ != 0 && --ifp->if_timer == 0)
+
+1609 (*
+owtimo
+)(
+i
+);
+
+1611 
+	`lx
+(
+s
+);
+
+1613 i(
+	`__edi_ue
+(
+i
+->
+if_owtimo
+ !
+NULL
+))
+
+1614 
+	`out_schedu
+(
+i
+->
+if_owtimo_ch
+, 
+hz
+ / 
+IFNET_SLOWHZ
+);
+
+1615 
+	}
+}
+
+1624 
+	$iromisc
+(
+i
+ *
+i
+, 
+pswch
+)
+
+1626 
+pcou
+, 
+t
+;
+
+1627 
+nags
+;
+
+1629 
+pcou
+ = 
+i
+->
+if_pcou
+;
+
+1630 i(
+pswch
+) {
+
+1636 i(
+i
+->
+if_pcou
+++ != 0)
+
+1638 
+nags
+ = 
+i
+->
+if_ags
+ | 
+IFF_PROMISC
+;
+
+1640 i(--
+i
+->
+if_pcou
+ > 0)
+
+1642 
+nags
+ = 
+i
+->
+if_ags
+ & ~
+IFF_PROMISC
+;
+
+1644 
+t
+ = 
+	`if_ags_t
+(
+i
+, 
+nags
+);
+
+1646 i(
+t
+ != 0) {
+
+1647 
+i
+->
+if_pcou
+ = 
+pcou
+;
+
+1649  
+t
+;
+
+1650 
+	}
+}
+
+1656 
+i
+ *
+
+1657 
+	$ifun
+(c *
+me
+)
+
+1659 
+i
+ *
+i
+;
+
+1660 c *
+
+ = 
+me
+;
+
+1661 
+u_t
+ 
+un
+ = 0;
+
+1662 
+u_t
+ 
+i
+;
+
+1667 
+i
+ = 0; i < 
+IFNAMSIZ
+ && *
+
+ >= '0' && *cp <= '9'; i++, cp++) {
+
+1668 
+un
+ = un * 10 + (*
+
+ - '0');
+
+1674 i(
+i
+ =
+IFNAMSIZ
+ || (
+
+ !
+me
+ && *cp == '\0')) {
+
+1675 i(
+un
+ >
+if_dexlim
+)
+
+1676  
+NULL
+;
+
+1677 
+i
+ = 
+ifdex2i
+[
+un
+];
+
+1678 i(
+i
+ =
+NULL
+ || i->
+if_ouut
+ =
+if_nuouut
+)
+
+1679  
+NULL
+;
+
+1680  
+i
+;
+
+1683 
+	`IFNET_FOREACH
+(
+i
+) {
+
+1684 i(
+i
+->
+if_ouut
+ =
+if_nuouut
+)
+
+1686 i(
+	`rcmp
+(
+i
+->
+if_xme
+, 
+me
+) == 0)
+
+1687  
+i
+;
+
+1689  
+NULL
+;
+
+1690 
+	}
+}
+
+1692 
+i_t
+ *
+
+1693 
+	$if_bydex
+(
+u_t
+ 
+idx
+)
+
+1695  (
+idx
+ < 
+if_dexlim
+? 
+ifdex2i
+[idx] : 
+NULL
+;
+
+1696 
+	}
+}
+
+1700 
+	$ifiol_comm
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+1702 
+s
+;
+
+1703 
+ieq
+ *
+i
+;
+
+1704 
+ifeq
+ *
+if
+;
+
+1705 
+ifdeq
+ *
+ifdr
+;
+
+1707 
+cmd
+) {
+
+1708 
+SIOCSIFCAP
+:
+
+1709 
+if
+ = 
+da
+;
+
+1710 i((
+if
+->
+if_b
+ & ~
+i
+->
+if_bs
+) != 0)
+
+1711  
+EINVAL
+;
+
+1713 i(
+if
+->
+if_b
+ =
+i
+->
+if_b
+)
+
+1716 
+i
+->
+if_b
+ = 
+if
+->
+if_b
+;
+
+1719 
+i
+->
+if_csum_ags_tx
+ = 0;
+
+1720 
+i
+->
+if_csum_ags_rx
+ = 0;
+
+1721 i(
+i
+->
+if_b
+ & 
+IFCAP_CSUM_IPv4_Tx
+) {
+
+1722 
+i
+->
+if_csum_ags_tx
+ |
+M_CSUM_IPv4
+;
+
+1724 i(
+i
+->
+if_b
+ & 
+IFCAP_CSUM_IPv4_Rx
+) {
+
+1725 
+i
+->
+if_csum_ags_rx
+ |
+M_CSUM_IPv4
+;
+
+1728 i(
+i
+->
+if_b
+ & 
+IFCAP_CSUM_TCPv4_Tx
+) {
+
+1729 
+i
+->
+if_csum_ags_tx
+ |
+M_CSUM_TCPv4
+;
+
+1731 i(
+i
+->
+if_b
+ & 
+IFCAP_CSUM_TCPv4_Rx
+) {
+
+1732 
+i
+->
+if_csum_ags_rx
+ |
+M_CSUM_TCPv4
+;
+
+1735 i(
+i
+->
+if_b
+ & 
+IFCAP_CSUM_UDPv4_Tx
+) {
+
+1736 
+i
+->
+if_csum_ags_tx
+ |
+M_CSUM_UDPv4
+;
+
+1738 i(
+i
+->
+if_b
+ & 
+IFCAP_CSUM_UDPv4_Rx
+) {
+
+1739 
+i
+->
+if_csum_ags_rx
+ |
+M_CSUM_UDPv4
+;
+
+1742 i(
+i
+->
+if_b
+ & 
+IFCAP_CSUM_TCPv6_Tx
+) {
+
+1743 
+i
+->
+if_csum_ags_tx
+ |
+M_CSUM_TCPv6
+;
+
+1745 i(
+i
+->
+if_b
+ & 
+IFCAP_CSUM_TCPv6_Rx
+) {
+
+1746 
+i
+->
+if_csum_ags_rx
+ |
+M_CSUM_TCPv6
+;
+
+1749 i(
+i
+->
+if_b
+ & 
+IFCAP_CSUM_UDPv6_Tx
+) {
+
+1750 
+i
+->
+if_csum_ags_tx
+ |
+M_CSUM_UDPv6
+;
+
+1752 i(
+i
+->
+if_b
+ & 
+IFCAP_CSUM_UDPv6_Rx
+) {
+
+1753 
+i
+->
+if_csum_ags_rx
+ |
+M_CSUM_UDPv6
+;
+
+1755 i(
+i
+->
+if_ags
+ & 
+IFF_UP
+)
+
+1756  
+ENETRESET
+;
+
+1758 
+SIOCSIFFLAGS
+:
+
+1759 
+i
+ = 
+da
+;
+
+1760 i(
+i
+->
+if_ags
+ & 
+IFF_UP
+ && (
+i
+->
+i_ags
+ & IFF_UP) == 0) {
+
+1761 
+s
+ = 
+	`
+();
+
+1762 
+	`if_down
+(
+i
+);
+
+1763 
+	`lx
+(
+s
+);
+
+1765 i(
+i
+->
+i_ags
+ & 
+IFF_UP
+ && (
+i
+->
+if_ags
+ & IFF_UP) == 0) {
+
+1766 
+s
+ = 
+	`
+();
+
+1767 
+	`if_up
+(
+i
+);
+
+1768 
+	`lx
+(
+s
+);
+
+1770 
+i
+->
+if_ags
+ = (i->if_ag& 
+IFF_CANTCHANGE
+) |
+
+1771 (
+i
+->
+i_ags
+ &~ 
+IFF_CANTCHANGE
+);
+
+1773 
+SIOCGIFFLAGS
+:
+
+1774 
+i
+ = 
+da
+;
+
+1775 
+i
+->
+i_ags
+ = 
+i
+->
+if_ags
+;
+
+1778 
+SIOCGIFMETRIC
+:
+
+1779 
+i
+ = 
+da
+;
+
+1780 
+i
+->
+i_mric
+ = 
+i
+->
+if_mric
+;
+
+1783 
+SIOCGIFMTU
+:
+
+1784 
+i
+ = 
+da
+;
+
+1785 
+i
+->
+i_mtu
+ = 
+i
+->
+if_mtu
+;
+
+1788 
+SIOCGIFDLT
+:
+
+1789 
+i
+ = 
+da
+;
+
+1790 
+i
+->
+i_d
+ = 
+i
+->
+if_d
+;
+
+1793 
+SIOCGIFCAP
+:
+
+1794 
+if
+ = 
+da
+;
+
+1795 
+if
+->
+if_bs
+ = 
+i
+->
+if_bs
+;
+
+1796 
+if
+->
+if_b
+ = 
+i
+->
+if_b
+;
+
+1799 
+SIOCSIFMETRIC
+:
+
+1800 
+i
+ = 
+da
+;
+
+1801 
+i
+->
+if_mric
+ = 
+i
+->
+i_mric
+;
+
+1804 
+SIOCGIFDATA
+:
+
+1805 
+ifdr
+ = 
+da
+;
+
+1806 
+ifdr
+->
+ifdr_da
+ = 
+i
+->
+if_da
+;
+
+1809 
+SIOCGIFINDEX
+:
+
+1810 
+i
+ = 
+da
+;
+
+1811 
+i
+->
+i_dex
+ = 
+i
+->
+if_dex
+;
+
+1814 
+SIOCZIFDATA
+:
+
+1815 
+ifdr
+ = 
+da
+;
+
+1816 
+ifdr
+->
+ifdr_da
+ = 
+i
+->
+if_da
+;
+
+1821 
+	`memt
+(&
+i
+->
+if_da
+.
+ifi_acks
+, 0, (ifp->if_data) -
+
+1822 
+	`offtof
+(
+if_da
+, 
+ifi_acks
+));
+
+1830 
+	`gnime
+(&
+i
+->
+if_chge
+);
+
+1832 
+SIOCSIFMTU
+:
+
+1833 
+i
+ = 
+da
+;
+
+1834 i(
+i
+->
+if_mtu
+ =
+i
+->
+i_mtu
+)
+
+1836 
+i
+->
+if_mtu
+ = 
+i
+->
+i_mtu
+;
+
+1840 #ifde
+INET6
+
+
+1841 i(
+6_e
+)
+
+1842 
+	`nd6_tmtu
+(
+i
+);
+
+1844  
+ENETRESET
+;
+
+1846  
+ENOTTY
+;
+
+1849 
+	}
+}
+
+1852 
+	$iddf_iol
+(
+sock
+ *
+so
+, 
+u_lg
+ 
+cmd
+, *
+da
+, 
+i
+ *
+i
+)
+
+1854 
+if_addeq
+ *
+ip
+ = (if_addeq *)
+da
+;
+
+1855 
+iddr
+ *
+i
+;
+
+1856 c 
+sockaddr
+ *
+y
+, *
+
+;
+
+1858 
+sockaddr
+ 
+
+;
+
+1859 
+sockaddr_age
+ 
+ss
+;
+
+1860 } 
+u
+, 
+v
+;
+
+1862 
+cmd
+) {
+
+1863 
+SIOCSIFADDRPREF
+:
+
+1864 i(
+	`kauth_authize_twk
+(
+cuwp
+->
+l_ed
+, 
+KAUTH_NETWORK_INTERFACE
+,
+
+1865 
+KAUTH_REQ_NETWORK_INTERFACE_SETPRIV
+, 
+i
+, (*)
+cmd
+,
+
+1866 
+NULL
+) != 0)
+
+1867  
+EPERM
+;
+
+1868 
+SIOCGIFADDRPREF
+:
+
+1871  
+EOPNOTSUPP
+;
+
+1875 i(
+da
+ =
+NULL
+ || 
+i
+ == NULL) {
+
+1876 
+	`nic
+("vidrgumt%s", 
+__func__
+);
+
+1881 
+
+ = 
+	`soc
+(&
+ip
+->
+ip_addr
+);
+
+1882 i(
+
+->
+_my
+ !
+	`somy
+(
+so
+))
+
+1883  
+EINVAL
+;
+
+1884 i((
+y
+ = 
+	`sockaddr_y
+(
+
+)=
+NULL
+ || sa->
+_n
+ !=ny->sa_len)
+
+1885  
+EINVAL
+;
+
+1887 
+	`sockaddr_exize
+(&
+v
+.
+
+, (v.
+ss
+), sa);
+
+1889 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+) {
+
+1890 i(
+i
+->
+i_addr
+->
+_my
+ !
+
+->sa_family)
+
+1892 
+	`sockaddr_exize
+(&
+u
+.
+
+, (u.
+ss
+), 
+i
+->
+i_addr
+);
+
+1893 i(
+	`sockaddr_cmp
+(&
+u
+.
+
+, &
+v
+.sa) == 0)
+
+1896 i(
+i
+ =
+NULL
+)
+
+1897  
+EADDRNOTAVAIL
+;
+
+1899 
+cmd
+) {
+
+1900 
+SIOCSIFADDRPREF
+:
+
+1901 
+i
+->
+i_en
+ = 
+ip
+->
+ip_en
+;
+
+1903 
+SIOCGIFADDRPREF
+:
+
+1905 ()
+	`sockaddr_cy
+(
+	`so
+(&
+ip
+->
+ip_addr
+),
+
+1906 (
+ip
+->
+ip_addr
+), 
+i
+->
+i_addr
+);
+
+1907 
+ip
+->
+ip_en
+ = 
+i
+->
+i_en
+;
+
+1910  
+EOPNOTSUPP
+;
+
+1912 
+	}
+}
+
+1915 
+	$i_lock_r
+(
+i_lock
+ *
+
+)
+
+1917 
+ut64_t
+ *
+
+;
+
+1924 
+
+ = 
+	`ru_gf
+(
+
+->
+_
+);
+
+1925 (*
+
+)++;
+
+1926 
+	`ru_puef
+(
+
+->
+_
+);
+
+1927 
+	`mux_r
+(&
+
+->
+_lock
+);
+
+1928 
+	}
+}
+
+1931 
+	$i_lock_ex
+(
+i_lock
+ *
+
+)
+
+1936 
+
+->
+_x
+++;
+
+1937 
+	`mux_ex
+(&
+
+->
+_lock
+);
+
+1938 
+	}
+}
+
+1944 
+	$doifiol
+(
+sock
+ *
+so
+, 
+u_lg
+ 
+cmd
+, *
+da
+, 
+lwp
+ *
+l
+)
+
+1946 
+i
+ *
+i
+;
+
+1947 
+ieq
+ *
+i
+;
+
+1948 
+r
+ = 0;
+
+1949 #i
+	`defed
+(
+COMPAT_OSOCK
+|| defed(
+COMPAT_OIFREQ
+)
+
+1950 
+u_lg
+ 
+ocmd
+ = 
+cmd
+;
+
+1952 
+oif_ags
+;
+
+1953 #ifde
+COMPAT_OIFREQ
+
+
+1954 
+ieq
+ 
+ib
+;
+
+1955 
+oieq
+ *
+oi
+ = 
+NULL
+;
+
+1957 
+r
+;
+
+1959 
+cmd
+) {
+
+1960 #ifde
+COMPAT_OIFREQ
+
+
+1961 
+OSIOCGIFCONF
+:
+
+1962 
+OOSIOCGIFCONF
+:
+
+1963  
+	`comt_ifcf
+(
+cmd
+, 
+da
+);
+
+1965 #ifde
+COMPAT_OIFDATA
+
+
+1966 
+OSIOCGIFDATA
+:
+
+1967 
+OSIOCZIFDATA
+:
+
+1968  
+	`comt_ifdeq
+(
+l
+, 
+cmd
+, 
+da
+);
+
+1970 
+SIOCGIFCONF
+:
+
+1971  
+	`ifcf
+(
+cmd
+, 
+da
+);
+
+1972 
+SIOCINITIFADDR
+:
+
+1973  
+EPERM
+;
+
+1976 #ifde
+COMPAT_OIFREQ
+
+
+1977 
+cmd
+ = 
+	`comt_cvtcmd
+(cmd);
+
+1978 i(
+cmd
+ !
+ocmd
+) {
+
+1979 
+oi
+ = 
+da
+;
+
+1980 
+da
+ = 
+i
+ = &
+ib
+;
+
+1981 
+	`ieqo2n
+(
+oi
+, 
+i
+);
+
+1984 
+i
+ = 
+da
+;
+
+1986 
+i
+ = 
+	`ifun
+(
+i
+->
+i_me
+);
+
+1988 
+cmd
+) {
+
+1989 
+SIOCIFCREATE
+:
+
+1990 
+SIOCIFDESTROY
+:
+
+1991 i(
+l
+ !
+NULL
+) {
+
+1992 
+r
+ = 
+	`kauth_authize_twk
+(
+l
+->
+l_ed
+,
+
+1993 
+KAUTH_NETWORK_INTERFACE
+,
+
+1994 
+KAUTH_REQ_NETWORK_INTERFACE_SETPRIV
+, 
+i
+,
+
+1995 (*)
+cmd
+, 
+NULL
+);
+
+1996 i(
+r
+ != 0)
+
+1997  
+r
+;
+
+1999 
+	`mux_r
+(&
+if_e_mtx
+);
+
+2000 
+r
+ = (
+cmd
+ =
+SIOCIFCREATE
+) ?
+
+2001 
+	`if_e_
+(
+i
+->
+i_me
+) :
+
+2002 
+	`if_e_deroy
+(
+i
+->
+i_me
+);
+
+2003 
+	`mux_ex
+(&
+if_e_mtx
+);
+
+2004  
+r
+;
+
+2006 
+SIOCIFGCLONERS
+:
+
+2008 
+if_eq
+ *
+q
+ = (if_eq *)
+da
+;
+
+2009  
+	`if_e_li
+(
+q
+->
+if_cou
+,eq->
+if_bufr
+,
+
+2010 &
+q
+->
+if_t
+);
+
+2014 i(
+i
+ =
+NULL
+)
+
+2015  
+ENXIO
+;
+
+2017 
+cmd
+) {
+
+2018 
+SIOCALIFADDR
+:
+
+2019 
+SIOCDLIFADDR
+:
+
+2020 
+SIOCSIFADDRPREF
+:
+
+2021 
+SIOCSIFFLAGS
+:
+
+2022 
+SIOCSIFCAP
+:
+
+2023 
+SIOCSIFMETRIC
+:
+
+2024 
+SIOCZIFDATA
+:
+
+2025 
+SIOCSIFMTU
+:
+
+2026 
+SIOCSIFPHYADDR
+:
+
+2027 
+SIOCDIFPHYADDR
+:
+
+2028 #ifde
+INET6
+
+
+2029 
+SIOCSIFPHYADDR_IN6
+:
+
+2031 
+SIOCSLIFPHYADDR
+:
+
+2032 
+SIOCADDMULTI
+:
+
+2033 
+SIOCDELMULTI
+:
+
+2034 
+SIOCSIFMEDIA
+:
+
+2035 
+SIOCSDRVSPEC
+:
+
+2036 
+SIOCG80211
+:
+
+2037 
+SIOCS80211
+:
+
+2038 
+SIOCS80211NWID
+:
+
+2039 
+SIOCS80211NWKEY
+:
+
+2040 
+SIOCS80211POWER
+:
+
+2041 
+SIOCS80211BSSID
+:
+
+2042 
+SIOCS80211CHANNEL
+:
+
+2043 
+SIOCSLINKSTR
+:
+
+2044 i(
+l
+ !
+NULL
+) {
+
+2045 
+r
+ = 
+	`kauth_authize_twk
+(
+l
+->
+l_ed
+,
+
+2046 
+KAUTH_NETWORK_INTERFACE
+,
+
+2047 
+KAUTH_REQ_NETWORK_INTERFACE_SETPRIV
+, 
+i
+,
+
+2048 (*)
+cmd
+, 
+NULL
+);
+
+2049 i(
+r
+ != 0)
+
+2050  
+r
+;
+
+2054 
+oif_ags
+ = 
+i
+->
+if_ags
+;
+
+2056 
+	`i_lock_r
+(
+i
+->
+if_iol_lock
+);
+
+2057 
+r
+ = (*
+i
+->
+if_iol
+)(i, 
+cmd
+, 
+da
+);
+
+2058 i(
+r
+ !
+ENOTTY
+)
+
+2060 i(
+so
+->
+so_o
+ =
+NULL
+)
+
+2061 
+r
+ = 
+EOPNOTSUPP
+;
+
+2063 #ifde
+COMPAT_OSOCK
+
+
+2064 
+r
+ = 
+	`comt_ifiol
+(
+so
+, 
+ocmd
+, 
+cmd
+, 
+da
+, 
+l
+);
+
+2066 
+r
+ = (*
+so
+->
+so_o
+->
+_uqs
+->
+_iol
+)(so,
+
+2067 
+cmd
+, 
+da
+, 
+i
+);
+
+2071 i(((
+oif_ags
+ ^ 
+i
+->
+if_ags
+& 
+IFF_UP
+) != 0) {
+
+2072 i((
+i
+->
+if_ags
+ & 
+IFF_UP
+) != 0) {
+
+2073 
+s
+ = 
+	`
+();
+
+2074 
+	`if_up
+(
+i
+);
+
+2075 
+	`lx
+(
+s
+);
+
+2078 #ifde
+COMPAT_OIFREQ
+
+
+2079 i(
+cmd
+ !
+ocmd
+)
+
+2080 
+	`ieqn2o
+(
+oi
+, 
+i
+);
+
+2083 
+	`i_lock_ex
+(
+i
+->
+if_iol_lock
+);
+
+2084  
+r
+;
+
+2085 
+	}
+}
+
+2092 
+	$i_lock_sum
+(*
+p
+, *
+g
+, 
+u_fo
+ *
+ci
+)
+
+2094 
+ut64_t
+ *
+sum
+ = 
+g
+, *
+
+ = 
+p
+;
+
+2096 *
+sum
+ +*
+
+;
+
+2097 
+	}
+}
+
+2102 
+ut64_t
+
+
+2103 
+	$i_lock_s
+(
+i_lock
+ *
+
+)
+
+2105 
+ut64_t
+ 
+sum
+ = 0;
+
+2107 
+	`ru_fch
+(
+
+->
+_
+, 
+i_lock_sum
+, &
+sum
+);
+
+2109  
+sum
+;
+
+2110 
+	}
+}
+
+2113 
+	$ifiol_ch
+(
+i
+ *
+i
+)
+
+2115 
+i_lock
+ *
+
+;
+
+2120 i(
+i
+->
+if_iol
+ =
+NULL
+)
+
+2121 
+i
+->
+if_iol
+ = 
+ifiol_comm
+;
+
+2124 i((
+
+ = 
+	`kmem_zloc
+((*), 
+KM_SLEEP
+)=
+NULL
+)
+
+2125  
+ENOMEM
+;
+
+2127 
+
+->
+_
+ = 
+	`ru_loc
+((
+ut64_t
+));
+
+2128 i(
+
+->
+_
+ =
+NULL
+) {
+
+2129 
+	`kmem_
+(
+
+, (*il));
+
+2130  
+ENOMEM
+;
+
+2133 
+	`mux_
+(&
+
+->
+_lock
+, 
+MUTEX_DEFAULT
+, 
+IPL_NONE
+);
+
+2134 
+	`cv_
+(&
+
+->
+_emd
+, 
+i
+->
+if_xme
+);
+
+2136 
+i
+->
+if_iol_lock
+ = 
+
+;
+
+2139 
+	}
+}
+
+2147 
+	$ifiol_dach
+(
+i
+ *
+i
+)
+
+2149 
+i_lock
+ *
+
+;
+
+2151 
+
+ = 
+i
+->
+if_iol_lock
+;
+
+2152 
+	`mux_r
+(&
+
+->
+_lock
+);
+
+2158 
+i
+->
+if_iol
+ = 
+if_nuiol
+;
+
+2162 
+	`i_lock_s
+(
+
+!->
+_x
+)
+
+2163 
+	`cv_wa
+(&
+
+->
+_emd
+, &->
+_lock
+);
+
+2168 
+	`mux_ex
+(&
+
+->
+_lock
+);
+
+2169 
+i
+->
+if_iol_lock
+ = 
+NULL
+;
+
+2170 
+	`ru_
+(
+
+->
+_
+, (
+ut64_t
+));
+
+2171 
+
+->
+_
+ = 
+NULL
+;
+
+2172 
+	`cv_deroy
+(&
+
+->
+_emd
+);
+
+2173 
+	`mux_deroy
+(&
+
+->
+_lock
+);
+
+2174 
+	`kmem_
+(
+
+, (*il));
+
+2175 
+	}
+}
+
+2207 
+	$ifcf
+(
+u_lg
+ 
+cmd
+, *
+da
+)
+
+2209 
+ifcf
+ *
+ifc
+ = (ifc*)
+da
+;
+
+2210 
+i
+ *
+i
+;
+
+2211 
+iddr
+ *
+i
+;
+
+2212 
+ieq
+ 
+i
+, *
+ip
+ = 
+NULL
+;
+
+2213 
+a
+ = 0, 
+r
+ = 0;
+
+2214 c 
+sz
+ = ()(
+ieq
+);
+
+2215 c 
+bo
+ 
+docy
+ = 
+ifc
+->
+ifc_q
+ !
+NULL
+;
+
+2217 i(
+docy
+) {
+
+2218 
+a
+ = 
+ifc
+->
+ifc_n
+;
+
+2219 
+ip
+ = 
+ifc
+->
+ifc_q
+;
+
+2222 
+	`IFNET_FOREACH
+(
+i
+) {
+
+2223 ()
+	`y
+(
+i
+.
+i_me
+, 
+i
+->
+if_xme
+,
+
+2224 (
+i
+.
+i_me
+));
+
+2225 i(
+i
+.
+i_me
+[(ifr.ifr_name) - 1] != '\0')
+
+2226  
+ENAMETOOLONG
+;
+
+2227 i(
+	`IFADDR_EMPTY
+(
+i
+)) {
+
+2229 
+	`memt
+(&
+i
+.
+i_addr
+, 0, (ifr.ifr_addr));
+
+2230 i(!
+docy
+) {
+
+2231 
+a
+ +
+sz
+;
+
+2234 i(
+a
+ >
+sz
+) {
+
+2235 
+r
+ = 
+	`cyout
+(&
+i
+, 
+ip
+, 
+sz
+);
+
+2236 i(
+r
+ != 0)
+
+2237  
+r
+;
+
+2238 
+ip
+++;
+
+2239 
+a
+ -
+sz
+;
+
+2243 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+) {
+
+2244 
+sockaddr
+ *
+
+ = 
+i
+->
+i_addr
+;
+
+2246 
+	`KASSERT
+(
+
+->
+_n
+ <(
+i
+.
+i_iu
+));
+
+2248 i(!
+docy
+) {
+
+2249 
+a
+ +
+sz
+;
+
+2252 
+	`memy
+(&
+i
+.
+i_a
+, 
+
+, sa->
+_n
+);
+
+2253 i(
+a
+ >
+sz
+) {
+
+2254 
+r
+ = 
+	`cyout
+(&
+i
+, 
+ip
+, 
+sz
+);
+
+2255 i(
+r
+ != 0)
+
+2256  (
+r
+);
+
+2257 
+ip
+++; 
+a
+ -
+sz
+;
+
+2261 i(
+docy
+) {
+
+2262 
+	`KASSERT
+(0 <
+a
+ && s <
+ifc
+->
+ifc_n
+);
+
+2263 
+ifc
+->
+ifc_n
+ -
+a
+;
+
+2265 
+	`KASSERT
+(
+a
+ >= 0);
+
+2266 
+ifc
+->
+ifc_n
+ = 
+a
+;
+
+2269 
+	}
+}
+
+2272 
+	$ieq_ddr
+(
+u_lg
+ 
+cmd
+, 
+ieq
+ *
+i
+, c 
+sockaddr
+ *
+
+)
+
+2274 
+ut8_t
+ 
+n
+;
+
+2275 #ifde
+COMPAT_OIFREQ
+
+
+2276 
+ieq
+ 
+ib
+;
+
+2277 
+oieq
+ *
+oi
+ = 
+NULL
+;
+
+2278 
+u_lg
+ 
+ocmd
+ = 
+cmd
+;
+
+2279 
+cmd
+ = 
+	`comt_cvtcmd
+(cmd);
+
+2280 i(
+cmd
+ !
+ocmd
+) {
+
+2281 
+oi
+ = (
+oieq
+ *)(*)
+i
+;
+
+2282 
+i
+ = &
+ib
+;
+
+2283 
+	`ieqo2n
+(
+oi
+, 
+i
+);
+
+2284 
+n
+ = (
+oi
+->
+i_addr
+);
+
+2287 
+n
+ = (
+i
+->
+i_iu
+.
+iu_a
+);
+
+2289 i(
+n
+ < 
+
+->
+_n
+)
+
+2290  
+EFBIG
+;
+
+2292 
+	`memt
+(&
+i
+->
+i_addr
+, 0, 
+n
+);
+
+2293 
+	`sockaddr_cy
+(&
+i
+->
+i_addr
+, 
+n
+, 
+
+);
+
+2295 #ifde
+COMPAT_OIFREQ
+
+
+2296 i(
+cmd
+ !
+ocmd
+)
+
+2297 
+	`ieqn2o
+(
+oi
+, 
+i
+);
+
+2300 
+	}
+}
+
+2307 
+ifq_queue
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+
+
+2308 
+ALTQ_COMMA
+ 
+	$ALTQ_DECL
+(
+tq_pkr
+ *
+pkr
+))
+
+2310 
+n
+ = 
+m
+->
+m_pkthdr
+.len;
+
+2311 
+mags
+ = 
+m
+->
+m_ags
+;
+
+2312 
+s
+ = 
+	`
+();
+
+2313 
+r
+;
+
+2315 
+	`IFQ_ENQUEUE
+(&
+i
+->
+if_d
+, 
+m
+, 
+pkr
+, 
+r
+);
+
+2316 i(
+r
+ != 0)
+
+2317 
+out
+;
+
+2318 
+i
+->
+if_obys
+ +
+n
+;
+
+2319 i(
+mags
+ & 
+M_MCAST
+)
+
+2320 
+i
+->
+if_oms
+++;
+
+2321 i((
+i
+->
+if_ags
+ & 
+IFF_OACTIVE
+) == 0)
+
+2322 (*
+i
+->
+if_t
+)(ifp);
+
+2323 
+out
+:
+
+2324 
+	`lx
+(
+s
+);
+
+2325  
+r
+;
+
+2326 
+	}
+}
+
+2332 
+ifq_queue2
+(
+i
+ *
+i
+, 
+ifqueue
+ *
+ifq
+, 
+mbuf
+ *
+m
+
+
+2333 
+ALTQ_COMMA
+ 
+	$ALTQ_DECL
+(
+tq_pkr
+ *
+pkr
+))
+
+2335 
+r
+ = 0;
+
+2337 i(
+ifq
+ !
+NULL
+
+
+2338 #ifde
+ALTQ
+
+
+2339 && 
+	`ALTQ_IS_ENABLED
+(&
+i
+->
+if_d
+) == 0
+
+2342 i(
+	`IF_QFULL
+(
+ifq
+)) {
+
+2343 
+	`IF_DROP
+(&
+i
+->
+if_d
+);
+
+2344 
+	`m_m
+(
+m
+);
+
+2345 i(
+r
+ == 0)
+
+2346 
+r
+ = 
+ENOBUFS
+;
+
+2348 
+	`IF_ENQUEUE
+(
+ifq
+, 
+m
+);
+
+2350 
+	`IFQ_ENQUEUE
+(&
+i
+->
+if_d
+, 
+m
+, 
+pkr
+, 
+r
+);
+
+2351 i(
+r
+ != 0) {
+
+2352 ++
+i
+->
+if_s
+;
+
+2353  
+r
+;
+
+2356 
+	}
+}
+
+2359 
+	$if_addr_
+(
+i_t
+ *
+i
+, 
+iddr
+ *
+i
+, c 
+bo
+ 
+c
+)
+
+2361 
+rc
+;
+
+2363 i(
+i
+->
+if_addr
+ !
+NULL
+)
+
+2364 
+rc
+ = (*
+i
+->
+if_addr
+)(i, 
+i
+, 
+c
+);
+
+2365 i(
+c
+ ||
+
+2366 (
+rc
+ = (*
+i
+->
+if_iol
+)(i, 
+SIOCSIFDSTADDR
+, 
+i
+)=
+ENOTTY
+)
+
+2367 
+rc
+ = (*
+i
+->
+if_iol
+)(i, 
+SIOCINITIFADDR
+, 
+i
+);
+
+2369  
+rc
+;
+
+2370 
+	}
+}
+
+2373 
+	$if_do_dad
+(
+i
+ *
+i
+)
+
+2375 i((
+i
+->
+if_ags
+ & 
+IFF_LOOPBACK
+) != 0)
+
+2378 
+i
+->
+if_ty
+) {
+
+2379 
+IFT_FAITH
+:
+
+2397 i((
+i
+->
+if_ags
+ & (
+IFF_UP
+|
+IFF_RUNNING
+)) !=
+
+2398 (
+IFF_UP
+|
+IFF_RUNNING
+))
+
+2403 
+	}
+}
+
+2406 
+	$if_ags_t
+(
+i_t
+ *
+i
+, c 
+ags
+)
+
+2408 
+rc
+;
+
+2410 i(
+i
+->
+if_tags
+ !
+NULL
+)
+
+2411 
+rc
+ = (*
+i
+->
+if_tags
+)(i, 
+ags
+);
+
+2413 
+ags
+, 
+chgdags
+;
+
+2414 
+ieq
+ 
+i
+;
+
+2416 
+chgdags
+ = 
+i
+->
+if_ags
+ ^ 
+ags
+;
+
+2417 
+ags
+ = 
+chgdags
+ & 
+IFF_CANTCHANGE
+;
+
+2419 i(
+ags
+ != 0)
+
+2420 
+i
+->
+if_ags
+ ^
+ags
+;
+
+2426 i(
+chgdags
+ =
+IFF_PROMISC
+ && (
+i
+->
+if_ags
+ & 
+IFF_UP
+) == 0)
+
+2429 
+	`memt
+(&
+i
+, 0, (ifr));
+
+2431 
+i
+.
+i_ags
+ = 
+ags
+ & ~
+IFF_CANTCHANGE
+;
+
+2432 
+rc
+ = (*
+i
+->
+if_iol
+)(i, 
+SIOCSIFFLAGS
+, &
+i
+);
+
+2434 i(
+rc
+ !0 && 
+ags
+ != 0)
+
+2435 
+i
+->
+if_ags
+ ^
+ags
+;
+
+2438  
+rc
+;
+
+2439 
+	}
+}
+
+2442 
+	$if_m_
+(
+i_t
+ *
+i
+, c 
+cmd
+, c 
+sockaddr
+ *
+
+)
+
+2444 
+rc
+;
+
+2445 
+ieq
+ 
+i
+;
+
+2447 i(
+i
+->
+if_m
+ !
+NULL
+)
+
+2448 
+rc
+ = (*
+i
+->
+if_m
+)(i, 
+cmd
+, 
+
+);
+
+2450 
+	`ieq_ddr
+(
+cmd
+, &
+i
+, 
+
+);
+
+2451 
+rc
+ = (*
+i
+->
+if_iol
+)(i, 
+cmd
+, &
+i
+);
+
+2454  
+rc
+;
+
+2455 
+	}
+}
+
+2458 
+	$sysl_dq_tup
+(
+sysog
+ **
+og
+, c *
+iame
+,
+
+2459 
+iq
+ *
+ifq
+)
+
+2461 c 
+sysode
+ *
+ode
+, *
+ode
+;
+
+2463 i(
+	`sysl_v
+(
+og
+, 0, 
+NULL
+, &
+ode
+,
+
+2464 
+CTLFLAG_PERMANENT
+,
+
+2465 
+CTLTYPE_NODE
+, "interfaces",
+
+2466 
+	`SYSCTL_DESCR
+("Per-interface controls"),
+
+2467 
+NULL
+, 0, NULL, 0,
+
+2468 
+CTL_NET
+, 
+CTL_CREATE
+, 
+CTL_EOL
+) != 0)
+
+2469 
+bad
+;
+
+2471 i(
+	`sysl_v
+(
+og
+, 0, &
+ode
+, &rnode,
+
+2472 
+CTLFLAG_PERMANENT
+,
+
+2473 
+CTLTYPE_NODE
+, 
+iame
+,
+
+2474 
+	`SYSCTL_DESCR
+("Interface controls"),
+
+2475 
+NULL
+, 0, NULL, 0,
+
+2476 
+CTL_CREATE
+, 
+CTL_EOL
+) != 0)
+
+2477 
+bad
+;
+
+2479 i(
+	`sysl_v
+(
+og
+, 0, &
+ode
+, &rnode,
+
+2480 
+CTLFLAG_PERMANENT
+,
+
+2481 
+CTLTYPE_NODE
+, "sndq",
+
+2482 
+	`SYSCTL_DESCR
+("Interface output queue controls"),
+
+2483 
+NULL
+, 0, NULL, 0,
+
+2484 
+CTL_CREATE
+, 
+CTL_EOL
+) != 0)
+
+2485 
+bad
+;
+
+2487 i(
+	`sysl_v
+(
+og
+, 0, &
+ode
+, &
+ode
+,
+
+2488 
+CTLFLAG_PERMANENT
+,
+
+2489 
+CTLTYPE_INT
+, "len",
+
+2490 
+	`SYSCTL_DESCR
+("Current output queueength"),
+
+2491 
+NULL
+, 0, &
+ifq
+->
+ifq_n
+, 0,
+
+2492 
+CTL_CREATE
+, 
+CTL_EOL
+) != 0)
+
+2493 
+bad
+;
+
+2495 i(
+	`sysl_v
+(
+og
+, 0, &
+ode
+, &
+ode
+,
+
+2496 
+CTLFLAG_PERMANENT
+|
+CTLFLAG_READWRITE
+,
+
+2497 
+CTLTYPE_INT
+, "maxlen",
+
+2498 
+	`SYSCTL_DESCR
+("Maximumllowed output queueength"),
+
+2499 
+NULL
+, 0, &
+ifq
+->
+ifq_maxn
+, 0,
+
+2500 
+CTL_CREATE
+, 
+CTL_EOL
+) != 0)
+
+2501 
+bad
+;
+
+2503 i(
+	`sysl_v
+(
+og
+, 0, &
+ode
+, &
+ode
+,
+
+2504 
+CTLFLAG_PERMANENT
+,
+
+2505 
+CTLTYPE_INT
+, "drops",
+
+2506 
+	`SYSCTL_DESCR
+("Packets dropped dueo full output queue"),
+
+2507 
+NULL
+, 0, &
+ifq
+->
+ifq_drs
+, 0,
+
+2508 
+CTL_CREATE
+, 
+CTL_EOL
+) != 0)
+
+2509 
+bad
+;
+
+2512 
+bad
+:
+
+2513 
+	`tf
+("%s: couldach sysnodes\n", 
+iame
+);
+
+2515 
+	}
+}
+
+2517 #i
+defed
+(
+INET
+|| defed(
+INET6
+)
+
+2519 
+	#SYSCTL_NET_PKTQ
+(
+q
+, 
+
+, 
+c
+) \
+
+2521 
+sysl_t_
+##
+q
+##
+_
+##
+	`
+(
+SYSCTLFN_ARGS
+) \
+
+2523  
+	`sysl_pktq_cou
+(
+	`SYSCTLFN_CALL
+(
+ode
+), 
+q
+, 
+c
+); \
+
+2524 }
+
+	)
+
+2526 #i
+defed
+(
+INET
+)
+
+2528 
+	$sysl_t__pktq_maxn
+(
+SYSCTLFN_ARGS
+)
+
+2530  
+	`sysl_pktq_maxn
+(
+	`SYSCTLFN_CALL
+(
+ode
+), 
+_pktq
+);
+
+2531 
+	}
+}
+
+2532 
+	$SYSCTL_NET_PKTQ
+(
+_pktq
+, 
+ems
+, 
+PKTQ_NITEMS
+)
+
+2533 
+	$SYSCTL_NET_PKTQ
+(
+_pktq
+, 
+drs
+, 
+PKTQ_DROPS
+)
+
+2536 #i
+	`defed
+(
+INET6
+)
+
+2538 
+	$sysl_t_6_pktq_maxn
+(
+SYSCTLFN_ARGS
+)
+
+2540  
+	`sysl_pktq_maxn
+(
+	`SYSCTLFN_CALL
+(
+ode
+), 
+6_pktq
+);
+
+2541 
+	}
+}
+
+2542 
+	$SYSCTL_NET_PKTQ
+(
+6_pktq
+, 
+ems
+, 
+PKTQ_NITEMS
+)
+
+2543 
+	$SYSCTL_NET_PKTQ
+(
+6_pktq
+, 
+drs
+, 
+PKTQ_DROPS
+)
+
+2547 
+	$sysl_t_pktq_tup
+(
+sysog
+ **
+og
+, 
+pf
+)
+
+2549 
+sysl
+ 
+n_func
+ = 
+NULL
+, 
+maxn_func
+ = NULL, 
+drs_func
+ = NULL;
+
+2550 c *
+pame
+ = 
+NULL
+, *
+me
+ = NULL;
+
+2551 
+n
+ = 0, 
+qid
+ = 0;
+
+2553 
+pf
+) {
+
+2554 #i
+	`defed
+(
+INET
+)
+
+2555 
+PF_INET
+:
+
+2556 
+n_func
+ = 
+sysl_t__pktq_ems
+;
+
+2557 
+maxn_func
+ = 
+sysl_t__pktq_maxn
+;
+
+2558 
+drs_func
+ = 
+sysl_t__pktq_drs
+;
+
+2559 
+pame
+ = "", 
+n
+ = 
+IPPROTO_IP
+;
+
+2560 
+me
+ = "", 
+qid
+ = 
+IPCTL_IFQ
+;
+
+2563 #i
+	`defed
+(
+INET6
+)
+
+2564 
+PF_INET6
+:
+
+2565 
+n_func
+ = 
+sysl_t_6_pktq_ems
+;
+
+2566 
+maxn_func
+ = 
+sysl_t_6_pktq_maxn
+;
+
+2567 
+drs_func
+ = 
+sysl_t_6_pktq_drs
+;
+
+2568 
+pame
+ = "6", 
+n
+ = 
+IPPROTO_IPV6
+;
+
+2569 
+me
+ = "6", 
+qid
+ = 
+IPV6CTL_IFQ
+;
+
+2573 
+	`KASSERT
+(
+l
+);
+
+2576 
+	`sysl_v
+(
+og
+, 0, 
+NULL
+, NULL,
+
+2577 
+CTLFLAG_PERMANENT
+,
+
+2578 
+CTLTYPE_NODE
+, 
+pame
+, 
+NULL
+,
+
+2579 
+NULL
+, 0, NULL, 0,
+
+2580 
+CTL_NET
+, 
+pf
+, 
+CTL_EOL
+);
+
+2581 
+	`sysl_v
+(
+og
+, 0, 
+NULL
+, NULL,
+
+2582 
+CTLFLAG_PERMANENT
+,
+
+2583 
+CTLTYPE_NODE
+, 
+me
+, 
+NULL
+,
+
+2584 
+NULL
+, 0, NULL, 0,
+
+2585 
+CTL_NET
+, 
+pf
+, 
+n
+, 
+CTL_EOL
+);
+
+2586 
+	`sysl_v
+(
+og
+, 0, 
+NULL
+, NULL,
+
+2587 
+CTLFLAG_PERMANENT
+,
+
+2588 
+CTLTYPE_NODE
+, "ifq",
+
+2589 
+	`SYSCTL_DESCR
+("Protocol input queue controls"),
+
+2590 
+NULL
+, 0, NULL, 0,
+
+2591 
+CTL_NET
+, 
+pf
+, 
+n
+, 
+qid
+, 
+CTL_EOL
+);
+
+2593 
+	`sysl_v
+(
+og
+, 0, 
+NULL
+, NULL,
+
+2594 
+CTLFLAG_PERMANENT
+,
+
+2595 
+CTLTYPE_INT
+, "len",
+
+2596 
+	`SYSCTL_DESCR
+("Current input queueength"),
+
+2597 
+n_func
+, 0, 
+NULL
+, 0,
+
+2598 
+CTL_NET
+, 
+pf
+, 
+n
+, 
+qid
+, 
+IFQCTL_LEN
+, 
+CTL_EOL
+);
+
+2599 
+	`sysl_v
+(
+og
+, 0, 
+NULL
+, NULL,
+
+2600 
+CTLFLAG_PERMANENT
+|
+CTLFLAG_READWRITE
+,
+
+2601 
+CTLTYPE_INT
+, "maxlen",
+
+2602 
+	`SYSCTL_DESCR
+("Maximumllowed input queueength"),
+
+2603 
+maxn_func
+, 0, 
+NULL
+, 0,
+
+2604 
+CTL_NET
+, 
+pf
+, 
+n
+, 
+qid
+, 
+IFQCTL_MAXLEN
+, 
+CTL_EOL
+);
+
+2605 
+	`sysl_v
+(
+og
+, 0, 
+NULL
+, NULL,
+
+2606 
+CTLFLAG_PERMANENT
+,
+
+2607 
+CTLTYPE_INT
+, "drops",
+
+2608 
+	`SYSCTL_DESCR
+("Packets dropped dueo full input queue"),
+
+2609 
+drs_func
+, 0, 
+NULL
+, 0,
+
+2610 
+CTL_NET
+, 
+pf
+, 
+n
+, 
+qid
+, 
+IFQCTL_DROPS
+, 
+CTL_EOL
+);
+
+2611 
+	}
+}
+
+2615 
+	$if_sdl_sysl
+(
+SYSCTLFN_ARGS
+)
+
+2617 
+i
+ *
+i
+;
+
+2618 c 
+sockaddr_dl
+ *
+sdl
+;
+
+2620 i(
+m
+ != 1)
+
+2621  
+EINVAL
+;
+
+2623 
+i
+ = 
+	`if_bydex
+(
+me
+[0]);
+
+2624 i(
+i
+ =
+NULL
+)
+
+2625  
+ENODEV
+;
+
+2627 
+sdl
+ = 
+i
+->
+if_dl
+;
+
+2628 i(
+sdl
+ =
+NULL
+) {
+
+2629 *
+d
+ = 0;
+
+2633 i(
+dp
+ =
+NULL
+) {
+
+2634 *
+d
+ = 
+sdl
+->
+sdl_
+;
+
+2638 i(*
+d
+ >
+sdl
+->
+sdl_
+)
+
+2639 *
+d
+ = 
+sdl
+->
+sdl_
+;
+
+2640  
+	`sysl_cyout
+(
+l
+, &
+sdl
+->
+sdl_da
+[sdl->
+sdl_
+], 
+dp
+, *
+d
+);
+
+2641 
+	}
+}
+
+2643 
+SYSCTL_SETUP
+(
+sysl_t_sdl_tup
+, "sysctlet.sdl subtree setup")
+
+2645 c 
+sysode
+ *
+	gode
+ = 
+NULL
+;
+
+2647 
+sysl_v
+(
+og
+, 0, 
+NULL
+, &
+ode
+,
+
+2648 
+CTLFLAG_PERMANENT
+,
+
+2649 
+CTLTYPE_NODE
+, "sdl",
+
+2650 
+SYSCTL_DESCR
+("Getctiveink-layerddress"),
+
+2651 
+if_sdl_sysl
+, 0, 
+NULL
+, 0,
+
+2652 
+CTL_NET
+, 
+CTL_CREATE
+, 
+CTL_EOL
+);
+
+	@if.h
+
+63 #ide
+_NET_IF_H_
+
+
+64 
+	#_NET_IF_H_
+
+
+	)
+
+66 #i!
+defed
+(
+_KERNEL
+&& !defed(
+_STANDALONE
+)
+
+67 
+	~<dbo.h
+>
+
+70 
+	~<sys/u.h
+>
+
+76 
+	#IF_NAMESIZE
+ 16
+
+	)
+
+78 #i
+defed
+(
+_NETBSD_SOURCE
+)
+
+80 
+	~<sys/sock.h
+>
+
+81 
+	~<sys/queue.h
+>
+
+82 
+	~<sys/mux.h
+>
+
+84 
+	~<t/d.h
+>
+
+85 
+	~<t/pf.h
+>
+
+86 #ifde
+_KERNEL
+
+
+87 
+	~<t/pktqueue.h
+>
+
+96 
+	~<tq/if_tq.h
+>
+
+122 
+	~<sys/time.h
+>
+
+124 #i
+defed
+(
+_KERNEL_OPT
+)
+
+125 
+	~"t_comt_tbsd.h
+"
+
+128 
+	gmbuf
+;
+
+129 
+	goc
+;
+
+130 
+	gy
+;
+
+131 
+	gsock
+;
+
+132 
+	gh_hd
+;
+
+133 
+	giddr
+;
+
+134 
+	gi
+;
+
+135 
+	g_addrfo
+;
+
+137 
+	#IFNAMSIZ
+ 
+IF_NAMESIZE
+
+
+	)
+
+142 
+	sif_e
+ {
+
+143 
+LIST_ENTRY
+(
+if_e
+
+	mifc_li
+;
+
+144 c *
+	mifc_me
+;
+
+145 
+size_t
+ 
+	mifc_m
+;
+
+147 (*
+	mifc_
+)(
+	mif_e
+ *, );
+
+148 (*
+	mifc_deroy
+)(
+	mi
+ *);
+
+151 
+	#IF_CLONE_INITIALIZER
+(
+me
+, 
+
+, 
+deroy
+) \
+
+152 { { 
+NULL
+, NULL }, 
+me
+, ame- 1, 
+
+, 
+deroy
+ }
+
+	)
+
+157 
+	sif_eq
+ {
+
+158 
+	mif_t
+;
+
+159 
+	mif_cou
+;
+
+160 *
+	mif_bufr
+;
+
+167 
+	sif_da
+ {
+
+169 
+u_ch
+ 
+	mifi_ty
+;
+
+170 
+u_ch
+ 
+	mifi_add
+;
+
+171 
+u_ch
+ 
+	mifi_hd
+;
+
+172 
+	mifi_lk_e
+;
+
+173 
+ut64_t
+ 
+	mifi_mtu
+;
+
+174 
+ut64_t
+ 
+	mifi_mric
+;
+
+175 
+ut64_t
+ 
+	mifi_baud
+;
+
+177 
+ut64_t
+ 
+	mifi_acks
+;
+
+178 
+ut64_t
+ 
+	mifi_s
+;
+
+179 
+ut64_t
+ 
+	mifi_acks
+;
+
+180 
+ut64_t
+ 
+	mifi_s
+;
+
+181 
+ut64_t
+ 
+	mifi_clisis
+;
+
+182 
+ut64_t
+ 
+	mifi_ibys
+;
+
+183 
+ut64_t
+ 
+	mifi_obys
+;
+
+184 
+ut64_t
+ 
+	mifi_ims
+;
+
+185 
+ut64_t
+ 
+	mifi_oms
+;
+
+186 
+ut64_t
+ 
+	mifi_iqdrs
+;
+
+187 
+ut64_t
+ 
+	mifi_nro
+;
+
+188 
+timeec
+ 
+	mifi_chge
+;
+
+194 
+	#LINK_STATE_UNKNOWN
+ 0
+
+	)
+
+195 
+	#LINK_STATE_DOWN
+ 1
+
+	)
+
+196 
+	#LINK_STATE_UP
+ 2
+
+	)
+
+201 
+	sifqueue
+ {
+
+202 
+mbuf
+ *
+	mifq_hd
+;
+
+203 
+mbuf
+ *
+	mifq_
+;
+
+204 
+	mifq_n
+;
+
+205 
+	mifq_maxn
+;
+
+206 
+	mifq_drs
+;
+
+207 
+kmux_t
+ *
+	mifq_lock
+;
+
+210 
+	gi_lock
+;
+
+212 #ifde
+_KERNEL
+
+
+213 
+	~<sys/cdv.h
+>
+
+214 
+	~<sys/ru.h
+>
+
+215 
+	~<sys/out.h
+>
+
+217 
+	si_lock
+ {
+
+218 
+kmux_t
+ 
+	m_lock
+;
+
+219 
+ut64_t
+ 
+	m_x
+;
+
+224 
+ru_t
+ *
+	m_
+;
+
+229 
+kcdv_t
+ 
+	m_emd
+;
+
+242 
+TAILQ_HEAD
+(
+i_hd
+, 
+i
+);
+
+244 
+	gbridge_soc
+;
+
+245 
+	gbridge_ii
+;
+
+246 
+	gout
+;
+
+248 
+	si
+ {
+
+249 *
+	mif_soc
+;
+
+250 
+TAILQ_ENTRY
+(
+i
+
+	mif_li
+;
+
+251 
+TAILQ_HEAD
+(, 
+iddr
+
+	mif_addi
+;
+
+252 
+	mif_xme
+[
+IFNAMSIZ
+];
+
+253 
+	mif_pcou
+;
+
+254 
+bpf_if
+ *
+	mif_bpf
+;
+
+255 
+u_sht
+ 
+	mif_dex
+;
+
+256 
+	mif_tim
+;
+
+257 
+	mif_ags
+;
+
+258 
+	mif__d1
+;
+
+259 
+if_da
+ 
+	mif_da
+;
+
+264 (*
+	mif_ouut
+)
+
+265 (
+	mi
+ *, 
+	mmbuf
+ *, c 
+	msockaddr
+ *,
+
+266 
+	my
+ *);
+
+267 (*
+	mif_put
+)
+
+268 (
+	mi
+ *, 
+	mmbuf
+ *);
+
+269 (*
+	mif_t
+)
+
+270 (
+	mi
+ *);
+
+271 (*
+	mif_iol
+)
+
+272 (
+	mi
+ *, 
+	mu_lg
+, *);
+
+273 (*
+	mif_
+)
+
+274 (
+	mi
+ *);
+
+275 (*
+	mif_
+)
+
+276 (
+	mi
+ *, );
+
+277 (*
+	mif_owtimo
+)
+
+278 (
+	mi
+ *);
+
+279 
+	#if_wchdog
+ 
+if_owtimo
+
+
+	)
+
+280 (*
+	mif_d
+)
+
+281 (
+	mi
+ *);
+
+282 
+iq
+ 
+	mif_d
+;
+
+283 
+iddr
+ *
+	mif_dl
+;
+
+284 c 
+sockaddr_dl
+ *
+	mif_dl
+;
+
+294 
+iddr
+ *
+	mif_hwdl
+;
+
+295 c 
+ut8_t
+ *
+	mif_brdaddr
+;
+
+296 
+bridge_soc
+ *
+	mif_bridge
+;
+
+297 
+bridge_ii
+ *
+	mif_bridgeif
+;
+
+298 
+	mif_d
+;
+
+299 
+pf_hd_t
+ * 
+	mif_pf
+;
+
+300 
+ut64_t
+ 
+	mif_bs
+;
+
+301 
+ut64_t
+ 
+	mif_b
+;
+
+303 * 
+	m_s
+;
+
+304 
+i
+ *
+	m_d
+;
+
+305 } 
+	mif__r
+;
+
+306 
+	#if_
+ 
+if__r
+.
+_s
+
+
+	)
+
+307 
+	#if_dev
+ 
+if__r
+.
+_d
+
+
+	)
+
+312 
+	mif_csum_ags_tx
+;
+
+313 
+	mif_csum_ags_rx
+;
+
+315 *
+	mif_afda
+[
+AF_MAX
+];
+
+316 
+mowr
+ *
+	mif_mowr
+;
+
+318 *
+	mif_agrive
+;
+
+323 *
+	mif_pf_kif
+;
+
+324 *
+	mif_pf_groups
+;
+
+334 
+ut64_t
+ 
+	mif_dex_g
+;
+
+339 
+sysog
+ *
+	mif_sysl_log
+;
+
+340 (*
+	mif_addr
+)(
+	mi
+ *, 
+	middr
+ *, 
+	mbo
+);
+
+341 (*
+	mif_m
+)(
+	mi
+ *, const ,
+
+342 c 
+	msockaddr
+ *);
+
+343 (*
+	mif_tags
+)(
+	mi
+ *, const );
+
+344 
+i_lock
+ *
+	mif_iol_lock
+;
+
+345 #ifde
+_KERNEL
+
+
+346 
+out
+ *
+	mif_owtimo_ch
+;
+
+348 } 
+	ti_t
+;
+
+350 
+	#if_mtu
+ 
+if_da
+.
+ifi_mtu
+
+
+	)
+
+351 
+	#if_ty
+ 
+if_da
+.
+ifi_ty
+
+
+	)
+
+352 
+	#if_add
+ 
+if_da
+.
+ifi_add
+
+
+	)
+
+353 
+	#if_hd
+ 
+if_da
+.
+ifi_hd
+
+
+	)
+
+354 
+	#if_mric
+ 
+if_da
+.
+ifi_mric
+
+
+	)
+
+355 
+	#if_lk_e
+ 
+if_da
+.
+ifi_lk_e
+
+
+	)
+
+356 
+	#if_baud
+ 
+if_da
+.
+ifi_baud
+
+
+	)
+
+357 
+	#if_acks
+ 
+if_da
+.
+ifi_acks
+
+
+	)
+
+358 
+	#if_s
+ 
+if_da
+.
+ifi_s
+
+
+	)
+
+359 
+	#if_acks
+ 
+if_da
+.
+ifi_acks
+
+
+	)
+
+360 
+	#if_s
+ 
+if_da
+.
+ifi_s
+
+
+	)
+
+361 
+	#if_clisis
+ 
+if_da
+.
+ifi_clisis
+
+
+	)
+
+362 
+	#if_ibys
+ 
+if_da
+.
+ifi_ibys
+
+
+	)
+
+363 
+	#if_obys
+ 
+if_da
+.
+ifi_obys
+
+
+	)
+
+364 
+	#if_ims
+ 
+if_da
+.
+ifi_ims
+
+
+	)
+
+365 
+	#if_oms
+ 
+if_da
+.
+ifi_oms
+
+
+	)
+
+366 
+	#if_iqdrs
+ 
+if_da
+.
+ifi_iqdrs
+
+
+	)
+
+367 
+	#if_nro
+ 
+if_da
+.
+ifi_nro
+
+
+	)
+
+368 
+	#if_chge
+ 
+if_da
+.
+ifi_chge
+
+
+	)
+
+370 
+	#IFF_UP
+ 0x0001
+
+	)
+
+371 
+	#IFF_BROADCAST
+ 0x0002
+
+	)
+
+372 
+	#IFF_DEBUG
+ 0x0004
+
+	)
+
+373 
+	#IFF_LOOPBACK
+ 0x0008
+
+	)
+
+374 
+	#IFF_POINTOPOINT
+ 0x0010
+
+	)
+
+375 
+	#IFF_NOTRAILERS
+ 0x0020
+
+	)
+
+376 
+	#IFF_RUNNING
+ 0x0040
+
+	)
+
+377 
+	#IFF_NOARP
+ 0x0080
+
+	)
+
+378 
+	#IFF_PROMISC
+ 0x0100
+
+	)
+
+379 
+	#IFF_ALLMULTI
+ 0x0200
+
+	)
+
+380 
+	#IFF_OACTIVE
+ 0x0400
+
+	)
+
+381 
+	#IFF_SIMPLEX
+ 0x0800
+
+	)
+
+382 
+	#IFF_LINK0
+ 0x1000
+
+	)
+
+383 
+	#IFF_LINK1
+ 0x2000
+
+	)
+
+384 
+	#IFF_LINK2
+ 0x4000
+
+	)
+
+385 
+	#IFF_MULTICAST
+ 0x8000
+
+	)
+
+387 
+	#IFFBITS
+ \
+
+390 "\15LINK0\16LINK1\17LINK2\20MULTICAST"
+
+	)
+
+393 
+	#IFF_CANTCHANGE
+ \
+
+394 (
+IFF_BROADCAST
+|
+IFF_POINTOPOINT
+|
+IFF_RUNNING
+|
+IFF_OACTIVE
+|\
+
+395 
+IFF_SIMPLEX
+|
+IFF_MULTICAST
+|
+IFF_ALLMULTI
+|
+IFF_PROMISC
+)
+
+	)
+
+400 
+	#IF_Kbps
+(
+x
+((x* 1000ULL
+
+	)
+
+401 
+	#IF_Mbps
+(
+x
+(
+	`IF_Kbps
+((x* 1000ULL)
+
+	)
+
+402 
+	#IF_Gbps
+(
+x
+(
+	`IF_Mbps
+((x* 1000ULL)
+
+	)
+
+406 
+	#IFCAP_TSOv4
+ 0x00080
+
+	)
+
+407 
+	#IFCAP_CSUM_IPv4_Rx
+ 0x00100
+
+	)
+
+408 
+	#IFCAP_CSUM_IPv4_Tx
+ 0x00200
+
+	)
+
+409 
+	#IFCAP_CSUM_TCPv4_Rx
+ 0x00400
+
+	)
+
+410 
+	#IFCAP_CSUM_TCPv4_Tx
+ 0x00800
+
+	)
+
+411 
+	#IFCAP_CSUM_UDPv4_Rx
+ 0x01000
+
+	)
+
+412 
+	#IFCAP_CSUM_UDPv4_Tx
+ 0x02000
+
+	)
+
+413 
+	#IFCAP_CSUM_TCPv6_Rx
+ 0x04000
+
+	)
+
+414 
+	#IFCAP_CSUM_TCPv6_Tx
+ 0x08000
+
+	)
+
+415 
+	#IFCAP_CSUM_UDPv6_Rx
+ 0x10000
+
+	)
+
+416 
+	#IFCAP_CSUM_UDPv6_Tx
+ 0x20000
+
+	)
+
+417 
+	#IFCAP_TSOv6
+ 0x40000
+
+	)
+
+418 
+	#IFCAP_LRO
+ 0x80000
+
+	)
+
+419 
+	#IFCAP_MASK
+ 0xfff80
+
+	)
+
+421 
+	#IFCAPBITS
+ \
+
+436 
+
+	)
+
+437 
+	#IFQ_LOCK
+(
+_ifq
+i((_ifq)->
+ifq_lock
+
+	`mux_r
+((_ifq)->ifq_lock)
+
+	)
+
+438 
+	#IFQ_UNLOCK
+(
+_ifq
+i((_ifq)->
+ifq_lock
+
+	`mux_ex
+((_ifq)->ifq_lock)
+
+	)
+
+446 
+	#IF_QFULL
+(
+ifq
+((ifq)->
+ifq_n
+ >(ifq)->
+ifq_maxn
+)
+
+	)
+
+447 
+	#IF_DROP
+(
+ifq
+((ifq)->
+ifq_drs
+++)
+
+	)
+
+448 
+	#IF_ENQUEUE
+(
+ifq
+, 
+m
+) do { \
+
+449 (
+m
+)->
+m_xkt
+ = 0; \
+
+450 i((
+ifq
+)->
+ifq_
+ == 0) \
+
+451 (
+ifq
+)->
+ifq_hd
+ = 
+m
+; \
+
+453 (
+ifq
+)->
+ifq_
+->
+m_xkt
+ = 
+m
+; \
+
+454 (
+ifq
+)->
+ifq_
+ = 
+m
+; \
+
+455 (
+ifq
+)->
+ifq_n
+++; \
+
+456 }  0)
+
+	)
+
+457 
+	#IF_PREPEND
+(
+ifq
+, 
+m
+) do { \
+
+458 (
+m
+)->
+m_xkt
+ = (
+ifq
+)->
+ifq_hd
+; \
+
+459 i((
+ifq
+)->
+ifq_
+ == 0) \
+
+460 (
+ifq
+)->
+ifq_
+ = (
+m
+); \
+
+461 (
+ifq
+)->
+ifq_hd
+ = (
+m
+); \
+
+462 (
+ifq
+)->
+ifq_n
+++; \
+
+463 }  0)
+
+	)
+
+464 
+	#IF_DEQUEUE
+(
+ifq
+, 
+m
+) do { \
+
+465 (
+m
+(
+ifq
+)->
+ifq_hd
+; \
+
+466 i(
+m
+) { \
+
+467 i(((
+ifq
+)->
+ifq_hd
+ = (
+m
+)->
+m_xkt
+) == 0) \
+
+468 (
+ifq
+)->
+ifq_
+ = 0; \
+
+469 (
+m
+)->
+m_xkt
+ = 0; \
+
+470 (
+ifq
+)->
+ifq_n
+--; \
+
+472 }  0)
+
+	)
+
+473 
+	#IF_POLL
+(
+ifq
+, 
+m
+((m(ifq)->
+ifq_hd
+)
+
+	)
+
+474 
+	#IF_PURGE
+(
+ifq
+) \
+
+476 
+mbuf
+ *
+__m0
+; \
+
+479 
+	`IF_DEQUEUE
+((
+ifq
+), 
+__m0
+); \
+
+480 i(
+__m0
+ =
+NULL
+) \
+
+483 
+	`m_m
+(
+__m0
+); \
+
+485 }  0)
+
+	)
+
+486 
+	#IF_IS_EMPTY
+(
+ifq
+((ifq)->
+ifq_n
+ =0)
+
+	)
+
+488 #ide
+IFQ_MAXLEN
+
+
+489 
+	#IFQ_MAXLEN
+ 256
+
+	)
+
+491 
+	#IFNET_SLOWHZ
+ 1
+
+	)
+
+497 
+	siddr_da
+ {
+
+498 
+t64_t
+ 
+	mid_bys
+;
+
+499 
+t64_t
+ 
+	mid_outbys
+;
+
+508 
+	siddr
+ {
+
+509 
+sockaddr
+ *
+	mi_addr
+;
+
+510 
+sockaddr
+ *
+	mi_daddr
+;
+
+511 
+	#i_brdaddr
+ 
+i_daddr
+
+
+	)
+
+512 
+sockaddr
+ *
+	mi_tmask
+;
+
+513 
+i
+ *
+	mi_i
+;
+
+514 
+TAILQ_ENTRY
+(
+iddr
+
+	mi_li
+;
+
+515 
+iddr_da
+ 
+	mi_da
+;
+
+516 (*
+	mi_que
+)
+
+517 (, 
+	my
+ *, c 
+	m_addrfo
+ *);
+
+518 
+u_t
+ 
+	mi_ags
+;
+
+519 
+	mi_ft
+;
+
+520 
+	mi_mric
+;
+
+521 
+	middr
+ *(*
+	mi_gi
+)(ifaddr *,
+
+522 c 
+	msockaddr
+ *);
+
+523 
+ut32_t
+ *
+	mi_qno
+;
+
+524 
+t16_t
+ 
+	mi_en
+;
+
+526 
+	#IFA_ROUTE
+ 
+RTF_UP
+
+
+	)
+
+533 #i!
+defed
+(
+_KERNEL
+|| !defed(
+COMPAT_RTSOCK
+)
+
+534 
+	#__ign64
+ 
+	`__igd
+((
+ut64_t
+))
+
+	)
+
+536 
+	#__ign64
+
+
+	)
+
+538 
+	sif_msghdr
+ {
+
+539 
+u_sht
+ 
+ifm_msgn
+ 
+	m__ign64
+;
+
+541 
+u_ch
+ 
+	mifm_vsi
+;
+
+542 
+u_ch
+ 
+	mifm_ty
+;
+
+543 
+	mifm_addrs
+;
+
+544 
+	mifm_ags
+;
+
+545 
+u_sht
+ 
+	mifm_dex
+;
+
+546 
+if_da
+ 
+ifm_da
+ 
+	m__ign64
+;
+
+554 
+	si_msghdr
+ {
+
+555 
+u_sht
+ 
+im_msgn
+ 
+	m__ign64
+;
+
+557 
+u_ch
+ 
+	mim_vsi
+;
+
+558 
+u_ch
+ 
+	mim_ty
+;
+
+559 
+	mim_addrs
+;
+
+560 
+	mim_ags
+;
+
+561 
+	mim_mric
+;
+
+562 
+u_sht
+ 
+	mim_dex
+;
+
+568 
+	sif_nounmsghdr
+ {
+
+569 
+u_sht
+ 
+in_msgn
+ 
+	m__ign64
+;
+
+571 
+u_ch
+ 
+	min_vsi
+;
+
+572 
+u_ch
+ 
+	min_ty
+;
+
+573 
+u_sht
+ 
+	min_dex
+;
+
+574 
+	min_me
+[
+IFNAMSIZ
+];
+
+575 
+u_sht
+ 
+	min_wh
+;
+
+578 
+	#IFAN_ARRIVAL
+ 0
+
+	)
+
+579 
+	#IFAN_DEPARTURE
+ 1
+
+	)
+
+581 #unde
+__ign64
+
+
+589 
+	sieq
+ {
+
+590 
+	mi_me
+[
+IFNAMSIZ
+];
+
+592 
+sockaddr
+ 
+	miu_addr
+;
+
+593 
+sockaddr
+ 
+	miu_daddr
+;
+
+594 
+sockaddr
+ 
+	miu_brdaddr
+;
+
+595 
+sockaddr_age
+ 
+	miu_a
+;
+
+596 
+	miu_ags
+;
+
+597 
+	miu_addrags
+;
+
+598 
+	miu_mric
+;
+
+599 
+	miu_mtu
+;
+
+600 
+	miu_d
+;
+
+601 
+u_t
+ 
+	miu_vue
+;
+
+602 * 
+	miu_da
+;
+
+604 
+ut32_t
+ 
+	mb_bu
+;
+
+605 *
+	mb_buf
+;
+
+606 } 
+	miu_b
+;
+
+607 } 
+	mi_iu
+;
+
+608 
+	#i_addr
+ 
+i_iu
+.
+iu_addr
+
+
+	)
+
+609 
+	#i_daddr
+ 
+i_iu
+.
+iu_daddr
+
+
+	)
+
+610 
+	#i_brdaddr
+ 
+i_iu
+.
+iu_brdaddr
+
+
+	)
+
+611 
+	#i_a
+ 
+i_iu
+.
+iu_a
+
+
+	)
+
+612 
+	#i_ags
+ 
+i_iu
+.
+iu_ags
+
+
+	)
+
+613 
+	#i_addrags
+ 
+i_iu
+.
+iu_addrags
+
+
+	)
+
+614 
+	#i_mric
+ 
+i_iu
+.
+iu_mric
+
+
+	)
+
+615 
+	#i_mtu
+ 
+i_iu
+.
+iu_mtu
+
+
+	)
+
+616 
+	#i_d
+ 
+i_iu
+.
+iu_d
+
+
+	)
+
+617 
+	#i_vue
+ 
+i_iu
+.
+iu_vue
+
+
+	)
+
+618 
+	#i_med
+ 
+i_iu
+.
+iu_mric
+
+
+	)
+
+619 
+	#i_da
+ 
+i_iu
+.
+iu_da
+
+
+	)
+
+622 
+	#i_buf
+ 
+i_iu
+.
+iu_b
+.
+b_buf
+
+
+	)
+
+623 
+	#i_bu
+ 
+i_iu
+.
+iu_b
+.
+b_bu
+
+
+	)
+
+624 
+	#i_dex
+ 
+i_iu
+.
+iu_vue
+
+
+	)
+
+625 
+	#i_ifdex
+ 
+i_dex
+
+
+	)
+
+628 #ifde
+_KERNEL
+
+
+629 
+	#ieq_tdaddr
+ 
+ieq_ddr
+
+
+	)
+
+630 
+	#ieq_tbrdaddr
+ 
+ieq_ddr
+
+
+	)
+
+631 
+	#ieq_gdaddr
+ 
+ieq_gaddr
+
+
+	)
+
+632 
+	#ieq_gbrdaddr
+ 
+ieq_gaddr
+
+
+	)
+
+634 
+le
+ c 
+sockaddr
+ *
+
+636 
+	$ieq_gaddr
+(
+u_lg
+ 
+cmd
+, c 
+ieq
+ *
+i
+)
+
+638  &
+i
+->
+i_addr
+;
+
+639 
+	}
+}
+
+642 
+	sifeq
+ {
+
+643 
+	mif_me
+[
+IFNAMSIZ
+];
+
+644 
+ut64_t
+ 
+	mif_bs
+;
+
+645 
+ut64_t
+ 
+	mif_b
+;
+
+648 
+	sileq
+ {
+
+649 
+	mia_me
+[
+IFNAMSIZ
+];
+
+650 
+sockaddr
+ 
+	mia_addr
+;
+
+651 
+sockaddr
+ 
+	mia_daddr
+;
+
+652 
+	#ia_brdaddr
+ 
+ia_daddr
+
+
+	)
+
+653 
+sockaddr
+ 
+	mia_mask
+;
+
+656 
+	sifdeq
+ {
+
+657 
+	mifdr_me
+[
+IFNAMSIZ
+];
+
+658 
+if_da
+ 
+	mifdr_da
+;
+
+661 
+	sifmedq
+ {
+
+662 
+	mifm_me
+[
+IFNAMSIZ
+];
+
+663 
+	mifm_cut
+;
+
+664 
+	mifm_mask
+;
+
+665 
+	mifm_us
+;
+
+666 
+	mifm_aive
+;
+
+667 
+	mifm_cou
+;
+
+669 *
+	mifm_uli
+;
+
+673 
+	sifdrv
+ {
+
+674 
+	mifd_me
+[
+IFNAMSIZ
+];
+
+675 
+	mifd_cmd
+;
+
+676 
+size_t
+ 
+	mifd_n
+;
+
+677 *
+	mifd_da
+;
+
+679 
+	#IFLINKSTR_QUERYLEN
+ 0x01
+
+	)
+
+680 
+	#IFLINKSTR_UNSET
+ 0x02
+
+	)
+
+688 
+	sifcf
+ {
+
+689 
+	mifc_n
+;
+
+691 * 
+	mifcu_buf
+;
+
+692 
+ieq
+ *
+	mifcu_q
+;
+
+693 } 
+	mifc_ifcu
+;
+
+694 
+	#ifc_buf
+ 
+ifc_ifcu
+.
+ifcu_buf
+
+
+	)
+
+695 
+	#ifc_q
+ 
+ifc_ifcu
+.
+ifcu_q
+
+
+	)
+
+701 
+	sif_ddeq
+ {
+
+702 
+	mir_me
+[
+IFNAMSIZ
+];
+
+703 
+	mags
+;
+
+704 
+	#IFLR_PREFIX
+ 0x8000
+
+	)
+
+705 
+	#IFLR_ACTIVE
+ 0x4000
+
+	)
+
+706 
+	#IFLR_FACTORY
+ 0x2000
+
+	)
+
+707 
+	mefixn
+;
+
+708 
+sockaddr_age
+ 
+	maddr
+;
+
+709 
+sockaddr_age
+ 
+	mdaddr
+;
+
+715 
+	sif_addeq
+ {
+
+716 
+	mip_me
+[
+IFNAMSIZ
+];
+
+717 
+t16_t
+ 
+	mip_en
+;
+
+718 
+sockaddr_age
+ 
+	mip_addr
+;
+
+721 
+	~<t/if_p.h
+>
+
+725 #ifde
+_KERNEL
+
+
+726 #ifde
+ALTQ
+
+
+727 
+	#ALTQ_DECL
+(
+x
+
+	)
+x
+
+728 
+	#ALTQ_COMMA
+ ,
+
+	)
+
+730 
+	#IFQ_ENQUEUE
+(
+ifq
+, 
+m
+, 
+r
+, 
+r
+) \
+
+732 
+	`IFQ_LOCK
+((
+ifq
+)); \
+
+733 i(
+	`ALTQ_IS_ENABLED
+((
+ifq
+))) \
+
+734 
+	`ALTQ_ENQUEUE
+((
+ifq
+), (
+m
+), (
+r
+), (
+r
+)); \
+
+736 i(
+	`IF_QFULL
+((
+ifq
+))) { \
+
+737 
+	`m_m
+((
+m
+)); \
+
+738 (
+r
+
+ENOBUFS
+; \
+
+740 
+	`IF_ENQUEUE
+((
+ifq
+), (
+m
+)); \
+
+741 (
+r
+) = 0; \
+
+744 i((
+r
+)) \
+
+745 (
+ifq
+)->
+ifq_drs
+++; \
+
+746 
+	`IFQ_UNLOCK
+((
+ifq
+)); \
+
+747 }  0)
+
+	)
+
+749 
+	#IFQ_DEQUEUE
+(
+ifq
+, 
+m
+) \
+
+751 
+	`IFQ_LOCK
+((
+ifq
+)); \
+
+752 i(
+	`TBR_IS_ENABLED
+((
+ifq
+))) \
+
+753 (
+m
+
+	`tbr_dequeue
+((
+ifq
+), 
+ALTDQ_REMOVE
+); \
+
+754 i(
+	`ALTQ_IS_ENABLED
+((
+ifq
+))) \
+
+755 
+	`ALTQ_DEQUEUE
+((
+ifq
+), (
+m
+)); \
+
+757 
+	`IF_DEQUEUE
+((
+ifq
+), (
+m
+)); \
+
+758 
+	`IFQ_UNLOCK
+((
+ifq
+)); \
+
+759 }  0)
+
+	)
+
+761 
+	#IFQ_POLL
+(
+ifq
+, 
+m
+) \
+
+763 
+	`IFQ_LOCK
+((
+ifq
+)); \
+
+764 i(
+	`TBR_IS_ENABLED
+((
+ifq
+))) \
+
+765 (
+m
+
+	`tbr_dequeue
+((
+ifq
+), 
+ALTDQ_POLL
+); \
+
+766 i(
+	`ALTQ_IS_ENABLED
+((
+ifq
+))) \
+
+767 
+	`ALTQ_POLL
+((
+ifq
+), (
+m
+)); \
+
+769 
+	`IF_POLL
+((
+ifq
+), (
+m
+)); \
+
+770 
+	`IFQ_UNLOCK
+((
+ifq
+)); \
+
+771 }  0)
+
+	)
+
+773 
+	#IFQ_PURGE
+(
+ifq
+) \
+
+775 
+	`IFQ_LOCK
+((
+ifq
+)); \
+
+776 i(
+	`ALTQ_IS_ENABLED
+((
+ifq
+))) \
+
+777 
+	`ALTQ_PURGE
+((
+ifq
+)); \
+
+779 
+	`IF_PURGE
+((
+ifq
+)); \
+
+780 
+	`IFQ_UNLOCK
+((
+ifq
+)); \
+
+781 }  0)
+
+	)
+
+783 
+	#IFQ_SET_READY
+(
+ifq
+) \
+
+785 (
+ifq
+)->
+tq_ags
+ |
+ALTQF_READY
+; \
+
+786 }  0)
+
+	)
+
+788 
+	#IFQ_CLASSIFY
+(
+ifq
+, 
+m
+, 
+af
+, 
+r
+) \
+
+790 
+	`IFQ_LOCK
+((
+ifq
+)); \
+
+791 i(
+	`ALTQ_IS_ENABLED
+((
+ifq
+))) { \
+
+792 i(
+	`ALTQ_NEEDS_CLASSIFY
+((
+ifq
+))) \
+
+793 (
+r
+)->
+r_ass
+ = (*(
+ifq
+)->
+tq_assify
+) \
+
+794 ((
+ifq
+)->
+tq_fr
+, (
+m
+), (
+af
+)); \
+
+795 (
+r
+)->
+r_af
+ = (
+af
+); \
+
+796 (
+r
+)->
+r_hdr
+ = 
+	`mtod
+((
+m
+), *); \
+
+798 
+	`IFQ_UNLOCK
+((
+ifq
+)); \
+
+799 }  0)
+
+	)
+
+801 
+	#ALTQ_DECL
+(
+x
+
+
+	)
+
+802 
+	#ALTQ_COMMA
+
+
+	)
+
+804 
+	#IFQ_ENQUEUE
+(
+ifq
+, 
+m
+, 
+r
+, 
+r
+) \
+
+806 
+	`IFQ_LOCK
+((
+ifq
+)); \
+
+807 i(
+	`IF_QFULL
+((
+ifq
+))) { \
+
+808 
+	`m_m
+((
+m
+)); \
+
+809 (
+r
+
+ENOBUFS
+; \
+
+811 
+	`IF_ENQUEUE
+((
+ifq
+), (
+m
+)); \
+
+812 (
+r
+) = 0; \
+
+814 i((
+r
+)) \
+
+815 (
+ifq
+)->
+ifq_drs
+++; \
+
+816 
+	`IFQ_UNLOCK
+((
+ifq
+)); \
+
+817 }  0)
+
+	)
+
+819 
+	#IFQ_DEQUEUE
+(
+ifq
+, 
+m
+) \
+
+821 
+	`IFQ_LOCK
+((
+ifq
+)); \
+
+822 
+	`IF_DEQUEUE
+((
+ifq
+), (
+m
+)); \
+
+823 
+	`IFQ_UNLOCK
+((
+ifq
+)); \
+
+824 }  0)
+
+	)
+
+826 
+	#IFQ_POLL
+(
+ifq
+, 
+m
+) \
+
+828 
+	`IFQ_LOCK
+((
+ifq
+)); \
+
+829 
+	`IF_POLL
+((
+ifq
+), (
+m
+)); \
+
+830 
+	`IFQ_UNLOCK
+((
+ifq
+)); \
+
+831 }  0)
+
+	)
+
+833 
+	#IFQ_PURGE
+(
+ifq
+) \
+
+835 
+	`IFQ_LOCK
+((
+ifq
+)); \
+
+836 
+	`IF_PURGE
+((
+ifq
+)); \
+
+837 
+	`IFQ_UNLOCK
+((
+ifq
+)); \
+
+838 }  0)
+
+	)
+
+840 
+	#IFQ_SET_READY
+(
+ifq
+
+
+	)
+
+842 
+	#IFQ_CLASSIFY
+(
+ifq
+, 
+m
+, 
+af
+, 
+r
+
+
+	)
+
+846 
+	#IFQ_IS_EMPTY
+(
+ifq
+
+	`IF_IS_EMPTY
+((ifq))
+
+	)
+
+847 
+	#IFQ_INC_LEN
+(
+ifq
+((ifq)->
+ifq_n
+++)
+
+	)
+
+848 
+	#IFQ_DEC_LEN
+(
+ifq
+(--(ifq)->
+ifq_n
+)
+
+	)
+
+849 
+	#IFQ_INC_DROPS
+(
+ifq
+((ifq)->
+ifq_drs
+++)
+
+	)
+
+850 
+	#IFQ_SET_MAXLEN
+(
+ifq
+, 
+n
+((ifq)->
+ifq_maxn
+ = (n))
+
+	)
+
+852 
+	~<sys/mlocv.h
+>
+
+853 
+MALLOC_DECLARE
+(
+M_IFADDR
+);
+
+854 
+MALLOC_DECLARE
+(
+M_IFMADDR
+);
+
+856 
+ieq_ddr
+(
+u_lg
+, 
+ieq
+ *, c 
+sockaddr
+ *);
+
+858 
+i
+ *
+if_loc
+(
+u_ch
+);
+
+859 
+if_
+(
+i
+ *);
+
+860 
+if_me
+(
+i
+ *, const *, );
+
+861 
+iddr
+ *
+if_dl_
+(c 
+i
+ *, c 
+sockaddr_dl
+ **);
+
+862 
+if_aive_dl
+(
+i
+ *, 
+iddr
+ *,
+
+863 c 
+sockaddr_dl
+ *);
+
+864 
+if_t_dl
+(
+i
+ *, c *, 
+u_ch
+, 
+bo
+);
+
+865 
+if_loc_dl
+(
+i
+ *);
+
+866 
+if_lize
+(
+i
+ *);
+
+867 
+if_gi
+(
+i
+ *);
+
+868 
+if_ch
+(
+i
+ *);
+
+869 
+if_chdoma
+();
+
+870 
+if_dive
+(
+i
+ *);
+
+871 
+if_purgddrs
+(
+i
+ *, , (*)(
+iddr
+ *));
+
+872 
+	`if_dach
+(
+i
+ *);
+
+873 
+	`if_down
+(
+i
+ *);
+
+874 
+	`if_lk_e_chge
+(
+i
+ *, );
+
+875 
+	`if_up
+(
+i
+ *);
+
+876 
+	`if
+();
+
+877 
+	`if1
+();
+
+878 
+	`iddf_iol
+(
+sock
+ *, 
+u_lg
+, *, 
+i
+ *);
+
+879 (*
+ifiol
+)(
+sock
+ *, 
+u_lg
+, *, 
+lwp
+ *);
+
+880 
+	`ifiol_comm
+(
+i
+ *, 
+u_lg
+, *);
+
+881 
+	`iromisc
+(
+i
+ *, );
+
+882 
+i
+ *
+	`ifun
+(const *);
+
+883 
+	`if_addr_
+(
+i_t
+ *, 
+iddr
+ *, 
+bo
+);
+
+884 
+	`if_do_dad
+(
+i
+ *);
+
+885 
+	`if_m_
+(
+i_t
+ *, c , c 
+sockaddr
+ *);
+
+886 
+	`if_ags_t
+(
+i
+ *, const );
+
+887 
+	`if_e_li
+(, *, *);
+
+889 
+	`i_
+(
+i
+ *, 
+iddr
+ *);
+
+890 
+	`i_move
+(
+i
+ *, 
+iddr
+ *);
+
+892 
+	`if
+(
+iddr
+ *);
+
+893 
+	`i
+(
+iddr
+ *);
+
+895 
+iddr
+ *
+	`i_ifwhaddr
+(c 
+sockaddr
+ *);
+
+896 
+iddr
+ *
+	`i_ifwhaf
+();
+
+897 
+iddr
+ *
+	`i_ifwhdaddr
+(c 
+sockaddr
+ *);
+
+898 
+iddr
+ *
+	`i_ifwht
+(c 
+sockaddr
+ *);
+
+899 
+iddr
+ *
+	`i_ifwhddr
+(c 
+sockaddr
+ *);
+
+900 
+iddr
+ *
+	`i_ifwhrou
+(, c 
+sockaddr
+ *,
+
+901 c 
+sockaddr
+ *);
+
+902 
+iddr
+ *
+	`iof_ifaddr
+(c 
+sockaddr
+ *, 
+i
+ *);
+
+903 
+	`i
+(
+iddr
+ *);
+
+904 
+	`lk_que
+(, 
+y
+ *, c 
+_addrfo
+ *);
+
+905 
+	`p2p_que
+(, 
+y
+ *, c 
+_addrfo
+ *);
+
+907 
+	`if_e_ch
+(
+if_e
+ *);
+
+908 
+	`if_e_dach
+(
+if_e
+ *);
+
+910 
+	`ifq_queue
+(
+i
+ *, 
+mbuf
+ * 
+ALTQ_COMMA
+
+
+911 
+	`ALTQ_DECL
+(
+tq_pkr
+ *));
+
+912 
+	`ifq_queue2
+(
+i
+ *, 
+ifqueue
+ *, 
+mbuf
+ * 
+ALTQ_COMMA
+
+
+913 
+	`ALTQ_DECL
+(
+tq_pkr
+ *));
+
+915 
+	`loiol
+(
+i
+ *, 
+u_lg
+, *);
+
+916 
+	`loch
+();
+
+917 
+	`loouut
+(
+i
+ *,
+
+918 
+mbuf
+ *, c 
+sockaddr
+ *, 
+y
+ *);
+
+919 
+	`leque
+(, 
+y
+ *, c 
+_addrfo
+ *);
+
+925 
+	`if_nuouut
+(
+i
+ *, 
+mbuf
+ *,
+
+926 c 
+sockaddr
+ *, 
+y
+ *);
+
+927 
+	`if_nuput
+(
+i
+ *, 
+mbuf
+ *);
+
+928 
+	`if_nut
+(
+i
+ *);
+
+929 
+	`if_nuiol
+(
+i
+ *, 
+u_lg
+, *);
+
+930 
+	`if_nu
+(
+i
+ *);
+
+931 
+	`if_nu
+(
+i
+ *, );
+
+932 
+	`if_nuowtimo
+(
+i
+ *);
+
+933 
+	#if_nuwchdog
+ 
+if_nuowtimo
+
+
+	)
+
+934 
+	`if_nud
+(
+i
+ *);
+
+936 
+	sif_medex
+ {
+
+937 
+if_dex
+;
+
+938 *
+if_me
+;
+
+941 
+	~<sys/cdefs.h
+>
+
+942 
+__BEGIN_DECLS
+
+
+943 
+	`if_modex
+(const *);
+
+944 * 
+	`if_dextame
+(, *);
+
+945 
+if_medex
+ * 
+	`if_medex
+();
+
+946 
+	`if_medex
+(
+if_medex
+ *);
+
+947 
+__END_DECLS
+
+
+950 #ifde
+_KERNEL
+
+
+952 
+	#IFNET_FIRST
+(
+	`TAILQ_FIRST
+(&
+i_li
+)
+
+	)
+
+953 
+	#IFNET_EMPTY
+(
+	`TAILQ_EMPTY
+(&
+i_li
+)
+
+	)
+
+954 
+	#IFNET_NEXT
+(
+__i
+
+	`TAILQ_NEXT
+((__i), 
+if_li
+)
+
+	)
+
+955 
+	#IFNET_FOREACH
+(
+__i
+
+	`TAILQ_FOREACH
+(__i, &
+i_li
+, 
+if_li
+)
+
+	)
+
+956 
+	#IFADDR_FIRST
+(
+__i
+
+	`TAILQ_FIRST
+(&(__i)->
+if_addi
+)
+
+	)
+
+957 
+	#IFADDR_NEXT
+(
+__i
+
+	`TAILQ_NEXT
+((__i), 
+i_li
+)
+
+	)
+
+958 
+	#IFADDR_FOREACH
+(
+__i
+, 
+__i
+
+	`TAILQ_FOREACH
+(__ifa, \
+
+959 &(
+__i
+)->
+if_addi
+, 
+i_li
+)
+
+	)
+
+960 
+	#IFADDR_FOREACH_SAFE
+(
+__i
+, 
+__i
+, 
+__ni
+) \
+
+961 
+	`TAILQ_FOREACH_SAFE
+(
+__i
+, \
+
+962 &(
+__i
+)->
+if_addi
+, 
+i_li
+, 
+__ni
+)
+
+	)
+
+963 
+	#IFADDR_EMPTY
+(
+__i
+
+	`TAILQ_EMPTY
+(&(__i)->
+if_addi
+)
+
+	)
+
+965 
+i_hd
+ 
+i_li
+;
+
+966 
+i
+ *
+lo0i
+;
+
+968 
+i_t
+ * 
+	`if_bydex
+(
+u_t
+);
+
+973 
+	`sysl_ifq
+(*
+me
+, 
+u_t
+ 
+m
+, *
+dp
+,
+
+974 
+size_t
+ *
+d
+, *
+wp
+, size_
+wn
+,
+
+975 
+ifqueue
+ *
+ifq
+);
+
+977 
+	#IFQCTL_LEN
+ 1
+
+	)
+
+978 
+	#IFQCTL_MAXLEN
+ 2
+
+	)
+
+979 
+	#IFQCTL_PEAK
+ 3
+
+	)
+
+980 
+	#IFQCTL_DROPS
+ 4
+
+	)
+
+981 
+	#IFQCTL_MAXID
+ 5
+
+	)
+
+985 #ifde
+_NETBSD_SOURCE
+
+
+989 
+	#CTL_IFQ_NAMES
+ { \
+
+991 { "n", 
+CTLTYPE_INT
+ }, \
+
+992 { "maxn", 
+CTLTYPE_INT
+ }, \
+
+993 { "ak", 
+CTLTYPE_INT
+ }, \
+
+994 { "drs", 
+CTLTYPE_INT
+ }, \
+
+995 
+	}
+
+	)
+}
+
+	@if_arc.h
+
+35 #ide
+_NET_IF_ARC_H_
+
+
+36 
+	#_NET_IF_ARC_H_
+
+
+	)
+
+42 
+	sc_addr
+ {
+
+43 
+ut8_t
+ 
+	mc_addr_o
+[1];
+
+44 } 
+	g__cked
+;
+
+50 
+	sc_hd
+ {
+
+51 
+ut8_t
+ 
+	mc_sho
+;
+
+52 
+ut8_t
+ 
+	mc_dho
+;
+
+53 
+ut8_t
+ 
+	mc_ty
+;
+
+58 
+ut8_t
+ 
+	mc_ag
+;
+
+59 
+ut16_t
+ 
+	mc_qid
+;
+
+64 
+ut8_t
+ 
+	mc_ty2
+;
+
+65 
+ut8_t
+ 
+	mc_ag2
+;
+
+66 
+ut16_t
+ 
+	mc_qid2
+;
+
+67 } 
+	g__cked
+;
+
+69 
+	#ARC_ADDR_LEN
+ 1
+
+	)
+
+71 
+	#ARC_HDRLEN
+ 3
+
+	)
+
+72 
+	#ARC_HDRNEWLEN
+ 6
+
+	)
+
+73 
+	#ARC_HDRNEWLEN_EXC
+ 10
+
+	)
+
+76 
+	#ARC_MIN_LEN
+ 1
+
+	)
+
+77 
+	#ARC_MIN_FORBID_LEN
+ 254
+
+	)
+
+78 
+	#ARC_MAX_FORBID_LEN
+ 256
+
+	)
+
+79 
+	#ARC_MAX_LEN
+ 508
+
+	)
+
+83 
+	#ARCTYPE_IP_OLD
+ 240
+
+	)
+
+84 
+	#ARCTYPE_ARP_OLD
+ 241
+
+	)
+
+87 
+	#ARCTYPE_IP
+ 212
+
+	)
+
+88 
+	#ARCTYPE_ARP
+ 213
+
+	)
+
+89 
+	#ARCTYPE_REVARP
+ 214
+
+	)
+
+91 
+	#ARCTYPE_ATALK
+ 221
+
+	)
+
+92 
+	#ARCTYPE_BANIAN
+ 247
+
+	)
+
+93 
+	#ARCTYPE_IPX
+ 250
+
+	)
+
+95 
+	#ARCTYPE_INET6
+ 0xc4
+
+	)
+
+96 
+	#ARCTYPE_DIAGNOSE
+ 0x80
+
+	)
+
+98 
+	#ARCMTU
+ 507
+
+	)
+
+99 
+	#ARCMIN
+ 0
+
+	)
+
+101 
+	#ARC_PHDS_MAXMTU
+ 60480
+
+	)
+
+103 
+	sccom
+ {
+
+104 
+i
+ 
+	mac_if
+;
+
+106 
+ut16_t
+ 
+	mac_qid
+;
+
+108 
+	sac_ag
+ {
+
+109 
+ut8_t
+ 
+	maf_maxag
+;
+
+110 
+ut8_t
+ 
+	maf_
+;
+
+111 
+ut16_t
+ 
+	maf_qid
+;
+
+112 
+mbuf
+ *
+	maf_ck
+;
+
+113 } 
+	mac_agb
+[256];
+
+117 #ifde
+_KERNEL
+
+
+118 
+ut8_t
+ 
+cbrdaddr
+;
+
+119 
+c_mtu
+;
+
+121 
+c_iach
+(
+i
+ *, 
+ut8_t
+);
+
+122 *
+c_rtf
+(
+ut8_t
+ *);
+
+123 
+c_ihds
+(
+ut8_t
+);
+
+	@if_arcsubr.c
+
+37 
+	~<sys/cdefs.h
+>
+
+38 
+__KERNEL_RCSID
+(0, "$NetBSD: if_arcsubr.c,v 1.66 2014/06/05 23:48:16mind Exp $");
+
+40 
+	~"t_.h
+"
+
+43 
+	~<sys/m.h
+>
+
+44 
+	~<sys/sym.h
+>
+
+45 
+	~<sys/kl.h
+>
+
+46 
+	~<sys/mloc.h
+>
+
+47 
+	~<sys/mbuf.h
+>
+
+48 
+	~<sys/osw.h
+>
+
+49 
+	~<sys/sock.h
+>
+
+50 
+	~<sys/iol.h
+>
+
+51 
+	~<sys/o.h
+>
+
+52 
+	~<sys/syog.h
+>
+
+54 
+	~<sys/u.h
+>
+
+56 
+	~<t/if.h
+>
+
+57 
+	~<t/ti.h
+>
+
+58 
+	~<t/rou.h
+>
+
+59 
+	~<t/if_dl.h
+>
+
+60 
+	~<t/if_tys.h
+>
+
+61 
+	~<t/if_c.h
+>
+
+62 
+	~<t/if_p.h
+>
+
+63 
+	~<t/if_h.h
+>
+
+65 
+	~<t/bpf.h
+>
+
+67 #ifde
+INET
+
+
+68 
+	~<t/.h
+>
+
+69 
+	~<t/_v.h
+>
+
+70 
+	~<t/if_p.h
+>
+
+73 #ifde
+INET6
+
+
+74 #ide
+INET
+
+
+75 
+	~<t/.h
+>
+
+77 
+	~<t6/6_v.h
+>
+
+78 
+	~<t6/nd6.h
+>
+
+81 
+	#ARCNET_ALLOW_BROKEN_ARP
+
+
+	)
+
+83 #ide
+ARC_IPMTU
+
+
+84 
+	#ARC_IPMTU
+ 1500
+
+	)
+
+87 
+mbuf
+ *
+c_deag
+(
+i
+ *, mbuf *);
+
+95 #i
+ARC_IPMTU
+ > 60480
+
+96 
+	gERROR
+: 
+The
+ 
+c_mtu
+ 
+is
+ 
+ARC_IPMTU
+, 
+but
+ 
+mu
+ 
+n
+ 
+	gexed
+ 60480.
+
+98 
+	gc_mtu
+ = 
+ARC_IPMTU
+;
+
+99 
+ut8_t
+ 
+	gcbrdaddr
+ = 0;
+
+101 
+	#ndr
+(
+e
+{ 
+r
+ = (e); 
+bad
+;}
+
+	)
+
+103 
+c_ouut
+(
+i
+ *, 
+mbuf
+ *,
+
+104 c 
+sockaddr
+ *, 
+y
+ *);
+
+105 
+c_put
+(
+i
+ *, 
+mbuf
+ *);
+
+113 
+	$c_ouut
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m0
+, c 
+sockaddr
+ *
+d
+,
+
+114 
+y
+ *
+0
+)
+
+116 
+mbuf
+ *
+m
+, *
+m1
+, *
+mcy
+;
+
+117 
+y
+ *
+
+;
+
+118 
+ccom
+ *
+ac
+;
+
+119 c 
+c_hd
+ *
+h
+;
+
+120 
+c_hd
+ *
+ah
+;
+
+121 
+phdr
+ *
+ph
+;
+
+122 
+r
+, 
+wcodg
+;
+
+123 
+ut8_t
+ 
+y
+, 
+ad
+, 
+mylf
+;
+
+124 
+tags
+, 
+sag
+, 
+fsag
+, 
+rsag
+;
+
+125 
+	`ALTQ_DECL
+(
+tq_pkr
+ 
+pkr
+;)
+
+127 i((
+i
+->
+if_ags
+ & (
+IFF_UP
+|
+IFF_RUNNING
+)) != (IFF_UP|IFF_RUNNING))
+
+128  (
+ENETDOWN
+);
+
+130 
+r
+ = 
+wcodg
+ = 0;
+
+131 
+ac
+ = (
+ccom
+ *)
+i
+;
+
+132 
+m
+ = 
+m0
+;
+
+133 
+mcy
+ = 
+m1
+ = 
+NULL
+;
+
+135 
+mylf
+ = *
+	`CLLADDR
+(
+i
+->
+if_dl
+);
+
+137 i((
+
+ = 
+0
+)) {
+
+138 i((
+
+->
+_ags
+ & 
+RTF_UP
+) == 0) {
+
+139 i((
+0
+ = 
+
+ = 
+	`loc1
+(
+d
+, 1)))
+
+140 
+
+->
+_ft
+--;
+
+142 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+144 i(
+
+->
+_ags
+ & 
+RTF_GATEWAY
+) {
+
+145 i(
+
+->
+_gwrou
+ == 0)
+
+146 
+lookup
+;
+
+147 i(((
+
+ =t->
+_gwrou
+)->
+_ags
+ & 
+RTF_UP
+) == 0) {
+
+148 
+	`
+(
+
+);
+0
+;
+
+149 
+lookup
+: 
+
+->
+_gwrou
+ = 
+	`loc1
+t->
+_geway
+, 1);
+
+150 i((
+
+ =t->
+_gwrou
+) == 0)
+
+151 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+154 i(
+
+->
+_ags
+ & 
+RTF_REJECT
+)
+
+155 i(
+
+->
+_rmx
+.
+rmx_expe
+ == 0 ||
+
+156 
+time_cd
+ < 
+
+->
+_rmx
+.
+rmx_expe
+)
+
+157 
+	`ndr
+(
+
+ =
+0
+ ? 
+EHOSTDOWN
+ : 
+EHOSTUNREACH
+);
+
+164 
+	`IFQ_CLASSIFY
+(&
+i
+->
+if_d
+, 
+m
+, 
+d
+->
+_my
+, &
+pkr
+);
+
+166 
+d
+->
+_my
+) {
+
+167 #ifde
+INET
+
+
+168 
+AF_INET
+:
+
+173 i(
+m
+->
+m_ags
+ & (
+M_BCAST
+|
+M_MCAST
+))
+
+174 
+ad
+ = 
+cbrdaddr
+;
+
+175 i(
+i
+->
+if_ags
+ & 
+IFF_NOARP
+)
+
+176 
+ad
+ = 
+	`ohl
+(
+	`tocs
+(
+d
+)->
+s_addr
+.
+s_addr
+) & 0xFF;
+
+177 i(!
+	`esve
+(
+i
+, 
+
+, 
+m
+, 
+d
+, &
+ad
+))
+
+181 i((
+m
+->
+m_ags
+ & (
+M_BCAST
+|
+M_MCAST
+)) &&
+
+182 (
+i
+->
+if_ags
+ & 
+IFF_SIMPLEX
+))
+
+183 
+mcy
+ = 
+	`m_cy
+(
+m
+, 0, ()
+M_COPYALL
+);
+
+184 i(
+i
+->
+if_ags
+ & 
+IFF_LINK0
+) {
+
+185 
+y
+ = 
+ARCTYPE_IP
+;
+
+186 
+wcodg
+ = 1;
+
+188 
+y
+ = 
+ARCTYPE_IP_OLD
+;
+
+189 
+wcodg
+ = 0;
+
+193 
+AF_ARP
+:
+
+194 
+ph
+ = 
+	`mtod
+(
+m
+, 
+phdr
+ *);
+
+195 i(
+m
+->
+m_ags
+ & 
+M_BCAST
+)
+
+196 
+ad
+ = 
+cbrdaddr
+;
+
+198 
+ut8_t
+ *
+tha
+ = 
+	`_tha
+(
+ph
+);
+
+199 i(
+tha
+ =
+NULL
+)
+
+201 
+ad
+ = *
+tha
+;
+
+204 
+ph
+->
+_hrd
+ = 
+	`hts
+(
+ARPHRD_ARCNET
+);
+
+206 
+	`ohs
+(
+ph
+->
+_
+)) {
+
+207 
+ARPOP_REVREQUEST
+:
+
+208 
+ARPOP_REVREPLY
+:
+
+209 i(!(
+i
+->
+if_ags
+ & 
+IFF_LINK0
+)) {
+
+210 
+	`tf
+("%s: can't handlef%d\n",
+
+211 
+i
+->
+if_xme
+, 
+d
+->
+_my
+);
+
+212 
+	`ndr
+(
+EAFNOSUPPORT
+);
+
+215 
+y
+ = 
+	`hts
+(
+ARCTYPE_REVARP
+);
+
+216 
+wcodg
+ = 1;
+
+219 
+ARPOP_REQUEST
+:
+
+220 
+ARPOP_REPLY
+:
+
+222 i(
+i
+->
+if_ags
+ & 
+IFF_LINK0
+) {
+
+223 
+y
+ = 
+	`hts
+(
+ARCTYPE_ARP
+);
+
+224 
+wcodg
+ = 1;
+
+226 
+y
+ = 
+	`hts
+(
+ARCTYPE_ARP_OLD
+);
+
+227 
+wcodg
+ = 0;
+
+230 #ifde
+ARCNET_ALLOW_BROKEN_ARP
+
+
+237 i(
+i
+->
+if_ags
+ & 
+IFF_LINK2
+)
+
+238 
+ph
+->
+_o
+ = 
+y
+ - 1;
+
+242 #ifde
+INET6
+
+
+243 
+AF_INET6
+:
+
+244 i(!
+	`nd6_ddr
+(
+i
+, 
+
+, 
+m
+, 
+d
+, &
+ad
+, (adst)))
+
+246 
+y
+ = 
+	`hts
+(
+ARCTYPE_INET6
+);
+
+247 
+wcodg
+ = 1;
+
+251 
+AF_UNSPEC
+:
+
+252 
+h
+ = (c 
+c_hd
+ *)
+d
+->
+_da
+;
+
+253 
+ad
+ = 
+h
+->
+c_dho
+;
+
+254 
+y
+ = 
+h
+->
+c_ty
+;
+
+258 
+	`tf
+("%s: c'hdf%d\n", 
+i
+->
+if_xme
+,
+
+259 
+d
+->
+_my
+);
+
+260 
+	`ndr
+(
+EAFNOSUPPORT
+);
+
+263 i(
+mcy
+)
+
+264 (
+	`loouut
+(
+i
+, 
+mcy
+, 
+d
+, 
+
+);
+
+275 i(
+wcodg
+) {
+
+276 ++
+ac
+->
+ac_qid
+;
+
+278 
+tags
+ = (
+m
+->
+m_pkthdr
+.
+n
+ + 503) / 504;
+
+279 
+fsag
+ = 2 * 
+tags
+ - 3;
+
+280 
+sag
+ = 0;
+
+281 
+rsag
+ = 
+fsag
+;
+
+283 
+sag
+ < 
+fsag
+) {
+
+285 
+m1
+ = 
+	`m_l
+(
+m
+, 504, 
+M_DONTWAIT
+);
+
+286 i(
+m1
+ == 0)
+
+287 
+	`ndr
+(
+ENOBUFS
+);
+
+289 
+	`M_PREPEND
+(
+m
+, 
+ARC_HDRNEWLEN
+, 
+M_DONTWAIT
+);
+
+290 i(
+m
+ == 0)
+
+291 
+	`ndr
+(
+ENOBUFS
+);
+
+292 
+ah
+ = 
+	`mtod
+(
+m
+, 
+c_hd
+ *);
+
+293 
+ah
+->
+c_ty
+ = 
+y
+;
+
+294 
+ah
+->
+c_dho
+ = 
+ad
+;
+
+295 
+ah
+->
+c_sho
+ = 
+mylf
+;
+
+296 
+ah
+->
+c_ag
+ = 
+rsag
+;
+
+297 
+ah
+->
+c_qid
+ = 
+ac
+->
+ac_qid
+;
+
+299 i((
+r
+ = 
+	`ifq_queue
+(
+i
+, 
+m
+ 
+ALTQ_COMMA
+
+
+300 
+	`ALTQ_DECL
+(&
+pkr
+))) != 0)
+
+301  (
+r
+);
+
+303 
+m
+ = 
+m1
+;
+
+304 
+sag
+ += 2;
+
+305 
+rsag
+ = 
+sag
+;
+
+307 
+m1
+ = 
+NULL
+;
+
+312 i((
+m
+->
+m_pkthdr
+.
+n
+ >=
+
+313 
+ARC_MIN_FORBID_LEN
+ - 
+ARC_HDRNEWLEN
+ + 2) &&
+
+314 (
+m
+->
+m_pkthdr
+.
+n
+ <=
+
+315 
+ARC_MAX_FORBID_LEN
+ - 
+ARC_HDRNEWLEN
+ + 2)) {
+
+317 
+	`M_PREPEND
+(
+m
+, 
+ARC_HDRNEWLEN_EXC
+, 
+M_DONTWAIT
+);
+
+318 i(
+m
+ == 0)
+
+319 
+	`ndr
+(
+ENOBUFS
+);
+
+320 
+ah
+ = 
+	`mtod
+(
+m
+, 
+c_hd
+ *);
+
+321 
+ah
+->
+c_ag
+ = 0xFF;
+
+322 
+ah
+->
+c_qid
+ = 0xFFFF;
+
+323 
+ah
+->
+c_ty2
+ = 
+y
+;
+
+324 
+ah
+->
+c_ag2
+ = 
+sag
+;
+
+325 
+ah
+->
+c_qid2
+ = 
+ac
+->
+ac_qid
+;
+
+327 
+	`M_PREPEND
+(
+m
+, 
+ARC_HDRNEWLEN
+, 
+M_DONTWAIT
+);
+
+328 i(
+m
+ == 0)
+
+329 
+	`ndr
+(
+ENOBUFS
+);
+
+330 
+ah
+ = 
+	`mtod
+(
+m
+, 
+c_hd
+ *);
+
+331 
+ah
+->
+c_ag
+ = 
+sag
+;
+
+332 
+ah
+->
+c_qid
+ = 
+ac
+->
+ac_qid
+;
+
+335 
+ah
+->
+c_dho
+ = 
+ad
+;
+
+336 
+ah
+->
+c_sho
+ = 
+mylf
+;
+
+337 
+ah
+->
+c_ty
+ = 
+y
+;
+
+339 
+	`M_PREPEND
+(
+m
+, 
+ARC_HDRLEN
+, 
+M_DONTWAIT
+);
+
+340 i(
+m
+ == 0)
+
+341 
+	`ndr
+(
+ENOBUFS
+);
+
+342 
+ah
+ = 
+	`mtod
+(
+m
+, 
+c_hd
+ *);
+
+343 
+ah
+->
+c_ty
+ = 
+y
+;
+
+344 
+ah
+->
+c_dho
+ = 
+ad
+;
+
+345 
+ah
+->
+c_sho
+ = 
+mylf
+;
+
+348  
+	`ifq_queue
+(
+i
+, 
+m
+ 
+ALTQ_COMMA
+ 
+	`ALTQ_DECL
+(&
+pkr
+));
+
+350 
+bad
+:
+
+351 i(
+m1
+)
+
+352 
+	`m_m
+(
+m1
+);
+
+353 i(
+m
+)
+
+354 
+	`m_m
+(
+m
+);
+
+355  (
+r
+);
+
+356 
+	}
+}
+
+363 
+mbuf
+ *
+
+364 
+	$c_deag
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+)
+
+366 
+c_hd
+ *
+ah
+, *
+ah1
+;
+
+367 
+ccom
+ *
+ac
+;
+
+368 
+ac_ag
+ *
+af
+;
+
+369 
+mbuf
+ *
+m1
+;
+
+370 c *
+s
+;
+
+371 
+w
+;
+
+372 
+u_ch
+ 
+c
+, 
+d
+, 
+typ
+;
+
+374 
+ac
+ = (
+ccom
+ *)
+i
+;
+
+376 i(
+m
+->
+m_n
+ < 
+ARC_HDRNEWLEN
+) {
+
+377 
+m
+ = 
+	`m_puup
+(m, 
+ARC_HDRNEWLEN
+);
+
+378 i(
+m
+ =
+NULL
+) {
+
+379 ++
+i
+->
+if_s
+;
+
+380  
+NULL
+;
+
+384 
+ah
+ = 
+	`mtod
+(
+m
+, 
+c_hd
+ *);
+
+385 
+typ
+ = 
+ah
+->
+c_ty
+;
+
+387 i(!
+	`c_ihds
+(
+typ
+))
+
+388  
+m
+;
+
+390 
+c
+ = 
+ah
+->
+c_sho
+;
+
+391 
+d
+ = 
+ah
+->
+c_dho
+;
+
+393 i(
+ah
+->
+c_ag
+ == 0xff) {
+
+394 
+	`m_adj
+(
+m
+, 4);
+
+396 i(
+m
+->
+m_n
+ < 
+ARC_HDRNEWLEN
+) {
+
+397 
+m
+ = 
+	`m_puup
+(m, 
+ARC_HDRNEWLEN
+);
+
+398 i(
+m
+ =
+NULL
+) {
+
+399 ++
+i
+->
+if_s
+;
+
+400  
+NULL
+;
+
+404 
+ah
+ = 
+	`mtod
+(
+m
+, 
+c_hd
+ *);
+
+407 
+af
+ = &
+ac
+->
+ac_agb
+[
+c
+];
+
+408 
+m1
+ = 
+af
+->
+af_ck
+;
+
+409 
+s
+ = "debug coderror";
+
+411 i(
+ah
+->
+c_ag
+ & 1) {
+
+417 i(
+m1
+ !
+NULL
+)
+
+418 
+	`m_m
+(
+m1
+);
+
+420 
+af
+->
+af_ck
+ = 
+m
+;
+
+421 
+m1
+ = 
+m
+;
+
+422 
+af
+->
+af_maxag
+ = 
+ah
+->
+c_ag
+;
+
+423 
+af
+->
+af_
+ = 0;
+
+424 
+af
+->
+af_qid
+ = 
+ah
+->
+c_qid
+;
+
+426  
+NULL
+;
+
+430 i(
+ah
+->
+c_ag
+ == 0)
+
+431  
+m
+;
+
+434 i(
+m1
+ =
+NULL
+) {
+
+435 
+s
+ = "no first frag";
+
+436 
+outofq
+;
+
+439 
+ah1
+ = 
+	`mtod
+(
+m1
+, 
+c_hd
+ *);
+
+441 i(
+ah
+->
+c_qid
+ !
+ah1
+->arc_seqid) {
+
+442 
+s
+ = "seqid differs";
+
+443 
+outofq
+;
+
+446 i(
+typ
+ !
+ah1
+->
+c_ty
+) {
+
+447 
+s
+ = "type differs";
+
+448 
+outofq
+;
+
+451 i(
+d
+ !
+ah1
+->
+c_dho
+) {
+
+452 
+s
+ = "dest host differs";
+
+453 
+outofq
+;
+
+458 i(
+ah
+->
+c_ag
+ =
+af
+->
+af_
+) {
+
+459 
+	`m_m
+(
+m
+);
+
+460  
+NULL
+;
+
+463 i(
+ah
+->
+c_ag
+ =
+af
+->
+af_
+ + 2) {
+
+465 
+af
+->
+af_
+ = 
+ah
+->
+c_ag
+;
+
+466 
+	`m_adj
+(
+m
+, 
+ARC_HDRNEWLEN
+);
+
+473 
+w
+ = 
+m
+->
+m_pkthdr
+.
+n
+;
+
+475 
+	`m_t
+(
+m1
+, 
+m
+);
+
+477 
+m1
+->
+m_pkthdr
+.
+n
+ +
+w
+;
+
+480 i(
+af
+->
+af_
+ >f->
+af_maxag
+) {
+
+481 
+af
+->
+af_ck
+ = 
+NULL
+;
+
+482  (
+m1
+);
+
+484  
+NULL
+;
+
+486 
+s
+ = "othereason";
+
+489 
+outofq
+:
+
+490 i(
+m1
+) {
+
+491 
+	`m_m
+(
+m1
+);
+
+492 
+af
+->
+af_ck
+ = 
+NULL
+;
+
+495 i(
+m
+)
+
+496 
+	`m_m
+(
+m
+);
+
+498 
+	`log
+(
+LOG_INFO
+,"%s: got out of seq.acket: %s\n",
+
+499 
+i
+->
+if_xme
+, 
+s
+);
+
+501  
+NULL
+;
+
+502 
+	}
+}
+
+512 
+	$c_ihds
+(
+ut8_t
+ 
+ty
+)
+
+514  (
+ty
+ !
+ARCTYPE_IP_OLD
+ &&
+
+515 
+ty
+ !
+ARCTYPE_ARP_OLD
+ &&
+
+516 
+ty
+ !
+ARCTYPE_DIAGNOSE
+);
+
+517 
+	}
+}
+
+525 
+	$c_put
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+)
+
+527 
+pktqueue_t
+ *
+pktq
+ = 
+NULL
+;
+
+528 
+c_hd
+ *
+ah
+;
+
+529 
+ifqueue
+ *
+q
+;
+
+530 
+ut8_t
+ 
+y
+;
+
+531 
+i
+ = 0;
+
+532 
+s
+;
+
+534 i((
+i
+->
+if_ags
+ & 
+IFF_UP
+) == 0) {
+
+535 
+	`m_m
+(
+m
+);
+
+540 
+m
+ = 
+	`c_deag
+(
+i
+, m);
+
+541 i(
+m
+ =
+NULL
+)
+
+544 
+ah
+ = 
+	`mtod
+(
+m
+, 
+c_hd
+ *);
+
+546 
+i
+->
+if_ibys
+ +
+m
+->
+m_pkthdr
+.
+n
+;
+
+548 i(
+cbrdaddr
+ =
+ah
+->
+c_dho
+) {
+
+549 
+m
+->
+m_ags
+ |
+M_BCAST
+|
+M_MCAST
+;
+
+550 
+i
+->
+if_ims
+++;
+
+553 
+y
+ = 
+ah
+->
+c_ty
+;
+
+554 
+y
+) {
+
+555 #ifde
+INET
+
+
+556 
+ARCTYPE_IP
+:
+
+557 
+	`m_adj
+(
+m
+, 
+ARC_HDRNEWLEN
+);
+
+558 
+pktq
+ = 
+_pktq
+;
+
+561 
+ARCTYPE_IP_OLD
+:
+
+562 
+	`m_adj
+(
+m
+, 
+ARC_HDRLEN
+);
+
+563 
+pktq
+ = 
+_pktq
+;
+
+566 
+ARCTYPE_ARP
+:
+
+567 
+	`m_adj
+(
+m
+, 
+ARC_HDRNEWLEN
+);
+
+568 
+i
+ = 
+NETISR_ARP
+;
+
+569 
+q
+ = &
+pq
+;
+
+570 #ifde
+ARCNET_ALLOW_BROKEN_ARP
+
+
+571 
+	`mtod
+(
+m
+, 
+phdr
+ *)->
+_o
+ = 
+	`hts
+(
+ETHERTYPE_IP
+);
+
+575 
+ARCTYPE_ARP_OLD
+:
+
+576 
+	`m_adj
+(
+m
+, 
+ARC_HDRLEN
+);
+
+577 
+i
+ = 
+NETISR_ARP
+;
+
+578 
+q
+ = &
+pq
+;
+
+579 #ifde
+ARCNET_ALLOW_BROKEN_ARP
+
+
+580 
+	`mtod
+(
+m
+, 
+phdr
+ *)->
+_o
+ = 
+	`hts
+(
+ETHERTYPE_IP
+);
+
+584 #ifde
+INET6
+
+
+585 
+ARCTYPE_INET6
+:
+
+586 
+	`m_adj
+(
+m
+, 
+ARC_HDRNEWLEN
+);
+
+587 
+pktq
+ = 
+6_pktq
+;
+
+591 
+	`m_m
+(
+m
+);
+
+595 
+s
+ = 
+	`
+();
+
+596 i(
+	`__edi_ue
+(
+pktq
+)) {
+
+597 i(
+	`__edi_l
+(!
+	`pktq_queue
+(
+pktq
+, 
+m
+, 0))) {
+
+598 
+	`m_m
+(
+m
+);
+
+600 
+	`lx
+(
+s
+);
+
+603 i(
+	`IF_QFULL
+(
+q
+)) {
+
+604 
+	`IF_DROP
+(
+q
+);
+
+605 
+	`m_m
+(
+m
+);
+
+607 
+	`IF_ENQUEUE
+(
+q
+, 
+m
+);
+
+608 
+	`schedti
+(
+i
+);
+
+610 
+	`lx
+(
+s
+);
+
+611 
+	}
+}
+
+617 
+	$c_rtf
+(
+ut8_t
+ *
+
+)
+
+619 
+cbuf
+[3];
+
+620 *
+
+ = 
+cbuf
+;
+
+622 *
+
+++ = 
+hexdigs
+[*
+
+ >> 4];
+
+623 *
+
+++ = 
+hexdigs
+[*
+
+++ & 0xf];
+
+624 *
+
+ = 0;
+
+625  (
+cbuf
+);
+
+626 
+	}
+}
+
+632 
+	$c_iach
+(
+i
+ *
+i
+, 
+ut8_t
+ 
+a
+)
+
+634 
+ccom
+ *
+ac
+;
+
+636 
+i
+->
+if_ty
+ = 
+IFT_ARCNET
+;
+
+637 
+i
+->
+if_add
+ = 1;
+
+638 
+i
+->
+if_hd
+ = 
+ARC_HDRLEN
+;
+
+639 
+i
+->
+if_d
+ = 
+DLT_ARCNET
+;
+
+640 i(
+i
+->
+if_ags
+ & 
+IFF_BROADCAST
+)
+
+641 
+i
+->
+if_ags
+ |
+IFF_MULTICAST
+|
+IFF_ALLMULTI
+;
+
+642 i(
+i
+->
+if_ags
+ & 
+IFF_LINK0
+ && 
+c_mtu
+ > 
+ARC_PHDS_MAXMTU
+)
+
+643 
+	`log
+(
+LOG_ERR
+,
+
+645 
+i
+->
+if_xme
+, 
+c_mtu
+, 
+ARC_PHDS_MAXMTU
+);
+
+647 
+i
+->
+if_ouut
+ = 
+c_ouut
+;
+
+648 
+i
+->
+if_put
+ = 
+c_put
+;
+
+649 
+ac
+ = (
+ccom
+ *)
+i
+;
+
+650 
+ac
+->
+ac_qid
+ = (
+time_cd
+) & 0xFFFF;
+
+651 i(
+a
+ == 0) {
+
+653 
+	`log
+(
+LOG_ERR
+,"%s:inkddress 0eserved for broadcasts. Please change itnd ifconfig %s down up\n",
+
+654 
+i
+->
+if_xme
+, ifp->if_xname);
+
+656 
+	`if_ch
+(
+i
+);
+
+657 
+	`if_t_dl
+(
+i
+, &
+a
+, ), 
+ue
+);
+
+659 
+i
+->
+if_brdaddr
+ = &
+cbrdaddr
+;
+
+661 
+	`bpf_ch
+(
+i
+, 
+DLT_ARCNET
+, 
+ARC_HDRLEN
+);
+
+662 
+	}
+}
+
+	@if_arp.h
+
+34 #ide
+_NET_IF_ARP_H_
+
+
+35 
+	#_NET_IF_ARP_H_
+
+
+	)
+
+46 
+	sphdr
+ {
+
+47 
+ut16_t
+ 
+	m_hrd
+;
+
+48 
+	#ARPHRD_ETHER
+ 1
+
+	)
+
+49 
+	#ARPHRD_IEEE802
+ 6
+
+	)
+
+50 
+	#ARPHRD_ARCNET
+ 7
+
+	)
+
+51 
+	#ARPHRD_FRELAY
+ 15
+
+	)
+
+52 
+	#ARPHRD_STRIP
+ 23
+
+	)
+
+53 
+	#ARPHRD_IEEE1394
+ 24
+
+	)
+
+54 
+ut16_t
+ 
+	m_o
+;
+
+55 
+ut8_t
+ 
+	m_h
+;
+
+56 
+ut8_t
+ 
+	m_n
+;
+
+57 
+ut16_t
+ 
+	m_
+;
+
+58 
+	#ARPOP_REQUEST
+ 1
+
+	)
+
+59 
+	#ARPOP_REPLY
+ 2
+
+	)
+
+60 
+	#ARPOP_REVREQUEST
+ 3
+
+	)
+
+61 
+	#ARPOP_REVREPLY
+ 4
+
+	)
+
+62 
+	#ARPOP_INVREQUEST
+ 8
+
+	)
+
+63 
+	#ARPOP_INVREPLY
+ 9
+
+	)
+
+68 #ifde
+COMMENT_ONLY
+
+
+69 
+ut8_t
+ 
+	m_sha
+[];
+
+70 
+ut8_t
+ 
+	m_a
+[];
+
+71 
+ut8_t
+ 
+	m_tha
+[];
+
+72 
+ut8_t
+ 
+	m_a
+[];
+
+74 
+	#_sha
+(
+
+(((*)(p)+1))+0)
+
+	)
+
+75 
+	#_a
+(
+
+(((*)(p)+1))+p)->
+_h
+)
+
+	)
+
+76 
+	#_tha
+(
+
+) \
+
+77 (
+	`ohs
+((
+
+)->
+_hrd
+=
+ARPHRD_IEEE1394
+ \
+
+78 ? 
+NULL
+ : (((*)((
+
+)+1))+p)->
+_h
++p)->
+_n
+))
+
+	)
+
+79 
+	#_a
+(
+
+) \
+
+80 (
+	`ohs
+((
+
+)->
+_hrd
+=
+ARPHRD_IEEE1394
+ \
+
+81 ? (((*)((
+
+)+1))+p)->
+_h
++p)->
+_n
+) \
+
+82 : (((*)((
+
+)+1))+p)->
+_h
++p)->
+_n
++p)->_h))
+
+	)
+
+83 } 
+	g__cked
+;
+
+89 
+	seq
+ {
+
+90 
+sockaddr
+ 
+	mp_
+;
+
+91 
+sockaddr
+ 
+	mp_ha
+;
+
+92 
+	mp_ags
+;
+
+95 
+	#ATF_INUSE
+ 0x01
+
+	)
+
+96 
+	#ATF_COM
+ 0x02
+
+	)
+
+97 
+	#ATF_PERM
+ 0x04
+
+	)
+
+98 
+	#ATF_PUBL
+ 0x08
+
+	)
+
+99 
+	#ATF_USETRAILERS
+ 0x10
+
+	)
+
+104 
+	#ARP_STAT_SNDTOTAL
+ 0
+
+	)
+
+105 
+	#ARP_STAT_SNDREPLY
+ 1
+
+	)
+
+106 
+	#ARP_STAT_SENDREQUEST
+ 2
+
+	)
+
+107 
+	#ARP_STAT_RCVTOTAL
+ 3
+
+	)
+
+108 
+	#ARP_STAT_RCVREQUEST
+ 4
+
+	)
+
+109 
+	#ARP_STAT_RCVREPLY
+ 5
+
+	)
+
+110 
+	#ARP_STAT_RCVMCAST
+ 6
+
+	)
+
+111 
+	#ARP_STAT_RCVBADPROTO
+ 7
+
+	)
+
+112 
+	#ARP_STAT_RCVBADLEN
+ 8
+
+	)
+
+113 
+	#ARP_STAT_RCVZEROTPA
+ 9
+
+	)
+
+114 
+	#ARP_STAT_RCVZEROSPA
+ 10
+
+	)
+
+115 
+	#ARP_STAT_RCVNOINT
+ 11
+
+	)
+
+116 
+	#ARP_STAT_RCVLOCALSHA
+ 12
+
+	)
+
+117 
+	#ARP_STAT_RCVBCASTSHA
+ 13
+
+	)
+
+118 
+	#ARP_STAT_RCVLOCALSPA
+ 14
+
+	)
+
+119 
+	#ARP_STAT_RCVOVERPERM
+ 15
+
+	)
+
+120 
+	#ARP_STAT_RCVOVERINT
+ 16
+
+	)
+
+121 
+	#ARP_STAT_RCVOVER
+ 17
+
+	)
+
+122 
+	#ARP_STAT_RCVLENCHG
+ 18
+
+	)
+
+123 
+	#ARP_STAT_DFRTOTAL
+ 19
+
+	)
+
+124 
+	#ARP_STAT_DFRSENT
+ 20
+
+	)
+
+125 
+	#ARP_STAT_DFRDROPPED
+ 21
+
+	)
+
+126 
+	#ARP_STAT_ALLOCFAIL
+ 22
+
+	)
+
+128 
+	#ARP_NSTATS
+ 23
+
+	)
+
+	@if_atm.h
+
+32 #ide
+_NET_IF_ATM_H_
+
+
+33 
+	#_NET_IF_ATM_H_
+
+
+	)
+
+35 #i(
+defed
+(
+__FeBSD__
+|| defed(
+__bsdi__
+)&& defed(
+KERNEL
+)
+
+36 #ide
+_KERNEL
+
+
+37 
+	#_KERNEL
+
+
+	)
+
+41 #ide
+NO_ATM_PVCEXT
+
+
+46 
+	#ATM_PVCEXT
+
+
+	)
+
+49 #i
+defed
+(
+__NBSD__
+|| defed(
+__OnBSD__
+|| defed(
+__bsdi__
+)
+
+50 
+	#RTALLOC1
+(
+A
+,
+B
+
+	`loc1
+((A),(B))
+
+	)
+
+51 #i
+defed
+(
+__FeBSD__
+)
+
+52 
+	#RTALLOC1
+(
+A
+,
+B
+
+	`loc1
+((A),(B),0UL)
+
+	)
+
+59 
+	sm_pudohdr
+ {
+
+60 
+ut8_t
+ 
+	mm_ph
+[4];
+
+63 
+	#ATM_PH_FLAGS
+(
+X
+((X)->
+m_ph
+[0])
+
+	)
+
+64 
+	#ATM_PH_VPI
+(
+X
+((X)->
+m_ph
+[1])
+
+	)
+
+65 
+	#ATM_PH_VCI
+(
+X
+((((X)->
+m_ph
+[2]<< 8| ((X)->m_ph[3]))
+
+	)
+
+66 
+	#ATM_PH_SETVCI
+(
+X
+,
+V
+) { \
+
+67 (
+X
+)->
+m_ph
+[2] = ((
+V
+) >> 8) & 0xff; \
+
+68 (
+X
+)->
+m_ph
+[3] = ((
+V
+) & 0xff); \
+
+69 }
+
+	)
+
+71 
+	#ATM_PH_AAL5
+ 0x01
+
+	)
+
+72 
+	#ATM_PH_LLCSNAP
+ 0x02
+
+	)
+
+74 #ifde
+ATM_PVCEXT
+
+
+75 
+	#ATM_PH_INERNAL
+ 0x20
+
+	)
+
+77 
+	#ATM_PH_DRIVER7
+ 0x40
+
+	)
+
+78 
+	#ATM_PH_DRIVER8
+ 0x80
+
+	)
+
+80 
+	#ATMMTU
+ 9180
+
+	)
+
+85 
+	#SIOCRAWATM
+ 
+	`_IOWR
+('a', 122, 
+
+	)
+
+88 
+	sm_pudoiol
+ {
+
+89 
+m_pudohdr
+ 
+	mh
+;
+
+90 *
+	mrxhd
+;
+
+92 
+	#SIOCATMENA
+ 
+	`_IOWR
+('a', 123, 
+m_pudoiol
+
+
+	)
+
+93 
+	#SIOCATMDIS
+ 
+	`_IOWR
+('a', 124, 
+m_pudoiol
+
+
+	)
+
+95 #ifde
+ATM_PVCEXT
+
+
+98 
+	spvxq
+ {
+
+100 
+	mpvc_iame
+[
+IFNAMSIZ
+];
+
+101 
+m_pudohdr
+ 
+	mpvc_h
+;
+
+102 
+m_pudohdr
+ 
+	mpvc_jot
+;
+
+104 
+	mpvc_p
+;
+
+108 
+	#SIOCSPVCTX
+ 
+	`_IOWR
+('i', 95, 
+pvxq
+)
+
+	)
+
+109 
+	#SIOCGPVCTX
+ 
+	`_IOWR
+('i', 96, 
+pvxq
+)
+
+	)
+
+110 
+	#SIOCSPVCSIF
+ 
+	`_IOWR
+('i', 97, 
+ieq
+)
+
+	)
+
+111 
+	#SIOCGPVCSIF
+ 
+	`_IOWR
+('i', 98, 
+ieq
+)
+
+	)
+
+119 
+	#ATMLLC_HDR
+ "\252\252\3\0\0\0"
+
+	)
+
+120 
+	smc
+ {
+
+121 
+ut8_t
+ 
+	mchdr
+[6];
+
+122 
+ut8_t
+ 
+	mty
+[2];
+
+123 } 
+	g__cked
+;
+
+126 
+	#ATM_LLC_TYPE
+(
+X
+(((X)->
+ty
+[0] << 8| ((X)->ty[1]))
+
+	)
+
+127 
+	#ATM_LLC_SETTYPE
+(
+X
+,
+V
+) { \
+
+128 (
+X
+)->
+ty
+[0] = ((
+V
+) >> 8) & 0xff; \
+
+129 (
+X
+)->
+ty
+[1] = ((
+V
+) & 0xff); \
+
+130 }
+
+	)
+
+132 #ifde
+_KERNEL
+
+
+133 
+m_iach
+(
+i
+ *);
+
+134 
+m_put
+(
+i
+ *, 
+m_pudohdr
+ *,
+
+135 
+mbuf
+ *, *);
+
+136 
+m_ouut
+(
+i
+ *, 
+mbuf
+ *, c 
+sockaddr
+ *,
+
+137 
+y
+ *);
+
+139 #ifde
+ATM_PVCEXT
+
+
+140 #ifde
+_KERNEL
+
+
+141 
+	~<sys/queue.h
+>
+
+150 
+	spvcsif
+ {
+
+154 
+i
+ 
+	msif_if
+;
+
+155 
+m_pudohdr
+ 
+	msif_h
+;
+
+156 
+	msif_vci
+;
+
+157 
+LIST_ENTRY
+(
+pvcsif
+
+	msif_lks
+;
+
+159 
+i
+ *
+pvcsif_loc
+();
+
+	@if_atmsubr.c
+
+32 
+	~<sys/cdefs.h
+>
+
+33 
+__KERNEL_RCSID
+(0, "$NetBSD: if_atmsubr.c,v 1.52 2014/06/05 23:48:16mind Exp $");
+
+35 
+	~"t_.h
+"
+
+36 
+	~"t_geway.h
+"
+
+37 
+	~"t_tm.h
+"
+
+40 
+	~<sys/m.h
+>
+
+41 
+	~<sys/sym.h
+>
+
+42 
+	~<sys/kl.h
+>
+
+43 
+	~<sys/mloc.h
+>
+
+44 
+	~<sys/mbuf.h
+>
+
+45 
+	~<sys/osw.h
+>
+
+46 
+	~<sys/sock.h
+>
+
+47 
+	~<sys/iol.h
+>
+
+48 
+	~<sys/o.h
+>
+
+49 
+	~<sys/syog.h
+>
+
+51 
+	~<sys/u.h
+>
+
+53 
+	~<t/if.h
+>
+
+54 
+	~<t/ti.h
+>
+
+55 
+	~<t/rou.h
+>
+
+56 
+	~<t/if_dl.h
+>
+
+57 
+	~<t/if_tys.h
+>
+
+58 
+	~<t/if_m.h
+>
+
+59 
+	~<t/htys.h
+>
+
+61 
+	~<t/bpf.h
+>
+
+63 
+	~<t/.h
+>
+
+64 
+	~<t/if_m.h
+>
+
+66 #i
+defed
+(
+INET
+|| defed(
+INET6
+)
+
+67 
+	~<t/_v.h
+>
+
+69 #ifde
+NATM
+
+
+70 
+	~<m/tm.h
+>
+
+73 
+	#ndr
+(
+e
+{ 
+r
+ = (e); 
+bad
+;}
+
+	)
+
+91 
+	$m_ouut
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m0
+, c 
+sockaddr
+ *
+d
+,
+
+92 
+y
+ *
+0
+)
+
+94 
+ut16_t
+ 
+y
+ = 0;
+
+95 
+r
+ = 0, 
+sz
+;
+
+96 
+m_pudohdr
+ 
+md
+, *
+ad
+;
+
+97 
+mbuf
+ *
+m
+ = 
+m0
+;
+
+98 
+y
+ *
+
+;
+
+99 
+mc
+ *atmllc;
+
+100 
+ut32_t
+ 
+m_ags
+;
+
+101 
+	`ALTQ_DECL
+(
+tq_pkr
+ 
+pkr
+;)
+
+103 i((
+i
+->
+if_ags
+ & (
+IFF_UP
+|
+IFF_RUNNING
+)) != (IFF_UP|IFF_RUNNING))
+
+104 
+	`ndr
+(
+ENETDOWN
+);
+
+110 
+	`IFQ_CLASSIFY
+(&
+i
+->
+if_d
+, 
+m
+,
+
+111 (
+d
+ !
+NULL
+ ? d->
+_my
+ : 
+AF_UNSPEC
+), &
+pkr
+);
+
+116 i((
+
+ = 
+0
+!
+NULL
+) {
+
+118 i((
+
+->
+_ags
+ & 
+RTF_UP
+) == 0) {
+
+119 i((
+0
+ = 
+
+ = 
+	`RTALLOC1
+(
+d
+, 0)!
+NULL
+)
+
+120 
+
+->
+_ft
+--;
+
+122 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+125 i(
+
+->
+_ags
+ & 
+RTF_GATEWAY
+) {
+
+126 i(
+
+->
+_gwrou
+ == 0)
+
+127 
+lookup
+;
+
+128 i(((
+
+ =t->
+_gwrou
+)->
+_ags
+ & 
+RTF_UP
+) == 0) {
+
+129 
+	`
+(
+
+);
+0
+;
+
+130 
+lookup
+: 
+
+->
+_gwrou
+ = 
+	`RTALLOC1
+t->
+_geway
+, 0);
+
+131 i((
+
+ =t->
+_gwrou
+) == 0)
+
+132 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+143 i(
+d
+) {
+
+144 
+d
+->
+_my
+) {
+
+145 #ifde
+INET
+
+
+146 
+AF_INET
+:
+
+148 #ifde
+INET6
+
+
+149 
+AF_INET6
+:
+
+151 #i
+	`defed
+(
+INET
+|| defed(
+INET6
+)
+
+152 i(
+d
+->
+_my
+ =
+AF_INET
+)
+
+153 
+y
+ = 
+ETHERTYPE_IP
+;
+
+155 
+y
+ = 
+ETHERTYPE_IPV6
+;
+
+156 #ifde
+ATM_PVCEXT
+
+
+157 i(
+i
+->
+if_ags
+ & 
+IFF_POINTOPOINT
+) {
+
+159 
+pvcsif
+ *pvcsi(pvcsi*)
+i
+;
+
+160 
+md
+ = 
+pvcsif
+->
+sif_h
+;
+
+164 i(!
+	`msve
+(
+
+, 
+m
+, 
+d
+, &
+md
+)) {
+
+165 
+m
+ = 
+NULL
+;
+
+167 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+174 
+AF_UNSPEC
+:
+
+180 
+	`memy
+(&
+md
+, 
+d
+->
+_da
+, (atmdst));
+
+184 #i
+	`defed
+(
+__NBSD__
+|| defed(
+__OnBSD__
+)
+
+185 
+	`tf
+("%s: c'hdf%d\n", 
+i
+->
+if_xme
+,
+
+186 
+d
+->
+_my
+);
+
+187 #i
+	`defed
+(
+__FeBSD__
+|| defed(
+__bsdi__
+)
+
+188 
+	`tf
+("%s%d: c'hdf%d\n", 
+i
+->
+if_me
+,
+
+189 
+i
+->
+if_un
+, 
+d
+->
+_my
+);
+
+191 
+	`ndr
+(
+EAFNOSUPPORT
+);
+
+197 
+sz
+ = (
+md
+);
+
+198 
+m_ags
+ = 
+	`ATM_PH_FLAGS
+(&
+md
+);
+
+199 i(
+m_ags
+ & 
+ATM_PH_LLCSNAP
+
+sz
+ += 8;
+
+200 
+	`M_PREPEND
+(
+m
+, 
+sz
+, 
+M_DONTWAIT
+);
+
+201 i(
+m
+ == 0)
+
+202 
+	`ndr
+(
+ENOBUFS
+);
+
+203 
+ad
+ = 
+	`mtod
+(
+m
+, 
+m_pudohdr
+ *);
+
+204 *
+ad
+ = 
+md
+;
+
+205 i(
+m_ags
+ & 
+ATM_PH_LLCSNAP
+) {
+
+206 
+mc
+ = (m*)(
+ad
+ + 1);
+
+207 
+	`memy
+(
+mc
+->
+chdr
+, 
+ATMLLC_HDR
+,
+
+208 (
+mc
+->
+chdr
+));
+
+209 
+	`ATM_LLC_SETTYPE
+(
+mc
+, 
+y
+);
+
+213  
+	`ifq_queue
+(
+i
+, 
+m
+ 
+ALTQ_COMMA
+ 
+	`ALTQ_DECL
+(&
+pkr
+));
+
+215 
+bad
+:
+
+216 i(
+m
+)
+
+217 
+	`m_m
+(
+m
+);
+
+218  (
+r
+);
+
+219 
+	}
+}
+
+226 
+	$m_put
+(
+i
+ *
+i
+, 
+m_pudohdr
+ *
+ah
+, 
+mbuf
+ *
+m
+,
+
+227 *
+rxhd
+)
+
+229 
+pktqueue_t
+ *
+pktq
+ = 
+NULL
+;
+
+230 
+ut16_t
+ 
+y
+ = 
+ETHERTYPE_IP
+;
+
+232 i((
+i
+->
+if_ags
+ & 
+IFF_UP
+) == 0) {
+
+233 
+	`m_m
+(
+m
+);
+
+236 
+i
+->
+if_ibys
+ +
+m
+->
+m_pkthdr
+.
+n
+;
+
+238 i(
+rxhd
+) {
+
+239 #ifde
+NATM
+
+
+240 
+tmpcb
+ *
+cb
+ = 
+rxhd
+;
+
+241 
+ifqueue
+ *
+q
+;
+
+242 
+s
+, 
+i
+ = 0;
+
+244 
+s
+ = 
+	`
+();
+
+245 
+cb
+->
+cb_q
+++;
+
+246 
+	`lx
+(
+s
+);
+
+247 
+i
+ = 
+NETISR_NATM
+;
+
+248 
+q
+ = &
+tmq
+;
+
+249 
+m
+->
+m_pkthdr
+.
+rcvif
+ = 
+rxhd
+;
+
+251 
+s
+ = 
+	`
+();
+
+252 i(
+	`IF_QFULL
+(
+q
+)) {
+
+253 
+	`IF_DROP
+(
+q
+);
+
+254 
+	`m_m
+(
+m
+);
+
+256 
+	`IF_ENQUEUE
+(
+q
+, 
+m
+);
+
+257 
+	`schedti
+(
+i
+);
+
+259 
+	`lx
+(
+s
+);
+
+261 
+	`tf
+("atm_input: NATM detected butot configured in kernel\n");
+
+262 
+	`m_m
+(
+m
+);
+
+270 i(
+	`ATM_PH_FLAGS
+(
+ah
+& 
+ATM_PH_LLCSNAP
+) {
+
+271 
+mc
+ *
+c
+;
+
+272 i(
+m
+->
+m_n
+ < (*
+c
+&& (m = 
+	`m_puup
+(m, (*alc))) == 0)
+
+274 
+c
+ = 
+	`mtod
+(
+m
+, 
+mc
+ *);
+
+275 i(
+	`memcmp
+(
+c
+, 
+ATMLLC_HDR
+, 6)) {
+
+276 #i
+	`defed
+(
+__NBSD__
+|| defed(
+__OnBSD__
+)
+
+277 
+	`tf
+("%s:ecv'd invalid LLC/SNAP frame [vp=%d,vc=%d]\n",
+
+278 
+i
+->
+if_xme
+, 
+	`ATM_PH_VPI
+(
+ah
+), 
+	`ATM_PH_VCI
+(ah));
+
+279 #i
+	`defed
+(
+__FeBSD__
+|| defed(
+__bsdi__
+)
+
+280 
+	`tf
+("%s%d:ecv'd invalid LLC/SNAP frame [vp=%d,vc=%d]\n",
+
+281 
+i
+->
+if_me
+, i->
+if_un
+, 
+	`ATM_PH_VPI
+(
+ah
+), 
+	`ATM_PH_VCI
+(ah));
+
+283 
+	`m_m
+(
+m
+);
+
+286 
+y
+ = 
+	`ATM_LLC_TYPE
+(
+c
+);
+
+287 
+	`m_adj
+(
+m
+, (*
+c
+));
+
+290 
+y
+) {
+
+291 #ifde
+INET
+
+
+292 
+ETHERTYPE_IP
+:
+
+293 #ifde
+GATEWAY
+
+
+294 i(
+	`ow_fwd
+(
+m
+))
+
+297 
+pktq
+ = 
+_pktq
+;
+
+300 #ifde
+INET6
+
+
+301 
+ETHERTYPE_IPV6
+:
+
+302 #ifde
+GATEWAY
+
+
+303 i(
+	`6ow_fwd
+(&
+m
+))
+
+306 
+pktq
+ = 
+6_pktq
+;
+
+310 
+	`m_m
+(
+m
+);
+
+315 i(
+	`__edi_l
+(!
+	`pktq_queue
+(
+pktq
+, 
+m
+, 0))) {
+
+316 
+	`m_m
+(
+m
+);
+
+318 
+	}
+}
+
+324 
+	$m_iach
+(
+i
+ *
+i
+)
+
+327 
+i
+->
+if_ty
+ = 
+IFT_ATM
+;
+
+328 
+i
+->
+if_add
+ = 0;
+
+329 
+i
+->
+if_hd
+ = 0;
+
+330 
+i
+->
+if_d
+ = 
+DLT_ATM_RFC1483
+;
+
+331 
+i
+->
+if_mtu
+ = 
+ATMMTU
+;
+
+332 
+i
+->
+if_ouut
+ = 
+m_ouut
+;
+
+334 
+i
+->
+if_put
+ = 
+m_put
+;
+
+337 
+	`if_loc_dl
+(
+i
+);
+
+340 
+	`bpf_ch
+(
+i
+, 
+DLT_ATM_RFC1483
+, (
+mc
+));
+
+341 
+	}
+}
+
+343 #ifde
+ATM_PVCEXT
+
+
+345 
+	gpvc_max_numb
+ = 16;
+
+346 
+	gpvc_numb
+ = 0;
+
+348 
+i
+ *
+
+349 
+	$pvcsif_loc
+()
+
+351 
+pvcsif
+ *pvcsif;
+
+353 i(
+pvc_numb
+ >
+pvc_max_numb
+)
+
+354  (
+NULL
+);
+
+355 
+pvcsif
+ = 
+	`mloc
+((pvcsif),
+
+356 
+M_DEVBUF
+, 
+M_WAITOK
+|
+M_ZERO
+);
+
+357 i(
+pvcsif
+ =
+NULL
+)
+
+358  (
+NULL
+);
+
+360 #ifde
+__NBSD__
+
+
+361 
+	`tf
+(
+pvcsif
+->
+sif_if
+.
+if_xme
+, (pvcsif->sif_if.if_xname),
+
+362 "pvc%d", 
+pvc_numb
+++);
+
+364 
+pvcsif
+->
+sif_if
+.
+if_me
+ = "pvc";
+
+365 
+pvcsif
+->
+sif_if
+.
+if_un
+ = 
+pvc_numb
+++;
+
+367  (&
+pvcsif
+->
+sif_if
+);
+
+368 
+	}
+}
+
+	@if_bridge.c
+
+82 
+	~<sys/cdefs.h
+>
+
+83 
+__KERNEL_RCSID
+(0, "$NetBSD: if_bridge.c,v 1.98 2015/04/16 08:54:15 ozaki-r Exp $");
+
+85 #ifde
+_KERNEL_OPT
+
+
+86 
+	~"t_bridge_f.h
+"
+
+87 
+	~"t_.h
+"
+
+90 
+	~<sys/m.h
+>
+
+91 
+	~<sys/kl.h
+>
+
+92 
+	~<sys/mbuf.h
+>
+
+93 
+	~<sys/queue.h
+>
+
+94 
+	~<sys/sock.h
+>
+
+95 
+	~<sys/sockv.h
+>
+
+96 
+	~<sys/sockio.h
+>
+
+97 
+	~<sys/sym.h
+>
+
+98 
+	~<sys/oc.h
+>
+
+99 
+	~<sys/po.h
+>
+
+100 
+	~<sys/kauth.h
+>
+
+101 
+	~<sys/u.h
+>
+
+102 
+	~<sys/g.h
+>
+
+103 
+	~<sys/mux.h
+>
+
+104 
+	~<sys/kmem.h
+>
+
+106 
+	~<t/bpf.h
+>
+
+107 
+	~<t/if.h
+>
+
+108 
+	~<t/if_dl.h
+>
+
+109 
+	~<t/if_tys.h
+>
+
+110 
+	~<t/if_c.h
+>
+
+111 
+	~<t/pktqueue.h
+>
+
+113 
+	~<t/if_h.h
+>
+
+114 
+	~<t/if_bridgev.h
+>
+
+116 #i
+defed
+(
+BRIDGE_IPF
+)
+
+118 
+	~<t/.h
+>
+
+119 
+	~<t/_sym.h
+>
+
+120 
+	~<t/.h
+>
+
+121 
+	~<t/_v.h
+>
+
+122 
+	~<t/_ive.h
+>
+
+124 
+	~<t/6.h
+>
+
+125 
+	~<t6/6_v.h
+>
+
+126 
+	~<t6/6_v.h
+>
+
+127 
+	~<t6/6_ive.h
+>
+
+133 #ide
+BRIDGE_RTHASH_SIZE
+
+
+134 
+	#BRIDGE_RTHASH_SIZE
+ 1024
+
+	)
+
+137 
+	#BRIDGE_RTHASH_MASK
+ (
+BRIDGE_RTHASH_SIZE
+ - 1)
+
+	)
+
+139 
+	~".h
+"
+
+140 #i
+NCARP
+ > 0
+
+141 
+	~<t/.h
+>
+
+142 
+	~<t/_v.h
+>
+
+143 
+	~<t/_.h
+>
+
+149 #ide
+BRIDGE_RTABLE_MAX
+
+
+150 
+	#BRIDGE_RTABLE_MAX
+ 100
+
+	)
+
+156 
+	#BSTP_DEFAULT_MAX_AGE
+ (20 * 256)
+
+	)
+
+157 
+	#BSTP_DEFAULT_HELLO_TIME
+ (2 * 256)
+
+	)
+
+158 
+	#BSTP_DEFAULT_FORWARD_DELAY
+ (15 * 256)
+
+	)
+
+159 
+	#BSTP_DEFAULT_HOLD_TIME
+ (1 * 256)
+
+	)
+
+160 
+	#BSTP_DEFAULT_BRIDGE_PRIORITY
+ 0x8000
+
+	)
+
+161 
+	#BSTP_DEFAULT_PORT_PRIORITY
+ 0x80
+
+	)
+
+162 
+	#BSTP_DEFAULT_PATH_COST
+ 55
+
+	)
+
+167 #ide
+BRIDGE_RTABLE_TIMEOUT
+
+
+168 
+	#BRIDGE_RTABLE_TIMEOUT
+ (20 * 60
+
+	)
+
+174 #ide
+BRIDGE_RTABLE_PRUNE_PERIOD
+
+
+175 
+	#BRIDGE_RTABLE_PRUNE_PERIOD
+ (5 * 60)
+
+	)
+
+178 
+	#BRIDGE_RT_INTR_LOCK
+(
+_sc
+
+	`mux_r
+((_sc)->
+sc_li__lock
+)
+
+	)
+
+179 
+	#BRIDGE_RT_INTR_UNLOCK
+(
+_sc
+
+	`mux_ex
+((_sc)->
+sc_li__lock
+)
+
+	)
+
+180 
+	#BRIDGE_RT_INTR_LOCKED
+(
+_sc
+
+	`mux_owd
+((_sc)->
+sc_li__lock
+)
+
+	)
+
+182 
+	#BRIDGE_RT_LOCK
+(
+_sc
+i((_sc)->
+sc_li_lock
+) \
+
+183 
+	`mux_r
+((
+_sc
+)->
+sc_li_lock
+)
+
+	)
+
+184 
+	#BRIDGE_RT_UNLOCK
+(
+_sc
+i((_sc)->
+sc_li_lock
+) \
+
+185 
+	`mux_ex
+((
+_sc
+)->
+sc_li_lock
+)
+
+	)
+
+186 
+	#BRIDGE_RT_LOCKED
+(
+_sc
+(!(_sc)->
+sc_li_lock
+ || \
+
+187 
+	`mux_owd
+((
+_sc
+)->
+sc_li_lock
+))
+
+	)
+
+189 
+	#BRIDGE_RT_PSZ_PERFORM
+(
+_sc
+) \
+
+190 i((
+_sc
+)->
+sc_li_psz
+ !
+NULL
+) \
+
+191 
+	`prlize_rfm
+((
+_sc
+)->
+sc_li_psz
+);
+
+	)
+
+193 #ifde
+BRIDGE_MPSAFE
+
+
+194 
+	#BRIDGE_RT_RENTER
+(
+__s
+) do { \
+
+195 i(!
+	`u__p
+()) \
+
+196 
+__s
+ = 
+	`prlize_ad_r
+(); \
+
+198 
+__s
+ = 
+	`lhigh
+(); \
+
+199 } 0)
+
+	)
+
+200 
+	#BRIDGE_RT_REXIT
+(
+__s
+) do { \
+
+201 i(!
+	`u__p
+()) \
+
+202 
+	`prlize_ad_ex
+(
+__s
+); \
+
+204 
+	`lx
+(
+__s
+); \
+
+205 } 0)
+
+	)
+
+207 
+	#BRIDGE_RT_RENTER
+(
+__s
+d{ __0; } 0)
+
+	)
+
+208 
+	#BRIDGE_RT_REXIT
+(
+__s
+d{ ()__s; } 0)
+
+	)
+
+211 
+	gbridge_ab_u_riod
+ = 
+BRIDGE_RTABLE_PRUNE_PERIOD
+;
+
+213 
+po
+ 
+	gbridge_node_po
+;
+
+214 
+wk
+ 
+	gbridge_age_wk
+;
+
+216 
+bridgach
+();
+
+218 
+bridge_e_
+(
+if_e
+ *, );
+
+219 
+bridge_e_deroy
+(
+i
+ *);
+
+221 
+bridge_iol
+(
+i
+ *, 
+u_lg
+, *);
+
+222 
+bridge_
+(
+i
+ *);
+
+223 
+bridge_
+(
+i
+ *, );
+
+224 
+bridge_t
+(
+i
+ *);
+
+226 
+bridge_put
+(
+i
+ *, 
+mbuf
+ *);
+
+227 
+bridge_fwd
+(*);
+
+229 
+bridge_tim
+(*);
+
+231 
+bridge_brd
+(
+bridge_soc
+ *, 
+i
+ *,
+
+232 
+mbuf
+ *);
+
+234 
+bridge_upde
+(
+bridge_soc
+ *, c 
+ut8_t
+ *,
+
+235 
+i
+ *, , 
+ut8_t
+);
+
+236 
+i
+ *
+bridge_lookup
+(
+bridge_soc
+ *, c 
+ut8_t
+ *);
+
+237 
+bridge_im
+(
+bridge_soc
+ *);
+
+238 
+bridge_age
+(
+bridge_soc
+ *);
+
+239 
+bridge_age_wk
+(
+wk
+ *, *);
+
+240 
+bridge_ush
+(
+bridge_soc
+ *, );
+
+241 
+bridge_daddr
+(
+bridge_soc
+ *, c 
+ut8_t
+ *);
+
+242 
+bridge_de
+(
+bridge_soc
+ *, 
+i
+ *
+i
+);
+
+244 
+bridge_ab_
+(
+bridge_soc
+ *);
+
+245 
+bridge_ab_fi
+(
+bridge_soc
+ *);
+
+247 
+bridge_node
+ *
+bridge_node_lookup
+(
+bridge_soc
+ *,
+
+248 c 
+ut8_t
+ *);
+
+249 
+bridge_node_
+(
+bridge_soc
+ *,
+
+250 
+bridge_node
+ *);
+
+251 
+bridge_node_move
+(
+bridge_soc
+ *,
+
+252 
+bridge_node
+ *);
+
+253 
+bridge_node_deroy
+(
+bridge_node
+ *);
+
+255 
+bridge_ii
+ *
+bridge_lookup_memb
+(
+bridge_soc
+ *,
+
+256 c *
+me
+);
+
+257 
+bridge_ii
+ *
+bridge_lookup_memb_if
+(
+bridge_soc
+ *,
+
+258 
+i
+ *
+i
+);
+
+259 
+bridge_a_memb
+(
+bridge_soc
+ *, 
+bridge_ii
+ *);
+
+260 
+bridge_de_memb
+(
+bridge_soc
+ *,
+
+261 
+bridge_ii
+ *);
+
+262 
+bridge_ii
+ *
+bridge_y_hd_bif
+(bridge_iflist *);
+
+264 
+bridge_iol_add
+(
+bridge_soc
+ *, *);
+
+265 
+bridge_iol_d
+(
+bridge_soc
+ *, *);
+
+266 
+bridge_iol_gifags
+(
+bridge_soc
+ *, *);
+
+267 
+bridge_iol_sifags
+(
+bridge_soc
+ *, *);
+
+268 
+bridge_iol_sche
+(
+bridge_soc
+ *, *);
+
+269 
+bridge_iol_gche
+(
+bridge_soc
+ *, *);
+
+270 
+bridge_iol_gifs
+(
+bridge_soc
+ *, *);
+
+271 
+bridge_iol_s
+(
+bridge_soc
+ *, *);
+
+272 
+bridge_iol_ddr
+(
+bridge_soc
+ *, *);
+
+273 
+bridge_iol_o
+(
+bridge_soc
+ *, *);
+
+274 
+bridge_iol_gto
+(
+bridge_soc
+ *, *);
+
+275 
+bridge_iol_daddr
+(
+bridge_soc
+ *, *);
+
+276 
+bridge_iol_ush
+(
+bridge_soc
+ *, *);
+
+277 
+bridge_iol_gi
+(
+bridge_soc
+ *, *);
+
+278 
+bridge_iol_ri
+(
+bridge_soc
+ *, *);
+
+279 
+bridge_iol_ght
+(
+bridge_soc
+ *, *);
+
+280 
+bridge_iol_sht
+(
+bridge_soc
+ *, *);
+
+281 
+bridge_iol_gfd
+(
+bridge_soc
+ *, *);
+
+282 
+bridge_iol_sfd
+(
+bridge_soc
+ *, *);
+
+283 
+bridge_iol_gma
+(
+bridge_soc
+ *, *);
+
+284 
+bridge_iol_sma
+(
+bridge_soc
+ *, *);
+
+285 
+bridge_iol_sirio
+(
+bridge_soc
+ *, *);
+
+286 
+bridge_iol_sifco
+(
+bridge_soc
+ *, *);
+
+287 #i
+defed
+(
+BRIDGE_IPF
+)
+
+288 
+bridge_iol_gft
+(
+bridge_soc
+ *, *);
+
+289 
+bridge_iol_sft
+(
+bridge_soc
+ *, *);
+
+290 
+bridge_f
+(*, 
+mbuf
+ **, 
+i
+ *, );
+
+291 
+bridge__checkbasic
+(
+mbuf
+ **
+mp
+);
+
+292 #ifde
+INET6
+
+
+293 
+bridge_6_checkbasic
+(
+mbuf
+ **
+mp
+);
+
+297 
+bridge_sysl_fwdq_tup
+(
+sysog
+ **
+og
+,
+
+298 
+bridge_soc
+ *
+sc
+);
+
+300 
+	sbridge_c
+ {
+
+301 (*
+	mbc_func
+)(
+	mbridge_soc
+ *, *);
+
+302 
+	mbc_gsize
+;
+
+303 
+	mbc_ags
+;
+
+306 
+	#BC_F_COPYIN
+ 0x01
+
+	)
+
+307 
+	#BC_F_COPYOUT
+ 0x02
+
+	)
+
+308 
+	#BC_F_SUSER
+ 0x04
+
+	)
+
+310 c 
+bridge_c
+ 
+	gbridge_c_b
+[] = {
+
+311 [
+BRDGADD
+] = {
+bridge_iol_add
+, (
+ifbq
+), 
+BC_F_COPYIN
+|
+BC_F_SUSER
+},
+
+312 [
+BRDGDEL
+] = {
+bridge_iol_d
+, (
+ifbq
+), 
+BC_F_COPYIN
+|
+BC_F_SUSER
+},
+
+314 [
+BRDGGIFFLGS
+] = {
+bridge_iol_gifags
+, (
+ifbq
+), 
+BC_F_COPYIN
+|
+BC_F_COPYOUT
+},
+
+315 [
+BRDGSIFFLGS
+] = {
+bridge_iol_sifags
+, (
+ifbq
+), 
+BC_F_COPYIN
+|
+BC_F_SUSER
+},
+
+317 [
+BRDGSCACHE
+] = {
+bridge_iol_sche
+, (
+ifbam
+), 
+BC_F_COPYIN
+|
+BC_F_SUSER
+},
+
+318 [
+BRDGGCACHE
+] = {
+bridge_iol_gche
+, (
+ifbam
+), 
+BC_F_COPYOUT
+},
+
+320 [
+BRDGGIFS
+] = {
+bridge_iol_gifs
+, (
+ifbifcf
+), 
+BC_F_COPYIN
+|
+BC_F_COPYOUT
+},
+
+321 [
+BRDGRTS
+] = {
+bridge_iol_s
+, (
+ifbacf
+), 
+BC_F_COPYIN
+|
+BC_F_COPYOUT
+},
+
+323 [
+BRDGSADDR
+] = {
+bridge_iol_ddr
+, (
+ifbeq
+), 
+BC_F_COPYIN
+|
+BC_F_SUSER
+},
+
+325 [
+BRDGSTO
+] = {
+bridge_iol_o
+, (
+ifbam
+), 
+BC_F_COPYIN
+|
+BC_F_SUSER
+},
+
+326 [
+BRDGGTO
+] = {
+bridge_iol_gto
+, (
+ifbam
+), 
+BC_F_COPYOUT
+},
+
+328 [
+BRDGDADDR
+] = {
+bridge_iol_daddr
+, (
+ifbeq
+), 
+BC_F_COPYIN
+|
+BC_F_SUSER
+},
+
+330 [
+BRDGFLUSH
+] = {
+bridge_iol_ush
+, (
+ifbq
+), 
+BC_F_COPYIN
+|
+BC_F_SUSER
+},
+
+332 [
+BRDGGPRI
+] = {
+bridge_iol_gi
+, (
+ifbam
+), 
+BC_F_COPYOUT
+},
+
+333 [
+BRDGSPRI
+] = {
+bridge_iol_ri
+, (
+ifbam
+), 
+BC_F_COPYIN
+|
+BC_F_SUSER
+},
+
+335 [
+BRDGGHT
+] = {
+bridge_iol_ght
+, (
+ifbam
+), 
+BC_F_COPYOUT
+},
+
+336 [
+BRDGSHT
+] = {
+bridge_iol_sht
+, (
+ifbam
+), 
+BC_F_COPYIN
+|
+BC_F_SUSER
+},
+
+338 [
+BRDGGFD
+] = {
+bridge_iol_gfd
+, (
+ifbam
+), 
+BC_F_COPYOUT
+},
+
+339 [
+BRDGSFD
+] = {
+bridge_iol_sfd
+, (
+ifbam
+), 
+BC_F_COPYIN
+|
+BC_F_SUSER
+},
+
+341 [
+BRDGGMA
+] = {
+bridge_iol_gma
+, (
+ifbam
+), 
+BC_F_COPYOUT
+},
+
+342 [
+BRDGSMA
+] = {
+bridge_iol_sma
+, (
+ifbam
+), 
+BC_F_COPYIN
+|
+BC_F_SUSER
+},
+
+344 [
+BRDGSIFPRIO
+] = {
+bridge_iol_sirio
+, (
+ifbq
+), 
+BC_F_COPYIN
+|
+BC_F_SUSER
+},
+
+346 [
+BRDGSIFCOST
+] = {
+bridge_iol_sifco
+, (
+ifbq
+), 
+BC_F_COPYIN
+|
+BC_F_SUSER
+},
+
+347 #i
+defed
+(
+BRIDGE_IPF
+)
+
+348 [
+BRDGGFILT
+] = {
+bridge_iol_gft
+, (
+ifbam
+), 
+BC_F_COPYOUT
+},
+
+349 [
+BRDGSFILT
+] = {
+bridge_iol_sft
+, (
+ifbam
+), 
+BC_F_COPYIN
+|
+BC_F_SUSER
+},
+
+352 c 
+	gbridge_c_b_size
+ = 
+__ycou
+(
+bridge_c_b
+);
+
+354 
+	$LIST_HEAD
+(, 
+bridge_soc
+
+bridge_li
+;
+
+355 
+kmux_t
+ 
+bridge_li_lock
+;
+
+357 
+if_e
+ 
+bridge_
+ =
+
+358 
+	`IF_CLONE_INITIALIZER
+("bridge", 
+bridge_e_
+, 
+bridge_e_deroy
+);
+
+366 
+	$bridgach
+(
+n
+)
+
+369 
+	`po_
+(&
+bridge_node_po
+, (
+bridge_node
+),
+
+370 0, 0, 0, "b", 
+NULL
+, 
+IPL_NET
+);
+
+372 
+	`LIST_INIT
+(&
+bridge_li
+);
+
+373 
+	`mux_
+(&
+bridge_li_lock
+, 
+MUTEX_DEFAULT
+, 
+IPL_NET
+);
+
+374 
+	`if_e_ch
+(&
+bridge_
+);
+
+375 
+	}
+}
+
+383 
+	$bridge_e_
+(
+if_e
+ *
+ifc
+, 
+un
+)
+
+385 
+bridge_soc
+ *
+sc
+;
+
+386 
+i
+ *
+i
+;
+
+387 
+r
+, 
+ags
+;
+
+389 
+sc
+ = 
+	`kmem_zloc
+((*sc), 
+KM_SLEEP
+);
+
+390 
+i
+ = &
+sc
+->
+sc_if
+;
+
+392 
+sc
+->
+sc_bmax
+ = 
+BRIDGE_RTABLE_MAX
+;
+
+393 
+sc
+->
+sc_btimeout
+ = 
+BRIDGE_RTABLE_TIMEOUT
+;
+
+394 
+sc
+->
+sc_bridge_max_age
+ = 
+BSTP_DEFAULT_MAX_AGE
+;
+
+395 
+sc
+->
+sc_bridge_hlo_time
+ = 
+BSTP_DEFAULT_HELLO_TIME
+;
+
+396 
+sc
+->
+sc_bridge_fwd_day
+ = 
+BSTP_DEFAULT_FORWARD_DELAY
+;
+
+397 
+sc
+->
+sc_bridge_iy
+ = 
+BSTP_DEFAULT_BRIDGE_PRIORITY
+;
+
+398 
+sc
+->
+sc_hd_time
+ = 
+BSTP_DEFAULT_HOLD_TIME
+;
+
+399 
+sc
+->
+sc_fr_ags
+ = 0;
+
+402 
+	`bridge_ab_
+(
+sc
+);
+
+404 #ifde
+BRIDGE_MPSAFE
+
+
+405 
+ags
+ = 
+WQ_MPSAFE
+;
+
+407 
+ags
+ = 0;
+
+409 
+r
+ = 
+	`wkqueue_
+(&
+sc
+->
+sc_age_wq
+, "bridge_rtage",
+
+410 
+bridge_age_wk
+, 
+sc
+, 
+PRI_SOFTNET
+, 
+IPL_SOFTNET
+, 
+ags
+);
+
+411 i(
+r
+)
+
+412 
+	`nic
+("%s: wkqueue_ %d\n", 
+__func__
+, 
+r
+);
+
+414 
+	`out_
+(&
+sc
+->
+sc_brout
+, 0);
+
+415 
+	`out_
+(&
+sc
+->
+sc_bpout
+, 0);
+
+417 
+	`LIST_INIT
+(&
+sc
+->
+sc_ii
+);
+
+418 #ifde
+BRIDGE_MPSAFE
+
+
+419 
+sc
+->
+sc_ii__lock
+ = 
+	`mux_obj_loc
+(
+MUTEX_DEFAULT
+, 
+IPL_NET
+);
+
+420 
+sc
+->
+sc_ii_psz
+ = 
+	`prlize_
+();
+
+421 
+sc
+->
+sc_ii_lock
+ = 
+	`mux_obj_loc
+(
+MUTEX_DEFAULT
+, 
+IPL_SOFTNET
+);
+
+423 
+sc
+->
+sc_ii__lock
+ = 
+NULL
+;
+
+424 
+sc
+->
+sc_ii_psz
+ = 
+NULL
+;
+
+425 
+sc
+->
+sc_ii_lock
+ = 
+NULL
+;
+
+427 
+	`cv_
+(&
+sc
+->
+sc_ii_cv
+, "if_bridge_cv");
+
+429 
+	`if_me
+(
+i
+, 
+ifc
+->
+ifc_me
+, 
+un
+);
+
+430 
+i
+->
+if_soc
+ = 
+sc
+;
+
+431 
+i
+->
+if_mtu
+ = 
+ETHERMTU
+;
+
+432 
+i
+->
+if_iol
+ = 
+bridge_iol
+;
+
+433 
+i
+->
+if_ouut
+ = 
+bridge_ouut
+;
+
+434 
+i
+->
+if_t
+ = 
+bridge_t
+;
+
+435 
+i
+->
+if_
+ = 
+bridge_
+;
+
+436 
+i
+->
+if_
+ = 
+bridge_
+;
+
+437 
+i
+->
+if_ty
+ = 
+IFT_BRIDGE
+;
+
+438 
+i
+->
+if_add
+ = 0;
+
+439 
+i
+->
+if_d
+ = 
+DLT_EN10MB
+;
+
+440 
+i
+->
+if_hd
+ = 
+ETHER_HDR_LEN
+;
+
+442 
+sc
+->
+sc_fwd_pktq
+ = 
+	`pktq_
+(
+IFQ_MAXLEN
+, 
+bridge_fwd
+, sc);
+
+443 
+	`KASSERT
+(
+sc
+->
+sc_fwd_pktq
+ !
+NULL
+);
+
+445 
+	`bridge_sysl_fwdq_tup
+(&
+i
+->
+if_sysl_log
+, 
+sc
+);
+
+447 
+	`if_ch
+(
+i
+);
+
+449 
+	`if_loc_dl
+(
+i
+);
+
+451 
+	`mux_r
+(&
+bridge_li_lock
+);
+
+452 
+	`LIST_INSERT_HEAD
+(&
+bridge_li
+, 
+sc
+, 
+sc_li
+);
+
+453 
+	`mux_ex
+(&
+bridge_li_lock
+);
+
+456 
+	}
+}
+
+464 
+	$bridge_e_deroy
+(
+i
+ *
+i
+)
+
+466 
+bridge_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+467 
+bridge_ii
+ *
+bif
+;
+
+468 
+s
+;
+
+471 
+	`pktq_brr
+(
+sc
+->
+sc_fwd_pktq
+);
+
+473 
+s
+ = 
+	`
+();
+
+475 
+	`bridge_
+(
+i
+, 1);
+
+477 
+	`BRIDGE_LOCK
+(
+sc
+);
+
+478 (
+bif
+ = 
+	`LIST_FIRST
+(&
+sc
+->
+sc_ii
+)!
+NULL
+)
+
+479 
+	`bridge_de_memb
+(
+sc
+, 
+bif
+);
+
+480 
+	`BRIDGE_UNLOCK
+(
+sc
+);
+
+482 
+	`mux_r
+(&
+bridge_li_lock
+);
+
+483 
+	`LIST_REMOVE
+(
+sc
+, 
+sc_li
+);
+
+484 
+	`mux_ex
+(&
+bridge_li_lock
+);
+
+486 
+	`lx
+(
+s
+);
+
+488 
+	`if_dach
+(
+i
+);
+
+491 
+	`pktq_ush
+(
+sc
+->
+sc_fwd_pktq
+);
+
+492 
+	`pktq_deroy
+(
+sc
+->
+sc_fwd_pktq
+);
+
+495 
+	`bridge_ab_fi
+(
+sc
+);
+
+497 
+	`cv_deroy
+(&
+sc
+->
+sc_ii_cv
+);
+
+498 i(
+sc
+->
+sc_ii__lock
+)
+
+499 
+	`mux_obj_
+(
+sc
+->
+sc_ii__lock
+);
+
+501 i(
+sc
+->
+sc_ii_psz
+)
+
+502 
+	`prlize_deroy
+(
+sc
+->
+sc_ii_psz
+);
+
+503 i(
+sc
+->
+sc_ii_lock
+)
+
+504 
+	`mux_obj_
+(
+sc
+->
+sc_ii_lock
+);
+
+506 
+	`wkqueue_deroy
+(
+sc
+->
+sc_age_wq
+);
+
+508 
+	`kmem_
+(
+sc
+, (*sc));
+
+511 
+	}
+}
+
+514 
+	$bridge_sysl_fwdq_maxn
+(
+SYSCTLFN_ARGS
+)
+
+516 
+sysode
+ 
+node
+ = *
+ode
+;
+
+517 c 
+bridge_soc
+ *
+sc
+ = 
+node
+.
+sysl_da
+;
+
+518  
+	`sysl_pktq_maxn
+(
+	`SYSCTLFN_CALL
+(
+ode
+), 
+sc
+->
+sc_fwd_pktq
+);
+
+519 
+	}
+}
+
+521 
+	#SYSCTL_BRIDGE_PKTQ
+(
+
+, 
+c
+) \
+
+523 
+bridge_sysl_fwdq_
+##
+	`
+(
+SYSCTLFN_ARGS
+) \
+
+525 
+sysode
+ 
+node
+ = *
+ode
+; \
+
+526 c 
+bridge_soc
+ *
+sc
+ = 
+node
+.
+sysl_da
+; \
+
+527  
+	`sysl_pktq_cou
+(
+	`SYSCTLFN_CALL
+(
+ode
+), \
+
+528 
+sc
+->
+sc_fwd_pktq
+, 
+c
+); \
+
+529 }
+
+	)
+
+531 
+	$SYSCTL_BRIDGE_PKTQ
+(
+ems
+, 
+PKTQ_NITEMS
+)
+
+532 
+	$SYSCTL_BRIDGE_PKTQ
+(
+drs
+, 
+PKTQ_DROPS
+)
+
+535 
+	$bridge_sysl_fwdq_tup
+(
+sysog
+ **
+og
+, 
+bridge_soc
+ *
+sc
+)
+
+537 c 
+sysode
+ *
+ode
+, *
+ode
+;
+
+538 
+sysl
+ 
+n_func
+ = 
+NULL
+, 
+maxn_func
+ = NULL, 
+drs_func
+ = NULL;
+
+539 c *
+iame
+ = 
+sc
+->
+sc_if
+.
+if_xme
+;
+
+541 
+n_func
+ = 
+bridge_sysl_fwdq_ems
+;
+
+542 
+maxn_func
+ = 
+bridge_sysl_fwdq_maxn
+;
+
+543 
+drs_func
+ = 
+bridge_sysl_fwdq_drs
+;
+
+545 i(
+	`sysl_v
+(
+og
+, 0, 
+NULL
+, &
+ode
+,
+
+546 
+CTLFLAG_PERMANENT
+,
+
+547 
+CTLTYPE_NODE
+, "interfaces",
+
+548 
+	`SYSCTL_DESCR
+("Per-interface controls"),
+
+549 
+NULL
+, 0, NULL, 0,
+
+550 
+CTL_NET
+, 
+CTL_CREATE
+, 
+CTL_EOL
+) != 0)
+
+551 
+bad
+;
+
+553 i(
+	`sysl_v
+(
+og
+, 0, &
+ode
+, &rnode,
+
+554 
+CTLFLAG_PERMANENT
+,
+
+555 
+CTLTYPE_NODE
+, 
+iame
+,
+
+556 
+	`SYSCTL_DESCR
+("Interface controls"),
+
+557 
+NULL
+, 0, NULL, 0,
+
+558 
+CTL_CREATE
+, 
+CTL_EOL
+) != 0)
+
+559 
+bad
+;
+
+561 i(
+	`sysl_v
+(
+og
+, 0, &
+ode
+, &rnode,
+
+562 
+CTLFLAG_PERMANENT
+,
+
+563 
+CTLTYPE_NODE
+, "fwdq",
+
+564 
+	`SYSCTL_DESCR
+("Protocol input queue controls"),
+
+565 
+NULL
+, 0, NULL, 0,
+
+566 
+CTL_CREATE
+, 
+CTL_EOL
+) != 0)
+
+567 
+bad
+;
+
+569 i(
+	`sysl_v
+(
+og
+, 0, &
+ode
+, &
+ode
+,
+
+570 
+CTLFLAG_PERMANENT
+,
+
+571 
+CTLTYPE_INT
+, "len",
+
+572 
+	`SYSCTL_DESCR
+("Current forwarding queueength"),
+
+573 
+n_func
+, 0, (*)
+sc
+, 0,
+
+574 
+CTL_CREATE
+, 
+IFQCTL_LEN
+, 
+CTL_EOL
+) != 0)
+
+575 
+bad
+;
+
+577 i(
+	`sysl_v
+(
+og
+, 0, &
+ode
+, &
+ode
+,
+
+578 
+CTLFLAG_PERMANENT
+|
+CTLFLAG_READWRITE
+,
+
+579 
+CTLTYPE_INT
+, "maxlen",
+
+580 
+	`SYSCTL_DESCR
+("Maximumllowed forwarding queueength"),
+
+581 
+maxn_func
+, 0, (*)
+sc
+, 0,
+
+582 
+CTL_CREATE
+, 
+IFQCTL_MAXLEN
+, 
+CTL_EOL
+) != 0)
+
+583 
+bad
+;
+
+585 i(
+	`sysl_v
+(
+og
+, 0, &
+ode
+, &
+ode
+,
+
+586 
+CTLFLAG_PERMANENT
+,
+
+587 
+CTLTYPE_INT
+, "drops",
+
+588 
+	`SYSCTL_DESCR
+("Packets dropped dueo full forwarding queue"),
+
+589 
+drs_func
+, 0, (*)
+sc
+, 0,
+
+590 
+CTL_CREATE
+, 
+IFQCTL_DROPS
+, 
+CTL_EOL
+) != 0)
+
+591 
+bad
+;
+
+594 
+bad
+:
+
+595 
+	`rt_r
+("%s: couldach sysnodes\n", 
+iame
+);
+
+597 
+	}
+}
+
+605 
+	$bridge_iol
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+607 
+bridge_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+608 
+lwp
+ *
+l
+ = 
+cuwp
+;
+
+610 
+ifbq
+ ifbreq;
+
+611 
+ifbifcf
+ ifbifconf;
+
+612 
+ifbeq
+ ifbareq;
+
+613 
+ifbacf
+ ifbaconf;
+
+614 
+ifbam
+ ifbrparam;
+
+615 } 
+gs
+;
+
+616 
+ifdrv
+ *
+ifd
+ = (ifdrv *
+da
+;
+
+617 c 
+bridge_c
+ *
+bc
+ = 
+NULL
+;
+
+618 
+s
+, 
+r
+ = 0;
+
+621 
+cmd
+) {
+
+622 
+SIOCGDRVSPEC
+:
+
+623 
+SIOCSDRVSPEC
+:
+
+624 i(
+ifd
+->
+ifd_cmd
+ >
+bridge_c_b_size
+) {
+
+625 
+r
+ = 
+EINVAL
+;
+
+626  
+r
+;
+
+629 
+bc
+ = &
+bridge_c_b
+[
+ifd
+->
+ifd_cmd
+];
+
+632 i((
+bc
+->
+bc_ags
+ & 
+BC_F_SUSER
+) == 0)
+
+635 
+r
+ = 
+	`kauth_authize_twk
+(
+l
+->
+l_ed
+,
+
+636 
+KAUTH_NETWORK_INTERFACE_BRIDGE
+,
+
+637 
+cmd
+ =
+SIOCGDRVSPEC
+ ?
+
+638 
+KAUTH_REQ_NETWORK_INTERFACE_BRIDGE_GETPRIV
+ :
+
+639 
+KAUTH_REQ_NETWORK_INTERFACE_BRIDGE_SETPRIV
+,
+
+640 
+ifd
+, 
+NULL
+, NULL);
+
+641 i(
+r
+)
+
+642  (
+r
+);
+
+647 
+s
+ = 
+	`
+();
+
+649 
+cmd
+) {
+
+650 
+SIOCGDRVSPEC
+:
+
+651 
+SIOCSDRVSPEC
+:
+
+652 
+	`KASSERT
+(
+bc
+ !
+NULL
+);
+
+653 i(
+cmd
+ =
+SIOCGDRVSPEC
+ &&
+
+654 (
+bc
+->
+bc_ags
+ & 
+BC_F_COPYOUT
+) == 0) {
+
+655 
+r
+ = 
+EINVAL
+;
+
+658 i(
+cmd
+ =
+SIOCSDRVSPEC
+ &&
+
+659 (
+bc
+->
+bc_ags
+ & 
+BC_F_COPYOUT
+) != 0) {
+
+660 
+r
+ = 
+EINVAL
+;
+
+666 i(
+ifd
+->
+ifd_n
+ !
+bc
+->
+bc_gsize
+ ||
+
+667 
+ifd
+->
+ifd_n
+ > (
+gs
+)) {
+
+668 
+r
+ = 
+EINVAL
+;
+
+672 
+	`memt
+(&
+gs
+, 0, (args));
+
+673 i(
+bc
+->
+bc_ags
+ & 
+BC_F_COPYIN
+) {
+
+674 
+r
+ = 
+	`cy
+(
+ifd
+->
+ifd_da
+, &
+gs
+, ifd->
+ifd_n
+);
+
+675 i(
+r
+)
+
+679 
+r
+ = (*
+bc
+->
+bc_func
+)(
+sc
+, &
+gs
+);
+
+680 i(
+r
+)
+
+683 i(
+bc
+->
+bc_ags
+ & 
+BC_F_COPYOUT
+)
+
+684 
+r
+ = 
+	`cyout
+(&
+gs
+, 
+ifd
+->
+ifd_da
+, ifd->
+ifd_n
+);
+
+688 
+SIOCSIFFLAGS
+:
+
+689 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)) != 0)
+
+691 
+i
+->
+if_ags
+ & (
+IFF_UP
+|
+IFF_RUNNING
+)) {
+
+692 
+IFF_RUNNING
+:
+
+697 (*
+i
+->
+if_
+)(ifp, 1);
+
+699 
+IFF_UP
+:
+
+704 
+r
+ = (*
+i
+->
+if_
+)(ifp);
+
+711 
+SIOCSIFMTU
+:
+
+712 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)=
+ENETRESET
+)
+
+713 
+r
+ = 0;
+
+717 
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+);
+
+721 
+	`lx
+(
+s
+);
+
+723  (
+r
+);
+
+724 
+	}
+}
+
+731 
+bridge_ii
+ *
+
+732 
+	$bridge_lookup_memb
+(
+bridge_soc
+ *
+sc
+, c *
+me
+)
+
+734 
+bridge_ii
+ *
+bif
+;
+
+735 
+i
+ *
+i
+;
+
+736 
+s
+;
+
+738 
+	`BRIDGE_PSZ_RENTER
+(
+s
+);
+
+740 
+	`LIST_FOREACH
+(
+bif
+, &
+sc
+->
+sc_ii
+, 
+bif_xt
+) {
+
+741 
+i
+ = 
+bif
+->
+bif_i
+;
+
+742 i(
+	`rcmp
+(
+i
+->
+if_xme
+, 
+me
+) == 0)
+
+745 
+bif
+ = 
+	`bridge_y_hd_bif
+(bif);
+
+747 
+	`BRIDGE_PSZ_REXIT
+(
+s
+);
+
+749  
+bif
+;
+
+750 
+	}
+}
+
+757 
+bridge_ii
+ *
+
+758 
+	$bridge_lookup_memb_if
+(
+bridge_soc
+ *
+sc
+, 
+i
+ *
+memb_i
+)
+
+760 
+bridge_ii
+ *
+bif
+;
+
+761 
+s
+;
+
+763 
+	`BRIDGE_PSZ_RENTER
+(
+s
+);
+
+765 
+bif
+ = 
+memb_i
+->
+if_bridgeif
+;
+
+766 
+bif
+ = 
+	`bridge_y_hd_bif
+(bif);
+
+768 
+	`BRIDGE_PSZ_REXIT
+(
+s
+);
+
+770  
+bif
+;
+
+771 
+	}
+}
+
+773 
+bridge_ii
+ *
+
+774 
+	$bridge_y_hd_bif
+(
+bridge_ii
+ *
+bif
+)
+
+776 #ifde
+BRIDGE_MPSAFE
+
+
+777 i(
+bif
+ !
+NULL
+) {
+
+778 i(
+bif
+->
+bif_wag
+)
+
+779 
+bif
+ = 
+NULL
+;
+
+781 
+	`omic_c_32
+(&
+bif
+->
+bif_fs
+);
+
+784  
+bif
+;
+
+785 
+	}
+}
+
+793 
+	$bridge_a_memb
+(
+bridge_soc
+ *
+sc
+, 
+bridge_ii
+ *
+bif
+)
+
+795 #ifde
+BRIDGE_MPSAFE
+
+
+796 
+ut32_t
+ 
+fs
+;
+
+798 
+fs
+ = 
+	`omic_dec_ut_nv
+(&
+bif
+->
+bif_fs
+);
+
+799 i(
+	`__edi_l
+(
+fs
+ =0 && 
+bif
+->
+bif_wag
+)) {
+
+800 
+	`BRIDGE_INTR_LOCK
+(
+sc
+);
+
+801 
+	`cv_brd
+(&
+sc
+->
+sc_ii_cv
+);
+
+802 
+	`BRIDGE_INTR_UNLOCK
+(
+sc
+);
+
+805 ()
+sc
+;
+
+806 ()
+bif
+;
+
+808 
+	}
+}
+
+816 
+	$bridge_de_memb
+(
+bridge_soc
+ *
+sc
+, 
+bridge_ii
+ *
+bif
+)
+
+818 
+i
+ *
+ifs
+ = 
+bif
+->
+bif_i
+;
+
+820 
+	`KASSERT
+(
+	`BRIDGE_LOCKED
+(
+sc
+));
+
+822 
+ifs
+->
+if_put
+ = 
+h_put
+;
+
+823 
+ifs
+->
+if_bridge
+ = 
+NULL
+;
+
+824 
+ifs
+->
+if_bridgeif
+ = 
+NULL
+;
+
+826 
+	`LIST_REMOVE
+(
+bif
+, 
+bif_xt
+);
+
+828 
+	`BRIDGE_PSZ_PERFORM
+(
+sc
+);
+
+830 
+	`BRIDGE_UNLOCK
+(
+sc
+);
+
+832 #ifde
+BRIDGE_MPSAFE
+
+
+833 
+	`BRIDGE_INTR_LOCK
+(
+sc
+);
+
+834 
+bif
+->
+bif_wag
+ = 
+ue
+;
+
+835 
+	`memb_sync
+();
+
+836 
+bif
+->
+bif_fs
+ > 0) {
+
+837 
+	`rt_debug
+("%s: cv_wa oii\n", 
+__func__
+);
+
+838 
+	`cv_wa
+(&
+sc
+->
+sc_ii_cv
+, sc->
+sc_ii__lock
+);
+
+840 
+bif
+->
+bif_wag
+ = 
+l
+;
+
+841 
+	`BRIDGE_INTR_UNLOCK
+(
+sc
+);
+
+844 
+	`kmem_
+(
+bif
+, (*bif));
+
+846 
+	`BRIDGE_LOCK
+(
+sc
+);
+
+847 
+	}
+}
+
+850 
+	$bridge_iol_add
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+852 
+ifbq
+ *
+q
+ = 
+g
+;
+
+853 
+bridge_ii
+ *
+bif
+ = 
+NULL
+;
+
+854 
+i
+ *
+ifs
+;
+
+855 
+r
+ = 0;
+
+857 
+ifs
+ = 
+	`ifun
+(
+q
+->
+ifbr_ifame
+);
+
+858 i(
+ifs
+ =
+NULL
+)
+
+859  (
+ENOENT
+);
+
+861 i(
+sc
+->
+sc_if
+.
+if_mtu
+ !
+ifs
+->if_mtu)
+
+862  (
+EINVAL
+);
+
+864 i(
+ifs
+->
+if_bridge
+ =
+sc
+)
+
+865  (
+EEXIST
+);
+
+867 i(
+ifs
+->
+if_bridge
+ !
+NULL
+)
+
+868  (
+EBUSY
+);
+
+870 i(
+ifs
+->
+if_put
+ !
+h_put
+)
+
+871  
+EINVAL
+;
+
+874 i((
+ifs
+->
+if_ags
+ & 
+IFF_SIMPLEX
+) == 0)
+
+875  
+EINVAL
+;
+
+877 
+bif
+ = 
+	`kmem_loc
+((*bif), 
+KM_SLEEP
+);
+
+879 
+ifs
+->
+if_ty
+) {
+
+880 
+IFT_ETHER
+:
+
+884 
+r
+ = 
+	`iromisc
+(
+ifs
+, 1);
+
+885 i(
+r
+)
+
+886 
+out
+;
+
+889 
+r
+ = 
+EINVAL
+;
+
+890 
+out
+;
+
+893 
+bif
+->
+bif_i
+ = 
+ifs
+;
+
+894 
+bif
+->
+bif_ags
+ = 
+IFBIF_LEARNING
+ | 
+IFBIF_DISCOVER
+;
+
+895 
+bif
+->
+bif_iy
+ = 
+BSTP_DEFAULT_PORT_PRIORITY
+;
+
+896 
+bif
+->
+bif_th_co
+ = 
+BSTP_DEFAULT_PATH_COST
+;
+
+897 
+bif
+->
+bif_fs
+ = 0;
+
+898 
+bif
+->
+bif_wag
+ = 
+l
+;
+
+900 
+	`BRIDGE_LOCK
+(
+sc
+);
+
+902 
+ifs
+->
+if_bridge
+ = 
+sc
+;
+
+903 
+ifs
+->
+if_bridgeif
+ = 
+bif
+;
+
+904 
+	`LIST_INSERT_HEAD
+(&
+sc
+->
+sc_ii
+, 
+bif
+, 
+bif_xt
+);
+
+905 
+ifs
+->
+if_put
+ = 
+bridge_put
+;
+
+907 
+	`BRIDGE_UNLOCK
+(
+sc
+);
+
+909 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_RUNNING
+)
+
+910 
+	`bp_lizi
+(
+sc
+);
+
+912 
+	`bp_
+(
+sc
+);
+
+914 
+out
+:
+
+915 i(
+r
+) {
+
+916 i(
+bif
+ !
+NULL
+)
+
+917 
+	`kmem_
+(
+bif
+, (*bif));
+
+919  (
+r
+);
+
+920 
+	}
+}
+
+923 
+	$bridge_iol_d
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+925 
+ifbq
+ *
+q
+ = 
+g
+;
+
+926 c *
+me
+ = 
+q
+->
+ifbr_ifame
+;
+
+927 
+bridge_ii
+ *
+bif
+;
+
+928 
+i
+ *
+ifs
+;
+
+930 
+	`BRIDGE_LOCK
+(
+sc
+);
+
+936 
+	`LIST_FOREACH
+(
+bif
+, &
+sc
+->
+sc_ii
+, 
+bif_xt
+) {
+
+937 
+ifs
+ = 
+bif
+->
+bif_i
+;
+
+938 i(
+	`rcmp
+(
+ifs
+->
+if_xme
+, 
+me
+) == 0)
+
+942 i(
+bif
+ =
+NULL
+) {
+
+943 
+	`BRIDGE_UNLOCK
+(
+sc
+);
+
+944  
+ENOENT
+;
+
+947 
+	`bridge_de_memb
+(
+sc
+, 
+bif
+);
+
+949 
+	`BRIDGE_UNLOCK
+(
+sc
+);
+
+951 
+ifs
+->
+if_ty
+) {
+
+952 
+IFT_ETHER
+:
+
+957 (
+	`iromisc
+(
+ifs
+, 0);
+
+960 #ifde
+DIAGNOSTIC
+
+
+961 
+	`nic
+("bridge_delete_member: impossible");
+
+966 
+	`bridge_de
+(
+sc
+, 
+ifs
+);
+
+968 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_RUNNING
+)
+
+969 
+	`bp_lizi
+(
+sc
+);
+
+972 
+	}
+}
+
+975 
+	$bridge_iol_gifags
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+977 
+ifbq
+ *
+q
+ = 
+g
+;
+
+978 
+bridge_ii
+ *
+bif
+;
+
+980 
+bif
+ = 
+	`bridge_lookup_memb
+(
+sc
+, 
+q
+->
+ifbr_ifame
+);
+
+981 i(
+bif
+ =
+NULL
+)
+
+982  (
+ENOENT
+);
+
+984 
+q
+->
+ifbr_ifsags
+ = 
+bif
+->
+bif_ags
+;
+
+985 
+q
+->
+ifbr_e
+ = 
+bif
+->
+bif_e
+;
+
+986 
+q
+->
+ifbr_iy
+ = 
+bif
+->
+bif_iy
+;
+
+987 
+q
+->
+ifbr_th_co
+ = 
+bif
+->
+bif_th_co
+;
+
+988 
+q
+->
+ifbr_po
+ = 
+bif
+->
+bif_i
+->
+if_dex
+ & 0xff;
+
+990 
+	`bridge_a_memb
+(
+sc
+, 
+bif
+);
+
+993 
+	}
+}
+
+996 
+	$bridge_iol_sifags
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+998 
+ifbq
+ *
+q
+ = 
+g
+;
+
+999 
+bridge_ii
+ *
+bif
+;
+
+1001 
+bif
+ = 
+	`bridge_lookup_memb
+(
+sc
+, 
+q
+->
+ifbr_ifame
+);
+
+1002 i(
+bif
+ =
+NULL
+)
+
+1003  (
+ENOENT
+);
+
+1005 i(
+q
+->
+ifbr_ifsags
+ & 
+IFBIF_STP
+) {
+
+1006 
+bif
+->
+bif_i
+->
+if_ty
+) {
+
+1007 
+IFT_ETHER
+:
+
+1013 
+	`bridge_a_memb
+(
+sc
+, 
+bif
+);
+
+1014  (
+EINVAL
+);
+
+1018 
+bif
+->
+bif_ags
+ = 
+q
+->
+ifbr_ifsags
+;
+
+1020 
+	`bridge_a_memb
+(
+sc
+, 
+bif
+);
+
+1022 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_RUNNING
+)
+
+1023 
+	`bp_lizi
+(
+sc
+);
+
+1026 
+	}
+}
+
+1029 
+	$bridge_iol_sche
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+1031 
+ifbam
+ *
+m
+ = 
+g
+;
+
+1033 
+sc
+->
+sc_bmax
+ = 
+m
+->
+ifb_csize
+;
+
+1034 
+	`bridge_im
+(
+sc
+);
+
+1037 
+	}
+}
+
+1040 
+	$bridge_iol_gche
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+1042 
+ifbam
+ *
+m
+ = 
+g
+;
+
+1044 
+m
+->
+ifb_csize
+ = 
+sc
+->
+sc_bmax
+;
+
+1047 
+	}
+}
+
+1050 
+	$bridge_iol_gifs
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+1052 
+ifbifcf
+ *
+bifc
+ = 
+g
+;
+
+1053 
+bridge_ii
+ *
+bif
+;
+
+1054 
+ifbq
+ *
+bqs
+;
+
+1055 
+i
+, 
+cou
+, 
+r
+ = 0;
+
+1057 
+y
+:
+
+1058 
+	`BRIDGE_LOCK
+(
+sc
+);
+
+1059 
+cou
+ = 0;
+
+1060 
+	`LIST_FOREACH
+(
+bif
+, &
+sc
+->
+sc_ii
+, 
+bif_xt
+)
+
+1061 
+cou
+++;
+
+1062 
+	`BRIDGE_UNLOCK
+(
+sc
+);
+
+1064 i(
+cou
+ == 0) {
+
+1065 
+bifc
+->
+ifbic_n
+ = 0;
+
+1069 i(
+bifc
+->
+ifbic_n
+ =0 || bifc->ifbic_< ((*
+bqs
+* 
+cou
+)) {
+
+1071 
+bifc
+->
+ifbic_n
+ = (*
+bqs
+* 
+cou
+;
+
+1075 
+bqs
+ = 
+	`kmem_loc
+((*bqs* 
+cou
+, 
+KM_SLEEP
+);
+
+1077 
+	`BRIDGE_LOCK
+(
+sc
+);
+
+1079 
+i
+ = 0;
+
+1080 
+	`LIST_FOREACH
+(
+bif
+, &
+sc
+->
+sc_ii
+, 
+bif_xt
+)
+
+1081 
+i
+++;
+
+1082 i(
+i
+ > 
+cou
+) {
+
+1087 
+	`BRIDGE_UNLOCK
+(
+sc
+);
+
+1088 
+	`kmem_
+(
+bqs
+, (*bqs* 
+cou
+);
+
+1089 
+y
+;
+
+1092 
+i
+ = 0;
+
+1093 
+	`LIST_FOREACH
+(
+bif
+, &
+sc
+->
+sc_ii
+, 
+bif_xt
+) {
+
+1094 
+ifbq
+ *
+bq
+ = &
+bqs
+[
+i
+++];
+
+1095 
+	`memt
+(
+bq
+, 0, (*breq));
+
+1097 
+	`y
+(
+bq
+->
+ifbr_ifame
+, 
+bif
+->
+bif_i
+->
+if_xme
+,
+
+1098 (
+bq
+->
+ifbr_ifame
+));
+
+1099 
+bq
+->
+ifbr_ifsags
+ = 
+bif
+->
+bif_ags
+;
+
+1100 
+bq
+->
+ifbr_e
+ = 
+bif
+->
+bif_e
+;
+
+1101 
+bq
+->
+ifbr_iy
+ = 
+bif
+->
+bif_iy
+;
+
+1102 
+bq
+->
+ifbr_th_co
+ = 
+bif
+->
+bif_th_co
+;
+
+1103 
+bq
+->
+ifbr_po
+ = 
+bif
+->
+bif_i
+->
+if_dex
+ & 0xff;
+
+1107 
+	`BRIDGE_UNLOCK
+(
+sc
+);
+
+1109 
+i
+ = 0; i < 
+cou
+; i++) {
+
+1110 
+r
+ = 
+	`cyout
+(&
+bqs
+[
+i
+], 
+bifc
+->
+ifbic_q
+ + i, (*breqs));
+
+1111 i(
+r
+)
+
+1114 
+bifc
+->
+ifbic_n
+ = (*
+bqs
+* 
+i
+;
+
+1116 
+	`kmem_
+(
+bqs
+, (*bqs* 
+cou
+);
+
+1118  
+r
+;
+
+1119 
+	}
+}
+
+1122 
+	$bridge_iol_s
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+1124 
+ifbacf
+ *
+bac
+ = 
+g
+;
+
+1125 
+bridge_node
+ *
+b
+;
+
+1126 
+ifbeq
+ 
+beq
+;
+
+1127 
+cou
+ = 0, 
+r
+ = 0, 
+n
+;
+
+1129 i(
+bac
+->
+ifbac_n
+ == 0)
+
+1132 
+	`BRIDGE_RT_INTR_LOCK
+(
+sc
+);
+
+1134 
+n
+ = 
+bac
+->
+ifbac_n
+;
+
+1135 
+	`LIST_FOREACH
+(
+b
+, &
+sc
+->
+sc_li
+, 
+b_li
+) {
+
+1136 i(
+n
+ < (
+beq
+))
+
+1137 
+out
+;
+
+1138 
+	`memt
+(&
+beq
+, 0, (bareq));
+
+1139 
+	`y
+(
+beq
+.
+ifba_ifame
+, 
+b
+->
+b_i
+->
+if_xme
+,
+
+1140 (
+beq
+.
+ifba_ifame
+));
+
+1141 
+	`memy
+(
+beq
+.
+ifba_d
+, 
+b
+->
+b_addr
+, (brt->brt_addr));
+
+1142 i((
+b
+->
+b_ags
+ & 
+IFBAF_TYPEMASK
+=
+IFBAF_DYNAMIC
+) {
+
+1143 
+beq
+.
+ifba_expe
+ = 
+b
+->
+b_expe
+ - 
+time_uime
+;
+
+1145 
+beq
+.
+ifba_expe
+ = 0;
+
+1146 
+beq
+.
+ifba_ags
+ = 
+b
+->
+b_ags
+;
+
+1148 
+r
+ = 
+	`cyout
+(&
+beq
+, 
+bac
+->
+ifbac_q
+ + 
+cou
+, (bareq));
+
+1149 i(
+r
+)
+
+1150 
+out
+;
+
+1151 
+cou
+++;
+
+1152 
+n
+ -(
+beq
+);
+
+1154 
+out
+:
+
+1155 
+	`BRIDGE_RT_INTR_UNLOCK
+(
+sc
+);
+
+1157 
+bac
+->
+ifbac_n
+ = (
+beq
+* 
+cou
+;
+
+1158  (
+r
+);
+
+1159 
+	}
+}
+
+1162 
+	$bridge_iol_ddr
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+1164 
+ifbeq
+ *
+q
+ = 
+g
+;
+
+1165 
+bridge_ii
+ *
+bif
+;
+
+1166 
+r
+;
+
+1168 
+bif
+ = 
+	`bridge_lookup_memb
+(
+sc
+, 
+q
+->
+ifba_ifame
+);
+
+1169 i(
+bif
+ =
+NULL
+)
+
+1170  (
+ENOENT
+);
+
+1172 
+r
+ = 
+	`bridge_upde
+(
+sc
+, 
+q
+->
+ifba_d
+, 
+bif
+->
+bif_i
+, 1,
+
+1173 
+q
+->
+ifba_ags
+);
+
+1175 
+	`bridge_a_memb
+(
+sc
+, 
+bif
+);
+
+1177  (
+r
+);
+
+1178 
+	}
+}
+
+1181 
+	$bridge_iol_o
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+1183 
+ifbam
+ *
+m
+ = 
+g
+;
+
+1185 
+sc
+->
+sc_btimeout
+ = 
+m
+->
+ifb_ime
+;
+
+1188 
+	}
+}
+
+1191 
+	$bridge_iol_gto
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+1193 
+ifbam
+ *
+m
+ = 
+g
+;
+
+1195 
+m
+->
+ifb_ime
+ = 
+sc
+->
+sc_btimeout
+;
+
+1198 
+	}
+}
+
+1201 
+	$bridge_iol_daddr
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+1203 
+ifbeq
+ *
+q
+ = 
+g
+;
+
+1205  (
+	`bridge_daddr
+(
+sc
+, 
+q
+->
+ifba_d
+));
+
+1206 
+	}
+}
+
+1209 
+	$bridge_iol_ush
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+1211 
+ifbq
+ *
+q
+ = 
+g
+;
+
+1213 
+	`bridge_ush
+(
+sc
+, 
+q
+->
+ifbr_ifsags
+);
+
+1216 
+	}
+}
+
+1219 
+	$bridge_iol_gi
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+1221 
+ifbam
+ *
+m
+ = 
+g
+;
+
+1223 
+m
+->
+ifb_io
+ = 
+sc
+->
+sc_bridge_iy
+;
+
+1226 
+	}
+}
+
+1229 
+	$bridge_iol_ri
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+1231 
+ifbam
+ *
+m
+ = 
+g
+;
+
+1233 
+sc
+->
+sc_bridge_iy
+ = 
+m
+->
+ifb_io
+;
+
+1235 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_RUNNING
+)
+
+1236 
+	`bp_lizi
+(
+sc
+);
+
+1239 
+	}
+}
+
+1242 
+	$bridge_iol_ght
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+1244 
+ifbam
+ *
+m
+ = 
+g
+;
+
+1246 
+m
+->
+ifb_hlime
+ = 
+sc
+->
+sc_bridge_hlo_time
+ >> 8;
+
+1249 
+	}
+}
+
+1252 
+	$bridge_iol_sht
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+1254 
+ifbam
+ *
+m
+ = 
+g
+;
+
+1256 i(
+m
+->
+ifb_hlime
+ == 0)
+
+1257  (
+EINVAL
+);
+
+1258 
+sc
+->
+sc_bridge_hlo_time
+ = 
+m
+->
+ifb_hlime
+ << 8;
+
+1260 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_RUNNING
+)
+
+1261 
+	`bp_lizi
+(
+sc
+);
+
+1264 
+	}
+}
+
+1267 
+	$bridge_iol_gfd
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+1269 
+ifbam
+ *
+m
+ = 
+g
+;
+
+1271 
+m
+->
+ifb_fwdday
+ = 
+sc
+->
+sc_bridge_fwd_day
+ >> 8;
+
+1274 
+	}
+}
+
+1277 
+	$bridge_iol_sfd
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+1279 
+ifbam
+ *
+m
+ = 
+g
+;
+
+1281 i(
+m
+->
+ifb_fwdday
+ == 0)
+
+1282  (
+EINVAL
+);
+
+1283 
+sc
+->
+sc_bridge_fwd_day
+ = 
+m
+->
+ifb_fwdday
+ << 8;
+
+1285 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_RUNNING
+)
+
+1286 
+	`bp_lizi
+(
+sc
+);
+
+1289 
+	}
+}
+
+1292 
+	$bridge_iol_gma
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+1294 
+ifbam
+ *
+m
+ = 
+g
+;
+
+1296 
+m
+->
+ifb_maxage
+ = 
+sc
+->
+sc_bridge_max_age
+ >> 8;
+
+1299 
+	}
+}
+
+1302 
+	$bridge_iol_sma
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+1304 
+ifbam
+ *
+m
+ = 
+g
+;
+
+1306 i(
+m
+->
+ifb_maxage
+ == 0)
+
+1307  (
+EINVAL
+);
+
+1308 
+sc
+->
+sc_bridge_max_age
+ = 
+m
+->
+ifb_maxage
+ << 8;
+
+1310 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_RUNNING
+)
+
+1311 
+	`bp_lizi
+(
+sc
+);
+
+1314 
+	}
+}
+
+1317 
+	$bridge_iol_sirio
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+1319 
+ifbq
+ *
+q
+ = 
+g
+;
+
+1320 
+bridge_ii
+ *
+bif
+;
+
+1322 
+bif
+ = 
+	`bridge_lookup_memb
+(
+sc
+, 
+q
+->
+ifbr_ifame
+);
+
+1323 i(
+bif
+ =
+NULL
+)
+
+1324  (
+ENOENT
+);
+
+1326 
+bif
+->
+bif_iy
+ = 
+q
+->
+ifbr_iy
+;
+
+1328 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_RUNNING
+)
+
+1329 
+	`bp_lizi
+(
+sc
+);
+
+1331 
+	`bridge_a_memb
+(
+sc
+, 
+bif
+);
+
+1334 
+	}
+}
+
+1336 #i
+defed
+(
+BRIDGE_IPF
+)
+
+1338 
+	$bridge_iol_gft
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+1340 
+ifbam
+ *
+m
+ = 
+g
+;
+
+1342 
+m
+->
+ifb_fr
+ = 
+sc
+->
+sc_fr_ags
+;
+
+1345 
+	}
+}
+
+1348 
+	$bridge_iol_sft
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+1350 
+ifbam
+ *
+m
+ = 
+g
+;
+
+1351 
+ut32_t
+ 
+nags
+, 
+oags
+;
+
+1353 i(
+m
+->
+ifb_fr
+ & ~
+IFBF_FILT_MASK
+)
+
+1354  (
+EINVAL
+);
+
+1356 
+nags
+ = 
+m
+->
+ifb_fr
+;
+
+1357 
+oags
+ = 
+sc
+->
+sc_fr_ags
+;
+
+1359 i((
+nags
+ & 
+IFBF_FILT_USEIPF
+&& !(
+oags
+ & IFBF_FILT_USEIPF)) {
+
+1360 
+	`pf_add_hook
+((*)
+bridge_f
+, 
+NULL
+, 
+PFIL_IN
+|
+PFIL_OUT
+,
+
+1361 
+sc
+->
+sc_if
+.
+if_pf
+);
+
+1363 i(!(
+nags
+ & 
+IFBF_FILT_USEIPF
+&& (
+oags
+ & IFBF_FILT_USEIPF)) {
+
+1364 
+	`pf_move_hook
+((*)
+bridge_f
+, 
+NULL
+, 
+PFIL_IN
+|
+PFIL_OUT
+,
+
+1365 
+sc
+->
+sc_if
+.
+if_pf
+);
+
+1368 
+sc
+->
+sc_fr_ags
+ = 
+nags
+;
+
+1371 
+	}
+}
+
+1375 
+	$bridge_iol_sifco
+(
+bridge_soc
+ *
+sc
+, *
+g
+)
+
+1377 
+ifbq
+ *
+q
+ = 
+g
+;
+
+1378 
+bridge_ii
+ *
+bif
+;
+
+1380 
+bif
+ = 
+	`bridge_lookup_memb
+(
+sc
+, 
+q
+->
+ifbr_ifame
+);
+
+1381 i(
+bif
+ =
+NULL
+)
+
+1382  (
+ENOENT
+);
+
+1384 
+bif
+->
+bif_th_co
+ = 
+q
+->
+ifbr_th_co
+;
+
+1386 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_RUNNING
+)
+
+1387 
+	`bp_lizi
+(
+sc
+);
+
+1389 
+	`bridge_a_memb
+(
+sc
+, 
+bif
+);
+
+1392 
+	}
+}
+
+1401 
+	$bridge_ifdach
+(
+i
+ *
+i
+)
+
+1403 
+bridge_soc
+ *
+sc
+ = 
+i
+->
+if_bridge
+;
+
+1404 
+ifbq
+ 
+bq
+;
+
+1407 
+	`KASSERT
+(
+sc
+ !
+NULL
+);
+
+1409 
+	`memt
+(&
+bq
+, 0, (breq));
+
+1410 
+	`y
+(
+bq
+.
+ifbr_ifame
+, 
+i
+->
+if_xme
+, (breq.ifbr_ifsname));
+
+1412 (
+	`bridge_iol_d
+(
+sc
+, &
+bq
+);
+
+1413 
+	}
+}
+
+1421 
+	$bridge_
+(
+i
+ *
+i
+)
+
+1423 
+bridge_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+1425 i(
+i
+->
+if_ags
+ & 
+IFF_RUNNING
+)
+
+1428 
+	`out_t
+(&
+sc
+->
+sc_brout
+, 
+bridge_ab_u_riod
+ * 
+hz
+,
+
+1429 
+bridge_tim
+, 
+sc
+);
+
+1431 
+i
+->
+if_ags
+ |
+IFF_RUNNING
+;
+
+1432 
+	`bp_lizi
+(
+sc
+);
+
+1434 
+	}
+}
+
+1442 
+	$bridge_
+(
+i
+ *
+i
+, 
+dib
+)
+
+1444 
+bridge_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+1446 i((
+i
+->
+if_ags
+ & 
+IFF_RUNNING
+) == 0)
+
+1449 
+	`out_
+(&
+sc
+->
+sc_brout
+);
+
+1450 
+	`bp_
+(
+sc
+);
+
+1452 
+	`bridge_ush
+(
+sc
+, 
+IFBF_FLUSHDYN
+);
+
+1454 
+i
+->
+if_ags
+ &~
+IFF_RUNNING
+;
+
+1455 
+	}
+}
+
+1463 
+	$bridge_queue
+(
+bridge_soc
+ *
+sc
+, 
+i
+ *
+d_i
+, 
+mbuf
+ *
+m
+,
+
+1464 
+runft
+)
+
+1466 
+	`ALTQ_DECL
+(
+tq_pkr
+ 
+pkr
+;)
+
+1467 
+n
+, 
+r
+;
+
+1468 
+mags
+;
+
+1473 
+m
+->
+m_pkthdr
+.
+csum_ags
+ = 0;
+
+1475 i(
+runft
+) {
+
+1476 i(
+	`pf_run_hooks
+(
+sc
+->
+sc_if
+.
+if_pf
+, &
+m
+,
+
+1477 
+d_i
+, 
+PFIL_OUT
+) != 0) {
+
+1478 i(
+m
+ !
+NULL
+)
+
+1479 
+	`m_m
+(
+m
+);
+
+1482 i(
+m
+ =
+NULL
+)
+
+1486 #ifde
+ALTQ
+
+
+1493 i(
+	`ALTQ_IS_ENABLED
+(&
+d_i
+->
+if_d
+)) {
+
+1495 
+	`tq_hassify
+(&
+d_i
+->
+if_d
+, 
+m
+, &
+pkr
+);
+
+1499 
+n
+ = 
+m
+->
+m_pkthdr
+.len;
+
+1500 
+m
+->
+m_ags
+ |
+M_PROTO1
+;
+
+1501 
+mags
+ = 
+m
+->
+m_ags
+;
+
+1503 
+	`IFQ_ENQUEUE
+(&
+d_i
+->
+if_d
+, 
+m
+, &
+pkr
+, 
+r
+);
+
+1505 i(
+r
+) {
+
+1507 
+sc
+->
+sc_if
+.
+if_s
+++;
+
+1511 
+sc
+->
+sc_if
+.
+if_acks
+++;
+
+1512 
+sc
+->
+sc_if
+.
+if_obys
+ +
+n
+;
+
+1514 
+d_i
+->
+if_obys
+ +
+n
+;
+
+1516 i(
+mags
+ & 
+M_MCAST
+) {
+
+1517 
+sc
+->
+sc_if
+.
+if_oms
+++;
+
+1518 
+d_i
+->
+if_oms
+++;
+
+1521 i((
+d_i
+->
+if_ags
+ & 
+IFF_OACTIVE
+) == 0)
+
+1522 (*
+d_i
+->
+if_t
+)(dst_ifp);
+
+1523 
+	}
+}
+
+1536 
+	$bridge_ouut
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+, c 
+sockaddr
+ *
+
+,
+
+1537 
+y
+ *
+
+)
+
+1539 
+h_hd
+ *
+eh
+;
+
+1540 
+i
+ *
+d_if
+;
+
+1541 
+bridge_soc
+ *
+sc
+;
+
+1542 #ide
+BRIDGE_MPSAFE
+
+
+1543 
+s
+;
+
+1546 i(
+m
+->
+m_n
+ < 
+ETHER_HDR_LEN
+) {
+
+1547 
+m
+ = 
+	`m_puup
+(m, 
+ETHER_HDR_LEN
+);
+
+1548 i(
+m
+ =
+NULL
+)
+
+1552 
+eh
+ = 
+	`mtod
+(
+m
+, 
+h_hd
+ *);
+
+1553 
+sc
+ = 
+i
+->
+if_bridge
+;
+
+1555 #ide
+BRIDGE_MPSAFE
+
+
+1556 
+s
+ = 
+	`
+();
+
+1564 i(
+	`__edi_l
+(
+sc
+ =
+NULL
+) ||
+
+1565 (
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_RUNNING
+) == 0) {
+
+1566 
+d_if
+ = 
+i
+;
+
+1567 
+nduni
+;
+
+1574 i(
+	`ETHER_IS_MULTICAST
+(
+eh
+->
+h_dho
+))
+
+1575 
+d_if
+ = 
+NULL
+;
+
+1577 
+d_if
+ = 
+	`bridge_lookup
+(
+sc
+, 
+eh
+->
+h_dho
+);
+
+1578 i(
+d_if
+ =
+NULL
+) {
+
+1579 
+bridge_ii
+ *
+bif
+;
+
+1580 
+mbuf
+ *
+mc
+;
+
+1581 
+ud
+ = 0;
+
+1582 
+ss
+;
+
+1584 
+	`BRIDGE_PSZ_RENTER
+(
+ss
+);
+
+1585 
+	`LIST_FOREACH
+(
+bif
+, &
+sc
+->
+sc_ii
+, 
+bif_xt
+) {
+
+1586 
+bif
+ = 
+	`bridge_y_hd_bif
+(bif);
+
+1587 i(
+bif
+ =
+NULL
+)
+
+1589 
+	`BRIDGE_PSZ_REXIT
+(
+ss
+);
+
+1591 
+d_if
+ = 
+bif
+->
+bif_i
+;
+
+1592 i((
+d_if
+->
+if_ags
+ & 
+IFF_RUNNING
+) == 0)
+
+1593 
+xt
+;
+
+1601 i(
+d_if
+ !
+i
+ &&
+
+1602 (
+bif
+->
+bif_ags
+ & 
+IFBIF_STP
+) != 0) {
+
+1603 
+bif
+->
+bif_e
+) {
+
+1604 
+BSTP_IFSTATE_BLOCKING
+:
+
+1605 
+BSTP_IFSTATE_LISTENING
+:
+
+1606 
+BSTP_IFSTATE_DISABLED
+:
+
+1607 
+xt
+;
+
+1611 i(
+	`LIST_NEXT
+(
+bif
+, 
+bif_xt
+=
+NULL
+) {
+
+1612 
+ud
+ = 1;
+
+1613 
+mc
+ = 
+m
+;
+
+1615 
+mc
+ = 
+	`m_cym
+(
+m
+, 0, 
+M_COPYALL
+, 
+M_NOWAIT
+);
+
+1616 i(
+mc
+ =
+NULL
+) {
+
+1617 
+sc
+->
+sc_if
+.
+if_s
+++;
+
+1618 
+xt
+;
+
+1622 
+	`bridge_queue
+(
+sc
+, 
+d_if
+, 
+mc
+, 0);
+
+1623 
+xt
+:
+
+1624 
+	`bridge_a_memb
+(
+sc
+, 
+bif
+);
+
+1625 
+	`BRIDGE_PSZ_RENTER
+(
+ss
+);
+
+1627 
+	`BRIDGE_PSZ_REXIT
+(
+ss
+);
+
+1629 i(
+ud
+ == 0)
+
+1630 
+	`m_m
+(
+m
+);
+
+1631 #ide
+BRIDGE_MPSAFE
+
+
+1632 
+	`lx
+(
+s
+);
+
+1637 
+nduni
+:
+
+1642 i((
+d_if
+->
+if_ags
+ & 
+IFF_RUNNING
+) == 0) {
+
+1643 
+	`m_m
+(
+m
+);
+
+1644 #ide
+BRIDGE_MPSAFE
+
+
+1645 
+	`lx
+(
+s
+);
+
+1650 
+	`bridge_queue
+(
+sc
+, 
+d_if
+, 
+m
+, 0);
+
+1652 #ide
+BRIDGE_MPSAFE
+
+
+1653 
+	`lx
+(
+s
+);
+
+1656 
+	}
+}
+
+1666 
+	$bridge_t
+(
+i
+ *
+i
+)
+
+1669 
+	`tf
+("%s: bridge_t(ed\n", 
+i
+->
+if_xme
+);
+
+1670 
+	}
+}
+
+1678 
+	$bridge_fwd
+(*
+v
+)
+
+1680 
+	`tf
+("bridge_forward\n");
+
+1681 
+bridge_soc
+ *
+sc
+ = 
+v
+;
+
+1682 
+mbuf
+ *
+m
+;
+
+1683 
+bridge_ii
+ *
+bif
+;
+
+1684 
+i
+ *
+c_if
+, *
+d_if
+;
+
+1685 
+h_hd
+ *
+eh
+;
+
+1686 #ide
+BRIDGE_MPSAFE
+
+
+1687 
+s
+;
+
+1689 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+1690 
+	`mux_r
+(
+sot_lock
+);
+
+1693 i((
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_RUNNING
+) == 0) {
+
+1694 #ide
+BRIDGE_MPSAFE
+
+
+1695 
+	`mux_ex
+(
+sot_lock
+);
+
+1696 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+1701 #ide
+BRIDGE_MPSAFE
+
+
+1702 
+s
+ = 
+	`
+();
+
+1704 (
+m
+ = 
+	`pktq_dequeue
+(
+sc
+->
+sc_fwd_pktq
+)!
+NULL
+) {
+
+1705 
+c_if
+ = 
+m
+->
+m_pkthdr
+.
+rcvif
+;
+
+1707 
+sc
+->
+sc_if
+.
+if_acks
+++;
+
+1708 
+sc
+->
+sc_if
+.
+if_ibys
+ +
+m
+->
+m_pkthdr
+.
+n
+;
+
+1713 
+bif
+ = 
+	`bridge_lookup_memb_if
+(
+sc
+, 
+c_if
+);
+
+1714 i(
+bif
+ =
+NULL
+) {
+
+1716 
+	`m_m
+(
+m
+);
+
+1720 i(
+bif
+->
+bif_ags
+ & 
+IFBIF_STP
+) {
+
+1721 
+bif
+->
+bif_e
+) {
+
+1722 
+BSTP_IFSTATE_BLOCKING
+:
+
+1723 
+BSTP_IFSTATE_LISTENING
+:
+
+1724 
+BSTP_IFSTATE_DISABLED
+:
+
+1725 
+	`m_m
+(
+m
+);
+
+1726 
+	`bridge_a_memb
+(
+sc
+, 
+bif
+);
+
+1731 
+eh
+ = 
+	`mtod
+(
+m
+, 
+h_hd
+ *);
+
+1738 i((
+bif
+->
+bif_ags
+ & 
+IFBIF_LEARNING
+) != 0 &&
+
+1739 
+	`ETHER_IS_MULTICAST
+(
+eh
+->
+h_sho
+) == 0 &&
+
+1740 (
+eh
+->
+h_sho
+[0] == 0 &&
+
+1741 
+eh
+->
+h_sho
+[1] == 0 &&
+
+1742 
+eh
+->
+h_sho
+[2] == 0 &&
+
+1743 
+eh
+->
+h_sho
+[3] == 0 &&
+
+1744 
+eh
+->
+h_sho
+[4] == 0 &&
+
+1745 
+eh
+->
+h_sho
+[5] == 0) == 0) {
+
+1746 (
+	`bridge_upde
+(
+sc
+, 
+eh
+->
+h_sho
+,
+
+1747 
+c_if
+, 0, 
+IFBAF_DYNAMIC
+);
+
+1750 i((
+bif
+->
+bif_ags
+ & 
+IFBIF_STP
+) != 0 &&
+
+1751 
+bif
+->
+bif_e
+ =
+BSTP_IFSTATE_LEARNING
+) {
+
+1752 
+	`m_m
+(
+m
+);
+
+1753 
+	`bridge_a_memb
+(
+sc
+, 
+bif
+);
+
+1757 
+	`bridge_a_memb
+(
+sc
+, 
+bif
+);
+
+1768 i((
+m
+->
+m_ags
+ & (
+M_BCAST
+|
+M_MCAST
+)) == 0) {
+
+1769 
+d_if
+ = 
+	`bridge_lookup
+(
+sc
+, 
+eh
+->
+h_dho
+);
+
+1770 i(
+c_if
+ =
+d_if
+) {
+
+1771 
+	`m_m
+(
+m
+);
+
+1776 
+sc
+->
+sc_if
+.
+if_ims
+++;
+
+1777 
+d_if
+ = 
+NULL
+;
+
+1780 i(
+	`pf_run_hooks
+(
+sc
+->
+sc_if
+.
+if_pf
+, &
+m
+,
+
+1781 
+m
+->
+m_pkthdr
+.
+rcvif
+, 
+PFIL_IN
+) != 0) {
+
+1782 i(
+m
+ !
+NULL
+)
+
+1783 
+	`m_m
+(
+m
+);
+
+1786 i(
+m
+ =
+NULL
+)
+
+1789 i(
+d_if
+ =
+NULL
+) {
+
+1790 
+	`bridge_brd
+(
+sc
+, 
+c_if
+, 
+m
+);
+
+1798 i((
+d_if
+->
+if_ags
+ & 
+IFF_RUNNING
+) == 0) {
+
+1799 
+	`m_m
+(
+m
+);
+
+1803 
+bif
+ = 
+	`bridge_lookup_memb_if
+(
+sc
+, 
+d_if
+);
+
+1804 i(
+bif
+ =
+NULL
+) {
+
+1806 
+	`m_m
+(
+m
+);
+
+1810 i(
+bif
+->
+bif_ags
+ & 
+IFBIF_STP
+) {
+
+1811 
+bif
+->
+bif_e
+) {
+
+1812 
+BSTP_IFSTATE_DISABLED
+:
+
+1813 
+BSTP_IFSTATE_BLOCKING
+:
+
+1814 
+	`m_m
+(
+m
+);
+
+1815 
+	`bridge_a_memb
+(
+sc
+, 
+bif
+);
+
+1820 
+	`bridge_a_memb
+(
+sc
+, 
+bif
+);
+
+1822 
+	`bridge_queue
+(
+sc
+, 
+d_if
+, 
+m
+, 1);
+
+1824 #ide
+BRIDGE_MPSAFE
+
+
+1825 
+	`lx
+(
+s
+);
+
+1826 
+	`mux_ex
+(
+sot_lock
+);
+
+1827 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+1829 
+	}
+}
+
+1831 
+bo
+
+
+1832 
+	$bp_e_befe_ng
+(
+bridge_ii
+ *
+bif
+)
+
+1834 i(
+bif
+->
+bif_ags
+ & 
+IFBIF_STP
+) {
+
+1835 
+bif
+->
+bif_e
+) {
+
+1836 
+BSTP_IFSTATE_BLOCKING
+:
+
+1837 
+BSTP_IFSTATE_LISTENING
+:
+
+1838 
+BSTP_IFSTATE_DISABLED
+:
+
+1839  
+ue
+;
+
+1842  
+l
+;
+
+1843 
+	}
+}
+
+1845 
+bo
+
+
+1846 
+	$bridge_outh
+(
+bridge_ii
+ *
+bif
+, 
+h_hd
+ *
+eh
+, 
+c
+)
+
+1848 
+ut8_t
+ *
+h
+ = 
+c
+ ? 
+eh
+->
+h_sho
+ :h->
+h_dho
+;
+
+1850 i(
+	`memcmp
+(
+	`CLLADDR
+(
+bif
+->
+bif_i
+->
+if_dl
+), 
+h
+, 
+ETHER_ADDR_LEN
+) == 0
+
+1851 #i
+NCARP
+ > 0
+
+1852 || (
+bif
+->
+bif_i
+->
+if_
+ &&
+
+1853 
+	`_outh
+(
+bif
+->
+bif_i
+->
+if_
+, 
+eh
+, 
+IFT_ETHER
+, 
+c
+!
+NULL
+)
+
+1856  
+ue
+;
+
+1858  
+l
+;
+
+1859 
+	}
+}
+
+1868 
+	$bridge_put
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+)
+
+1870 
+bridge_soc
+ *
+sc
+ = 
+i
+->
+if_bridge
+;
+
+1871 
+bridge_ii
+ *
+bif
+;
+
+1872 
+h_hd
+ *
+eh
+;
+
+1874 i(
+	`__edi_l
+(
+sc
+ =
+NULL
+) ||
+
+1875 (
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_RUNNING
+) == 0) {
+
+1876 
+	`h_put
+(
+i
+, 
+m
+);
+
+1880 
+bif
+ = 
+	`bridge_lookup_memb_if
+(
+sc
+, 
+i
+);
+
+1881 i(
+bif
+ =
+NULL
+) {
+
+1882 
+	`h_put
+(
+i
+, 
+m
+);
+
+1886 
+eh
+ = 
+	`mtod
+(
+m
+, 
+h_hd
+ *);
+
+1888 i(
+	`ETHER_IS_MULTICAST
+(
+eh
+->
+h_dho
+)) {
+
+1889 i(
+	`memcmp
+(
+hbrdaddr
+,
+
+1890 
+eh
+->
+h_dho
+, 
+ETHER_ADDR_LEN
+) == 0)
+
+1891 
+m
+->
+m_ags
+ |
+M_BCAST
+;
+
+1893 
+m
+->
+m_ags
+ |
+M_MCAST
+;
+
+1900 i(!(
+m
+->
+m_ags
+ & (
+M_BCAST
+|
+M_MCAST
+)) &&
+
+1901 !
+	`bp_e_befe_ng
+(
+bif
+)) {
+
+1902 
+bridge_ii
+ *
+_bif
+;
+
+1903 
+i
+ *
+_i
+ = 
+NULL
+;
+
+1904 
+s
+;
+
+1906 
+	`BRIDGE_PSZ_RENTER
+(
+s
+);
+
+1907 
+	`LIST_FOREACH
+(
+_bif
+, &
+sc
+->
+sc_ii
+, 
+bif_xt
+) {
+
+1909 i(
+	`bridge_outh
+(
+_bif
+, 
+eh
+, 0)) {
+
+1910 
+_bif
+ = 
+	`bridge_y_hd_bif
+(_bif);
+
+1911 
+	`BRIDGE_PSZ_REXIT
+(
+s
+);
+
+1912 i(
+_bif
+ =
+NULL
+)
+
+1913 
+out
+;
+
+1914 i(
+_bif
+->
+bif_ags
+ & 
+IFBIF_LEARNING
+)
+
+1915 (
+	`bridge_upde
+(
+sc
+,
+
+1916 
+eh
+->
+h_sho
+, 
+i
+, 0, 
+IFBAF_DYNAMIC
+);
+
+1917 
+_i
+ = 
+m
+->
+m_pkthdr
+.
+rcvif
+ = 
+_bif
+->
+bif_i
+;
+
+1918 
+	`bridge_a_memb
+(
+sc
+, 
+_bif
+);
+
+1919 
+out
+;
+
+1923 i(
+	`bridge_outh
+(
+_bif
+, 
+eh
+, 1))
+
+1926 
+	`BRIDGE_PSZ_REXIT
+(
+s
+);
+
+1927 
+out
+:
+
+1929 i(
+_bif
+ !
+NULL
+) {
+
+1930 
+	`bridge_a_memb
+(
+sc
+, 
+bif
+);
+
+1931 i(
+_i
+ !
+NULL
+)
+
+1932 
+	`h_put
+(
+_i
+, 
+m
+);
+
+1934 
+	`m_m
+(
+m
+);
+
+1940 i(
+bif
+->
+bif_ags
+ & 
+IFBIF_STP
+ &&
+
+1941 
+	`memcmp
+(
+eh
+->
+h_dho
+, 
+bp_haddr
+, 
+ETHER_ADDR_LEN
+) == 0) {
+
+1942 
+	`bp_put
+(
+sc
+, 
+bif
+, 
+m
+);
+
+1943 
+	`bridge_a_memb
+(
+sc
+, 
+bif
+);
+
+1951 i(
+	`bp_e_befe_ng
+(
+bif
+)) {
+
+1952 
+	`bridge_a_memb
+(
+sc
+, 
+bif
+);
+
+1953 
+	`h_put
+(
+i
+, 
+m
+);
+
+1957 
+	`bridge_a_memb
+(
+sc
+, 
+bif
+);
+
+1960 i(
+	`__edi_l
+(!
+	`pktq_queue
+(
+sc
+->
+sc_fwd_pktq
+, 
+m
+, 0)))
+
+1961 
+	`m_m
+(
+m
+);
+
+1962 
+	}
+}
+
+1972 
+	$bridge_brd
+(
+bridge_soc
+ *
+sc
+, 
+i
+ *
+c_if
+,
+
+1973 
+mbuf
+ *
+m
+)
+
+1975 
+bridge_ii
+ *
+bif
+;
+
+1976 
+mbuf
+ *
+mc
+;
+
+1977 
+i
+ *
+d_if
+;
+
+1978 
+bo
+ 
+ud
+, 
+bm
+;
+
+1979 
+s
+;
+
+1981 
+ud
+ = 
+bm
+ = 
+m
+->
+m_ags
+ & (
+M_BCAST
+|
+M_MCAST
+);
+
+1983 
+	`BRIDGE_PSZ_RENTER
+(
+s
+);
+
+1984 
+	`LIST_FOREACH
+(
+bif
+, &
+sc
+->
+sc_ii
+, 
+bif_xt
+) {
+
+1985 
+bif
+ = 
+	`bridge_y_hd_bif
+(bif);
+
+1986 i(
+bif
+ =
+NULL
+)
+
+1988 
+	`BRIDGE_PSZ_REXIT
+(
+s
+);
+
+1990 
+d_if
+ = 
+bif
+->
+bif_i
+;
+
+1991 i(
+d_if
+ =
+c_if
+)
+
+1992 
+xt
+;
+
+1994 i(
+bif
+->
+bif_ags
+ & 
+IFBIF_STP
+) {
+
+1995 
+bif
+->
+bif_e
+) {
+
+1996 
+BSTP_IFSTATE_BLOCKING
+:
+
+1997 
+BSTP_IFSTATE_DISABLED
+:
+
+1998 
+xt
+;
+
+2002 i((
+bif
+->
+bif_ags
+ & 
+IFBIF_DISCOVER
+=0 && !
+bm
+)
+
+2003 
+xt
+;
+
+2005 i((
+d_if
+->
+if_ags
+ & 
+IFF_RUNNING
+) == 0)
+
+2006 
+xt
+;
+
+2008 i(!
+ud
+ && 
+	`LIST_NEXT
+(
+bif
+, 
+bif_xt
+=
+NULL
+) {
+
+2009 
+mc
+ = 
+m
+;
+
+2010 
+ud
+ = 
+ue
+;
+
+2012 
+mc
+ = 
+	`m_cym
+(
+m
+, 0, 
+M_COPYALL
+, 
+M_DONTWAIT
+);
+
+2013 i(
+mc
+ =
+NULL
+) {
+
+2014 
+sc
+->
+sc_if
+.
+if_s
+++;
+
+2015 
+xt
+;
+
+2019 
+	`bridge_queue
+(
+sc
+, 
+d_if
+, 
+mc
+, 1);
+
+2020 
+xt
+:
+
+2021 
+	`bridge_a_memb
+(
+sc
+, 
+bif
+);
+
+2022 
+	`BRIDGE_PSZ_RENTER
+(
+s
+);
+
+2024 
+	`BRIDGE_PSZ_REXIT
+(
+s
+);
+
+2026 i(
+bm
+)
+
+2027 
+	`h_put
+(
+c_if
+, 
+m
+);
+
+2028 i(!
+ud
+)
+
+2029 
+	`m_m
+(
+m
+);
+
+2030 
+	}
+}
+
+2033 
+	$bridge_loc
+(
+bridge_soc
+ *
+sc
+, c 
+ut8_t
+ *
+d
+,
+
+2034 
+bridge_node
+ **
+bp
+)
+
+2036 
+bridge_node
+ *
+b
+;
+
+2037 
+r
+;
+
+2039 i(
+sc
+->
+sc_bt
+ >sc->
+sc_bmax
+)
+
+2040  
+ENOSPC
+;
+
+2047 
+b
+ = 
+	`po_g
+(&
+bridge_node_po
+, 
+PR_NOWAIT
+);
+
+2048 i(
+b
+ =
+NULL
+)
+
+2049  
+ENOMEM
+;
+
+2051 
+	`memt
+(
+b
+, 0, (*brt));
+
+2052 
+b
+->
+b_expe
+ = 
+time_uime
+ + 
+sc
+->
+sc_btimeout
+;
+
+2053 
+b
+->
+b_ags
+ = 
+IFBAF_DYNAMIC
+;
+
+2054 
+	`memy
+(
+b
+->
+b_addr
+, 
+d
+, 
+ETHER_ADDR_LEN
+);
+
+2056 
+	`BRIDGE_RT_INTR_LOCK
+(
+sc
+);
+
+2057 
+r
+ = 
+	`bridge_node_
+(
+sc
+, 
+b
+);
+
+2058 
+	`BRIDGE_RT_INTR_UNLOCK
+(
+sc
+);
+
+2060 i(
+r
+ != 0) {
+
+2061 
+	`po_put
+(&
+bridge_node_po
+, 
+b
+);
+
+2062  
+r
+;
+
+2065 *
+bp
+ = 
+b
+;
+
+2067 
+	}
+}
+
+2075 
+	$bridge_upde
+(
+bridge_soc
+ *
+sc
+, c 
+ut8_t
+ *
+d
+,
+
+2076 
+i
+ *
+d_if
+, 
+tags
+, 
+ut8_t
+ 
+ags
+)
+
+2078 
+bridge_node
+ *
+b
+;
+
+2079 
+s
+;
+
+2081 
+aga
+:
+
+2086 
+	`BRIDGE_RT_RENTER
+(
+s
+);
+
+2087 
+b
+ = 
+	`bridge_node_lookup
+(
+sc
+, 
+d
+);
+
+2089 i(
+b
+ !
+NULL
+) {
+
+2090 
+b
+->
+b_i
+ = 
+d_if
+;
+
+2091 i(
+tags
+) {
+
+2092 
+b
+->
+b_ags
+ = 
+ags
+;
+
+2093 i(
+ags
+ & 
+IFBAF_STATIC
+)
+
+2094 
+b
+->
+b_expe
+ = 0;
+
+2096 
+b
+->
+b_expe
+ = 
+time_uime
+ + 
+sc
+->
+sc_btimeout
+;
+
+2098 i((
+b
+->
+b_ags
+ & 
+IFBAF_TYPEMASK
+=
+IFBAF_DYNAMIC
+)
+
+2099 
+b
+->
+b_expe
+ = 
+time_uime
+ + 
+sc
+->
+sc_btimeout
+;
+
+2102 
+	`BRIDGE_RT_REXIT
+(
+s
+);
+
+2104 i(
+b
+ =
+NULL
+) {
+
+2105 
+r
+;
+
+2107 
+r
+ = 
+	`bridge_loc
+(
+sc
+, 
+d
+, &
+b
+);
+
+2108 i(
+r
+ != 0)
+
+2109  
+r
+;
+
+2110 
+aga
+;
+
+2114 
+	}
+}
+
+2121 
+i
+ *
+
+2122 
+	$bridge_lookup
+(
+bridge_soc
+ *
+sc
+, c 
+ut8_t
+ *
+addr
+)
+
+2124 
+bridge_node
+ *
+b
+;
+
+2125 
+i
+ *
+ifs
+ = 
+NULL
+;
+
+2126 
+s
+;
+
+2128 
+	`BRIDGE_RT_RENTER
+(
+s
+);
+
+2129 
+b
+ = 
+	`bridge_node_lookup
+(
+sc
+, 
+addr
+);
+
+2130 i(
+b
+ !
+NULL
+)
+
+2131 
+ifs
+ = 
+b
+->
+b_i
+;
+
+2132 
+	`BRIDGE_RT_REXIT
+(
+s
+);
+
+2134  
+ifs
+;
+
+2135 
+	}
+}
+
+2137 
+	$bo
+ (*
+	tbridge_e_cb_t
+)
+
+2138 (
+	tbridge_soc
+ *, 
+	tbridge_node
+ *, 
+	tbo
+ *, *);
+
+2149 
+	$bridge_li_e_move
+(
+bridge_soc
+ *
+sc
+, 
+bridge_e_cb_t
+ 
+func
+, *
+g
+)
+
+2151 
+bridge_node
+ *
+b
+, *
+nb
+;
+
+2152 
+bridge_node
+ **
+b_li
+;
+
+2153 
+i
+, 
+cou
+;
+
+2155 
+y
+:
+
+2156 
+cou
+ = 
+sc
+->
+sc_bt
+;
+
+2157 i(
+cou
+ == 0)
+
+2159 
+b_li
+ = 
+	`kmem_loc
+((
+bridge_node
+ ** 
+cou
+, 
+KM_SLEEP
+);
+
+2161 
+	`BRIDGE_RT_LOCK
+(
+sc
+);
+
+2162 
+	`BRIDGE_RT_INTR_LOCK
+(
+sc
+);
+
+2163 i(
+	`__edi_l
+(
+sc
+->
+sc_bt
+ > 
+cou
+)) {
+
+2165 
+	`BRIDGE_RT_INTR_UNLOCK
+(
+sc
+);
+
+2166 
+	`BRIDGE_RT_UNLOCK
+(
+sc
+);
+
+2167 
+	`kmem_
+(
+b_li
+, (*b_li* 
+cou
+);
+
+2168 
+y
+;
+
+2171 
+i
+ = 0;
+
+2172 
+	`LIST_FOREACH_SAFE
+(
+b
+, &
+sc
+->
+sc_li
+, 
+b_li
+, 
+nb
+) {
+
+2173 
+bo
+ 
+ed_bak
+ = 
+l
+;
+
+2174 i(
+	`func
+(
+sc
+, 
+b
+, &
+ed_bak
+, 
+g
+)) {
+
+2175 
+	`bridge_node_move
+(
+sc
+, 
+b
+);
+
+2176 
+b_li
+[
+i
+++] = 
+b
+;
+
+2178 i(
+ed_bak
+)
+
+2181 
+	`BRIDGE_RT_INTR_UNLOCK
+(
+sc
+);
+
+2183 i(
+i
+ > 0)
+
+2184 
+	`BRIDGE_RT_PSZ_PERFORM
+(
+sc
+);
+
+2185 
+	`BRIDGE_RT_UNLOCK
+(
+sc
+);
+
+2187 --
+i
+ >= 0)
+
+2188 
+	`bridge_node_deroy
+(
+b_li
+[
+i
+]);
+
+2190 
+	`kmem_
+(
+b_li
+, (*b_li* 
+cou
+);
+
+2191 
+	}
+}
+
+2193 
+bo
+
+
+2194 
+	$bridge_im0_cb
+(
+bridge_soc
+ *
+sc
+, 
+bridge_node
+ *
+b
+,
+
+2195 
+bo
+ *
+ed_bak
+, *
+g
+)
+
+2197 i((
+b
+->
+b_ags
+ & 
+IFBAF_TYPEMASK
+=
+IFBAF_DYNAMIC
+) {
+
+2199 i((
+sc
+->
+sc_bt
+ - 1<sc->
+sc_bmax
+)
+
+2200 *
+ed_bak
+ = 
+ue
+;
+
+2201  
+ue
+;
+
+2203  
+l
+;
+
+2204 
+	}
+}
+
+2207 
+	$bridge_im0
+(
+bridge_soc
+ *
+sc
+)
+
+2209 
+	`bridge_li_e_move
+(
+sc
+, 
+bridge_im0_cb
+, 
+NULL
+);
+
+2210 
+	}
+}
+
+2220 
+	$bridge_im
+(
+bridge_soc
+ *
+sc
+)
+
+2224 i(
+sc
+->
+sc_bt
+ <sc->
+sc_bmax
+)
+
+2228 
+	`bridge_age
+(
+sc
+);
+
+2229 i(
+sc
+->
+sc_bt
+ <sc->
+sc_bmax
+)
+
+2232 
+	`bridge_im0
+(
+sc
+);
+
+2235 
+	}
+}
+
+2243 
+	$bridge_tim
+(*
+g
+)
+
+2245 
+bridge_soc
+ *
+sc
+ = 
+g
+;
+
+2247 
+	`wkqueue_queue
+(
+sc
+->
+sc_age_wq
+, &
+bridge_age_wk
+, 
+NULL
+);
+
+2248 
+	}
+}
+
+2251 
+	$bridge_age_wk
+(
+wk
+ *
+wk
+, *
+g
+)
+
+2253 
+bridge_soc
+ *
+sc
+ = 
+g
+;
+
+2255 
+	`KASSERT
+(
+wk
+ =&
+bridge_age_wk
+);
+
+2257 
+	`bridge_age
+(
+sc
+);
+
+2259 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_RUNNING
+)
+
+2260 
+	`out_t
+(&
+sc
+->
+sc_brout
+,
+
+2261 
+bridge_ab_u_riod
+ * 
+hz
+, 
+bridge_tim
+, 
+sc
+);
+
+2262 
+	}
+}
+
+2264 
+bo
+
+
+2265 
+	$bridge_age_cb
+(
+bridge_soc
+ *
+sc
+, 
+bridge_node
+ *
+b
+,
+
+2266 
+bo
+ *
+ed_bak
+, *
+g
+)
+
+2268 i((
+b
+->
+b_ags
+ & 
+IFBAF_TYPEMASK
+=
+IFBAF_DYNAMIC
+ &&
+
+2269 
+time_uime
+ >
+b
+->
+b_expe
+)
+
+2270  
+ue
+;
+
+2272  
+l
+;
+
+2273 
+	}
+}
+
+2281 
+	$bridge_age
+(
+bridge_soc
+ *
+sc
+)
+
+2283 
+	`bridge_li_e_move
+(
+sc
+, 
+bridge_age_cb
+, 
+NULL
+);
+
+2284 
+	}
+}
+
+2287 
+bo
+
+
+2288 
+	$bridge_ush_cb
+(
+bridge_soc
+ *
+sc
+, 
+bridge_node
+ *
+b
+,
+
+2289 
+bo
+ *
+ed_bak
+, *
+g
+)
+
+2291 
+fu
+ = *(*)
+g
+;
+
+2293 i(
+fu
+ || (
+b
+->
+b_ags
+ & 
+IFBAF_TYPEMASK
+=
+IFBAF_DYNAMIC
+)
+
+2294  
+ue
+;
+
+2296  
+l
+;
+
+2297 
+	}
+}
+
+2305 
+	$bridge_ush
+(
+bridge_soc
+ *
+sc
+, 
+fu
+)
+
+2307 
+	`bridge_li_e_move
+(
+sc
+, 
+bridge_ush_cb
+, &
+fu
+);
+
+2308 
+	}
+}
+
+2316 
+	$bridge_daddr
+(
+bridge_soc
+ *
+sc
+, c 
+ut8_t
+ *
+addr
+)
+
+2318 
+bridge_node
+ *
+b
+;
+
+2320 
+	`BRIDGE_RT_LOCK
+(
+sc
+);
+
+2321 
+	`BRIDGE_RT_INTR_LOCK
+(
+sc
+);
+
+2322 i((
+b
+ = 
+	`bridge_node_lookup
+(
+sc
+, 
+addr
+)=
+NULL
+) {
+
+2323 
+	`BRIDGE_RT_INTR_UNLOCK
+(
+sc
+);
+
+2324 
+	`BRIDGE_RT_UNLOCK
+(
+sc
+);
+
+2325  
+ENOENT
+;
+
+2327 
+	`bridge_node_move
+(
+sc
+, 
+b
+);
+
+2328 
+	`BRIDGE_RT_INTR_UNLOCK
+(
+sc
+);
+
+2329 
+	`BRIDGE_RT_PSZ_PERFORM
+(
+sc
+);
+
+2330 
+	`BRIDGE_RT_UNLOCK
+(
+sc
+);
+
+2332 
+	`bridge_node_deroy
+(
+b
+);
+
+2335 
+	}
+}
+
+2343 
+	$bridge_de
+(
+bridge_soc
+ *
+sc
+, 
+i
+ *
+i
+)
+
+2345 
+bridge_node
+ *
+b
+, *
+nb
+;
+
+2347 
+	`BRIDGE_RT_LOCK
+(
+sc
+);
+
+2348 
+	`BRIDGE_RT_INTR_LOCK
+(
+sc
+);
+
+2349 
+	`LIST_FOREACH_SAFE
+(
+b
+, &
+sc
+->
+sc_li
+, 
+b_li
+, 
+nb
+) {
+
+2350 i(
+b
+->
+b_i
+ =
+i
+)
+
+2353 i(
+b
+ =
+NULL
+) {
+
+2354 
+	`BRIDGE_RT_INTR_UNLOCK
+(
+sc
+);
+
+2355 
+	`BRIDGE_RT_UNLOCK
+(
+sc
+);
+
+2358 
+	`bridge_node_move
+(
+sc
+, 
+b
+);
+
+2359 
+	`BRIDGE_RT_INTR_UNLOCK
+(
+sc
+);
+
+2360 
+	`BRIDGE_RT_PSZ_PERFORM
+(
+sc
+);
+
+2361 
+	`BRIDGE_RT_UNLOCK
+(
+sc
+);
+
+2363 
+	`bridge_node_deroy
+(
+b
+);
+
+2364 
+	}
+}
+
+2372 
+	$bridge_ab_
+(
+bridge_soc
+ *
+sc
+)
+
+2374 
+i
+;
+
+2376 
+sc
+->
+sc_hash
+ = 
+	`kmem_loc
+((*sc->sc_hash* 
+BRIDGE_RTHASH_SIZE
+,
+
+2377 
+KM_SLEEP
+);
+
+2379 
+i
+ = 0; i < 
+BRIDGE_RTHASH_SIZE
+; i++)
+
+2380 
+	`LIST_INIT
+(&
+sc
+->
+sc_hash
+[
+i
+]);
+
+2382 
+sc
+->
+sc_hash_key
+ = 
+	`g_32
+();
+
+2384 
+	`LIST_INIT
+(&
+sc
+->
+sc_li
+);
+
+2386 
+sc
+->
+sc_li__lock
+ = 
+	`mux_obj_loc
+(
+MUTEX_DEFAULT
+, 
+IPL_NET
+);
+
+2387 #ifde
+BRIDGE_MPSAFE
+
+
+2388 
+sc
+->
+sc_li_psz
+ = 
+	`prlize_
+();
+
+2389 
+sc
+->
+sc_li_lock
+ = 
+	`mux_obj_loc
+(
+MUTEX_DEFAULT
+, 
+IPL_SOFTNET
+);
+
+2391 
+sc
+->
+sc_li_psz
+ = 
+NULL
+;
+
+2392 
+sc
+->
+sc_li_lock
+ = 
+NULL
+;
+
+2394 
+	}
+}
+
+2402 
+	$bridge_ab_fi
+(
+bridge_soc
+ *
+sc
+)
+
+2405 
+	`kmem_
+(
+sc
+->
+sc_hash
+, (*sc->sc_hash* 
+BRIDGE_RTHASH_SIZE
+);
+
+2406 i(
+sc
+->
+sc_li__lock
+)
+
+2407 
+	`mux_obj_
+(
+sc
+->
+sc_li__lock
+);
+
+2408 i(
+sc
+->
+sc_li_lock
+)
+
+2409 
+	`mux_obj_
+(
+sc
+->
+sc_li_lock
+);
+
+2410 i(
+sc
+->
+sc_li_psz
+)
+
+2411 
+	`prlize_deroy
+(
+sc
+->
+sc_li_psz
+);
+
+2412 
+	}
+}
+
+2418 
+	#mix
+(
+a
+, 
+b
+, 
+c
+) \
+
+2420 
+a
+ -
+b
+; -
+c
+; ^= (c >> 13); \
+
+2421 
+b
+ -
+c
+; b -
+a
+; b ^= (a << 8); \
+
+2422 
+c
+ -
+a
+; c -
+b
+; c ^= (b >> 13); \
+
+2423 
+a
+ -
+b
+; -
+c
+; ^= (c >> 12); \
+
+2424 
+b
+ -
+c
+; b -
+a
+; b ^= (a << 16); \
+
+2425 
+c
+ -
+a
+; c -
+b
+; c ^= (b >> 5); \
+
+2426 
+a
+ -
+b
+; -
+c
+; ^= (c >> 3); \
+
+2427 
+b
+ -
+c
+; b -
+a
+; b ^= (a << 10); \
+
+2428 
+c
+ -
+a
+; c -
+b
+; c ^= (b >> 15); \
+
+2429 }  0)
+
+	)
+
+2431 
+le
+ 
+ut32_t
+
+
+2432 
+	$bridge_hash
+(
+bridge_soc
+ *
+sc
+, c 
+ut8_t
+ *
+addr
+)
+
+2434 
+ut32_t
+ 
+a
+ = 0x9e3779b9, 
+b
+ = 0x9e3779b9, 
+c
+ = 
+sc
+->
+sc_hash_key
+;
+
+2436 
+b
+ +
+addr
+[5] << 8;
+
+2437 
+b
+ +
+addr
+[4];
+
+2438 
+a
+ +
+addr
+[3] << 24;
+
+2439 
+a
+ +
+addr
+[2] << 16;
+
+2440 
+a
+ +
+addr
+[1] << 8;
+
+2441 
+a
+ +
+addr
+[0];
+
+2443 
+	`mix
+(
+a
+, 
+b
+, 
+c
+);
+
+2445  (
+c
+ & 
+BRIDGE_RTHASH_MASK
+);
+
+2446 
+	}
+}
+
+2448 #unde
+mix
+
+
+2455 
+bridge_node
+ *
+
+2456 
+	$bridge_node_lookup
+(
+bridge_soc
+ *
+sc
+, c 
+ut8_t
+ *
+addr
+)
+
+2458 
+bridge_node
+ *
+b
+;
+
+2459 
+ut32_t
+ 
+hash
+;
+
+2460 
+d
+;
+
+2462 
+hash
+ = 
+	`bridge_hash
+(
+sc
+, 
+addr
+);
+
+2463 
+	`LIST_FOREACH
+(
+b
+, &
+sc
+->
+sc_hash
+[
+hash
+], 
+b_hash
+) {
+
+2464 
+d
+ = 
+	`memcmp
+(
+addr
+, 
+b
+->
+b_addr
+, 
+ETHER_ADDR_LEN
+);
+
+2465 i(
+d
+ == 0)
+
+2466  (
+b
+);
+
+2467 i(
+d
+ > 0)
+
+2468  (
+NULL
+);
+
+2471  (
+NULL
+);
+
+2472 
+	}
+}
+
+2481 
+	$bridge_node_
+(
+bridge_soc
+ *
+sc
+, 
+bridge_node
+ *
+b
+)
+
+2483 
+bridge_node
+ *
+lb
+;
+
+2484 
+ut32_t
+ 
+hash
+;
+
+2485 
+d
+;
+
+2487 
+	`KASSERT
+(
+	`BRIDGE_RT_INTR_LOCKED
+(
+sc
+));
+
+2489 
+hash
+ = 
+	`bridge_hash
+(
+sc
+, 
+b
+->
+b_addr
+);
+
+2491 
+lb
+ = 
+	`LIST_FIRST
+(&
+sc
+->
+sc_hash
+[
+hash
+]);
+
+2492 i(
+lb
+ =
+NULL
+) {
+
+2493 
+	`LIST_INSERT_HEAD
+(&
+sc
+->
+sc_hash
+[
+hash
+], 
+b
+, 
+b_hash
+);
+
+2494 
+out
+;
+
+2498 
+d
+ = 
+	`memcmp
+(
+b
+->
+b_addr
+, 
+lb
+->b_addr, 
+ETHER_ADDR_LEN
+);
+
+2499 i(
+d
+ == 0)
+
+2500  (
+EEXIST
+);
+
+2501 i(
+d
+ > 0) {
+
+2502 
+	`LIST_INSERT_BEFORE
+(
+lb
+, 
+b
+, 
+b_hash
+);
+
+2503 
+out
+;
+
+2505 i(
+	`LIST_NEXT
+(
+lb
+, 
+b_hash
+=
+NULL
+) {
+
+2506 
+	`LIST_INSERT_AFTER
+(
+lb
+, 
+b
+, 
+b_hash
+);
+
+2507 
+out
+;
+
+2509 
+lb
+ = 
+	`LIST_NEXT
+b, 
+b_hash
+);
+
+2510 } 
+lb
+ !
+NULL
+);
+
+2512 #ifde
+DIAGNOSTIC
+
+
+2513 
+	`nic
+("bridge_rtnode_insert: impossible");
+
+2516 
+out
+:
+
+2517 
+	`LIST_INSERT_HEAD
+(&
+sc
+->
+sc_li
+, 
+b
+, 
+b_li
+);
+
+2518 
+sc
+->
+sc_bt
+++;
+
+2521 
+	}
+}
+
+2529 
+	$bridge_node_move
+(
+bridge_soc
+ *
+sc
+, 
+bridge_node
+ *
+b
+)
+
+2532 
+	`KASSERT
+(
+	`BRIDGE_RT_INTR_LOCKED
+(
+sc
+));
+
+2534 
+	`LIST_REMOVE
+(
+b
+, 
+b_hash
+);
+
+2535 
+	`LIST_REMOVE
+(
+b
+, 
+b_li
+);
+
+2536 
+sc
+->
+sc_bt
+--;
+
+2537 
+	}
+}
+
+2545 
+	$bridge_node_deroy
+(
+bridge_node
+ *
+b
+)
+
+2548 
+	`po_put
+(&
+bridge_node_po
+, 
+b
+);
+
+2549 
+	}
+}
+
+2551 #i
+defed
+(
+BRIDGE_IPF
+)
+
+2552 
+pf_hd_t
+ *
+_pf_hook
+;
+
+2553 
+pf_hd_t
+ *
+6_pf_hook
+;
+
+2561 
+	$bridge_f
+(*
+g
+, 
+mbuf
+ **
+mp
+, 
+i
+ *
+i
+, 
+d
+)
+
+2563 
+
+, 
+r
+;
+
+2564 
+h_hd
+ *
+eh1
+, 
+eh2
+;
+
+2565 
+c
+ 
+c1
+;
+
+2566 
+ut16_t
+ 
+h_ty
+;
+
+2568 
+
+ = 0;
+
+2569 
+r
+ = -1;
+
+2570 
+eh1
+ = 
+	`mtod
+(*
+mp
+, 
+h_hd
+ *);
+
+2571 
+h_ty
+ = 
+	`ohs
+(
+eh1
+->ether_type);
+
+2576 i(
+h_ty
+ < 
+ETHERMTU
+) {
+
+2577 
+c
+ *
+c2
+ = (*)(
+eh1
+ + 1);
+
+2579 i((*
+mp
+)->
+m_n
+ >
+ETHER_HDR_LEN
+ + 8 &&
+
+2580 
+c2
+->
+c_dp
+ =
+LLC_SNAP_LSAP
+ &&
+
+2581 
+c2
+->
+c_sp
+ =
+LLC_SNAP_LSAP
+ &&
+
+2582 
+c2
+->
+c_c
+ =
+LLC_UI
+) {
+
+2583 
+h_ty
+ = 
+	`hts
+(
+c2
+->
+c_un
+.
+ty_
+.ether_type);
+
+2584 
+
+ = 1;
+
+2597 
+h_ty
+) {
+
+2598 
+ETHERTYPE_ARP
+:
+
+2599 
+ETHERTYPE_REVARP
+:
+
+2601 
+ETHERTYPE_IP
+:
+
+2602 #ifde
+INET6
+
+
+2603 
+ETHERTYPE_IPV6
+:
+
+2607 
+bad
+;
+
+2611 
+	`m_cyda
+(*
+mp
+, 0, 
+ETHER_HDR_LEN
+, (*&
+eh2
+);
+
+2612 
+	`m_adj
+(*
+mp
+, 
+ETHER_HDR_LEN
+);
+
+2615 i(
+
+) {
+
+2616 
+	`m_cyda
+(*
+mp
+, 0, (
+c
+), (*&
+c1
+);
+
+2617 
+	`m_adj
+(*
+mp
+, (
+c
+));
+
+2623 
+	`KASSERT
+(!
+	`u__p
+());
+
+2624 
+h_ty
+)
+
+2626 
+ETHERTYPE_IP
+ :
+
+2627 
+r
+ = (
+d
+ =
+PFIL_IN
+? 
+	`bridge__checkbasic
+(
+mp
+) : 0;
+
+2628 i(
+r
+ == 0)
+
+2629 
+r
+ = 
+	`pf_run_hooks
+(
+_pf_hook
+, 
+mp
+, 
+i
+, 
+d
+);
+
+2631 #ifde
+INET6
+
+
+2632 
+ETHERTYPE_IPV6
+ :
+
+2633 
+r
+ = (
+d
+ =
+PFIL_IN
+? 
+	`bridge_6_checkbasic
+(
+mp
+) : 0;
+
+2634 i(
+r
+ == 0)
+
+2635 
+r
+ = 
+	`pf_run_hooks
+(
+6_pf_hook
+, 
+mp
+, 
+i
+, 
+d
+);
+
+2639 
+r
+ = 0;
+
+2643 i(*
+mp
+ =
+NULL
+)
+
+2644  
+r
+;
+
+2645 i(
+r
+ != 0)
+
+2646 
+bad
+;
+
+2648 
+r
+ = -1;
+
+2653 i(
+
+) {
+
+2654 
+	`M_PREPEND
+(*
+mp
+, (
+c
+), 
+M_DONTWAIT
+);
+
+2655 i(*
+mp
+ =
+NULL
+)
+
+2656  
+r
+;
+
+2657 
+	`bcy
+(&
+c1
+, 
+	`mtod
+(*
+mp
+, *), (
+c
+));
+
+2660 
+	`M_PREPEND
+(*
+mp
+, 
+ETHER_HDR_LEN
+, 
+M_DONTWAIT
+);
+
+2661 i(*
+mp
+ =
+NULL
+)
+
+2662  
+r
+;
+
+2663 
+	`bcy
+(&
+eh2
+, 
+	`mtod
+(*
+mp
+, *), 
+ETHER_HDR_LEN
+);
+
+2667 
+bad
+:
+
+2668 
+	`m_m
+(*
+mp
+);
+
+2669 *
+mp
+ = 
+NULL
+;
+
+2670  
+r
+;
+
+2671 
+	}
+}
+
+2686 
+	$bridge__checkbasic
+(
+mbuf
+ **
+mp
+)
+
+2688 
+mbuf
+ *
+m
+ = *
+mp
+;
+
+2689 
+
+ *ip;
+
+2690 
+n
+, 
+hn
+;
+
+2692 i(*
+mp
+ =
+NULL
+)
+
+2695 i(
+	`IP_HDR_ALIGNED_P
+(
+	`mtod
+(
+m
+, *)) == 0) {
+
+2696 i((
+m
+ = 
+	`m_cyup
+(m, (
+
+),
+
+2697 (
+max_lkhdr
+ + 3& ~3)=
+NULL
+) {
+
+2699 
+	`_c
+(
+IP_STAT_TOOSMALL
+);
+
+2700 
+bad
+;
+
+2702 } i(
+	`__edi_l
+(
+m
+->
+m_n
+ <  (
+
+))) {
+
+2703 i((
+m
+ = 
+	`m_puup
+(m,  (
+
+))=
+NULL
+) {
+
+2704 
+	`_c
+(
+IP_STAT_TOOSMALL
+);
+
+2705 
+bad
+;
+
+2708 
+
+ = 
+	`mtod
+(
+m
+, ip *);
+
+2709 i(
+
+ =
+NULL
+
+bad
+;
+
+2711 i(
+
+->
+_v
+ !
+IPVERSION
+) {
+
+2712 
+	`_c
+(
+IP_STAT_BADVERS
+);
+
+2713 
+bad
+;
+
+2715 
+hn
+ = 
+
+->
+_hl
+ << 2;
+
+2716 i(
+hn
+ < (
+
+)) {
+
+2717 
+	`_c
+(
+IP_STAT_BADHLEN
+);
+
+2718 
+bad
+;
+
+2720 i(
+hn
+ > 
+m
+->
+m_n
+) {
+
+2721 i((
+m
+ = 
+	`m_puup
+(m, 
+hn
+)) == 0) {
+
+2722 
+	`_c
+(
+IP_STAT_BADHLEN
+);
+
+2723 
+bad
+;
+
+2725 
+
+ = 
+	`mtod
+(
+m
+, ip *);
+
+2726 i(
+
+ =
+NULL
+
+bad
+;
+
+2729 
+m
+->
+m_pkthdr
+.
+csum_ags
+ &
+
+2730 ((
+m
+->
+m_pkthdr
+.
+rcvif
+->
+if_csum_ags_rx
+ & 
+M_CSUM_IPv4
+) |
+
+2731 
+M_CSUM_IPv4_BAD
+)) {
+
+2732 
+M_CSUM_IPv4
+|
+M_CSUM_IPv4_BAD
+:
+
+2734 
+bad
+;
+
+2736 
+M_CSUM_IPv4
+:
+
+2744 i(
+	`_cksum
+(
+m
+, 
+hn
+) != 0)
+
+2745 
+bad
+;
+
+2750 
+n
+ = 
+	`ohs
+(
+
+->
+_n
+);
+
+2755 i(
+n
+ < 
+hn
+) {
+
+2756 
+	`_c
+(
+IP_STAT_BADLEN
+);
+
+2757 
+bad
+;
+
+2765 i(
+m
+->
+m_pkthdr
+.
+n
+ <en) {
+
+2766 
+	`_c
+(
+IP_STAT_TOOSHORT
+);
+
+2767 
+bad
+;
+
+2771 *
+mp
+ = 
+m
+;
+
+2774 
+bad
+:
+
+2775 *
+mp
+ = 
+m
+;
+
+2777 
+	}
+}
+
+2779 #ifde
+INET6
+
+
+2786 
+	$bridge_6_checkbasic
+(
+mbuf
+ **
+mp
+)
+
+2788 
+mbuf
+ *
+m
+ = *
+mp
+;
+
+2789 
+6_hdr
+ *
+6
+;
+
+2797 i(
+	`IP6_HDR_ALIGNED_P
+(
+	`mtod
+(
+m
+, *)) == 0) {
+
+2798 
+i
+ *
+i
+ = 
+m
+->
+m_pkthdr
+.
+rcvif
+;
+
+2799 i((
+m
+ = 
+	`m_cyup
+(m, (
+6_hdr
+),
+
+2800 (
+max_lkhdr
+ + 3& ~3)=
+NULL
+) {
+
+2802 
+	`6_c
+(
+IP6_STAT_TOOSMALL
+);
+
+2803 
+	`6_if_c
+(
+i
+, 
+ifs6__hd
+);
+
+2804 
+bad
+;
+
+2806 } i(
+	`__edi_l
+(
+m
+->
+m_n
+ < (
+6_hdr
+))) {
+
+2807 
+i
+ *
+i
+ = 
+m
+->
+m_pkthdr
+.
+rcvif
+;
+
+2808 i((
+m
+ = 
+	`m_puup
+(m, (
+6_hdr
+))=
+NULL
+) {
+
+2809 
+	`6_c
+(
+IP6_STAT_TOOSMALL
+);
+
+2810 
+	`6_if_c
+(
+i
+, 
+ifs6__hd
+);
+
+2811 
+bad
+;
+
+2815 
+6
+ = 
+	`mtod
+(
+m
+, 
+6_hdr
+ *);
+
+2817 i((
+6
+->
+6_vfc
+ & 
+IPV6_VERSION_MASK
+!
+IPV6_VERSION
+) {
+
+2818 
+	`6_c
+(
+IP6_STAT_BADVERS
+);
+
+2819 
+	`6_if_c
+(
+m
+->
+m_pkthdr
+.
+rcvif
+, 
+ifs6__hd
+);
+
+2820 
+bad
+;
+
+2824 *
+mp
+ = 
+m
+;
+
+2827 
+bad
+:
+
+2828 *
+mp
+ = 
+m
+;
+
+2830 
+	}
+}
+
+	@if_bridgevar.h
+
+75 #ide
+_NET_IF_BRIDGEVAR_H_
+
+
+76 
+	#_NET_IF_BRIDGEVAR_H_
+
+
+	)
+
+78 
+	~<sys/out.h
+>
+
+79 
+	~<sys/queue.h
+>
+
+80 
+	~<sys/mux.h
+>
+
+81 
+	~<sys/cdv.h
+>
+
+87 
+	#BRDGADD
+ 0
+
+	)
+
+88 
+	#BRDGDEL
+ 1
+
+	)
+
+89 
+	#BRDGGIFFLGS
+ 2
+
+	)
+
+90 
+	#BRDGSIFFLGS
+ 3
+
+	)
+
+91 
+	#BRDGSCACHE
+ 4
+
+	)
+
+92 
+	#BRDGGCACHE
+ 5
+
+	)
+
+93 
+	#BRDGGIFS
+ 6
+
+	)
+
+94 
+	#BRDGRTS
+ 7
+
+	)
+
+95 
+	#BRDGSADDR
+ 8
+
+	)
+
+96 
+	#BRDGSTO
+ 9
+
+	)
+
+97 
+	#BRDGGTO
+ 10
+
+	)
+
+98 
+	#BRDGDADDR
+ 11
+
+	)
+
+99 
+	#BRDGFLUSH
+ 12
+
+	)
+
+101 
+	#BRDGGPRI
+ 13
+
+	)
+
+102 
+	#BRDGSPRI
+ 14
+
+	)
+
+103 
+	#BRDGGHT
+ 15
+
+	)
+
+104 
+	#BRDGSHT
+ 16
+
+	)
+
+105 
+	#BRDGGFD
+ 17
+
+	)
+
+106 
+	#BRDGSFD
+ 18
+
+	)
+
+107 
+	#BRDGGMA
+ 19
+
+	)
+
+108 
+	#BRDGSMA
+ 20
+
+	)
+
+109 
+	#BRDGSIFPRIO
+ 21
+
+	)
+
+110 
+	#BRDGSIFCOST
+ 22
+
+	)
+
+111 
+	#BRDGGFILT
+ 23
+
+	)
+
+112 
+	#BRDGSFILT
+ 24
+
+	)
+
+117 
+	sifbq
+ {
+
+118 
+	mifbr_ifame
+[
+IFNAMSIZ
+];
+
+119 
+ut32_t
+ 
+	mifbr_ifsags
+;
+
+120 
+ut8_t
+ 
+	mifbr_e
+;
+
+121 
+ut8_t
+ 
+	mifbr_iy
+;
+
+122 
+ut8_t
+ 
+	mifbr_th_co
+;
+
+123 
+ut8_t
+ 
+	mifbr_po
+;
+
+127 
+	#IFBIF_LEARNING
+ 0x01
+
+	)
+
+128 
+	#IFBIF_DISCOVER
+ 0x02
+
+	)
+
+129 
+	#IFBIF_STP
+ 0x04
+
+	)
+
+131 
+	#IFBIFBITS
+ "\020\1LEARNING\2DISCOVER\3STP"
+
+	)
+
+134 
+	#IFBF_FLUSHDYN
+ 0x00
+
+	)
+
+135 
+	#IFBF_FLUSHALL
+ 0x01
+
+	)
+
+138 
+	#IFBF_FILT_USEIPF
+ 0x00000001
+
+	)
+
+139 
+	#IFBF_FILT_MASK
+ 0x00000001
+
+	)
+
+142 
+	#BSTP_IFSTATE_DISABLED
+ 0
+
+	)
+
+143 
+	#BSTP_IFSTATE_LISTENING
+ 1
+
+	)
+
+144 
+	#BSTP_IFSTATE_LEARNING
+ 2
+
+	)
+
+145 
+	#BSTP_IFSTATE_FORWARDING
+ 3
+
+	)
+
+146 
+	#BSTP_IFSTATE_BLOCKING
+ 4
+
+	)
+
+151 
+	sifbifcf
+ {
+
+152 
+ut32_t
+ 
+	mifbic_n
+;
+
+154 * 
+	mifbicu_buf
+;
+
+155 
+ifbq
+ *
+	mifbicu_q
+;
+
+156 } 
+	mifbic_ifbicu
+;
+
+157 
+	#ifbic_buf
+ 
+ifbic_ifbicu
+.
+ifbicu_buf
+
+
+	)
+
+158 
+	#ifbic_q
+ 
+ifbic_ifbicu
+.
+ifbicu_q
+
+
+	)
+
+164 
+	sifbeq
+ {
+
+165 
+	mifba_ifame
+[
+IFNAMSIZ
+];
+
+167 
+	mifba_expe
+;
+
+168 
+ut8_t
+ 
+	mifba_ags
+;
+
+169 
+ut8_t
+ 
+	mifba_d
+[
+ETHER_ADDR_LEN
+];
+
+172 
+	#IFBAF_TYPEMASK
+ 0x03
+
+	)
+
+173 
+	#IFBAF_DYNAMIC
+ 0x00
+
+	)
+
+174 
+	#IFBAF_STATIC
+ 0x01
+
+	)
+
+176 
+	#IFBAFBITS
+ "\020\1STATIC"
+
+	)
+
+181 
+	sifbacf
+ {
+
+182 
+ut32_t
+ 
+	mifbac_n
+;
+
+184 *
+	mifbacu_buf
+;
+
+185 
+ifbeq
+ *
+	mifbacu_q
+;
+
+186 } 
+	mifbac_ifbacu
+;
+
+187 
+	#ifbac_buf
+ 
+ifbac_ifbacu
+.
+ifbacu_buf
+
+
+	)
+
+188 
+	#ifbac_q
+ 
+ifbac_ifbacu
+.
+ifbacu_q
+
+
+	)
+
+194 
+	sifbam
+ {
+
+196 
+ut32_t
+ 
+	mifbu_t32
+;
+
+197 
+ut16_t
+ 
+	mifbu_t16
+;
+
+198 
+ut8_t
+ 
+	mifbu_t8
+;
+
+199 } 
+	mifb_ifbu
+;
+
+201 
+	#ifb_csize
+ 
+ifb_ifbu
+.
+ifbu_t32
+
+
+	)
+
+202 
+	#ifb_ime
+ 
+ifb_ifbu
+.
+ifbu_t32
+
+
+	)
+
+203 
+	#ifb_io
+ 
+ifb_ifbu
+.
+ifbu_t16
+
+
+	)
+
+204 
+	#ifb_hlime
+ 
+ifb_ifbu
+.
+ifbu_t8
+
+
+	)
+
+205 
+	#ifb_fwdday
+ 
+ifb_ifbu
+.
+ifbu_t8
+
+
+	)
+
+206 
+	#ifb_maxage
+ 
+ifb_ifbu
+.
+ifbu_t8
+
+
+	)
+
+207 
+	#ifb_fr
+ 
+ifb_ifbu
+.
+ifbu_t32
+
+
+	)
+
+209 #ifde
+_KERNEL
+
+
+210 #ifde
+_KERNEL_OPT
+
+
+211 
+	~"t_t_mp.h
+"
+
+214 
+	~<sys/prlize.h
+>
+
+215 
+	~<sys/wkqueue.h
+>
+
+217 
+	~<t/pktqueue.h
+>
+
+222 
+	sbridge_tim
+ {
+
+223 
+ut16_t
+ 
+	maive
+;
+
+224 
+ut16_t
+ 
+	mvue
+;
+
+227 
+	sbp_cfig_un
+ {
+
+228 
+ut64_t
+ 
+	mcu_roid
+;
+
+229 
+ut64_t
+ 
+	mcu_bridge_id
+;
+
+230 
+ut32_t
+ 
+	mcu_ro_th_co
+;
+
+231 
+ut16_t
+ 
+	mcu_mesge_age
+;
+
+232 
+ut16_t
+ 
+	mcu_max_age
+;
+
+233 
+ut16_t
+ 
+	mcu_hlo_time
+;
+
+234 
+ut16_t
+ 
+	mcu_fwd_day
+;
+
+235 
+ut16_t
+ 
+	mcu_pt_id
+;
+
+236 
+ut8_t
+ 
+	mcu_mesge_ty
+;
+
+237 
+ut8_t
+ 
+	mcu_togy_chge_acknowdgmt
+;
+
+238 
+ut8_t
+ 
+	mcu_togy_chge
+;
+
+241 
+	sbp_t_un
+ {
+
+242 
+ut8_t
+ 
+	mtu_mesge_ty
+;
+
+248 
+	sbridge_ii
+ {
+
+249 
+LIST_ENTRY
+(
+bridge_ii
+
+	mbif_xt
+;
+
+250 
+ut64_t
+ 
+	mbif_desigd_ro
+;
+
+251 
+ut64_t
+ 
+	mbif_desigd_bridge
+;
+
+252 
+ut32_t
+ 
+	mbif_th_co
+;
+
+253 
+ut32_t
+ 
+	mbif_desigd_co
+;
+
+254 
+bridge_tim
+ 
+	mbif_hd_tim
+;
+
+255 
+bridge_tim
+ 
+	mbif_mesge_age_tim
+;
+
+256 
+bridge_tim
+ 
+	mbif_fwd_day_tim
+;
+
+257 
+ut16_t
+ 
+	mbif_pt_id
+;
+
+258 
+ut16_t
+ 
+	mbif_desigd_pt
+;
+
+259 
+bp_cfig_un
+ 
+	mbif_cfig_bpdu
+;
+
+260 
+ut8_t
+ 
+	mbif_e
+;
+
+261 
+ut8_t
+ 
+	mbif_togy_chge_acknowdge
+;
+
+262 
+ut8_t
+ 
+	mbif_cfig_ndg
+;
+
+263 
+ut8_t
+ 
+	mbif_chge_dei_abd
+;
+
+264 
+ut8_t
+ 
+	mbif_iy
+;
+
+265 
+i
+ *
+	mbif_i
+;
+
+266 
+ut32_t
+ 
+	mbif_ags
+;
+
+267 
+ut32_t
+ 
+	mbif_fs
+;
+
+268 
+bo
+ 
+	mbif_wag
+;
+
+274 
+	sbridge_node
+ {
+
+275 
+LIST_ENTRY
+(
+bridge_node
+
+	mb_hash
+;
+
+276 
+LIST_ENTRY
+(
+bridge_node
+
+	mb_li
+;
+
+277 
+i
+ *
+	mb_i
+;
+
+278 
+time_t
+ 
+	mb_expe
+;
+
+279 
+ut8_t
+ 
+	mb_ags
+;
+
+280 
+ut8_t
+ 
+	mb_addr
+[
+ETHER_ADDR_LEN
+];
+
+286 
+	sbridge_soc
+ {
+
+287 
+i
+ 
+	msc_if
+;
+
+288 
+LIST_ENTRY
+(
+bridge_soc
+
+	msc_li
+;
+
+289 
+ut64_t
+ 
+	msc_desigd_ro
+;
+
+290 
+ut64_t
+ 
+	msc_bridge_id
+;
+
+291 
+bridge_ii
+ *
+	msc_ro_pt
+;
+
+292 
+ut32_t
+ 
+	msc_ro_th_co
+;
+
+293 
+ut16_t
+ 
+	msc_max_age
+;
+
+294 
+ut16_t
+ 
+	msc_hlo_time
+;
+
+295 
+ut16_t
+ 
+	msc_fwd_day
+;
+
+296 
+ut16_t
+ 
+	msc_bridge_max_age
+;
+
+297 
+ut16_t
+ 
+	msc_bridge_hlo_time
+;
+
+298 
+ut16_t
+ 
+	msc_bridge_fwd_day
+;
+
+299 
+ut16_t
+ 
+	msc_togy_chge_time
+;
+
+300 
+ut16_t
+ 
+	msc_hd_time
+;
+
+301 
+ut16_t
+ 
+	msc_bridge_iy
+;
+
+302 
+ut8_t
+ 
+	msc_togy_chge_deed
+;
+
+303 
+ut8_t
+ 
+	msc_togy_chge
+;
+
+304 
+bridge_tim
+ 
+	msc_hlo_tim
+;
+
+305 
+bridge_tim
+ 
+	msc_togy_chge_tim
+;
+
+306 
+bridge_tim
+ 
+	msc_t_tim
+;
+
+307 
+ut32_t
+ 
+	msc_bmax
+;
+
+308 
+ut32_t
+ 
+	msc_bt
+;
+
+309 
+ut32_t
+ 
+	msc_btimeout
+;
+
+310 
+out_t
+ 
+	msc_brout
+;
+
+311 
+out_t
+ 
+	msc_bpout
+;
+
+312 
+LIST_HEAD
+(, 
+bridge_ii
+
+	msc_ii
+;
+
+313 
+kmux_t
+ *
+	msc_ii__lock
+;
+
+314 
+kcdv_t
+ 
+	msc_ii_cv
+;
+
+315 
+prlize_t
+ 
+	msc_ii_psz
+;
+
+316 
+kmux_t
+ *
+	msc_ii_lock
+;
+
+317 
+LIST_HEAD
+(, 
+bridge_node
+*
+	msc_hash
+;
+
+318 
+LIST_HEAD
+(, 
+bridge_node
+
+	msc_li
+;
+
+319 
+kmux_t
+ *
+	msc_li__lock
+;
+
+320 
+kmux_t
+ *
+	msc_li_lock
+;
+
+321 
+prlize_t
+ 
+	msc_li_psz
+;
+
+322 
+wkqueue
+ *
+	msc_age_wq
+;
+
+323 
+ut32_t
+ 
+	msc_hash_key
+;
+
+324 
+ut32_t
+ 
+	msc_fr_ags
+;
+
+325 
+pktqueue_t
+ * 
+	msc_fwd_pktq
+;
+
+328 c 
+ut8_t
+ 
+bp_haddr
+[];
+
+330 
+bridge_ifdach
+(
+i
+ *);
+
+332 
+bridge_ouut
+(
+i
+ *, 
+mbuf
+ *, c 
+sockaddr
+ *,
+
+333 
+y
+ *);
+
+335 
+bp_lizi
+(
+bridge_soc
+ *);
+
+336 
+bp_
+(
+bridge_soc
+ *);
+
+337 
+bp_put
+(
+bridge_soc
+ *, 
+bridge_ii
+ *, 
+mbuf
+ *);
+
+339 
+bridge_queue
+(
+bridge_soc
+ *, 
+i
+ *, 
+mbuf
+ *,
+
+342 #ifde
+NET_MPSAFE
+
+
+343 
+	#BRIDGE_MPSAFE
+ 1
+
+	)
+
+346 
+	#BRIDGE_LOCK
+(
+_sc
+i((_sc)->
+sc_ii_lock
+) \
+
+347 
+	`mux_r
+((
+_sc
+)->
+sc_ii_lock
+)
+
+	)
+
+348 
+	#BRIDGE_UNLOCK
+(
+_sc
+i((_sc)->
+sc_ii_lock
+) \
+
+349 
+	`mux_ex
+((
+_sc
+)->
+sc_ii_lock
+)
+
+	)
+
+350 
+	#BRIDGE_LOCKED
+(
+_sc
+(!(_sc)->
+sc_ii_lock
+ || \
+
+351 
+	`mux_owd
+((
+_sc
+)->
+sc_ii_lock
+))
+
+	)
+
+353 
+	#BRIDGE_INTR_LOCK
+(
+_sc
+i((_sc)->
+sc_ii__lock
+) \
+
+354 
+	`mux_r
+((
+_sc
+)->
+sc_ii__lock
+)
+
+	)
+
+355 
+	#BRIDGE_INTR_UNLOCK
+(
+_sc
+i((_sc)->
+sc_ii__lock
+) \
+
+356 
+	`mux_ex
+((
+_sc
+)->
+sc_ii__lock
+)
+
+	)
+
+357 
+	#BRIDGE_INTR_LOCKED
+(
+_sc
+(!(_sc)->
+sc_ii__lock
+ || \
+
+358 
+	`mux_owd
+((
+_sc
+)->
+sc_ii__lock
+))
+
+	)
+
+360 #ifde
+BRIDGE_MPSAFE
+
+
+364 
+	#BRIDGE_PSZ_RENTER
+(
+__s
+) do { \
+
+365 i(!
+	`u__p
+()) \
+
+366 
+__s
+ = 
+	`prlize_ad_r
+(); \
+
+368 
+__s
+ = 
+	`lhigh
+(); \
+
+369 } 0)
+
+	)
+
+370 
+	#BRIDGE_PSZ_REXIT
+(
+__s
+) do { \
+
+371 i(!
+	`u__p
+()) \
+
+372 
+	`prlize_ad_ex
+(
+__s
+); \
+
+374 
+	`lx
+(
+__s
+); \
+
+375 } 0)
+
+	)
+
+377 
+	#BRIDGE_PSZ_RENTER
+(
+__s
+d{ __0; } 0)
+
+	)
+
+378 
+	#BRIDGE_PSZ_REXIT
+(
+__s
+d{ ()__s; } 0)
+
+	)
+
+381 
+	#BRIDGE_PSZ_PERFORM
+(
+_sc
+i((_sc)->
+sc_ii_psz
+) \
+
+382 
+	`prlize_rfm
+((
+_sc
+)->
+sc_ii_psz
+);
+
+	)
+
+	@if_cnic.c
+
+3 
+	~<sys/cdefs.h
+>
+
+5 
+	~"t_.h
+"
+
+7 
+	~<sys/m.h
+>
+
+8 
+	~<sys/oc.h
+>
+
+9 
+	~<sys/sym.h
+>
+
+10 
+	~<sys/mbuf.h
+>
+
+11 
+	~<sys/buf.h
+>
+
+12 
+	~<sys/osw.h
+>
+
+13 
+	~<sys/sock.h
+>
+
+14 
+	~<sys/iol.h
+>
+
+15 
+	~<sys/o.h
+>
+
+16 
+	~<sys/syog.h
+>
+
+17 
+	~<sys/.h
+>
+
+18 
+	~<sys/pl.h
+>
+
+19 
+	~<sys/fe.h
+>
+
+20 
+	~<sys/siglv.h
+>
+
+21 
+	~<sys/cf.h
+>
+
+22 
+	~<sys/kauth.h
+>
+
+23 
+	~<sys/mux.h
+>
+
+24 
+	~<sys/u.h
+>
+
+26 
+	~<t/if.h
+>
+
+27 
+	~<t/if_tys.h
+>
+
+28 
+	~<t/ti.h
+>
+
+29 
+	~<t/rou.h
+>
+
+31 #ifde
+INET
+
+
+32 
+	~<t/.h
+>
+
+33 
+	~<t/_sym.h
+>
+
+34 
+	~<t/_v.h
+>
+
+35 
+	~<t/.h
+>
+
+36 
+	~<t/if_p.h
+>
+
+39 
+	~<sys/time.h
+>
+
+40 
+	~<t/bpf.h
+>
+
+42 
+	~<t/if_ic.h
+>
+
+44 
+	#CNICDEBUG
+ i(
+icdebug
+
+tf
+
+
+	)
+
+45 
+	gicdebug
+ = 0;
+
+46 
+ifqmaxn
+;
+
+47 
+iach
+();
+
+48 
+rump_vmid
+;
+
+49 
+	$LIST_HEAD
+(, 
+ic_soc
+
+ic_soc_li
+;
+
+50 
+	$LIST_HEAD
+(, 
+ic_soc
+
+icz_soc_li
+;
+
+51 
+kmux_t
+ 
+ic_soc_lock
+;
+
+53 
+	`ic_iol
+(
+i
+ *, 
+u_lg
+, *);
+
+54 
+	`ic_ouut
+(
+i
+ *, 
+mbuf
+ *,
+
+55 c 
+sockaddr
+ *, 
+y
+ *
+
+);
+
+56 
+	`ic_e_
+(
+if_e
+ *, );
+
+57 
+	`ic_e_deroy
+(
+i
+ *);
+
+59 
+if_e
+ 
+ic_
+ =
+
+60 
+	`IF_CLONE_INITIALIZER
+("ic", 
+ic_e_
+, 
+ic_e_deroy
+);
+
+62 
+	`iach0
+(
+ic_soc
+ *);
+
+63 
+	`ic
+(
+ic_soc
+ *);
+
+64 
+	`ic_i_so
+(*);
+
+65 
+	`ic_o_so
+(*);
+
+66 #ifde
+ALTQ
+
+
+67 
+	`ict
+(
+i
+ *);
+
+69 
+ic_soc
+ *
+	`ic_fd_un
+(
+dev_t
+);
+
+70 
+ic_soc
+ *
+	`ic_fd_zun
+();
+
+72 
+	`dev_ty_
+(
+ic
+);
+
+73 
+	`dev_ty_o
+(
+ico
+);
+
+74 
+	`dev_ty_ad
+(
+id
+);
+
+75 
+	`dev_ty_wre
+(
+icwre
+);
+
+76 
+	`dev_ty_iol
+(
+iciol
+);
+
+77 
+	`dev_ty_pl
+(
+il
+);
+
+78 
+	`dev_ty_kqfr
+(
+ickqfr
+);
+
+80 
+cos_rumps
+ 
+s
+;
+
+82 c 
+cdevsw
+ 
+ic_cdevsw
+ = {
+
+83 .
+d_
+ = 
+ic
+,
+
+84 .
+d_o
+ = 
+ico
+,
+
+85 .
+d_ad
+ = 
+id
+,
+
+86 .
+d_wre
+ = 
+icwre
+,
+
+87 .
+d_iol
+ = 
+iciol
+,
+
+88 .
+d_
+ = 
+no
+,
+
+89 .
+d_y
+ = 
+nty
+,
+
+90 .
+d_pl
+ = 
+il
+,
+
+91 .
+d_mm
+ = 
+nomm
+,
+
+92 .
+d_kqfr
+ = 
+ickqfr
+,
+
+93 .
+d_disrd
+ = 
+nodisrd
+,
+
+94 .
+d_ag
+ = 
+D_OTHER
+
+
+95 
+	}
+};
+
+99 
+	$iach
+(
+unud
+)
+
+102 
+	`mux_
+(&
+ic_soc_lock
+, 
+MUTEX_DEFAULT
+, 
+IPL_NET
+);
+
+103 
+	`LIST_INIT
+(&
+ic_soc_li
+);
+
+104 
+	`LIST_INIT
+(&
+icz_soc_li
+);
+
+105 
+	`if_e_ch
+(&
+ic_
+);
+
+106 
+	}
+}
+
+112 
+ic_soc
+ *
+
+113 
+	$ic_fd_un
+(
+dev_t
+ 
+dev
+)
+
+115 
+ic_soc
+ *
+
+;
+
+116 
+un
+ = 
+	`m
+(
+dev
+);
+
+118 
+	`mux_r
+(&
+ic_soc_lock
+);
+
+119 
+	`LIST_FOREACH
+(
+
+, &
+ic_soc_li
+, 
+ic_li
+)
+
+120 i(
+un
+ =
+
+->
+ic_un
+)
+
+122 i(
+
+)
+
+123 
+	`mux_r
+(&
+
+->
+ic_lock
+);
+
+124 
+	`mux_ex
+(&
+ic_soc_lock
+);
+
+126  (
+
+);
+
+127 
+	}
+}
+
+133 
+ic_soc
+ *
+
+134 
+	$ic_fd_zun
+(
+un
+)
+
+136 
+ic_soc
+ *
+
+;
+
+138 
+	`mux_r
+(&
+ic_soc_lock
+);
+
+139 
+	`LIST_FOREACH
+(
+
+, &
+icz_soc_li
+, 
+ic_li
+)
+
+140 i(
+un
+ =
+
+->
+ic_un
+)
+
+142 i(
+
+)
+
+143 
+	`LIST_REMOVE
+(
+
+, 
+ic_li
+);
+
+144 
+	`mux_ex
+(&
+ic_soc_lock
+);
+
+145 #ifde
+DIAGNOSTIC
+
+
+146 i(
+
+ !
+NULL
+ && (->
+ic_ags
+ & (
+CNIC_INITED
+|
+CNIC_OPEN
+)) != CNIC_OPEN)
+
+147 
+	`tf
+("ic%d: incsiags: %x\n", 
+un
+, 
+
+->
+ic_ags
+);
+
+150  (
+
+);
+
+151 
+	}
+}
+
+154 
+	$ic_e_
+(
+if_e
+ *
+ifc
+, 
+un
+)
+
+156 
+ic_soc
+ *
+
+;
+
+158 i((
+
+ = 
+	`ic_fd_zun
+(
+un
+)=
+NULL
+) {
+
+160 
+
+ = 
+	`mloc
+((*), 
+M_DEVBUF
+, 
+M_WAITOK
+|
+M_ZERO
+);
+
+162 
+
+->
+ic_un
+ = 
+un
+;
+
+163 
+	`mux_
+(&
+
+->
+ic_lock
+, 
+MUTEX_DEFAULT
+, 
+IPL_NET
+);
+
+164 
+	`l
+(&
+
+->
+ic_rl
+);
+
+165 
+	`l
+(&
+
+->
+ic_wl
+);
+
+168 ()
+	`memt
+(&
+
+->
+ic_if
+, 0, (
+i
+));
+
+171 
+	`if_me
+(&
+
+->
+ic_if
+, 
+ifc
+->
+ifc_me
+, 
+un
+);
+
+172 
+	`iach0
+(
+
+);
+
+173 
+
+->
+ic_ags
+ |
+CNIC_INITED
+;
+
+174 
+
+->
+ic_osih
+ = 
+	`sot_eablish
+(
+SOFTINT_CLOCK
+, 
+ic_o_so
+,p);
+
+175 
+
+->
+ic_isih
+ = 
+	`sot_eablish
+(
+SOFTINT_CLOCK
+, 
+ic_i_so
+,p);
+
+177 
+	`mux_r
+(&
+ic_soc_lock
+);
+
+178 
+	`LIST_INSERT_HEAD
+(&
+ic_soc_li
+, 
+
+, 
+ic_li
+);
+
+179 
+	`mux_ex
+(&
+ic_soc_lock
+);
+
+182 
+	}
+}
+
+185 
+	$iach0
+(
+ic_soc
+ *
+
+)
+
+187 
+i
+ *
+i
+;
+
+189 
+i
+ = &
+
+->
+ic_if
+;
+
+190 
+i
+->
+if_soc
+ = 
+
+;
+
+191 
+i
+->
+if_mtu
+ = 
+CNICMTU
+;
+
+192 
+i
+->
+if_iol
+ = 
+ic_iol
+;
+
+193 
+i
+->
+if_ouut
+ = 
+ic_ouut
+;
+
+194 #ifde
+ALTQ
+
+
+195 
+i
+->
+if_t
+ = 
+ict
+;
+
+197 
+i
+->
+if_ags
+ = 
+IFF_POINTOPOINT
+;
+
+198 
+i
+->
+if_ty
+ = 
+IFT_TUNNEL
+;
+
+199 
+i
+->
+if_d
+.
+ifq_maxn
+ = 
+ifqmaxn
+;
+
+200 
+i
+->
+if_clisis
+ = 0;
+
+201 
+i
+->
+if_s
+ = 0;
+
+202 
+i
+->
+if_s
+ = 0;
+
+203 
+i
+->
+if_acks
+ = 0;
+
+204 
+i
+->
+if_acks
+ = 0;
+
+205 
+i
+->
+if_ibys
+ = 0;
+
+206 
+i
+->
+if_obys
+ = 0;
+
+207 
+i
+->
+if_d
+ = 
+DLT_NULL
+;
+
+208 
+	`IFQ_SET_READY
+(&
+i
+->
+if_d
+);
+
+209 
+	`if_ch
+(
+i
+);
+
+210 
+	`if_loc_dl
+(
+i
+);
+
+211 
+	`bpf_ch
+(
+i
+, 
+DLT_NULL
+, (
+ut32_t
+));
+
+212 
+	}
+}
+
+215 
+	$ic_e_deroy
+(
+i
+ *
+i
+)
+
+217 
+ic_soc
+ *
+
+ = (*)
+i
+;
+
+218 
+zomb
+ = 0;
+
+220 
+	`IF_PURGE
+(&
+i
+->
+if_d
+);
+
+221 
+i
+->
+if_ags
+ &~
+IFF_RUNNING
+;
+
+223 
+	`mux_r
+(&
+ic_soc_lock
+);
+
+224 
+	`mux_r
+(&
+
+->
+ic_lock
+);
+
+225 
+	`LIST_REMOVE
+(
+
+, 
+ic_li
+);
+
+226 i(
+
+->
+ic_ags
+ & 
+CNIC_OPEN
+) {
+
+228 
+zomb
+ = 1;
+
+229 
+
+->
+ic_ags
+ &~
+CNIC_INITED
+;
+
+230 
+	`LIST_INSERT_HEAD
+(&
+icz_soc_li
+, 
+
+, 
+ic_li
+);
+
+232 
+	`mux_ex
+(&
+ic_soc_lock
+);
+
+234 i(
+
+->
+ic_ags
+ & 
+CNIC_RWAIT
+) {
+
+235 
+
+->
+ic_ags
+ &~
+CNIC_RWAIT
+;
+
+236 
+	`wakeup
+((*)
+
+);
+
+238 
+	`ify
+(&
+
+->
+ic_rl
+, 0, 0);
+
+240 
+	`mux_ex
+(&
+
+->
+ic_lock
+);
+
+242 i(
+
+->
+ic_ags
+ & 
+CNIC_ASYNC
+ &&p->
+ic_pgid
+)
+
+243 
+	`fownsigl
+(
+
+->
+ic_pgid
+, 
+SIGIO
+, 
+POLL_HUP
+, 0, 
+NULL
+);
+
+245 
+	`bpf_dach
+(
+i
+);
+
+246 
+	`if_dach
+(
+i
+);
+
+248 i(!
+zomb
+) {
+
+249 
+	`lderoy
+(&
+
+->
+ic_rl
+);
+
+250 
+	`lderoy
+(&
+
+->
+ic_wl
+);
+
+251 
+	`sot_diablish
+(
+
+->
+ic_osih
+);
+
+252 
+	`sot_diablish
+(
+
+->
+ic_isih
+);
+
+253 
+	`mux_deroy
+(&
+
+->
+ic_lock
+);
+
+254 
+	`
+(
+
+, 
+M_DEVBUF
+);
+
+258 
+	}
+}
+
+265 
+	$ic
+(
+dev_t
+ 
+dev
+, 
+ag
+, 
+mode
+, 
+lwp
+ *
+l
+)
+
+267 
+i
+ *
+i
+;
+
+268 
+ic_soc
+ *
+
+;
+
+269 
+r
+;
+
+271 
+r
+ = 
+	`kauth_authize_twk
+(
+l
+->
+l_ed
+, 
+KAUTH_NETWORK_INTERFACE_TUN
+,
+
+272 
+KAUTH_REQ_NETWORK_INTERFACE_TUN_ADD
+, 
+NULL
+, NULL, NULL);
+
+273 i(
+r
+)
+
+274  (
+r
+);
+
+276 
+
+ = 
+	`ic_fd_un
+(
+dev
+);
+
+278 i(
+
+ =
+NULL
+) {
+
+279 ()
+	`ic_e_
+(&
+ic_
+, 
+	`m
+(
+dev
+));
+
+280 
+
+ = 
+	`ic_fd_un
+(
+dev
+);
+
+281 i(
+
+ =
+NULL
+) {
+
+282 
+r
+ = 
+ENXIO
+;
+
+283 
+out_nock
+;
+
+287 i(
+
+->
+ic_ags
+ & 
+CNIC_OPEN
+) {
+
+288 
+r
+ = 
+EBUSY
+;
+
+289 
+out
+;
+
+292 
+i
+ = &
+
+->
+ic_if
+;
+
+293 
+
+->
+ic_ags
+ |
+CNIC_OPEN
+;
+
+294 
+	`CNICDEBUG
+("%s: on\n", 
+i
+->
+if_xme
+);
+
+295 
+out
+:
+
+296 
+	`mux_ex
+(&
+
+->
+ic_lock
+);
+
+297 
+out_nock
+:
+
+298  (
+r
+);
+
+299 
+	}
+}
+
+306 
+	$ico
+(
+dev_t
+ 
+dev
+, 
+ag
+, 
+mode
+,
+
+307 
+lwp
+ *
+l
+)
+
+309 
+ic_soc
+ *
+
+;
+
+310 
+i
+ *
+i
+;
+
+312 i((
+
+ = 
+	`ic_fd_zun
+(
+	`m
+(
+dev
+))!
+NULL
+) {
+
+314 
+	`lderoy
+(&
+
+->
+ic_rl
+);
+
+315 
+	`lderoy
+(&
+
+->
+ic_wl
+);
+
+316 
+	`sot_diablish
+(
+
+->
+ic_osih
+);
+
+317 
+	`sot_diablish
+(
+
+->
+ic_isih
+);
+
+318 
+	`mux_deroy
+(&
+
+->
+ic_lock
+);
+
+319 
+	`
+(
+
+, 
+M_DEVBUF
+);
+
+320 
+out_nock
+;
+
+323 i((
+
+ = 
+	`ic_fd_un
+(
+dev
+)=
+NULL
+)
+
+324 
+out_nock
+;
+
+326 
+i
+ = &
+
+->
+ic_if
+;
+
+328 
+
+->
+ic_ags
+ &~
+CNIC_OPEN
+;
+
+330 
+
+->
+ic_pgid
+ = 0;
+
+331 
+	`ify
+(&
+
+->
+ic_rl
+, 0, 0);
+
+333 
+	`CNICDEBUG
+ ("%s: clod\n", 
+i
+->
+if_xme
+);
+
+334 
+	`mux_ex
+(&
+
+->
+ic_lock
+);
+
+339 
+	`IFQ_PURGE
+(&
+i
+->
+if_d
+);
+
+341 i(
+i
+->
+if_ags
+ & 
+IFF_UP
+) {
+
+342 
+	`if_down
+(
+i
+);
+
+343 i(
+i
+->
+if_ags
+ & 
+IFF_RUNNING
+) {
+
+345 
+iddr
+ *
+i
+;
+
+346 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+) {
+
+347 #i
+	`defed
+(
+INET
+|| defed(
+INET6
+)
+
+348 i(
+i
+->
+i_addr
+->
+_my
+ =
+AF_INET
+ ||
+
+349 
+i
+->
+i_addr
+->
+_my
+ =
+AF_INET6
+) {
+
+350 
+	`
+(
+i
+, ()
+RTM_DELETE
+,
+
+351 
+
+->
+ic_ags
+ & 
+CNIC_DSTADDR
+
+
+352 ? 
+RTF_HOST
+
+
+359 
+out_nock
+:
+
+361 
+	}
+}
+
+367 
+	$ic
+(
+ic_soc
+ *
+
+)
+
+369 
+i
+ *
+i
+ = &
+
+->
+ic_if
+;
+
+370 
+iddr
+ *
+i
+;
+
+372 
+	`CNICDEBUG
+("%s: cnic\n", 
+i
+->
+if_xme
+);
+
+374 
+	`mux_r
+(&
+
+->
+ic_lock
+);
+
+375 
+i
+->
+if_ags
+ |
+IFF_UP
+ | 
+IFF_RUNNING
+;
+
+377 
+
+->
+ic_ags
+ &~(
+CNIC_IASET
+|
+CNIC_DSTADDR
+);
+
+378 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+) {
+
+379 #ifde
+INET
+
+
+380 i(
+i
+->
+i_addr
+->
+_my
+ =
+AF_INET
+) {
+
+381 
+sockaddr_
+ *
+s
+;
+
+383 
+s
+ = 
+	`tos
+(
+i
+->
+i_addr
+);
+
+384 i(
+s
+ && s->
+s_addr
+.
+s_addr
+)
+
+385 
+
+->
+ic_ags
+ |
+CNIC_IASET
+;
+
+387 i(
+i
+->
+if_ags
+ & 
+IFF_POINTOPOINT
+) {
+
+388 
+s
+ = 
+	`tos
+(
+i
+->
+i_daddr
+);
+
+389 i(
+s
+ && s->
+s_addr
+.
+s_addr
+)
+
+390 
+
+->
+ic_ags
+ |
+CNIC_DSTADDR
+;
+
+394 #ifde
+INET6
+
+
+395 i(
+i
+->
+i_addr
+->
+_my
+ =
+AF_INET6
+) {
+
+396 
+sockaddr_6
+ *
+s
+;
+
+398 
+s
+ = (
+sockaddr_6
+ *)
+i
+->
+i_addr
+;
+
+399 i(!
+	`IN6_IS_ADDR_UNSPECIFIED
+(&
+s
+->
+s6_addr
+))
+
+400 
+
+->
+ic_ags
+ |
+CNIC_IASET
+;
+
+402 i(
+i
+->
+if_ags
+ & 
+IFF_POINTOPOINT
+) {
+
+403 
+s
+ = (
+sockaddr_6
+ *)
+i
+->
+i_daddr
+;
+
+404 i(
+s
+ &&
+
+405 !
+	`IN6_IS_ADDR_UNSPECIFIED
+(&
+s
+->
+s6_addr
+))
+
+406 
+
+->
+ic_ags
+ |
+CNIC_DSTADDR
+;
+
+408 
+
+->
+ic_ags
+ &~
+CNIC_DSTADDR
+;
+
+412 
+	`mux_ex
+(&
+
+->
+ic_lock
+);
+
+413 
+	}
+}
+
+419 
+	$ic_iol
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+421 
+r
+ = 0, 
+s
+;
+
+422 
+ic_soc
+ *
+
+ = (ic_so*)(
+i
+->
+if_soc
+);
+
+423 
+ieq
+ *
+i
+ = (ieq *)
+da
+;
+
+424 
+iddr
+ *
+i
+ = (idd*)
+da
+;
+
+426 
+s
+ = 
+	`
+();
+
+428 
+cmd
+) {
+
+429 
+SIOCINITIFADDR
+:
+
+430 
+	`ic
+(
+
+);
+
+431 
+i
+->
+i_que
+ = 
+p2p_que
+;
+
+432 
+	`CNICDEBUG
+("%s:ddst\n", 
+i
+->
+if_xme
+);
+
+434 
+SIOCSIFBRDADDR
+:
+
+435 
+	`CNICDEBUG
+("%s: brdddst\n", 
+i
+->
+if_xme
+);
+
+437 
+SIOCSIFMTU
+:
+
+438 i(
+i
+->
+i_mtu
+ > 
+CNICMTU
+ || ifr->ifr_mtu < 576) {
+
+439 
+r
+ = 
+EINVAL
+;
+
+442 
+	`CNICDEBUG
+("%s: i mtu s\n", 
+i
+->
+if_xme
+);
+
+443 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)=
+ENETRESET
+)
+
+444 
+r
+ = 0;
+
+446 
+SIOCADDMULTI
+:
+
+447 
+SIOCDELMULTI
+:
+
+448 i(
+i
+ =
+NULL
+) {
+
+449 
+r
+ = 
+EAFNOSUPPORT
+;
+
+452 
+	`ieq_gaddr
+(
+cmd
+, 
+i
+)->
+_my
+) {
+
+453 #ifde
+INET
+
+
+454 
+AF_INET
+:
+
+457 #ifde
+INET6
+
+
+458 
+AF_INET6
+:
+
+462 
+r
+ = 
+EAFNOSUPPORT
+;
+
+467 
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+);
+
+470 
+	`lx
+(
+s
+);
+
+471  (
+r
+);
+
+472 
+	}
+}
+
+478 
+	$ic_ouut
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m0
+, c 
+sockaddr
+ *
+d
+,
+
+479 
+y
+ *
+
+)
+
+481 
+	`tf
+("%s:ic_ouut\n", 
+i
+->
+if_xme
+);
+
+483 
+ic_soc
+ *
+
+ = 
+i
+->
+if_soc
+;
+
+484 
+s
+;
+
+485 
+r
+;
+
+486 #i
+	`defed
+(
+INET
+|| defed(
+INET6
+)
+
+487 
+mn
+;
+
+488 
+ut32_t
+ *
+af
+;
+
+492 
+	`ALTQ_DECL
+(
+tq_pkr
+ 
+pkr
+;)
+
+494 
+s
+ = 
+	`
+();
+
+495 
+	`mux_r
+(&
+
+->
+ic_lock
+);
+
+497 i((
+
+->
+ic_ags
+ & 
+CNIC_READY
+) != CNIC_READY) {
+
+498 
+	`CNICDEBUG
+ ("%s:dy 0%o\n", 
+i
+->
+if_xme
+,
+
+499 
+
+->
+ic_ags
+);
+
+500 
+r
+ = 
+EHOSTDOWN
+;
+
+501 
+out
+;
+
+508 
+	`IFQ_CLASSIFY
+(&
+i
+->
+if_d
+, 
+m0
+, 
+d
+->
+_my
+, &
+pkr
+);
+
+510 
+	`bpf_mp_af
+(
+i
+, 
+d
+->
+_my
+, 
+m0
+);
+
+512 
+d
+->
+_my
+) {
+
+513 #ifde
+INET6
+
+
+514 
+AF_INET6
+:
+
+516 #ifde
+INET
+
+
+517 
+AF_INET
+:
+
+519 #i
+	`defed
+(
+INET
+|| defed(
+INET6
+)
+
+520 i(
+
+->
+ic_ags
+ & 
+CNIC_PREPADDR
+) {
+
+522 
+	`M_PREPEND
+(
+m0
+, 
+d
+->
+_n
+, 
+M_DONTWAIT
+);
+
+523 i(
+m0
+ =
+NULL
+) {
+
+524 
+	`IF_DROP
+(&
+i
+->
+if_d
+);
+
+525 
+r
+ = 
+ENOBUFS
+;
+
+526 
+out
+;
+
+528 
+	`bcy
+(
+d
+, 
+	`mtod
+(
+m0
+, *), d->
+_n
+);
+
+531 i(
+
+->
+ic_ags
+ & 
+CNIC_IFHEAD
+) {
+
+533 
+	`M_PREPEND
+(
+m0
+, (*
+af
+), 
+M_DONTWAIT
+);
+
+534 i(
+m0
+ =
+NULL
+) {
+
+535 
+	`IF_DROP
+(&
+i
+->
+if_d
+);
+
+536 
+r
+ = 
+ENOBUFS
+;
+
+537 
+out
+;
+
+539 
+af
+ = 
+	`mtod
+(
+m0
+,
+ut32_t
+ *);
+
+540 *
+af
+ = 
+	`htl
+(
+d
+->
+_my
+);
+
+542 #ifde
+INET
+
+
+543 i(
+d
+->
+_my
+ !
+AF_INET
+)
+
+546 
+r
+ = 
+EAFNOSUPPORT
+;
+
+547 
+out
+;
+
+551 
+AF_UNSPEC
+:
+
+553 
+	`IFQ_ENQUEUE
+(&
+i
+->
+if_d
+, 
+m0
+, &
+pkr
+, 
+r
+);
+
+557 i(
+r
+) {
+
+558 
+i
+->
+if_clisis
+++;
+
+559 
+r
+ = 
+EAFNOSUPPORT
+;
+
+560 
+m0
+ = 
+NULL
+;
+
+561 
+out
+;
+
+563 
+mn
+ = 
+m0
+->
+m_pkthdr
+.
+n
+;
+
+564 
+i
+->
+if_acks
+++;
+
+565 
+i
+->
+if_obys
+ +
+mn
+;
+
+569 
+r
+ = 
+EAFNOSUPPORT
+;
+
+570 
+out
+;
+
+573 i(
+
+->
+ic_ags
+ & 
+CNIC_RWAIT
+) {
+
+574 
+
+->
+ic_ags
+ &~
+CNIC_RWAIT
+;
+
+575 
+	`wakeup
+((*)
+
+);
+
+577 i(
+
+->
+ic_ags
+ & 
+CNIC_ASYNC
+ &&p->
+ic_pgid
+)
+
+578 
+	`sot_schedu
+(
+
+->
+ic_isih
+);
+
+580 
+	`ify
+(&
+
+->
+ic_rl
+, 0, 0);
+
+581 
+out
+:
+
+582 
+	`mux_ex
+(&
+
+->
+ic_lock
+);
+
+583 
+	`lx
+(
+s
+);
+
+585 i(
+r
+ && 
+m0
+) {
+
+586 
+	`m_m
+(
+m0
+);
+
+589 
+	}
+}
+
+592 
+	$ic_i_so
+(*
+cook
+)
+
+594 
+ic_soc
+ *
+
+ = 
+cook
+;
+
+596 i(
+
+->
+ic_ags
+ & 
+CNIC_ASYNC
+ &&p->
+ic_pgid
+)
+
+597 
+	`fownsigl
+(
+
+->
+ic_pgid
+, 
+SIGIO
+, 
+POLL_IN
+, 
+POLLIN
+|
+POLLRDNORM
+,
+
+598 
+NULL
+);
+
+599 
+	}
+}
+
+602 
+	$ic_o_so
+(*
+cook
+)
+
+604 
+ic_soc
+ *
+
+ = 
+cook
+;
+
+606 i(
+
+->
+ic_ags
+ & 
+CNIC_ASYNC
+ &&p->
+ic_pgid
+)
+
+607 
+	`fownsigl
+(
+
+->
+ic_pgid
+, 
+SIGIO
+, 
+POLL_OUT
+, 
+POLLOUT
+|
+POLLWRNORM
+,
+
+608 
+NULL
+);
+
+609 
+	}
+}
+
+615 
+	$iciol
+(
+dev_t
+ 
+dev
+, 
+u_lg
+ 
+cmd
+, *
+da
+, 
+ag
+, 
+lwp
+ *
+l
+)
+
+617 
+ic_soc
+ *
+
+;
+
+618 
+s
+, 
+r
+ = 0;
+
+620 
+s
+ = 
+	`
+();
+
+621 
+
+ = 
+	`ic_fd_un
+(
+dev
+);
+
+624 i(
+
+ =
+NULL
+) {
+
+625 
+r
+ = 
+ENXIO
+;
+
+626 
+out_nock
+;
+
+629 
+cmd
+) {
+
+630 
+CNICSDEBUG
+:
+
+631 
+icdebug
+ = *(*)
+da
+;
+
+634 
+CNICGDEBUG
+:
+
+635 *(*)
+da
+ = 
+icdebug
+;
+
+638 
+CNICSIFMODE
+:
+
+639 *(*)
+da
+ & (
+IFF_POINTOPOINT
+|
+IFF_BROADCAST
+)) {
+
+640 
+IFF_POINTOPOINT
+:
+
+641 
+IFF_BROADCAST
+:
+
+642 i(
+
+->
+ic_if
+.
+if_ags
+ & 
+IFF_UP
+) {
+
+643 
+r
+ = 
+EBUSY
+;
+
+644 
+out
+;
+
+646 
+
+->
+ic_if
+.
+if_ags
+ &=
+
+647 ~(
+IFF_BROADCAST
+|
+IFF_POINTOPOINT
+|
+IFF_MULTICAST
+);
+
+648 
+
+->
+ic_if
+.
+if_ags
+ |*(*)
+da
+;
+
+651 
+r
+ = 
+EINVAL
+;
+
+652 
+out
+;
+
+656 
+CNICSLMODE
+:
+
+657 i(*(*)
+da
+) {
+
+658 
+
+->
+ic_ags
+ |
+CNIC_PREPADDR
+;
+
+659 
+
+->
+ic_ags
+ &~
+CNIC_IFHEAD
+;
+
+661 
+
+->
+ic_ags
+ &~
+CNIC_PREPADDR
+;
+
+664 
+CNICSIFHEAD
+:
+
+665 i(*(*)
+da
+) {
+
+666 
+
+->
+ic_ags
+ |
+CNIC_IFHEAD
+;
+
+667 
+
+->
+ic_ags
+ &~
+CNIC_PREPADDR
+;
+
+669 
+
+->
+ic_ags
+ &~
+CNIC_IFHEAD
+;
+
+672 
+CNICGIFHEAD
+:
+
+673 *(*)
+da
+ = (
+
+->
+ic_ags
+ & 
+CNIC_IFHEAD
+);
+
+676 
+FIONBIO
+:
+
+677 i(*(*)
+da
+)
+
+678 
+
+->
+ic_ags
+ |
+CNIC_NBIO
+;
+
+680 
+
+->
+ic_ags
+ &~
+CNIC_NBIO
+;
+
+683 
+FIOASYNC
+:
+
+684 i(*(*)
+da
+)
+
+685 
+
+->
+ic_ags
+ |
+CNIC_ASYNC
+;
+
+687 
+
+->
+ic_ags
+ &~
+CNIC_ASYNC
+;
+
+690 
+FIONREAD
+:
+
+691 i(
+
+->
+ic_if
+.
+if_d
+.
+ifq_hd
+)
+
+692 *(*)
+da
+ = 
+
+->
+ic_if
+.
+if_d
+.
+ifq_hd
+->
+m_pkthdr
+.
+n
+;
+
+694 *(*)
+da
+ = 0;
+
+697 
+TIOCSPGRP
+:
+
+698 
+FIOSETOWN
+:
+
+699 
+r
+ = 
+	`ftown
+(&
+
+->
+ic_pgid
+, 
+cmd
+, 
+da
+);
+
+702 
+TIOCGPGRP
+:
+
+703 
+FIOGETOWN
+:
+
+704 
+r
+ = 
+	`fgown
+(
+
+->
+ic_pgid
+, 
+cmd
+, 
+da
+);
+
+708 
+r
+ = 
+ENOTTY
+;
+
+711 
+out
+:
+
+712 
+	`mux_ex
+(&
+
+->
+ic_lock
+);
+
+713 
+out_nock
+:
+
+714 
+	`lx
+(
+s
+);
+
+715  (
+r
+);
+
+716 
+	}
+}
+
+723 
+	$id
+(
+dev_t
+ 
+dev
+, 
+uio
+ *uio, 
+ioag
+)
+
+725 
+	`tf
+("iad %d:\n", 
+rump_vmid
+);
+
+727 
+ic_soc
+ *
+
+;
+
+728 
+i
+ *
+i
+;
+
+729 
+mbuf
+ *
+m
+, *
+m0
+;
+
+730 
+r
+ = 0, 
+n
+, 
+s
+, 
+dex
+;
+
+732 
+s
+ = 
+	`
+();
+
+733 
+
+ = 
+	`ic_fd_un
+(
+dev
+);
+
+736 i(
+
+ =
+NULL
+) {
+
+737 
+r
+ = 
+ENXIO
+;
+
+738 
+out_nock
+;
+
+741 
+dex
+ = 
+
+->
+ic_if
+.
+if_dex
+;
+
+742 
+i
+ = &
+
+->
+ic_if
+;
+
+744 
+	`CNICDEBUG
+ ("%s:d\n", 
+i
+->
+if_xme
+);
+
+745 i((
+
+->
+ic_ags
+ & 
+CNIC_READY
+) != CNIC_READY) {
+
+746 
+	`CNICDEBUG
+ ("%s:dy 0%o\n", 
+i
+->
+if_xme
+, 
+
+->
+ic_ags
+);
+
+747 
+r
+ = 
+EHOSTDOWN
+;
+
+748 
+out
+;
+
+751 
+
+->
+ic_ags
+ &~
+CNIC_RWAIT
+;
+
+754 
+	`tf
+("loop\n");
+
+755 
+	`IFQ_DEQUEUE
+(&
+i
+->
+if_d
+, 
+m0
+);
+
+756 i(
+m0
+ == 0) {
+
+757 i(
+
+->
+ic_ags
+ & 
+CNIC_NBIO
+) {
+
+758 
+r
+ = 
+EWOULDBLOCK
+;
+
+759 
+out
+;
+
+761 
+
+->
+ic_ags
+ |
+CNIC_RWAIT
+;
+
+762 i(
+	`mtp
+((*)
+
+, 
+PZERO
+|
+PCATCH
+|
+PNORELOCK
+,
+
+763 "id", 0, &
+
+->
+ic_lock
+) != 0) {
+
+764 
+r
+ = 
+EINTR
+;
+
+765 
+out_nock
+;
+
+773 
+
+ = 
+	`ic_fd_un
+(
+dev
+);
+
+774 i(
+
+ =
+NULL
+) {
+
+775 
+r
+ = 
+ENXIO
+;
+
+776 
+out_nock
+;
+
+778 i(
+
+->
+ic_if
+.
+if_dex
+ !
+dex
+) {
+
+779 
+r
+ = 
+ENXIO
+;
+
+780 
+out
+;
+
+784 } 
+m0
+ == 0);
+
+786 
+	`mux_ex
+(&
+
+->
+ic_lock
+);
+
+787 
+	`lx
+(
+s
+);
+
+790 
+m0
+ && 
+uio
+->
+uio_sid
+ > 0 && 
+r
+ == 0) {
+
+791 
+n
+ = 
+	`m
+(
+uio
+->
+uio_sid
+, 
+m0
+->
+m_n
+);
+
+792 i(
+n
+ != 0)
+
+793 
+r
+ = 
+	`uiomove
+(
+	`mtod
+(
+m0
+, *), 
+n
+, 
+uio
+);
+
+794 
+	`MFREE
+(
+m0
+, 
+m
+);
+
+795 
+m0
+ = 
+m
+;
+
+798 i(
+m0
+) {
+
+799 
+	`CNICDEBUG
+("Dropping mbuf\n");
+
+800 
+	`m_m
+(
+m0
+);
+
+802 i(
+r
+)
+
+803 
+i
+->
+if_s
+++;
+
+805  (
+r
+);
+
+807 
+out
+:
+
+808 
+	`tf
+("out\n");
+
+809 
+	`mux_ex
+(&
+
+->
+ic_lock
+);
+
+810 
+out_nock
+:
+
+811 
+	`lx
+(
+s
+);
+
+812  (
+r
+);
+
+813 
+	}
+}
+
+819 
+	$icwre
+(
+dev_t
+ 
+dev
+, 
+uio
+ *uio, 
+ioag
+)
+
+822 
+	`tf
+("cnicwrite\n");
+
+826 
+ic_soc
+ *
+
+;
+
+827 
+i
+ *
+i
+;
+
+828 
+mbuf
+ *
+t
+, **
+mp
+, *
+m
+;
+
+829 
+pktqueue_t
+ *
+pktq
+;
+
+830 
+sockaddr
+ 
+d
+;
+
+831 
+r
+ = 0, 
+s
+, 
+
+, 
+mn
+;
+
+832 
+ut32_t
+ 
+my
+;
+
+834 
+s
+ = 
+	`
+();
+
+835 
+
+ = 
+	`ic_fd_un
+(
+dev
+);
+
+838 i(
+
+ =
+NULL
+) {
+
+839 
+r
+ = 
+ENXIO
+;
+
+840 
+out_nock
+;
+
+844 
+	`mux_ex
+(&
+
+->
+ic_lock
+);
+
+845 
+	`lx
+(
+s
+);
+
+847 
+i
+ = &
+
+->
+ic_if
+;
+
+849 
+	`CNICDEBUG
+("%s: cnicwre\n", 
+i
+->
+if_xme
+);
+
+851 i(
+
+->
+ic_ags
+ & 
+CNIC_PREPADDR
+) {
+
+852 i(
+uio
+->
+uio_sid
+ < (
+d
+)) {
+
+853 
+r
+ = 
+EIO
+;
+
+854 
+out0
+;
+
+856 
+r
+ = 
+	`uiomove
+((*)&
+d
+, (d), 
+uio
+);
+
+857 i(
+d
+.
+_n
+ > (dst)) {
+
+859 
+disrd
+;
+
+860 
+n
+ = 
+d
+.
+_n
+ - (dst);
+
+861 
+n
+--)
+
+862 i((
+r
+ = 
+	`uiomove
+(&
+disrd
+, 1, 
+uio
+)) != 0) {
+
+863 
+out0
+;
+
+866 } i(
+
+->
+ic_ags
+ & 
+CNIC_IFHEAD
+) {
+
+867 i(
+uio
+->
+uio_sid
+ < (
+my
+)){
+
+868 
+r
+ = 
+EIO
+;
+
+869 
+out0
+;
+
+871 
+r
+ = 
+	`uiomove
+((*)&
+my
+, (my), 
+uio
+);
+
+872 
+d
+.
+_my
+ = 
+	`ohl
+(
+my
+);
+
+874 #ifde
+INET
+
+
+875 
+d
+.
+_my
+ = 
+AF_INET
+;
+
+879 i(
+uio
+->
+uio_sid
+ > 
+CNICMTU
+) {
+
+880 
+	`CNICDEBUG
+("%s:=%lu!\n", 
+i
+->
+if_xme
+,
+
+881 ()
+uio
+->
+uio_sid
+);
+
+882 
+r
+ = 
+EIO
+;
+
+883 
+out0
+;
+
+886 
+d
+.
+_my
+) {
+
+887 #ifde
+INET
+
+
+888 
+AF_INET
+:
+
+889 
+pktq
+ = 
+_pktq
+;
+
+892 #ifde
+INET6
+
+
+893 
+AF_INET6
+:
+
+894 
+pktq
+ = 
+6_pktq
+;
+
+898 
+r
+ = 
+EAFNOSUPPORT
+;
+
+899 
+out0
+;
+
+902 
+
+ = 
+uio
+->
+uio_sid
+;
+
+905 
+	`MGETHDR
+(
+m
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+906 i(
+m
+ =
+NULL
+) {
+
+907 
+r
+ = 
+ENOBUFS
+;
+
+908 
+out0
+;
+
+910 
+mn
+ = 
+MHLEN
+;
+
+912 
+t
+ = 
+NULL
+;
+
+913 
+mp
+ = &
+t
+;
+
+914 
+r
+ =0 && 
+uio
+->
+uio_sid
+ > 0) {
+
+915 
+m
+->
+m_n
+ = 
+	`m
+(
+mn
+, 
+uio
+->
+uio_sid
+);
+
+916 
+r
+ = 
+	`uiomove
+(
+	`mtod
+(
+m
+, *), m->
+m_n
+, 
+uio
+);
+
+917 *
+mp
+ = 
+m
+;
+
+918 
+mp
+ = &
+m
+->
+m_xt
+;
+
+919 i(
+r
+ =0 && 
+uio
+->
+uio_sid
+ > 0) {
+
+920 
+	`MGET
+(
+m
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+921 i(
+m
+ =
+NULL
+) {
+
+922 
+r
+ = 
+ENOBUFS
+;
+
+925 
+mn
+ = 
+MLEN
+;
+
+928 i(
+r
+) {
+
+929 i(
+t
+ !
+NULL
+)
+
+930 
+	`m_m
+ (
+t
+);
+
+931 
+i
+->
+if_s
+++;
+
+932 
+out0
+;
+
+935 
+t
+->
+m_pkthdr
+.
+n
+ = 
+
+;
+
+936 
+t
+->
+m_pkthdr
+.
+rcvif
+ = 
+i
+;
+
+938 
+	`bpf_mp_af
+(
+i
+, 
+d
+.
+_my
+, 
+t
+);
+
+940 
+s
+ = 
+	`
+();
+
+941 
+	`mux_r
+(&
+
+->
+ic_lock
+);
+
+942 i((
+
+->
+ic_ags
+ & 
+CNIC_INITED
+) == 0) {
+
+944 
+r
+ = 
+ENXIO
+;
+
+945 
+out
+;
+
+948 
+	`tf
+("pktq_enqueue \n");
+
+949 i(
+	`__edi_l
+(!
+	`pktq_queue
+(
+pktq
+, 
+t
+, 0))) {
+
+950 
+i
+->
+if_clisis
+++;
+
+951 
+	`mux_ex
+(&
+
+->
+ic_lock
+);
+
+952 
+r
+ = 
+ENOBUFS
+;
+
+953 
+	`m_m
+(
+t
+);
+
+954 
+out_nock
+;
+
+956 
+i
+->
+if_acks
+++;
+
+957 
+i
+->
+if_ibys
+ +
+
+;
+
+958 
+out
+:
+
+959 
+	`mux_ex
+(&
+
+->
+ic_lock
+);
+
+960 
+out_nock
+:
+
+961 
+	`lx
+(
+s
+);
+
+962 
+out0
+:
+
+963  (
+r
+);
+
+964 
+	}
+}
+
+966 #ifde
+ALTQ
+
+
+976 
+	$ict
+(
+i
+ *
+i
+)
+
+978 
+ic_soc
+ *
+
+ = 
+i
+->
+if_soc
+;
+
+980 i(!
+	`ALTQ_IS_ENABLED
+(&
+i
+->
+if_d
+&& !
+	`TBR_IS_ENABLED
+(&ifp->if_snd))
+
+983 
+	`mux_r
+(&
+
+->
+ic_lock
+);
+
+984 i(!
+	`IF_IS_EMPTY
+(&
+i
+->
+if_d
+)) {
+
+985 i(
+
+->
+ic_ags
+ & 
+CNIC_RWAIT
+) {
+
+986 
+
+->
+ic_ags
+ &~
+CNIC_RWAIT
+;
+
+987 
+	`wakeup
+((*)
+
+);
+
+989 i(
+
+->
+ic_ags
+ & 
+CNIC_ASYNC
+ &&p->
+ic_pgid
+)
+
+990 
+	`sot_schedu
+(
+
+->
+ic_osih
+);
+
+992 
+	`ify
+(&
+
+->
+ic_rl
+, 0, 0);
+
+994 
+	`mux_ex
+(&
+
+->
+ic_lock
+);
+
+995 
+	}
+}
+
+1003 
+	$il
+(
+dev_t
+ 
+dev
+, 
+evts
+, 
+lwp
+ *
+l
+)
+
+1005 
+ic_soc
+ *
+
+;
+
+1006 
+i
+ *
+i
+;
+
+1007 
+s
+, 
+vts
+ = 0;
+
+1009 
+s
+ = 
+	`
+();
+
+1010 
+
+ = 
+	`ic_fd_un
+(
+dev
+);
+
+1013 i(
+
+ =
+NULL
+)
+
+1014 
+out_nock
+;
+
+1016 
+i
+ = &
+
+->
+ic_if
+;
+
+1018 
+	`CNICDEBUG
+("%s: cnil\n", 
+i
+->
+if_xme
+);
+
+1020 i(
+evts
+ & (
+POLLIN
+ | 
+POLLRDNORM
+)) {
+
+1021 i(!
+	`IFQ_IS_EMPTY
+(&
+i
+->
+if_d
+)) {
+
+1022 
+	`CNICDEBUG
+("%s: cniq=%d\n", 
+i
+->
+if_xme
+,
+
+1023 
+i
+->
+if_d
+.
+ifq_n
+);
+
+1024 
+vts
+ |
+evts
+ & (
+POLLIN
+ | 
+POLLRDNORM
+);
+
+1026 
+	`CNICDEBUG
+("%s: cniwag\n", 
+i
+->
+if_xme
+);
+
+1027 
+	`ecd
+(
+l
+, &
+
+->
+ic_rl
+);
+
+1031 i(
+evts
+ & (
+POLLOUT
+ | 
+POLLWRNORM
+))
+
+1032 
+vts
+ |
+evts
+ & (
+POLLOUT
+ | 
+POLLWRNORM
+);
+
+1034 
+	`mux_ex
+(&
+
+->
+ic_lock
+);
+
+1035 
+out_nock
+:
+
+1036 
+	`lx
+(
+s
+);
+
+1037  (
+vts
+);
+
+1038 
+	}
+}
+
+1041 
+	$ft_idach
+(
+kne
+ *
+kn
+)
+
+1043 
+ic_soc
+ *
+
+ = 
+kn
+->
+kn_hook
+;
+
+1044 
+s
+;
+
+1046 
+s
+ = 
+	`
+();
+
+1047 
+	`SLIST_REMOVE
+(&
+
+->
+ic_rl
+.
+l_kli
+, 
+kn
+, 
+kne
+, 
+kn_ext
+);
+
+1048 
+	`lx
+(
+s
+);
+
+1049 
+	}
+}
+
+1052 
+	$ft_id
+(
+kne
+ *
+kn
+, 
+ht
+)
+
+1054 
+ic_soc
+ *
+
+ = 
+kn
+->
+kn_hook
+;
+
+1055 
+i
+ *
+i
+ = &
+
+->
+ic_if
+;
+
+1056 
+mbuf
+ *
+m
+;
+
+1057 
+s
+;
+
+1059 
+s
+ = 
+	`
+();
+
+1060 
+	`IF_POLL
+(&
+i
+->
+if_d
+, 
+m
+);
+
+1061 i(
+m
+ =
+NULL
+) {
+
+1062 
+	`lx
+(
+s
+);
+
+1066 
+kn
+->
+kn_da
+ = 0; 
+m
+ !
+NULL
+; m = m->
+m_xt
+)
+
+1067 
+kn
+->
+kn_da
+ +
+m
+->
+m_n
+;
+
+1069 
+	`lx
+(
+s
+);
+
+1071 
+	}
+}
+
+1073 c 
+frs
+ 
+	gid_fts
+ =
+
+1074 { 1, 
+NULL
+, 
+ft_idach
+, 
+ft_id
+ };
+
+1076 c 
+frs
+ 
+	gic_rue_fts
+ =
+
+1077 { 1, 
+NULL
+, 
+ft_idach
+, 
+ft_rue
+ };
+
+1080 
+	$ickqfr
+(
+dev_t
+ 
+dev
+, 
+kne
+ *
+kn
+)
+
+1082 
+ic_soc
+ *
+
+;
+
+1083 
+kli
+ *klist;
+
+1084 
+rv
+ = 0, 
+s
+;
+
+1086 
+s
+ = 
+	`
+();
+
+1087 
+
+ = 
+	`ic_fd_un
+(
+dev
+);
+
+1088 i(
+
+ =
+NULL
+)
+
+1089 
+out_nock
+;
+
+1091 
+kn
+->
+kn_fr
+) {
+
+1092 
+EVFILT_READ
+:
+
+1093 
+kli
+ = &
+
+->
+ic_rl
+.
+l_kli
+;
+
+1094 
+kn
+->
+kn_f
+ = &
+id_fts
+;
+
+1097 
+EVFILT_WRITE
+:
+
+1098 
+kli
+ = &
+
+->
+ic_rl
+.
+l_kli
+;
+
+1099 
+kn
+->
+kn_f
+ = &
+ic_rue_fts
+;
+
+1103 
+rv
+ = 
+EINVAL
+;
+
+1104 
+out
+;
+
+1107 
+kn
+->
+kn_hook
+ = 
+
+;
+
+1109 
+	`SLIST_INSERT_HEAD
+(
+kli
+, 
+kn
+, 
+kn_ext
+);
+
+1111 
+out
+:
+
+1112 
+	`mux_ex
+(&
+
+->
+ic_lock
+);
+
+1113 
+out_nock
+:
+
+1114 
+	`lx
+(
+s
+);
+
+1115  (
+rv
+);
+
+1116 
+	}
+}
+
+	@if_cnic.h
+
+1 #ide
+_NET_IF_CNIC_H_
+
+
+2 
+	#_NET_IF_CNIC_H_
+
+
+	)
+
+4 #ifde
+_KERNEL
+
+
+5 
+	sic_soc
+ {
+
+6 
+i
+ 
+	mic_if
+;
+
+8 
+u_sht
+ 
+	mic_ags
+;
+
+9 
+	#CNIC_OPEN
+ 0x0001
+
+	)
+
+10 
+	#CNIC_INITED
+ 0x0002
+
+	)
+
+11 
+	#CNIC_RCOLL
+ 0x0004
+
+	)
+
+12 
+	#CNIC_IASET
+ 0x0008
+
+	)
+
+13 
+	#CNIC_DSTADDR
+ 0x0010
+
+	)
+
+14 
+	#CNIC_RWAIT
+ 0x0040
+
+	)
+
+15 
+	#CNIC_ASYNC
+ 0x0080
+
+	)
+
+16 
+	#CNIC_NBIO
+ 0x0100
+
+	)
+
+17 
+	#CNIC_PREPADDR
+ 0x0200
+
+	)
+
+18 
+	#CNIC_IFHEAD
+ 0x0400
+
+	)
+
+20 
+	#CNIC_READY
+ (
+CNIC_OPEN
+ | 
+CNIC_INITED
+ | 
+CNIC_IASET
+)
+
+	)
+
+22 
+pid_t
+ 
+	mic_pgid
+;
+
+23 
+lfo
+ 
+	mic_rl
+;
+
+24 
+lfo
+ 
+	mic_wl
+;
+
+25 
+	mic_un
+;
+
+26 
+kmux_t
+ 
+	mic_lock
+;
+
+27 
+LIST_ENTRY
+(
+ic_soc
+
+	mic_li
+;
+
+28 *
+	mic_osih
+;
+
+29 *
+	mic_isih
+;
+
+34 
+	#CNICMTU
+ 1500
+
+	)
+
+37 
+	#CNICSDEBUG
+ 
+	`_IOW
+('t', 90, )
+
+	)
+
+38 
+	#CNICGDEBUG
+ 
+	`_IOR
+('t', 89, )
+
+	)
+
+39 
+	#CNICSIFMODE
+ 
+	`_IOW
+('t', 88, )
+
+	)
+
+40 
+	#CNICSLMODE
+ 
+	`_IOW
+('t', 87, )
+
+	)
+
+41 
+	#CNICSIFHEAD
+ 
+	`_IOW
+('t', 66, )
+
+	)
+
+42 
+	#CNICGIFHEAD
+ 
+	`_IOR
+('t', 65, )
+
+	)
+
+	@if_dl.h
+
+52 #ide
+_NET_IF_DL_H_
+
+
+53 
+	#_NET_IF_DL_H_
+
+
+	)
+
+55 
+	~<sys/si.h
+>
+
+57 #ide
+_my_t
+
+
+58 
+___my_t
+ 
+	t_my_t
+;
+
+59 
+	#_my_t
+ 
+___my_t
+
+
+	)
+
+61 #ide
+sockn_t
+
+
+62 
+__sockn_t
+ 
+	tsockn_t
+;
+
+63 
+	#sockn_t
+ 
+__sockn_t
+
+
+	)
+
+66 
+	sdl_addr
+ {
+
+67 
+ut8_t
+ 
+	mdl_ty
+;
+
+68 
+ut8_t
+ 
+	mdl_
+;
+
+69 
+ut8_t
+ 
+	mdl_
+;
+
+70 
+ut8_t
+ 
+	mdl_
+;
+
+75 
+	mdl_da
+[12];
+
+81 
+	ssockaddr_dl
+ {
+
+82 
+ut8_t
+ 
+	msdl_n
+;
+
+83 
+_my_t
+ 
+	msdl_my
+;
+
+84 
+ut16_t
+ 
+	msdl_dex
+;
+
+85 
+dl_addr
+ 
+	msdl_addr
+;
+
+86 
+	#sdl_ty
+ 
+sdl_addr
+.
+dl_ty
+
+
+	)
+
+87 
+	#sdl_
+ 
+sdl_addr
+.
+dl_
+
+
+	)
+
+88 
+	#sdl_
+ 
+sdl_addr
+.
+dl_
+
+
+	)
+
+89 
+	#sdl_
+ 
+sdl_addr
+.
+dl_
+
+
+	)
+
+90 
+	#sdl_da
+ 
+sdl_addr
+.
+dl_da
+
+
+	)
+
+93 
+	#tosdl
+(
+__
+((
+sockaddr_dl
+ *)(__))
+
+	)
+
+94 
+	#tocsdl
+(
+__
+((c 
+sockaddr_dl
+ *)(__))
+
+	)
+
+97 
+	#LLADDR
+(
+s
+((*)((s)->
+sdl_da
+ + (s)->
+sdl_
+))
+
+	)
+
+98 
+	#CLLADDR
+(
+s
+((c *)((s)->
+sdl_da
+ + (s)->
+sdl_
+))
+
+	)
+
+100 #ifde
+_KERNEL
+
+
+101 
+ut8_t
+ 
+sockaddr_dl_msu
+(uint8_t, uint8_t);
+
+102 
+sockaddr
+ *
+sockaddr_dl_loc
+(
+ut16_t
+, 
+ut8_t
+,
+
+103 c *, 
+ut8_t
+, const *, uint8_t, );
+
+104 
+sockaddr_dl
+ *
+sockaddr_dl_
+(sockaddr_d*, 
+sockn_t
+, 
+ut16_t
+,
+
+105 
+ut8_t
+, const *, uint8_t, const *, uint8_t);
+
+106 
+sockaddr_dl
+ *
+sockaddr_dl_ddr
+(sockaddr_d*, 
+sockn_t
+,
+
+107 c *, 
+ut8_t
+);
+
+110 
+	~<sys/cdefs.h
+>
+
+112 
+__BEGIN_DECLS
+
+
+113 
+lk_addr
+(c *, 
+sockaddr_dl
+ *);
+
+114 *
+lk_
+(c 
+sockaddr_dl
+ *);
+
+115 
+	g__END_DECLS
+
+
+119 #i
+defed
+(
+_KERNEL
+|| defed(
+_TEST
+)
+
+121 
+	#LINK_ADDRSTRLEN
+ ((255 * 4+ 5)
+
+	)
+
+123 
+dl_t
+(*, 
+size_t
+, c 
+dl_addr
+ *);
+
+124 
+	#DL_PRINT
+(
+b
+, 
+a
+(
+	`dl_t
+((b), (b), (a)), (b))
+
+	)
+
+125 
+sdl_t
+(*, 
+size_t
+, const *);
+
+	@if_eco.h
+
+30 #ide
+_NET_IF_ECO_H_
+
+
+31 
+	#_NET_IF_ECO_H_
+
+
+	)
+
+33 
+	~<sys/out.h
+>
+
+34 
+	~<sys/mbuf.h
+>
+
+35 
+	~<sys/queue.h
+>
+
+37 
+	~<t/if.h
+>
+
+47 
+	#ECO_ADDR_LEN
+ 2
+
+	)
+
+48 
+	#ECO_HDR_LEN
+ 6
+
+	)
+
+49 
+	#ECO_SHDR_LEN
+ 4
+
+	)
+
+51 
+	#ECO_IPMTU
+ 1280
+
+	)
+
+52 
+	#ECO_MTU
+ 
+ECO_IPMTU
+
+
+	)
+
+54 
+	seco_hd
+ {
+
+55 
+ut8_t
+ 
+	meco_dho
+[
+ECO_ADDR_LEN
+];
+
+56 
+ut8_t
+ 
+	meco_sho
+[
+ECO_ADDR_LEN
+];
+
+57 
+ut8_t
+ 
+	meco_c
+;
+
+58 
+ut8_t
+ 
+	meco_pt
+;
+
+59 } 
+	g__cked
+;
+
+61 
+	#ECO_PORT_IMMEDIATE
+ 0x00
+
+	)
+
+62 
+	#ECO_PORT_DSTAPE
+ 0x54
+
+	)
+
+63 
+	#ECO_PORT_FS
+ 0x99
+
+	)
+
+64 
+	#ECO_PORT_BRIDGE
+ 0x9C
+
+	)
+
+65 
+	#ECO_PORT_PSINQREP
+ 0x9E
+
+	)
+
+66 
+	#ECO_PORT_PSINQ
+ 0x9F
+
+	)
+
+67 
+	#ECO_PORT_FAST
+ 0xA0
+
+	)
+
+68 
+	#ECO_PORT_NEXNETFIND
+ 0xA1
+
+	)
+
+69 
+	#ECO_PORT_FINDSRV
+ 0xB0
+
+	)
+
+70 
+	#ECO_PORT_FINDSRVREP
+ 0xB1
+
+	)
+
+71 
+	#ECO_PORT_TTXTCMD
+ 0xB2
+
+	)
+
+72 
+	#ECO_PORT_TTXTPAGE
+ 0xB3
+
+	)
+
+73 
+	#ECO_PORT_OLDPSDATA
+ 0xD0
+
+	)
+
+74 
+	#ECO_PORT_PSDATA
+ 0xD1
+
+	)
+
+75 
+	#ECO_PORT_IP
+ 0xD2
+
+	)
+
+76 
+	#ECO_PORT_SIDSLAVE
+ 0xD3
+
+	)
+
+77 
+	#ECO_PORT_SCROLLARAMA
+ 0xD4
+
+	)
+
+78 
+	#ECO_PORT_PHONE
+ 0xD5
+
+	)
+
+79 
+	#ECO_PORT_BCASTCTL
+ 0xD6
+
+	)
+
+80 
+	#ECO_PORT_BCASTDATA
+ 0xD7
+
+	)
+
+81 
+	#ECO_PORT_IMPLICENCE
+ 0xD8
+
+	)
+
+82 
+	#ECO_PORT_SQUIRREL
+ 0xD9
+
+	)
+
+83 
+	#ECO_PORT_SID2NDARY
+ 0xDA
+
+	)
+
+84 
+	#ECO_PORT_SQUIRREL2
+ 0xDB
+
+	)
+
+85 
+	#ECO_PORT_DDCTL
+ 0xDC
+
+	)
+
+86 
+	#ECO_PORT_DDDATA
+ 0xDD
+
+	)
+
+87 
+	#ECO_PORT_CLASSROM
+ 0xDE
+
+	)
+
+88 
+	#ECO_PORT_PSCMD
+ 0xDF
+
+	)
+
+91 
+	#ECO_CTL_PEEK
+ 0x81
+
+	)
+
+92 
+	#ECO_CTL_POKE
+ 0x82
+
+	)
+
+93 
+	#ECO_CTL_JSR
+ 0x83
+
+	)
+
+94 
+	#ECO_CTL_USERPROC
+ 0x84
+
+	)
+
+95 
+	#ECO_CTL_OSPROC
+ 0x85
+
+	)
+
+96 
+	#ECO_CTL_HALT
+ 0x86
+
+	)
+
+97 
+	#ECO_CTL_CONTINUE
+ 0x87
+
+	)
+
+98 
+	#ECO_CTL_MACHINEPEEK
+ 0x88
+
+	)
+
+99 
+	#ECO_CTL_GETREGISTERS
+ 0x89
+
+	)
+
+102 
+	#ECO_CTL_IP
+ 0x81
+
+	)
+
+103 
+	#ECO_CTL_IPBCAST_REPLY
+ 0x8E
+
+	)
+
+104 
+	#ECO_CTL_IPBCAST_REQUEST
+ 0x8F
+
+	)
+
+105 
+	#ECO_CTL_ARP_REQUEST
+ 0xA1
+
+	)
+
+106 
+	#ECO_CTL_ARP_REPLY
+ 0xA2
+
+	)
+
+108 
+	seco_p
+ {
+
+109 
+ut8_t
+ 
+	mer_a
+[4];
+
+110 
+ut8_t
+ 
+	mer_a
+[4];
+
+113 
+	eeco_e
+ {
+
+114 
+	mECO_UNKNOWN
+, 
+	mECO_IDLE
+, 
+	mECO_SCOUT_RCVD
+,
+
+115 
+	mECO_SCOUT_SENT
+, 
+	mECO_DATA_SENT
+, 
+	mECO_IMMED_SENT
+,
+
+116 
+	mECO_DONE
+
+
+126 
+	seco_y
+ {
+
+127 
+LIST_ENTRY
+(
+eco_y
+
+	m_lk
+;
+
+128 
+out
+ 
+	m_out
+;
+
+129 
+mbuf
+ *
+	m_ck
+;
+
+130 
+i
+ *
+	m_i
+;
+
+136 
+	secocom
+ {
+
+137 
+i
+ 
+	mec_if
+;
+
+138 (*
+	mec_aimwe
+)(
+	mi
+ *);
+
+139 (*
+	mec_txame
+)(
+	mi
+ *, 
+	mmbuf
+ *);
+
+140 
+eco_e
+ 
+	mec_e
+;
+
+141 
+mbuf
+ *
+	mec_scout
+;
+
+142 
+mbuf
+ *
+	mec_ck
+;
+
+143 
+LIST_HEAD
+(, 
+eco_y
+
+	mec_s
+;
+
+146 #ifde
+_KERNEL
+
+
+147 
+eco_iach
+(
+i
+ *, c 
+ut8_t
+ *);
+
+148 
+eco_ifdach
+(
+i
+ *);
+
+149 
+eco_
+(
+i
+ *);
+
+150 
+eco_
+(
+i
+ *, );
+
+152 *
+eco_rtf
+(c 
+ut8_t
+ *);
+
+154 
+mbuf
+ * 
+eco_putame
+(
+i
+ *, mbuf *);
+
+155 
+eco_putid
+(
+i
+ *);
+
+	@if_ecosubr.c
+
+60 
+	~<sys/cdefs.h
+>
+
+61 
+__KERNEL_RCSID
+(0, "$NetBSD: if_ecosubr.c,v 1.42 2015/05/20 09:17:18 ozaki-r Exp $");
+
+63 
+	~"t_.h
+"
+
+65 
+	~<sys/m.h
+>
+
+66 
+	~<sys/o.h
+>
+
+67 
+	~<sys/kl.h
+>
+
+68 
+	~<sys/sock.h
+>
+
+69 
+	~<sys/sockio.h
+>
+
+70 
+	~<sys/syog.h
+>
+
+71 
+	~<sys/sym.h
+>
+
+73 
+	~<t/if.h
+>
+
+74 
+	~<t/if_dl.h
+>
+
+75 
+	~<t/if_eco.h
+>
+
+76 
+	~<t/if_tys.h
+>
+
+77 
+	~<t/ti.h
+>
+
+78 
+	~<t/rou.h
+>
+
+80 
+	~<t/bpf.h
+>
+
+82 #ifde
+INET
+
+
+83 
+	~<t/htys.h
+>
+
+84 
+	~<t/if_p.h
+>
+
+85 
+	~<t/.h
+>
+
+86 
+	~<t/_v.h
+>
+
+88 
+	~<t/if_p.h
+>
+
+90 
+	seco_yrms
+ {
+
+91 
+	mp_day
+;
+
+92 
+	mp_cou
+;
+
+96 c 
+ut8_t
+ 
+	geco_brdaddr
+[] = { 0xff, 0xff };
+
+98 
+eco_ouut
+(
+i
+ *, 
+mbuf
+ *, c 
+sockaddr
+ *,
+
+99 
+y
+ *);
+
+100 
+eco_put
+(
+i
+ *, 
+mbuf
+ *);
+
+101 
+eco_t
+(
+i
+ *);
+
+102 
+eco_iol
+(
+i
+ *, 
+u_lg
+, *);
+
+104 
+eco_gp
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+);
+
+105 
+mbuf
+ *
+eco_immed
+(
+i
+ *
+i
+, mbu*
+m
+);
+
+106 
+mbuf
+ *
+eco_ack
+(
+i
+ *
+i
+, mbu*
+m
+);
+
+108 
+eco_der
+(
+i
+ *, 
+mbuf
+ *, );
+
+109 
+eco_y_
+(
+eco_y
+ *
+
+);
+
+110 
+eco_y
+(*);
+
+113 
+	$eco_iach
+(
+i
+ *
+i
+, c 
+ut8_t
+ *
+a
+)
+
+115 
+ecocom
+ *
+ec
+ = (*)
+i
+;
+
+117 
+i
+->
+if_ty
+ = 
+IFT_ECONET
+;
+
+118 
+i
+->
+if_add
+ = 
+ECO_ADDR_LEN
+;
+
+119 
+i
+->
+if_hd
+ = 
+ECO_HDR_LEN
+;
+
+120 
+i
+->
+if_d
+ = 
+DLT_ECONET
+;
+
+121 
+i
+->
+if_mtu
+ = 
+ECO_MTU
+;
+
+123 
+i
+->
+if_ouut
+ = 
+eco_ouut
+;
+
+124 
+i
+->
+if_put
+ = 
+eco_put
+;
+
+125 
+i
+->
+if_t
+ = 
+eco_t
+;
+
+126 
+i
+->
+if_iol
+ = 
+eco_iol
+;
+
+129 
+	`if_t_dl
+(
+i
+, 
+a
+, 
+ECO_ADDR_LEN
+, 
+FALSE
+);
+
+131 
+i
+->
+if_brdaddr
+ = 
+eco_brdaddr
+;
+
+133 
+	`LIST_INIT
+(&
+ec
+->
+ec_s
+);
+
+135 
+	`bpf_ch
+(
+i
+, i->
+if_d
+, 
+ECO_HDR_LEN
+);
+
+136 
+	}
+}
+
+138 
+	#ndr
+(
+e
+) do { \
+
+139 
+r
+ = (
+e
+); \
+
+140 
+bad
+; \
+
+141 }  0)
+
+	)
+
+144 
+	$eco_
+(
+i
+ *
+i
+)
+
+146 
+ecocom
+ *
+ec
+ = (ecocom *)
+i
+;
+
+148 i((
+i
+->
+if_ags
+ & 
+IFF_RUNNING
+) == 0)
+
+149 
+ec
+->
+ec_e
+ = 
+ECO_UNKNOWN
+;
+
+151 
+	}
+}
+
+154 
+	$eco_
+(
+i
+ *
+i
+, 
+dib
+)
+
+156 
+ecocom
+ *
+ec
+ = (ecocom *)
+i
+;
+
+158 !
+	`LIST_EMPTY
+(&
+ec
+->
+ec_s
+))
+
+159 
+	`eco_y_
+(
+	`LIST_FIRST
+(&
+ec
+->
+ec_s
+));
+
+160 
+	}
+}
+
+163 
+	$eco_ouut
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m0
+, c 
+sockaddr
+ *
+d
+,
+
+164 
+y
+ *
+0
+)
+
+166 
+eco_hd
+ 
+ehdr
+, *
+eh
+;
+
+167 
+r
+;
+
+168 
+mbuf
+ *
+m
+ = 
+m0
+, *
+mcy
+ = 
+NULL
+;
+
+169 
+y
+ *
+
+;
+
+170 
+hdrcmt
+;
+
+171 
+y_day
+, 
+y_cou
+;
+
+172 
+m_g
+ *
+mg
+;
+
+173 
+eco_yrms
+ *
+p
+;
+
+174 #ifde
+INET
+
+
+175 
+mbuf
+ *
+m1
+;
+
+176 
+phdr
+ *
+ah
+;
+
+177 *
+tha
+;
+
+178 
+eco_p
+ *
+eh
+;
+
+180 
+	`ALTQ_DECL
+(
+tq_pkr
+ 
+pkr
+;)
+
+182 i((
+i
+->
+if_ags
+ & (
+IFF_UP
+|
+IFF_RUNNING
+)) != (IFF_UP|IFF_RUNNING))
+
+183 
+	`ndr
+(
+ENETDOWN
+);
+
+184 i((
+
+ = 
+0
+!
+NULL
+) {
+
+185 i((
+
+->
+_ags
+ & 
+RTF_UP
+) == 0) {
+
+186 i((
+0
+ = 
+
+ = 
+	`loc1
+(
+d
+, 1)!
+NULL
+) {
+
+187 
+
+->
+_ft
+--;
+
+188 i(
+
+->
+_i
+ !
+i
+)
+
+189  (*
+
+->
+_i
+->
+if_ouut
+)
+
+190 (
+i
+, 
+m0
+, 
+d
+, 
+
+);
+
+192 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+194 i((
+
+->
+_ags
+ & 
+RTF_GATEWAY
+)) {
+
+195 i(
+
+->
+_gwrou
+ == 0)
+
+196 
+lookup
+;
+
+197 i(((
+
+ =t->
+_gwrou
+)->
+_ags
+ & 
+RTF_UP
+) == 0) {
+
+198 
+	`
+(
+
+);
+0
+;
+
+199 
+lookup
+: 
+
+->
+_gwrou
+ = 
+	`loc1
+t->
+_geway
+, 1);
+
+200 i((
+
+ =t->
+_gwrou
+) == 0)
+
+201 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+203 i((
+
+->
+_ags
+ & 
+RTF_GATEWAY
+) ||
+
+204 (
+
+->
+_i
+ !
+i
+)) {
+
+205 
+
+->
+_ft
+--;
+
+206 
+0
+->
+_gwrou
+ = 0;
+
+207 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+211 i(
+
+->
+_ags
+ & 
+RTF_REJECT
+)
+
+212 i(
+
+->
+_rmx
+.
+rmx_expe
+ == 0 ||
+
+213 
+time_cd
+ < 
+
+->
+_rmx
+.
+rmx_expe
+)
+
+214 
+	`ndr
+(
+
+ =
+0
+ ? 
+EHOSTDOWN
+ : 
+EHOSTUNREACH
+);
+
+220 
+	`IFQ_CLASSIFY
+(&
+i
+->
+if_d
+, 
+m
+, 
+d
+->
+_my
+, &
+pkr
+);
+
+222 
+hdrcmt
+ = 0;
+
+223 
+y_day
+ = 
+hz
+ / 16;
+
+224 
+y_cou
+ = 16;
+
+225 
+d
+->
+_my
+) {
+
+226 #ifde
+INET
+
+
+227 
+AF_INET
+:
+
+228 i(
+m
+->
+m_ags
+ & 
+M_BCAST
+)
+
+229 
+	`memy
+(
+ehdr
+.
+eco_dho
+, 
+eco_brdaddr
+,
+
+230 
+ECO_ADDR_LEN
+);
+
+232 i(!
+	`esve
+(
+i
+, 
+
+, 
+m
+, 
+d
+, 
+ehdr
+.
+eco_dho
+))
+
+235 i((
+m
+->
+m_ags
+ & 
+M_BCAST
+&& (
+i
+->
+if_ags
+ & 
+IFF_SIMPLEX
+))
+
+236 
+mcy
+ = 
+	`m_cy
+(
+m
+, 0, ()
+M_COPYALL
+);
+
+237 
+ehdr
+.
+eco_pt
+ = 
+ECO_PORT_IP
+;
+
+238 
+ehdr
+.
+eco_c
+ = 
+ECO_CTL_IP
+;
+
+241 
+AF_ARP
+:
+
+242 
+ah
+ = 
+	`mtod
+(
+m
+, 
+phdr
+ *);
+
+244 i(
+	`ohs
+(
+ah
+->
+_o
+!
+ETHERTYPE_IP
+)
+
+245  
+EAFNOSUPPORT
+;
+
+246 
+ehdr
+.
+eco_pt
+ = 
+ECO_PORT_IP
+;
+
+247 
+	`ohs
+(
+ah
+->
+_
+)) {
+
+248 
+ARPOP_REQUEST
+:
+
+249 
+ehdr
+.
+eco_c
+ = 
+ECO_CTL_ARP_REQUEST
+;
+
+251 
+ARPOP_REPLY
+:
+
+252 
+ehdr
+.
+eco_c
+ = 
+ECO_CTL_ARP_REPLY
+;
+
+255  
+EOPNOTSUPP
+;
+
+258 i(
+m
+->
+m_ags
+ & 
+M_BCAST
+)
+
+259 
+	`memy
+(
+ehdr
+.
+eco_dho
+, 
+eco_brdaddr
+,
+
+260 
+ECO_ADDR_LEN
+);
+
+262 
+tha
+ = 
+	`_tha
+(
+ah
+);
+
+263 i(
+tha
+ =
+NULL
+)
+
+265 
+	`memy
+(
+ehdr
+.
+eco_dho
+, 
+tha
+, 
+ECO_ADDR_LEN
+);
+
+268 
+	`MGETHDR
+(
+m1
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+269 i(
+m1
+ =
+NULL
+)
+
+270 
+	`ndr
+(
+ENOBUFS
+);
+
+271 
+	`M_MOVE_PKTHDR
+(
+m1
+, 
+m
+);
+
+272 
+m1
+->
+m_n
+ = (*
+eh
+);
+
+273 
+m1
+->
+m_pkthdr
+.
+n
+ = m1->
+m_n
+;
+
+274 
+	`MH_ALIGN
+(
+m1
+, m1->
+m_n
+);
+
+275 
+eh
+ = 
+	`mtod
+(
+m1
+, 
+eco_p
+ *);
+
+276 
+	`memt
+(
+eh
+, 0, 
+m1
+->
+m_n
+);
+
+277 
+	`memy
+(
+eh
+->
+er_a
+, 
+	`_a
+(
+ah
+),h->
+_n
+);
+
+278 
+	`memy
+(
+eh
+->
+er_a
+, 
+	`_a
+(
+ah
+),h->
+_n
+);
+
+279 
+	`m_m
+(
+m
+);
+
+280 
+m
+ = 
+m1
+;
+
+283 
+pudo_AF_HDRCMPLT
+:
+
+284 
+hdrcmt
+ = 1;
+
+286 
+AF_UNSPEC
+:
+
+287 
+ehdr
+ = *(
+eco_hd
+ c *)
+d
+->
+_da
+;
+
+290 
+	`log
+(
+LOG_ERR
+, "%s: c'hdf%d\n", 
+i
+->
+if_xme
+,
+
+291 
+d
+->
+_my
+);
+
+292 
+	`ndr
+(
+EAFNOSUPPORT
+);
+
+295 i(
+mcy
+)
+
+296 (
+	`loouut
+(
+i
+, 
+mcy
+, 
+d
+, 
+
+);
+
+302 
+	`M_PREPEND
+(
+m
+,  (
+eco_hd
+), 
+M_DONTWAIT
+);
+
+303 i(
+m
+ == 0)
+
+304 
+	`ndr
+(
+ENOBUFS
+);
+
+305 
+eh
+ = 
+	`mtod
+(
+m
+, 
+eco_hd
+ *);
+
+306 *
+eh
+ = 
+ehdr
+;
+
+307 i(!
+hdrcmt
+)
+
+308 
+	`memy
+(
+eh
+->
+eco_sho
+, 
+	`CLLADDR
+(
+i
+->
+if_dl
+),
+
+309 
+ECO_ADDR_LEN
+);
+
+311 i((
+m
+->
+m_ags
+ & 
+M_BCAST
+) == 0) {
+
+313 
+mg
+ = 
+	`m_g_g
+(
+PACKET_TAG_ECO_RETRYPARMS
+,
+
+314 (
+eco_yrms
+), 
+M_NOWAIT
+);
+
+315 i(
+mg
+ =
+NULL
+)
+
+316 
+	`ndr
+(
+ENOBUFS
+);
+
+317 
+p
+ = (
+eco_yrms
+ *)(
+mg
+ + 1);
+
+318 
+p
+->
+p_day
+ = 
+y_day
+;
+
+319 
+p
+->
+p_cou
+ = 
+y_cou
+;
+
+322 i((
+r
+ = 
+	`pf_run_hooks
+(
+i
+->
+if_pf
+, &
+m
+, i, 
+PFIL_OUT
+)) != 0)
+
+323  (
+r
+);
+
+324 i(
+m
+ =
+NULL
+)
+
+327  
+	`ifq_queue
+(
+i
+, 
+m
+ 
+ALTQ_COMMA
+ 
+	`ALTQ_DECL
+(&
+pkr
+));
+
+329 
+bad
+:
+
+330 i(
+m
+)
+
+331 
+	`m_m
+(
+m
+);
+
+332  
+r
+;
+
+333 
+	}
+}
+
+339 
+	$eco_gp
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+)
+
+341 
+eco_hd
+ *
+eh
+;
+
+343 
+eh
+ = 
+	`mtod
+(
+m
+, 
+eco_hd
+ *);
+
+344 
+eh
+->
+eco_pt
+) {
+
+345 #ifde
+INET
+
+
+346 
+ECO_PORT_IP
+:
+
+351 
+	}
+}
+
+354 
+	$eco_put
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+)
+
+356 
+pktqueue_t
+ *
+pktq
+ = 
+NULL
+;
+
+357 
+ifqueue
+ *
+q
+;
+
+358 
+eco_hd
+ 
+ehdr
+, *
+eh
+;
+
+359 
+i
+ = 0;
+
+360 
+s
+;
+
+361 #ifde
+INET
+
+
+362 
+i
+;
+
+363 
+phdr
+ *
+ah
+;
+
+364 
+eco_p
+ *
+eh
+;
+
+365 
+mbuf
+ *
+m1
+;
+
+366 *
+tha
+;
+
+369 i(
+	`pf_run_hooks
+(
+i
+->
+if_pf
+, &
+m
+, i, 
+PFIL_IN
+) != 0)
+
+371 i(
+m
+ =
+NULL
+)
+
+376 
+eh
+ = &
+ehdr
+;
+
+377 
+	`m_cyda
+(
+m
+, 0, 
+ECO_HDR_LEN
+, (*)
+eh
+);
+
+378 
+	`m_adj
+(
+m
+, 
+ECO_HDR_LEN
+);
+
+380 
+eh
+->
+eco_pt
+) {
+
+381 #ifde
+INET
+
+
+382 
+ECO_PORT_IP
+:
+
+383 
+eh
+->
+eco_c
+) {
+
+384 
+ECO_CTL_IP
+:
+
+385 
+pktq
+ = 
+_pktq
+;
+
+387 
+ECO_CTL_ARP_REQUEST
+:
+
+388 
+ECO_CTL_ARP_REPLY
+:
+
+397 i(
+m
+->
+m_pkthdr
+.
+n
+ !(
+eco_p
+))
+
+398 
+dr
+;
+
+399 i(
+m
+->
+m_n
+ < (
+eco_p
+)) {
+
+400 
+m
+ = 
+	`m_puup
+(m, (
+eco_p
+));
+
+401 i(
+m
+ =
+NULL
+
+dr
+;
+
+403 
+eh
+ = 
+	`mtod
+(
+m
+, 
+eco_p
+ *);
+
+405 
+	`MGETHDR
+(
+m1
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+406 i(
+m1
+ =
+NULL
+)
+
+407 
+dr
+;
+
+408 
+	`M_MOVE_PKTHDR
+(
+m1
+, 
+m
+);
+
+409 
+m1
+->
+m_n
+ = (*
+ah
++ 2*(
+_addr
+) +
+
+410 2*
+i
+->
+if_da
+.
+ifi_add
+;
+
+411 
+m1
+->
+m_pkthdr
+.
+n
+ = m1->
+m_n
+;
+
+412 
+	`MH_ALIGN
+(
+m1
+, m1->
+m_n
+);
+
+413 
+ah
+ = 
+	`mtod
+(
+m1
+, 
+phdr
+ *);
+
+414 
+	`memt
+((*)
+ah
+, 0, 
+m1
+->
+m_n
+);
+
+415 
+ah
+->
+_o
+ = 
+	`hts
+(
+ETHERTYPE_IP
+);
+
+416 
+ah
+->
+_h
+ = 
+i
+->
+if_da
+.
+ifi_add
+;
+
+417 
+ah
+->
+_n
+ = (
+_addr
+);
+
+418 i(
+eh
+->
+eco_c
+ =
+ECO_CTL_ARP_REQUEST
+)
+
+419 
+ah
+->
+_
+ = 
+	`hts
+(
+ARPOP_REQUEST
+);
+
+421 
+ah
+->
+_
+ = 
+	`hts
+(
+ARPOP_REPLY
+);
+
+422 
+tha
+ = 
+	`_tha
+(
+ah
+);
+
+423 
+	`KASSERT
+(
+tha
+ !
+NULL
+);
+
+424 
+	`memy
+(
+	`_sha
+(
+ah
+), 
+eh
+->
+eco_sho
+,h->
+_h
+);
+
+425 
+	`memy
+(
+tha
+, 
+eh
+->
+eco_dho
+, 
+ah
+->
+_h
+);
+
+426 
+	`memy
+(
+	`_a
+(
+ah
+), 
+eh
+->
+er_a
+,h->
+_n
+);
+
+427 
+	`memy
+(
+	`_a
+(
+ah
+), 
+eh
+->
+er_a
+,h->
+_n
+);
+
+428 
+	`m_m
+(
+m
+);
+
+429 
+m
+ = 
+m1
+;
+
+430 
+i
+ = 
+NETISR_ARP
+;
+
+431 
+q
+ = &
+pq
+;
+
+433 
+ECO_CTL_IPBCAST_REQUEST
+:
+
+435 
+sockaddr_age
+ 
+d_e
+;
+
+436 
+sockaddr
+ *
+d
+ = (sockadd*)&
+d_e
+;
+
+439 
+	`memy
+(
+eh
+->
+eco_dho
+,h->
+eco_sho
+, 
+ECO_ADDR_LEN
+);
+
+440 
+eh
+->
+eco_c
+ = 
+ECO_CTL_IPBCAST_REPLY
+;
+
+442 
+d
+->
+_my
+ = 
+AF_UNSPEC
+;
+
+443 
+	`memy
+(
+d
+->
+_da
+, 
+eh
+, 
+ECO_HDR_LEN
+);
+
+444 
+i
+->
+	`if_ouut
+(i, 
+m
+, 
+d
+, 
+NULL
+);
+
+448 
+	`tf
+("%s: unknown IP stn %s ctl 0x%02xen %d:",
+
+449 
+i
+->
+if_xme
+, 
+	`eco_rtf
+(
+eh
+->
+eco_sho
+),
+
+450 
+eh
+->
+eco_c
+, 
+m
+->
+m_pkthdr
+.
+n
+);
+
+451 i(
+m
+->
+m_n
+ == 0) {
+
+452 
+m
+ = 
+	`m_puup
+(m, 1);
+
+453 i(
+m
+ == 0) {
+
+454 
+	`tf
+("\n");
+
+455 
+dr
+;
+
+458 
+i
+ = 0; i < 
+m
+->
+m_n
+; i++)
+
+459 
+	`tf
+(" %02x", 
+	`mtod
+(
+m
+, 
+ut8_t
+ *)[
+i
+]);
+
+460 
+	`tf
+("\n");
+
+461 
+dr
+;
+
+466 
+	`tf
+("%s: unknownort stn %sort 0x%02x ctl 0x%02x\n",
+
+467 
+i
+->
+if_xme
+, 
+	`eco_rtf
+(
+eh
+->
+eco_sho
+),
+
+468 
+eh
+->
+eco_pt
+,h->
+eco_c
+);
+
+469 #ifde
+INET
+
+
+470 
+dr
+:
+
+472 
+	`m_m
+(
+m
+);
+
+476 i(
+	`__edi_ue
+(
+pktq
+)) {
+
+477 i(
+	`__edi_l
+(!
+	`pktq_queue
+(
+pktq
+, 
+m
+, 0))) {
+
+478 
+	`m_m
+(
+m
+);
+
+483 
+s
+ = 
+	`
+();
+
+484 i(
+	`IF_QFULL
+(
+q
+)) {
+
+485 
+	`IF_DROP
+(
+q
+);
+
+486 
+	`m_m
+(
+m
+);
+
+488 
+	`IF_ENQUEUE
+(
+q
+, 
+m
+);
+
+489 
+	`schedti
+(
+i
+);
+
+491 
+	`lx
+(
+s
+);
+
+492 
+	}
+}
+
+495 
+	$eco_t
+(
+i
+ *
+i
+)
+
+497 
+ecocom
+ *
+ec
+ = (*)
+i
+;
+
+498 
+mbuf
+ *
+m
+;
+
+499 
+eco_hd
+ *
+eh
+;
+
+501 i(
+ec
+->
+ec_e
+ !
+ECO_IDLE
+) ;
+
+502 
+	`IFQ_DEQUEUE
+(&
+i
+->
+if_d
+, 
+m
+);
+
+503 i(
+m
+ =
+NULL
+) ;
+
+504 i(
+ec
+->
+	`ec_aimwe
+(
+i
+) == 0) {
+
+505 
+eh
+ = 
+	`mtod
+(
+m
+, 
+eco_hd
+ *);
+
+506 i(
+eh
+->
+eco_pt
+ =
+ECO_PORT_IMMEDIATE
+) {
+
+507 
+ec
+->
+	`ec_txame
+(
+i
+, 
+m
+);
+
+508 
+ec
+->
+ec_e
+ = 
+ECO_IMMED_SENT
+;
+
+509 } i(
+eh
+->
+eco_dho
+[0] == 255) {
+
+510 
+ec
+->
+	`ec_txame
+(
+i
+, 
+m
+);
+
+511 
+ec
+->
+ec_e
+ = 
+ECO_DONE
+;
+
+513 
+ec
+->
+ec_ck
+ = 
+m
+;
+
+514 
+m
+ = 
+	`m_cym
+(m, 0, 
+ECO_HDR_LEN
+, 
+M_DONTWAIT
+);
+
+515 i(
+m
+ =
+NULL
+) {
+
+516 
+	`m_m
+(
+ec
+->
+ec_ck
+);
+
+517 
+ec
+->
+ec_ck
+ = 
+NULL
+;
+
+520 
+ec
+->
+	`ec_txame
+(
+i
+, 
+m
+);
+
+521 
+ec
+->
+ec_e
+ = 
+ECO_SCOUT_SENT
+;
+
+523 
+i
+->
+if_ags
+ |
+IFF_OACTIVE
+;
+
+525 
+	`log
+(
+LOG_ERR
+, "%s:jammed\n", 
+i
+->
+if_xme
+);
+
+526 
+	`m_m
+(
+m
+);
+
+528 
+	}
+}
+
+531 
+	$eco_iol
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+533 
+iddr
+ *
+i
+ = (idd*)
+da
+;
+
+534 
+r
+;
+
+536 
+cmd
+) {
+
+537 
+SIOCINITIFADDR
+:
+
+538 
+i
+->
+if_ags
+ |
+IFF_UP
+;
+
+539 i((
+i
+->
+if_ags
+ & 
+IFF_RUNNING
+) == 0 &&
+
+540 (
+r
+ = (*
+i
+->
+if_
+)(ifp)) != 0)
+
+541  
+r
+;
+
+542 
+i
+->
+i_addr
+->
+_my
+) {
+
+543 #ifde
+INET
+
+
+544 
+AF_INET
+:
+
+545 
+	`p_if
+(
+i
+, 
+i
+);
+
+552 
+SIOCSIFMTU
+:
+
+553 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)!
+ENETRESET
+)
+
+554  
+r
+;
+
+555 i(
+i
+->
+if_ags
+ & 
+IFF_UP
+)
+
+556  (*
+i
+->
+if_
+)(ifp);
+
+560 
+SIOCSIFFLAGS
+:
+
+561 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)) != 0)
+
+562  
+r
+;
+
+563 
+i
+->
+if_ags
+ & (
+IFF_UP
+|
+IFF_RUNNING
+)) {
+
+564 
+IFF_RUNNING
+:
+
+569 (*
+i
+->
+if_
+)(ifp, 1);
+
+571 
+IFF_UP
+:
+
+576  (*
+i
+->
+if_
+)(ifp);
+
+577 
+IFF_UP
+|
+IFF_RUNNING
+:
+
+582  (*
+i
+->
+if_
+)(ifp);
+
+588  
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+);
+
+592 
+	}
+}
+
+601 
+mbuf
+ *
+
+602 
+	$eco_putame
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+)
+
+604 
+ecocom
+ *
+ec
+ = (*)
+i
+;
+
+605 
+eco_hd
+ *
+eh
+, *
+eh0
+;
+
+606 
+mbuf
+ *
+m0
+;
+
+607 
+mbuf
+ *
+y
+;
+
+608 
+n
+;
+
+610 
+eh
+ = 
+	`mtod
+(
+m
+, 
+eco_hd
+ *);
+
+611 
+ec
+->
+ec_e
+) {
+
+612 
+ECO_IDLE
+:
+
+613 i(
+m
+->
+m_pkthdr
+.
+n
+ < 
+ECO_HDR_LEN
+) {
+
+614 
+	`log
+(
+LOG_NOTICE
+, "%s: undersize scout\n",
+
+615 
+i
+->
+if_xme
+);
+
+616 
+dr
+;
+
+618 i(
+	`memcmp
+(
+eh
+->
+eco_dho
+, 
+eco_brdaddr
+,
+
+619 
+ECO_ADDR_LEN
+) == 0) {
+
+621 
+	`eco_put
+(
+i
+, 
+m
+);
+
+622 } i(
+	`memcmp
+(
+eh
+->
+eco_dho
+, 
+	`CLLADDR
+(
+i
+->
+if_dl
+),
+
+623 
+ECO_ADDR_LEN
+) == 0) {
+
+625 i(
+eh
+->
+eco_pt
+ =
+ECO_PORT_IMMEDIATE
+)
+
+626  
+	`eco_immed
+(
+i
+, 
+m
+);
+
+628 i(
+	`eco_gp
+(
+i
+, 
+m
+)) {
+
+629 
+y
+ = 
+	`eco_ack
+(
+i
+, 
+m
+);
+
+630 i(
+y
+ =
+NULL
+) {
+
+631 
+	`m_m
+(
+m
+);
+
+632  
+NULL
+;
+
+634 
+ec
+->
+ec_e
+ = 
+ECO_SCOUT_RCVD
+;
+
+635 
+ec
+->
+ec_scout
+ = 
+m
+;
+
+636  
+y
+;
+
+638 
+	`m_m
+(
+m
+);
+
+639  
+NULL
+;
+
+644 
+	`m_m
+(
+m
+);
+
+646 
+ECO_SCOUT_RCVD
+:
+
+647 
+	`KASSERT
+(
+ec
+->
+ec_scout
+ !
+NULL
+);
+
+648 
+m0
+ = 
+ec
+->
+ec_scout
+;
+
+649 
+eh0
+ = 
+	`mtod
+(
+m0
+, 
+eco_hd
+ *);
+
+650 i(
+m
+->
+m_pkthdr
+.
+n
+ < 
+ECO_SHDR_LEN
+ ||
+
+651 
+	`memcmp
+(
+eh
+->
+eco_sho
+, 
+eh0
+->eco_sho, 
+ECO_ADDR_LEN
+) != 0 ||
+
+652 
+	`memcmp
+(
+eh
+->
+eco_dho
+, 
+eh0
+->eco_dho, 
+ECO_ADDR_LEN
+) != 0) {
+
+653 
+	`log
+(
+LOG_NOTICE
+, "%s: garbled dataacket header\n",
+
+654 
+i
+->
+if_xme
+);
+
+655 
+dr
+;
+
+657 
+y
+ = 
+	`eco_ack
+(
+i
+, 
+m
+);
+
+663 
+ec
+->
+ec_scout
+ = 
+NULL
+;
+
+664 
+	`m_adj
+(
+m
+, 
+ECO_SHDR_LEN
+);
+
+665 
+n
+ = 
+m0
+->
+m_pkthdr
+.+ 
+m
+->m_pkthdr.len;
+
+666 
+	`m_t
+(
+m0
+, 
+m
+);
+
+667 
+m0
+->
+m_pkthdr
+.
+n
+ =en;
+
+668 
+ec
+->
+ec_e
+ = 
+ECO_DONE
+;
+
+669 
+	`eco_put
+(
+i
+, 
+m0
+);
+
+670  
+y
+;
+
+671 
+ECO_SCOUT_SENT
+:
+
+672 
+	`KASSERT
+(
+ec
+->
+ec_ck
+ !
+NULL
+);
+
+673 
+m0
+ = 
+ec
+->
+ec_ck
+;
+
+674 
+eh0
+ = 
+	`mtod
+(
+m0
+, 
+eco_hd
+ *);
+
+675 i(
+m
+->
+m_pkthdr
+.
+n
+ !
+ECO_SHDR_LEN
+ ||
+
+676 
+	`memcmp
+(
+eh
+->
+eco_sho
+, 
+eh0
+->
+eco_dho
+, 
+ECO_ADDR_LEN
+) != 0 ||
+
+677 
+	`memcmp
+(
+eh
+->
+eco_dho
+, 
+eh0
+->
+eco_sho
+, 
+ECO_ADDR_LEN
+) != 0) {
+
+678 
+	`log
+(
+LOG_NOTICE
+, "%s: garbled scoutck\n",
+
+679 
+i
+->
+if_xme
+);
+
+680 
+dr
+;
+
+682 
+	`m_m
+(
+m
+);
+
+684 
+m0
+ = 
+	`m_cym
+(
+ec
+->
+ec_ck
+, 0, 
+ECO_SHDR_LEN
+, 
+M_DONTWAIT
+);
+
+685 i(
+m0
+ =
+NULL
+) {
+
+686 
+	`m_m
+(
+ec
+->
+ec_ck
+);
+
+687  
+NULL
+;
+
+689 
+m
+ = 
+ec
+->
+ec_ck
+;
+
+690 
+ec
+->
+ec_ck
+ = 
+	`m_cyck
+(
+m
+, 
+M_DONTWAIT
+);
+
+691 i(
+ec
+->
+ec_ck
+ =
+NULL
+) {
+
+692 
+	`m_m
+(
+m0
+);
+
+693 
+	`m_m
+(
+m
+);
+
+694  
+NULL
+;
+
+696 
+	`m_adj
+(
+m
+, 
+ECO_HDR_LEN
+);
+
+697 
+n
+ = 
+m0
+->
+m_pkthdr
+.+ 
+m
+->m_pkthdr.len;
+
+698 
+	`m_t
+(
+m0
+, 
+m
+);
+
+699 
+m0
+->
+m_pkthdr
+.
+n
+ =en;
+
+700 
+ec
+->
+ec_e
+ = 
+ECO_DATA_SENT
+;
+
+701  
+m0
+;
+
+702 
+ECO_DATA_SENT
+:
+
+703 
+	`KASSERT
+(
+ec
+->
+ec_ck
+ !
+NULL
+);
+
+704 
+m0
+ = 
+ec
+->
+ec_ck
+;
+
+705 
+eh0
+ = 
+	`mtod
+(
+m0
+, 
+eco_hd
+ *);
+
+706 i(
+m
+->
+m_pkthdr
+.
+n
+ !
+ECO_SHDR_LEN
+ ||
+
+707 
+	`memcmp
+(
+eh
+->
+eco_sho
+, 
+eh0
+->
+eco_dho
+, 
+ECO_ADDR_LEN
+) != 0 ||
+
+708 
+	`memcmp
+(
+eh
+->
+eco_dho
+, 
+eh0
+->
+eco_sho
+, 
+ECO_ADDR_LEN
+) != 0) {
+
+709 
+	`log
+(
+LOG_NOTICE
+, "%s: garbled datack\n",
+
+710 
+i
+->
+if_xme
+);
+
+711 
+dr
+;
+
+713 
+	`m_m
+(
+m
+);
+
+714 
+	`m_m
+(
+ec
+->
+ec_ck
+);
+
+715 
+ec
+->
+ec_ck
+ = 
+NULL
+;
+
+716 
+ec
+->
+ec_e
+ = 
+ECO_DONE
+;
+
+717  
+NULL
+;
+
+719 
+dr
+:
+
+720 
+	`m_m
+(
+m
+);
+
+723  
+NULL
+;
+
+724 
+	}
+}
+
+731 
+mbuf
+ *
+
+732 
+	$eco_immed
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+)
+
+734 
+eco_hd
+ *
+eh
+, *
+h
+;
+
+735 
+mbuf
+ *
+n
+;
+
+736 c 
+ut8_t
+ 
+machk_da
+[] = { 42, 0, 0, 1 };
+
+738 
+eh
+ = 
+	`mtod
+(
+m
+, 
+eco_hd
+ *);
+
+739 
+eh
+->
+eco_c
+) {
+
+740 
+ECO_CTL_MACHINEPEEK
+:
+
+741 
+	`MGETHDR
+(
+n
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+742 i(
+n
+ =
+NULL
+)
+
+743 
+bad
+;
+
+744 
+n
+->
+m_n
+ =->
+m_pkthdr
+.
+n
+ = 
+ECO_SHDR_LEN
+ + 4;
+
+745 
+h
+ = 
+	`mtod
+(
+n
+, 
+eco_hd
+ *);
+
+746 
+	`memy
+(
+h
+->
+eco_dho
+, 
+eh
+->
+eco_sho
+,
+
+747 
+ECO_ADDR_LEN
+);
+
+748 
+	`memy
+(
+h
+->
+eco_sho
+, 
+	`CLLADDR
+(
+i
+->
+if_dl
+),
+
+749 
+ECO_ADDR_LEN
+);
+
+750 
+	`memy
+(
+	`mtod
+(
+n
+, *+ 
+ECO_SHDR_LEN
+, 
+machk_da
+,
+
+751 (
+machk_da
+));
+
+752 
+	`m_m
+(
+m
+);
+
+753  
+n
+;
+
+755 
+bad
+:
+
+756 
+	`m_m
+(
+m
+);
+
+757  
+NULL
+;
+
+759 
+	}
+}
+
+765 
+mbuf
+ *
+
+766 
+	$eco_ack
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+)
+
+768 
+eco_hd
+ *
+eh
+, *
+h
+;
+
+769 
+mbuf
+ *
+n
+;
+
+771 
+eh
+ = 
+	`mtod
+(
+m
+, 
+eco_hd
+ *);
+
+772 
+	`MGETHDR
+(
+n
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+773 i(
+n
+ =
+NULL
+)
+
+774  
+NULL
+;
+
+775 
+n
+->
+m_n
+ =->
+m_pkthdr
+.
+n
+ = 
+ECO_SHDR_LEN
+;
+
+776 
+h
+ = 
+	`mtod
+(
+n
+, 
+eco_hd
+ *);
+
+777 
+	`memy
+(
+h
+->
+eco_dho
+, 
+eh
+->
+eco_sho
+, 
+ECO_ADDR_LEN
+);
+
+778 
+	`memy
+(
+h
+->
+eco_sho
+, 
+	`CLLADDR
+(
+i
+->
+if_dl
+), 
+ECO_ADDR_LEN
+);
+
+779  
+n
+;
+
+780 
+	}
+}
+
+783 
+	$eco_putid
+(
+i
+ *
+i
+)
+
+785 
+ecocom
+ *
+ec
+ = (*)
+i
+;
+
+786 
+mbuf
+ *
+m
+;
+
+787 
+m_g
+ *
+mg
+;
+
+788 
+eco_yrms
+ *
+p
+;
+
+790 
+ec
+->
+ec_e
+) {
+
+791 
+ECO_SCOUT_SENT
+:
+
+792 
+ECO_DATA_SENT
+:
+
+793 
+ECO_IMMED_SENT
+:
+
+795 
+m
+ = 
+ec
+->
+ec_ck
+;
+
+796 
+ec
+->
+ec_ck
+ = 
+NULL
+;
+
+797 
+mg
+ = 
+	`m_g_fd
+(
+m
+, 
+PACKET_TAG_ECO_RETRYPARMS
+, 
+NULL
+);
+
+798 i(
+mg
+ =
+NULL
+)
+
+799 
+	`m_m
+(
+m
+);
+
+801 
+p
+ = (
+eco_yrms
+ *)(
+mg
+ + 1);
+
+802 i(--
+p
+->
+p_cou
+ > 0)
+
+803 
+	`eco_der
+(
+i
+, 
+m
+, 
+p
+->
+p_day
+);
+
+805 
+	`tf
+("%s:ked\n", 
+i
+->
+if_xme
+);
+
+808 
+ECO_SCOUT_RCVD
+:
+
+809 
+	`m_m
+(
+ec
+->
+ec_scout
+);
+
+810 
+ec
+->
+ec_scout
+ = 
+NULL
+;
+
+815 
+ec
+->
+ec_e
+ = 
+ECO_IDLE
+;
+
+816 
+i
+->
+	`if_t
+(ifp);
+
+817 
+	}
+}
+
+823 
+	$eco_rtf
+(c 
+ut8_t
+ *
+
+)
+
+825 
+buf
+[8];
+
+827 i(
+
+[1] == 0)
+
+828 
+	`tf
+(
+buf
+, (buf), "%d", 
+
+[0]);
+
+830 
+	`tf
+(
+buf
+, (buf), "%d.%d", 
+
+[1],a[0]);
+
+831  
+buf
+;
+
+832 
+	}
+}
+
+838 
+	$eco_der
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+, 
+y_day
+)
+
+840 
+ecocom
+ *
+ec
+ = (ecocom *)
+i
+;
+
+841 
+eco_y
+ *
+
+;
+
+842 
+s
+;
+
+844 
+
+ = 
+	`mloc
+((*), 
+M_TEMP
+, 
+M_NOWAIT
+);
+
+845 i(
+
+ =
+NULL
+) {
+
+846 
+	`m_m
+(
+m
+);
+
+849 
+	`out_
+(&
+
+->
+_out
+, 0);
+
+850 
+
+->
+_ck
+ = 
+m
+;
+
+851 
+
+->
+_i
+ = 
+i
+;
+
+852 
+s
+ = 
+	`
+();
+
+853 
+	`LIST_INSERT_HEAD
+(&
+ec
+->
+ec_s
+, 
+
+, 
+_lk
+);
+
+854 
+	`lx
+(
+s
+);
+
+855 
+	`out_t
+(&
+
+->
+_out
+, 
+y_day
+, 
+eco_y
+,r);
+
+856 
+	}
+}
+
+859 
+	$eco_y_
+(
+eco_y
+ *
+
+)
+
+861 
+s
+;
+
+863 
+	`out_ht
+(&
+
+->
+_out
+, 
+NULL
+);
+
+864 
+	`m_m
+(
+
+->
+_ck
+);
+
+865 
+s
+ = 
+	`
+();
+
+866 
+	`LIST_REMOVE
+(
+
+, 
+_lk
+);
+
+867 
+	`lx
+(
+s
+);
+
+868 
+	`out_deroy
+(&
+
+->
+_out
+);
+
+869 
+	`
+(
+
+, 
+M_TEMP
+);
+
+870 
+	}
+}
+
+873 
+	$eco_y
+(*
+g
+)
+
+875 
+eco_y
+ *
+
+ = 
+g
+;
+
+876 
+mbuf
+ *
+m
+;
+
+877 
+i
+ *
+i
+;
+
+879 
+i
+ = 
+
+->
+_i
+;
+
+880 
+m
+ = 
+
+->
+_ck
+;
+
+881 
+	`LIST_REMOVE
+(
+
+, 
+_lk
+);
+
+882 ()
+	`ifq_queue
+(
+i
+, 
+m
+ 
+ALTQ_COMMA
+ 
+	`ALTQ_DECL
+(
+NULL
+));
+
+883 
+	`
+(
+
+, 
+M_TEMP
+);
+
+884 
+	}
+}
+
+	@if_ether.h
+
+34 #ide
+_NET_IF_ETHER_H_
+
+
+35 
+	#_NET_IF_ETHER_H_
+
+
+	)
+
+37 #ifde
+_KERNEL
+
+
+38 #ifde
+_KERNEL_OPT
+
+
+39 
+	~"t_mbu.h
+"
+
+41 
+	~<sys/mbuf.h
+>
+
+44 #ide
+_STANDALONE
+
+
+45 
+	~<t/if.h
+>
+
+51 
+	#ETHER_ADDR_LEN
+ 6
+
+	)
+
+52 
+	#ETHER_TYPE_LEN
+ 2
+
+	)
+
+53 
+	#ETHER_CRC_LEN
+ 4
+
+	)
+
+54 
+	#ETHER_HDR_LEN
+ ((
+ETHER_ADDR_LEN
+ * 2+ 
+ETHER_TYPE_LEN
+)
+
+	)
+
+55 
+	#ETHER_MIN_LEN
+ 64
+
+	)
+
+56 
+	#ETHER_MAX_LEN
+ 1518
+
+	)
+
+57 
+	#ETHER_MAX_LEN_JUMBO
+ 9018
+
+	)
+
+62 
+	#ETHER_VLAN_ENCAP_LEN
+ 4
+
+	)
+
+63 
+	#ETHER_PPPOE_ENCAP_LEN
+ 8
+
+	)
+
+69 
+	sh_addr
+ {
+
+70 
+ut8_t
+ 
+	mh_addr_o
+[
+ETHER_ADDR_LEN
+];
+
+71 } 
+	g__cked
+;
+
+76 
+	sh_hd
+ {
+
+77 
+ut8_t
+ 
+	mh_dho
+[
+ETHER_ADDR_LEN
+];
+
+78 
+ut8_t
+ 
+	mh_sho
+[
+ETHER_ADDR_LEN
+];
+
+79 
+ut16_t
+ 
+	mh_ty
+;
+
+80 } 
+	g__cked
+;
+
+82 
+	~<t/htys.h
+>
+
+84 
+	#ETHER_IS_MULTICAST
+(
+addr
+(*ddr& 0x01
+
+	)
+
+85 
+	#ETHER_IS_LOCAL
+(
+addr
+(*ddr& 0x02
+
+	)
+
+87 
+	#ETHERMTU_JUMBO
+ (
+ETHER_MAX_LEN_JUMBO
+ - 
+ETHER_HDR_LEN
+ - 
+ETHER_CRC_LEN
+)
+
+	)
+
+88 
+	#ETHERMTU
+ (
+ETHER_MAX_LEN
+ - 
+ETHER_HDR_LEN
+ - 
+ETHER_CRC_LEN
+)
+
+	)
+
+89 
+	#ETHERMIN
+ (
+ETHER_MIN_LEN
+ - 
+ETHER_HDR_LEN
+ - 
+ETHER_CRC_LEN
+)
+
+	)
+
+95 
+	#ETHER_MAX_FRAME
+(
+i
+, 
+y
+, 
+hasfcs
+) \
+
+96 ((
+i
+)->
+if_mtu
+ + 
+ETHER_HDR_LEN
+ + \
+
+97 ((
+hasfcs
+? 
+ETHER_CRC_LEN
+ : 0) + \
+
+98 (((
+y
+=
+ETHERTYPE_VLAN
+? 
+ETHER_VLAN_ENCAP_LEN
+ : 0) + \
+
+99 (((
+y
+=
+ETHERTYPE_PPPOE
+? 
+ETHER_PPPOE_ENCAP_LEN
+ : 0))
+
+	)
+
+104 
+	#ETHER_CRC_POLY_LE
+ 0xedb88320
+
+	)
+
+105 
+	#ETHER_CRC_POLY_BE
+ 0x04c11db6
+
+	)
+
+107 #ide
+_STANDALONE
+
+
+112 
+	#M_HASFCS
+ 
+M_LINK0
+
+
+	)
+
+113 
+	#M_PROMISC
+ 
+M_LINK1
+
+
+	)
+
+115 #ifde
+_KERNEL
+
+
+121 
+	#ETHER_MAP_IP_MULTICAST
+(
+addr
+, 
+addr
+) \
+
+125 (
+addr
+)[0] = 0x01; \
+
+126 (
+addr
+)[1] = 0x00; \
+
+127 (
+addr
+)[2] = 0x5e; \
+
+128 (
+addr
+)[3] = ((c 
+ut8_t
+ *)
+addr
+)[1] & 0x7f; \
+
+129 (
+addr
+)[4] = ((c 
+ut8_t
+ *)
+addr
+)[2]; \
+
+130 (
+addr
+)[5] = ((c 
+ut8_t
+ *)
+addr
+)[3]; \
+
+131 }  0)
+
+	)
+
+137 
+	#ETHER_MAP_IPV6_MULTICAST
+(
+6addr
+, 
+addr
+) \
+
+141 (
+addr
+)[0] = 0x33; \
+
+142 (
+addr
+)[1] = 0x33; \
+
+143 (
+addr
+)[2] = ((c 
+ut8_t
+ *)
+6addr
+)[12]; \
+
+144 (
+addr
+)[3] = ((c 
+ut8_t
+ *)
+6addr
+)[13]; \
+
+145 (
+addr
+)[4] = ((c 
+ut8_t
+ *)
+6addr
+)[14]; \
+
+146 (
+addr
+)[5] = ((c 
+ut8_t
+ *)
+6addr
+)[15]; \
+
+147 }
+
+	)
+
+150 
+	gmii_da
+;
+
+152 
+	ghcom
+;
+
+154 (*
+	th_cb_t
+)(
+	thcom
+ *);
+
+161 
+	shcom
+ {
+
+162 
+i
+ 
+ec_if
+;
+
+163 
+	`LIST_HEAD
+(, 
+h_mui
+
+ec_muddrs
+;
+
+165 
+ec_muit
+;
+
+167 
+ec_bs
+;
+
+169 
+ec_b
+;
+
+172 
+ec_nvns
+;
+
+174 
+mii_da
+ *
+ec_mii
+;
+
+179 
+h_cb_t
+ 
+ec_ifags_cb
+;
+
+180 #ifde
+MBUFTRACE
+
+
+181 
+mowr
+ 
+ec_rx_mowr
+;
+
+182 
+mowr
+ 
+ec_tx_mowr
+;
+
+186 
+	#ETHERCAP_VLAN_MTU
+ 0x00000001
+
+	)
+
+187 
+	#ETHERCAP_VLAN_HWTAGGING
+ 0x00000002
+
+	)
+
+188 
+	#ETHERCAP_JUMBO_MTU
+ 0x00000004
+
+	)
+
+189 
+	#ETHERCAP_MASK
+ 0x00000007
+
+	)
+
+191 
+	#ECCAPBITS
+ \
+
+195 "\3JUMBO_MTU"
+
+	)
+
+198 
+	seceq
+ {
+
+199 
+ec_me
+[
+IFNAMSIZ
+];
+
+200 
+ec_bs
+;
+
+201 
+ec_b
+;
+
+204 #ifdef 
+_KERNEL
+
+
+205 c 
+ut8_t
+ 
+hbrdaddr
+[
+ETHER_ADDR_LEN
+];
+
+206 c 
+ut8_t
+ 
+hmuiaddr_owocs
+[
+ETHER_ADDR_LEN
+];
+
+207 c 
+ut8_t
+ 
+h_mui_m
+[
+ETHER_ADDR_LEN
+];
+
+208 c 
+ut8_t
+ 
+h_mui_max
+[
+ETHER_ADDR_LEN
+];
+
+210 
+	`h_t_ifags_cb
+(
+hcom
+ *, 
+h_cb_t
+);
+
+211 
+	`h_iol
+(
+i
+ *, 
+u_lg
+, *);
+
+212 
+	`h_addmui
+(c 
+sockaddr
+ *, 
+hcom
+ *);
+
+213 
+	`h_dmui
+(c 
+sockaddr
+ *, 
+hcom
+ *);
+
+214 
+	`h_muddr
+(c 
+sockaddr
+ *, 
+ut8_t
+[], uint8_t[]);
+
+215 
+	`h_put
+(
+i
+ *, 
+mbuf
+ *);
+
+224 
+	sh_mui
+ {
+
+225 
+ut8_t
+ 
+m_addo
+[
+ETHER_ADDR_LEN
+];
+
+226 
+ut8_t
+ 
+m_addrhi
+[
+ETHER_ADDR_LEN
+];
+
+227 
+u_t
+ 
+m_fcou
+;
+
+228 
+	`LIST_ENTRY
+(
+h_mui
+
+m_li
+;
+
+231 
+	sh_mui_sysl
+ {
+
+232 
+u_t
+ 
+m_fcou
+;
+
+233 
+ut8_t
+ 
+m_addo
+[
+ETHER_ADDR_LEN
+];
+
+234 
+ut8_t
+ 
+m_addrhi
+[
+ETHER_ADDR_LEN
+];
+
+241 
+	sh_mui
+ {
+
+242 
+h_mui
+ *
+e_m
+;
+
+250 
+	#ETHER_LOOKUP_MULTI
+(
+addo
+, 
+addrhi
+, 
+ec
+, 
+m
+) \
+
+256 (
+m
+
+	`LIST_FIRST
+(&(
+ec
+)->
+ec_muddrs
+); \
+
+257 (
+m
+!
+NULL
+ && \
+
+258 (
+	`memcmp
+((
+m
+)->
+m_addo
+, (
+addo
+), 
+ETHER_ADDR_LEN
+) != 0 || \
+
+259 
+	`memcmp
+((
+m
+)->
+m_addrhi
+, (
+addrhi
+), 
+ETHER_ADDR_LEN
+) != 0); \
+
+260 (
+m
+
+	`LIST_NEXT
+(nm), 
+m_li
+)); \
+
+261 
+	}
+
+	)
+}
+
+270 
+	#ETHER_NEXT_MULTI
+(
+
+, 
+m
+) \
+
+274 i(((
+m
+(
+
+).
+e_m
+!
+NULL
+) \
+
+275 (
+
+).
+e_m
+ = 
+	`LIST_NEXT
+((
+m
+), 
+m_li
+); \
+
+276 }
+
+	)
+
+278 
+	#ETHER_FIRST_MULTI
+(
+
+, 
+ec
+, 
+m
+) \
+
+283 (
+
+).
+e_m
+ = 
+	`LIST_FIRST
+(&(
+ec
+)->
+ec_muddrs
+); \
+
+284 
+	`ETHER_NEXT_MULTI
+((
+
+), (
+m
+)); \
+
+285 }
+
+	)
+
+287 #ifde
+_KERNEL
+
+
+294 
+le
+ 
+vn_put_g
+(
+i
+ *, 
+mbuf
+ *, 
+u_t
+);
+
+295 
+le
+ 
+
+296 
+	$vn_put_g
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+, 
+u_t
+ 
+vnid
+)
+
+298 
+m_g
+ *
+mg
+;
+
+299 
+mg
+ = 
+	`m_g_g
+(
+PACKET_TAG_VLAN
+, (
+u_t
+), 
+M_NOWAIT
+);
+
+300 i(
+mg
+ =
+NULL
+) {
+
+301 
+i
+->
+if_s
+++;
+
+302 
+	`tf
+("%s: ublo VLANag\n", 
+i
+->
+if_xme
+);
+
+303 
+	`m_m
+(
+m
+);
+
+306 *(
+u_t
+ *)(
+mg
+ + 1
+vnid
+;
+
+307 
+	`m_g_d
+(
+m
+, 
+mg
+);
+
+309 
+	}
+}
+
+311 
+	#VLAN_INPUT_TAG
+(
+i
+, 
+m
+, 
+vnid
+, 
+_r
+) \
+
+312 i(
+	`vn_put_g
+(
+i
+, 
+m
+, 
+vnid
+) != 0) { \
+
+313 
+_r
+; \
+
+314 }
+
+	)
+
+317 
+	#VLAN_OUTPUT_TAG
+(
+ec
+, 
+m0
+) \
+
+318 (
+	`VLAN_ATTACHED
+(
+ec
+? 
+	`m_g_fd
+((
+m0
+), 
+PACKET_TAG_VLAN
+, 
+NULL
+: NULL)
+
+	)
+
+321 
+	#VLAN_TAG_VALUE
+(
+mg
+) \
+
+322 ((*(
+u_t
+ *)(
+mg
+ + 1)& 4095)
+
+	)
+
+325 
+	#VLAN_ATTACHED
+(
+ec
+(c)->
+ec_nvns
+ > 0)
+
+	)
+
+327 
+h
+();
+
+328 
+h_iach
+(
+i
+ *, c 
+ut8_t
+ *);
+
+329 
+h_ifdach
+(
+i
+ *);
+
+330 
+h_medchge
+(
+i
+ *);
+
+331 
+h_medus
+(
+i
+ *, 
+ifmedq
+ *);
+
+333 *
+h_rtf
+(c 
+ut8_t
+ *);
+
+334 *
+h_tf
+(*, 
+size_t
+, c 
+ut8_t
+ *);
+
+336 
+ut32_t
+ 
+h_c32_
+(c 
+ut8_t
+ *, 
+size_t
+);
+
+337 
+ut32_t
+ 
+h_c32_be
+(c 
+ut8_t
+ *, 
+size_t
+);
+
+339 
+h__r
+(
+u_ch
+ *, 
+size_t
+, const *);
+
+344 
+	~<sys/cdefs.h
+>
+
+345 
+__BEGIN_DECLS
+
+
+346 * 
+h_
+(c 
+h_addr
+ *);
+
+347 
+h_addr
+ *
+
+348 
+h_
+(const *);
+
+349 
+h_oho
+(*, c 
+h_addr
+ *);
+
+350 
+h_hot
+(c *, 
+h_addr
+ *);
+
+351 
+h_le
+(c *, 
+h_addr
+ *, *);
+
+352 
+	g__END_DECLS
+
+
+	@if_etherip.c
+
+88 
+	~<sys/cdefs.h
+>
+
+89 
+__KERNEL_RCSID
+(0, "$NetBSD: if_etherip.c,v 1.35 2014/02/25 18:30:12ooka Exp $");
+
+91 
+	~"t_.h
+"
+
+93 
+	~<sys/m.h
+>
+
+94 
+	~<sys/sym.h
+>
+
+95 
+	~<sys/kl.h
+>
+
+96 
+	~<sys/mloc.h
+>
+
+97 
+	~<sys/cf.h
+>
+
+98 
+	~<sys/devi.h
+>
+
+99 
+	~<sys/o.h
+>
+
+100 
+	~<sys/time.h
+>
+
+101 
+	~<sys/sysl.h
+>
+
+102 
+	~<sys/queue.h
+>
+
+103 
+	~<sys/sock.h
+>
+
+104 
+	~<sys/sockv.h
+>
+
+105 
+	~<sys/.h
+>
+
+107 
+	~<t/if.h
+>
+
+108 
+	~<t/if_dl.h
+>
+
+109 
+	~<t/if_h.h
+>
+
+110 
+	~<t/if_med.h
+>
+
+111 
+	~<t/rou.h
+>
+
+112 
+	~<t/if_h.h
+>
+
+113 
+	~<t/bpf.h
+>
+
+115 
+	~<t/.h
+>
+
+116 
+	~<t/_sym.h
+>
+
+117 
+	~<t/.h
+>
+
+118 #ifde 
+INET
+
+
+119 
+	~<t/_v.h
+>
+
+121 
+	~<t/_h.h
+>
+
+123 #ifde
+INET6
+
+
+124 
+	~<t6/6_h.h
+>
+
+125 #ide
+INET
+
+
+126 
+	~<t/.h
+>
+
+128 
+	~<t6/6_v.h
+>
+
+129 
+	~<t/6.h
+>
+
+130 
+	~<t6/6_v.h
+>
+
+131 
+	~<t6/6_gif.h
+>
+
+132 
+	~<t6/6osw.h
+>
+
+135 
+	~<comt/sys/sockio.h
+>
+
+137 
+h_soc_li
+ 
+	gh_soc_li
+;
+
+139 
+	gh_node
+;
+
+140 
+h_sysl_hdr
+(
+SYSCTLFN_PROTO
+);
+
+141 
+SYSCTL_SETUP_PROTO
+(
+sysl_h_tup
+);
+
+143 
+hch
+();
+
+145 
+h_mch
+(
+devi_t
+, 
+cfda_t
+, *);
+
+146 
+h_ch
+(
+devi_t
+, device_t, *);
+
+147 
+h_dach
+(
+devi_t
+, );
+
+149 
+CFATTACH_DECL_NEW
+(
+h
+, (
+h_soc
+),
+
+150 
+h_mch
+, 
+h_ch
+, 
+h_dach
+, 
+NULL
+);
+
+151 
+cfdriv
+ 
+h_cd
+;
+
+153 
+h_t
+(
+i
+ *);
+
+154 
+h_
+(
+i
+ *, );
+
+155 
+h_
+(
+i
+ *);
+
+156 
+h_iol
+(
+i
+ *, 
+u_lg
+, *);
+
+158 
+h_medchge
+(
+i
+ *);
+
+159 
+h_medus
+(
+i
+ *, 
+ifmedq
+ *);
+
+161 
+h_e_
+(
+if_e
+ *, );
+
+162 
+h_e_deroy
+(
+i
+ *);
+
+164 
+if_e
+ 
+	gh_s
+ = 
+IF_CLONE_INITIALIZER
+(
+
+165 "h", 
+h_e_
+, 
+h_e_deroy
+);
+
+167 
+h_t_tu
+(
+i
+ *,
+
+168 
+sockaddr
+ *, sockaddr *);
+
+169 
+h_de_tu
+(
+i
+ *);
+
+170 
+h
+(*);
+
+173 
+	$hch
+(
+cou
+)
+
+175 
+r
+;
+
+177 
+r
+ = 
+	`cfig_cach_ch
+(
+h_cd
+.
+cd_me
+, &
+h_
+);
+
+179 i(
+r
+) {
+
+180 
+	`rt_r
+("%s: unableoegister cfattach\n",
+
+181 
+h_cd
+.
+cd_me
+);
+
+182 ()
+	`cfig_cfdriv_dach
+(&
+h_cd
+);
+
+186 
+	`LIST_INIT
+(&
+h_soc_li
+);
+
+187 
+	`if_e_ch
+(&
+h_s
+);
+
+188 
+	}
+}
+
+192 
+	$h_mch
+(
+devi_t
+ 
+lf
+, 
+cfda_t
+ 
+cfda
+, *
+g
+)
+
+195 
+	}
+}
+
+198 
+	$h_ch
+(
+devi_t
+ 
+
+, devi_
+lf
+, *
+aux
+)
+
+200 
+h_soc
+ *
+sc
+ = 
+	`devi_ive
+(
+lf
+);
+
+201 
+i
+ *
+i
+;
+
+202 c 
+sysode
+ *
+node
+;
+
+203 
+ut8_t
+ 
+addr
+[
+ETHER_ADDR_LEN
+] =
+
+205 
+addrr
+[3 * 
+ETHER_ADDR_LEN
+];
+
+206 
+timev
+ 
+tv
+;
+
+207 
+ut32_t
+ 
+ui
+;
+
+208 
+r
+;
+
+210 
+sc
+->
+sc_dev
+ = 
+lf
+;
+
+211 
+sc
+->
+sc_si
+ = 
+NULL
+;
+
+212 
+sc
+->
+sc_c
+ = 
+NULL
+;
+
+213 
+sc
+->
+sc_d
+ = 
+NULL
+;
+
+215 i(!
+	`pmf_devi_gi
+(
+lf
+, 
+NULL
+, NULL))
+
+216 
+	`rt_r_dev
+(
+lf
+, "couldn'tstablishower handler\n");
+
+223 
+	`gmiouime
+(&
+tv
+);
+
+224 
+ui
+ = (
+tv
+.
+tv_c
+ ^v.
+tv_uc
+) & 0xffffff;
+
+225 
+	`memy
+(
+addr
++3, (
+ut8_t
+ *)&
+ui
+, 3);
+
+227 
+	`rt_vbo_dev
+(
+lf
+, "Ethernetddress %s\n",
+
+228 
+	`h_tf
+(
+addrr
+, ddrr), 
+addr
+));
+
+237 
+	`ifmed_
+(&
+sc
+->
+sc_im
+, 0, 
+h_medchge
+, 
+h_medus
+);
+
+238 
+	`ifmed_add
+(&
+sc
+->
+sc_im
+, 
+IFM_ETHER
+|
+IFM_1000_T
+, 0, 
+NULL
+);
+
+239 
+	`ifmed_add
+(&
+sc
+->
+sc_im
+, 
+IFM_ETHER
+|
+IFM_1000_T
+|
+IFM_FDX
+, 0, 
+NULL
+);
+
+240 
+	`ifmed_add
+(&
+sc
+->
+sc_im
+, 
+IFM_ETHER
+|
+IFM_100_TX
+, 0, 
+NULL
+);
+
+241 
+	`ifmed_add
+(&
+sc
+->
+sc_im
+, 
+IFM_ETHER
+|
+IFM_100_TX
+|
+IFM_FDX
+, 0, 
+NULL
+);
+
+242 
+	`ifmed_add
+(&
+sc
+->
+sc_im
+, 
+IFM_ETHER
+|
+IFM_10_T
+, 0, 
+NULL
+);
+
+243 
+	`ifmed_add
+(&
+sc
+->
+sc_im
+, 
+IFM_ETHER
+|
+IFM_10_T
+|
+IFM_FDX
+, 0, 
+NULL
+);
+
+244 
+	`ifmed_add
+(&
+sc
+->
+sc_im
+, 
+IFM_ETHER
+|
+IFM_AUTO
+, 0, 
+NULL
+);
+
+245 
+	`ifmed_t
+(&
+sc
+->
+sc_im
+, 
+IFM_ETHER
+|
+IFM_AUTO
+);
+
+251 
+i
+ = &
+sc
+->
+sc_ec
+.
+ec_if
+;
+
+252 
+	`y
+(
+i
+->
+if_xme
+, 
+	`devi_xme
+(
+lf
+), 
+IFNAMSIZ
+);
+
+253 
+i
+->
+if_soc
+ = 
+sc
+;
+
+254 
+i
+->
+if_ags
+ = 
+IFF_BROADCAST
+ | 
+IFF_SIMPLEX
+ | 
+IFF_MULTICAST
+;
+
+255 
+i
+->
+if_iol
+ = 
+h_iol
+;
+
+256 
+i
+->
+if_t
+ = 
+h_t
+;
+
+257 
+i
+->
+if_
+ = 
+h_
+;
+
+258 
+i
+->
+if_
+ = 
+h_
+;
+
+259 
+	`IFQ_SET_READY
+(&
+i
+->
+if_d
+);
+
+261 
+sc
+->
+sc_ec
+.
+ec_bs
+ = 
+ETHERCAP_VLAN_MTU
+ | 
+ETHERCAP_JUMBO_MTU
+;
+
+267 
+	`if_ch
+(
+i
+);
+
+268 
+	`h_iach
+(
+i
+, 
+addr
+);
+
+278 
+r
+ = 
+	`sysl_v
+(
+NULL
+, 0, NULL, &
+node
+, 
+CTLFLAG_READWRITE
+,
+
+279 
+CTLTYPE_STRING
+, 
+	`devi_xme
+(
+lf
+), 
+NULL
+,
+
+280 
+h_sysl_hdr
+, 0, (*)
+sc
+, 18, 
+CTL_NET
+,
+
+281 
+AF_LINK
+, 
+h_node
+, 
+	`devi_un
+(
+lf
+),
+
+282 
+CTL_EOL
+);
+
+283 i(
+r
+)
+
+284 
+	`rt_r_dev
+(
+lf
+, "sysctl_createveturned %d, ignoring\n",
+
+285 
+r
+);
+
+288 
+	`LIST_INSERT_HEAD
+(&
+h_soc_li
+, 
+sc
+, 
+h_li
+);
+
+289 
+	}
+}
+
+296 
+	$h_dach
+(
+devi_t
+ 
+lf
+, 
+ags
+)
+
+298 
+h_soc
+ *
+sc
+ = 
+	`devi_ive
+(
+lf
+);
+
+299 
+i
+ *
+i
+ = &
+sc
+->
+sc_ec
+.
+ec_if
+;
+
+300 
+r
+, 
+s
+;
+
+302 
+s
+ = 
+	`
+();
+
+303 
+	`h_
+(
+i
+, 1);
+
+304 
+	`if_down
+(
+i
+);
+
+305 
+	`lx
+(
+s
+);
+
+312 
+r
+ = 
+	`sysl_deroyv
+(
+NULL
+, 
+CTL_NET
+, 
+AF_LINK
+, 
+h_node
+,
+
+313 
+	`devi_un
+(
+lf
+), 
+CTL_EOL
+);
+
+314 i(
+r
+)
+
+315 
+	`rt_r_dev
+(
+lf
+, "sysctl_destroyveturned %d, ignoring\n",
+
+316 
+r
+);
+
+318 
+	`LIST_REMOVE
+(
+sc
+, 
+h_li
+);
+
+319 
+	`h_de_tu
+(
+i
+);
+
+320 
+	`h_ifdach
+(
+i
+);
+
+321 
+	`if_dach
+(
+i
+);
+
+322 
+	`che_
+(&
+sc
+->
+sc_ro
+);
+
+323 
+	`ifmed_de_
+(&
+sc
+->
+sc_im
+, 
+IFM_INST_ANY
+);
+
+325 
+	`pmf_devi_degi
+(
+lf
+);
+
+328 
+	}
+}
+
+336 
+	$h_medchge
+(
+i
+ *
+i
+)
+
+339 
+	}
+}
+
+345 
+	$h_medus
+(
+i
+ *
+i
+, 
+ifmedq
+ *
+imr
+)
+
+347 
+h_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+349 
+imr
+->
+ifm_aive
+ = 
+sc
+->
+sc_im
+.
+ifm_cur
+->
+ifm_med
+;
+
+350 
+	}
+}
+
+353 
+	$h_t
+(
+i
+ *
+i
+)
+
+355 
+h_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+357 if(
+sc
+->
+sc_si
+)
+
+358 
+	`sot_schedu
+(
+sc
+->
+sc_si
+);
+
+359 
+	}
+}
+
+362 
+	$h
+(*
+g
+)
+
+364 
+h_soc
+ *
+sc
+ = (h_so*)
+g
+;
+
+365 
+i
+ *
+i
+ = &
+sc
+->
+sc_ec
+.
+ec_if
+;
+
+366 
+mbuf
+ *
+m
+;
+
+367 
+s
+, 
+r
+;
+
+369 
+	`mux_r
+(
+sot_lock
+);
+
+371 
+s
+ = 
+	`
+();
+
+372 
+	`IFQ_DEQUEUE
+(&
+i
+->
+if_d
+, 
+m
+);
+
+373 
+	`lx
+(
+s
+);
+
+374 i(
+m
+ =
+NULL
+)
+
+377 
+	`bpf_mp
+(
+i
+, 
+m
+);
+
+379 
+i
+->
+if_acks
+++;
+
+380 i(
+sc
+->
+sc_c
+ && sc->
+sc_d
+) {
+
+381 
+i
+->
+if_ags
+ |
+IFF_OACTIVE
+;
+
+382 
+sc
+->
+sc_c
+->
+_my
+) {
+
+383 #ifde
+INET
+
+
+384 
+AF_INET
+:
+
+385 
+r
+ = 
+	`_h_ouut
+(
+i
+, 
+m
+);
+
+388 #ifde
+INET6
+
+
+389 
+AF_INET6
+:
+
+390 
+r
+ = 
+	`6_h_ouut
+(
+i
+, 
+m
+);
+
+394 
+r
+ = 
+ENETDOWN
+;
+
+396 
+i
+->
+if_ags
+ &~
+IFF_OACTIVE
+;
+
+397 } 
+	`m_m
+(
+m
+);
+
+399 
+	`mux_ex
+(
+sot_lock
+);
+
+400 
+	`__USE
+(
+r
+);
+
+401 
+	}
+}
+
+404 
+	$h_iol
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+406 
+h_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+407 
+ieq
+ *
+i
+ = 
+da
+;
+
+408 
+sockaddr
+ *
+c
+, *
+d
+;
+
+409 
+s
+, 
+r
+;
+
+411 
+cmd
+) {
+
+412 
+SIOCSLIFPHYADDR
+:
+
+413 
+c
+ = (
+sockaddr
+ *)
+
+414 &(((
+if_ddeq
+ *)
+da
+)->
+addr
+);
+
+415 
+d
+ = (
+sockaddr
+ *)
+
+416 &(((
+if_ddeq
+ *)
+da
+)->
+daddr
+);
+
+419 i(
+c
+->
+_my
+ !
+d
+->sa_family)
+
+420  
+EINVAL
+;
+
+423 
+c
+->
+_my
+) {
+
+424 #ifde
+INET
+
+
+425 
+AF_INET
+:
+
+426 i(
+c
+->
+_n
+ !(
+sockaddr_
+) ||
+
+427 
+d
+->
+_n
+ !(
+sockaddr_
+))
+
+428  
+EINVAL
+;
+
+431 #ifde
+INET6
+
+
+432 
+AF_INET6
+:
+
+433 i(
+c
+->
+_n
+ !(
+sockaddr_6
+) ||
+
+434 
+d
+->
+_n
+ !(
+sockaddr_6
+))
+
+435  
+EINVAL
+;
+
+439  
+EAFNOSUPPORT
+;
+
+442 
+r
+ = 
+	`h_t_tu
+(
+i
+, 
+c
+, 
+d
+);
+
+445 
+SIOCDIFPHYADDR
+:
+
+446 
+	`h_de_tu
+(
+i
+);
+
+447 
+r
+ = 0;
+
+450 
+SIOCGLIFPHYADDR
+:
+
+451 i(
+sc
+->
+sc_c
+ =
+NULL
+ || sc->
+sc_d
+ == NULL)
+
+452  
+EADDRNOTAVAIL
+;
+
+455 
+c
+ = 
+sc
+->
+sc_c
+;
+
+456 
+d
+ = (
+sockaddr
+ *)
+
+457 &(((
+if_ddeq
+ *)
+da
+)->
+addr
+);
+
+458 i(
+c
+->
+_n
+ > (((
+if_ddeq
+ *)
+da
+)->
+addr
+))
+
+459  
+EINVAL
+;
+
+460 
+	`memy
+(
+d
+, 
+c
+, src->
+_n
+);
+
+463 
+c
+ = 
+sc
+->
+sc_d
+;
+
+464 
+d
+ = (
+sockaddr
+ *)
+
+465 &(((
+if_ddeq
+ *)
+da
+)->
+daddr
+);
+
+466 i(
+c
+->
+_n
+ > (((
+if_ddeq
+ *)
+da
+)->
+daddr
+))
+
+467  
+EINVAL
+;
+
+468 
+	`memy
+(
+d
+, 
+c
+, src->
+_n
+);
+
+470 
+r
+ = 0;
+
+473 #ifde
+OSIOCSIFMEDIA
+
+
+474 
+OSIOCSIFMEDIA
+:
+
+476 
+SIOCSIFMEDIA
+:
+
+477 
+SIOCGIFMEDIA
+:
+
+478 
+s
+ = 
+	`
+();
+
+479 
+r
+ = 
+	`ifmed_iol
+(
+i
+, 
+i
+, &
+sc
+->
+sc_im
+, 
+cmd
+);
+
+480 
+	`lx
+(
+s
+);
+
+484 
+s
+ = 
+	`
+();
+
+485 
+r
+ = 
+	`h_iol
+(
+i
+, 
+cmd
+, 
+da
+);
+
+486 
+	`lx
+(
+s
+);
+
+487 i(
+r
+ =
+ENETRESET
+)
+
+488 
+r
+ = 0;
+
+492  (
+r
+);
+
+493 
+	}
+}
+
+496 
+	$h_t_tu
+(
+i
+ *
+i
+,
+
+497 
+sockaddr
+ *
+c
+,
+
+498 
+sockaddr
+ *
+d
+)
+
+500 
+h_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+501 
+h_soc
+ *
+sc2
+;
+
+502 
+sockaddr
+ *
+oc
+, *
+od
+;
+
+503 
+s
+, 
+r
+ = 0;
+
+505 
+s
+ = 
+	`lsot
+();
+
+507 
+	`LIST_FOREACH
+(
+sc2
+, &
+h_soc_li
+, 
+h_li
+) {
+
+508 i(
+sc2
+ =
+sc
+)
+
+510 i(!
+sc2
+->
+sc_d
+ || !sc2->
+sc_c
+)
+
+512 i(
+sc2
+->
+sc_d
+->
+_my
+ !
+d
+->sa_family ||
+
+513 
+sc2
+->
+sc_d
+->
+_n
+ !
+d
+->sa_len ||
+
+514 
+sc2
+->
+sc_c
+->
+_my
+ !
+c
+->sa_family ||
+
+515 
+sc2
+->
+sc_c
+->
+_n
+ !
+c
+->sa_len)
+
+518 i(
+	`memcmp
+(
+sc2
+->
+sc_d
+, 
+d
+, d->
+_n
+) == 0 &&
+
+519 
+	`memcmp
+(
+sc2
+->
+sc_c
+, 
+c
+, src->
+_n
+) == 0) {
+
+520 
+r
+ = 
+EADDRNOTAVAIL
+;
+
+521 
+out
+;
+
+526 i(
+sc
+->
+sc_si
+) {
+
+527 
+	`sot_diablish
+(
+sc
+->
+sc_si
+);
+
+528 
+sc
+->
+sc_si
+ = 
+NULL
+;
+
+531 
+i
+->
+if_ags
+ &~
+IFF_RUNNING
+;
+
+533 
+oc
+ = 
+sc
+->
+sc_c
+; sc->sc_
+NULL
+;
+
+534 
+od
+ = 
+sc
+->
+sc_d
+; sc->sc_d = 
+NULL
+;
+
+536 
+sc
+->
+sc_c
+ = 
+	`sockaddr_dup
+(
+c
+, 
+M_WAITOK
+);
+
+537 i(
+oc
+)
+
+538 
+	`sockaddr_
+(
+oc
+);
+
+540 
+sc
+->
+sc_d
+ = 
+	`sockaddr_dup
+(
+d
+, 
+M_WAITOK
+);
+
+541 i(
+od
+)
+
+542 
+	`sockaddr_
+(
+od
+);
+
+544 
+i
+->
+if_ags
+ |
+IFF_RUNNING
+;
+
+546 
+sc
+->
+sc_si
+ = 
+	`sot_eablish
+(
+SOFTINT_NET
+, 
+h
+, sc);
+
+547 i(
+sc
+->
+sc_si
+ =
+NULL
+)
+
+548 
+r
+ = 
+ENOMEM
+;
+
+550 
+out
+:
+
+551 
+	`lx
+(
+s
+);
+
+553 (
+r
+);
+
+554 
+	}
+}
+
+557 
+	$h_de_tu
+(
+i
+ *
+i
+)
+
+559 
+h_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+560 
+s
+;
+
+562 
+s
+ = 
+	`lsot
+();
+
+564 i(
+sc
+->
+sc_si
+) {
+
+565 
+	`sot_diablish
+(
+sc
+->
+sc_si
+);
+
+566 
+sc
+->
+sc_si
+ = 
+NULL
+;
+
+569 i(
+sc
+->
+sc_c
+) {
+
+570 
+	`sockaddr_
+(
+sc
+->
+sc_c
+);
+
+571 
+sc
+->
+sc_c
+ = 
+NULL
+;
+
+573 i(
+sc
+->
+sc_d
+) {
+
+574 
+	`sockaddr_
+(
+sc
+->
+sc_d
+);
+
+575 
+sc
+->
+sc_d
+ = 
+NULL
+;
+
+578 
+i
+->
+if_ags
+ &~
+IFF_RUNNING
+;
+
+579 
+	`lx
+(
+s
+);
+
+580 
+	}
+}
+
+583 
+	$h_
+(
+i
+ *
+i
+)
+
+585 
+h_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+587 i(
+sc
+->
+sc_si
+ =
+NULL
+)
+
+588 
+sc
+->
+sc_si
+ = 
+	`sot_eablish
+(
+SOFTINT_NET
+, 
+h
+, sc);
+
+590 i(
+sc
+->
+sc_si
+ =
+NULL
+)
+
+591 (
+ENOMEM
+);
+
+593 
+i
+->
+if_ags
+ |
+IFF_RUNNING
+;
+
+594 
+	`h_t
+(
+i
+);
+
+597 
+	}
+}
+
+600 
+	$h_
+(
+i
+ *
+i
+, 
+dib
+)
+
+602 
+i
+->
+if_ags
+ &~
+IFF_RUNNING
+;
+
+603 
+	}
+}
+
+606 
+	$h_e_
+(
+if_e
+ *
+ifc
+, 
+un
+)
+
+608 
+cfda_t
+ 
+cf
+;
+
+610 
+cf
+ = 
+	`mloc
+((
+cfda
+), 
+M_DEVBUF
+, 
+M_WAITOK
+);
+
+611 
+cf
+->
+cf_me
+ = 
+h_cd
+.
+cd_me
+;
+
+612 
+cf
+->
+cf_me
+ = 
+h_
+.
+_me
+;
+
+613 
+cf
+->
+cf_un
+ = 
+un
+;
+
+614 
+cf
+->
+cf_fe
+ = 
+FSTATE_STAR
+;
+
+616 i(
+	`cfig_ch_pudo
+(
+cf
+=
+NULL
+) {
+
+617 
+	`rt_r
+("%s%d: unableottachn instance\n",
+
+618 
+h_cd
+.
+cd_me
+, 
+un
+);
+
+619  (
+ENXIO
+);
+
+623 
+	}
+}
+
+626 
+	$h_e_deroy
+(
+i
+ *
+i
+)
+
+628 
+h_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+629 
+cfda_t
+ 
+cf
+ = 
+	`devi_cfda
+(
+sc
+->
+sc_dev
+);
+
+630 
+r
+;
+
+632 i((
+r
+ = 
+	`cfig_dach
+(
+sc
+->
+sc_dev
+, 0)) != 0)
+
+633 
+	`rt_r_dev
+(
+sc
+->
+sc_dev
+, "unableo detach instance\n");
+
+634 
+	`
+(
+cf
+, 
+M_DEVBUF
+);
+
+636  
+r
+;
+
+637 
+	}
+}
+
+639 
+SYSCTL_SETUP
+(
+sysl_h_tup
+, "sysctlet.link.etherip subtree setup")
+
+641 c 
+sysode
+ *
+	gnode
+;
+
+642 
+	gr
+ = 0;
+
+644 
+	gr
+ = 
+sysl_v
+(
+og
+, 0, 
+NULL
+, NULL,
+
+645 
+CTLFLAG_PERMANENT
+,
+
+646 
+CTLTYPE_NODE
+, "lk", 
+NULL
+,
+
+647 
+NULL
+, 0, NULL, 0,
+
+648 
+CTL_NET
+, 
+AF_LINK
+, 
+CTL_EOL
+);
+
+649 i(
+	gr
+)
+
+652 
+	gr
+ = 
+sysl_v
+(
+og
+, 0, 
+NULL
+, &
+node
+,
+
+653 
+CTLFLAG_PERMANENT
+,
+
+654 
+CTLTYPE_NODE
+, "h", 
+NULL
+,
+
+655 
+NULL
+, 0, NULL, 0,
+
+656 
+CTL_NET
+, 
+AF_LINK
+, 
+CTL_CREATE
+, 
+CTL_EOL
+);
+
+657 i(
+	gr
+)
+
+660 
+	gh_node
+ = 
+node
+->
+sysl_num
+;
+
+664 
+	$h_sysl_hdr
+(
+SYSCTLFN_ARGS
+)
+
+666 
+sysode
+ 
+node
+;
+
+667 
+h_soc
+ *
+sc
+;
+
+668 
+i
+ *
+i
+;
+
+669 
+r
+;
+
+670 
+size_t
+ 
+n
+;
+
+671 
+addr
+[3 * 
+ETHER_ADDR_LEN
+];
+
+672 
+addr
+[
+ETHER_ADDR_LEN
+];
+
+674 
+node
+ = *
+ode
+;
+
+675 
+sc
+ = 
+node
+.
+sysl_da
+;
+
+676 
+i
+ = &
+sc
+->
+sc_ec
+.
+ec_if
+;
+
+677 ()
+	`h_tf
+(
+addr
+, ddr), 
+	`CLLADDR
+(
+i
+->
+if_dl
+));
+
+678 
+node
+.
+sysl_da
+ = 
+addr
+;
+
+679 
+r
+ = 
+	`sysl_lookup
+(
+	`SYSCTLFN_CALL
+(&
+node
+));
+
+680 i(
+r
+ || 
+wp
+ =
+NULL
+)
+
+681  
+r
+;
+
+683 
+n
+ = 
+	`
+(
+addr
+);
+
+684 i(
+n
+ < 11 ||en > 17)
+
+685  
+EINVAL
+;
+
+688 i(
+	`h__r
+(
+addr
+, ddr), 
+addr
+) != 0)
+
+689  
+EINVAL
+;
+
+691 
+	`if_t_dl
+(
+i
+, 
+addr
+, 
+ETHER_ADDR_LEN
+, 
+l
+);
+
+692  
+r
+;
+
+693 
+	}
+}
+
+	@if_etherip.h
+
+32 #ide
+_NET_IF_ETHERIP_H_
+
+
+33 
+	#_NET_IF_ETHERIP_H_
+
+
+	)
+
+35 
+	~<sys/queue.h
+>
+
+37 #ifde
+_KERNEL_OPT
+
+
+38 
+	~"t_.h
+"
+
+41 
+	~<t/.h
+>
+
+43 
+	sh_soc
+ {
+
+44 
+ifmed
+ 
+	msc_im
+;
+
+45 
+devi_t
+ 
+	msc_dev
+;
+
+46 
+hcom
+ 
+	msc_ec
+;
+
+47 
+sockaddr
+ *
+	msc_c
+;
+
+48 
+sockaddr
+ *
+	msc_d
+;
+
+49 
+rou
+ 
+	msc_ro
+;
+
+50 *
+	msc_si
+;
+
+51 
+LIST_ENTRY
+(
+h_soc
+
+	mh_li
+;
+
+54 
+LIST_HEAD
+(
+h_soc_li
+, 
+h_soc
+);
+
+55 
+h_soc_li
+therip_softc_list;
+
+57 
+	sh_hd
+ {
+
+58 
+ut8_t
+ 
+	me_v
+;
+
+59 
+ut8_t
+ 
+	me_d
+;
+
+62 
+	#ETHERIP_VER_VERS_MASK
+ 0x0f
+
+	)
+
+63 
+	#ETHERIP_VER_RSVD_MASK
+ 0xf0
+
+	)
+
+64 
+	#ETHERIP_VERSION
+ 0x03
+
+	)
+
+66 
+	#ETHERIP_TTL
+ 30
+
+	)
+
+67 
+	#ETHERIP_ROUTE_TTL
+ 10
+
+	)
+
+	@if_ethersubr.c
+
+63 
+	~<sys/cdefs.h
+>
+
+64 
+__KERNEL_RCSID
+(0, "$NetBSD: if_ethersubr.c,v 1.208 2015/05/20 09:17:18 ozaki-r Exp $");
+
+66 
+	~"t_.h
+"
+
+67 
+	~"t_k.h
+"
+
+68 
+	~"t_x.h
+"
+
+69 
+	~"t_mbu.h
+"
+
+70 
+	~"t_ms.h
+"
+
+71 
+	~"t_geway.h
+"
+
+72 
+	~"t_p.h
+"
+
+73 
+	~"t_t_mp.h
+"
+
+74 
+	~"vn.h
+"
+
+75 
+	~"p.h
+"
+
+76 
+	~"bridge.h
+"
+
+77 
+	~"p.h
+"
+
+78 
+	~"agr.h
+"
+
+80 
+	~<sys/m.h
+>
+
+81 
+	~<sys/sym.h
+>
+
+82 
+	~<sys/sysl.h
+>
+
+83 
+	~<sys/kl.h
+>
+
+84 
+	~<sys/out.h
+>
+
+85 
+	~<sys/mloc.h
+>
+
+86 
+	~<sys/mbuf.h
+>
+
+87 
+	~<sys/osw.h
+>
+
+88 
+	~<sys/sock.h
+>
+
+89 
+	~<sys/iol.h
+>
+
+90 
+	~<sys/o.h
+>
+
+91 
+	~<sys/syog.h
+>
+
+92 
+	~<sys/kauth.h
+>
+
+93 
+	~<sys/u.h
+>
+
+94 
+	~<sys/.h
+>
+
+95 
+	~<sys/devi.h
+>
+
+96 
+	~<sys/d.h
+>
+
+97 
+	~<sys/dsour.h
+>
+
+99 
+	~<t/if.h
+>
+
+100 
+	~<t/ti.h
+>
+
+101 
+	~<t/rou.h
+>
+
+102 
+	~<t/if_c.h
+>
+
+103 
+	~<t/if_dl.h
+>
+
+104 
+	~<t/if_tys.h
+>
+
+106 
+	~<t/if_med.h
+>
+
+107 
+	~<dev/mii/mii.h
+>
+
+108 
+	~<dev/mii/miiv.h
+>
+
+110 #i
+NARP
+ == 0
+
+114 #r 
+You
+ 
+have
+ 
+uded
+ 
+NETATALK
+ 
+
+ 
+a
+ 
+pudo
+-
+devi
+ 
+
+ 
+your
+ 
+cfiguti
+ 
+th
+ 
+dds
+ 
+
+ 
+the
+ 
+en
+ 
+of
+ 
+ht
+ 
+rs
+, 
+but
+ hav
+no
+ 
+such
+ i
+cfigud
+. 
+Check
+ 
+you
+ 
+ly
+ 
+ed
+udo-devi 
+bridge
+, 
+p
+, 
+vn
+ o
+tis
+ NETATALK.
+
+117 
+	~<t/bpf.h
+>
+
+119 
+	~<t/if_h.h
+>
+
+120 
+	~<t/if_vnv.h
+>
+
+122 #i
+NPPPOE
+ > 0
+
+123 
+	~<t/if_p.h
+>
+
+126 #i
+NAGR
+ > 0
+
+127 
+	~<t/agr/8023_owocs.h
+>
+
+128 
+	~<t/agr/8023ad.h
+>
+
+129 
+	~<t/agr/if_agrv.h
+>
+
+132 #i
+NBRIDGE
+ > 0
+
+133 
+	~<t/if_bridgev.h
+>
+
+136 
+	~<t/.h
+>
+
+137 #ifde
+INET
+
+
+138 
+	~<t/_v.h
+>
+
+140 
+	~<t/if_p.h
+>
+
+142 #ifde
+INET6
+
+
+143 #ide
+INET
+
+
+144 
+	~<t/.h
+>
+
+146 
+	~<t6/6_v.h
+>
+
+147 
+	~<t6/nd6.h
+>
+
+151 
+	~".h
+"
+
+152 #i
+NCARP
+ > 0
+
+153 
+	~<t/_.h
+>
+
+156 #ifde
+IPX
+
+
+157 
+	~<tx/x.h
+>
+
+158 
+	~<tx/x_if.h
+>
+
+161 #ifde
+NETATALK
+
+
+162 
+	~<lk/.h
+>
+
+163 
+	~<lk/_v.h
+>
+
+164 
+	~<lk/_ex.h
+>
+
+166 
+	#c__g_code
+ 
+c_un
+.
+ty_
+.
+g_code
+
+
+	)
+
+167 
+	#c__h_ty
+ 
+c_un
+.
+ty_
+.
+h_ty
+
+
+	)
+
+169 
+u_ch
+ 
+_g_code
+[3];
+
+170 
+u_ch
+ 
+_g_code
+[3];
+
+173 #ifde
+MPLS
+
+
+174 
+	~<tms/ms.h
+>
+
+175 
+	~<tms/ms_v.h
+>
+
+178 
+timev
+ 
+	gbigpkpim_
+;
+
+179 
+	gbigpkpim
+ = 2;
+
+180 
+	gbigpkps_cou
+;
+
+181 
+kmux_t
+ 
+bigpkps_lock
+ 
+	g__che_igd
+;
+
+184 c 
+ut8_t
+ 
+	ghbrdaddr
+[
+ETHER_ADDR_LEN
+] =
+
+186 c 
+ut8_t
+ 
+	ghmuiaddr_owocs
+[
+ETHER_ADDR_LEN
+] =
+
+188 
+	#ndr
+(
+e
+{ 
+r
+ = (e); 
+bad
+;}
+
+	)
+
+190 
+h_ouut
+(
+i
+ *, 
+mbuf
+ *,
+
+191 c 
+sockaddr
+ *, 
+y
+ *);
+
+199 
+	$h_ouut
+(
+i
+ * c 
+i0
+, 
+mbuf
+ * c 
+m0
+,
+
+200 c 
+sockaddr
+ * c 
+d
+,
+
+201 
+y
+ *
+0
+)
+
+203 
+ut16_t
+ 
+y
+ = 0;
+
+204 
+r
+ = 0, 
+hdrcmt
+ = 0;
+
+205 
+ut8_t
+ 
+ec
+[6], 
+ed
+[6];
+
+206 
+mbuf
+ *
+m
+ = 
+m0
+;
+
+207 
+y
+ *
+
+;
+
+208 
+mbuf
+ *
+mcy
+ = 
+NULL
+;
+
+209 
+h_hd
+ *
+eh
+;
+
+210 
+i
+ *
+i
+ = 
+i0
+;
+
+211 
+	`ALTQ_DECL
+(
+tq_pkr
+ 
+pkr
+;)
+
+212 #ifde
+INET
+
+
+213 
+phdr
+ *
+ah
+;
+
+215 #ifde
+NETATALK
+
+
+216 
+_iddr
+ *
+
+;
+
+219 #ide
+NET_MPSAFE
+
+
+220 
+	`KASSERT
+(
+	`KERNEL_LOCKED_P
+());
+
+223 #ifde
+MBUFTRACE
+
+
+224 
+	`m_aimm
+(
+m
+, 
+i
+->
+if_mowr
+);
+
+227 #i
+NCARP
+ > 0
+
+228 i(
+i
+->
+if_ty
+ =
+IFT_CARP
+) {
+
+229 
+iddr
+ *
+i
+;
+
+232 i(
+d
+ !
+NULL
+ && 
+i0
+->
+if_lk_e
+ =
+LINK_STATE_UP
+ &&
+
+233 (
+i
+ = 
+	`i_ifwhaddr
+(
+d
+)!
+NULL
+ &&
+
+234 
+i
+->
+i_i
+ =
+i0
+)
+
+235  
+	`loouut
+(
+i0
+, 
+m
+, 
+d
+, 
+0
+);
+
+237 
+i
+ = i->
+if_dev
+;
+
+240 i((
+i0
+->
+if_ags
+ & (
+IFF_UP
+|
+IFF_RUNNING
+)) !=
+
+241 (
+IFF_UP
+|
+IFF_RUNNING
+))
+
+242 
+	`ndr
+(
+ENETDOWN
+);
+
+246 i((
+i
+->
+if_ags
+ & (
+IFF_UP
+|
+IFF_RUNNING
+)) != (IFF_UP|IFF_RUNNING))
+
+247 
+	`ndr
+(
+ENETDOWN
+);
+
+248 i((
+
+ = 
+0
+!
+NULL
+) {
+
+249 i((
+
+->
+_ags
+ & 
+RTF_UP
+) == 0) {
+
+250 i((
+0
+ = 
+
+ = 
+	`loc1
+(
+d
+, 1)!
+NULL
+) {
+
+251 
+
+->
+_ft
+--;
+
+252 i(
+
+->
+_i
+ !
+i
+)
+
+253  (*
+
+->
+_i
+->
+if_ouut
+)
+
+254 (
+i
+, 
+m0
+, 
+d
+, 
+
+);
+
+256 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+258 i((
+
+->
+_ags
+ & 
+RTF_GATEWAY
+)) {
+
+259 i(
+
+->
+_gwrou
+ =
+NULL
+)
+
+260 
+lookup
+;
+
+261 i(((
+
+ =t->
+_gwrou
+)->
+_ags
+ & 
+RTF_UP
+) == 0) {
+
+262 
+	`
+(
+
+);
+0
+;
+
+263 
+lookup
+: 
+
+->
+_gwrou
+ = 
+	`loc1
+t->
+_geway
+, 1);
+
+264 i((
+
+ =t->
+_gwrou
+=
+NULL
+)
+
+265 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+267 i((
+
+->
+_ags
+ & 
+RTF_GATEWAY
+) ||
+
+268 (
+
+->
+_i
+ !
+i
+)) {
+
+269 
+
+->
+_ft
+--;
+
+270 
+0
+->
+_gwrou
+ = 
+NULL
+;
+
+271 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+275 i(
+
+->
+_ags
+ & 
+RTF_REJECT
+)
+
+276 i(
+
+->
+_rmx
+.
+rmx_expe
+ == 0 ||
+
+277 (
+u_lg
+
+time_cd
+ < 
+
+->
+_rmx
+.
+rmx_expe
+)
+
+278 
+	`ndr
+(
+
+ =
+0
+ ? 
+EHOSTDOWN
+ : 
+EHOSTUNREACH
+);
+
+281 
+d
+->
+_my
+) {
+
+283 #ifde
+INET
+
+
+284 
+AF_INET
+:
+
+285 i(
+m
+->
+m_ags
+ & 
+M_BCAST
+)
+
+286 ()
+	`memy
+(
+ed
+, 
+hbrdaddr
+, (edst));
+
+287 i(
+m
+->
+m_ags
+ & 
+M_MCAST
+)
+
+288 
+	`ETHER_MAP_IP_MULTICAST
+(&
+	`tocs
+(
+d
+)->
+s_addr
+, 
+ed
+);
+
+289 i(!
+	`esve
+(
+i
+, 
+
+, 
+m
+, 
+d
+, 
+ed
+))
+
+292 i((
+m
+->
+m_ags
+ & 
+M_BCAST
+&& (
+i
+->
+if_ags
+ & 
+IFF_SIMPLEX
+))
+
+293 
+mcy
+ = 
+	`m_cy
+(
+m
+, 0, ()
+M_COPYALL
+);
+
+294 
+y
+ = 
+	`hts
+(
+ETHERTYPE_IP
+);
+
+297 
+AF_ARP
+:
+
+298 
+ah
+ = 
+	`mtod
+(
+m
+, 
+phdr
+ *);
+
+299 i(
+m
+->
+m_ags
+ & 
+M_BCAST
+)
+
+300 ()
+	`memy
+(
+ed
+, 
+hbrdaddr
+, (edst));
+
+302 *
+tha
+ = 
+	`_tha
+(
+ah
+);
+
+304 i(
+tha
+ =
+NULL
+) {
+
+308 
+	`memy
+(
+ed
+, 
+tha
+, (edst));
+
+311 
+ah
+->
+_hrd
+ = 
+	`hts
+(
+ARPHRD_ETHER
+);
+
+313 
+	`ohs
+(
+ah
+->
+_
+)) {
+
+314 
+ARPOP_REVREQUEST
+:
+
+315 
+ARPOP_REVREPLY
+:
+
+316 
+y
+ = 
+	`hts
+(
+ETHERTYPE_REVARP
+);
+
+319 
+ARPOP_REQUEST
+:
+
+320 
+ARPOP_REPLY
+:
+
+322 
+y
+ = 
+	`hts
+(
+ETHERTYPE_ARP
+);
+
+327 #ifde
+INET6
+
+
+328 
+AF_INET6
+:
+
+329 i(!
+	`nd6_ddr
+(
+i
+, 
+
+, 
+m
+, 
+d
+, 
+ed
+, (edst))){
+
+333 
+y
+ = 
+	`hts
+(
+ETHERTYPE_IPV6
+);
+
+336 #ifde
+NETATALK
+
+
+337 
+AF_APPLETALK
+:
+
+338 i(!
+	`sve
+(
+i
+, 
+m
+, (c 
+sockaddr_
+ *)
+d
+, 
+ed
+)) {
+
+339 #ifde
+NETATALKDEBUG
+
+
+340 
+	`tf
+("aarpresolv failed\n");
+
+347 
+
+ = (
+_iddr
+ *
+	`_iwht
+(
+
+348 (c 
+sockaddr_
+ *)
+d
+, 
+i
+);
+
+349 i(
+
+ =
+NULL
+)
+
+350 
+bad
+;
+
+358 i(
+
+->
+_ags
+ & 
+AFA_PHASE2
+) {
+
+359 
+c
+lc;
+
+361 
+	`M_PREPEND
+(
+m
+, (
+c
+), 
+M_DONTWAIT
+);
+
+362 
+c
+.
+c_dp
+ =lc.
+c_sp
+ = 
+LLC_SNAP_LSAP
+;
+
+363 
+c
+.
+c_c
+ = 
+LLC_UI
+;
+
+364 
+	`memy
+(
+c
+.
+c__g_code
+, 
+_g_code
+,
+
+365 (
+c
+.
+c__g_code
+));
+
+366 
+c
+.
+c__h_ty
+ = 
+	`hts
+(
+ETHERTYPE_ATALK
+);
+
+367 
+	`memy
+(
+	`mtod
+(
+m
+, *), &
+c
+, (llc));
+
+369 
+y
+ = 
+	`hts
+(
+ETHERTYPE_ATALK
+);
+
+373 #ifde
+IPX
+
+
+374 
+AF_IPX
+:
+
+375 
+y
+ = 
+	`hts
+(
+ETHERTYPE_IPX
+);
+
+376 
+	`memy
+(
+ed
+,
+
+377 &(((c 
+sockaddr_x
+ *)
+d
+)->
+sx_addr
+.
+x_ho
+),
+
+378 (
+ed
+));
+
+380 i((
+m
+->
+m_ags
+ & 
+M_BCAST
+&& (
+i
+->
+if_ags
+ & 
+IFF_SIMPLEX
+))
+
+381 
+mcy
+ = 
+	`m_cy
+(
+m
+, 0, ()
+M_COPYALL
+);
+
+384 
+pudo_AF_HDRCMPLT
+:
+
+385 
+hdrcmt
+ = 1;
+
+386 
+	`memy
+(
+ec
+,
+
+387 ((c 
+h_hd
+ *)
+d
+->
+_da
+)->
+h_sho
+,
+
+388 (
+ec
+));
+
+391 
+AF_UNSPEC
+:
+
+392 
+	`memy
+(
+ed
+,
+
+393 ((c 
+h_hd
+ *)
+d
+->
+_da
+)->
+h_dho
+,
+
+394 (
+ed
+));
+
+396 
+y
+ = ((c 
+h_hd
+ *)
+d
+->
+_da
+)->
+h_ty
+;
+
+400 
+	`tf
+("%s: c'hdf%d\n", 
+i
+->
+if_xme
+,
+
+401 
+d
+->
+_my
+);
+
+402 
+	`ndr
+(
+EAFNOSUPPORT
+);
+
+405 #ifde
+MPLS
+
+
+406 i(
+0
+ !
+NULL
+ && 
+	`_gg
+(rt0) != NULL &&
+
+407 
+	`_gg
+(
+0
+)->
+_my
+ =
+AF_MPLS
+ &&
+
+408 (
+m
+->
+m_ags
+ & (
+M_MCAST
+ | 
+M_BCAST
+)) == 0) {
+
+409 
+ms_shim
+ 
+msh
+;
+
+410 
+msh
+.
+s_addr
+ = 
+	`MPLS_GETSADDR
+(
+0
+);
+
+411 i(
+msh
+.
+shim
+.
+b
+ !
+MPLS_LABEL_IMPLNULL
+)
+
+412 
+y
+ = 
+	`hts
+(
+ETHERTYPE_MPLS
+);
+
+416 i(
+mcy
+)
+
+417 ()
+	`loouut
+(
+i
+, 
+mcy
+, 
+d
+, 
+
+);
+
+421 i(
+y
+ == 0)
+
+422 
+y
+ = 
+	`hts
+(
+m
+->
+m_pkthdr
+.
+n
+);
+
+427 
+	`M_PREPEND
+(
+m
+,  (
+h_hd
+), 
+M_DONTWAIT
+);
+
+428 i(
+m
+ == 0)
+
+429 
+	`ndr
+(
+ENOBUFS
+);
+
+430 
+eh
+ = 
+	`mtod
+(
+m
+, 
+h_hd
+ *);
+
+432 ()
+	`memy
+(&
+eh
+->
+h_ty
+, &
+y
+, (eh->ether_type));
+
+433 
+	`memy
+(
+eh
+->
+h_dho
+, 
+ed
+, (edst));
+
+434 i(
+hdrcmt
+)
+
+435 
+	`memy
+(
+eh
+->
+h_sho
+, 
+ec
+, (eh->ether_shost));
+
+437 
+	`memy
+(
+eh
+->
+h_sho
+, 
+	`CLLADDR
+(
+i
+->
+if_dl
+),
+
+438 (
+eh
+->
+h_sho
+));
+
+440 #i
+NCARP
+ > 0
+
+441 i(
+i0
+ !
+i
+ && i0->
+if_ty
+ =
+IFT_CARP
+) {
+
+442 
+	`memy
+(
+eh
+->
+h_sho
+, 
+	`CLLADDR
+(
+i0
+->
+if_dl
+),
+
+443 (
+eh
+->
+h_sho
+));
+
+447 i((
+r
+ = 
+	`pf_run_hooks
+(
+i
+->
+if_pf
+, &
+m
+, i, 
+PFIL_OUT
+)) != 0)
+
+448  (
+r
+);
+
+449 i(
+m
+ =
+NULL
+)
+
+452 #i
+NBRIDGE
+ > 0
+
+456 i(
+i
+->
+if_bridge
+)
+
+457  (
+	`bridge_ouut
+(
+i
+, 
+m
+, 
+NULL
+, NULL));
+
+460 #i
+NCARP
+ > 0
+
+461 i(
+i
+ !
+i0
+)
+
+462 
+i0
+->
+if_obys
+ +
+m
+->
+m_pkthdr
+.
+n
+ + 
+ETHER_HDR_LEN
+;
+
+465 #ifde
+ALTQ
+
+
+472 i(
+	`ALTQ_IS_ENABLED
+(&
+i
+->
+if_d
+))
+
+473 
+	`tq_hassify
+(&
+i
+->
+if_d
+, 
+m
+, &
+pkr
+);
+
+475  
+	`ifq_queue
+(
+i
+, 
+m
+ 
+ALTQ_COMMA
+ 
+	`ALTQ_DECL
+(&
+pkr
+));
+
+477 
+bad
+:
+
+478 i(
+m
+)
+
+479 
+	`m_m
+(
+m
+);
+
+480  (
+r
+);
+
+481 
+	}
+}
+
+483 #ifde
+ALTQ
+
+
+490 
+	$tq_hassify
+(
+iq
+ *
+ifq
+, 
+mbuf
+ *
+m
+,
+
+491 
+tq_pkr
+ *
+pkr
+)
+
+493 
+h_hd
+ *
+eh
+;
+
+494 
+ut16_t
+ 
+h_ty
+;
+
+495 
+hn
+, 
+af
+, 
+hdrsize
+;
+
+496 *
+hdr
+;
+
+498 
+hn
+ = 
+ETHER_HDR_LEN
+;
+
+499 
+eh
+ = 
+	`mtod
+(
+m
+, 
+h_hd
+ *);
+
+501 
+h_ty
+ = 
+	`hts
+(
+eh
+->ether_type);
+
+503 i(
+h_ty
+ < 
+ETHERMTU
+) {
+
+505 
+c
+ *(*)(
+eh
+ + 1);
+
+506 
+hn
+ += 8;
+
+508 i(
+m
+->
+m_n
+ < 
+hn
+ ||
+
+509 
+c
+->
+c_dp
+ !
+LLC_SNAP_LSAP
+ ||
+
+510 
+c
+->
+c_sp
+ !
+LLC_SNAP_LSAP
+ ||
+
+511 
+c
+->
+c_c
+ !
+LLC_UI
+) {
+
+513 
+bad
+;
+
+516 
+h_ty
+ = 
+	`hts
+(
+c
+->
+c_un
+.
+ty_
+.ether_type);
+
+519 
+h_ty
+) {
+
+520 
+ETHERTYPE_IP
+:
+
+521 
+af
+ = 
+AF_INET
+;
+
+522 
+hdrsize
+ = 20;
+
+525 
+ETHERTYPE_IPV6
+:
+
+526 
+af
+ = 
+AF_INET6
+;
+
+527 
+hdrsize
+ = 40;
+
+531 
+af
+ = 
+AF_UNSPEC
+;
+
+532 
+hdrsize
+ = 0;
+
+536 
+m
+->
+m_n
+ <
+hn
+) {
+
+537 
+hn
+ -
+m
+->
+m_n
+;
+
+538 
+m
+ = m->
+m_xt
+;
+
+540 i(
+m
+->
+m_n
+ < (
+hn
+ + 
+hdrsize
+)) {
+
+546 #ifde
+DEBUG
+
+
+547 
+	`tf
+("altq_etherclassify: headers span multiple mbufs: "
+
+548 "%d < %d\n", 
+m
+->
+m_n
+, (
+hn
+ + 
+hdrsize
+));
+
+550 
+bad
+;
+
+553 
+m
+->
+m_da
+ +
+hn
+;
+
+554 
+m
+->
+m_n
+ -
+hn
+;
+
+556 
+hdr
+ = 
+	`mtod
+(
+m
+, *);
+
+558 i(
+	`ALTQ_NEEDS_CLASSIFY
+(
+ifq
+))
+
+559 
+pkr
+->
+r_ass
+ =
+
+560 (*
+ifq
+->
+tq_assify
+)(ifq->
+tq_fr
+, 
+m
+, 
+af
+);
+
+561 
+pkr
+->
+r_af
+ = 
+af
+;
+
+562 
+pkr
+->
+r_hdr
+ = 
+hdr
+;
+
+564 
+m
+->
+m_da
+ -
+hn
+;
+
+565 
+m
+->
+m_n
+ +
+hn
+;
+
+569 
+bad
+:
+
+570 
+pkr
+->
+r_ass
+ = 
+NULL
+;
+
+571 
+pkr
+->
+r_hdr
+ = 
+NULL
+;
+
+572 
+pkr
+->
+r_af
+ = 
+AF_UNSPEC
+;
+
+573 
+	}
+}
+
+582 
+	$h_put
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+)
+
+584 
+	`tf
+("ether_input\n");
+
+585 
+hcom
+ *
+ec
+ = (hcom *
+i
+;
+
+586 
+pktqueue_t
+ *
+pktq
+ = 
+NULL
+;
+
+587 
+ifqueue
+ *
+q
+ = 
+NULL
+;
+
+588 
+ut16_t
+ 
+y
+;
+
+589 
+h_hd
+ *
+eh
+;
+
+590 
+size_t
+ 
+ehn
+;
+
+591 
+ypkts
+;
+
+592 
+i
+ = 0;
+
+593 #i
+	`defed
+ (
+LLC
+|| defed(
+NETATALK
+)
+
+594 
+c
+ *
+l
+;
+
+597 i((
+i
+->
+if_ags
+ & 
+IFF_UP
+) == 0) {
+
+598 
+	`m_m
+(
+m
+);
+
+602 #ifde
+MBUFTRACE
+
+
+603 
+	`m_aimm
+(
+m
+, &
+ec
+->
+ec_rx_mowr
+);
+
+605 
+eh
+ = 
+	`mtod
+(
+m
+, 
+h_hd
+ *);
+
+606 
+y
+ = 
+	`ohs
+(
+eh
+->
+h_ty
+);
+
+607 
+ehn
+ = (*
+eh
+);
+
+609 if(
+	`__edi_l
+(
+ypkts
+ < 100 || !
+d_l_y
+)) {
+
+610 
+	`d_add_da
+(
+NULL
+, 
+eh
+, 
+ehn
+, 0);
+
+611 
+ypkts
+++;
+
+617 i(
+y
+ !
+ETHERTYPE_MPLS
+ && 
+m
+->
+m_pkthdr
+.
+n
+ >
+
+618 
+	`ETHER_MAX_FRAME
+(
+i
+, 
+y
+, 
+m
+->
+m_ags
+ & 
+M_HASFCS
+)) {
+
+619 
+	`mux_r
+(&
+bigpkps_lock
+);
+
+620 i(
+	`echeck
+(&
+bigpkpim_
+, &
+bigpkps_cou
+,
+
+621 
+bigpkpim
+)) {
+
+622 
+	`tf
+("%s: discarding oversize frame (len=%d)\n",
+
+623 
+i
+->
+if_xme
+, 
+m
+->
+m_pkthdr
+.
+n
+);
+
+625 
+	`mux_ex
+(&
+bigpkps_lock
+);
+
+626 
+	`m_m
+(
+m
+);
+
+630 i(
+	`ETHER_IS_MULTICAST
+(
+eh
+->
+h_dho
+)) {
+
+635 i((
+i
+->
+if_ags
+ & 
+IFF_SIMPLEX
+) == 0 &&
+
+636 
+	`memcmp
+(
+	`CLLADDR
+(
+i
+->
+if_dl
+), 
+eh
+->
+h_sho
+,
+
+637 
+ETHER_ADDR_LEN
+) == 0) {
+
+638 
+	`m_m
+(
+m
+);
+
+642 i(
+	`memcmp
+(
+hbrdaddr
+,
+
+643 
+eh
+->
+h_dho
+, 
+ETHER_ADDR_LEN
+) == 0)
+
+644 
+m
+->
+m_ags
+ |
+M_BCAST
+;
+
+646 
+m
+->
+m_ags
+ |
+M_MCAST
+;
+
+647 
+i
+->
+if_ims
+++;
+
+651 i(
+m
+->
+m_ags
+ & 
+M_HASFCS
+) {
+
+652 
+	`m_adj
+(
+m
+, -
+ETHER_CRC_LEN
+);
+
+653 
+m
+->
+m_ags
+ &~
+M_HASFCS
+;
+
+656 
+i
+->
+if_ibys
+ +
+m
+->
+m_pkthdr
+.
+n
+;
+
+658 #i
+NCARP
+ > 0
+
+659 i(
+	`__edi_l
+(
+i
+->
+if_
+ && i->
+if_ty
+ !
+IFT_CARP
+)) {
+
+664 
+m
+->
+m_ags
+ &~
+M_PROMISC
+;
+
+665 i(
+	`_put
+(
+m
+, (
+ut8_t
+ *)&
+eh
+->
+h_sho
+,
+
+666 (
+ut8_t
+ *)&
+eh
+->
+h_dho
+,h->
+h_ty
+) == 0)
+
+670 i((
+m
+->
+m_ags
+ & (
+M_BCAST
+|
+M_MCAST
+|
+M_PROMISC
+)) == 0 &&
+
+671 (
+i
+->
+if_ags
+ & 
+IFF_PROMISC
+) != 0 &&
+
+672 
+	`memcmp
+(
+	`CLLADDR
+(
+i
+->
+if_dl
+), 
+eh
+->
+h_dho
+,
+
+673 
+ETHER_ADDR_LEN
+) != 0) {
+
+674 
+m
+->
+m_ags
+ |
+M_PROMISC
+;
+
+677 i((
+m
+->
+m_ags
+ & 
+M_PROMISC
+) == 0) {
+
+678 i(
+	`pf_run_hooks
+(
+i
+->
+if_pf
+, &
+m
+, i, 
+PFIL_IN
+) != 0)
+
+680 i(
+m
+ =
+NULL
+)
+
+683 
+eh
+ = 
+	`mtod
+(
+m
+, 
+h_hd
+ *);
+
+684 
+y
+ = 
+	`ohs
+(
+eh
+->
+h_ty
+);
+
+685 
+ehn
+ = (*
+eh
+);
+
+688 #i
+NAGR
+ > 0
+
+689 i(
+i
+->
+if_agrive
+ &&
+
+690 
+	`__edi_ue
+(
+y
+ !
+ETHERTYPE_SLOWPROTOCOLS
+)) {
+
+691 
+m
+->
+m_ags
+ &~
+M_PROMISC
+;
+
+692 
+	`agr_put
+(
+i
+, 
+m
+);
+
+702 i(
+ec
+->
+ec_nvns
+ && 
+	`m_g_fd
+(
+m
+, 
+PACKET_TAG_VLAN
+, 
+NULL
+) != NULL) {
+
+703 #i
+NVLAN
+ > 0
+
+708 
+	`vn_put
+(
+i
+, 
+m
+);
+
+710 
+	`m_m
+(
+m
+);
+
+719 
+y
+) {
+
+720 
+ETHERTYPE_VLAN
+: {
+
+721 
+h_vn_hd
+ *
+evl
+ = (*)
+eh
+;
+
+727 i(
+m
+->
+m_n
+ <(*
+evl
+)
+
+728 && 
+	`EVL_VLANOFTAG
+(
+evl
+->
+evl_g
+) == 0) {
+
+729 
+y
+ = 
+	`ohs
+(
+evl
+->
+evl_o
+);
+
+730 
+ehn
+ = (*
+evl
+);
+
+731 i((
+m
+->
+m_ags
+ & 
+M_PROMISC
+) == 0
+
+732 && (
+y
+ =
+ETHERTYPE_IP
+
+
+733 || 
+y
+ =
+ETHERTYPE_IPV6
+))
+
+736 #i
+NVLAN
+ > 0
+
+741 i(((
+hcom
+ *)
+i
+)->
+ec_nvns
+ != 0)
+
+742 
+	`vn_put
+(
+i
+, 
+m
+);
+
+745 
+	`m_m
+(
+m
+);
+
+748 #i
+NPPPOE
+ > 0
+
+749 
+ETHERTYPE_PPPOEDISC
+:
+
+750 
+ETHERTYPE_PPPOE
+:
+
+751 i(
+m
+->
+m_ags
+ & 
+M_PROMISC
+) {
+
+752 
+	`m_m
+(
+m
+);
+
+755 #ide
+PPPOE_SERVER
+
+
+756 i(
+m
+->
+m_ags
+ & (
+M_MCAST
+ | 
+M_BCAST
+)) {
+
+757 
+	`m_m
+(
+m
+);
+
+762 i(
+y
+ =
+ETHERTYPE_PPPOEDISC
+)
+
+763 
+q
+ = &
+discq
+;
+
+765 
+q
+ = &
+q
+;
+
+766 i(
+	`IF_QFULL
+(
+q
+)) {
+
+767 
+	`IF_DROP
+(
+q
+);
+
+768 
+	`m_m
+(
+m
+);
+
+770 
+	`IF_ENQUEUE
+(
+q
+, 
+m
+);
+
+771 
+	`sot_schedu
+(
+p_so
+);
+
+775 
+ETHERTYPE_SLOWPROTOCOLS
+: {
+
+776 
+ut8_t
+ 
+subty
+;
+
+778 #i
+	`defed
+(
+DIAGNOSTIC
+)
+
+779 i(
+m
+->
+m_pkthdr
+.
+n
+ < (*
+eh
++ (
+subty
+)) {
+
+780 
+	`nic
+("ether_input:oo short slowrotocolacket");
+
+783 
+	`m_cyda
+(
+m
+, (*
+eh
+), (
+subty
+), &subtype);
+
+784 
+subty
+) {
+
+785 #i
+NAGR
+ > 0
+
+786 
+SLOWPROTOCOLS_SUBTYPE_LACP
+:
+
+787 i(
+i
+->
+if_agrive
+) {
+
+788 
+	`8023ad__put
+(
+i
+, 
+m
+);
+
+793 
+SLOWPROTOCOLS_SUBTYPE_MARKER
+:
+
+794 i(
+i
+->
+if_agrive
+) {
+
+795 
+	`8023ad_mk_put
+(
+i
+, 
+m
+);
+
+801 i(
+subty
+ == 0 || subtype > 10) {
+
+803 
+	`m_m
+(
+m
+);
+
+812 i(
+m
+->
+m_ags
+ & 
+M_PROMISC
+) {
+
+813 
+	`m_m
+(
+m
+);
+
+819 i(
+m
+->
+m_ags
+ & 
+M_HASFCS
+) {
+
+820 
+	`m_adj
+(
+m
+, -
+ETHER_CRC_LEN
+);
+
+821 
+m
+->
+m_ags
+ &~
+M_HASFCS
+;
+
+824 i(
+y
+ > 
+ETHERMTU
+ +  (
+h_hd
+)) {
+
+826 
+	`m_adj
+(
+m
+, 
+ehn
+);
+
+828 
+y
+) {
+
+829 #ifde
+INET
+
+
+830 
+ETHERTYPE_IP
+:
+
+831 #ifde
+GATEWAY
+
+
+832 i(
+	`ow_fwd
+(
+m
+))
+
+835 
+pktq
+ = 
+_pktq
+;
+
+838 
+ETHERTYPE_ARP
+:
+
+839 
+i
+ = 
+NETISR_ARP
+;
+
+840 
+q
+ = &
+pq
+;
+
+843 
+ETHERTYPE_REVARP
+:
+
+844 
+	`vpput
+(
+m
+);
+
+847 #ifde
+INET6
+
+
+848 
+ETHERTYPE_IPV6
+:
+
+849 i(
+	`__edi_l
+(!
+6_e
+)) {
+
+850 
+	`m_m
+(
+m
+);
+
+853 #ifde
+GATEWAY
+
+
+854 i(
+	`6ow_fwd
+(&
+m
+))
+
+857 
+pktq
+ = 
+6_pktq
+;
+
+860 #ifde
+IPX
+
+
+861 
+ETHERTYPE_IPX
+:
+
+862 
+i
+ = 
+NETISR_IPX
+;
+
+863 
+q
+ = &
+xq
+;
+
+866 #ifde
+NETATALK
+
+
+867 
+ETHERTYPE_ATALK
+:
+
+868 
+i
+ = 
+NETISR_ATALK
+;
+
+869 
+q
+ = &
+q1
+;
+
+871 
+ETHERTYPE_AARP
+:
+
+873 
+	`put
+(
+i
+, 
+m
+);
+
+876 #ifde
+MPLS
+
+
+877 
+ETHERTYPE_MPLS
+:
+
+878 
+i
+ = 
+NETISR_MPLS
+;
+
+879 
+q
+ = &
+msq
+;
+
+883 
+	`m_m
+(
+m
+);
+
+887 #i
+	`defed
+ (
+LLC
+|| defed (
+NETATALK
+)
+
+888 
+l
+ = (
+c
+ *)(
+eh
++1);
+
+889 
+l
+->
+c_dp
+) {
+
+890 #ifde
+NETATALK
+
+
+891 
+LLC_SNAP_LSAP
+:
+
+892 
+l
+->
+c_c
+) {
+
+893 
+LLC_UI
+:
+
+894 i(
+l
+->
+c_sp
+ !
+LLC_SNAP_LSAP
+) {
+
+895 
+dryway
+;
+
+898 i(
+	`memcmp
+(&(
+l
+->
+c__g_code
+)[0],
+
+899 
+_g_code
+, (at_org_code)) == 0 &&
+
+900 
+	`ohs
+(
+l
+->
+c__h_ty
+) ==
+
+901 
+ETHERTYPE_ATALK
+) {
+
+902 
+q
+ = &
+q2
+;
+
+903 
+	`m_adj
+(
+m
+, (
+h_hd
+)
+
+904 + (
+c
+));
+
+905 
+i
+ = 
+NETISR_ATALK
+;
+
+909 i(
+	`memcmp
+(&(
+l
+->
+c__g_code
+)[0],
+
+910 
+_g_code
+,
+
+911 (
+_g_code
+)) == 0 &&
+
+912 
+	`ohs
+(
+l
+->
+c__h_ty
+) ==
+
+913 
+ETHERTYPE_AARP
+) {
+
+914 
+	`m_adj
+
+m
+, (
+h_hd
+)
+
+915 + (
+c
+));
+
+916 
+	`put
+(
+i
+, 
+m
+);
+
+921 
+dryway
+;
+
+924 
+dryway
+:
+
+927 
+	`m_m
+(
+m
+);
+
+931 
+	`m_m
+(
+m
+);
+
+936 i(
+	`__edi_ue
+(
+pktq
+)) {
+
+937 c 
+ut32_t
+ 
+h
+ = 
+	`pktq_s_hash
+(
+m
+);
+
+938 i(
+	`__edi_l
+(!
+	`pktq_queue
+(
+pktq
+, 
+m
+, 
+h
+))) {
+
+939 
+	`m_m
+(
+m
+);
+
+944 i(
+	`__edi_l
+(!
+q
+)) {
+
+946 
+	`m_m
+(
+m
+);
+
+949 i(
+	`IF_QFULL
+(
+q
+)) {
+
+950 
+	`IF_DROP
+(
+q
+);
+
+951 
+	`m_m
+(
+m
+);
+
+953 
+	`IF_ENQUEUE
+(
+q
+, 
+m
+);
+
+954 
+	`schedti
+(
+i
+);
+
+956 
+	}
+}
+
+962 
+	$h_rtf
+(c 
+u_ch
+ *
+
+)
+
+964 
+hbuf
+[3 * 
+ETHER_ADDR_LEN
+];
+
+965  
+	`h_tf
+(
+hbuf
+, thbuf), 
+
+);
+
+966 
+	}
+}
+
+969 
+	$h_tf
+(*
+buf
+, 
+size_t
+ 
+n
+, c 
+u_ch
+ *
+
+)
+
+971 *
+
+ = 
+buf
+;
+
+972 
+size_t
+ 
+i
+;
+
+974 
+i
+ = 0; i < 
+n
+ / 3; i++) {
+
+975 *
+
+++ = 
+hexdigs
+[*
+
+ >> 4];
+
+976 *
+
+++ = 
+hexdigs
+[*
+
+++ & 0xf];
+
+977 *
+
+++ = ':';
+
+979 *--
+
+ = '\0';
+
+980  
+buf
+;
+
+981 
+	}
+}
+
+987 
+	$h_iach
+(
+i
+ *
+i
+, c 
+ut8_t
+ *
+a
+)
+
+989 
+hcom
+ *
+ec
+ = (hcom *)
+i
+;
+
+991 
+i
+->
+if_ty
+ = 
+IFT_ETHER
+;
+
+992 
+i
+->
+if_hd
+ = 
+ETHER_HDR_LEN
+;
+
+993 
+i
+->
+if_d
+ = 
+DLT_EN10MB
+;
+
+994 
+i
+->
+if_mtu
+ = 
+ETHERMTU
+;
+
+995 
+i
+->
+if_ouut
+ = 
+h_ouut
+;
+
+996 
+i
+->
+if_put
+ = 
+h_put
+;
+
+997 i(
+i
+->
+if_baud
+ == 0)
+
+998 
+i
+->
+if_baud
+ = 
+	`IF_Mbps
+(10);
+
+1000 
+	`if_t_dl
+(
+i
+, 
+a
+, 
+ETHER_ADDR_LEN
+, !
+	`ETHER_IS_LOCAL
+(lla));
+
+1002 
+	`LIST_INIT
+(&
+ec
+->
+ec_muddrs
+);
+
+1003 
+i
+->
+if_brdaddr
+ = 
+hbrdaddr
+;
+
+1004 
+	`bpf_ch
+(
+i
+, 
+DLT_EN10MB
+, (
+h_hd
+));
+
+1005 #ifde
+MBUFTRACE
+
+
+1006 
+	`y
+(
+ec
+->
+ec_tx_mowr
+.
+mo_me
+, 
+i
+->
+if_xme
+,
+
+1007 (
+ec
+->
+ec_tx_mowr
+.
+mo_me
+));
+
+1008 
+	`y
+(
+ec
+->
+ec_tx_mowr
+.
+mo_des
+, "tx",
+
+1009 (
+ec
+->
+ec_tx_mowr
+.
+mo_des
+));
+
+1010 
+	`y
+(
+ec
+->
+ec_rx_mowr
+.
+mo_me
+, 
+i
+->
+if_xme
+,
+
+1011 (
+ec
+->
+ec_rx_mowr
+.
+mo_me
+));
+
+1012 
+	`y
+(
+ec
+->
+ec_rx_mowr
+.
+mo_des
+, "rx",
+
+1013 (
+ec
+->
+ec_rx_mowr
+.
+mo_des
+));
+
+1014 
+	`MOWNER_ATTACH
+(&
+ec
+->
+ec_tx_mowr
+);
+
+1015 
+	`MOWNER_ATTACH
+(&
+ec
+->
+ec_rx_mowr
+);
+
+1016 
+i
+->
+if_mowr
+ = &
+ec
+->
+ec_tx_mowr
+;
+
+1018 
+	}
+}
+
+1021 
+	$h_ifdach
+(
+i
+ *
+i
+)
+
+1023 
+hcom
+ *
+ec
+ = (*
+i
+;
+
+1024 
+h_mui
+ *
+m
+;
+
+1025 
+s
+;
+
+1034 
+i
+->
+if_iol
+ = ((*)(
+i
+ *, 
+u_lg
+, *))
+xio
+;
+
+1036 #i
+NBRIDGE
+ > 0
+
+1037 i(
+i
+->
+if_bridge
+)
+
+1038 
+	`bridge_ifdach
+(
+i
+);
+
+1041 
+	`bpf_dach
+(
+i
+);
+
+1043 #i
+NVLAN
+ > 0
+
+1044 i(
+ec
+->
+ec_nvns
+)
+
+1045 
+	`vn_ifdach
+(
+i
+);
+
+1048 
+s
+ = 
+	`
+();
+
+1049 (
+m
+ = 
+	`LIST_FIRST
+(&
+ec
+->
+ec_muddrs
+)!
+NULL
+) {
+
+1050 
+	`LIST_REMOVE
+(
+m
+, 
+m_li
+);
+
+1051 
+	`
+(
+m
+, 
+M_IFMADDR
+);
+
+1052 
+ec
+->
+ec_muit
+--;
+
+1054 
+	`lx
+(
+s
+);
+
+1056 
+i
+->
+if_mowr
+ = 
+NULL
+;
+
+1057 
+	`MOWNER_DETACH
+(&
+ec
+->
+ec_rx_mowr
+);
+
+1058 
+	`MOWNER_DETACH
+(&
+ec
+->
+ec_tx_mowr
+);
+
+1059 
+	}
+}
+
+1067 
+ut32_t
+
+
+1068 
+	$h_c32_
+(c 
+ut8_t
+ *
+buf
+, 
+size_t
+ 
+n
+)
+
+1070 
+ut32_t
+ 
+c
+, 
+c
+, 
+y
+;
+
+1071 
+size_t
+ 
+i
+, 
+j
+;
+
+1073 
+c
+ = 0xffffffffU;
+
+1075 
+i
+ = 0; i < 
+n
+; i++) {
+
+1076 
+c
+ = 
+buf
+[
+i
+];
+
+1077 
+j
+ = 0; j < 8; j++) {
+
+1078 
+y
+ = ((
+c
+ & 0x01? 1 : 0^ (
+c
+ & 0x01);
+
+1079 
+c
+ >>= 1;
+
+1080 
+c
+ >>= 1;
+
+1081 i(
+y
+)
+
+1082 
+c
+ = (^ 
+ETHER_CRC_POLY_LE
+);
+
+1086  (
+c
+);
+
+1087 
+	}
+}
+
+1089 
+ut32_t
+
+
+1090 
+	$h_c32_
+(c 
+ut8_t
+ *
+buf
+, 
+size_t
+ 
+n
+)
+
+1092 c 
+ut32_t
+ 
+ab
+[] = {
+
+1098 
+ut32_t
+ 
+c
+;
+
+1099 
+size_t
+ 
+i
+;
+
+1101 
+c
+ = 0xffffffffU;
+
+1103 
+i
+ = 0; i < 
+n
+; i++) {
+
+1104 
+c
+ ^
+buf
+[
+i
+];
+
+1105 
+c
+ = (>> 4^ 
+ab
+[crc & 0xf];
+
+1106 
+c
+ = (>> 4^ 
+ab
+[crc & 0xf];
+
+1109  (
+c
+);
+
+1110 
+	}
+}
+
+1113 
+ut32_t
+
+
+1114 
+	$h_c32_be
+(c 
+ut8_t
+ *
+buf
+, 
+size_t
+ 
+n
+)
+
+1116 
+ut32_t
+ 
+c
+, 
+c
+, 
+y
+;
+
+1117 
+size_t
+ 
+i
+, 
+j
+;
+
+1119 
+c
+ = 0xffffffffU;
+
+1121 
+i
+ = 0; i < 
+n
+; i++) {
+
+1122 
+c
+ = 
+buf
+[
+i
+];
+
+1123 
+j
+ = 0; j < 8; j++) {
+
+1124 
+y
+ = ((
+c
+ & 0x80000000U? 1 : 0^ (
+c
+ & 0x01);
+
+1125 
+c
+ <<= 1;
+
+1126 
+c
+ >>= 1;
+
+1127 i(
+y
+)
+
+1128 
+c
+ = (^ 
+ETHER_CRC_POLY_BE
+| 
+y
+;
+
+1132  (
+c
+);
+
+1133 
+	}
+}
+
+1135 #ifde
+INET
+
+
+1136 c 
+ut8_t
+ 
+	gh_mui_m
+[
+ETHER_ADDR_LEN
+] =
+
+1138 c 
+ut8_t
+ 
+	gh_mui_max
+[
+ETHER_ADDR_LEN
+] =
+
+1141 #ifde
+INET6
+
+
+1142 c 
+ut8_t
+ 
+	gh_6mui_m
+[
+ETHER_ADDR_LEN
+] =
+
+1144 c 
+ut8_t
+ 
+	gh_6mui_max
+[
+ETHER_ADDR_LEN
+] =
+
+1152 
+	$h__r
+(
+u_ch
+ *
+de
+, 
+size_t
+ 
+n
+, c *
+r
+)
+
+1154 c 
+u_ch
+ *
+
+ = (c *)
+r
+;
+
+1155 
+u_ch
+ *
+
+;
+
+1157 
+	#ox
+(
+c
+(((c<'9'? ((c- '0': ((
+	`tou
+(c- 'A'+ 10))
+
+	)
+
+1159 i(
+n
+ < 
+ETHER_ADDR_LEN
+)
+
+1160  
+ENOSPC
+;
+
+1162 
+
+ = 
+de
+ + 
+ETHER_ADDR_LEN
+;
+
+1164 *
+
+) {
+
+1165 i(!
+	`isxdig
+(*
+
+))
+
+1166  
+EINVAL
+;
+
+1167 *
+de
+ = 
+	`ox
+(*
+
+);
+
+1168 
+
+++;
+
+1169 i(
+	`isxdig
+(*
+
+)) {
+
+1170 *
+de
+ = (*de << 4| 
+	`ox
+(*
+
+);
+
+1171 
+de
+++;
+
+1172 
+
+++;
+
+1174 
+de
+++;
+
+1175 i(
+de
+ =
+
+)
+
+1176  *
+
+ ='\0' ? 0 : 
+ENAMETOOLONG
+;
+
+1177 *
+
+) {
+
+1181 
+
+++;
+
+1185  
+ENOBUFS
+;
+
+1186 
+	}
+}
+
+1193 
+	$h_muddr
+(c 
+sockaddr
+ *
+
+, 
+ut8_t
+ 
+addo
+[
+ETHER_ADDR_LEN
+],
+
+1194 
+ut8_t
+ 
+addrhi
+[
+ETHER_ADDR_LEN
+])
+
+1196 #ifde
+INET
+
+
+1197 c 
+sockaddr_
+ *
+s
+;
+
+1199 #ifde
+INET6
+
+
+1200 c 
+sockaddr_6
+ *
+s6
+;
+
+1203 
+
+->
+_my
+) {
+
+1205 
+AF_UNSPEC
+:
+
+1206 
+	`memy
+(
+addo
+, 
+
+->
+_da
+, 
+ETHER_ADDR_LEN
+);
+
+1207 
+	`memy
+(
+addrhi
+, 
+addo
+, 
+ETHER_ADDR_LEN
+);
+
+1210 #ifde
+INET
+
+
+1211 
+AF_INET
+:
+
+1212 
+s
+ = 
+	`tocs
+(
+
+);
+
+1213 i(
+s
+->
+s_addr
+.
+s_addr
+ =
+INADDR_ANY
+) {
+
+1220 
+	`memy
+(
+addo
+, 
+h_mui_m
+, 
+ETHER_ADDR_LEN
+);
+
+1221 
+	`memy
+(
+addrhi
+, 
+h_mui_max
+, 
+ETHER_ADDR_LEN
+);
+
+1224 
+	`ETHER_MAP_IP_MULTICAST
+(&
+s
+->
+s_addr
+, 
+addo
+);
+
+1225 
+	`memy
+(
+addrhi
+, 
+addo
+, 
+ETHER_ADDR_LEN
+);
+
+1229 #ifde
+INET6
+
+
+1230 
+AF_INET6
+:
+
+1231 
+s6
+ = 
+	`tocs6
+(
+
+);
+
+1232 i(
+	`IN6_IS_ADDR_UNSPECIFIED
+(&
+s6
+->
+s6_addr
+)) {
+
+1239 
+	`memy
+(
+addo
+, 
+h_6mui_m
+, 
+ETHER_ADDR_LEN
+);
+
+1240 
+	`memy
+(
+addrhi
+, 
+h_6mui_max
+, 
+ETHER_ADDR_LEN
+);
+
+1242 
+	`ETHER_MAP_IPV6_MULTICAST
+(&
+s6
+->
+s6_addr
+, 
+addo
+);
+
+1243 
+	`memy
+(
+addrhi
+, 
+addo
+, 
+ETHER_ADDR_LEN
+);
+
+1249  
+EAFNOSUPPORT
+;
+
+1252 
+	}
+}
+
+1259 
+	$h_addmui
+(c 
+sockaddr
+ *
+
+, 
+hcom
+ *
+ec
+)
+
+1261 
+h_mui
+ *
+m
+;
+
+1262 
+u_ch
+ 
+addo
+[
+ETHER_ADDR_LEN
+];
+
+1263 
+u_ch
+ 
+addrhi
+[
+ETHER_ADDR_LEN
+];
+
+1264 
+s
+ = 
+	`
+(), 
+r
+;
+
+1266 
+r
+ = 
+	`h_muddr
+(
+
+, 
+addo
+, 
+addrhi
+);
+
+1267 i(
+r
+ != 0) {
+
+1268 
+	`lx
+(
+s
+);
+
+1269  
+r
+;
+
+1275 i(!
+	`ETHER_IS_MULTICAST
+(
+addo
+|| !ETHER_IS_MULTICAST(
+addrhi
+)) {
+
+1276 
+	`lx
+(
+s
+);
+
+1277  
+EINVAL
+;
+
+1282 
+	`ETHER_LOOKUP_MULTI
+(
+addo
+, 
+addrhi
+, 
+ec
+, 
+m
+);
+
+1283 i(
+m
+ !
+NULL
+) {
+
+1287 ++
+m
+->
+m_fcou
+;
+
+1288 
+	`lx
+(
+s
+);
+
+1295 
+m
+ = (
+h_mui
+ *)
+	`mloc
+((*m), 
+M_IFMADDR
+, 
+M_NOWAIT
+);
+
+1296 i(
+m
+ =
+NULL
+) {
+
+1297 
+	`lx
+(
+s
+);
+
+1298  
+ENOBUFS
+;
+
+1300 
+	`memy
+(
+m
+->
+m_addo
+, 
+addo
+, 6);
+
+1301 
+	`memy
+(
+m
+->
+m_addrhi
+, 
+addrhi
+, 6);
+
+1302 
+m
+->
+m_fcou
+ = 1;
+
+1303 
+	`LIST_INSERT_HEAD
+(&
+ec
+->
+ec_muddrs
+, 
+m
+, 
+m_li
+);
+
+1304 
+ec
+->
+ec_muit
+++;
+
+1305 
+	`lx
+(
+s
+);
+
+1310  
+ENETRESET
+;
+
+1311 
+	}
+}
+
+1317 
+	$h_dmui
+(c 
+sockaddr
+ *
+
+, 
+hcom
+ *
+ec
+)
+
+1319 
+h_mui
+ *
+m
+;
+
+1320 
+u_ch
+ 
+addo
+[
+ETHER_ADDR_LEN
+];
+
+1321 
+u_ch
+ 
+addrhi
+[
+ETHER_ADDR_LEN
+];
+
+1322 
+s
+ = 
+	`
+(), 
+r
+;
+
+1324 
+r
+ = 
+	`h_muddr
+(
+
+, 
+addo
+, 
+addrhi
+);
+
+1325 i(
+r
+ != 0) {
+
+1326 
+	`lx
+(
+s
+);
+
+1327  (
+r
+);
+
+1333 
+	`ETHER_LOOKUP_MULTI
+(
+addo
+, 
+addrhi
+, 
+ec
+, 
+m
+);
+
+1334 i(
+m
+ =
+NULL
+) {
+
+1335 
+	`lx
+(
+s
+);
+
+1336  (
+ENXIO
+);
+
+1338 i(--
+m
+->
+m_fcou
+ != 0) {
+
+1342 
+	`lx
+(
+s
+);
+
+1348 
+	`LIST_REMOVE
+(
+m
+, 
+m_li
+);
+
+1349 
+	`
+(
+m
+, 
+M_IFMADDR
+);
+
+1350 
+ec
+->
+ec_muit
+--;
+
+1351 
+	`lx
+(
+s
+);
+
+1356  (
+ENETRESET
+);
+
+1357 
+	}
+}
+
+1360 
+	$h_t_ifags_cb
+(
+hcom
+ *
+ec
+, 
+h_cb_t
+ 
+cb
+)
+
+1362 
+ec
+->
+ec_ifags_cb
+ = 
+cb
+;
+
+1363 
+	}
+}
+
+1370 
+	$h_iol
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+1372 
+hcom
+ *
+ec
+ = (*
+i
+;
+
+1373 
+eceq
+ *
+ec
+;
+
+1374 
+ieq
+ *
+i
+ = (ieq *)
+da
+;
+
+1375 
+if_ddeq
+ *
+ir
+ = 
+da
+;
+
+1376 c 
+sockaddr_dl
+ *
+sdl
+;
+
+1377 c 
+ut8_t
+ 
+zo
+[
+ETHER_ADDR_LEN
+];
+
+1378 
+r
+;
+
+1380 
+cmd
+) {
+
+1381 
+SIOCINITIFADDR
+:
+
+1383 
+iddr
+ *
+i
+ = (idd*)
+da
+;
+
+1384 i(
+i
+->
+i_addr
+->
+_my
+ !
+AF_LINK
+
+
+1385 && (
+i
+->
+if_ags
+ & (
+IFF_UP
+|
+IFF_RUNNING
+)) !=
+
+1386 (
+IFF_UP
+|
+IFF_RUNNING
+)) {
+
+1387 
+i
+->
+if_ags
+ |
+IFF_UP
+;
+
+1388 i((
+r
+ = (*
+i
+->
+if_
+)(ifp)) != 0)
+
+1389  
+r
+;
+
+1391 #ifde
+INET
+
+
+1392 i(
+i
+->
+i_addr
+->
+_my
+ =
+AF_INET
+)
+
+1393 
+	`p_if
+(
+i
+, 
+i
+);
+
+1398 
+SIOCSIFMTU
+:
+
+1400 
+maxmtu
+;
+
+1402 i(
+ec
+->
+ec_bs
+ & 
+ETHERCAP_JUMBO_MTU
+)
+
+1403 
+maxmtu
+ = 
+ETHERMTU_JUMBO
+;
+
+1405 
+maxmtu
+ = 
+ETHERMTU
+;
+
+1407 i(
+i
+->
+i_mtu
+ < 
+ETHERMIN
+ || i->i_mtu > 
+maxmtu
+)
+
+1408  
+EINVAL
+;
+
+1409 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)!
+ENETRESET
+)
+
+1410  
+r
+;
+
+1411 i(
+i
+->
+if_ags
+ & 
+IFF_UP
+) {
+
+1413  (*
+i
+->
+if_
+)(ifp);
+
+1418 
+SIOCSIFFLAGS
+:
+
+1419 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)) != 0)
+
+1420  
+r
+;
+
+1421 
+i
+->
+if_ags
+ & (
+IFF_UP
+|
+IFF_RUNNING
+)) {
+
+1422 
+IFF_RUNNING
+:
+
+1427 (*
+i
+->
+if_
+)(ifp, 1);
+
+1429 
+IFF_UP
+:
+
+1434  (*
+i
+->
+if_
+)(ifp);
+
+1435 
+IFF_UP
+|
+IFF_RUNNING
+:
+
+1436 
+r
+ = 0;
+
+1437 i(
+ec
+->
+ec_ifags_cb
+ =
+NULL
+ ||
+
+1438 (
+r
+ = (*
+ec
+->
+ec_ifags_cb
+)c)=
+ENETRESET
+) {
+
+1444  (*
+i
+->
+if_
+)(ifp);
+
+1446  
+r
+;
+
+1451 
+SIOCGETHERCAP
+:
+
+1452 
+ec
+ = (
+eceq
+ *)
+da
+;
+
+1453 
+ec
+->
+ec_bs
+ = 
+ec
+->
+ec_bs
+;
+
+1454 
+ec
+->
+ec_b
+ = 
+ec
+->
+ec_b
+;
+
+1456 
+SIOCADDMULTI
+:
+
+1457  
+	`h_addmui
+(
+	`ieq_gaddr
+(
+cmd
+, 
+i
+), 
+ec
+);
+
+1458 
+SIOCDELMULTI
+:
+
+1459  
+	`h_dmui
+(
+	`ieq_gaddr
+(
+cmd
+, 
+i
+), 
+ec
+);
+
+1460 
+SIOCSIFMEDIA
+:
+
+1461 
+SIOCGIFMEDIA
+:
+
+1462 i(
+ec
+->
+ec_mii
+ =
+NULL
+)
+
+1463  
+ENOTTY
+;
+
+1464  
+	`ifmed_iol
+(
+i
+, 
+i
+, &
+ec
+->
+ec_mii
+->
+mii_med
+, 
+cmd
+);
+
+1465 
+SIOCALIFADDR
+:
+
+1466 
+sdl
+ = 
+	`tocsdl
+(
+	`soc
+(&
+ir
+->
+addr
+));
+
+1467 i(
+sdl
+->
+sdl_my
+ !
+AF_LINK
+)
+
+1469 i(
+	`ETHER_IS_MULTICAST
+(
+	`CLLADDR
+(
+sdl
+)))
+
+1470  
+EINVAL
+;
+
+1471 i(
+	`memcmp
+(
+zo
+, 
+	`CLLADDR
+(
+sdl
+), (zero)) == 0)
+
+1472  
+EINVAL
+;
+
+1475  
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+);
+
+1478 
+	}
+}
+
+1481 
+	$h_mui_sysl
+(
+SYSCTLFN_ARGS
+)
+
+1483 
+h_mui
+ *
+m
+;
+
+1484 
+h_mui_sysl
+ 
+addr
+;
+
+1485 
+i
+ *
+i
+;
+
+1486 
+hcom
+ *
+ec
+;
+
+1487 
+r
+;
+
+1488 
+size_t
+ 
+wrn
+;
+
+1490 i(
+m
+ != 1)
+
+1491  
+EINVAL
+;
+
+1493 
+i
+ = 
+	`if_bydex
+(
+me
+[0]);
+
+1494 i(
+i
+ =
+NULL
+)
+
+1495  
+ENODEV
+;
+
+1496 i(
+i
+->
+if_ty
+ !
+IFT_ETHER
+) {
+
+1497 *
+d
+ = 0;
+
+1500 
+ec
+ = (
+hcom
+ *)
+i
+;
+
+1502 i(
+dp
+ =
+NULL
+) {
+
+1503 *
+d
+ = 
+ec
+->
+ec_muit
+ * (
+addr
+);
+
+1507 
+	`memt
+(&
+addr
+, 0, (addr));
+
+1508 
+r
+ = 0;
+
+1509 
+wrn
+ = 0;
+
+1511 
+	`LIST_FOREACH
+(
+m
+, &
+ec
+->
+ec_muddrs
+, 
+m_li
+) {
+
+1512 i(
+wrn
+ + (
+addr
+> *
+d
+)
+
+1514 
+addr
+.
+m_fcou
+ = 
+m
+->enm_refcount;
+
+1515 
+	`memy
+(
+addr
+.
+m_addo
+, 
+m
+->m_addo, 
+ETHER_ADDR_LEN
+);
+
+1516 
+	`memy
+(
+addr
+.
+m_addrhi
+, 
+m
+->m_addrhi, 
+ETHER_ADDR_LEN
+);
+
+1517 
+r
+ = 
+	`sysl_cyout
+(
+l
+, &
+addr
+, 
+dp
+, (addr));
+
+1518 i(
+r
+)
+
+1520 
+wrn
+ +(
+addr
+);
+
+1521 
+dp
+ = (*)d+ (
+addr
+);
+
+1524 *
+d
+ = 
+wrn
+;
+
+1525  
+r
+;
+
+1526 
+	}
+}
+
+1528 
+SYSCTL_SETUP
+(
+sysl_t_h_tup
+, "sysctlet.ether subtree setup")
+
+1530 c 
+sysode
+ *
+	gode
+ = 
+NULL
+;
+
+1532 
+sysl_v
+(
+og
+, 0, 
+NULL
+, &
+ode
+,
+
+1533 
+CTLFLAG_PERMANENT
+,
+
+1534 
+CTLTYPE_NODE
+, "ether",
+
+1535 
+SYSCTL_DESCR
+("Ethernet-specific information"),
+
+1536 
+NULL
+, 0, NULL, 0,
+
+1537 
+CTL_NET
+, 
+CTL_CREATE
+, 
+CTL_EOL
+);
+
+1539 
+sysl_v
+(
+og
+, 0, &
+ode
+, 
+NULL
+,
+
+1540 
+CTLFLAG_PERMANENT
+,
+
+1541 
+CTLTYPE_NODE
+, "multicast",
+
+1542 
+SYSCTL_DESCR
+("multicastddresses"),
+
+1543 
+h_mui_sysl
+, 0, 
+NULL
+, 0,
+
+1544 
+CTL_CREATE
+, 
+CTL_EOL
+);
+
+1548 
+	$h
+()
+
+1550 
+	`mux_
+(&
+bigpkps_lock
+, 
+MUTEX_DEFAULT
+, 
+IPL_NET
+);
+
+1551 
+	}
+}
+
+	@if_faith.c
+
+42 
+	~<sys/cdefs.h
+>
+
+43 
+__KERNEL_RCSID
+(0, "$NetBSD: if_faith.c,v 1.50 2014/07/29 01:35:44 ozaki-r Exp $");
+
+45 
+	~"t_.h
+"
+
+47 
+	~<sys/m.h
+>
+
+48 
+	~<sys/sym.h
+>
+
+49 
+	~<sys/kl.h
+>
+
+50 
+	~<sys/mbuf.h
+>
+
+51 
+	~<sys/sock.h
+>
+
+52 
+	~<sys/o.h
+>
+
+53 
+	~<sys/iol.h
+>
+
+54 
+	~<sys/time.h
+>
+
+55 
+	~<sys/queue.h
+>
+
+57 
+	~<sys/u.h
+>
+
+59 
+	~<t/if.h
+>
+
+60 
+	~<t/if_tys.h
+>
+
+61 
+	~<t/ti.h
+>
+
+62 
+	~<t/rou.h
+>
+
+63 
+	~<t/bpf.h
+>
+
+64 
+	~<t/if_h.h
+>
+
+66 #ifdef 
+INET
+
+
+67 
+	~<t/.h
+>
+
+68 
+	~<t/_sym.h
+>
+
+69 
+	~<t/_v.h
+>
+
+70 
+	~<t/.h
+>
+
+73 #ifde
+INET6
+
+
+74 #ide
+INET
+
+
+75 
+	~<t/.h
+>
+
+77 
+	~<t6/6_v.h
+>
+
+78 
+	~<t/6.h
+>
+
+79 
+	~<t6/6_v.h
+>
+
+83 
+	~<t/t_osd.h
+>
+
+85 
+hiol
+(
+i
+ *, 
+u_lg
+, *);
+
+86 
+houut
+(
+i
+ *, 
+mbuf
+ *,
+
+87 c 
+sockaddr
+ *, 
+y
+ *);
+
+88 
+hque
+(, 
+y
+ *,
+
+89 c 
+_addrfo
+ *);
+
+91 
+hch
+();
+
+93 
+h_e_
+(
+if_e
+ *, );
+
+94 
+h_e_deroy
+(
+i
+ *);
+
+96 
+if_e
+ 
+	gh_
+ =
+
+97 
+IF_CLONE_INITIALIZER
+("h", 
+h_e_
+, 
+h_e_deroy
+);
+
+99 
+	#FAITHMTU
+ 1500
+
+	)
+
+103 
+	$hch
+(
+cou
+)
+
+106 
+	`if_e_ch
+(&
+h_
+);
+
+107 
+	}
+}
+
+110 
+	$h_e_
+(
+if_e
+ *
+ifc
+, 
+un
+)
+
+112 
+i
+ *
+i
+;
+
+114 
+i
+ = 
+	`if_loc
+(
+IFT_FAITH
+);
+
+116 
+	`if_me
+(
+i
+, 
+ifc
+->
+ifc_me
+, 
+un
+);
+
+118 
+i
+->
+if_mtu
+ = 
+FAITHMTU
+;
+
+120 
+i
+->
+if_ags
+ = 
+IFF_BROADCAST
+ | 
+IFF_MULTICAST
+;
+
+121 
+i
+->
+if_iol
+ = 
+hiol
+;
+
+122 
+i
+->
+if_ouut
+ = 
+houut
+;
+
+123 
+i
+->
+if_ty
+ = 
+IFT_FAITH
+;
+
+124 
+i
+->
+if_hd
+ = 0;
+
+125 
+i
+->
+if_add
+ = 0;
+
+126 
+i
+->
+if_d
+ = 
+DLT_NULL
+;
+
+127 
+	`if_ch
+(
+i
+);
+
+128 
+	`if_loc_dl
+(
+i
+);
+
+129 
+	`bpf_ch
+(
+i
+, 
+DLT_NULL
+, (
+u_t
+));
+
+131 
+	}
+}
+
+134 
+	$h_e_deroy
+(
+i
+ *
+i
+)
+
+137 
+	`bpf_dach
+(
+i
+);
+
+138 
+	`if_dach
+(
+i
+);
+
+139 
+	`if_
+(
+i
+);
+
+142 
+	}
+}
+
+145 
+	$houut
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+, c 
+sockaddr
+ *
+d
+,
+
+146 
+y
+ *
+
+)
+
+148 
+pktqueue_t
+ *
+pktq
+;
+
+149 
+size_t
+ 
+pk
+;
+
+150 
+s
+, 
+r
+;
+
+151 
+ut32_t
+ 
+af
+;
+
+153 i((
+m
+->
+m_ags
+ & 
+M_PKTHDR
+) == 0)
+
+154 
+	`nic
+("faithoutputo HDR");
+
+155 
+af
+ = 
+d
+->
+_my
+;
+
+157 i(
+af
+ =
+AF_UNSPEC
+) {
+
+158 
+af
+ = *(
+	`mtod
+(
+m
+, *));
+
+159 
+	`m_adj
+(
+m
+, ());
+
+162 
+	`bpf_mp_af
+(
+i
+, 
+af
+, 
+m
+);
+
+164 i(
+
+ &&t->
+_ags
+ & (
+RTF_REJECT
+|
+RTF_BLACKHOLE
+)) {
+
+165 
+	`m_m
+(
+m
+);
+
+166  (
+
+->
+_ags
+ & 
+RTF_BLACKHOLE
+ ? 0 :
+
+167 
+
+->
+_ags
+ & 
+RTF_HOST
+ ? 
+EHOSTUNREACH
+ : 
+ENETUNREACH
+);
+
+169 
+pk
+ = 
+m
+->
+m_pkthdr
+.
+n
+;
+
+170 
+i
+->
+if_acks
+++;
+
+171 
+i
+->
+if_obys
+ +
+pk
+;
+
+172 
+af
+) {
+
+173 #ifde
+INET
+
+
+174 
+AF_INET
+:
+
+175 
+pktq
+ = 
+_pktq
+;
+
+178 #ifde
+INET6
+
+
+179 
+AF_INET6
+:
+
+180 
+pktq
+ = 
+6_pktq
+;
+
+184 
+	`m_m
+(
+m
+);
+
+185  
+EAFNOSUPPORT
+;
+
+189 
+	`KASSERT
+(
+pktq
+ !
+NULL
+);
+
+190 
+m
+->
+m_pkthdr
+.
+rcvif
+ = 
+i
+;
+
+192 
+s
+ = 
+	`
+();
+
+193 i(
+	`__edi_ue
+(
+	`pktq_queue
+(
+pktq
+, 
+m
+, 0))) {
+
+194 
+i
+->
+if_acks
+++;
+
+195 
+i
+->
+if_ibys
+ +
+pk
+;
+
+196 
+r
+ = 0;
+
+198 
+	`m_m
+(
+m
+);
+
+199 
+r
+ = 
+ENOBUFS
+;
+
+201 
+	`lx
+(
+s
+);
+
+203  
+r
+;
+
+204 
+	}
+}
+
+208 
+	$hque
+(
+cmd
+, 
+y
+ *
+
+,
+
+209 c 
+_addrfo
+ *
+fo
+)
+
+211 i(
+
+)
+
+212 
+
+->
+_rmx
+.
+rmx_mtu
+ =t->
+_i
+->
+if_mtu
+;
+
+213 
+	}
+}
+
+220 
+	$hiol
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+222 
+iddr
+ *
+i
+;
+
+223 
+ieq
+ *
+i
+ = (ieq *)
+da
+;
+
+224 
+r
+ = 0;
+
+226 
+cmd
+) {
+
+228 
+SIOCINITIFADDR
+:
+
+229 
+i
+->
+if_ags
+ |
+IFF_UP
+ | 
+IFF_RUNNING
+;
+
+230 
+i
+ = (
+iddr
+ *)
+da
+;
+
+231 
+i
+->
+i_que
+ = 
+hque
+;
+
+237 
+SIOCADDMULTI
+:
+
+238 
+SIOCDELMULTI
+:
+
+239 i(
+i
+ == 0) {
+
+240 
+r
+ = 
+EAFNOSUPPORT
+;
+
+243 
+i
+->
+i_addr
+.
+_my
+) {
+
+244 #ifde
+INET
+
+
+245 
+AF_INET
+:
+
+248 #ifde
+INET6
+
+
+249 
+AF_INET6
+:
+
+254 
+r
+ = 
+EAFNOSUPPORT
+;
+
+260 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)=
+ENETRESET
+)
+
+261 
+r
+ = 0;
+
+264  (
+r
+);
+
+265 
+	}
+}
+
+267 #ifde
+INET6
+
+
+273 
+	$hefix
+(
+6_addr
+ *
+6
+)
+
+275 
+y
+ *
+
+;
+
+276 
+sockaddr_6
+ 
+s6
+;
+
+277 
+t
+;
+
+279 i(
+6_kph
+ == 0)
+
+282 
+	`memt
+(&
+s6
+, 0, (sin6));
+
+283 
+s6
+.
+s6_my
+ = 
+AF_INET6
+;
+
+284 
+s6
+.
+s6_n
+ = (
+sockaddr_6
+);
+
+285 
+s6
+.
+s6_addr
+ = *
+6
+;
+
+286 
+
+ = 
+	`loc1
+((
+sockaddr
+ *)&
+s6
+, 0);
+
+287 i(
+
+ &&t->
+_i
+ &&t->_i->
+if_ty
+ =
+IFT_FAITH
+ &&
+
+288 (
+
+->
+_i
+->
+if_ags
+ & 
+IFF_UP
+) != 0)
+
+289 
+t
+ = 1;
+
+291 
+t
+ = 0;
+
+292 i(
+
+)
+
+293 
+	`
+(
+
+);
+
+294  
+t
+;
+
+295 
+	}
+}
+
+	@if_faith.h
+
+33 #ide
+_NET_IF_FAITH_H_
+
+
+34 
+	#_NET_IF_FAITH_H_
+
+
+	)
+
+36 #ifde
+_KERNEL
+
+
+37 
+	g6_addr
+;
+
+38 
+hefix
+(
+6_addr
+ *);
+
+	@if_fddi.h
+
+29 #ide
+_NET_IF_FDDI_H_
+
+
+30 
+	#_NET_IF_FDDI_H_
+
+
+	)
+
+35 
+	sfddi_hd
+ {
+
+36 
+u_ch
+ 
+	mfddi_ph
+[3];
+
+37 
+u_ch
+ 
+	mfddi_fc
+;
+
+38 
+u_ch
+ 
+	mfddi_dho
+[6];
+
+39 
+u_ch
+ 
+	mfddi_sho
+[6];
+
+40 } 
+	g__cked
+;
+
+42 
+	#FDDIIPMTU
+ 4352
+
+	)
+
+43 
+	#FDDIMTU
+ 4470
+
+	)
+
+44 
+	#FDDIMIN
+ 3
+
+	)
+
+46 
+	#FDDIFC_C
+ 0x80
+
+	)
+
+47 
+	#FDDIFC_L
+ 0x40
+
+	)
+
+48 
+	#FDDIFC_F
+ 0x30
+
+	)
+
+49 
+	#FDDIFC_Z
+ 0x0F
+
+	)
+
+54 
+	#FDDIFC_VOID
+ 0x40
+
+	)
+
+55 
+	#FDDIFC_NRT
+ 0x80
+
+	)
+
+56 
+	#FDDIFC_RT
+ 0xc0
+
+	)
+
+57 
+	#FDDIFC_MAC_BEACON
+ 0xc2
+
+	)
+
+58 
+	#FDDIFC_MAC_CLAIM
+ 0xc3
+
+	)
+
+59 
+	#FDDIFC_LLC_ASYNC
+ 0x50
+
+	)
+
+60 
+	#FDDIFC_LLC_PRIO0
+ 0
+
+	)
+
+61 
+	#FDDIFC_LLC_PRIO1
+ 1
+
+	)
+
+62 
+	#FDDIFC_LLC_PRIO2
+ 2
+
+	)
+
+63 
+	#FDDIFC_LLC_PRIO3
+ 3
+
+	)
+
+64 
+	#FDDIFC_LLC_PRIO4
+ 4
+
+	)
+
+65 
+	#FDDIFC_LLC_PRIO5
+ 5
+
+	)
+
+66 
+	#FDDIFC_LLC_PRIO6
+ 6
+
+	)
+
+67 
+	#FDDIFC_LLC_PRIO7
+ 7
+
+	)
+
+68 
+	#FDDIFC_LLC_SYNC
+ 0xd0
+
+	)
+
+69 
+	#FDDIFC_IMP_ASYNC
+ 0x60
+
+	)
+
+70 
+	#FDDIFC_IMP_SYNC
+ 0xe0
+
+	)
+
+71 
+	#FDDIFC_SMT
+ 0x40
+
+	)
+
+72 
+	#FDDIFC_SMT_INFO
+ 0x41
+
+	)
+
+73 
+	#FDDIFC_SMT_NSA
+ 0x4F
+
+	)
+
+74 
+	#FDDIFC_MAC
+ 0xc0
+
+	)
+
+76 
+	#FDDIFC_CLFF
+ 0xF0
+
+	)
+
+77 
+	#FDDIFC_ZZZZ
+ 0x0F
+
+	)
+
+79 #i
+defed
+(
+KERNEL
+|| defed(
+_KERNEL
+)
+
+80 #i
+defed
+(
+__NBSD__
+)
+
+81 
+	~<t/if_h.h
+>
+
+83 
+	#fddibrdaddr
+ 
+hbrdaddr
+
+
+	)
+
+84 
+	#fddi_mui_m
+ 
+h_mui_m
+
+
+	)
+
+85 
+	#fddi_mui_max
+ 
+h_mui_max
+
+
+	)
+
+86 
+	#fddi_rtf
+ 
+h_rtf
+
+
+	)
+
+88 #i
+defed
+(
+__NBSD__
+)
+
+89 
+fddi_iach
+(
+i
+ *, *);
+
+91 
+fddi_iach
+(
+i
+ *);
+
+	@if_fddisubr.c
+
+98 
+	~<sys/cdefs.h
+>
+
+99 
+__KERNEL_RCSID
+(0, "$NetBSD: if_fddisubr.c,v 1.89 2015/05/20 09:17:18 ozaki-r Exp $");
+
+101 
+	~"t_geway.h
+"
+
+102 
+	~"t_.h
+"
+
+103 
+	~"t_k.h
+"
+
+104 
+	~"t_x.h
+"
+
+105 
+	~"t_mbu.h
+"
+
+108 
+	~<sys/m.h
+>
+
+109 
+	~<sys/sym.h
+>
+
+110 
+	~<sys/kl.h
+>
+
+111 
+	~<sys/mloc.h
+>
+
+112 
+	~<sys/mbuf.h
+>
+
+113 
+	~<sys/osw.h
+>
+
+114 
+	~<sys/sock.h
+>
+
+115 
+	~<sys/iol.h
+>
+
+116 
+	~<sys/o.h
+>
+
+117 
+	~<sys/syog.h
+>
+
+119 
+	~<sys/u.h
+>
+
+121 
+	~<t/if.h
+>
+
+122 
+	~<t/ti.h
+>
+
+123 
+	~<t/rou.h
+>
+
+124 
+	~<t/if_c.h
+>
+
+125 
+	~<t/if_dl.h
+>
+
+126 
+	~<t/if_tys.h
+>
+
+128 
+	~<t/bpf.h
+>
+
+130 #ifde
+INET
+
+
+131 
+	~<t/.h
+>
+
+132 
+	~<t/_v.h
+>
+
+133 
+	~<t/if_p.h
+>
+
+134 
+	~"t_geway.h
+"
+
+136 
+	~<t/if_fddi.h
+>
+
+138 #ifde
+IPX
+
+
+139 
+	~<tx/x.h
+>
+
+140 
+	~<tx/x_if.h
+>
+
+143 #ifde
+INET6
+
+
+144 #ide
+INET
+
+
+145 
+	~<t/.h
+>
+
+146 
+	~<t/_v.h
+>
+
+148 
+	~<t6/nd6.h
+>
+
+152 
+	~".h
+"
+
+153 #i
+NCARP
+ > 0
+
+154 
+	~<t/_.h
+>
+
+157 #ifde
+DECNET
+
+
+158 
+	~<tdt/dn.h
+>
+
+161 #ifde
+NETATALK
+
+
+162 
+	~<lk/.h
+>
+
+163 
+	~<lk/_v.h
+>
+
+164 
+	~<lk/_ex.h
+>
+
+166 
+	#c__g_code
+ 
+c_un
+.
+ty_
+.
+g_code
+
+
+	)
+
+167 
+	#c__h_ty
+ 
+c_un
+.
+ty_
+.
+h_ty
+
+
+	)
+
+169 
+u_ch
+ 
+_g_code
+[ 3 ];
+
+170 
+u_ch
+ 
+_g_code
+[ 3 ];
+
+175 
+	#ndr
+(
+e
+{ 
+r
+ = (e); 
+bad
+;}
+
+	)
+
+180 #ide
+c_
+
+
+181 
+	#c_
+ 
+c_un
+.
+ty_
+
+
+	)
+
+184 
+	#FDDIADDR
+(
+i
+
+	`LLADDR
+((i)->
+if_dl
+)
+
+	)
+
+185 
+	#CFDDIADDR
+(
+i
+
+	`CLLADDR
+((i)->
+if_dl
+)
+
+	)
+
+187 
+fddi_ouut
+(
+i
+ *, 
+mbuf
+ *,
+
+188 c 
+sockaddr
+ *, 
+y
+ *);
+
+189 
+fddi_put
+(
+i
+ *, 
+mbuf
+ *);
+
+197 
+	$fddi_ouut
+(
+i
+ *
+i0
+, 
+mbuf
+ *
+m0
+, c 
+sockaddr
+ *
+d
+,
+
+198 
+y
+ *
+0
+)
+
+200 
+ut16_t
+ 
+y
+;
+
+201 
+r
+ = 0, 
+hdrcmt
+ = 0;
+
+202 
+ut8_t
+ 
+ec
+[6], 
+ed
+[6];
+
+203 
+mbuf
+ *
+m
+ = 
+m0
+;
+
+204 
+y
+ *
+
+;
+
+205 
+fddi_hd
+ *
+fh
+;
+
+206 
+mbuf
+ *
+mcy
+ = 
+NULL
+;
+
+207 
+i
+ *
+i
+ = 
+i0
+;
+
+208 
+	`ALTQ_DECL
+(
+tq_pkr
+ 
+pkr
+;)
+
+210 
+	`MCLAIM
+(
+m
+, 
+i
+->
+if_mowr
+);
+
+212 #i
+NCARP
+ > 0
+
+213 i(
+i
+->
+if_ty
+ =
+IFT_CARP
+) {
+
+214 
+iddr
+ *
+i
+;
+
+217 i(
+d
+ !
+NULL
+ && 
+i0
+->
+if_lk_e
+ =
+LINK_STATE_UP
+ &&
+
+218 (
+i
+ = 
+	`i_ifwhaddr
+(
+d
+)!
+NULL
+ &&
+
+219 
+i
+->
+i_i
+ =
+i0
+)
+
+220  (
+	`loouut
+(
+i0
+, 
+m
+, 
+d
+, 
+0
+));
+
+222 
+i
+ = i->
+if_dev
+;
+
+225 i((
+i0
+->
+if_ags
+ & (
+IFF_UP
+|
+IFF_RUNNING
+)) !=
+
+226 (
+IFF_UP
+|
+IFF_RUNNING
+))
+
+227 
+	`ndr
+(
+ENETDOWN
+);
+
+230 i((
+i
+->
+if_ags
+ & (
+IFF_UP
+|
+IFF_RUNNING
+)) != (IFF_UP|IFF_RUNNING))
+
+231 
+	`ndr
+(
+ENETDOWN
+);
+
+232 #i!
+	`defed
+(
+__bsdi__
+|| 
+_BSDI_VERSION
+ >= 199401
+
+233 i((
+
+ = 
+0
+!
+NULL
+) {
+
+234 i((
+
+->
+_ags
+ & 
+RTF_UP
+) == 0) {
+
+235 i((
+0
+ = 
+
+ = 
+	`loc1
+(
+d
+, 1)!
+NULL
+)
+
+236 
+
+->
+_ft
+--;
+
+238 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+240 i(
+
+->
+_ags
+ & 
+RTF_GATEWAY
+) {
+
+241 i(
+
+->
+_gwrou
+ == 0)
+
+242 
+lookup
+;
+
+243 i(((
+
+ =t->
+_gwrou
+)->
+_ags
+ & 
+RTF_UP
+) == 0) {
+
+244 
+	`
+(
+
+);
+0
+;
+
+245 
+lookup
+: 
+
+->
+_gwrou
+ = 
+	`loc1
+t->
+_geway
+, 1);
+
+246 i((
+
+ =t->
+_gwrou
+) == 0)
+
+247 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+250 i(
+
+->
+_ags
+ & 
+RTF_REJECT
+)
+
+251 i(
+
+->
+_rmx
+.
+rmx_expe
+ == 0 ||
+
+252 
+time_cd
+ < 
+
+->
+_rmx
+.
+rmx_expe
+)
+
+253 
+	`ndr
+(
+
+ =
+0
+ ? 
+EHOSTDOWN
+ : 
+EHOSTUNREACH
+);
+
+261 
+	`IFQ_CLASSIFY
+(&
+i
+->
+if_d
+, 
+m
+, 
+d
+->
+_my
+, &
+pkr
+);
+
+263 
+d
+->
+_my
+) {
+
+265 #ifde
+INET
+
+
+266 
+AF_INET
+: {
+
+267 i(
+m
+->
+m_ags
+ & 
+M_BCAST
+)
+
+268 
+	`memy
+(
+ed
+, 
+fddibrdaddr
+, (edst));
+
+269 i(
+m
+->
+m_ags
+ & 
+M_MCAST
+) {
+
+270 
+	`ETHER_MAP_IP_MULTICAST
+(&
+	`tocs
+(
+d
+)->
+s_addr
+,
+
+271 (*)
+ed
+);
+
+272 } i(!
+	`esve
+(
+i
+, 
+
+, 
+m
+, 
+d
+, 
+ed
+))
+
+275 i((
+m
+->
+m_ags
+ & 
+M_BCAST
+&& (
+i
+->
+if_ags
+ & 
+IFF_SIMPLEX
+))
+
+276 
+mcy
+ = 
+	`m_cy
+(
+m
+, 0, ()
+M_COPYALL
+);
+
+277 
+y
+ = 
+	`hts
+(
+ETHERTYPE_IP
+);
+
+281 #ifde
+INET6
+
+
+282 
+AF_INET6
+:
+
+283 i(!
+	`nd6_ddr
+(
+i
+, 
+
+, 
+m
+, 
+d
+, 
+ed
+, (edst))){
+
+287 
+y
+ = 
+	`hts
+(
+ETHERTYPE_IPV6
+);
+
+290 #ifde
+AF_ARP
+
+
+291 
+AF_ARP
+: {
+
+292 
+phdr
+ *
+ah
+ = 
+	`mtod
+(
+m
+, arphdr *);
+
+293 i(
+m
+->
+m_ags
+ & 
+M_BCAST
+)
+
+294 
+	`memy
+(
+ed
+, 
+hbrdaddr
+, (edst));
+
+296 *
+tha
+ = 
+	`_tha
+(
+ah
+);
+
+297 i(
+tha
+ =
+NULL
+)
+
+299 
+	`memy
+(
+ed
+, 
+tha
+, (edst));
+
+302 
+ah
+->
+_hrd
+ = 
+	`hts
+(
+ARPHRD_ETHER
+);
+
+304 
+	`ohs
+(
+ah
+->
+_
+)) {
+
+305 
+ARPOP_REVREQUEST
+:
+
+306 
+ARPOP_REVREPLY
+:
+
+307 
+y
+ = 
+	`hts
+(
+ETHERTYPE_REVARP
+);
+
+310 
+ARPOP_REQUEST
+:
+
+311 
+ARPOP_REPLY
+:
+
+313 
+y
+ = 
+	`hts
+(
+ETHERTYPE_ARP
+);
+
+319 #ifde
+IPX
+
+
+320 
+AF_IPX
+:
+
+321 
+y
+ = 
+	`hts
+(
+ETHERTYPE_IPX
+);
+
+322 
+	`memy
+(
+ed
+, &(((
+sockaddr_x
+ *)
+d
+)->
+sx_addr
+.
+x_ho
+),
+
+323  (
+ed
+));
+
+325 i((
+m
+->
+m_ags
+ & 
+M_BCAST
+&& (
+i
+->
+if_ags
+ & 
+IFF_SIMPLEX
+))
+
+326 
+mcy
+ = 
+	`m_cy
+(
+m
+, 0, ()
+M_COPYALL
+);
+
+329 #ifde
+NETATALK
+
+
+330 
+AF_APPLETALK
+: {
+
+331 
+_iddr
+ *
+
+;
+
+332 i(!
+	`sve
+(
+i
+, 
+m
+, (c 
+sockaddr_
+ *)
+d
+, 
+ed
+)) {
+
+333 #ifde
+NETATALKDEBUG
+
+
+334 
+	`tf
+("aarpresolv: failed\n");
+
+341 i((
+
+ = (
+_iddr
+ *)
+	`_iwht
+(
+
+342 (c 
+sockaddr_
+ *)
+d
+, 
+i
+)=
+NULL
+)
+
+343 
+bad
+;
+
+351 i(
+
+->
+_ags
+ & 
+AFA_PHASE2
+) {
+
+352 
+c
+lc;
+
+354 
+	`M_PREPEND
+(
+m
+, (
+c
+), 
+M_NOWAIT
+);
+
+355 i(
+m
+ == 0)
+
+356 
+	`ndr
+(
+ENOBUFS
+);
+
+357 
+c
+.
+c_dp
+ =lc.
+c_sp
+ = 
+LLC_SNAP_LSAP
+;
+
+358 
+c
+.
+c_c
+ = 
+LLC_UI
+;
+
+359 
+	`memy
+(
+c
+.
+c__g_code
+, 
+_g_code
+,
+
+360 (
+_g_code
+));
+
+361 
+c
+.
+c__h_ty
+ = 
+	`hts
+(
+ETHERTYPE_ATALK
+);
+
+362 
+	`memy
+(
+	`mtod
+(
+m
+, *), &
+c
+, (llc));
+
+363 
+y
+ = 0;
+
+365 
+y
+ = 
+	`hts
+(
+ETHERTYPE_ATALK
+);
+
+371 
+pudo_AF_HDRCMPLT
+:
+
+373 c 
+fddi_hd
+ *
+fh1
+ =
+
+374 (c 
+fddi_hd
+ *)
+d
+->
+_da
+;
+
+375 
+hdrcmt
+ = 1;
+
+376 
+	`memy
+(
+ec
+, 
+fh1
+->
+fddi_sho
+,  (esrc));
+
+380 
+AF_LINK
+:
+
+382 c 
+fddi_hd
+ *
+fh1
+ =
+
+383 (c 
+fddi_hd
+ *)
+d
+->
+_da
+;
+
+384 
+	`memy
+(
+ed
+, 
+fh1
+->
+fddi_dho
+,  (edst));
+
+385 i(*
+ed
+ & 1)
+
+386 
+m
+->
+m_ags
+ |(
+M_BCAST
+|
+M_MCAST
+);
+
+387 
+y
+ = 0;
+
+391 
+AF_UNSPEC
+:
+
+393 c 
+h_hd
+ *
+eh
+;
+
+394 
+eh
+ = (c 
+h_hd
+ *)
+d
+->
+_da
+;
+
+395 
+	`memy
+(
+ed
+, 
+eh
+->
+h_dho
+, (edst));
+
+396 i(*
+ed
+ & 1)
+
+397 
+m
+->
+m_ags
+ |(
+M_BCAST
+|
+M_MCAST
+);
+
+398 
+y
+ = 
+eh
+->
+h_ty
+;
+
+403 
+	`tf
+("%s: c'hdf%d\n", 
+i
+->
+if_xme
+,
+
+404 
+d
+->
+_my
+);
+
+405 
+	`ndr
+(
+EAFNOSUPPORT
+);
+
+409 i(
+mcy
+)
+
+410 (
+	`loouut
+(
+i
+, 
+mcy
+, 
+d
+, 
+
+);
+
+411 i(
+y
+ != 0) {
+
+412 
+c
+ *
+l
+;
+
+413 
+	`M_PREPEND
+(
+m
+,  (
+c
+), 
+M_DONTWAIT
+);
+
+414 i(
+m
+ == 0)
+
+415 
+	`ndr
+(
+ENOBUFS
+);
+
+416 
+l
+ = 
+	`mtod
+(
+m
+, 
+c
+ *);
+
+417 
+l
+->
+c_c
+ = 
+LLC_UI
+;
+
+418 
+l
+->
+c_dp
+ =->
+c_sp
+ = 
+LLC_SNAP_LSAP
+;
+
+419 
+l
+->
+c_
+.
+g_code
+[0] =->llc_snap.org_code[1] =->llc_snap.org_code[2] = 0;
+
+420 
+	`memy
+(&
+l
+->
+c_
+.
+h_ty
+, &
+y
+, (
+ut16_t
+));
+
+426 
+	`M_PREPEND
+(
+m
+,  (
+fddi_hd
+), 
+M_DONTWAIT
+);
+
+427 i(
+m
+ == 0)
+
+428 
+	`ndr
+(
+ENOBUFS
+);
+
+429 
+fh
+ = 
+	`mtod
+(
+m
+, 
+fddi_hd
+ *);
+
+430 
+fh
+->
+fddi_fc
+ = 
+FDDIFC_LLC_ASYNC
+|
+FDDIFC_LLC_PRIO4
+;
+
+431 
+	`memy
+(
+fh
+->
+fddi_dho
+, 
+ed
+,  (edst));
+
+432 i(
+hdrcmt
+)
+
+433 
+	`memy
+(
+fh
+->
+fddi_sho
+, 
+ec
+, (fh->fddi_shost));
+
+435 
+	`memy
+(
+fh
+->
+fddi_sho
+, 
+	`CFDDIADDR
+(
+i
+), (fh->fddi_shost));
+
+437 #i
+NCARP
+ > 0
+
+438 i(
+i0
+ !
+i
+ && i0->
+if_ty
+ =
+IFT_CARP
+) {
+
+439 
+	`if_t_dl
+(
+i0
+, 
+fh
+->
+fddi_sho
+, (fh->fddi_shost),
+
+440 
+l
+);
+
+443 i(
+i
+ !
+i0
+)
+
+444 
+i0
+->
+if_obys
+ +
+m
+->
+m_pkthdr
+.
+n
+;
+
+446  
+	`ifq_queue
+(
+i
+, 
+m
+ 
+ALTQ_COMMA
+ 
+	`ALTQ_DECL
+(&
+pkr
+));
+
+448 
+bad
+:
+
+449 i(
+m
+)
+
+450 
+	`m_m
+(
+m
+);
+
+451  (
+r
+);
+
+452 
+	}
+}
+
+460 
+	$fddi_put
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+)
+
+462 #i
+	`defed
+(
+INET
+|| defed(
+INET6
+)
+
+463 
+pktqueue_t
+ *
+pktq
+ = 
+NULL
+;
+
+465 #i
+	`defed
+(
+DECNET
+|| defed(
+IPX
+|| defed(
+NETATALK
+)
+
+466 
+ifqueue
+ *
+q
+ = 
+NULL
+;
+
+467 
+i
+ = 0;
+
+468 
+s
+;
+
+471 
+c
+ *
+l
+;
+
+472 
+fddi_hd
+ *
+fh
+;
+
+474 
+	`MCLAIM
+(
+m
+, &((
+hcom
+ *)
+i
+)->
+ec_rx_mowr
+);
+
+475 i((
+i
+->
+if_ags
+ & 
+IFF_UP
+) == 0) {
+
+476 
+	`m_m
+(
+m
+);
+
+480 
+fh
+ = 
+	`mtod
+(
+m
+, 
+fddi_hd
+ *);
+
+482 
+i
+->
+if_ibys
+ +
+m
+->
+m_pkthdr
+.
+n
+;
+
+483 i(
+fh
+->
+fddi_dho
+[0] & 1) {
+
+484 i(
+	`memcmp
+(
+fddibrdaddr
+, 
+fh
+->
+fddi_dho
+,
+
+485 (
+fddibrdaddr
+)) == 0)
+
+486 
+m
+->
+m_ags
+ |
+M_BCAST
+;
+
+488 
+m
+->
+m_ags
+ |
+M_MCAST
+;
+
+489 
+i
+->
+if_ims
+++;
+
+490 } i((
+i
+->
+if_ags
+ & 
+IFF_PROMISC
+)
+
+491 && 
+	`memcmp
+(
+	`CFDDIADDR
+(
+i
+), (*)
+fh
+->
+fddi_dho
+,
+
+492 (
+fh
+->
+fddi_dho
+)) != 0) {
+
+493 
+	`m_m
+(
+m
+);
+
+497 #ifde
+M_LINK0
+
+
+503 i((
+fh
+->
+fddi_fc
+ & 
+FDDIFC_LLC_PRIO7
+=
+FDDIFC_LLC_PRIO0
+)
+
+504 
+m
+->
+m_ags
+ |
+M_LINK0
+;
+
+507 
+l
+ = (
+c
+ *)(
+fh
++1);
+
+508 
+l
+->
+c_dp
+) {
+
+509 #i
+	`defed
+(
+INET
+|| defed(
+INET6
+|| defed(
+DECNET
+|| defed(
+IPX
+|| defed(
+NETATALK
+)
+
+510 
+LLC_SNAP_LSAP
+:
+
+512 
+ut16_t
+ 
+y
+;
+
+513 i(
+l
+->
+c_c
+ !
+LLC_UI
+ ||->
+c_sp
+ !
+LLC_SNAP_LSAP
+)
+
+514 
+dryway
+;
+
+517 
+	`m_adj
+(
+m
+, (
+fddi_hd
+));
+
+519 #ifde
+NETATALK
+
+
+520 i(
+	`memcmp
+(&(
+l
+->
+c__g_code
+)[0], 
+_g_code
+,
+
+521 (
+_g_code
+)) == 0 &&
+
+522 
+	`ohs
+(
+l
+->
+c__h_ty
+=
+ETHERTYPE_ATALK
+) {
+
+523 
+q
+ = &
+q2
+;
+
+524 
+	`m_adj
+
+m
+, 
+c
+ ));
+
+525 
+i
+ = 
+NETISR_ATALK
+;
+
+529 i(
+	`memcmp
+(&(
+l
+->
+c__g_code
+)[0], 
+_g_code
+,
+
+530 (
+_g_code
+)) == 0 &&
+
+531 
+	`ohs
+(
+l
+->
+c__h_ty
+=
+ETHERTYPE_AARP
+) {
+
+532 
+	`m_adj
+
+m
+, 
+c
+ ));
+
+533 
+	`put
+(
+i
+, 
+m
+);
+
+537 i(
+l
+->
+c_
+.
+g_code
+[0] != 0 ||->llc_snap.org_code[1] != 0||->llc_snap.org_code[2] != 0)
+
+538 
+dryway
+;
+
+539 
+y
+ = 
+	`ohs
+(
+l
+->
+c_
+.
+h_ty
+);
+
+540 
+	`m_adj
+(
+m
+, 8);
+
+541 #i
+NCARP
+ > 0
+
+542 i(
+i
+->
+if_
+ && i->
+if_ty
+ !
+IFT_CARP
+ &&
+
+543 (
+	`_put
+(
+m
+, (
+ut8_t
+ *)&
+fh
+->
+fddi_sho
+,
+
+544 (
+ut8_t
+ *)&
+fh
+->
+fddi_dho
+, 
+l
+->
+c_
+.
+h_ty
+) == 0))
+
+548 
+y
+) {
+
+549 #ifde
+INET
+
+
+550 
+ETHERTYPE_IP
+:
+
+551 #ifde
+GATEWAY
+
+
+552 i(
+	`ow_fwd
+(
+m
+))
+
+555 
+pktq
+ = 
+_pktq
+;
+
+558 
+ETHERTYPE_ARP
+:
+
+559 #i!
+	`defed
+(
+__bsdi__
+|| 
+_BSDI_VERSION
+ >= 199401
+
+560 #i
+	`defed
+(
+DECNET
+|| defed(
+IPX
+|| defed(
+NETATALK
+)
+
+561 
+i
+ = 
+NETISR_ARP
+;
+
+562 
+q
+ = &
+pq
+;
+
+566 
+	`pput
+(
+i
+, 
+m
+);
+
+570 #ifde
+IPX
+
+
+571 
+ETHERTYPE_IPX
+:
+
+572 
+i
+ = 
+NETISR_IPX
+;
+
+573 
+q
+ = &
+xq
+;
+
+576 #ifde
+INET6
+
+
+577 
+ETHERTYPE_IPV6
+:
+
+578 #ifde
+GATEWAY
+
+
+579 i(
+	`6ow_fwd
+(&
+m
+))
+
+582 
+pktq
+ = 
+6_pktq
+;
+
+586 #ifde
+DECNET
+
+
+587 
+ETHERTYPE_DECNET
+:
+
+588 
+i
+ = 
+NETISR_DECNET
+;
+
+589 
+q
+ = &
+deq
+;
+
+592 #ifde
+NETATALK
+
+
+593 
+ETHERTYPE_ATALK
+:
+
+594 
+i
+ = 
+NETISR_ATALK
+;
+
+595 
+q
+ = &
+q1
+;
+
+597 
+ETHERTYPE_AARP
+:
+
+599 
+	`put
+(
+i
+, 
+m
+);
+
+603 
+i
+->
+if_nro
+++;
+
+604 
+dryway
+;
+
+611 
+i
+->
+if_nro
+++;
+
+612 #i
+	`defed
+(
+INET
+|| defed(
+INET6
+|| defed(
+DECNET
+|| defed(
+IPX
+|| defed(
+NETATALK
+)
+
+613 
+dryway
+:
+
+615 
+	`m_m
+(
+m
+);
+
+619 #i
+	`defed
+(
+INET
+|| defed(
+INET6
+)
+
+620 i(
+	`__edi_ue
+(
+pktq
+)) {
+
+621 i(
+	`__edi_l
+(!
+	`pktq_queue
+(
+pktq
+, 
+m
+, 0))) {
+
+622 
+	`m_m
+(
+m
+);
+
+627 #i
+	`defed
+(
+DECNET
+|| defed(
+IPX
+|| defed(
+NETATALK
+)
+
+628 i(!
+q
+) {
+
+629 
+	`m_m
+(
+m
+);
+
+631 
+s
+ = 
+	`
+();
+
+632 i(
+	`IF_QFULL
+(
+q
+)) {
+
+633 
+	`IF_DROP
+(
+q
+);
+
+634 
+	`m_m
+(
+m
+);
+
+636 
+	`IF_ENQUEUE
+(
+q
+, 
+m
+);
+
+637 
+	`schedti
+(
+i
+);
+
+639 
+	`lx
+(
+s
+);
+
+641 
+	}
+}
+
+647 
+	$fddi_iach
+(
+i
+ *
+i
+, *
+a
+)
+
+649 
+hcom
+ *
+ec
+ = (hcom *)
+i
+;
+
+651 
+i
+->
+if_ty
+ = 
+IFT_FDDI
+;
+
+652 
+i
+->
+if_hd
+ = 21;
+
+653 
+i
+->
+if_d
+ = 
+DLT_FDDI
+;
+
+654 
+i
+->
+if_mtu
+ = 
+FDDIMTU
+;
+
+655 
+i
+->
+if_ouut
+ = 
+fddi_ouut
+;
+
+656 
+i
+->
+if_put
+ = 
+fddi_put
+;
+
+657 
+i
+->
+if_baud
+ = 
+	`IF_Mbps
+(100);
+
+658 #ifde
+IFF_NOTRAILERS
+
+
+659 
+i
+->
+if_ags
+ |
+IFF_NOTRAILERS
+;
+
+665 i(
+	`ALIGN
+(
+i
+->
+if_hd
+> 
+max_lkhdr
+)
+
+666 
+max_lkhdr
+ = 
+	`ALIGN
+(
+i
+->
+if_hd
+);
+
+668 
+	`LIST_INIT
+(&
+ec
+->
+ec_muddrs
+);
+
+669 
+	`if_t_dl
+(
+i
+, 
+a
+, 6, 
+ue
+);
+
+671 
+i
+->
+if_brdaddr
+ = 
+fddibrdaddr
+;
+
+672 
+	`bpf_ch
+(
+i
+, 
+DLT_FDDI
+, (
+fddi_hd
+));
+
+673 #ifde
+MBUFTRACE
+
+
+674 
+	`y
+(
+ec
+->
+ec_tx_mowr
+.
+mo_me
+, 
+i
+->
+if_xme
+,
+
+675 (
+ec
+->
+ec_tx_mowr
+.
+mo_me
+));
+
+676 
+	`y
+(
+ec
+->
+ec_tx_mowr
+.
+mo_des
+, "tx",
+
+677 (
+ec
+->
+ec_tx_mowr
+.
+mo_des
+));
+
+678 
+	`y
+(
+ec
+->
+ec_rx_mowr
+.
+mo_me
+, 
+i
+->
+if_xme
+,
+
+679 (
+ec
+->
+ec_rx_mowr
+.
+mo_me
+));
+
+680 
+	`y
+(
+ec
+->
+ec_rx_mowr
+.
+mo_des
+, "rx",
+
+681 (
+ec
+->
+ec_rx_mowr
+.
+mo_des
+));
+
+682 
+	`MOWNER_ATTACH
+(&
+ec
+->
+ec_tx_mowr
+);
+
+683 
+	`MOWNER_ATTACH
+(&
+ec
+->
+ec_rx_mowr
+);
+
+684 
+i
+->
+if_mowr
+ = &
+ec
+->
+ec_tx_mowr
+;
+
+686 
+	}
+}
+
+	@if_gif.c
+
+33 
+	~<sys/cdefs.h
+>
+
+34 
+__KERNEL_RCSID
+(0, "$NetBSD: if_gif.c,v 1.84 2015/04/20 10:19:54oy Exp $");
+
+36 
+	~"t_.h
+"
+
+38 
+	~<sys/m.h
+>
+
+39 
+	~<sys/sym.h
+>
+
+40 
+	~<sys/kl.h
+>
+
+41 
+	~<sys/mbuf.h
+>
+
+42 
+	~<sys/sock.h
+>
+
+43 
+	~<sys/sockio.h
+>
+
+44 
+	~<sys/o.h
+>
+
+45 
+	~<sys/iol.h
+>
+
+46 
+	~<sys/time.h
+>
+
+47 
+	~<sys/syog.h
+>
+
+48 
+	~<sys/oc.h
+>
+
+49 
+	~<sys/osw.h
+>
+
+50 
+	~<sys/u.h
+>
+
+51 
+	~<sys/.h
+>
+
+53 
+	~<t/if.h
+>
+
+54 
+	~<t/if_tys.h
+>
+
+55 
+	~<t/ti.h
+>
+
+56 
+	~<t/rou.h
+>
+
+57 
+	~<t/bpf.h
+>
+
+59 
+	~<t/.h
+>
+
+60 
+	~<t/_sym.h
+>
+
+61 
+	~<t/.h
+>
+
+62 #ifdef 
+INET
+
+
+63 
+	~<t/_v.h
+>
+
+65 
+	~<t/_gif.h
+>
+
+67 #ifde
+INET6
+
+
+68 #ide
+INET
+
+
+69 
+	~<t/.h
+>
+
+71 
+	~<t6/6_v.h
+>
+
+72 
+	~<t/6.h
+>
+
+73 
+	~<t6/6_v.h
+>
+
+74 
+	~<t6/6_gif.h
+>
+
+75 
+	~<t6/6osw.h
+>
+
+78 
+	~<t/_p.h
+>
+
+79 
+	~<t/if_gif.h
+>
+
+82 
+	~<t/t_osd.h
+>
+
+84 
+giach
+();
+
+85 
+gif
+(*);
+
+90 
+	$LIST_HEAD
+(, 
+gif_soc
+
+gif_soc_li
+;
+
+92 
+	`gif_e_
+(
+if_e
+ *, );
+
+93 
+	`gif_e_deroy
+(
+i
+ *);
+
+95 
+if_e
+ 
+gif_
+ =
+
+96 
+	`IF_CLONE_INITIALIZER
+("gif", 
+gif_e_
+, 
+gif_e_deroy
+);
+
+98 #ide
+MAX_GIF_NEST
+
+
+107 
+	#MAX_GIF_NEST
+ 1
+
+	)
+
+109 
+max_gif_g
+ = 
+MAX_GIF_NEST
+;
+
+113 
+	$giach
+(
+cou
+)
+
+116 
+	`LIST_INIT
+(&
+gif_soc_li
+);
+
+117 
+	`if_e_ch
+(&
+gif_
+);
+
+118 
+	}
+}
+
+121 
+	$gif_e_
+(
+if_e
+ *
+ifc
+, 
+un
+)
+
+123 
+gif_soc
+ *
+sc
+;
+
+125 
+sc
+ = 
+	`mloc
+((
+gif_soc
+), 
+M_DEVBUF
+, 
+M_WAITOK
+|
+M_ZERO
+);
+
+127 
+	`if_me
+(&
+sc
+->
+gif_if
+, 
+ifc
+->
+ifc_me
+, 
+un
+);
+
+129 
+	`giach0
+(
+sc
+);
+
+131 
+	`LIST_INSERT_HEAD
+(&
+gif_soc_li
+, 
+sc
+, 
+gif_li
+);
+
+133 
+	}
+}
+
+136 
+	$giach0
+(
+gif_soc
+ *
+sc
+)
+
+139 
+sc
+->
+p_cook4
+ = sc->
+p_cook6
+ = 
+NULL
+;
+
+141 
+sc
+->
+gif_if
+.
+if_add
+ = 0;
+
+142 
+sc
+->
+gif_if
+.
+if_mtu
+ = 
+GIF_MTU
+;
+
+143 
+sc
+->
+gif_if
+.
+if_ags
+ = 
+IFF_POINTOPOINT
+ | 
+IFF_MULTICAST
+;
+
+144 
+sc
+->
+gif_if
+.
+if_iol
+ = 
+gif_iol
+;
+
+145 
+sc
+->
+gif_if
+.
+if_ouut
+ = 
+gif_ouut
+;
+
+146 
+sc
+->
+gif_if
+.
+if_ty
+ = 
+IFT_GIF
+;
+
+147 
+sc
+->
+gif_if
+.
+if_d
+ = 
+DLT_NULL
+;
+
+148 
+sc
+->
+gif_if
+.
+if_soc
+ = sc;
+
+149 
+	`IFQ_SET_READY
+(&
+sc
+->
+gif_if
+.
+if_d
+);
+
+150 
+	`if_ch
+(&
+sc
+->
+gif_if
+);
+
+151 
+	`if_loc_dl
+(&
+sc
+->
+gif_if
+);
+
+152 
+	`bpf_ch
+(&
+sc
+->
+gif_if
+, 
+DLT_NULL
+, (
+u_t
+));
+
+153 
+	}
+}
+
+156 
+	$gif_e_deroy
+(
+i
+ *
+i
+)
+
+158 
+gif_soc
+ *
+sc
+ = (*
+i
+;
+
+160 
+	`gif_de_tu
+(&
+sc
+->
+gif_if
+);
+
+161 
+	`LIST_REMOVE
+(
+sc
+, 
+gif_li
+);
+
+162 #ifde
+INET6
+
+
+163 
+	`p_dach
+(
+sc
+->
+p_cook6
+);
+
+165 #ifde
+INET
+
+
+166 
+	`p_dach
+(
+sc
+->
+p_cook4
+);
+
+169 
+	`bpf_dach
+(
+i
+);
+
+170 
+	`if_dach
+(
+i
+);
+
+171 
+	`che_
+(&
+sc
+->
+gif_ro
+);
+
+173 
+	`
+(
+sc
+, 
+M_DEVBUF
+);
+
+176 
+	}
+}
+
+178 #ifde
+GIF_ENCAPCHECK
+
+
+180 
+	$gif_pcheck
+(
+mbuf
+ *
+m
+, 
+off
+, 
+o
+, *
+g
+)
+
+182 
+
+ ip;
+
+183 
+gif_soc
+ *
+sc
+;
+
+185 
+sc
+ = 
+g
+;
+
+186 i(
+sc
+ =
+NULL
+)
+
+189 i((
+sc
+->
+gif_if
+.
+if_ags
+ & 
+IFF_UP
+) == 0)
+
+193 i(!
+sc
+->
+gif_pc
+ || !sc->
+gif_pd
+)
+
+196 
+o
+) {
+
+197 #ifde
+INET
+
+
+198 
+IPPROTO_IPV4
+:
+
+201 #ifde
+INET6
+
+
+202 
+IPPROTO_IPV6
+:
+
+210 
+	`KASSERT
+(
+m
+->
+m_ags
+ & 
+M_PKTHDR
+);
+
+211 i(
+m
+->
+m_pkthdr
+.
+n
+ < (
+
+))
+
+214 
+	`m_cyda
+(
+m
+, 0, (
+
+), &ip);
+
+216 
+
+.
+_v
+) {
+
+217 #ifde
+INET
+
+
+219 i(
+sc
+->
+gif_pc
+->
+_my
+ !
+AF_INET
+ ||
+
+220 
+sc
+->
+gif_pd
+->
+_my
+ !
+AF_INET
+)
+
+222  
+	`gif_pcheck4
+(
+m
+, 
+off
+, 
+o
+, 
+g
+);
+
+224 #ifde
+INET6
+
+
+226 i(
+m
+->
+m_pkthdr
+.
+n
+ < (
+6_hdr
+))
+
+228 i(
+sc
+->
+gif_pc
+->
+_my
+ !
+AF_INET6
+ ||
+
+229 
+sc
+->
+gif_pd
+->
+_my
+ !
+AF_INET6
+)
+
+231  
+	`gif_pcheck6
+(
+m
+, 
+off
+, 
+o
+, 
+g
+);
+
+236 
+	}
+}
+
+240 
+	$gif_ouut
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+, c 
+sockaddr
+ *
+d
+,
+
+241 
+y
+ *
+
+)
+
+243 
+gif_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+244 
+r
+ = 0;
+
+245 
+ed
+ = 0;
+
+246 
+	`ALTQ_DECL
+(
+tq_pkr
+ 
+pkr
+;)
+
+247 
+s
+;
+
+249 
+	`IFQ_CLASSIFY
+(&
+i
+->
+if_d
+, 
+m
+, 
+d
+->
+_my
+, &
+pkr
+);
+
+258 i(++
+ed
+ > 
+max_gif_g
+) {
+
+259 
+	`log
+(
+LOG_NOTICE
+,
+
+261 
+ed
+);
+
+262 
+	`m_m
+(
+m
+);
+
+263 
+r
+ = 
+EIO
+;
+
+264 
+d
+;
+
+267 
+m
+->
+m_ags
+ &~(
+M_BCAST
+|
+M_MCAST
+);
+
+268 i(!(
+i
+->
+if_ags
+ & 
+IFF_UP
+) ||
+
+269 
+sc
+->
+gif_pc
+ =
+NULL
+ || sc->
+gif_pd
+ == NULL) {
+
+270 
+	`m_m
+(
+m
+);
+
+271 
+r
+ = 
+ENETDOWN
+;
+
+272 
+d
+;
+
+278 
+	`M_PREPEND
+(
+m
+, (), 
+M_DONTWAIT
+);
+
+279 i(!
+m
+) {
+
+280 
+r
+ = 
+ENOBUFS
+;
+
+281 
+d
+;
+
+283 *
+	`mtod
+(
+m
+, *
+d
+->
+_my
+;
+
+286 
+m
+->
+m_pkthdr
+.
+csum_ags
+ = 0;
+
+287 
+m
+->
+m_pkthdr
+.
+csum_da
+ = 0;
+
+289 
+s
+ = 
+	`
+();
+
+290 
+	`IFQ_ENQUEUE
+(&
+i
+->
+if_d
+, 
+m
+, &
+pkr
+, 
+r
+);
+
+291 i(
+r
+) {
+
+292 
+	`lx
+(
+s
+);
+
+293 
+d
+;
+
+295 
+	`lx
+(
+s
+);
+
+297 
+	`sot_schedu
+(
+sc
+->
+gif_si
+);
+
+298 
+r
+ = 0;
+
+300 
+d
+:
+
+301 
+ed
+ = 0;
+
+302 i(
+r
+)
+
+303 
+i
+->
+if_s
+++;
+
+304  
+r
+;
+
+305 
+	}
+}
+
+308 
+	$gif
+(*
+g
+)
+
+310 
+gif_soc
+ *
+sc
+;
+
+311 
+i
+ *
+i
+;
+
+312 
+mbuf
+ *
+m
+;
+
+313 
+my
+;
+
+314 
+n
+;
+
+315 
+s
+;
+
+316 
+r
+;
+
+318 
+sc
+ = 
+g
+;
+
+319 
+i
+ = &
+sc
+->
+gif_if
+;
+
+323 
+s
+ = 
+	`
+();
+
+324 
+	`IFQ_DEQUEUE
+(&
+sc
+->
+gif_if
+.
+if_d
+, 
+m
+);
+
+325 
+	`lx
+(
+s
+);
+
+326 i(
+m
+ =
+NULL
+)
+
+330 i((> 
+m
+->
+m_n
+) {
+
+331 
+m
+ = 
+	`m_puup
+(m, ());
+
+332 i(!
+m
+) {
+
+333 
+i
+->
+if_s
+++;
+
+337 
+my
+ = *
+	`mtod
+(
+m
+, *);
+
+338 
+	`bpf_mp
+(
+i
+, 
+m
+);
+
+339 
+	`m_adj
+(
+m
+, ());
+
+341 
+n
+ = 
+m
+->
+m_pkthdr
+.len;
+
+344 
+sc
+->
+gif_pc
+->
+_my
+) {
+
+345 #ifde
+INET
+
+
+346 
+AF_INET
+:
+
+347 
+r
+ = 
+	`_gif_ouut
+(
+i
+, 
+my
+, 
+m
+);
+
+350 #ifde
+INET6
+
+
+351 
+AF_INET6
+:
+
+352 
+r
+ = 
+	`6_gif_ouut
+(
+i
+, 
+my
+, 
+m
+);
+
+356 
+	`m_m
+(
+m
+);
+
+357 
+r
+ = 
+ENETDOWN
+;
+
+361 i(
+r
+)
+
+362 
+i
+->
+if_s
+++;
+
+364 
+i
+->
+if_acks
+++;
+
+365 
+i
+->
+if_obys
+ +
+n
+;
+
+368 
+	}
+}
+
+371 
+	$gif_put
+(
+mbuf
+ *
+m
+, 
+af
+, 
+i
+ *
+i
+)
+
+373 
+pktqueue_t
+ *
+pktq
+;
+
+374 
+size_t
+ 
+pk
+;
+
+375 
+s
+;
+
+377 i(
+i
+ =
+NULL
+) {
+
+379 
+	`m_m
+(
+m
+);
+
+383 
+m
+->
+m_pkthdr
+.
+rcvif
+ = 
+i
+;
+
+384 
+pk
+ = 
+m
+->
+m_pkthdr
+.
+n
+;
+
+386 
+	`bpf_mp_af
+(
+i
+, 
+af
+, 
+m
+);
+
+394 
+af
+) {
+
+395 #ifde
+INET
+
+
+396 
+AF_INET
+:
+
+397 
+pktq
+ = 
+_pktq
+;
+
+400 #ifde
+INET6
+
+
+401 
+AF_INET6
+:
+
+402 
+pktq
+ = 
+6_pktq
+;
+
+406 
+	`m_m
+(
+m
+);
+
+410 
+s
+ = 
+	`
+();
+
+411 i(
+	`__edi_ue
+(
+	`pktq_queue
+(
+pktq
+, 
+m
+, 0))) {
+
+412 
+i
+->
+if_ibys
+ +
+pk
+;
+
+413 
+i
+->
+if_acks
+++;
+
+415 
+	`m_m
+(
+m
+);
+
+417 
+	`lx
+(
+s
+);
+
+418 
+	}
+}
+
+422 
+	$gif_iol
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+424 
+gif_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+425 
+ieq
+ *
+i
+ = (ieq*)
+da
+;
+
+426 
+iddr
+ *
+i
+ = (iddr*)
+da
+;
+
+427 
+r
+ = 0, 
+size
+;
+
+428 
+sockaddr
+ *
+d
+, *
+c
+;
+
+430 
+cmd
+) {
+
+431 
+SIOCINITIFADDR
+:
+
+432 
+i
+->
+if_ags
+ |
+IFF_UP
+;
+
+433 
+i
+->
+i_que
+ = 
+p2p_que
+;
+
+436 
+SIOCADDMULTI
+:
+
+437 
+SIOCDELMULTI
+:
+
+438 
+i
+->
+i_addr
+.
+_my
+) {
+
+439 #ifde
+INET
+
+
+440 
+AF_INET
+:
+
+443 #ifde
+INET6
+
+
+444 
+AF_INET6
+:
+
+448 
+r
+ = 
+EAFNOSUPPORT
+;
+
+453 
+SIOCSIFMTU
+:
+
+454 i(
+i
+->
+i_mtu
+ < 
+GIF_MTU_MIN
+ || i->i_mtu > 
+GIF_MTU_MAX
+)
+
+455  
+EINVAL
+;
+
+456 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)=
+ENETRESET
+)
+
+457 
+r
+ = 0;
+
+460 #ifde
+INET
+
+
+461 
+SIOCSIFPHYADDR
+:
+
+463 #ifde
+INET6
+
+
+464 
+SIOCSIFPHYADDR_IN6
+:
+
+466 
+SIOCSLIFPHYADDR
+:
+
+467 
+cmd
+) {
+
+468 #ifde
+INET
+
+
+469 
+SIOCSIFPHYADDR
+:
+
+470 
+c
+ = (
+sockaddr
+ *)
+
+471 &(((
+_eq
+ *)
+da
+)->
+ia_addr
+);
+
+472 
+d
+ = (
+sockaddr
+ *)
+
+473 &(((
+_eq
+ *)
+da
+)->
+ia_daddr
+);
+
+476 #ifde
+INET6
+
+
+477 
+SIOCSIFPHYADDR_IN6
+:
+
+478 
+c
+ = (
+sockaddr
+ *)
+
+479 &(((
+6_eq
+ *)
+da
+)->
+ia_addr
+);
+
+480 
+d
+ = (
+sockaddr
+ *)
+
+481 &(((
+6_eq
+ *)
+da
+)->
+ia_daddr
+);
+
+484 
+SIOCSLIFPHYADDR
+:
+
+485 
+c
+ = (
+sockaddr
+ *)
+
+486 &(((
+if_ddeq
+ *)
+da
+)->
+addr
+);
+
+487 
+d
+ = (
+sockaddr
+ *)
+
+488 &(((
+if_ddeq
+ *)
+da
+)->
+daddr
+);
+
+491  
+EINVAL
+;
+
+495 i(
+c
+->
+_my
+ !
+d
+->sa_family)
+
+496  
+EINVAL
+;
+
+499 
+c
+->
+_my
+) {
+
+500 #ifde
+INET
+
+
+501 
+AF_INET
+:
+
+502 i(
+c
+->
+_n
+ !(
+sockaddr_
+))
+
+503  
+EINVAL
+;
+
+506 #ifde
+INET6
+
+
+507 
+AF_INET6
+:
+
+508 i(
+c
+->
+_n
+ !(
+sockaddr_6
+))
+
+509  
+EINVAL
+;
+
+513  
+EAFNOSUPPORT
+;
+
+515 
+d
+->
+_my
+) {
+
+516 #ifde
+INET
+
+
+517 
+AF_INET
+:
+
+518 i(
+d
+->
+_n
+ !(
+sockaddr_
+))
+
+519  
+EINVAL
+;
+
+522 #ifde
+INET6
+
+
+523 
+AF_INET6
+:
+
+524 i(
+d
+->
+_n
+ !(
+sockaddr_6
+))
+
+525  
+EINVAL
+;
+
+529  
+EAFNOSUPPORT
+;
+
+533 
+cmd
+) {
+
+534 
+SIOCSIFPHYADDR
+:
+
+535 i(
+c
+->
+_my
+ =
+AF_INET
+)
+
+537  
+EAFNOSUPPORT
+;
+
+538 #ifde
+INET6
+
+
+539 
+SIOCSIFPHYADDR_IN6
+:
+
+540 i(
+c
+->
+_my
+ =
+AF_INET6
+)
+
+542  
+EAFNOSUPPORT
+;
+
+544 
+SIOCSLIFPHYADDR
+:
+
+549 
+r
+ = 
+	`gif_t_tu
+(&
+sc
+->
+gif_if
+, 
+c
+, 
+d
+);
+
+552 #ifde
+SIOCDIFPHYADDR
+
+
+553 
+SIOCDIFPHYADDR
+:
+
+554 
+	`gif_de_tu
+(&
+sc
+->
+gif_if
+);
+
+558 
+SIOCGIFPSRCADDR
+:
+
+559 #ifde
+INET6
+
+
+560 
+SIOCGIFPSRCADDR_IN6
+:
+
+562 i(
+sc
+->
+gif_pc
+ =
+NULL
+) {
+
+563 
+r
+ = 
+EADDRNOTAVAIL
+;
+
+564 
+bad
+;
+
+566 
+c
+ = 
+sc
+->
+gif_pc
+;
+
+567 
+cmd
+) {
+
+568 #ifde
+INET
+
+
+569 
+SIOCGIFPSRCADDR
+:
+
+570 
+d
+ = &
+i
+->
+i_addr
+;
+
+571 
+size
+ = (
+i
+->
+i_addr
+);
+
+574 #ifde
+INET6
+
+
+575 
+SIOCGIFPSRCADDR_IN6
+:
+
+576 
+d
+ = (
+sockaddr
+ *)
+
+577 &(((
+6_ieq
+ *)
+da
+)->
+i_addr
+);
+
+578 
+size
+ = (((
+6_ieq
+ *)
+da
+)->
+i_addr
+);
+
+582 
+r
+ = 
+EADDRNOTAVAIL
+;
+
+583 
+bad
+;
+
+585 i(
+c
+->
+_n
+ > 
+size
+)
+
+586  
+EINVAL
+;
+
+587 
+	`memy
+(
+d
+, 
+c
+, src->
+_n
+);
+
+590 
+SIOCGIFPDSTADDR
+:
+
+591 #ifde
+INET6
+
+
+592 
+SIOCGIFPDSTADDR_IN6
+:
+
+594 i(
+sc
+->
+gif_pd
+ =
+NULL
+) {
+
+595 
+r
+ = 
+EADDRNOTAVAIL
+;
+
+596 
+bad
+;
+
+598 
+c
+ = 
+sc
+->
+gif_pd
+;
+
+599 
+cmd
+) {
+
+600 #ifde
+INET
+
+
+601 
+SIOCGIFPDSTADDR
+:
+
+602 
+d
+ = &
+i
+->
+i_addr
+;
+
+603 
+size
+ = (
+i
+->
+i_addr
+);
+
+606 #ifde
+INET6
+
+
+607 
+SIOCGIFPDSTADDR_IN6
+:
+
+608 
+d
+ = (
+sockaddr
+ *)
+
+609 &(((
+6_ieq
+ *)
+da
+)->
+i_addr
+);
+
+610 
+size
+ = (((
+6_ieq
+ *)
+da
+)->
+i_addr
+);
+
+614 
+r
+ = 
+EADDRNOTAVAIL
+;
+
+615 
+bad
+;
+
+617 i(
+c
+->
+_n
+ > 
+size
+)
+
+618  
+EINVAL
+;
+
+619 
+	`memy
+(
+d
+, 
+c
+, src->
+_n
+);
+
+622 
+SIOCGLIFPHYADDR
+:
+
+623 i(
+sc
+->
+gif_pc
+ =
+NULL
+ || sc->
+gif_pd
+ == NULL) {
+
+624 
+r
+ = 
+EADDRNOTAVAIL
+;
+
+625 
+bad
+;
+
+629 
+c
+ = 
+sc
+->
+gif_pc
+;
+
+630 
+d
+ = (
+sockaddr
+ *)
+
+631 &(((
+if_ddeq
+ *)
+da
+)->
+addr
+);
+
+632 
+size
+ = (((
+if_ddeq
+ *)
+da
+)->
+addr
+);
+
+633 i(
+c
+->
+_n
+ > 
+size
+)
+
+634  
+EINVAL
+;
+
+635 
+	`memy
+(
+d
+, 
+c
+, src->
+_n
+);
+
+638 
+c
+ = 
+sc
+->
+gif_pd
+;
+
+639 
+d
+ = (
+sockaddr
+ *)
+
+640 &(((
+if_ddeq
+ *)
+da
+)->
+daddr
+);
+
+641 
+size
+ = (((
+if_ddeq
+ *)
+da
+)->
+daddr
+);
+
+642 i(
+c
+->
+_n
+ > 
+size
+)
+
+643  
+EINVAL
+;
+
+644 
+	`memy
+(
+d
+, 
+c
+, src->
+_n
+);
+
+648  
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+);
+
+650 
+bad
+:
+
+651  
+r
+;
+
+652 
+	}
+}
+
+655 
+	$gif_t_tu
+(
+i
+ *
+i
+, 
+sockaddr
+ *
+c
+, sockadd*
+d
+)
+
+657 
+gif_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+658 
+gif_soc
+ *
+sc2
+;
+
+659 
+sockaddr
+ *
+oc
+, *
+od
+;
+
+660 
+s
+;
+
+661 
+r
+;
+
+663 
+s
+ = 
+	`lsot
+();
+
+665 
+	`LIST_FOREACH
+(
+sc2
+, &
+gif_soc_li
+, 
+gif_li
+) {
+
+666 i(
+sc2
+ =
+sc
+)
+
+668 i(!
+sc2
+->
+gif_pd
+ || !sc2->
+gif_pc
+)
+
+671 i(
+	`sockaddr_cmp
+(
+sc2
+->
+gif_pd
+, 
+d
+) == 0 &&
+
+672 
+	`sockaddr_cmp
+(
+sc2
+->
+gif_pc
+, 
+c
+) == 0) {
+
+673 
+r
+ = 
+EADDRNOTAVAIL
+;
+
+674 
+bad
+;
+
+680 i(
+sc
+->
+gif_si
+) {
+
+681 
+	`sot_diablish
+(
+sc
+->
+gif_si
+);
+
+682 
+sc
+->
+gif_si
+ = 
+NULL
+;
+
+686 i(
+sc
+->
+gif_pc
+)
+
+687 
+sc
+->
+gif_pc
+->
+_my
+) {
+
+688 #ifde
+INET
+
+
+689 
+AF_INET
+:
+
+690 ()
+	`_gif_dach
+(
+sc
+);
+
+693 #ifde
+INET6
+
+
+694 
+AF_INET6
+:
+
+695 ()
+	`6_gif_dach
+(
+sc
+);
+
+700 
+sc
+->
+gif_si
+ = 
+	`sot_eablish
+(
+SOFTINT_NET
+, 
+gif
+, sc);
+
+701 i(
+sc
+->
+gif_si
+ =
+NULL
+) {
+
+702 
+r
+ = 
+ENOMEM
+;
+
+703 
+bad
+;
+
+706 
+oc
+ = 
+sc
+->
+gif_pc
+;
+
+707 
+sc
+->
+gif_pc
+ = 
+	`sockaddr_dup
+(
+c
+, 
+M_WAITOK
+);
+
+709 
+od
+ = 
+sc
+->
+gif_pd
+;
+
+710 
+sc
+->
+gif_pd
+ = 
+	`sockaddr_dup
+(
+d
+, 
+M_WAITOK
+);
+
+712 
+sc
+->
+gif_pc
+->
+_my
+) {
+
+713 #ifde
+INET
+
+
+714 
+AF_INET
+:
+
+715 
+r
+ = 
+	`_gif_ch
+(
+sc
+);
+
+718 #ifde
+INET6
+
+
+719 
+AF_INET6
+:
+
+720 
+r
+ = 
+	`6_gif_ch
+(
+sc
+);
+
+724 
+r
+ = 
+EINVAL
+;
+
+727 i(
+r
+) {
+
+729 
+	`sockaddr_
+(
+sc
+->
+gif_pc
+);
+
+730 
+	`sockaddr_
+(
+sc
+->
+gif_pd
+);
+
+731 
+sc
+->
+gif_pc
+ = 
+oc
+;
+
+732 
+sc
+->
+gif_pd
+ = 
+od
+;
+
+733 
+bad
+;
+
+736 i(
+oc
+)
+
+737 
+	`sockaddr_
+(
+oc
+);
+
+738 i(
+od
+)
+
+739 
+	`sockaddr_
+(
+od
+);
+
+741 i(
+sc
+->
+gif_pc
+ && sc->
+gif_pd
+)
+
+742 
+i
+->
+if_ags
+ |
+IFF_RUNNING
+;
+
+744 
+i
+->
+if_ags
+ &~
+IFF_RUNNING
+;
+
+745 
+	`lx
+(
+s
+);
+
+749 
+bad
+:
+
+750 i(
+sc
+->
+gif_si
+) {
+
+751 
+	`sot_diablish
+(
+sc
+->
+gif_si
+);
+
+752 
+sc
+->
+gif_si
+ = 
+NULL
+;
+
+754 i(
+sc
+->
+gif_pc
+ && sc->
+gif_pd
+)
+
+755 
+i
+->
+if_ags
+ |
+IFF_RUNNING
+;
+
+757 
+i
+->
+if_ags
+ &~
+IFF_RUNNING
+;
+
+758 
+	`lx
+(
+s
+);
+
+760  
+r
+;
+
+761 
+	}
+}
+
+764 
+	$gif_de_tu
+(
+i
+ *
+i
+)
+
+766 
+gif_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+767 
+s
+;
+
+769 
+s
+ = 
+	`lsot
+();
+
+771 i(
+sc
+->
+gif_si
+) {
+
+772 
+	`sot_diablish
+(
+sc
+->
+gif_si
+);
+
+773 
+sc
+->
+gif_si
+ = 
+NULL
+;
+
+775 i(
+sc
+->
+gif_pc
+) {
+
+776 
+	`sockaddr_
+(
+sc
+->
+gif_pc
+);
+
+777 
+sc
+->
+gif_pc
+ = 
+NULL
+;
+
+779 i(
+sc
+->
+gif_pd
+) {
+
+780 
+	`sockaddr_
+(
+sc
+->
+gif_pd
+);
+
+781 
+sc
+->
+gif_pd
+ = 
+NULL
+;
+
+784 #ifde
+INET
+
+
+785 ()
+	`_gif_dach
+(
+sc
+);
+
+787 #ifde
+INET6
+
+
+788 ()
+	`6_gif_dach
+(
+sc
+);
+
+791 i(
+sc
+->
+gif_pc
+ && sc->
+gif_pd
+)
+
+792 
+i
+->
+if_ags
+ |
+IFF_RUNNING
+;
+
+794 
+i
+->
+if_ags
+ &~
+IFF_RUNNING
+;
+
+795 
+	`lx
+(
+s
+);
+
+796 
+	}
+}
+
+	@if_gif.h
+
+37 #ide
+_NET_IF_GIF_H_
+
+
+38 
+	#_NET_IF_GIF_H_
+
+
+	)
+
+40 
+	~<sys/queue.h
+>
+
+42 #ifde
+_KERNEL_OPT
+
+
+43 
+	~"t_.h
+"
+
+46 
+	~<t/.h
+>
+
+49 
+	gab
+;
+
+51 
+	sgif_soc
+ {
+
+52 
+i
+ 
+	mgif_if
+;
+
+53 
+sockaddr
+ *
+	mgif_pc
+;
+
+54 
+sockaddr
+ *
+	mgif_pd
+;
+
+56 
+rou
+ 
+	mgifs_ro
+;
+
+57 } 
+	mgifsc_gifs
+;
+
+58 
+	mgif_ags
+;
+
+59 c 
+ab
+ *
+	mp_cook4
+;
+
+60 c 
+ab
+ *
+	mp_cook6
+;
+
+61 
+LIST_ENTRY
+(
+gif_soc
+
+	mgif_li
+;
+
+62 *
+	mgif_si
+;
+
+64 
+	#GIF_ROUTE_TTL
+ 10
+
+	)
+
+66 
+	#gif_ro
+ 
+gifsc_gifs
+.
+gifs_ro
+
+
+	)
+
+68 
+	#GIF_MTU
+ (1280
+
+	)
+
+69 
+	#GIF_MTU_MIN
+ (1280
+
+	)
+
+70 
+	#GIF_MTU_MAX
+ (8192
+
+	)
+
+73 
+giach0
+(
+gif_soc
+ *);
+
+74 
+gif_put
+(
+mbuf
+ *, , 
+i
+ *);
+
+75 
+gif_ouut
+(
+i
+ *, 
+mbuf
+ *,
+
+76 c 
+sockaddr
+ *, 
+y
+ *);
+
+77 
+gif_iol
+(
+i
+ *, 
+u_lg
+, *);
+
+78 
+gif_t_tu
+(
+i
+ *, 
+sockaddr
+ *, sockaddr *);
+
+79 
+gif_de_tu
+(
+i
+ *);
+
+80 #ifde
+GIF_ENCAPCHECK
+
+
+81 
+gif_pcheck
+(
+mbuf
+ *, , , *);
+
+	@if_gre.c
+
+47 
+	~<sys/cdefs.h
+>
+
+48 
+__KERNEL_RCSID
+(0, "$NetBSD: if_gre.c,v 1.165 2015/05/02 17:18:03tr Exp $");
+
+50 
+	~"t_k.h
+"
+
+51 
+	~"t_g.h
+"
+
+52 
+	~"t_.h
+"
+
+53 
+	~"t_ms.h
+"
+
+55 
+	~<sys/m.h
+>
+
+56 
+	~<sys/fe.h
+>
+
+57 
+	~<sys/fedesc.h
+>
+
+58 
+	~<sys/mloc.h
+>
+
+59 
+	~<sys/mlocv.h
+>
+
+60 
+	~<sys/mbuf.h
+>
+
+61 
+	~<sys/oc.h
+>
+
+62 
+	~<sys/doma.h
+>
+
+63 
+	~<sys/osw.h
+>
+
+64 
+	~<sys/sock.h
+>
+
+65 
+	~<sys/sockv.h
+>
+
+66 
+	~<sys/iol.h
+>
+
+67 
+	~<sys/queue.h
+>
+
+68 
+	~<sys/.h
+>
+
+69 
+	~<sys/sym.h
+>
+
+70 
+	~<sys/sysl.h
+>
+
+71 
+	~<sys/kauth.h
+>
+
+73 
+	~<sys/kl.h
+>
+
+74 
+	~<sys/mux.h
+>
+
+75 
+	~<sys/cdv.h
+>
+
+76 
+	~<sys/kthad.h
+>
+
+78 
+	~<sys/u.h
+>
+
+80 
+	~<t/htys.h
+>
+
+81 
+	~<t/if.h
+>
+
+82 
+	~<t/if_tys.h
+>
+
+83 
+	~<t/ti.h
+>
+
+84 
+	~<t/rou.h
+>
+
+86 
+	~<t/_sym.h
+>
+
+87 
+	~<t/.h
+>
+
+88 
+	~<t/.h
+>
+
+90 #ifde
+INET
+
+
+91 
+	~<t/_v.h
+>
+
+92 
+	~<t/_v.h
+>
+
+95 #ifde
+INET6
+
+
+96 
+	~<t6/6_v.h
+>
+
+99 #ifde
+MPLS
+
+
+100 
+	~<tms/ms.h
+>
+
+101 
+	~<tms/ms_v.h
+>
+
+104 #ifde
+NETATALK
+
+
+105 
+	~<lk/.h
+>
+
+106 
+	~<lk/_v.h
+>
+
+107 
+	~<lk/_ex.h
+>
+
+110 
+	~<sys/time.h
+>
+
+111 
+	~<t/bpf.h
+>
+
+113 
+	~<t/if_g.h
+>
+
+115 
+	~<comt/sys/sock.h
+>
+
+116 
+	~<comt/sys/sockio.h
+>
+
+122 
+	#GREMTU
+ 1476
+
+	)
+
+124 #ifde
+GRE_DEBUG
+
+
+125 
+	gg_debug
+ = 0;
+
+126 
+	#GRE_DPRINTF
+(
+__sc
+, ...) \
+
+128 i(
+	`__edi_l
+(
+g_debug
+ || \
+
+129 ((
+__sc
+)->
+sc_if
+.
+if_ags
+ & 
+IFF_DEBUG
+) != 0)) { \
+
+130 
+	`tf
+("%s.%d: ", 
+__func__
+, 
+__LINE__
+); \
+
+131 
+	`tf
+(
+__VA_ARGS__
+); \
+
+133 }  0)
+
+	)
+
+135 
+	#GRE_DPRINTF
+(
+__sc
+, 
+__fmt
+, ...d{ }  0)
+
+	)
+
+138 
+	g_g_l
+ = 
+GRE_TTL
+;
+
+140 
+g_e_
+(
+if_e
+ *, );
+
+141 
+g_e_deroy
+(
+i
+ *);
+
+143 
+if_e
+ 
+	gg_
+ =
+
+144 
+IF_CLONE_INITIALIZER
+("g", 
+g_e_
+, 
+g_e_deroy
+);
+
+146 
+g_put
+(
+g_soc
+ *, 
+mbuf
+ *, ,
+
+147 c 
+g_h
+ *);
+
+148 
+bo
+ 
+g_is_nucf
+(c 
+g_sm
+ *);
+
+149 
+g_ouut
+(
+i
+ *, 
+mbuf
+ *,
+
+150 c 
+sockaddr
+ *, 
+y
+ *);
+
+151 
+g_iol
+(
+i
+ *, 
+u_lg
+, *);
+
+152 
+g_gsockme
+(
+sock
+ *, 
+sockaddr
+ *);
+
+153 
+g_gme
+(
+sock
+ *, 
+sockaddr
+ *);
+
+154 
+g_gmes
+(
+sock
+ *, 
+lwp
+ *,
+
+155 
+sockaddr_age
+ *, sockaddr_storage *);
+
+156 
+g_rcf
+(
+g_sm
+ *, 
+bo
+);
+
+157 
+g_seive
+(
+sock
+ *, 
+mbuf
+ **);
+
+158 
+g_sond
+(
+sock
+ *, 
+mbuf
+ *);
+
+159 
+sock
+ *
+g_cf
+(
+g_soc
+ *, c 
+g_sm
+ *);
+
+161 
+bo
+ 
+g__nd
+(
+g_soc
+ *, 
+g_msg
+, 
+fe_t
+ *);
+
+162 
+bo
+ 
+g__cv
+(
+g_soc
+ *);
+
+163 
+g__cvlo
+(*);
+
+166 
+	$g_bufq_
+(
+g_bufq
+ *
+bq
+, 
+size_t
+ 
+n0
+)
+
+168 
+	`memt
+(
+bq
+, 0, (*bq));
+
+169 
+bq
+->
+bq_q
+ = 
+	`pcq_
+(
+n0
+, 
+KM_SLEEP
+);
+
+170 
+	`KASSERT
+(
+bq
+->
+bq_q
+ !
+NULL
+);
+
+171 
+	}
+}
+
+173 
+mbuf
+ *
+
+174 
+	$g_bufq_dequeue
+(
+g_bufq
+ *
+bq
+)
+
+176  
+	`pcq_g
+(
+bq
+->
+bq_q
+);
+
+177 
+	}
+}
+
+180 
+	$g_bufq_purge
+(
+g_bufq
+ *
+bq
+)
+
+182 
+mbuf
+ *
+m
+;
+
+184 (
+m
+ = 
+	`g_bufq_dequeue
+(
+bq
+)!
+NULL
+)
+
+185 
+	`m_m
+(
+m
+);
+
+186 
+	}
+}
+
+189 
+	$g_bufq_deroy
+(
+g_bufq
+ *
+bq
+)
+
+191 
+	`g_bufq_purge
+(
+bq
+);
+
+192 
+	`pcq_deroy
+(
+bq
+->
+bq_q
+);
+
+193 
+	}
+}
+
+196 
+	$g_bufq_queue
+(
+g_bufq
+ *
+bq
+, 
+mbuf
+ *
+m
+)
+
+198 
+	`KASSERT
+(
+bq
+->
+bq_q
+ !
+NULL
+);
+
+200 i(!
+	`pcq_put
+(
+bq
+->
+bq_q
+, 
+m
+)) {
+
+201 
+bq
+->
+bq_drs
+++;
+
+202  
+ENOBUFS
+;
+
+205 
+	}
+}
+
+208 
+	$g
+(*
+g
+)
+
+210 
+g_soc
+ *
+sc
+ = (g_so*)
+g
+;
+
+211 
+sock
+ *
+so
+ = 
+sc
+->
+sc_sm
+.
+_so
+;
+
+212 
+rc
+;
+
+213 
+mbuf
+ *
+m
+;
+
+215 
+	`KASSERT
+(
+so
+ !
+NULL
+);
+
+217 
+sc
+->
+sc_nd_ev
+.
+ev_cou
+++;
+
+218 
+	`GRE_DPRINTF
+(
+sc
+, "enter\n");
+
+219 (
+m
+ = 
+	`g_bufq_dequeue
+(&
+sc
+->
+sc_d
+)!
+NULL
+) {
+
+221 i((
+rc
+ = 
+	`g_sond
+(
+so
+, 
+m
+)) != 0)
+
+222 
+	`GRE_DPRINTF
+(
+sc
+, "g_sond faed %d\n", 
+rc
+);
+
+224 
+	}
+}
+
+228 
+	$g__wa
+(
+g_soc
+ *
+sc
+)
+
+230 
+sc
+->
+sc__was
+++;
+
+231 
+	`cv_wa
+(&
+sc
+->
+sc__cdv
+, &sc->
+sc_mtx
+);
+
+232 
+sc
+->
+sc__was
+--;
+
+233 
+	}
+}
+
+236 
+	$g_evt_dach
+(
+g_soc
+ *
+sc
+)
+
+238 
+	`evt_dach
+(&
+sc
+->
+sc_cv_ev
+);
+
+239 
+	`evt_dach
+(&
+sc
+->
+sc_block_ev
+);
+
+240 
+	`evt_dach
+(&
+sc
+->
+sc_r_ev
+);
+
+241 
+	`evt_dach
+(&
+sc
+->
+sc_puup_ev
+);
+
+242 
+	`evt_dach
+(&
+sc
+->
+sc_unsu_ev
+);
+
+244 
+	`evt_dach
+(&
+sc
+->
+sc_nd_ev
+);
+
+245 
+	`evt_dach
+(&
+sc
+->
+sc_oow_ev
+);
+
+246 
+	}
+}
+
+249 
+	$g_evt_ch
+(
+g_soc
+ *
+sc
+)
+
+251 
+	`evt_ch_dymic
+(&
+sc
+->
+sc_cv_ev
+, 
+EVCNT_TYPE_MISC
+,
+
+252 
+NULL
+, 
+sc
+->
+sc_if
+.
+if_xme
+, "recv");
+
+253 
+	`evt_ch_dymic
+(&
+sc
+->
+sc_block_ev
+, 
+EVCNT_TYPE_MISC
+,
+
+254 &
+sc
+->
+sc_cv_ev
+, sc->
+sc_if
+.
+if_xme
+, "would block");
+
+255 
+	`evt_ch_dymic
+(&
+sc
+->
+sc_r_ev
+, 
+EVCNT_TYPE_MISC
+,
+
+256 &
+sc
+->
+sc_cv_ev
+, sc->
+sc_if
+.
+if_xme
+, "error");
+
+257 
+	`evt_ch_dymic
+(&
+sc
+->
+sc_puup_ev
+, 
+EVCNT_TYPE_MISC
+,
+
+258 &
+sc
+->
+sc_cv_ev
+, sc->
+sc_if
+.
+if_xme
+, "pullup failed");
+
+259 
+	`evt_ch_dymic
+(&
+sc
+->
+sc_unsu_ev
+, 
+EVCNT_TYPE_MISC
+,
+
+260 &
+sc
+->
+sc_cv_ev
+, sc->
+sc_if
+.
+if_xme
+, "unsupported");
+
+262 
+	`evt_ch_dymic
+(&
+sc
+->
+sc_nd_ev
+, 
+EVCNT_TYPE_MISC
+,
+
+263 
+NULL
+, 
+sc
+->
+sc_if
+.
+if_xme
+, "send");
+
+264 
+	`evt_ch_dymic
+(&
+sc
+->
+sc_oow_ev
+, 
+EVCNT_TYPE_MISC
+,
+
+265 &
+sc
+->
+sc_nd_ev
+, sc->
+sc_if
+.
+if_xme
+, "overflow");
+
+266 
+	}
+}
+
+269 
+	$g_e_
+(
+if_e
+ *
+ifc
+, 
+un
+)
+
+271 
+rc
+;
+
+272 
+g_soc
+ *
+sc
+;
+
+273 
+g_sm
+ *
+
+;
+
+274 c 
+sockaddr
+ *
+y
+;
+
+276 i((
+y
+ = 
+	`sockaddr_y_by_my
+(
+AF_INET
+)=
+NULL
+ &&
+
+277 (
+y
+ = 
+	`sockaddr_y_by_my
+(
+AF_INET6
+)=
+NULL
+)
+
+278 
+0
+;
+
+280 
+sc
+ = 
+	`mloc
+((*sc), 
+M_DEVBUF
+, 
+M_WAITOK
+|
+M_ZERO
+);
+
+281 
+	`mux_
+(&
+sc
+->
+sc_mtx
+, 
+MUTEX_DRIVER
+, 
+IPL_SOFTNET
+);
+
+282 
+	`cv_
+(&
+sc
+->
+sc_cdv
+, "gre wait");
+
+283 
+	`cv_
+(&
+sc
+->
+sc__cdv
+, "gre fp");
+
+285 
+	`if_me
+(&
+sc
+->
+sc_if
+, 
+ifc
+->
+ifc_me
+, 
+un
+);
+
+286 
+sc
+->
+sc_if
+.
+if_soc
+ = sc;
+
+287 
+sc
+->
+sc_if
+.
+if_ty
+ = 
+IFT_TUNNEL
+;
+
+288 
+sc
+->
+sc_if
+.
+if_add
+ = 0;
+
+289 
+sc
+->
+sc_if
+.
+if_hd
+ = (
+
++ (
+g_h
+);
+
+290 
+sc
+->
+sc_if
+.
+if_d
+ = 
+DLT_NULL
+;
+
+291 
+sc
+->
+sc_if
+.
+if_mtu
+ = 
+GREMTU
+;
+
+292 
+sc
+->
+sc_if
+.
+if_ags
+ = 
+IFF_POINTOPOINT
+|
+IFF_MULTICAST
+;
+
+293 
+sc
+->
+sc_if
+.
+if_ouut
+ = 
+g_ouut
+;
+
+294 
+sc
+->
+sc_if
+.
+if_iol
+ = 
+g_iol
+;
+
+295 
+
+ = &
+sc
+->
+sc_sm
+;
+
+296 
+	`sockaddr_cy
+(
+	`so
+(&
+
+->
+_d
+), (->_d), 
+y
+);
+
+297 
+	`sockaddr_cy
+(
+	`so
+(&
+
+->
+_c
+), (->_c), 
+y
+);
+
+298 
+
+->
+_o
+ = 
+IPPROTO_GRE
+;
+
+299 
+
+->
+_ty
+ = 
+SOCK_RAW
+;
+
+301 
+sc
+->
+sc_fd
+ = -1;
+
+303 
+rc
+ = 
+	`kthad_
+(
+PRI_NONE
+, 
+KTHREAD_MPSAFE
+, 
+NULL
+, 
+g__cvlo
+, 
+sc
+,
+
+304 
+NULL
+, "%s", 
+sc
+->
+sc_if
+.
+if_xme
+);
+
+305 i(
+rc
+)
+
+306 
+1
+;
+
+308 
+	`g_evt_ch
+(
+sc
+);
+
+310 
+	`g_bufq_
+(&
+sc
+->
+sc_d
+, 17);
+
+311 
+sc
+->
+sc_if
+.
+if_ags
+ |
+IFF_LINK0
+;
+
+312 
+	`if_ch
+(&
+sc
+->
+sc_if
+);
+
+313 
+	`if_loc_dl
+(&
+sc
+->
+sc_if
+);
+
+314 
+	`bpf_ch
+(&
+sc
+->
+sc_if
+, 
+DLT_NULL
+, (
+ut32_t
+));
+
+317 
+1
+: 
+	`cv_deroy
+(&
+sc
+->
+sc__cdv
+);
+
+318 
+	`cv_deroy
+(&
+sc
+->
+sc_cdv
+);
+
+319 
+	`mux_deroy
+(&
+sc
+->
+sc_mtx
+);
+
+320 
+	`
+(
+sc
+, 
+M_DEVBUF
+);
+
+321 
+0
+:  -1;
+
+322 
+	}
+}
+
+325 
+	$g_e_deroy
+(
+i
+ *
+i
+)
+
+327 
+s
+;
+
+328 
+g_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+330 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+332 
+	`bpf_dach
+(
+i
+);
+
+333 
+s
+ = 
+	`
+();
+
+334 
+	`if_dach
+(
+i
+);
+
+336 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+338 
+	`g_cf
+(
+sc
+, 
+NULL
+);
+
+340 
+	`mux_r
+(&
+sc
+->
+sc_mtx
+);
+
+341 
+sc
+->
+sc_msg
+ = 
+GRE_M_STOP
+;
+
+342 
+	`cv_sigl
+(&
+sc
+->
+sc__cdv
+);
+
+343 
+sc
+->
+sc__was
+ > 0)
+
+344 
+	`cv_wa
+(&
+sc
+->
+sc__cdv
+, &sc->
+sc_mtx
+);
+
+345 
+	`mux_ex
+(&
+sc
+->
+sc_mtx
+);
+
+347 
+	`lx
+(
+s
+);
+
+349 
+	`cv_deroy
+(&
+sc
+->
+sc_cdv
+);
+
+350 
+	`cv_deroy
+(&
+sc
+->
+sc__cdv
+);
+
+351 
+	`mux_deroy
+(&
+sc
+->
+sc_mtx
+);
+
+352 
+	`g_bufq_deroy
+(&
+sc
+->
+sc_d
+);
+
+353 
+	`g_evt_dach
+(
+sc
+);
+
+354 
+	`
+(
+sc
+, 
+M_DEVBUF
+);
+
+357 
+	}
+}
+
+360 
+	$g_ive
+(
+sock
+ *
+so
+, *
+g
+, 
+evts
+, 
+waag
+)
+
+362 
+g_soc
+ *
+sc
+ = (g_so*)
+g
+;
+
+363 
+rc
+;
+
+364 c 
+g_h
+ *
+gh
+;
+
+365 
+mbuf
+ *
+m
+;
+
+367 
+	`GRE_DPRINTF
+(
+sc
+, "enter\n");
+
+369 
+sc
+->
+sc_cv_ev
+.
+ev_cou
+++;
+
+371 
+rc
+ = 
+	`g_seive
+(
+so
+, &
+m
+);
+
+375 i(
+rc
+ =
+EWOULDBLOCK
+) {
+
+376 
+	`GRE_DPRINTF
+(
+sc
+, "EWOULDBLOCK\n");
+
+377 
+sc
+->
+sc_block_ev
+.
+ev_cou
+++;
+
+379 } i(
+rc
+ !0 || 
+m
+ =
+NULL
+) {
+
+380 
+	`GRE_DPRINTF
+(
+sc
+, "%s:c %d m %p\n",
+
+381 
+sc
+->
+sc_if
+.
+if_xme
+, 
+rc
+, (*)
+m
+);
+
+382 
+sc
+->
+sc_r_ev
+.
+ev_cou
+++;
+
+385 i(
+m
+->
+m_n
+ < (*
+gh
+&& (m = 
+	`m_puup
+(m, (*gh))=
+NULL
+) {
+
+386 
+	`GRE_DPRINTF
+(
+sc
+, "m_pullup failed\n");
+
+387 
+sc
+->
+sc_puup_ev
+.
+ev_cou
+++;
+
+390 
+gh
+ = 
+	`mtod
+(
+m
+, c 
+g_h
+ *);
+
+392 i(
+	`g_put
+(
+sc
+, 
+m
+, 0, 
+gh
+) == 0) {
+
+393 
+sc
+->
+sc_unsu_ev
+.
+ev_cou
+++;
+
+394 
+	`GRE_DPRINTF
+(
+sc
+, "dropping unsupported\n");
+
+395 
+	`m_m
+(
+m
+);
+
+397 
+	}
+}
+
+400 
+	$g_up_add
+(
+sock
+ *
+so
+, *
+g
+)
+
+403 
+	`KASSERT
+((
+so
+->
+so_rcv
+.
+sb_ags
+ & 
+SB_UPCALL
+) == 0);
+
+404 
+so
+->
+so_upg
+ = 
+g
+;
+
+405 
+so
+->
+so_up
+ = 
+g_ive
+;
+
+406 
+so
+->
+so_rcv
+.
+sb_ags
+ |
+SB_UPCALL
+;
+
+407 
+	}
+}
+
+410 
+	$g_up_move
+(
+sock
+ *
+so
+)
+
+412 
+so
+->
+so_rcv
+.
+sb_ags
+ &~
+SB_UPCALL
+;
+
+413 
+so
+->
+so_upg
+ = 
+NULL
+;
+
+414 
+so
+->
+so_up
+ = 
+NULL
+;
+
+415 
+	}
+}
+
+418 
+	$g_so
+(
+g_soc
+ *
+sc
+, c 
+g_sm
+ *
+
+, *
+fdout
+)
+
+420 
+fd
+, 
+rc
+;
+
+421 
+sock
+ *
+so
+;
+
+422 
+sockaddr_big
+ 
+sbig
+;
+
+423 
+_my_t
+ 
+af
+;
+
+424 
+v
+;
+
+426 
+	`GRE_DPRINTF
+(
+sc
+, "enter\n");
+
+428 
+af
+ = 
+
+->
+_c
+.
+ss_my
+;
+
+429 
+rc
+ = 
+	`fso
+(
+af
+, 
+NULL
+, 
+
+->
+_ty
+, sp->
+_o
+, &
+fd
+);
+
+430 i(
+rc
+ != 0) {
+
+431 
+	`GRE_DPRINTF
+(
+sc
+, "fsocreate failed\n");
+
+432  
+rc
+;
+
+435 i((
+rc
+ = 
+	`fd_gsock
+(
+fd
+, &
+so
+)) != 0)
+
+436  
+rc
+;
+
+438 
+	`memy
+(&
+sbig
+, &
+
+->
+_c
+, (sp->sp_src));
+
+439 i((
+rc
+ = 
+	`sobd
+(
+so
+, (
+sockaddr
+ *)&
+sbig
+, 
+cuwp
+)) != 0) {
+
+440 
+	`GRE_DPRINTF
+(
+sc
+, "sobind failed\n");
+
+441 
+out
+;
+
+444 
+	`memy
+(&
+sbig
+, &
+
+->
+_d
+, (sp->sp_dst));
+
+445 
+	`sock
+(
+so
+);
+
+446 i((
+rc
+ = 
+	`soc
+(
+so
+, (
+sockaddr
+ *)&
+sbig
+, 
+cuwp
+)) != 0) {
+
+447 
+	`GRE_DPRINTF
+(
+sc
+, "soconnect failed\n");
+
+448 
+	`souock
+(
+so
+);
+
+449 
+out
+;
+
+451 
+	`souock
+(
+so
+);
+
+454 
+	`KASSERT
+(
+so
+->
+so_o
+ !
+NULL
+);
+
+455 
+rc
+ = 
+	`so_tsockt
+(
+cuwp
+, 
+so
+, 
+IPPROTO_IP
+, 
+IP_TTL
+,
+
+456 &
+_g_l
+, (ip_gre_ttl));
+
+457 i(
+rc
+ != 0) {
+
+458 
+	`GRE_DPRINTF
+(
+sc
+, "so_setsockopttl failed\n");
+
+459 
+rc
+ = 0;
+
+462 
+v
+ = 1;
+
+463 
+rc
+ = 
+	`so_tsockt
+(
+cuwp
+, 
+so
+, 
+SOL_SOCKET
+, 
+SO_NOHEADER
+,
+
+464 &
+v
+, (val));
+
+465 i(
+rc
+ != 0) {
+
+466 
+	`GRE_DPRINTF
+(
+sc
+, "so_setsockopt SO_NOHEADER failed\n");
+
+467 
+rc
+ = 0;
+
+469 
+out
+:
+
+470 i(
+rc
+ != 0)
+
+471 
+	`fd_o
+(
+fd
+);
+
+473 
+	`fd_putfe
+(
+fd
+);
+
+474 *
+fdout
+ = 
+fd
+;
+
+477  
+rc
+;
+
+478 
+	}
+}
+
+481 
+	$g_sond
+(
+sock
+ *
+so
+, 
+mbuf
+ *
+t
+)
+
+483 
+oc
+ *
+p
+;
+
+484 
+a
+, 
+sid
+;
+
+485 
+r
+;
+
+486 
+lwp
+ * c 
+l
+ = 
+cuwp
+;
+
+488 
+p
+ = 
+l
+->
+l_oc
+;
+
+490 
+sid
+ = 
+t
+->
+m_pkthdr
+.
+n
+;
+
+491 i(
+p
+)
+
+492 
+l
+->
+l_ru
+.
+ru_msgd
+++;
+
+493 
+	#dr
+(
+o
+{ 
+r
+ =no; 
+a
+; }
+
+	)
+
+495 
+	`sock
+(
+so
+);
+
+496 i((
+r
+ = 
+	`sblock
+(&
+so
+->
+so_d
+, 
+M_NOWAIT
+)) != 0)
+
+497 
+out
+;
+
+498 i(
+so
+->
+so_e
+ & 
+SS_CANTSENDMORE
+)
+
+499 
+	`dr
+(
+EPIPE
+);
+
+500 i(
+so
+->
+so_r
+) {
+
+501 
+r
+ = 
+so
+->
+so_r
+;
+
+502 
+so
+->
+so_r
+ = 0;
+
+503 
+a
+;
+
+505 i((
+so
+->
+so_e
+ & 
+SS_ISCONNECTED
+) == 0) {
+
+506 i(
+so
+->
+so_o
+->
+_ags
+ & 
+PR_CONNREQUIRED
+) {
+
+507 
+	`dr
+(
+ENOTCONN
+);
+
+509 
+	`dr
+(
+EDESTADDRREQ
+);
+
+512 
+a
+ = 
+	`sba
+(&
+so
+->
+so_d
+);
+
+513 i(
+sid
+ > 
+so
+->
+so_d
+.
+sb_hiw
+)
+
+514 
+	`dr
+(
+EMSGSIZE
+);
+
+515 i(
+a
+ < 
+sid
+)
+
+516 
+	`dr
+(
+EWOULDBLOCK
+);
+
+520 i(
+so
+->
+so_e
+ & 
+SS_CANTSENDMORE
+)
+
+521 
+	`dr
+(
+EPIPE
+);
+
+522 
+r
+ = (*
+so
+->
+so_o
+->
+_uqs
+->
+_nd
+)(so,
+
+523 
+t
+, 
+NULL
+, NULL, 
+l
+);
+
+524 
+t
+ = 
+NULL
+;
+
+525 
+a
+:
+
+526 
+	`sbuock
+(&
+so
+->
+so_d
+);
+
+527 
+out
+:
+
+528 
+	`souock
+(
+so
+);
+
+529 i(
+t
+ !
+NULL
+)
+
+530 
+	`m_m
+(
+t
+);
+
+531  
+r
+;
+
+532 
+	}
+}
+
+539 
+	$g_seive
+(
+sock
+ *
+so
+, 
+mbuf
+ **
+mp0
+)
+
+541 
+mbuf
+ *
+m
+, **
+mp
+;
+
+542 
+ags
+, 
+n
+, 
+r
+, 
+ty
+;
+
+543 c 
+osw
+ *
+
+;
+
+544 
+mbuf
+ *
+xecd
+;
+
+546 
+	`KASSERT
+(
+mp0
+ !
+NULL
+);
+
+548 
+ags
+ = 
+MSG_DONTWAIT
+;
+
+549 
+
+ = 
+so
+->
+so_o
+;
+
+550 
+mp
+ = 
+mp0
+;
+
+551 
+ty
+ = 0;
+
+553 *
+mp
+ = 
+NULL
+;
+
+555 
+	`KASSERT
+(
+
+->
+_ags
+ & 
+PR_ATOMIC
+);
+
+556 
+t
+:
+
+557 i((
+r
+ = 
+	`sblock
+(&
+so
+->
+so_rcv
+, 
+M_NOWAIT
+)) != 0) {
+
+558  
+r
+;
+
+560 
+m
+ = 
+so
+->
+so_rcv
+.
+sb_mb
+;
+
+564 i(
+m
+ =
+NULL
+) {
+
+565 #ifde
+DIAGNOSTIC
+
+
+566 i(
+so
+->
+so_rcv
+.
+sb_cc
+)
+
+567 
+	`nic
+("receive 1");
+
+569 i(
+so
+->
+so_r
+) {
+
+570 
+r
+ = 
+so
+->
+so_r
+;
+
+571 
+so
+->
+so_r
+ = 0;
+
+572 } i(
+so
+->
+so_e
+ & 
+SS_CANTRCVMORE
+)
+
+574 i((
+so
+->
+so_e
+ & (
+SS_ISCONNECTED
+|
+SS_ISCONNECTING
+)) == 0
+
+575 && (
+so
+->
+so_o
+->
+_ags
+ & 
+PR_CONNREQUIRED
+))
+
+576 
+r
+ = 
+ENOTCONN
+;
+
+578 
+r
+ = 
+EWOULDBLOCK
+;
+
+579 
+a
+;
+
+586 i(
+cuwp
+ !
+NULL
+)
+
+587 
+cuwp
+->
+l_ru
+.
+ru_msgrcv
+++;
+
+588 
+	`KASSERT
+(
+m
+ =
+so
+->
+so_rcv
+.
+sb_mb
+);
+
+589 
+	`SBLASTRECORDCHK
+(&
+so
+->
+so_rcv
+, "soreceive 1");
+
+590 
+	`SBLASTMBUFCHK
+(&
+so
+->
+so_rcv
+, "soreceive 1");
+
+591 
+xecd
+ = 
+m
+->
+m_xkt
+;
+
+592 i(
+
+->
+_ags
+ & 
+PR_ADDR
+) {
+
+593 #ifde
+DIAGNOSTIC
+
+
+594 i(
+m
+->
+m_ty
+ !
+MT_SONAME
+)
+
+595 
+	`nic
+("receive 1a");
+
+597 
+	`sb
+(&
+so
+->
+so_rcv
+, 
+m
+);
+
+598 
+	`MFREE
+(
+m
+, 
+so
+->
+so_rcv
+.
+sb_mb
+);
+
+599 
+m
+ = 
+so
+->
+so_rcv
+.
+sb_mb
+;
+
+601 
+m
+ !
+NULL
+ && m->
+m_ty
+ =
+MT_CONTROL
+ && 
+r
+ == 0) {
+
+602 
+	`sb
+(&
+so
+->
+so_rcv
+, 
+m
+);
+
+607 i(
+
+->
+_doma
+->
+dom_dio
+ &&
+
+608 
+	`mtod
+(
+m
+, 
+cmsghdr
+ *)->
+cmsg_ty
+ =
+SCM_RIGHTS
+)
+
+609 (*
+
+->
+_doma
+->
+dom_dio
+)(
+m
+);
+
+610 
+	`MFREE
+(
+m
+, 
+so
+->
+so_rcv
+.
+sb_mb
+);
+
+611 
+m
+ = 
+so
+->
+so_rcv
+.
+sb_mb
+;
+
+620 i(
+m
+ !
+NULL
+) {
+
+621 
+m
+->
+m_xkt
+ = 
+xecd
+;
+
+627 i(
+xecd
+ =
+NULL
+) {
+
+628 
+	`KASSERT
+(
+so
+->
+so_rcv
+.
+sb_mb
+ =
+m
+);
+
+629 
+so
+->
+so_rcv
+.
+sb_cd
+ = 
+m
+;
+
+631 
+ty
+ = 
+m
+->
+m_ty
+;
+
+632 i(
+ty
+ =
+MT_OOBDATA
+)
+
+633 
+ags
+ |
+MSG_OOB
+;
+
+635 
+	`KASSERT
+(
+so
+->
+so_rcv
+.
+sb_mb
+ =
+m
+);
+
+636 
+so
+->
+so_rcv
+.
+sb_mb
+ = 
+xecd
+;
+
+637 
+	`SB_EMPTY_FIXUP
+(&
+so
+->
+so_rcv
+);
+
+639 
+	`SBLASTRECORDCHK
+(&
+so
+->
+so_rcv
+, "soreceive 2");
+
+640 
+	`SBLASTMBUFCHK
+(&
+so
+->
+so_rcv
+, "soreceive 2");
+
+642 
+m
+ !
+NULL
+) {
+
+643 i(
+m
+->
+m_ty
+ =
+MT_OOBDATA
+) {
+
+644 i(
+ty
+ !
+MT_OOBDATA
+)
+
+646 } i(
+ty
+ =
+MT_OOBDATA
+)
+
+648 #ifde
+DIAGNOSTIC
+
+
+649 i(
+m
+->
+m_ty
+ !
+MT_DATA
+ && m->m_ty !
+MT_HEADER
+)
+
+650 
+	`nic
+("receive 3");
+
+652 
+so
+->
+so_e
+ &~
+SS_RCVATMARK
+;
+
+653 i(
+so
+->
+so_oobmk
+ !0 && so->so_oobmk < 
+m
+->
+m_n
+)
+
+655 
+n
+ = 
+m
+->
+m_n
+;
+
+663 i(
+m
+->
+m_ags
+ & 
+M_EOR
+)
+
+664 
+ags
+ |
+MSG_EOR
+;
+
+665 
+xecd
+ = 
+m
+->
+m_xkt
+;
+
+666 
+	`sb
+(&
+so
+->
+so_rcv
+, 
+m
+);
+
+667 *
+mp
+ = 
+m
+;
+
+668 
+mp
+ = &
+m
+->
+m_xt
+;
+
+669 
+so
+->
+so_rcv
+.
+sb_mb
+ = 
+m
+ = m->
+m_xt
+;
+
+670 *
+mp
+ = 
+NULL
+;
+
+675 
+	`KASSERT
+(
+so
+->
+so_rcv
+.
+sb_mb
+ =
+m
+);
+
+676 i(
+m
+) {
+
+677 
+m
+->
+m_xkt
+ = 
+xecd
+;
+
+678 i(
+xecd
+ =
+NULL
+)
+
+679 
+so
+->
+so_rcv
+.
+sb_cd
+ = 
+m
+;
+
+681 
+so
+->
+so_rcv
+.
+sb_mb
+ = 
+xecd
+;
+
+682 
+	`SB_EMPTY_FIXUP
+(&
+so
+->
+so_rcv
+);
+
+684 
+	`SBLASTRECORDCHK
+(&
+so
+->
+so_rcv
+, "soreceive 3");
+
+685 
+	`SBLASTMBUFCHK
+(&
+so
+->
+so_rcv
+, "soreceive 3");
+
+686 i(
+so
+->
+so_oobmk
+) {
+
+687 
+so
+->
+so_oobmk
+ -
+n
+;
+
+688 i(
+so
+->
+so_oobmk
+ == 0) {
+
+689 
+so
+->
+so_e
+ |
+SS_RCVATMARK
+;
+
+693 i(
+ags
+ & 
+MSG_EOR
+)
+
+697 i(
+m
+ !
+NULL
+) {
+
+698 
+	`m_m
+(*
+mp
+);
+
+699 *
+mp
+ = 
+NULL
+;
+
+700 
+r
+ = 
+ENOMEM
+;
+
+701 (
+	`sbdrcd
+(&
+so
+->
+so_rcv
+);
+
+708 
+so
+->
+so_rcv
+.
+sb_mb
+ = 
+xecd
+;
+
+709 i(
+so
+->
+so_rcv
+.
+sb_mb
+ =
+NULL
+) {
+
+710 
+so
+->
+so_rcv
+.
+sb_mb
+ = 
+NULL
+;
+
+711 
+so
+->
+so_rcv
+.
+sb_cd
+ = 
+NULL
+;
+
+712 } i(
+xecd
+->
+m_xkt
+ =
+NULL
+)
+
+713 
+so
+->
+so_rcv
+.
+sb_cd
+ = 
+xecd
+;
+
+715 
+	`SBLASTRECORDCHK
+(&
+so
+->
+so_rcv
+, "soreceive 4");
+
+716 
+	`SBLASTMBUFCHK
+(&
+so
+->
+so_rcv
+, "soreceive 4");
+
+717 i(
+
+->
+_ags
+ & 
+PR_WANTRCVD
+ && 
+so
+->
+so_pcb
+)
+
+718 (*
+
+->
+_uqs
+->
+_rcvd
+)(
+so
+, 
+ags
+, 
+cuwp
+);
+
+719 i(*
+mp0
+ =
+NULL
+ && (
+ags
+ & 
+MSG_EOR
+) == 0 &&
+
+720 (
+so
+->
+so_e
+ & 
+SS_CANTRCVMORE
+) == 0) {
+
+721 
+	`sbuock
+(&
+so
+->
+so_rcv
+);
+
+722 
+t
+;
+
+725 
+a
+:
+
+726 
+	`sbuock
+(&
+so
+->
+so_rcv
+);
+
+727  
+r
+;
+
+728 
+	}
+}
+
+730 
+sock
+ *
+
+731 
+	$g_cf
+(
+g_soc
+ *
+sc
+, c 
+g_sm
+ *
+wsm
+)
+
+733 
+i
+ *
+i
+ = &
+sc
+->
+sc_if
+;
+
+735 
+	`GRE_DPRINTF
+(
+sc
+, "enter\n");
+
+737 
+shutdown
+:
+
+738 i(
+sc
+->
+sc_sm
+.
+_so
+ !
+NULL
+) {
+
+739 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+740 
+	`g_up_move
+(
+sc
+->
+sc_sm
+.
+_so
+);
+
+741 
+	`sot_diablish
+(
+sc
+->
+sc_si
+);
+
+742 
+sc
+->
+sc_si
+ = 
+NULL
+;
+
+743 
+	`g__nd
+(
+sc
+, 
+GRE_M_DELFP
+, 
+NULL
+);
+
+744 
+	`g_rcf
+(&
+sc
+->
+sc_sm
+, 
+l
+);
+
+747 i(
+wsm
+ !
+NULL
+) {
+
+748 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+749 
+sc
+->
+sc_sm
+ = *
+wsm
+;
+
+750 
+wsm
+ = 
+NULL
+;
+
+753 i(
+sc
+->
+sc_sm
+.
+_so
+ !
+NULL
+) {
+
+754 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+755 
+sc
+->
+sc_si
+ = 
+	`sot_eablish
+(
+SOFTINT_NET
+, 
+g
+, sc);
+
+756 
+	`g_up_add
+(
+sc
+->
+sc_sm
+.
+_so
+, sc);
+
+757 i((
+i
+->
+if_ags
+ & 
+IFF_UP
+) == 0) {
+
+758 
+	`GRE_DPRINTF
+(
+sc
+, "down\n");
+
+759 
+shutdown
+;
+
+763 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+764 i(
+sc
+->
+sc_sm
+.
+_so
+ !
+NULL
+)
+
+765 
+sc
+->
+sc_if
+.
+if_ags
+ |
+IFF_RUNNING
+;
+
+767 
+	`g_bufq_purge
+(&
+sc
+->
+sc_d
+);
+
+768 
+sc
+->
+sc_if
+.
+if_ags
+ &~
+IFF_RUNNING
+;
+
+770  
+sc
+->
+sc_sm
+.
+_so
+;
+
+771 
+	}
+}
+
+774 
+	$g_put
+(
+g_soc
+ *
+sc
+, 
+mbuf
+ *
+m
+, 
+hn
+,
+
+775 c 
+g_h
+ *
+gh
+)
+
+777 
+pktqueue_t
+ *
+pktq
+ = 
+NULL
+;
+
+778 
+ifqueue
+ *
+ifq
+ = 
+NULL
+;
+
+779 
+ut16_t
+ 
+ags
+;
+
+780 
+ut32_t
+ 
+af
+;
+
+781 
+i
+ = 0, 
+s
+;
+
+783 
+sc
+->
+sc_if
+.
+if_acks
+++;
+
+784 
+sc
+->
+sc_if
+.
+if_ibys
+ +
+m
+->
+m_pkthdr
+.
+n
+;
+
+786 
+hn
+ +(
+g_h
+);
+
+789 
+ags
+ = 
+	`ohs
+(
+gh
+->flags);
+
+792 i((
+ags
+ & 
+GRE_CP
+| (ag& 
+GRE_RP
+))
+
+793 
+hn
+ += 4;
+
+795 i(
+ags
+ & 
+GRE_RP
+) {
+
+796 
+sc
+->
+sc_if
+.
+if_s
+++;
+
+799 i(
+ags
+ & 
+GRE_KP
+)
+
+800 
+hn
+ += 4;
+
+801 i(
+ags
+ & 
+GRE_SP
+)
+
+802 
+hn
+ += 4;
+
+804 
+	`ohs
+(
+gh
+->
+y
+)) {
+
+805 #ifde
+INET
+
+
+806 
+ETHERTYPE_IP
+:
+
+807 
+pktq
+ = 
+_pktq
+;
+
+808 
+af
+ = 
+AF_INET
+;
+
+811 #ifde
+NETATALK
+
+
+812 
+ETHERTYPE_ATALK
+:
+
+813 
+ifq
+ = &
+q1
+;
+
+814 
+i
+ = 
+NETISR_ATALK
+;
+
+815 
+af
+ = 
+AF_APPLETALK
+;
+
+818 #ifde
+INET6
+
+
+819 
+ETHERTYPE_IPV6
+:
+
+820 
+pktq
+ = 
+6_pktq
+;
+
+821 
+af
+ = 
+AF_INET6
+;
+
+824 #ifde
+MPLS
+
+
+825 
+ETHERTYPE_MPLS
+:
+
+826 
+ifq
+ = &
+msq
+;
+
+827 
+i
+ = 
+NETISR_MPLS
+;
+
+828 
+af
+ = 
+AF_MPLS
+;
+
+832 
+	`GRE_DPRINTF
+(
+sc
+, "unhandledthertype 0x%04x\n",
+
+833 
+	`ohs
+(
+gh
+->
+y
+));
+
+834 
+sc
+->
+sc_if
+.
+if_nro
+++;
+
+838 i(
+hn
+ > 
+m
+->
+m_pkthdr
+.
+n
+) {
+
+839 
+	`m_m
+(
+m
+);
+
+840 
+sc
+->
+sc_if
+.
+if_s
+++;
+
+841  
+EINVAL
+;
+
+843 
+	`m_adj
+(
+m
+, 
+hn
+);
+
+845 
+	`bpf_mp_af
+(&
+sc
+->
+sc_if
+, 
+af
+, 
+m
+);
+
+847 
+m
+->
+m_pkthdr
+.
+rcvif
+ = &
+sc
+->
+sc_if
+;
+
+849 i(
+	`__edi_ue
+(
+pktq
+)) {
+
+850 i(
+	`__edi_l
+(!
+	`pktq_queue
+(
+pktq
+, 
+m
+, 0))) {
+
+851 
+	`m_m
+(
+m
+);
+
+856 
+s
+ = 
+	`
+();
+
+857 i(
+	`IF_QFULL
+(
+ifq
+)) {
+
+858 
+	`IF_DROP
+(
+ifq
+);
+
+859 
+	`m_m
+(
+m
+);
+
+861 
+	`IF_ENQUEUE
+(
+ifq
+, 
+m
+);
+
+864 
+	`schedti
+(
+i
+);
+
+865 
+	`lx
+(
+s
+);
+
+868 
+	}
+}
+
+875 
+	$g_ouut
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+, c 
+sockaddr
+ *
+d
+,
+
+876 
+y
+ *
+
+)
+
+878 
+r
+ = 0;
+
+879 
+g_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+880 
+g_h
+ *
+gh
+;
+
+881 
+ut16_t
+ 
+y
+ = 0;
+
+883 i((
+i
+->
+if_ags
+ & (
+IFF_UP
+|
+IFF_RUNNING
+)) != (IFF_UP|IFF_RUNNING)) {
+
+884 
+	`m_m
+(
+m
+);
+
+885 
+r
+ = 
+ENETDOWN
+;
+
+886 
+d
+;
+
+889 
+	`bpf_mp_af
+(
+i
+, 
+d
+->
+_my
+, 
+m
+);
+
+891 
+m
+->
+m_ags
+ &~(
+M_BCAST
+|
+M_MCAST
+);
+
+893 
+	`GRE_DPRINTF
+(
+sc
+, "d->_my=%d\n", 
+d
+->
+_my
+);
+
+894 
+d
+->
+_my
+) {
+
+895 #ifde
+INET
+
+
+896 
+AF_INET
+:
+
+900 
+y
+ = 
+	`hts
+(
+ETHERTYPE_IP
+);
+
+903 #ifde
+NETATALK
+
+
+904 
+AF_APPLETALK
+:
+
+905 
+y
+ = 
+	`hts
+(
+ETHERTYPE_ATALK
+);
+
+908 #ifde
+INET6
+
+
+909 
+AF_INET6
+:
+
+910 
+y
+ = 
+	`hts
+(
+ETHERTYPE_IPV6
+);
+
+914 
+	`IF_DROP
+(&
+i
+->
+if_d
+);
+
+915 
+	`m_m
+(
+m
+);
+
+916 
+r
+ = 
+EAFNOSUPPORT
+;
+
+917 
+d
+;
+
+920 #ifde
+MPLS
+
+
+921 i(
+
+ !
+NULL
+ && 
+	`_gg
+(rt) != NULL) {
+
+922 
+ms_shim
+ 
+msh
+;
+
+923 
+msh
+.
+s_addr
+ = 
+	`MPLS_GETSADDR
+(
+
+);
+
+924 i(
+msh
+.
+shim
+.
+b
+ !
+MPLS_LABEL_IMPLNULL
+)
+
+925 
+y
+ = 
+	`hts
+(
+ETHERTYPE_MPLS
+);
+
+929 
+	`M_PREPEND
+(
+m
+, (*
+gh
+), 
+M_DONTWAIT
+);
+
+931 i(
+m
+ =
+NULL
+) {
+
+932 
+	`IF_DROP
+(&
+i
+->
+if_d
+);
+
+933 
+r
+ = 
+ENOBUFS
+;
+
+934 
+d
+;
+
+937 
+gh
+ = 
+	`mtod
+(
+m
+, 
+g_h
+ *);
+
+938 
+gh
+->
+ags
+ = 0;
+
+939 
+gh
+->
+y
+ = 
+y
+;
+
+942 
+i
+->
+if_acks
+++;
+
+943 
+i
+->
+if_obys
+ +
+m
+->
+m_pkthdr
+.
+n
+;
+
+946 
+m
+->
+m_pkthdr
+.
+csum_ags
+ = 0;
+
+947 
+m
+->
+m_pkthdr
+.
+csum_da
+ = 0;
+
+950 i((
+r
+ = 
+	`g_bufq_queue
+(&
+sc
+->
+sc_d
+, 
+m
+)) != 0) {
+
+951 
+sc
+->
+sc_oow_ev
+.
+ev_cou
+++;
+
+952 
+	`m_m
+(
+m
+);
+
+954 
+	`sot_schedu
+(
+sc
+->
+sc_si
+);
+
+955 
+d
+:
+
+956 i(
+r
+)
+
+957 
+i
+->
+if_s
+++;
+
+958  
+r
+;
+
+959 
+	}
+}
+
+962 
+	$g_gsockme
+(
+sock
+ *
+so
+, 
+sockaddr
+ *
+m
+)
+
+964  (*
+so
+->
+so_o
+->
+_uqs
+->
+_sockaddr
+)(so, 
+m
+);
+
+965 
+	}
+}
+
+968 
+	$g_gme
+(
+sock
+ *
+so
+, 
+sockaddr
+ *
+m
+)
+
+970  (*
+so
+->
+so_o
+->
+_uqs
+->
+_addr
+)(so, 
+m
+);
+
+971 
+	}
+}
+
+974 
+	$g_gmes
+(
+sock
+ *
+so
+, 
+lwp
+ *
+l
+, 
+sockaddr_age
+ *
+c
+,
+
+975 
+sockaddr_age
+ *
+d
+)
+
+977 
+sockaddr_age
+ 
+ss
+;
+
+978 
+rc
+;
+
+980 
+	`sock
+(
+so
+);
+
+981 i((
+rc
+ = 
+	`g_gsockme
+(
+so
+, (
+sockaddr
+ *)&
+ss
+)) != 0)
+
+982 
+out
+;
+
+983 *
+c
+ = 
+ss
+;
+
+985 i((
+rc
+ = 
+	`g_gme
+(
+so
+, (
+sockaddr
+ *)&
+ss
+)) != 0)
+
+986 
+out
+;
+
+987 *
+d
+ = 
+ss
+;
+
+988 
+out
+:
+
+989 
+	`souock
+(
+so
+);
+
+990  
+rc
+;
+
+991 
+	}
+}
+
+994 
+	$g__cvlo
+(*
+g
+)
+
+996 
+g_soc
+ *
+sc
+ = 
+g
+;
+
+998 
+	`mux_r
+(&
+sc
+->
+sc_mtx
+);
+
+999 
+	`g__cv
+(
+sc
+))
+
+1001 
+	`mux_ex
+(&
+sc
+->
+sc_mtx
+);
+
+1002 
+	`kthad_ex
+(0);
+
+1003 
+	}
+}
+
+1005 
+bo
+
+
+1006 
+	$g__cv
+(
+g_soc
+ *
+sc
+)
+
+1008 
+fd
+, 
+ofd
+, 
+rc
+;
+
+1009 
+fe_t
+ *
+
+;
+
+1011 
+
+ = 
+sc
+->
+sc_
+;
+
+1012 
+ofd
+ = 
+sc
+->
+sc_fd
+;
+
+1013 
+fd
+ = -1;
+
+1015 
+sc
+->
+sc_msg
+) {
+
+1016 
+GRE_M_STOP
+:
+
+1017 
+	`cv_sigl
+(&
+sc
+->
+sc__cdv
+);
+
+1018  
+l
+;
+
+1019 
+GRE_M_SETFP
+:
+
+1020 
+	`mux_ex
+(&
+sc
+->
+sc_mtx
+);
+
+1021 
+rc
+ = 
+	`fd_dup
+(
+
+, 0, &
+fd
+, 0);
+
+1022 
+	`mux_r
+(&
+sc
+->
+sc_mtx
+);
+
+1023 i(
+rc
+ != 0) {
+
+1024 
+sc
+->
+sc_msg
+ = 
+GRE_M_ERR
+;
+
+1028 
+GRE_M_DELFP
+:
+
+1029 
+	`mux_ex
+(&
+sc
+->
+sc_mtx
+);
+
+1030 i(
+ofd
+ !-1 && 
+	`fd_gfe
+(ofd!
+NULL
+)
+
+1031 
+	`fd_o
+(
+ofd
+);
+
+1032 
+	`mux_r
+(&
+sc
+->
+sc_mtx
+);
+
+1033 
+sc
+->
+sc_fd
+ = 
+fd
+;
+
+1034 
+sc
+->
+sc_msg
+ = 
+GRE_M_OK
+;
+
+1037 
+	`g__wa
+(
+sc
+);
+
+1038  
+ue
+;
+
+1040 
+	`cv_sigl
+(&
+sc
+->
+sc__cdv
+);
+
+1041  
+ue
+;
+
+1042 
+	}
+}
+
+1044 
+bo
+
+
+1045 
+	$g__nd
+(
+g_soc
+ *
+sc
+, 
+g_msg
+ 
+msg
+, 
+fe_t
+ *
+
+)
+
+1047 
+bo
+ 
+rc
+;
+
+1049 
+	`mux_r
+(&
+sc
+->
+sc_mtx
+);
+
+1050 
+sc
+->
+sc_msg
+ !
+GRE_M_NONE
+)
+
+1051 
+	`g__wa
+(
+sc
+);
+
+1052 
+sc
+->
+sc_
+ = 
+
+;
+
+1053 
+sc
+->
+sc_msg
+ = 
+msg
+;
+
+1054 
+	`cv_sigl
+(&
+sc
+->
+sc__cdv
+);
+
+1055 
+sc
+->
+sc_msg
+ !
+GRE_M_STOP
+ && sc->sc_msg !
+GRE_M_OK
+ &&
+
+1056 
+sc
+->
+sc_msg
+ !
+GRE_M_ERR
+)
+
+1057 
+	`g__wa
+(
+sc
+);
+
+1058 
+rc
+ = (
+sc
+->
+sc_msg
+ !
+GRE_M_ERR
+);
+
+1059 
+sc
+->
+sc_msg
+ = 
+GRE_M_NONE
+;
+
+1060 
+	`cv_sigl
+(&
+sc
+->
+sc__cdv
+);
+
+1061 
+	`mux_ex
+(&
+sc
+->
+sc_mtx
+);
+
+1062  
+rc
+;
+
+1063 
+	}
+}
+
+1066 
+	$g_ssock
+(
+i
+ *
+i
+, 
+g_sm
+ *
+
+, 
+fd
+)
+
+1068 
+r
+ = 0;
+
+1069 c 
+osw
+ *
+
+;
+
+1070 
+fe_t
+ *
+
+;
+
+1071 
+g_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+1072 
+sock
+ *
+so
+;
+
+1073 
+sockaddr_age
+ 
+d
+, 
+c
+;
+
+1075 i((
+
+ = 
+	`fd_gfe
+(
+fd
+)=
+NULL
+)
+
+1076  
+EBADF
+;
+
+1077 i(
+
+->
+f_ty
+ !
+DTYPE_SOCKET
+) {
+
+1078 
+	`fd_putfe
+(
+fd
+);
+
+1079  
+ENOTSOCK
+;
+
+1082 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+1084 
+so
+ = 
+
+->
+f_sock
+;
+
+1085 
+
+ = 
+so
+->
+so_o
+;
+
+1087 
+	`GRE_DPRINTF
+(
+sc
+, "ty %d,r%d\n", 
+
+->
+_ty
+,r->
+_oc
+);
+
+1089 i((
+
+->
+_ags
+ & 
+PR_ATOMIC
+) == 0 ||
+
+1090 (
+
+->
+_ty
+ !0 && 
+
+->
+_ty
+ != sp->sp_type) ||
+
+1091 (
+
+->
+_o
+ !0 && 
+
+->
+_oc
+ != 0 &&
+
+1092 
+
+->
+_oc
+ !
+
+->
+_o
+)) {
+
+1093 
+r
+ = 
+EINVAL
+;
+
+1094 
+r
+;
+
+1097 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+1100 i((
+r
+ = 
+	`g_gmes
+(
+so
+, 
+cuwp
+, &
+c
+, &
+d
+)) != 0)
+
+1101 
+r
+;
+
+1103 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+1105 i(!
+	`g__nd
+(
+sc
+, 
+GRE_M_SETFP
+, 
+
+)) {
+
+1106 
+r
+ = 
+EBUSY
+;
+
+1107 
+r
+;
+
+1110 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+1112 
+
+->
+_c
+ = 
+c
+;
+
+1113 
+
+->
+_d
+ = 
+d
+;
+
+1115 
+
+->
+_so
+ = 
+so
+;
+
+1117 
+r
+:
+
+1118 
+	`fd_putfe
+(
+fd
+);
+
+1119  
+r
+;
+
+1120 
+	}
+}
+
+1122 
+bo
+
+
+1123 
+	$sockaddr_is_yaddr
+(c 
+sockaddr
+ *
+
+)
+
+1125 
+sockn_t
+ 
+yn
+, 
+n
+;
+
+1126 c *
+yaddr
+, *
+addr
+;
+
+1128 i((
+yaddr
+ = 
+	`sockaddr_yaddr
+(
+
+, &
+yn
+)=
+NULL
+ ||
+
+1129 (
+addr
+ = 
+	`sockaddr_c_addr
+(
+
+, &
+n
+)=
+NULL
+)
+
+1130  
+l
+;
+
+1132 i(
+n
+ > 
+yn
+)
+
+1133  
+l
+;
+
+1135  
+	`memcmp
+(
+yaddr
+, 
+addr
+, 
+	`MIN
+(
+yn
+, 
+n
+)) == 0;
+
+1136 
+	}
+}
+
+1138 
+bo
+
+
+1139 
+	$g_is_nucf
+(c 
+g_sm
+ *
+
+)
+
+1141  
+	`sockaddr_is_yaddr
+(
+	`soc
+(&
+
+->
+_c
+)) ||
+
+1142 
+	`sockaddr_is_yaddr
+(
+	`soc
+(&
+
+->
+_d
+));
+
+1143 
+	}
+}
+
+1146 
+	$g_rcf
+(
+g_sm
+ *
+
+, 
+bo
+ 
+f
+)
+
+1148 i(
+
+->
+_bysock
+ || 
+f
+) {
+
+1149 
+	`sockaddr_cy
+(
+	`so
+(&
+
+->
+_c
+), (sp->sp_src),
+
+1150 
+	`sockaddr_y
+(
+	`so
+(&
+
+->
+_c
+)));
+
+1151 
+	`sockaddr_cy
+(
+	`so
+(&
+
+->
+_d
+), (sp->sp_dst),
+
+1152 
+	`sockaddr_y
+(
+	`so
+(&
+
+->
+_d
+)));
+
+1153 
+
+->
+_bysock
+ = 
+l
+;
+
+1155 
+
+->
+_so
+ = 
+NULL
+;
+
+1156 
+	}
+}
+
+1159 
+	$g_iol
+(
+i
+ *
+i
+, c 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+1161 
+ieq
+ *
+i
+;
+
+1162 
+iddr
+ *
+i
+ = (idd*)
+da
+;
+
+1163 
+if_ddeq
+ *
+li
+ = (if_ddeq *)
+da
+;
+
+1164 
+g_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+1165 
+g_sm
+ *
+
+;
+
+1166 
+fd
+, 
+r
+ = 0, 
+ro
+, 
+y
+, 
+s
+;
+
+1167 
+g_sm
+ 
+0
+;
+
+1169 
+i
+ = 
+da
+;
+
+1171 
+	`GRE_DPRINTF
+(
+sc
+, "cmd %lu\n", 
+cmd
+);
+
+1173 
+cmd
+) {
+
+1174 
+GRESPROTO
+:
+
+1175 
+GRESADDRD
+:
+
+1176 
+GRESADDRS
+:
+
+1177 
+GRESSOCK
+:
+
+1178 
+GREDSOCK
+:
+
+1179 i(
+	`kauth_authize_twk
+(
+cuwp
+->
+l_ed
+,
+
+1180 
+KAUTH_NETWORK_INTERFACE
+,
+
+1181 
+KAUTH_REQ_NETWORK_INTERFACE_SETPRIV
+, 
+i
+, (*)
+cmd
+,
+
+1182 
+NULL
+) != 0)
+
+1183  
+EPERM
+;
+
+1189 
+s
+ = 
+	`
+();
+
+1191 
+0
+ = 
+sc
+->
+sc_sm
+;
+
+1192 
+0
+.
+_so
+ = 
+NULL
+;
+
+1193 
+
+ = &
+0
+;
+
+1195 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+1197 
+cmd
+) {
+
+1198 
+SIOCINITIFADDR
+:
+
+1199 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+1200 i((
+i
+->
+if_ags
+ & 
+IFF_UP
+) != 0)
+
+1202 
+	`g_rcf
+(
+
+, 
+l
+);
+
+1203 
+i
+->
+if_ags
+ |
+IFF_UP
+;
+
+1204 
+i
+->
+i_que
+ = 
+p2p_que
+;
+
+1205 
+mksock
+;
+
+1206 
+SIOCSIFFLAGS
+:
+
+1207 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)) != 0)
+
+1209 
+ro
+ = 
+
+->
+_o
+;
+
+1210 
+y
+ = 
+
+->
+_ty
+;
+
+1211 
+i
+->
+i_ags
+ & (
+IFF_LINK0
+|
+IFF_LINK2
+)) {
+
+1212 
+IFF_LINK0
+|
+IFF_LINK2
+:
+
+1213 
+
+->
+_o
+ = 
+IPPROTO_UDP
+;
+
+1214 
+
+->
+_ty
+ = 
+SOCK_DGRAM
+;
+
+1216 
+IFF_LINK2
+:
+
+1217 
+
+->
+_o
+ = 0;
+
+1218 
+
+->
+_ty
+ = 0;
+
+1220 
+IFF_LINK0
+:
+
+1221 
+
+->
+_o
+ = 
+IPPROTO_GRE
+;
+
+1222 
+
+->
+_ty
+ = 
+SOCK_RAW
+;
+
+1225 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+1226 
+r
+ = 
+EINVAL
+;
+
+1227 
+out
+;
+
+1229 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+1230 
+	`g_rcf
+(
+
+, 
+l
+);
+
+1231 i((
+i
+->
+if_ags
+ & (
+IFF_UP
+|
+IFF_RUNNING
+)) ==
+
+1232 (
+IFF_UP
+|
+IFF_RUNNING
+) &&
+
+1233 (
+ro
+ =
+
+->
+_o
+ || sp->sp_proto == 0) &&
+
+1234 (
+y
+ =
+
+->
+_ty
+ || sp->sp_type == 0))
+
+1236 
+
+->
+_o
+) {
+
+1237 
+IPPROTO_UDP
+:
+
+1238 
+IPPROTO_GRE
+:
+
+1239 
+mksock
+;
+
+1244 
+SIOCSIFMTU
+:
+
+1248 i(
+i
+->
+i_mtu
+ < 576) {
+
+1249 
+r
+ = 
+EINVAL
+;
+
+1253 
+SIOCGIFMTU
+:
+
+1254 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)=
+ENETRESET
+)
+
+1255 
+r
+ = 0;
+
+1257 
+SIOCADDMULTI
+:
+
+1258 
+SIOCDELMULTI
+:
+
+1259 i(
+i
+ =
+NULL
+) {
+
+1260 
+r
+ = 
+EAFNOSUPPORT
+;
+
+1263 
+	`ieq_gaddr
+(
+cmd
+, 
+i
+)->
+_my
+) {
+
+1264 #ifde
+INET
+
+
+1265 
+AF_INET
+:
+
+1268 #ifde
+INET6
+
+
+1269 
+AF_INET6
+:
+
+1273 
+r
+ = 
+EAFNOSUPPORT
+;
+
+1277 
+GRESPROTO
+:
+
+1278 
+	`g_rcf
+(
+
+, 
+l
+);
+
+1279 
+ro
+ = 
+
+->
+_o
+;
+
+1280 
+y
+ = 
+
+->
+_ty
+;
+
+1281 
+
+->
+_o
+ = 
+i
+->
+i_ags
+;
+
+1282 
+
+->
+_o
+) {
+
+1283 
+IPPROTO_UDP
+:
+
+1284 
+i
+->
+if_ags
+ |
+IFF_LINK0
+|
+IFF_LINK2
+;
+
+1285 
+
+->
+_ty
+ = 
+SOCK_DGRAM
+;
+
+1287 
+IPPROTO_GRE
+:
+
+1288 
+i
+->
+if_ags
+ |
+IFF_LINK0
+;
+
+1289 
+i
+->
+if_ags
+ &~
+IFF_LINK2
+;
+
+1290 
+
+->
+_ty
+ = 
+SOCK_RAW
+;
+
+1293 
+i
+->
+if_ags
+ &~
+IFF_LINK0
+;
+
+1294 
+i
+->
+if_ags
+ |
+IFF_LINK2
+;
+
+1295 
+
+->
+_ty
+ = 0;
+
+1298 
+r
+ = 
+EPROTONOSUPPORT
+;
+
+1301 i((
+ro
+ =
+
+->
+_o
+ || sp->sp_proto == 0) &&
+
+1302 (
+y
+ =
+
+->
+_ty
+ || sp->sp_type == 0))
+
+1304 
+
+->
+_o
+) {
+
+1305 
+IPPROTO_UDP
+:
+
+1306 
+IPPROTO_GRE
+:
+
+1307 
+mksock
+;
+
+1312 
+GREGPROTO
+:
+
+1313 
+i
+->
+i_ags
+ = 
+
+->
+_o
+;
+
+1315 
+GRESADDRS
+:
+
+1316 
+GRESADDRD
+:
+
+1317 
+	`g_rcf
+(
+
+, 
+l
+);
+
+1319 
+cmd
+) {
+
+1320 
+GRESADDRS
+:
+
+1321 
+	`sockaddr_cy
+(
+	`so
+(&
+
+->
+_c
+),
+
+1322 (
+
+->
+_c
+), 
+	`ieq_gaddr
+(
+cmd
+, 
+i
+));
+
+1324 
+GRESADDRD
+:
+
+1325 
+	`sockaddr_cy
+(
+	`so
+(&
+
+->
+_d
+),
+
+1326 (
+
+->
+_d
+), 
+	`ieq_gaddr
+(
+cmd
+, 
+i
+));
+
+1329 
+checkaddr
+:
+
+1330 i(
+	`sockaddr_y
+(
+	`so
+(&
+
+->
+_c
+)=
+NULL
+ ||
+
+1331 
+	`sockaddr_y
+(
+	`so
+(&
+
+->
+_d
+)=
+NULL
+) {
+
+1332 
+r
+ = 
+EINVAL
+;
+
+1336 
+mksock
+:
+
+1337 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+1341 i((
+i
+->
+if_ags
+ & 
+IFF_UP
+=0 || 
+	`g_is_nucf
+(
+
+))
+
+1342 
+ndcf
+;
+
+1344 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+1345 
+fd
+ = 0;
+
+1346 
+r
+ = 
+	`g_so
+(
+sc
+, 
+
+, &
+fd
+);
+
+1347 i(
+r
+ != 0)
+
+1350 
+tsock
+:
+
+1351 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+1353 
+r
+ = 
+	`g_ssock
+(
+i
+, 
+
+, 
+fd
+);
+
+1355 i(
+cmd
+ !
+GRESSOCK
+) {
+
+1356 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+1358 i(
+	`fd_gfe
+(
+fd
+!
+NULL
+)
+
+1359 
+	`fd_o
+(
+fd
+);
+
+1362 i(
+r
+ == 0) {
+
+1363 
+ndcf
+:
+
+1364 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+1365 
+i
+->
+if_ags
+ &~
+IFF_RUNNING
+;
+
+1366 
+	`g_cf
+(
+sc
+, 
+
+);
+
+1370 
+GREGADDRS
+:
+
+1371 
+	`ieq_ddr
+(
+cmd
+, 
+i
+, 
+	`so
+(&
+
+->
+_c
+));
+
+1373 
+GREGADDRD
+:
+
+1374 
+	`ieq_ddr
+(
+cmd
+, 
+i
+, 
+	`so
+(&
+
+->
+_d
+));
+
+1376 
+GREDSOCK
+:
+
+1377 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+1378 i(
+
+->
+_bysock
+)
+
+1379 
+i
+->
+if_ags
+ &~
+IFF_UP
+;
+
+1380 
+	`g_rcf
+(
+
+, 
+l
+);
+
+1381 
+mksock
+;
+
+1382 
+GRESSOCK
+:
+
+1383 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+1384 
+	`g_rcf
+(
+
+, 
+ue
+);
+
+1385 
+fd
+ = ()
+i
+->
+i_vue
+;
+
+1386 
+
+->
+_bysock
+ = 
+ue
+;
+
+1387 
+i
+->
+if_ags
+ |
+IFF_UP
+;
+
+1388 
+tsock
+;
+
+1389 
+SIOCSLIFPHYADDR
+:
+
+1390 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+1391 i(
+li
+->
+addr
+.
+ss_my
+ !li->
+daddr
+.ss_family) {
+
+1392 
+r
+ = 
+EAFNOSUPPORT
+;
+
+1395 
+	`sockaddr_cy
+(
+	`so
+(&
+
+->
+_c
+), (sp->sp_src),
+
+1396 
+	`so
+(&
+li
+->
+addr
+));
+
+1397 
+	`sockaddr_cy
+(
+	`so
+(&
+
+->
+_d
+), (sp->sp_dst),
+
+1398 
+	`so
+(&
+li
+->
+daddr
+));
+
+1399 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+1400 
+checkaddr
+;
+
+1401 
+SIOCDIFPHYADDR
+:
+
+1402 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+1403 
+	`g_rcf
+(
+
+, 
+ue
+);
+
+1404 
+i
+->
+if_ags
+ &~
+IFF_UP
+;
+
+1405 
+mksock
+;
+
+1406 
+SIOCGLIFPHYADDR
+:
+
+1407 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+1408 i(
+	`g_is_nucf
+(
+
+)) {
+
+1409 
+r
+ = 
+EADDRNOTAVAIL
+;
+
+1412 
+	`sockaddr_cy
+(
+	`so
+(&
+li
+->
+addr
+), (lifr->addr),
+
+1413 
+	`so
+(&
+
+->
+_c
+));
+
+1414 
+	`sockaddr_cy
+(
+	`so
+(&
+li
+->
+daddr
+), (lifr->dstaddr),
+
+1415 
+	`so
+(&
+
+->
+_d
+));
+
+1416 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+1419 
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+);
+
+1422 
+out
+:
+
+1423 
+	`GRE_DPRINTF
+(
+sc
+, "\n");
+
+1424 
+	`lx
+(
+s
+);
+
+1425  
+r
+;
+
+1426 
+	}
+}
+
+1428 
+gch
+();
+
+1432 
+	$gch
+(
+cou
+)
+
+1434 
+	`if_e_ch
+(&
+g_
+);
+
+1435 
+	}
+}
+
+	@if_gre.h
+
+38 #ide
+_NET_IF_GRE_H_
+
+
+39 
+	#_NET_IF_GRE_H_
+
+
+	)
+
+41 
+	~<sys/evt.h
+>
+
+42 
+	~<sys/queue.h
+>
+
+43 
+	~<sys/mux.h
+>
+
+44 
+	~<sys/cdv.h
+>
+
+45 
+	~<sys/mloc.h
+>
+
+46 
+	~<sys/mlocv.h
+>
+
+48 #ifde
+_KERNEL
+
+
+50 
+	~<sys/pcq.h
+>
+
+52 
+	sg_sm
+ {
+
+53 
+sock
+ *
+	m_so
+;
+
+54 
+sockaddr_age
+ 
+	m_c
+;
+
+55 
+sockaddr_age
+ 
+	m_d
+;
+
+56 
+	m_ty
+;
+
+57 
+	m_o
+;
+
+58 
+bo
+ 
+	m_bysock
+;
+
+63 
+	eg_e
+ {
+
+64 
+	mGRE_S_IDLE
+ = 0
+
+65 , 
+	mGRE_S_IOCTL
+
+
+66 , 
+	mGRE_S_DIE
+
+
+69 
+	sg_bufq
+ {
+
+70 
+pcq_t
+ *
+	mbq_q
+;
+
+71 v
+	mbq_drs
+;
+
+74 
+	eg_msg
+ {
+
+75 
+	mGRE_M_NONE
+ = 0
+
+76 , 
+	mGRE_M_SETFP
+
+
+77 , 
+	mGRE_M_DELFP
+
+
+78 , 
+	mGRE_M_STOP
+
+
+79 , 
+	mGRE_M_OK
+
+
+80 , 
+	mGRE_M_ERR
+
+
+83 
+	sg_soc
+ {
+
+84 
+i
+ 
+	msc_if
+;
+
+85 
+kmux_t
+ 
+	msc_mtx
+;
+
+86 
+kcdv_t
+ 
+	msc_cdv
+;
+
+87 
+kcdv_t
+ 
+	msc__cdv
+;
+
+88 
+g_bufq
+ 
+	msc_d
+;
+
+89 
+g_sm
+ 
+	msc_sm
+;
+
+90 v
+g_e
+ 
+	msc_e
+;
+
+91 v
+	msc_was
+;
+
+92 v
+	msc__was
+;
+
+93 *
+	msc_si
+;
+
+95 
+evt
+ 
+	msc_cv_ev
+;
+
+96 
+evt
+ 
+	msc_nd_ev
+;
+
+98 
+evt
+ 
+	msc_block_ev
+;
+
+99 
+evt
+ 
+	msc_r_ev
+;
+
+100 
+evt
+ 
+	msc_puup_ev
+;
+
+101 
+evt
+ 
+	msc_unsu_ev
+;
+
+102 
+evt
+ 
+	msc_oow_ev
+;
+
+103 
+fe_t
+ * v
+	msc_
+;
+
+104 v
+g_msg
+ 
+	msc_msg
+;
+
+105 
+	msc_fd
+;
+
+108 
+	sg_h
+ {
+
+109 
+ut16_t
+ 
+	mags
+;
+
+110 
+ut16_t
+ 
+	my
+;
+
+132 } 
+	g__cked
+;
+
+134 
+	#GRE_CP
+ 0x8000
+
+	)
+
+135 
+	#GRE_RP
+ 0x4000
+
+	)
+
+136 
+	#GRE_KP
+ 0x2000
+
+	)
+
+137 
+	#GRE_SP
+ 0x1000
+
+	)
+
+138 
+	#GRE_SS
+ 0x0800
+
+	)
+
+144 
+	sg_e
+ {
+
+145 
+ut16_t
+ 
+	me_my
+;
+
+146 
+u_ch
+ 
+	me_offt
+;
+
+147 
+u_ch
+ 
+	me_ngth
+;
+
+149 
+u_ch
+ *
+	me_fo
+;
+
+152 
+	#GRE_TTL
+ 30
+
+	)
+
+153 
+_g_l
+;
+
+160 
+	#GRESADDRS
+ 
+	`_IOW
+('i', 101, 
+ieq
+)
+
+	)
+
+161 
+	#GRESADDRD
+ 
+	`_IOW
+('i', 102, 
+ieq
+)
+
+	)
+
+162 
+	#GREGADDRS
+ 
+	`_IOWR
+('i', 103, 
+ieq
+)
+
+	)
+
+163 
+	#GREGADDRD
+ 
+	`_IOWR
+('i', 104, 
+ieq
+)
+
+	)
+
+164 
+	#GRESPROTO
+ 
+	`_IOW
+('i' , 105, 
+ieq
+)
+
+	)
+
+165 
+	#GREGPROTO
+ 
+	`_IOWR
+('i', 106, 
+ieq
+)
+
+	)
+
+166 
+	#GRESSOCK
+ 
+	`_IOW
+('i' , 107, 
+ieq
+)
+
+	)
+
+167 
+	#GREDSOCK
+ 
+	`_IOW
+('i' , 108, 
+ieq
+)
+
+	)
+
+	@if_hippi.h
+
+33 #ide
+_NET_IF_HIPPI_H_
+
+
+34 
+	#_NET_IF_HIPPI_H_
+
+
+	)
+
+36 
+	~<t/if_h.h
+>
+
+38 
+	shpi_
+ {
+
+39 
+ut8_t
+ 
+	m_u
+;
+
+40 
+ut8_t
+ 
+	m_ags
+;
+
+41 
+	#HIPPI_FP_D1_PRESENT
+ 0x80
+
+	)
+
+42 
+	#HIPPI_FP_D2_ON_BURST
+ 0x40
+
+	)
+
+43 
+ut16_t
+ 
+	m_offts
+;
+
+44 
+	#HIPPI_FP_D2_MASK
+ 0x07
+
+	)
+
+45 
+ut32_t
+ 
+	m_d2_n
+;
+
+46 } 
+	g__cked
+;
+
+48 
+	shpi_
+ {
+
+49 
+ut32_t
+ 
+	m_de_swch
+;
+
+50 
+ut32_t
+ 
+	m_c_swch
+;
+
+51 
+ut16_t
+ 
+	m_rved
+;
+
+52 
+ut8_t
+ 
+	m_de_addr
+[6];
+
+53 
+ut16_t
+ 
+	m_lol_adm
+;
+
+54 
+ut8_t
+ 
+	m_c_addr
+[6];
+
+55 } 
+	g__cked
+;
+
+57 
+	shpi_hd
+ {
+
+58 
+hpi_
+ 
+	mhi_
+;
+
+59 
+hpi_
+ 
+	mhi_
+;
+
+60 } 
+	g__cked
+;
+
+62 
+	#HIPPI_HDRLEN
+ ((
+hpi_hd
+))
+
+	)
+
+66 
+	#HIPPI_ULP_802
+ 4
+
+	)
+
+67 
+	#HIPPI_ULP_IPI3_SLAVE
+ 5
+
+	)
+
+68 
+	#HIPPI_ULP_IPI3_MASTER
+ 6
+
+	)
+
+69 
+	#HIPPI_ULP_IPI3_PEER
+ 7
+
+	)
+
+73 
+	#HIPPIMTU
+ 65280
+
+	)
+
+76 #ifde
+_KERNEL
+
+
+77 
+hpi_iach
+(
+i
+ *, *);
+
+78 
+hpi__put
+(
+i
+ *, 
+mbuf
+ *);
+
+	@if_hippisubr.c
+
+32 
+	~<sys/cdefs.h
+>
+
+33 
+__KERNEL_RCSID
+(0, "$NetBSD: if_hippisubr.c,v 1.42 2015/05/20 09:17:18 ozaki-r Exp $");
+
+35 
+	~"t_.h
+"
+
+38 
+	~<sys/m.h
+>
+
+39 
+	~<sys/sym.h
+>
+
+40 
+	~<sys/kl.h
+>
+
+41 
+	~<sys/mloc.h
+>
+
+42 
+	~<sys/mbuf.h
+>
+
+43 
+	~<sys/osw.h
+>
+
+44 
+	~<sys/sock.h
+>
+
+45 
+	~<sys/iol.h
+>
+
+46 
+	~<sys/o.h
+>
+
+47 
+	~<sys/syog.h
+>
+
+49 
+	~<sys/u.h
+>
+
+51 
+	~<t/if.h
+>
+
+52 
+	~<t/ti.h
+>
+
+53 
+	~<t/rou.h
+>
+
+54 
+	~<t/if_c.h
+>
+
+55 
+	~<t/if_dl.h
+>
+
+56 
+	~<t/if_tys.h
+>
+
+58 
+	~<t/bpf.h
+>
+
+60 
+	~<t/if_hpi.h
+>
+
+62 
+	~<t/.h
+>
+
+63 #i
+defed
+(
+INET
+|| defed(
+INET6
+)
+
+64 
+	~<t/_v.h
+>
+
+67 
+	#ndr
+(
+e
+{ 
+r
+ = (e); 
+bad
+;}
+
+	)
+
+69 #ide
+c_
+
+
+70 
+	#c_
+ 
+c_un
+.
+ty_
+
+
+	)
+
+73 
+hpi_ouut
+(
+i
+ *, 
+mbuf
+ *,
+
+74 c 
+sockaddr
+ *, 
+y
+ *);
+
+75 
+hpi_put
+(
+i
+ *, 
+mbuf
+ *);
+
+85 
+	$hpi_ouut
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m0
+, c 
+sockaddr
+ *
+d
+,
+
+86 
+y
+ *
+0
+)
+
+88 
+ut16_t
+ 
+hty
+;
+
+89 
+ut32_t
+ 
+ifld
+ = 0;
+
+90 
+r
+ = 0;
+
+91 
+mbuf
+ *
+m
+ = 
+m0
+;
+
+92 
+y
+ *
+
+;
+
+93 
+hpi_hd
+ *
+hh
+;
+
+94 
+ut32_t
+ *
+cci
+;
+
+95 
+ut32_t
+ 
+d2_n
+;
+
+96 
+	`ALTQ_DECL
+(
+tq_pkr
+ 
+pkr
+;)
+
+98 i((
+i
+->
+if_ags
+ & (
+IFF_UP
+|
+IFF_RUNNING
+)) != (IFF_UP|IFF_RUNNING))
+
+99 
+	`ndr
+(
+ENETDOWN
+);
+
+102 i(
+m
+->
+m_ags
+ & (
+M_BCAST
+ | 
+M_MCAST
+))
+
+103 
+	`ndr
+(
+EOPNOTSUPP
+);
+
+105 i((
+
+ = 
+0
+!
+NULL
+) {
+
+106 i((
+
+->
+_ags
+ & 
+RTF_UP
+) == 0) {
+
+107 i((
+0
+ = 
+
+ = 
+	`loc1
+(
+d
+, 1)!
+NULL
+) {
+
+108 
+
+->
+_ft
+--;
+
+109 i(
+
+->
+_i
+ !
+i
+)
+
+110  (*
+
+->
+_i
+->
+if_ouut
+)
+
+111 (
+i
+, 
+m0
+, 
+d
+, 
+
+);
+
+113 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+115 i((
+
+->
+_ags
+ & 
+RTF_GATEWAY
+)) {
+
+116 i(
+
+->
+_gwrou
+ == 0)
+
+117 
+lookup
+;
+
+118 i(((
+
+ =t->
+_gwrou
+)->
+_ags
+ & 
+RTF_UP
+) == 0) {
+
+119 
+	`
+(
+
+);
+0
+;
+
+120 
+lookup
+: 
+
+->
+_gwrou
+ = 
+	`loc1
+t->
+_geway
+, 1);
+
+121 i((
+
+ =t->
+_gwrou
+) == 0)
+
+122 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+124 i((
+
+->
+_ags
+ & 
+RTF_GATEWAY
+) ||
+
+125 (
+
+->
+_i
+ !
+i
+)) {
+
+126 
+
+->
+_ft
+--;
+
+127 
+0
+->
+_gwrou
+ = 0;
+
+128 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+132 i(
+
+->
+_ags
+ & 
+RTF_REJECT
+)
+
+133 i(
+
+->
+_rmx
+.
+rmx_expe
+ == 0 ||
+
+134 
+time_cd
+ < 
+
+->
+_rmx
+.
+rmx_expe
+)
+
+135 
+	`ndr
+(
+
+ =
+0
+ ? 
+EHOSTDOWN
+ : 
+EHOSTUNREACH
+);
+
+142 
+	`IFQ_CLASSIFY
+(&
+i
+->
+if_d
+, 
+m
+, 
+d
+->
+_my
+, &
+pkr
+);
+
+144 
+d
+->
+_my
+) {
+
+145 #ifde
+INET
+
+
+146 
+AF_INET
+:
+
+147 i(
+
+) {
+
+148 c 
+sockaddr_dl
+ *
+sdl
+ =
+
+149 
+	`tocsdl
+(
+
+->
+_geway
+);
+
+150 i(
+sdl
+->
+sdl_my
+ =
+AF_LINK
+ && sdl->
+sdl_
+ != 0)
+
+151 
+	`memy
+(&
+ifld
+, 
+	`CLLADDR
+(
+sdl
+), (ifield));
+
+153 i(!
+ifld
+)
+
+154 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+155 
+hty
+ = 
+	`hts
+(
+ETHERTYPE_IP
+);
+
+159 #ifde
+INET6
+
+
+160 
+AF_INET6
+:
+
+161 i(
+
+) {
+
+162 c 
+sockaddr_dl
+ *
+sdl
+ =
+
+163 
+	`tocsdl
+(
+
+->
+_geway
+);
+
+164 i(
+sdl
+->
+sdl_my
+ =
+AF_LINK
+ && sdl->
+sdl_
+ != 0)
+
+165 
+	`memy
+(&
+ifld
+, 
+	`CLLADDR
+(
+sdl
+), (ifield));
+
+167 i(!
+ifld
+)
+
+168 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+169 
+hty
+ = 
+	`hts
+(
+ETHERTYPE_IPV6
+);
+
+174 
+	`tf
+("%s: c'hdf%d\n", 
+i
+->
+if_xme
+,
+
+175 
+d
+->
+_my
+);
+
+176 
+	`ndr
+(
+EAFNOSUPPORT
+);
+
+179 i(
+hty
+ != 0) {
+
+180 
+c
+ *
+l
+;
+
+181 
+	`M_PREPEND
+(
+m
+,  (
+c
+), 
+M_DONTWAIT
+);
+
+182 i(
+m
+ == 0)
+
+183 
+	`ndr
+(
+ENOBUFS
+);
+
+184 
+l
+ = 
+	`mtod
+(
+m
+, 
+c
+ *);
+
+185 
+l
+->
+c_c
+ = 
+LLC_UI
+;
+
+186 
+l
+->
+c_dp
+ =->
+c_sp
+ = 
+LLC_SNAP_LSAP
+;
+
+187 
+l
+->
+c_
+.
+g_code
+[0] =->llc_snap.org_code[1] =
+
+188 
+l
+->
+c_
+.
+g_code
+[2] = 0;
+
+189 
+	`memy
+((*&
+l
+->
+c_
+.
+h_ty
+, (*&
+hty
+,
+
+190 (
+ut16_t
+));
+
+193 
+d2_n
+ = 
+m
+->
+m_pkthdr
+.
+n
+;
+
+200 
+	`M_PREPEND
+(
+m
+,  (
+hpi_hd
++ 8, 
+M_DONTWAIT
+);
+
+201 i(
+m
+ == 0)
+
+202 
+	`ndr
+(
+ENOBUFS
+);
+
+203 
+cci
+ = 
+	`mtod
+(
+m
+, 
+ut32_t
+ *);
+
+204 
+	`memt
+(
+cci
+, 0, (
+hpi_hd
+) + 8);
+
+205 
+cci
+[0] = 0;
+
+206 
+cci
+[1] = 
+ifld
+;
+
+207 
+hh
+ = (
+hpi_hd
+ *&
+cci
+[2];
+
+208 
+hh
+->
+hi_
+.
+_u
+ = 
+HIPPI_ULP_802
+;
+
+209 
+hh
+->
+hi_
+.
+_ags
+ = 
+HIPPI_FP_D1_PRESENT
+;
+
+210 
+hh
+->
+hi_
+.
+_offts
+ = 
+	`hts
+((
+hpi_
+));
+
+211 
+hh
+->
+hi_
+.
+_d2_n
+ = 
+	`htl
+(
+d2_n
+);
+
+215 i(
+d2_n
+ % 8 != 0) {
+
+216 
+ut32_t
+ 
+bufr
+[2] = {0, 0};
+
+217 
+	`m_cyback
+(
+m
+, m->
+m_pkthdr
+.
+n
+, 8 - 
+d2_n
+ % 8, (*
+bufr
+);
+
+220  
+	`ifq_queue
+(
+i
+, 
+m
+ 
+ALTQ_COMMA
+ 
+	`ALTQ_DECL
+(&
+pkr
+));
+
+222 
+bad
+:
+
+223 i(
+m
+)
+
+224 
+	`m_m
+(
+m
+);
+
+225  (
+r
+);
+
+226 
+	}
+}
+
+235 
+	$hpi_put
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+)
+
+237 
+pktqueue_t
+ *
+pktq
+;
+
+238 
+c
+ *
+l
+;
+
+239 
+ut16_t
+ 
+hty
+;
+
+240 
+hpi_hd
+ *
+hh
+;
+
+242 i((
+i
+->
+if_ags
+ & 
+IFF_UP
+) == 0) {
+
+243 
+	`m_m
+(
+m
+);
+
+249 
+hh
+ = 
+	`mtod
+(
+m
+, 
+hpi_hd
+ *);
+
+251 
+i
+->
+if_ibys
+ +
+m
+->
+m_pkthdr
+.
+n
+;
+
+252 i(
+hh
+->
+hi_
+.
+_de_addr
+[0] & 1) {
+
+253 i(
+	`memcmp
+(
+hbrdaddr
+, 
+hh
+->
+hi_
+.
+_de_addr
+,
+
+254 (
+hbrdaddr
+)) == 0)
+
+255 
+m
+->
+m_ags
+ |
+M_BCAST
+;
+
+257 
+m
+->
+m_ags
+ |
+M_MCAST
+;
+
+259 i(
+m
+->
+m_ags
+ & (
+M_BCAST
+|
+M_MCAST
+))
+
+260 
+i
+->
+if_ims
+++;
+
+263 
+	`m_adj
+(
+m
+, (
+hpi_hd
+));
+
+265 
+l
+ = 
+	`mtod
+(
+m
+, 
+c
+ *);
+
+266 i(
+l
+->
+c_dp
+ !
+LLC_SNAP_LSAP
+) {
+
+267 
+	`m_m
+(
+m
+);
+
+270 
+hty
+ = 
+	`ohs
+(
+l
+->
+c_
+.
+h_ty
+);
+
+271 
+	`m_adj
+(
+m
+, 8);
+
+272 
+hty
+) {
+
+273 #ifde
+INET
+
+
+274 
+ETHERTYPE_IP
+:
+
+275 
+pktq
+ = 
+_pktq
+;
+
+278 #ifde
+INET6
+
+
+279 
+ETHERTYPE_IPV6
+:
+
+280 
+pktq
+ = 
+6_pktq
+;
+
+284 
+	`m_m
+(
+m
+);
+
+288 i(
+	`__edi_l
+(!
+	`pktq_queue
+(
+pktq
+, 
+m
+, 0))) {
+
+289 
+	`m_m
+(
+m
+);
+
+291 
+	}
+}
+
+297 #ifde
+INET
+
+
+299 
+	$hpi__put
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+)
+
+301 
+s
+;
+
+303 
+s
+ = 
+	`
+();
+
+304 i(
+	`__edi_l
+(!
+	`pktq_queue
+(
+_pktq
+, 
+m
+, 0))) {
+
+305 
+	`m_m
+(
+m
+);
+
+307 
+	`lx
+(
+s
+);
+
+308 
+	}
+}
+
+315 
+	$hpi_iach
+(
+i
+ *
+i
+, *
+a
+)
+
+318 
+i
+->
+if_ty
+ = 
+IFT_HIPPI
+;
+
+319 
+i
+->
+if_hd
+ = (
+hpi_hd
+) + 8;
+
+320 
+i
+->
+if_d
+ = 
+DLT_HIPPI
+;
+
+321 
+i
+->
+if_mtu
+ = 
+HIPPIMTU
+;
+
+322 
+i
+->
+if_ouut
+ = 
+hpi_ouut
+;
+
+323 
+i
+->
+if_put
+ = 
+hpi_put
+;
+
+324 
+i
+->
+if_baud
+ = 
+	`IF_Mbps
+(800);
+
+326 
+	`if_t_dl
+(
+i
+, 
+a
+, 6, 
+ue
+);
+
+328 
+	`bpf_ch
+(
+i
+, 
+DLT_HIPPI
+, (
+hpi_hd
+));
+
+329 
+	}
+}
+
+	@if_ieee1394.h
+
+32 #ide
+_NET_IF_IEEE1394_H_
+
+
+33 
+	#_NET_IF_IEEE1394_H_
+
+
+	)
+
+36 
+	s1394_hwaddr
+ {
+
+37 
+ut8_t
+ 
+	miha_uid
+[8];
+
+38 
+ut8_t
+ 
+	miha_maxc
+;
+
+39 
+ut8_t
+ 
+	miha_d
+;
+
+40 
+ut8_t
+ 
+	miha_offt
+[6];
+
+46 
+	s1394_bpfhdr
+ {
+
+47 
+ut8_t
+ 
+	mibh_dho
+[8];
+
+48 
+ut8_t
+ 
+	mibh_sho
+[8];
+
+49 
+ut16_t
+ 
+	mibh_ty
+;
+
+52 #ifde
+_KERNEL
+
+
+55 
+	s1394_hd
+ {
+
+56 
+ut8_t
+ 
+	mih_uid
+[8];
+
+57 
+ut8_t
+ 
+	mih_maxc
+;
+
+58 
+ut8_t
+ 
+	mih_d
+;
+
+59 
+ut8_t
+ 
+	mih_offt
+[6];
+
+63 
+	s1394_unaghdr
+ {
+
+64 
+ut16_t
+ 
+	miuh_
+;
+
+65 
+ut16_t
+ 
+	miuh_y
+;
+
+69 
+	s1394_aghdr
+ {
+
+70 
+ut16_t
+ 
+	mifh__size
+;
+
+71 
+ut16_t
+ 
+	mifh_y_off
+;
+
+73 
+ut16_t
+ 
+	mifh_dgl
+;
+
+74 
+ut16_t
+ 
+	mifh_rved
+;
+
+77 
+	#IEEE1394_FT_SUBSEQ
+ 0x8000
+
+	)
+
+78 
+	#IEEE1394_FT_MORE
+ 0x4000
+
+	)
+
+80 
+	#IEEE1394MTU
+ 1500
+
+	)
+
+82 
+	#IEEE1394_GASP_LEN
+ 8
+
+	)
+
+83 
+	#IEEE1394_ADDR_LEN
+ 8
+
+	)
+
+84 
+	#IEEE1394_CRC_LEN
+ 4
+
+	)
+
+86 
+	s1394_ass_pkt
+ {
+
+87 
+LIST_ENTRY
+(
+1394_ass_pkt
+
+	m_xt
+;
+
+88 
+mbuf
+ *
+	m_m
+;
+
+89 
+ut16_t
+ 
+	m_size
+;
+
+90 
+ut16_t
+ 
+	m_y
+;
+
+91 
+ut16_t
+ 
+	m_off
+;
+
+92 
+ut16_t
+ 
+	m_dgl
+;
+
+93 
+ut16_t
+ 
+	m_n
+;
+
+94 
+ut16_t
+ 
+	m_l
+;
+
+97 
+	s1394_assq
+ {
+
+98 
+LIST_ENTRY
+(
+1394_assq
+
+	mrq_node
+;
+
+99 
+LIST_HEAD
+(, 
+1394_ass_pkt
+
+	mrq_pkt
+;
+
+100 
+ut32_t
+ 
+	m_id
+;
+
+103 
+	s1394com
+ {
+
+104 
+i
+ 
+	mfc_if
+;
+
+105 
+1394_hwaddr
+ 
+	mic_hwaddr
+;
+
+106 
+ut16_t
+ 
+	mic_dgl
+;
+
+107 
+LIST_HEAD
+(, 
+1394_assq
+
+	mic_assq
+;
+
+110 c *
+1394_rtf
+(c 
+ut8_t
+ *);
+
+111 
+1394_put
+(
+i
+ *, 
+mbuf
+ *, 
+ut16_t
+);
+
+112 
+1394_iach
+(
+i
+ *, c 
+1394_hwaddr
+ *);
+
+113 
+1394_ifdach
+(
+i
+ *);
+
+114 
+1394_iol
+(
+i
+ *, 
+u_lg
+, *);
+
+115 
+mbuf
+ * 
+1394_agmt
+(
+i
+ *, mbu*, , 
+ut16_t
+);
+
+116 
+1394_d
+(
+i
+ *);
+
+117 
+1394_wchdog
+(
+i
+ *);
+
+	@if_ieee1394subr.c
+
+32 
+	~<sys/cdefs.h
+>
+
+33 
+__KERNEL_RCSID
+(0, "$NetBSD: if_ieee1394subr.c,v 1.48 2014/11/28 08:29:00 ozaki-r Exp $");
+
+35 
+	~"t_.h
+"
+
+37 
+	~<sys/m.h
+>
+
+38 
+	~<sys/sym.h
+>
+
+39 
+	~<sys/bus.h
+>
+
+40 
+	~<sys/devi.h
+>
+
+41 
+	~<sys/kl.h
+>
+
+42 
+	~<sys/mbuf.h
+>
+
+43 
+	~<sys/sock.h
+>
+
+44 
+	~<sys/sockio.h
+>
+
+45 
+	~<sys/.h
+>
+
+47 
+	~<t/if.h
+>
+
+48 
+	~<t/if_dl.h
+>
+
+49 
+	~<t/if_1394.h
+>
+
+50 
+	~<t/if_tys.h
+>
+
+51 
+	~<t/if_med.h
+>
+
+52 
+	~<t/htys.h
+>
+
+53 
+	~<t/ti.h
+>
+
+54 
+	~<t/rou.h
+>
+
+56 
+	~<t/bpf.h
+>
+
+58 #ifde
+INET
+
+
+59 
+	~<t/.h
+>
+
+60 
+	~<t/_v.h
+>
+
+61 
+	~<t/if_p.h
+>
+
+63 #ifde
+INET6
+
+
+64 
+	~<t/.h
+>
+
+65 
+	~<t6/6_v.h
+>
+
+66 
+	~<t6/nd6.h
+>
+
+69 
+	~<dev/1394/fewe.h
+>
+
+71 
+	~<dev/1394/feweg.h
+>
+
+72 
+	~<dev/1394/c13213.h
+>
+
+73 
+	~<dev/1394/if_fwv.h
+>
+
+75 
+	#IEEE1394_REASS_TIMEOUT
+ 3
+
+	)
+
+77 
+	#ndr
+(
+e
+d{ 
+r
+ = (e); 
+bad
+; } 0 )
+
+	)
+
+79 
+1394_ouut
+(
+i
+ *, 
+mbuf
+ *,
+
+80 c 
+sockaddr
+ *, 
+y
+ *);
+
+81 
+mbuf
+ *
+1394_ass
+(
+i
+ *, mbu*, 
+ut16_t
+);
+
+84 
+	$1394_ouut
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m0
+, c 
+sockaddr
+ *
+d
+,
+
+85 
+y
+ *
+0
+)
+
+87 
+ut16_t
+ 
+y
+ = 0;
+
+88 
+mbuf
+ *
+m
+;
+
+89 
+s
+, 
+hd
+, 
+r
+ = 0;
+
+90 
+y
+ *
+
+;
+
+91 
+mbuf
+ *
+mcy
+ = 
+NULL
+;
+
+92 
+1394_hwaddr
+ *
+hwd
+, 
+baddr
+;
+
+93 c 
+1394_hwaddr
+ *
+myaddr
+;
+
+94 
+	`ALTQ_DECL
+(
+tq_pkr
+ 
+pkr
+;)
+
+95 #ifde
+INET
+
+
+96 
+phdr
+ *
+ah
+;
+
+98 
+m_g
+ *
+mg
+;
+
+99 
+uni
+;
+
+101 i((
+i
+->
+if_ags
+ & (
+IFF_UP
+|
+IFF_RUNNING
+)) != (IFF_UP|IFF_RUNNING))
+
+102 
+	`ndr
+(
+ENETDOWN
+);
+
+103 i((
+
+ = 
+0
+!
+NULL
+) {
+
+104 i((
+
+->
+_ags
+ & 
+RTF_UP
+) == 0) {
+
+105 i((
+0
+ = 
+
+ = 
+	`loc1
+(
+d
+, 1)!
+NULL
+) {
+
+106 
+
+->
+_ft
+--;
+
+107 i(
+
+->
+_i
+ !
+i
+)
+
+108  (*
+
+->
+_i
+->
+if_ouut
+)
+
+109 (
+i
+, 
+m0
+, 
+d
+, 
+
+);
+
+111 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+113 i(
+
+->
+_ags
+ & 
+RTF_GATEWAY
+) {
+
+114 i(
+
+->
+_gwrou
+ =
+NULL
+)
+
+115 
+lookup
+;
+
+116 i(((
+
+ =t->
+_gwrou
+)->
+_ags
+ & 
+RTF_UP
+) == 0) {
+
+117 
+	`
+(
+
+);
+
+118 
+
+ = 
+0
+;
+
+119 
+lookup
+:
+
+120 
+
+->
+_gwrou
+ = 
+	`loc1
+t->
+_geway
+, 1);
+
+121 i((
+
+ =t->
+_gwrou
+=
+NULL
+)
+
+122 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+124 i((
+
+->
+_ags
+ & 
+RTF_GATEWAY
+) ||
+
+125 (
+
+->
+_i
+ !
+i
+)) {
+
+126 
+
+->
+_ft
+--;
+
+127 
+0
+->
+_gwrou
+ = 
+NULL
+;
+
+128 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+132 i(
+
+->
+_ags
+ & 
+RTF_REJECT
+)
+
+133 i(
+
+->
+_rmx
+.
+rmx_expe
+ == 0 ||
+
+134 
+time_cd
+ < 
+
+->
+_rmx
+.
+rmx_expe
+)
+
+135 
+	`ndr
+(
+
+ =
+0
+ ? 
+EHOSTDOWN
+ : 
+EHOSTUNREACH
+);
+
+142 
+	`IFQ_CLASSIFY
+(&
+i
+->
+if_d
+, 
+m0
+, 
+d
+->
+_my
+, &
+pkr
+);
+
+153 
+uni
+ = !(
+m0
+->
+m_ags
+ & (
+M_BCAST
+ | 
+M_MCAST
+));
+
+154 i(
+uni
+) {
+
+155 
+mg
+ =
+
+156 
+	`m_g_fd
+(
+m0
+, 
+MTAG_FIREWIRE_HWADDR
+, 
+NULL
+);
+
+157 i(!
+mg
+) {
+
+158 
+mg
+ = 
+	`m_g_g
+(
+MTAG_FIREWIRE_HWADDR
+,
+
+159  (
+1394_hwaddr
+), 
+M_NOWAIT
+);
+
+160 i(!
+mg
+) {
+
+161 
+r
+ = 
+ENOMEM
+;
+
+162 
+bad
+;
+
+164 
+	`m_g_d
+(
+m0
+, 
+mg
+);
+
+166 
+hwd
+ = (
+1394_hwaddr
+ *)(
+mg
+ + 1);
+
+168 
+hwd
+ = &
+baddr
+;
+
+171 
+d
+->
+_my
+) {
+
+172 #ifde
+INET
+
+
+173 
+AF_INET
+:
+
+174 i(
+uni
+ && (!
+	`esve
+(
+i
+, 
+
+, 
+m0
+, 
+d
+, (
+u_ch
+ *)
+hwd
+)))
+
+177 i((
+m0
+->
+m_ags
+ & 
+M_BCAST
+&& (
+i
+->
+if_ags
+ & 
+IFF_SIMPLEX
+))
+
+178 
+mcy
+ = 
+	`m_cy
+(
+m0
+, 0, 
+M_COPYALL
+);
+
+179 
+y
+ = 
+	`hts
+(
+ETHERTYPE_IP
+);
+
+181 
+AF_ARP
+:
+
+182 
+ah
+ = 
+	`mtod
+(
+m0
+, 
+phdr
+ *);
+
+183 
+ah
+->
+_hrd
+ = 
+	`hts
+(
+ARPHRD_IEEE1394
+);
+
+184 
+y
+ = 
+	`hts
+(
+ETHERTYPE_ARP
+);
+
+187 #ifde
+INET6
+
+
+188 
+AF_INET6
+:
+
+189 i(
+uni
+ && (!
+	`nd6_ddr
+(
+i
+, 
+
+, 
+m0
+, 
+d
+,
+
+190 
+hwd
+->
+iha_uid
+, 
+IEEE1394_ADDR_LEN
+))) {
+
+194 
+y
+ = 
+	`hts
+(
+ETHERTYPE_IPV6
+);
+
+198 
+pudo_AF_HDRCMPLT
+:
+
+199 
+AF_UNSPEC
+:
+
+202 
+	`tf
+("%s: c'hdf%d\n", 
+i
+->
+if_xme
+,
+
+203 
+d
+->
+_my
+);
+
+204 
+	`ndr
+(
+EAFNOSUPPORT
+);
+
+208 i(
+mcy
+)
+
+209 
+	`loouut
+(
+i
+, 
+mcy
+, 
+d
+, 
+
+);
+
+210 
+myaddr
+ = (c 
+1394_hwaddr
+ *)
+	`CLLADDR
+(
+i
+->
+if_dl
+);
+
+211 i(
+i
+->
+if_bpf
+) {
+
+212 
+1394_bpfhdr
+ 
+h
+;
+
+213 i(
+uni
+)
+
+214 
+	`memy
+(
+h
+.
+ibh_dho
+, 
+hwd
+->
+iha_uid
+, 8);
+
+216 
+	`memy
+(
+h
+.
+ibh_dho
+,
+
+217 ((c 
+1394_hwaddr
+ *)
+
+218 
+i
+->
+if_brdaddr
+)->
+iha_uid
+, 8);
+
+219 
+	`memy
+(
+h
+.
+ibh_sho
+, 
+myaddr
+->
+iha_uid
+, 8);
+
+220 
+h
+.
+ibh_ty
+ = 
+y
+;
+
+221 
+	`bpf_mp2
+(
+i
+->
+if_bpf
+, &
+h
+, (h), 
+m0
+);
+
+223 i((
+i
+->
+if_ags
+ & 
+IFF_SIMPLEX
+) &&
+
+224 
+uni
+ &&
+
+225 
+	`memcmp
+(
+hwd
+, 
+myaddr
+, 
+IEEE1394_ADDR_LEN
+) == 0)
+
+226  
+	`loouut
+(
+i
+, 
+m0
+, 
+d
+, 
+
+);
+
+234 i(
+uni
+) {
+
+235 
+hd
+ = 
+IEEE1394_GASP_LEN
+;
+
+236 
+hwd
+->
+iha_d
+ = 0;
+
+238 
+hd
+ = 0;
+
+240 i(
+hwd
+->
+iha_d
+ > 
+myaddr
+->iha_speed)
+
+241 
+hwd
+->
+iha_d
+ = 
+myaddr
+->iha_speed;
+
+242 i(
+hwd
+->
+iha_maxc
+ > 
+myaddr
+->iha_maxrec)
+
+243 
+hwd
+->
+iha_maxc
+ = 
+myaddr
+->iha_maxrec;
+
+244 i(
+hwd
+->
+iha_maxc
+ > (8 + hwd->
+iha_d
+))
+
+245 
+hwd
+->
+iha_maxc
+ = 8 + hwd->
+iha_d
+;
+
+246 i(
+hwd
+->
+iha_maxc
+ < 8)
+
+247 
+hwd
+->
+iha_maxc
+ = 8;
+
+249 
+m0
+ = 
+	`1394_agmt
+(
+i
+, m0, (2<<
+hwd
+->
+iha_maxc
+- 
+hd
+, 
+y
+);
+
+250 i(
+m0
+ =
+NULL
+)
+
+251 
+	`ndr
+(
+ENOBUFS
+);
+
+253 
+s
+ = 
+	`
+();
+
+254 
+i
+->
+if_obys
+ +
+m0
+->
+m_pkthdr
+.
+n
+;
+
+255 i(
+m0
+->
+m_ags
+ & 
+M_MCAST
+)
+
+256 
+i
+->
+if_oms
+++;
+
+257 (
+m
+ = 
+m0
+!
+NULL
+) {
+
+258 
+m0
+ = 
+m
+->
+m_xkt
+;
+
+259 i(
+m
+ =
+NULL
+) {
+
+260 
+	`lx
+(
+s
+);
+
+261 
+	`ndr
+(
+ENOBUFS
+);
+
+263 
+	`IFQ_ENQUEUE
+(&
+i
+->
+if_d
+, 
+m
+, &
+pkr
+, 
+r
+);
+
+264 i(
+r
+) {
+
+266 
+	`lx
+(
+s
+);
+
+267 
+bad
+;
+
+270 i((
+i
+->
+if_ags
+ & 
+IFF_OACTIVE
+) == 0)
+
+271 (*
+i
+->
+if_t
+)(ifp);
+
+272 
+	`lx
+(
+s
+);
+
+275 
+bad
+:
+
+276 
+m0
+ !
+NULL
+) {
+
+277 
+m
+ = 
+m0
+->
+m_xkt
+;
+
+278 
+	`m_m
+(
+m0
+);
+
+279 
+m0
+ = 
+m
+;
+
+282  
+r
+;
+
+283 
+	}
+}
+
+285 
+mbuf
+ *
+
+286 
+	$1394_agmt
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m0
+, 
+maxsize
+,
+
+287 
+ut16_t
+ 
+y
+)
+
+289 
+1394com
+ *
+ic
+ = (1394com *)
+i
+;
+
+290 
+tn
+, 
+agn
+, 
+off
+;
+
+291 
+mbuf
+ *
+m
+, **
+mp
+;
+
+292 
+1394_aghdr
+ *
+ifh
+;
+
+293 
+1394_unaghdr
+ *
+iuh
+;
+
+295 
+tn
+ = 
+m0
+->
+m_pkthdr
+.
+n
+;
+
+296 i(
+tn
+ + (
+1394_unaghdr
+<
+maxsize
+) {
+
+297 
+	`M_PREPEND
+(
+m0
+, (
+1394_unaghdr
+), 
+M_DONTWAIT
+);
+
+298 i(
+m0
+ =
+NULL
+)
+
+299 
+bad
+;
+
+300 
+iuh
+ = 
+	`mtod
+(
+m0
+, 
+1394_unaghdr
+ *);
+
+301 
+iuh
+->
+iuh_
+ = 0;
+
+302 
+iuh
+->
+iuh_y
+ = 
+y
+;
+
+303  
+m0
+;
+
+306 
+agn
+ = 
+maxsize
+ - (
+1394_aghdr
+);
+
+308 
+	`M_PREPEND
+(
+m0
+, (
+1394_aghdr
+), 
+M_DONTWAIT
+);
+
+309 i(
+m0
+ =
+NULL
+)
+
+310 
+bad
+;
+
+311 
+ifh
+ = 
+	`mtod
+(
+m0
+, 
+1394_aghdr
+ *);
+
+312 
+ifh
+->
+ifh__size
+ = 
+	`hts
+(
+IEEE1394_FT_MORE
+ | (
+tn
+ - 1));
+
+313 
+ifh
+->
+ifh_y_off
+ = 
+y
+;
+
+314 
+ifh
+->
+ifh_dgl
+ = 
+	`hts
+(
+ic
+->
+ic_dgl
+);
+
+315 
+ifh
+->
+ifh_rved
+ = 0;
+
+316 
+off
+ = 
+agn
+;
+
+317 
+mp
+ = &
+m0
+->
+m_xkt
+;
+
+318 
+off
+ < 
+tn
+) {
+
+319 i(
+off
+ + 
+agn
+ > 
+tn
+)
+
+320 
+agn
+ = 
+tn
+ - 
+off
+;
+
+321 
+	`MGETHDR
+(
+m
+, 
+M_DONTWAIT
+, 
+MT_HEADER
+);
+
+322 i(
+m
+ =
+NULL
+)
+
+323 
+bad
+;
+
+324 
+m
+->
+m_ags
+ |
+m0
+->m_ag& (
+M_BCAST
+|
+M_MCAST
+);
+
+325 
+	`MH_ALIGN
+(
+m
+, (
+1394_aghdr
+));
+
+326 
+m
+->
+m_n
+ = (
+1394_aghdr
+);
+
+327 
+ifh
+ = 
+	`mtod
+(
+m
+, 
+1394_aghdr
+ *);
+
+328 
+ifh
+->
+ifh__size
+ =
+
+329 
+	`hts
+(
+IEEE1394_FT_SUBSEQ
+ | 
+IEEE1394_FT_MORE
+ | (
+tn
+ - 1));
+
+330 
+ifh
+->
+ifh_y_off
+ = 
+	`hts
+(
+off
+);
+
+331 
+ifh
+->
+ifh_dgl
+ = 
+	`hts
+(
+ic
+->
+ic_dgl
+);
+
+332 
+ifh
+->
+ifh_rved
+ = 0;
+
+333 
+m
+->
+m_xt
+ = 
+	`m_cy
+(
+m0
+, (*
+ifh
++ 
+off
+, 
+agn
+);
+
+334 i(
+m
+->
+m_xt
+ =
+NULL
+)
+
+335 
+bad
+;
+
+336 
+m
+->
+m_pkthdr
+.
+n
+ = (*
+ifh
++ 
+agn
+;
+
+337 
+off
+ +
+agn
+;
+
+338 *
+mp
+ = 
+m
+;
+
+339 
+mp
+ = &
+m
+->
+m_xkt
+;
+
+341 
+ifh
+->
+ifh__size
+ &~
+	`hts
+(
+IEEE1394_FT_MORE
+);
+
+342 
+	`m_adj
+(
+m0
+, -(m0->
+m_pkthdr
+.
+n
+ - 
+maxsize
+));
+
+344 
+ic
+->
+ic_dgl
+++;
+
+345  
+m0
+;
+
+347 
+bad
+:
+
+348 (
+m
+ = 
+m0
+!
+NULL
+) {
+
+349 
+m0
+ = 
+m
+->
+m_xkt
+;
+
+350 
+m
+->
+m_xkt
+ = 
+NULL
+;
+
+351 
+	`m_m
+(
+m
+);
+
+353  
+NULL
+;
+
+354 
+	}
+}
+
+357 
+	$1394_put
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+, 
+ut16_t
+ 
+c
+)
+
+359 
+pktqueue_t
+ *
+pktq
+ = 
+NULL
+;
+
+360 
+ifqueue
+ *
+q
+;
+
+361 
+ut16_t
+ 
+y
+;
+
+362 
+s
+;
+
+363 
+1394_unaghdr
+ *
+iuh
+;
+
+364 
+i
+ = 0;
+
+366 i((
+i
+->
+if_ags
+ & 
+IFF_UP
+) == 0) {
+
+367 
+	`m_m
+(
+m
+);
+
+370 i(
+m
+->
+m_n
+ < (*
+iuh
+)) {
+
+371 i((
+m
+ = 
+	`m_puup
+(m, (*
+iuh
+))=
+NULL
+)
+
+375 
+iuh
+ = 
+	`mtod
+(
+m
+, 
+1394_unaghdr
+ *);
+
+377 i(
+	`ohs
+(
+iuh
+->
+iuh_
+& (
+IEEE1394_FT_SUBSEQ
+ | 
+IEEE1394_FT_MORE
+)) {
+
+378 i((
+m
+ = 
+	`1394_ass
+(
+i
+, m, 
+c
+)=
+NULL
+)
+
+380 
+iuh
+ = 
+	`mtod
+(
+m
+, 
+1394_unaghdr
+ *);
+
+382 
+y
+ = 
+	`ohs
+(
+iuh
+->
+iuh_y
+);
+
+385 
+	`m_adj
+(
+m
+, (*
+iuh
+));
+
+386 i(
+i
+->
+if_bpf
+) {
+
+387 
+1394_bpfhdr
+ 
+h
+;
+
+388 
+m_g
+ *
+mg
+;
+
+389 c 
+1394_hwaddr
+ *
+myaddr
+;
+
+391 
+mg
+ = 
+	`m_g_fd
+(
+m
+, 
+MTAG_FIREWIRE_SENDER_EUID
+, 0);
+
+392 i(
+mg
+)
+
+393 
+	`memy
+(
+h
+.
+ibh_sho
+, 
+mg
+ + 1, 8);
+
+395 
+	`memt
+(
+h
+.
+ibh_sho
+, 0, 8);
+
+396 i(
+m
+->
+m_ags
+ & 
+M_BCAST
+)
+
+397 
+	`memy
+(
+h
+.
+ibh_dho
+,
+
+398 ((c 
+1394_hwaddr
+ *)
+
+399 
+i
+->
+if_brdaddr
+)->
+iha_uid
+, 8);
+
+401 
+myaddr
+ =
+
+402 (c 
+1394_hwaddr
+ *)
+	`CLLADDR
+(
+i
+->
+if_dl
+);
+
+403 
+	`memy
+(
+h
+.
+ibh_dho
+, 
+myaddr
+->
+iha_uid
+, 8);
+
+405 
+h
+.
+ibh_ty
+ = 
+	`hts
+(
+y
+);
+
+406 
+	`bpf_mp2
+(
+i
+->
+if_bpf
+, &
+h
+, (h), 
+m
+);
+
+409 
+y
+) {
+
+410 #ifde
+INET
+
+
+411 
+ETHERTYPE_IP
+:
+
+412 
+pktq
+ = 
+_pktq
+;
+
+415 
+ETHERTYPE_ARP
+:
+
+416 
+i
+ = 
+NETISR_ARP
+;
+
+417 
+q
+ = &
+pq
+;
+
+421 #ifde
+INET6
+
+
+422 
+ETHERTYPE_IPV6
+:
+
+423 
+pktq
+ = 
+6_pktq
+;
+
+428 
+	`m_m
+(
+m
+);
+
+432 i(
+	`__edi_ue
+(
+pktq
+)) {
+
+433 i(
+	`__edi_l
+(!
+	`pktq_queue
+(
+pktq
+, 
+m
+, 0))) {
+
+434 
+	`m_m
+(
+m
+);
+
+439 
+s
+ = 
+	`
+();
+
+440 i(
+	`IF_QFULL
+(
+q
+)) {
+
+441 
+	`IF_DROP
+(
+q
+);
+
+442 
+	`m_m
+(
+m
+);
+
+444 
+	`IF_ENQUEUE
+(
+q
+, 
+m
+);
+
+445 
+	`schedti
+(
+i
+);
+
+447 
+	`lx
+(
+s
+);
+
+448 
+	}
+}
+
+450 
+mbuf
+ *
+
+451 
+	$1394_ass
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m0
+, 
+ut16_t
+ 
+c
+)
+
+453 
+1394com
+ *
+ic
+ = (1394com *)
+i
+;
+
+454 
+1394_aghdr
+ *
+ifh
+;
+
+455 
+1394_unaghdr
+ *
+iuh
+;
+
+456 
+1394_assq
+ *
+rq
+;
+
+457 
+1394_ass_pkt
+ *
+
+, *
+p
+, *
+p
+ = 
+NULL
+;
+
+458 
+n
+;
+
+459 
+ut16_t
+ 
+y
+, 
+off
+, 
+y
+, 
+size
+, 
+dgl
+;
+
+460 
+ut32_t
+ 
+id
+;
+
+462 i(
+m0
+->
+m_n
+ < (*
+ifh
+)) {
+
+463 i((
+m0
+ = 
+	`m_puup
+(m0, (*
+ifh
+))=
+NULL
+)
+
+464  
+NULL
+;
+
+466 
+ifh
+ = 
+	`mtod
+(
+m0
+, 
+1394_aghdr
+ *);
+
+467 
+	`m_adj
+(
+m0
+, (*
+ifh
+));
+
+468 
+size
+ = 
+	`ohs
+(
+ifh
+->
+ifh__size
+);
+
+469 
+y
+ = 
+size
+ & (
+IEEE1394_FT_SUBSEQ
+ | 
+IEEE1394_FT_MORE
+);
+
+470 
+size
+ = (siz& ~
+y
+) + 1;
+
+471 
+dgl
+ = 
+	`ohs
+(
+ifh
+->
+ifh_dgl
+);
+
+472 
+n
+ = 
+m0
+->
+m_pkthdr
+.len;
+
+473 
+id
+ = 
+dgl
+ | (
+c
+ << 16);
+
+474 i(
+y
+ & 
+IEEE1394_FT_SUBSEQ
+) {
+
+475 
+	`m_g_de_cha
+(
+m0
+, 
+NULL
+);
+
+476 
+m0
+->
+m_ags
+ &~
+M_PKTHDR
+;
+
+477 
+y
+ = 0;
+
+478 
+off
+ = 
+	`ohs
+(
+ifh
+->
+ifh_y_off
+);
+
+480 
+y
+ = 
+ifh
+->
+ifh_y_off
+;
+
+481 
+off
+ = 0;
+
+484 
+rq
+ = 
+	`LIST_FIRST
+(&
+ic
+->
+ic_assq
+); ;q = 
+	`LIST_NEXT
+q, 
+rq_node
+)) {
+
+485 i(
+rq
+ =
+NULL
+) {
+
+489 
+rq
+ = 
+	`mloc
+((*rq), 
+M_FTABLE
+, 
+M_NOWAIT
+);
+
+490 i(
+rq
+ =
+NULL
+) {
+
+491 
+	`m_m
+(
+m0
+);
+
+492  
+NULL
+;
+
+494 
+rq
+->
+_id
+ = 
+id
+;
+
+495 
+	`LIST_INIT
+(&
+rq
+->
+rq_pkt
+);
+
+496 
+	`LIST_INSERT_HEAD
+(&
+ic
+->
+ic_assq
+, 
+rq
+, 
+rq_node
+);
+
+499 i(
+rq
+->
+_id
+ =
+id
+)
+
+502 
+
+ = 
+	`LIST_FIRST
+(&
+rq
+->
+rq_pkt
+);!
+NULL
+;
+p
+) {
+
+503 
+p
+ = 
+	`LIST_NEXT
+(
+
+, 
+_xt
+);
+
+504 i(
+
+->
+_dgl
+ !
+dgl
+)
+
+511 i(
+
+->
+_size
+ !
+size
+ ||
+
+512 (
+off
+ < 
+
+->
+_off
+ +p->
+_n
+ && of+ 
+n
+ >p->rp_off)) {
+
+518 
+
+ = 
+	`LIST_FIRST
+(&
+rq
+->
+rq_pkt
+);!
+NULL
+;
+
+519 
+
+ = 
+p
+) {
+
+520 
+p
+ = 
+	`LIST_NEXT
+(
+
+, 
+_xt
+);
+
+521 i(
+
+->
+_dgl
+ =
+dgl
+) {
+
+522 
+	`LIST_REMOVE
+(
+
+, 
+_xt
+);
+
+523 
+	`m_m
+(
+
+->
+_m
+);
+
+524 
+	`
+(
+
+, 
+M_FTABLE
+);
+
+529 i(
+
+->
+_off
+ +p->
+_n
+ =
+off
+) {
+
+538 
+	`m_t
+(
+
+->
+_m
+, 
+m0
+);
+
+539 
+
+->
+_n
+ +
+n
+;
+
+540 
+
+->
+_off
+ +p->
+_n
+ < 
+size
+ &&
+
+541 
+p
+ !
+NULL
+ &&->
+_dgl
+ =
+dgl
+ &&
+
+542 
+p
+->
+_off
+ =
+
+->_of+p->
+_n
+) {
+
+543 
+	`LIST_REMOVE
+(
+p
+, 
+_xt
+);
+
+544 
+	`m_t
+(
+
+->
+_m
+, 
+p
+->rp_m);
+
+545 
+
+->
+_n
+ +
+p
+->rp_len;
+
+546 
+	`
+(
+p
+, 
+M_FTABLE
+);
+
+547 
+p
+ = 
+	`LIST_NEXT
+(
+
+, 
+_xt
+);
+
+549 
+m0
+ = 
+NULL
+;
+
+552 i(
+off
+ + 
+m0
+->
+m_pkthdr
+.
+n
+ =
+
+->
+_off
+) {
+
+553 
+	`m_t
+(
+m0
+, 
+
+->
+_m
+);
+
+554 
+
+->
+_m
+ = 
+m0
+;
+
+555 
+
+->
+_off
+ = 
+off
+;
+
+556 
+
+->
+_y
+ = 
+y
+;
+
+557 
+
+->
+_n
+ +
+n
+;
+
+558 
+m0
+ = 
+NULL
+;
+
+561 i(
+
+->
+_off
+ > 
+off
+) {
+
+563 
+p
+ = 
+
+;
+
+566 i(
+p
+ =
+NULL
+ ||->
+_dgl
+ !
+dgl
+) {
+
+568 
+p
+ = 
+NULL
+;
+
+572 i(
+m0
+ =
+NULL
+) {
+
+573 i(
+
+->
+_off
+ !0 ||p->
+_n
+ !
+size
+)
+
+574  
+NULL
+;
+
+576 
+	`LIST_REMOVE
+(
+
+, 
+_xt
+);
+
+577 
+m0
+ = 
+
+->
+_m
+;
+
+578 
+m0
+->
+m_pkthdr
+.
+n
+ = 
+
+->
+_n
+;
+
+579 
+	`M_PREPEND
+(
+m0
+, (*
+iuh
+), 
+M_DONTWAIT
+);
+
+580 i(
+m0
+ !
+NULL
+) {
+
+581 
+iuh
+ = 
+	`mtod
+(
+m0
+, 
+1394_unaghdr
+ *);
+
+582 
+iuh
+->
+iuh_
+ = 0;
+
+583 
+iuh
+->
+iuh_y
+ = 
+
+->
+_y
+;
+
+585 
+	`
+(
+
+, 
+M_FTABLE
+);
+
+586  
+m0
+;
+
+592 
+p
+ = 
+	`mloc
+((*p), 
+M_FTABLE
+, 
+M_NOWAIT
+);
+
+593 i(
+p
+ =
+NULL
+) {
+
+594 
+	`m_m
+(
+m0
+);
+
+595  
+NULL
+;
+
+597 
+p
+->
+_m
+ = 
+m0
+;
+
+598 
+p
+->
+_size
+ = 
+size
+;
+
+599 
+p
+->
+_y
+ = 
+y
+;
+
+600 
+p
+->
+_off
+ = 
+off
+;
+
+601 
+p
+->
+_dgl
+ = 
+dgl
+;
+
+602 
+p
+->
+_n
+ = 
+n
+;
+
+603 
+p
+->
+_l
+ = 
+IEEE1394_REASS_TIMEOUT
+;
+
+604 i(
+p
+->
+_l
+ <
+i
+->
+if_tim
+)
+
+605 
+p
+->
+_l
+ = 
+i
+->
+if_tim
+ + 1;
+
+607 i(
+
+ =
+NULL
+) {
+
+609 
+	`LIST_INSERT_HEAD
+(&
+rq
+->
+rq_pkt
+, 
+p
+, 
+_xt
+);
+
+610 } i(
+p
+ =
+NULL
+) {
+
+612 
+	`LIST_INSERT_AFTER
+(
+
+, 
+p
+, 
+_xt
+);
+
+615 
+	`LIST_INSERT_BEFORE
+(
+p
+, 
+p
+, 
+_xt
+);
+
+617  
+NULL
+;
+
+618 
+	}
+}
+
+621 
+	$1394_d
+(
+i
+ *
+i
+)
+
+623 
+1394com
+ *
+ic
+ = (1394com *)
+i
+;
+
+624 
+1394_assq
+ *
+rq
+;
+
+625 
+1394_ass_pkt
+ *
+
+;
+
+627 (
+rq
+ = 
+	`LIST_FIRST
+(&
+ic
+->
+ic_assq
+)!
+NULL
+) {
+
+628 
+	`LIST_REMOVE
+(
+rq
+, 
+rq_node
+);
+
+629 (
+
+ = 
+	`LIST_FIRST
+(&
+rq
+->
+rq_pkt
+)!
+NULL
+) {
+
+630 
+	`LIST_REMOVE
+(
+
+, 
+_xt
+);
+
+631 
+	`m_m
+(
+
+->
+_m
+);
+
+632 
+	`
+(
+
+, 
+M_FTABLE
+);
+
+634 
+	`
+(
+rq
+, 
+M_FTABLE
+);
+
+636 
+	}
+}
+
+639 
+	$1394_wchdog
+(
+i
+ *
+i
+)
+
+641 
+1394com
+ *
+ic
+ = (1394com *)
+i
+;
+
+642 
+1394_assq
+ *
+rq
+;
+
+643 
+1394_ass_pkt
+ *
+
+, *
+p
+;
+
+644 
+dec
+;
+
+646 
+dec
+ = (
+i
+->
+if_tim
+ > 0) ? ifp->if_timer : 1;
+
+647 
+rq
+ = 
+	`LIST_FIRST
+(&
+ic
+->
+ic_assq
+);q !
+NULL
+;
+
+648 
+rq
+ = 
+	`LIST_NEXT
+q, 
+rq_node
+)) {
+
+649 
+
+ = 
+	`LIST_FIRST
+(&
+rq
+->
+rq_pkt
+);!
+NULL
+;
+p
+) {
+
+650 
+p
+ = 
+	`LIST_NEXT
+(
+
+, 
+_xt
+);
+
+651 i(
+
+->
+_l
+ >
+dec
+)
+
+652 
+
+->
+_l
+ -
+dec
+;
+
+654 
+	`LIST_REMOVE
+(
+
+, 
+_xt
+);
+
+655 
+	`m_m
+(
+
+->
+_m
+);
+
+656 
+	`
+(
+
+, 
+M_FTABLE
+);
+
+660 
+	}
+}
+
+663 
+	$1394_rtf
+(c 
+ut8_t
+ *
+ddr
+)
+
+665 
+buf
+[3*8];
+
+667 
+	`tf
+(
+buf
+, (buf), "%02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x",
+
+668 
+ddr
+[0],addr[1],addr[2],addr[3],
+
+669 
+ddr
+[4],addr[5],addr[6],addr[7]);
+
+670  
+buf
+;
+
+671 
+	}
+}
+
+674 
+	$1394_iach
+(
+i
+ *
+i
+, c 
+1394_hwaddr
+ *
+hwaddr
+)
+
+676 
+1394_hwaddr
+ *
+baddr
+;
+
+677 
+1394com
+ *
+ic
+ = (1394com *)
+i
+;
+
+679 
+i
+->
+if_ty
+ = 
+IFT_IEEE1394
+;
+
+680 
+i
+->
+if_hd
+ = (
+1394_hd
+);
+
+681 
+i
+->
+if_d
+ = 
+DLT_EN10MB
+;
+
+682 
+i
+->
+if_mtu
+ = 
+IEEE1394MTU
+;
+
+683 
+i
+->
+if_ouut
+ = 
+1394_ouut
+;
+
+684 
+i
+->
+if_d
+ = 
+1394_d
+;
+
+685 
+i
+->
+if_wchdog
+ = 
+1394_wchdog
+;
+
+686 
+i
+->
+if_tim
+ = 1;
+
+687 i(
+i
+->
+if_baud
+ == 0)
+
+688 
+i
+->
+if_baud
+ = 
+	`IF_Mbps
+(100);
+
+690 
+	`if_t_dl
+(
+i
+, 
+hwaddr
+, (
+1394_hwaddr
+), 
+ue
+);
+
+692 
+baddr
+ = 
+	`mloc
+(
+i
+->
+if_add
+, 
+M_DEVBUF
+, 
+M_WAITOK
+);
+
+693 
+	`memt
+(
+baddr
+->
+iha_uid
+, 0xff, 
+IEEE1394_ADDR_LEN
+);
+
+694 
+baddr
+->
+iha_d
+ = 0;
+
+695 
+baddr
+->
+iha_maxc
+ = 512 << baddr->
+iha_d
+;
+
+696 
+	`memt
+(
+baddr
+->
+iha_offt
+, 0, (baddr->iha_offset));
+
+697 
+i
+->
+if_brdaddr
+ = (
+ut8_t
+ *)
+baddr
+;
+
+698 
+	`LIST_INIT
+(&
+ic
+->
+ic_assq
+);
+
+699 
+	`bpf_ch
+(
+i
+, 
+DLT_APPLE_IP_OVER_IEEE1394
+,
+
+700 (
+1394_hwaddr
+));
+
+701 
+	}
+}
+
+704 
+	$1394_ifdach
+(
+i
+ *
+i
+)
+
+706 
+	`1394_d
+(
+i
+);
+
+707 
+	`bpf_dach
+(
+i
+);
+
+708 
+	`
+(
+	`__UNCONST
+(
+i
+->
+if_brdaddr
+), 
+M_DEVBUF
+);
+
+709 
+i
+->
+if_brdaddr
+ = 
+NULL
+;
+
+710 
+	}
+}
+
+713 
+	$1394_iol
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+715 
+ieq
+ *
+i
+ = (ieq *)
+da
+;
+
+716 
+iddr
+ *
+i
+ = (idd*)
+da
+;
+
+717 
+r
+ = 0;
+
+719 
+cmd
+) {
+
+720 
+SIOCINITIFADDR
+:
+
+721 
+i
+->
+if_ags
+ |
+IFF_UP
+;
+
+722 
+i
+->
+i_addr
+->
+_my
+) {
+
+723 #ifde
+INET
+
+
+724 
+AF_INET
+:
+
+725 i((
+r
+ = (*
+i
+->
+if_
+)(ifp)) != 0)
+
+727 
+	`p_if
+(
+i
+, 
+i
+);
+
+731 
+r
+ = (*
+i
+->
+if_
+)(ifp);
+
+736 
+SIOCSIFMTU
+:
+
+737 i(
+i
+->
+i_mtu
+ > 
+IEEE1394MTU
+)
+
+738 
+r
+ = 
+EINVAL
+;
+
+739 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)=
+ENETRESET
+)
+
+740 
+r
+ = 0;
+
+744 
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+);
+
+748  
+r
+;
+
+749 
+	}
+}
+
+	@if_llc.h
+
+34 #ide
+_NET_IF_LLC_H_
+
+
+35 
+	#_NET_IF_LLC_H_
+
+
+	)
+
+45 
+	sc
+ {
+
+46 
+ut8_t
+ 
+	mc_dp
+;
+
+47 
+ut8_t
+ 
+	mc_sp
+;
+
+50 
+ut8_t
+ 
+	mc
+;
+
+51 
+ut8_t
+ 
+	mfm_id
+;
+
+52 
+ut8_t
+ 
+	mass_u
+;
+
+53 
+ut8_t
+ 
+	mwdow_x2
+;
+
+54 } 
+	mty_u
+ ;
+
+56 
+ut8_t
+ 
+	mnum_d_x2
+;
+
+57 
+ut8_t
+ 
+	mnum_rcv_x2
+;
+
+58 } 
+	mty_i
+ ;
+
+60 
+ut8_t
+ 
+	mc
+;
+
+61 
+ut8_t
+ 
+	mnum_rcv_x2
+;
+
+62 } 
+	mty_s
+ ;
+
+64 
+ut8_t
+ 
+	mc
+;
+
+69 
+ut8_t
+ 
+	mmr_j_pdu0
+;
+
+70 
+ut8_t
+ 
+	mmr_j_pdu1
+;
+
+71 
+ut8_t
+ 
+	mmr_c
+;
+
+72 
+ut8_t
+ 
+	mmr_c_ext
+;
+
+73 
+ut8_t
+ 
+	mmr_u
+;
+
+74 } 
+	mty_mr
+ ;
+
+76 
+ut8_t
+ 
+	mc
+;
+
+77 
+ut8_t
+ 
+	mg_code
+[3];
+
+78 
+ut16_t
+ 
+	mh_ty
+;
+
+79 } 
+ty_
+ 
+	m__cked
+;
+
+81 
+ut8_t
+ 
+	mc
+;
+
+82 
+ut8_t
+ 
+	mc_ext
+;
+
+83 } 
+	mty_w
+ ;
+
+84 } 
+	mc_un
+ ;
+
+85 } 
+	g__cked
+;
+
+87 
+	smrfo
+ {
+
+88 
+ut8_t
+ 
+	mmr_j_pdu0
+;
+
+89 
+ut8_t
+ 
+	mmr_j_pdu1
+;
+
+90 
+ut8_t
+ 
+	mmr_c
+;
+
+91 
+ut8_t
+ 
+	mmr_c_ext
+;
+
+92 
+ut8_t
+ 
+	mmr_u
+;
+
+93 } 
+	g__cked
+;
+
+95 
+	#c_c
+ 
+c_un
+.
+ty_u
+.
+c
+
+
+	)
+
+96 
+	#c_c_ext
+ 
+c_un
+.
+ty_w
+.
+c_ext
+
+
+	)
+
+97 
+	#c_fid
+ 
+c_un
+.
+ty_u
+.
+fm_id
+
+
+	)
+
+98 
+	#c_ass
+ 
+c_un
+.
+ty_u
+.
+ass_u
+
+
+	)
+
+99 
+	#c_wdow
+ 
+c_un
+.
+ty_u
+.
+wdow_x2
+
+
+	)
+
+100 
+	#c_mrfo
+ 
+c_un
+.
+ty_mr
+.
+mr_j_pdu0
+
+
+	)
+
+101 
+	#c_mr_pdu0
+ 
+c_un
+.
+ty_mr
+.
+mr_j_pdu0
+
+
+	)
+
+102 
+	#c_mr_pdu1
+ 
+c_un
+.
+ty_mr
+.
+mr_j_pdu1
+
+
+	)
+
+103 
+	#c_mr_c
+ 
+c_un
+.
+ty_mr
+.
+mr_c
+
+
+	)
+
+104 
+	#c_mr_c_ext
+ 
+c_un
+.
+ty_mr
+.
+mr_c_ext
+
+
+	)
+
+105 
+	#c_mr_u
+ 
+c_un
+.
+ty_mr
+.
+mr_u
+
+
+	)
+
+106 
+	#c_
+ 
+c_un
+.
+ty_
+
+
+	)
+
+111 
+	#LLC_ISFRAMELEN
+ 4
+
+	)
+
+112 
+	#LLC_UFRAMELEN
+ 3
+
+	)
+
+113 
+	#LLC_FRMRLEN
+ 7
+
+	)
+
+114 
+	#LLC_SNAPFRAMELEN
+ 8
+
+	)
+
+119 
+	#LLC_UI
+ 0x3
+
+	)
+
+120 
+	#LLC_UI_P
+ 0x13
+
+	)
+
+121 
+	#LLC_DISC
+ 0x43
+
+	)
+
+122 
+	#LLC_DISC_P
+ 0x53
+
+	)
+
+123 
+	#LLC_UA
+ 0x63
+
+	)
+
+124 
+	#LLC_UA_P
+ 0x73
+
+	)
+
+125 
+	#LLC_TEST
+ 0xe3
+
+	)
+
+126 
+	#LLC_TEST_P
+ 0xf3
+
+	)
+
+127 
+	#LLC_FRMR
+ 0x87
+
+	)
+
+128 
+	#LLC_FRMR_P
+ 0x97
+
+	)
+
+129 
+	#LLC_DM
+ 0x0f
+
+	)
+
+130 
+	#LLC_DM_P
+ 0x1f
+
+	)
+
+131 
+	#LLC_XID
+ 0xaf
+
+	)
+
+132 
+	#LLC_XID_P
+ 0xbf
+
+	)
+
+133 
+	#LLC_SABME
+ 0x6f
+
+	)
+
+134 
+	#LLC_SABME_P
+ 0x7f
+
+	)
+
+139 
+	#LLC_RR
+ 0x01
+
+	)
+
+140 
+	#LLC_RNR
+ 0x05
+
+	)
+
+141 
+	#LLC_REJ
+ 0x09
+
+	)
+
+146 
+	#LLC_INFO
+ 0x00
+
+	)
+
+151 
+	#LLC_8021D_LSAP
+ 0x42
+
+	)
+
+152 
+	#LLC_X25_LSAP
+ 0x7e
+
+	)
+
+153 
+	#LLC_SNAP_LSAP
+ 0x
+
+	)
+
+154 
+	#LLC_ISO_LSAP
+ 0x
+
+	)
+
+160 
+	#LLC_XID_FORMAT_BASIC
+ 0x81
+
+	)
+
+161 
+	#LLC_XID_BASIC_MINLEN
+ (
+LLC_UFRAMELEN
+ + 3)
+
+	)
+
+163 
+	#LLC_XID_CLASS_I
+ 0x1
+
+	)
+
+164 
+	#LLC_XID_CLASS_II
+ 0x3
+
+	)
+
+165 
+	#LLC_XID_CLASS_III
+ 0x5
+
+	)
+
+166 
+	#LLC_XID_CLASS_IV
+ 0x7
+
+	)
+
+	@if_loop.c
+
+67 
+	~<sys/cdefs.h
+>
+
+68 
+__KERNEL_RCSID
+(0, "$NetBSD: if_loop.c,v 1.81 2015/04/03 07:55:18 ozaki-r Exp $");
+
+70 
+	~"t_.h
+"
+
+71 
+	~"t_k.h
+"
+
+72 
+	~"t_x.h
+"
+
+73 
+	~"t_mbu.h
+"
+
+74 
+	~"t_ms.h
+"
+
+75 
+	~"t_t_mp.h
+"
+
+77 
+	~<sys/m.h
+>
+
+78 
+	~<sys/sym.h
+>
+
+79 
+	~<sys/kl.h
+>
+
+80 
+	~<sys/mbuf.h
+>
+
+81 
+	~<sys/sock.h
+>
+
+82 
+	~<sys/o.h
+>
+
+83 
+	~<sys/iol.h
+>
+
+84 
+	~<sys/time.h
+>
+
+86 
+	~<sys/u.h
+>
+
+88 
+	~<t/if.h
+>
+
+89 
+	~<t/if_tys.h
+>
+
+90 
+	~<t/ti.h
+>
+
+91 
+	~<t/rou.h
+>
+
+93 #ifdef 
+INET
+
+
+94 
+	~<t/.h
+>
+
+95 
+	~<t/_sym.h
+>
+
+96 
+	~<t/_v.h
+>
+
+97 
+	~<t/_ofd.h
+>
+
+98 
+	~<t/.h
+>
+
+101 #ifde
+INET6
+
+
+102 #ide
+INET
+
+
+103 
+	~<t/.h
+>
+
+105 
+	~<t6/6_v.h
+>
+
+106 
+	~<t6/6_ofd.h
+>
+
+107 
+	~<t/6.h
+>
+
+110 #ifde
+IPX
+
+
+111 
+	~<tx/x.h
+>
+
+112 
+	~<tx/x_if.h
+>
+
+115 #ifde
+MPLS
+
+
+116 
+	~<tms/ms.h
+>
+
+117 
+	~<tms/ms_v.h
+>
+
+120 #ifde
+NETATALK
+
+
+121 
+	~<lk/.h
+>
+
+122 
+	~<lk/_v.h
+>
+
+125 
+	~<t/bpf.h
+>
+
+127 #i
+defed
+(
+LARGE_LOMTU
+)
+
+128 
+	#LOMTU
+ (131072 + 
+MHLEN
+ + 
+MLEN
+)
+
+	)
+
+129 
+	#LOMTU_MAX
+ 
+LOMTU
+
+
+	)
+
+131 
+	#LOMTU
+ (32768 + 
+MHLEN
+ + 
+MLEN
+)
+
+	)
+
+132 
+	#LOMTU_MAX
+ (65536 + 
+MHLEN
+ + 
+MLEN
+)
+
+	)
+
+135 #ifde
+ALTQ
+
+
+136 
+lot
+(
+i
+ *);
+
+139 
+lo_e_
+(
+if_e
+ *, );
+
+140 
+lo_e_deroy
+(
+i
+ *);
+
+142 
+if_e
+ 
+	glo_
+ =
+
+143 
+IF_CLONE_INITIALIZER
+("lo", 
+lo_e_
+, 
+lo_e_deroy
+);
+
+146 
+	$loch
+(
+n
+)
+
+149 ()
+	`lo_e_
+(&
+lo_
+, 0);
+
+150 
+	`if_e_ch
+(&
+lo_
+);
+
+151 
+	}
+}
+
+154 
+	$lo_e_
+(
+if_e
+ *
+ifc
+, 
+un
+)
+
+156 
+i
+ *
+i
+;
+
+158 
+i
+ = 
+	`if_loc
+(
+IFT_LOOP
+);
+
+160 
+	`if_me
+(
+i
+, 
+ifc
+->
+ifc_me
+, 
+un
+);
+
+162 
+i
+->
+if_mtu
+ = 
+LOMTU
+;
+
+163 
+i
+->
+if_ags
+ = 
+IFF_LOOPBACK
+ | 
+IFF_MULTICAST
+ | 
+IFF_RUNNING
+;
+
+164 
+i
+->
+if_iol
+ = 
+loiol
+;
+
+165 
+i
+->
+if_ouut
+ = 
+loouut
+;
+
+166 #ifde
+ALTQ
+
+
+167 
+i
+->
+if_t
+ = 
+lot
+;
+
+169 
+i
+->
+if_ty
+ = 
+IFT_LOOP
+;
+
+170 
+i
+->
+if_hd
+ = 0;
+
+171 
+i
+->
+if_add
+ = 0;
+
+172 
+i
+->
+if_d
+ = 
+DLT_NULL
+;
+
+173 
+	`IFQ_SET_READY
+(&
+i
+->
+if_d
+);
+
+174 i(
+un
+ == 0)
+
+175 
+lo0i
+ = 
+i
+;
+
+176 
+	`if_ch
+(
+i
+);
+
+177 
+	`if_loc_dl
+(
+i
+);
+
+178 
+	`bpf_ch
+(
+i
+, 
+DLT_NULL
+, (
+u_t
+));
+
+179 #ifde
+MBUFTRACE
+
+
+180 
+i
+->
+if_mowr
+ = 
+	`mloc
+((
+mowr
+), 
+M_DEVBUF
+,
+
+181 
+M_WAITOK
+ | 
+M_ZERO
+);
+
+182 
+	`y
+(
+i
+->
+if_mowr
+->
+mo_me
+, i->
+if_xme
+,
+
+183 (
+i
+->
+if_mowr
+->
+mo_me
+));
+
+184 
+	`MOWNER_ATTACH
+(
+i
+->
+if_mowr
+);
+
+188 
+	}
+}
+
+191 
+	$lo_e_deroy
+(
+i
+ *
+i
+)
+
+194 i(
+i
+ =
+lo0i
+)
+
+195  (
+EPERM
+);
+
+197 #ifde
+MBUFTRACE
+
+
+198 
+	`MOWNER_DETACH
+(
+i
+->
+if_mowr
+);
+
+199 
+	`
+(
+i
+->
+if_mowr
+, 
+M_DEVBUF
+);
+
+202 
+	`bpf_dach
+(
+i
+);
+
+203 
+	`if_dach
+(
+i
+);
+
+205 
+	`if_
+(
+i
+);
+
+208 
+	}
+}
+
+211 
+	$loouut
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+, c 
+sockaddr
+ *
+d
+,
+
+212 
+y
+ *
+
+)
+
+214 
+pktqueue_t
+ *
+pktq
+ = 
+NULL
+;
+
+215 
+ifqueue
+ *
+ifq
+ = 
+NULL
+;
+
+216 
+s
+, 
+i
+ = -1;
+
+217 
+csum_ags
+;
+
+218 
+size_t
+ 
+pk
+;
+
+220 
+	`MCLAIM
+(
+m
+, 
+i
+->
+if_mowr
+);
+
+221 #ide
+NET_MPSAFE
+
+
+222 
+	`KASSERT
+(
+	`KERNEL_LOCKED_P
+());
+
+225 i((
+m
+->
+m_ags
+ & 
+M_PKTHDR
+) == 0)
+
+226 
+	`nic
+("looutput:o header mbuf");
+
+227 i(
+i
+->
+if_ags
+ & 
+IFF_LOOPBACK
+)
+
+228 
+	`bpf_mp_af
+(
+i
+, 
+d
+->
+_my
+, 
+m
+);
+
+229 
+m
+->
+m_pkthdr
+.
+rcvif
+ = 
+i
+;
+
+231 i(
+
+ &&t->
+_ags
+ & (
+RTF_REJECT
+|
+RTF_BLACKHOLE
+)) {
+
+232 
+	`m_m
+(
+m
+);
+
+233  (
+
+->
+_ags
+ & 
+RTF_BLACKHOLE
+ ? 0 :
+
+234 
+
+->
+_ags
+ & 
+RTF_HOST
+ ? 
+EHOSTUNREACH
+ : 
+ENETUNREACH
+);
+
+237 
+pk
+ = 
+m
+->
+m_pkthdr
+.
+n
+;
+
+238 
+i
+->
+if_acks
+++;
+
+239 
+i
+->
+if_obys
+ +
+pk
+;
+
+241 #ifde
+ALTQ
+
+
+246 i((
+	`ALTQ_IS_ENABLED
+(&
+i
+->
+if_d
+|| 
+	`TBR_IS_ENABLED
+(&ifp->if_snd)) &&
+
+247 
+i
+->
+if_t
+ =
+lot
+) {
+
+248 
+tq_pkr
+ 
+pkr
+;
+
+249 
+r
+;
+
+255 
+	`IFQ_CLASSIFY
+(&
+i
+->
+if_d
+, 
+m
+, 
+d
+->
+_my
+, &
+pkr
+);
+
+257 
+	`M_PREPEND
+(
+m
+, (
+ut32_t
+), 
+M_DONTWAIT
+);
+
+258 i(
+m
+ =
+NULL
+)
+
+259  (
+ENOBUFS
+);
+
+260 *(
+	`mtod
+(
+m
+, 
+ut32_t
+ *)
+d
+->
+_my
+;
+
+262 
+s
+ = 
+	`
+();
+
+263 
+	`IFQ_ENQUEUE
+(&
+i
+->
+if_d
+, 
+m
+, &
+pkr
+, 
+r
+);
+
+264 (*
+i
+->
+if_t
+)(ifp);
+
+265 
+	`lx
+(
+s
+);
+
+266  (
+r
+);
+
+270 
+	`m_g_de_nrsit
+(
+m
+);
+
+272 #ifde
+MPLS
+
+
+273 i(
+
+ !
+NULL
+ && 
+	`_gg
+(rt) != NULL &&
+
+274 
+	`_gg
+(
+
+)->
+_my
+ =
+AF_MPLS
+ &&
+
+275 (
+m
+->
+m_ags
+ & (
+M_MCAST
+ | 
+M_BCAST
+)) == 0) {
+
+276 
+ms_shim
+ 
+msh
+;
+
+277 
+msh
+.
+s_addr
+ = 
+	`MPLS_GETSADDR
+(
+
+);
+
+278 i(
+msh
+.
+shim
+.
+b
+ !
+MPLS_LABEL_IMPLNULL
+) {
+
+279 
+ifq
+ = &
+msq
+;
+
+280 
+i
+ = 
+NETISR_MPLS
+;
+
+283 i(
+i
+ !
+NETISR_MPLS
+)
+
+285 
+d
+->
+_my
+) {
+
+287 #ifde
+INET
+
+
+288 
+AF_INET
+:
+
+289 
+csum_ags
+ = 
+m
+->
+m_pkthdr
+.csum_flags;
+
+290 
+	`KASSERT
+((
+csum_ags
+ & ~(
+M_CSUM_IPv4
+|
+M_CSUM_UDPv4
+)) == 0);
+
+291 i(
+csum_ags
+ !0 && 
+	`IN_LOOPBACK_NEED_CHECKSUM
+(csum_flags)) {
+
+292 
+	`_under_csum
+(
+m
+, 0, 
+csum_ags
+);
+
+294 
+m
+->
+m_pkthdr
+.
+csum_ags
+ = 0;
+
+295 
+pktq
+ = 
+_pktq
+;
+
+298 #ifde
+INET6
+
+
+299 
+AF_INET6
+:
+
+300 
+csum_ags
+ = 
+m
+->
+m_pkthdr
+.csum_flags;
+
+301 
+	`KASSERT
+((
+csum_ags
+ & ~
+M_CSUM_UDPv6
+) == 0);
+
+302 i(
+csum_ags
+ != 0 &&
+
+303 
+	`IN6_LOOPBACK_NEED_CHECKSUM
+(
+csum_ags
+)) {
+
+304 
+	`6_under_csum
+(
+m
+, 0, 
+csum_ags
+);
+
+306 
+m
+->
+m_pkthdr
+.
+csum_ags
+ = 0;
+
+307 
+m
+->
+m_ags
+ |
+M_LOOP
+;
+
+308 
+pktq
+ = 
+6_pktq
+;
+
+311 #ifde
+IPX
+
+
+312 
+AF_IPX
+:
+
+313 
+ifq
+ = &
+xq
+;
+
+314 
+i
+ = 
+NETISR_IPX
+;
+
+317 #ifde
+NETATALK
+
+
+318 
+AF_APPLETALK
+:
+
+319 
+ifq
+ = &
+q2
+;
+
+320 
+i
+ = 
+NETISR_ATALK
+;
+
+324 
+	`tf
+("%s: c'hdf%d\n", 
+i
+->
+if_xme
+,
+
+325 
+d
+->
+_my
+);
+
+326 
+	`m_m
+(
+m
+);
+
+327  (
+EAFNOSUPPORT
+);
+
+330 
+s
+ = 
+	`
+();
+
+331 i(
+	`__edi_ue
+(
+pktq
+)) {
+
+332 
+r
+ = 0;
+
+334 i(
+	`__edi_ue
+(
+	`pktq_queue
+(
+pktq
+, 
+m
+, 0))) {
+
+335 
+i
+->
+if_acks
+++;
+
+336 
+i
+->
+if_ibys
+ +
+pk
+;
+
+338 
+	`m_m
+(
+m
+);
+
+339 
+r
+ = 
+ENOBUFS
+;
+
+341 
+	`lx
+(
+s
+);
+
+342  
+r
+;
+
+344 i(
+	`IF_QFULL
+(
+ifq
+)) {
+
+345 
+	`IF_DROP
+(
+ifq
+);
+
+346 
+	`m_m
+(
+m
+);
+
+347 
+	`lx
+(
+s
+);
+
+348  (
+ENOBUFS
+);
+
+350 
+	`IF_ENQUEUE
+(
+ifq
+, 
+m
+);
+
+351 
+	`schedti
+(
+i
+);
+
+352 
+i
+->
+if_acks
+++;
+
+353 
+i
+->
+if_ibys
+ +
+m
+->
+m_pkthdr
+.
+n
+;
+
+354 
+	`lx
+(
+s
+);
+
+356 
+	}
+}
+
+358 #ifde
+ALTQ
+
+
+360 
+	$lot
+(
+i
+ *
+i
+)
+
+363 
+pktqueue_t
+ *
+pktq
+ = 
+NULL
+;
+
+364 
+ifqueue
+ *
+ifq
+ = 
+NULL
+;
+
+365 
+mbuf
+ *
+m
+;
+
+366 
+size_t
+ 
+pk
+;
+
+367 
+ut32_t
+ 
+af
+;
+
+368 
+s
+, 
+i
+ = 0;
+
+370 
+	`IFQ_DEQUEUE
+(&
+i
+->
+if_d
+, 
+m
+);
+
+371 i(
+m
+ =
+NULL
+)
+
+374 
+af
+ = *(
+	`mtod
+(
+m
+, 
+ut32_t
+ *));
+
+375 
+	`m_adj
+(
+m
+, (
+ut32_t
+));
+
+377 
+af
+) {
+
+378 #ifde
+INET
+
+
+379 
+AF_INET
+:
+
+380 
+pktq
+ = 
+_pktq
+;
+
+383 #ifde
+INET6
+
+
+384 
+AF_INET6
+:
+
+385 
+m
+->
+m_ags
+ |
+M_LOOP
+;
+
+386 
+pktq
+ = 
+6_pktq
+;
+
+389 #ifde
+IPX
+
+
+390 
+AF_IPX
+:
+
+391 
+ifq
+ = &
+xq
+;
+
+392 
+i
+ = 
+NETISR_IPX
+;
+
+395 #ifde
+NETATALK
+
+
+396 
+AF_APPLETALK
+:
+
+397 
+ifq
+ = &
+q2
+;
+
+398 
+i
+ = 
+NETISR_ATALK
+;
+
+402 
+	`tf
+("%s: c'hdf%d\n", 
+i
+->
+if_xme
+, 
+af
+);
+
+403 
+	`m_m
+(
+m
+);
+
+406 
+pk
+ = 
+m
+->
+m_pkthdr
+.
+n
+;
+
+408 
+s
+ = 
+	`
+();
+
+409 i(
+	`__edi_ue
+(
+pktq
+)) {
+
+410 i(
+	`__edi_l
+(
+	`pktq_queue
+(
+pktq
+, 
+m
+, 0))) {
+
+411 
+	`m_m
+(
+m
+);
+
+412 
+	`lx
+(
+s
+);
+
+415 
+i
+->
+if_acks
+++;
+
+416 
+i
+->
+if_ibys
+ +
+pk
+;
+
+417 
+	`lx
+(
+s
+);
+
+420 i(
+	`IF_QFULL
+(
+ifq
+)) {
+
+421 
+	`IF_DROP
+(
+ifq
+);
+
+422 
+	`lx
+(
+s
+);
+
+423 
+	`m_m
+(
+m
+);
+
+426 
+	`IF_ENQUEUE
+(
+ifq
+, 
+m
+);
+
+427 
+	`schedti
+(
+i
+);
+
+428 
+i
+->
+if_acks
+++;
+
+429 
+i
+->
+if_ibys
+ +
+pk
+;
+
+430 
+	`lx
+(
+s
+);
+
+432 
+	}
+}
+
+437 
+	$leque
+(
+cmd
+, 
+y
+ *
+
+,
+
+438 c 
+_addrfo
+ *
+fo
+)
+
+441 i(
+
+)
+
+442 
+
+->
+_rmx
+.
+rmx_mtu
+ = 
+lo0i
+->
+if_mtu
+;
+
+443 
+	}
+}
+
+450 
+	$loiol
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+452 
+iddr
+ *
+i
+;
+
+453 
+ieq
+ *
+i
+ = 
+da
+;
+
+454 
+r
+ = 0;
+
+456 
+cmd
+) {
+
+458 
+SIOCINITIFADDR
+:
+
+459 
+i
+->
+if_ags
+ |
+IFF_UP
+;
+
+460 
+i
+ = (
+iddr
+ *)
+da
+;
+
+461 i(
+i
+ !
+NULL
+)
+
+462 
+i
+->
+i_que
+ = 
+leque
+;
+
+468 
+SIOCSIFMTU
+:
+
+469 i(()
+i
+->
+i_mtu
+ > 
+LOMTU_MAX
+)
+
+470 
+r
+ = 
+EINVAL
+;
+
+471 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)=
+ENETRESET
+){
+
+472 
+r
+ = 0;
+
+476 
+SIOCADDMULTI
+:
+
+477 
+SIOCDELMULTI
+:
+
+478 i(
+i
+ =
+NULL
+) {
+
+479 
+r
+ = 
+EAFNOSUPPORT
+;
+
+482 
+	`ieq_gaddr
+(
+cmd
+, 
+i
+)->
+_my
+) {
+
+484 #ifde
+INET
+
+
+485 
+AF_INET
+:
+
+488 #ifde
+INET6
+
+
+489 
+AF_INET6
+:
+
+494 
+r
+ = 
+EAFNOSUPPORT
+;
+
+500 
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+);
+
+502  (
+r
+);
+
+503 
+	}
+}
+
+	@if_media.c
+
+78 
+	~<sys/cdefs.h
+>
+
+79 
+__KERNEL_RCSID
+(0, "$NetBSD: if_media.c,v 1.30 2009/10/05 21:27:36 dyoung Exp $");
+
+81 
+	~<sys/m.h
+>
+
+82 
+	~<sys/sym.h
+>
+
+83 
+	~<sys/o.h
+>
+
+84 
+	~<sys/iol.h
+>
+
+85 
+	~<sys/sock.h
+>
+
+86 
+	~<sys/mloc.h
+>
+
+88 
+	~<t/if.h
+>
+
+89 
+	~<t/if_med.h
+>
+
+90 
+	~<t/ti.h
+>
+
+99 #ifde
+IFMEDIA_DEBUG
+
+
+100 
+	gifmed_debug
+ = 0;
+
+101 
+ifmed_twd
+();
+
+104 
+MALLOC_DEFINE
+(
+M_IFMEDIA
+, "ifmedia", "interface media state");
+
+110 
+	$ifmed_
+(
+ifmed
+ *
+ifm
+, 
+dt_mask
+,
+
+111 
+ifm_chge_cb_t
+ 
+chge_back
+, 
+ifm__cb_t
+ 
+us_back
+)
+
+114 
+	`TAILQ_INIT
+(&
+ifm
+->
+ifm_li
+);
+
+115 
+ifm
+->
+ifm_cur
+ = 
+NULL
+;
+
+116 
+ifm
+->
+ifm_med
+ = 0;
+
+117 
+ifm
+->
+ifm_mask
+ = 
+dt_mask
+;
+
+118 
+ifm
+->
+ifm_chge
+ = 
+chge_back
+;
+
+119 
+ifm
+->
+ifm_us
+ = 
+us_back
+;
+
+120 
+	}
+}
+
+123 
+	$ifmed_chge
+(
+ifmed
+ *
+ifm
+, 
+i
+ *
+i
+)
+
+125  (*
+ifm
+->
+ifm_chge
+)(
+i
+);
+
+126 
+	}
+}
+
+133 
+	$ifmed_add
+(
+ifmed
+ *
+ifm
+, 
+mwd
+, 
+da
+, *
+aux
+)
+
+135 
+ifmed_y
+ *
+y
+;
+
+137 #ifde
+IFMEDIA_DEBUG
+
+
+138 i(
+ifmed_debug
+) {
+
+139 i(
+ifm
+ =
+NULL
+) {
+
+140 
+	`tf
+("ifmedia_add:ull ifm\n");
+
+143 
+	`tf
+("Addingntry for ");
+
+144 
+	`ifmed_twd
+(
+mwd
+);
+
+148 
+y
+ = 
+	`mloc
+((*y), 
+M_IFMEDIA
+, 
+M_NOWAIT
+);
+
+149 i(
+y
+ =
+NULL
+)
+
+150 
+	`nic
+("ifmedia_add: can't mallocntry");
+
+152 
+y
+->
+ifm_med
+ = 
+mwd
+;
+
+153 
+y
+->
+ifm_da
+ = 
+da
+;
+
+154 
+y
+->
+ifm_aux
+ = 
+aux
+;
+
+156 
+	`TAILQ_INSERT_TAIL
+(&
+ifm
+->
+ifm_li
+, 
+y
+, ifm_list);
+
+157 
+	}
+}
+
+164 
+	$ifmed_li_add
+(
+ifmed
+ *
+ifm
+, 
+ifmed_y
+ *
+
+, 
+cou
+)
+
+166 
+i
+;
+
+168 
+i
+ = 0; i < 
+cou
+; i++)
+
+169 
+	`ifmed_add
+(
+ifm
+, 
+
+[
+i
+].
+ifm_med
+,p[i].
+ifm_da
+,
+
+170 
+
+[
+i
+].
+ifm_aux
+);
+
+171 
+	}
+}
+
+181 
+	$ifmed_t
+(
+ifmed
+ *
+ifm
+, 
+rg
+)
+
+183 
+ifmed_y
+ *
+mch
+;
+
+185 
+mch
+ = 
+	`ifmed_mch
+(
+ifm
+, 
+rg
+, ifm->
+ifm_mask
+);
+
+201 i(
+mch
+ =
+NULL
+) {
+
+202 
+	`tf
+("ifmedia_set:o match for 0x%x/0x%x\n",
+
+203 
+rg
+, ~
+ifm
+->
+ifm_mask
+);
+
+204 
+rg
+ = (rg & 
+IFM_NMASK
+| 
+IFM_NONE
+;
+
+205 
+mch
+ = 
+	`ifmed_mch
+(
+ifm
+, 
+rg
+, ifm->
+ifm_mask
+);
+
+206 i(
+mch
+ =
+NULL
+) {
+
+207 
+	`ifmed_add
+(
+ifm
+, 
+rg
+, 0, 
+NULL
+);
+
+208 
+mch
+ = 
+	`ifmed_mch
+(
+ifm
+, 
+rg
+, ifm->
+ifm_mask
+);
+
+209 i(
+mch
+ =
+NULL
+) {
+
+210 
+	`nic
+("ifmedia_set failed");
+
+214 
+ifm
+->
+ifm_cur
+ = 
+mch
+;
+
+216 #ifde
+IFMEDIA_DEBUG
+
+
+217 i(
+ifmed_debug
+) {
+
+218 
+	`tf
+("ifmedia_set:arget ");
+
+219 
+	`ifmed_twd
+(
+rg
+);
+
+220 
+	`tf
+("ifmedia_set: settingo ");
+
+221 
+	`ifmed_twd
+(
+ifm
+->
+ifm_cur
+->
+ifm_med
+);
+
+224 
+	}
+}
+
+230 
+	$ifmed_iol
+(
+i
+ *
+i
+, 
+ieq
+ *
+i
+, 
+ifmed
+ *
+ifm
+,
+
+231 
+u_lg
+ 
+cmd
+)
+
+233 
+ifmed_y
+ *
+mch
+;
+
+234 
+ifmedq
+ *
+ifmr
+ = (ifmedq *
+i
+;
+
+235 
+r
+ = 0;
+
+236 #ifde
+OSIOCSIFMEDIA
+
+
+237 
+oieq
+ *
+oi
+ = (oieq *)
+i
+;
+
+240 i(
+i
+ =
+NULL
+ || 
+i
+ =NULL || 
+ifm
+ == NULL)
+
+241  (
+EINVAL
+);
+
+243 
+cmd
+) {
+
+245 #ifde
+OSIOCSIFMEDIA
+
+
+246 
+OSIOCSIFMEDIA
+:
+
+247 
+i
+->
+i_med
+ = 
+oi
+->ifr_media;
+
+253 
+SIOCSIFMEDIA
+:
+
+255 
+ifmed_y
+ *
+dy
+;
+
+256 
+u_t
+ 
+dmed
+;
+
+257 
+u_t
+ 
+wmed
+ = 
+i
+->
+i_med
+;
+
+259 
+mch
+ = 
+	`ifmed_mch
+(
+ifm
+, 
+wmed
+, ifm->
+ifm_mask
+);
+
+260 i(
+mch
+ =
+NULL
+) {
+
+261 #ifde
+IFMEDIA_DEBUG
+
+
+262 i(
+ifmed_debug
+) {
+
+263 
+	`tf
+(
+
+265 
+wmed
+);
+
+268  (
+EINVAL
+);
+
+277 i((
+	`IFM_SUBTYPE
+(
+wmed
+!
+IFM_AUTO
+) &&
+
+278 (
+wmed
+ =
+ifm
+->
+ifm_med
+) &&
+
+279 (
+mch
+ =
+ifm
+->
+ifm_cur
+))
+
+287 #ifde
+IFMEDIA_DEBUG
+
+
+288 i(
+ifmed_debug
+) {
+
+289 
+	`tf
+("ifmedia_ioctl: switching %so ",
+
+290 
+i
+->
+if_xme
+);
+
+291 
+	`ifmed_twd
+(
+mch
+->
+ifm_med
+);
+
+294 
+dy
+ = 
+ifm
+->
+ifm_cur
+;
+
+295 
+dmed
+ = 
+ifm
+->
+ifm_med
+;
+
+296 
+ifm
+->
+ifm_cur
+ = 
+mch
+;
+
+297 
+ifm
+->
+ifm_med
+ = 
+wmed
+;
+
+298 
+r
+ = 
+	`ifmed_chge
+(
+ifm
+, 
+i
+);
+
+299 i(
+r
+) {
+
+300 
+ifm
+->
+ifm_cur
+ = 
+dy
+;
+
+301 
+ifm
+->
+ifm_med
+ = 
+dmed
+;
+
+309 
+SIOCGIFMEDIA
+:
+
+311 
+ifmed_y
+ *
+
+;
+
+312 
+size_t
+ 
+nwds
+;
+
+314 i(
+ifmr
+->
+ifm_cou
+ < 0)
+
+315  
+EINVAL
+;
+
+317 
+ifmr
+->
+ifm_aive
+ = ifmr->
+ifm_cut
+ = 
+ifm
+->
+ifm_cur
+ ?
+
+318 
+ifm
+->
+ifm_cur
+->
+ifm_med
+ : 
+IFM_NONE
+;
+
+319 
+ifmr
+->
+ifm_mask
+ = 
+ifm
+->ifm_mask;
+
+320 
+ifmr
+->
+ifm_us
+ = 0;
+
+322 (*
+ifm
+->
+ifm_us
+)(
+i
+, 
+ifmr
+);
+
+328 
+
+ = 
+	`TAILQ_FIRST
+(&
+ifm
+->
+ifm_li
+);
+
+329 
+nwds
+ = 0; 
+
+ !
+NULL
+;
+	`TAILQ_NEXT
+p, 
+ifm_li
+))
+
+330 
+nwds
+++;
+
+332 i(
+ifmr
+->
+ifm_cou
+ != 0) {
+
+333 
+size_t
+ 
+cou
+;
+
+334 
+size_t
+ 
+mwds
+ = 
+nwds
+ > (size_t)
+ifmr
+->
+ifm_cou
+
+
+335 ? (
+size_t
+)
+ifmr
+->
+ifm_cou
+
+
+336 : 
+nwds
+;
+
+337 *
+kr
+ = (*)
+	`mloc
+(
+mwds
+ * (),
+
+338 
+M_TEMP
+, 
+M_WAITOK
+);
+
+342 
+
+ = 
+	`TAILQ_FIRST
+(&
+ifm
+->
+ifm_li
+);
+
+343 
+cou
+ = 0; 
+
+ !
+NULL
+ && cou < 
+mwds
+;
+
+344 
+
+ = 
+	`TAILQ_NEXT
+p, 
+ifm_li
+), 
+cou
+++)
+
+345 
+kr
+[
+cou
+] = 
+
+->
+ifm_med
+;
+
+347 
+r
+ = 
+	`cyout
+(
+kr
+, 
+ifmr
+->
+ifm_uli
+,
+
+348 
+mwds
+ * ());
+
+349 i(
+r
+ =0 && 
+
+ !
+NULL
+)
+
+350 
+r
+ = 
+E2BIG
+;
+
+351 
+	`
+(
+kr
+, 
+M_TEMP
+);
+
+353 
+ifmr
+->
+ifm_cou
+ = 
+nwds
+;
+
+358  (
+EINVAL
+);
+
+361  (
+r
+);
+
+362 
+	}
+}
+
+367 
+ifmed_y
+ *
+
+368 
+	$ifmed_mch
+(
+ifmed
+ *
+ifm
+, 
+u_t
+ 
+rg
+, u_
+mask
+)
+
+370 
+ifmed_y
+ *
+mch
+, *
+xt
+;
+
+372 
+mch
+ = 
+NULL
+;
+
+373 
+mask
+ = ~mask;
+
+375 
+xt
+ = 
+	`TAILQ_FIRST
+(&
+ifm
+->
+ifm_li
+);ex!
+NULL
+;
+
+376 
+xt
+ = 
+	`TAILQ_NEXT
+ext, 
+ifm_li
+)) {
+
+377 i((
+xt
+->
+ifm_med
+ & 
+mask
+=(
+rg
+ & mask)) {
+
+378 i(
+mch
+) {
+
+379 #i
+	`defed
+(
+IFMEDIA_DEBUG
+|| defed(
+DIAGNOSTIC
+)
+
+380 
+	`tf
+("ifmedia_match: multiple match for "
+
+382 
+rg
+, 
+mask
+, 
+	`IFM_INST
+(
+mch
+->
+ifm_med
+));
+
+386 
+mch
+ = 
+xt
+;
+
+390  
+mch
+;
+
+391 
+	}
+}
+
+397 
+	$ifmed_de_
+(
+ifmed
+ *
+ifm
+, 
+u_t
+ 
+
+)
+
+399 
+ifmed_y
+ *
+i
+, *
+ni
+;
+
+401 
+i
+ = 
+	`TAILQ_FIRST
+(&
+ifm
+->
+ifm_li
+); i !
+NULL
+;
+
+402 
+i
+ = 
+ni
+) {
+
+403 
+ni
+ = 
+	`TAILQ_NEXT
+(
+i
+, 
+ifm_li
+);
+
+404 i(
+
+ =
+IFM_INST_ANY
+ ||
+
+405 
+
+ =
+	`IFM_INST
+(
+i
+->
+ifm_med
+)) {
+
+406 
+	`TAILQ_REMOVE
+(&
+ifm
+->
+ifm_li
+, 
+i
+, ifm_list);
+
+407 
+	`
+(
+i
+, 
+M_IFMEDIA
+);
+
+410 
+	}
+}
+
+413 
+	$ifmed_mov
+(
+ifmed
+ *
+ifm
+)
+
+415 
+ifmed_y
+ *
+i
+, *
+ni
+;
+
+417 
+i
+ = 
+	`TAILQ_FIRST
+(&
+ifm
+->
+ifm_li
+); i !
+NULL
+; i = 
+ni
+) {
+
+418 
+ni
+ = 
+	`TAILQ_NEXT
+(
+i
+, 
+ifm_li
+);
+
+419 
+	`TAILQ_REMOVE
+(&
+ifm
+->
+ifm_li
+, 
+i
+, ifm_list);
+
+420 
+	`
+(
+i
+, 
+M_IFMEDIA
+);
+
+422 
+	}
+}
+
+429 c 
+ifmed_baud
+ 
+	gifmed_baud_destis
+[] =
+
+430 
+IFM_BAUDRATE_DESCRIPTIONS
+;
+
+432 
+ut64_t
+
+
+433 
+	$ifmed_baud
+(
+mwd
+)
+
+435 
+i
+;
+
+437 
+i
+ = 0; 
+ifmed_baud_destis
+[i].
+ifmb_wd
+ != 0; i++) {
+
+438 i((
+mwd
+ & (
+IFM_NMASK
+|
+IFM_TMASK
+)) ==
+
+439 
+ifmed_baud_destis
+[
+i
+].
+ifmb_wd
+)
+
+440  (
+ifmed_baud_destis
+[
+i
+].
+ifmb_baud
+);
+
+445 
+	}
+}
+
+447 #ifde
+IFMEDIA_DEBUG
+
+
+449 c 
+ifmed_desti
+ 
+	gifm_ty_destis
+[] =
+
+450 
+IFM_TYPE_DESCRIPTIONS
+;
+
+452 c 
+ifmed_desti
+ 
+	gifm_subty_destis
+[] =
+
+453 
+IFM_SUBTYPE_DESCRIPTIONS
+;
+
+455 c 
+ifmed_desti
+ 
+	gifm_ti_destis
+[] =
+
+456 
+IFM_OPTION_DESCRIPTIONS
+;
+
+462 
+	$ifmed_twd
+(
+ifmw
+)
+
+464 c 
+ifmed_desti
+ *
+desc
+;
+
+465 
+_ti
+ = 0;
+
+468 
+desc
+ = 
+ifm_ty_destis
+; desc->
+ifmt_rg
+ !
+NULL
+;
+
+469 
+desc
+++) {
+
+470 i(
+	`IFM_TYPE
+(
+ifmw
+=
+desc
+->
+ifmt_wd
+)
+
+473 i(
+desc
+->
+ifmt_rg
+ =
+NULL
+)
+
+474 
+	`tf
+("<unknownype> ");
+
+476 
+	`tf
+("%", 
+desc
+->
+ifmt_rg
+);
+
+479 
+desc
+ = 
+ifm_subty_destis
+; desc->
+ifmt_rg
+ !
+NULL
+;
+
+480 
+desc
+++) {
+
+481 i(
+	`IFM_TYPE_MATCH
+(
+desc
+->
+ifmt_wd
+, 
+ifmw
+) &&
+
+482 
+	`IFM_SUBTYPE
+(
+desc
+->
+ifmt_wd
+=IFM_SUBTYPE(
+ifmw
+))
+
+485 i(
+desc
+->
+ifmt_rg
+ =
+NULL
+)
+
+486 
+	`tf
+("<unknown subtype>");
+
+488 
+	`tf
+("%s", 
+desc
+->
+ifmt_rg
+);
+
+491 
+desc
+ = 
+ifm_ti_destis
+; desc->
+ifmt_rg
+ !
+NULL
+;
+
+492 
+desc
+++) {
+
+493 i(
+	`IFM_TYPE_MATCH
+(
+desc
+->
+ifmt_wd
+, 
+ifmw
+) &&
+
+494 (
+ifmw
+ & 
+desc
+->
+ifmt_wd
+) != 0 &&
+
+495 (
+_ti
+ & 
+	`IFM_OPTIONS
+(
+desc
+->
+ifmt_wd
+)) == 0) {
+
+496 i(
+_ti
+ == 0)
+
+497 
+	`tf
+(" <");
+
+498 
+	`tf
+("%s%s", 
+_ti
+ ? "," : "",
+
+499 
+desc
+->
+ifmt_rg
+);
+
+500 
+_ti
+ |
+	`IFM_OPTIONS
+(
+desc
+->
+ifmt_wd
+);
+
+503 
+	`tf
+("%s\n", 
+_ti
+ ? ">" : "");
+
+504 
+	}
+}
+
+	@if_media.h
+
+67 #ide
+_NET_IF_MEDIA_H_
+
+
+68 
+	#_NET_IF_MEDIA_H_
+
+
+	)
+
+82 #ifde
+_KERNEL
+
+
+84 
+	~<sys/queue.h
+>
+
+89 (*
+	tifm_chge_cb_t
+)(
+	ti
+ *);
+
+90 (*
+	tifm__cb_t
+)(
+	ti
+ *, 
+	tifmedq
+ *);
+
+95 
+	sifmed_y
+ {
+
+96 
+	`TAILQ_ENTRY
+(
+ifmed_y
+
+ifm_li
+;
+
+97 
+u_t
+ 
+ifm_med
+;
+
+98 
+u_t
+ 
+ifm_da
+;
+
+99 *
+ifm_aux
+;
+
+106 
+	sifmed
+ {
+
+107 
+u_t
+ 
+ifm_mask
+;
+
+108 
+u_t
+ 
+ifm_med
+;
+
+109 
+ifmed_y
+ *
+ifm_cur
+;
+
+110 
+	`TAILQ_HEAD
+(, 
+ifmed_y
+
+ifm_li
+;
+
+111 
+ifm_chge_cb_t
+ 
+ifm_chge
+;
+
+112 
+ifm__cb_t
+ 
+ifm_us
+;
+
+116 
+	`ifmed_
+(
+ifmed
+ *, , 
+ifm_chge_cb_t
+, 
+ifm__cb_t
+);
+
+118 
+	`ifmed_chge
+(
+ifmed
+ *, 
+i
+ *);
+
+121 
+	`ifmed_add
+(
+ifmed
+ *, , , *);
+
+124 
+	`ifmed_li_add
+(
+ifmed
+ *, 
+ifmed_y
+ *, );
+
+127 
+	`ifmed_t
+(
+ifmed
+ *
+ifm
+, 
+mwd
+);
+
+130 
+	`ifmed_iol
+(
+i
+ *, 
+ieq
+ *, 
+ifmed
+ *, 
+u_lg
+);
+
+133 
+ifmed_y
+ *
+	`ifmed_mch
+(
+ifmed
+ *, 
+u_t
+, u_int);
+
+136 
+	`ifmed_de_
+(
+ifmed
+ *, 
+u_t
+);
+
+139 
+ut64_t
+ 
+	`ifmed_baud
+();
+
+142 
+	`ifmed_mov
+(
+ifmed
+ *);
+
+162 
+	#IFM_ETHER
+ 0x00000020
+
+	)
+
+163 
+	#IFM_10_T
+ 3
+
+	)
+
+164 
+	#IFM_10_2
+ 4
+
+	)
+
+165 
+	#IFM_10_5
+ 5
+
+	)
+
+166 
+	#IFM_100_TX
+ 6
+
+	)
+
+167 
+	#IFM_100_FX
+ 7
+
+	)
+
+168 
+	#IFM_100_T4
+ 8
+
+	)
+
+169 
+	#IFM_100_VG
+ 9
+
+	)
+
+170 
+	#IFM_100_T2
+ 10
+
+	)
+
+171 
+	#IFM_1000_SX
+ 11
+
+	)
+
+172 
+	#IFM_10_STP
+ 12
+
+	)
+
+173 
+	#IFM_10_FL
+ 13
+
+	)
+
+174 
+	#IFM_1000_LX
+ 14
+
+	)
+
+175 
+	#IFM_1000_CX
+ 15
+
+	)
+
+176 
+	#IFM_1000_T
+ 16
+
+	)
+
+177 
+	#IFM_HPNA_1
+ 17
+
+	)
+
+178 
+	#IFM_10G_LR
+ 18
+
+	)
+
+179 
+	#IFM_10G_SR
+ 19
+
+	)
+
+180 
+	#IFM_10G_CX4
+ 20
+
+	)
+
+181 
+	#IFM_2500_SX
+ 21
+
+	)
+
+182 
+	#IFM_1000_BX10
+ 22
+
+	)
+
+183 
+	#IFM_10G_TWINAX
+ 23
+
+	)
+
+184 
+	#IFM_10G_TWINAX_LONG
+ 24
+
+	)
+
+185 
+	#IFM_10G_LRM
+ 25
+
+	)
+
+186 
+	#IFM_10G_T
+ 26
+
+	)
+
+188 
+	#IFM_ETH_MASTER
+ 0x00000100
+
+	)
+
+189 
+	#IFM_ETH_RXPAUSE
+ 0x00000200
+
+	)
+
+190 
+	#IFM_ETH_TXPAUSE
+ 0x00000400
+
+	)
+
+195 
+	#IFM_TOKEN
+ 0x00000040
+
+	)
+
+196 
+	#IFM_TOK_STP4
+ 3
+
+	)
+
+197 
+	#IFM_TOK_STP16
+ 4
+
+	)
+
+198 
+	#IFM_TOK_UTP4
+ 5
+
+	)
+
+199 
+	#IFM_TOK_UTP16
+ 6
+
+	)
+
+200 
+	#IFM_TOK_ETR
+ 0x00000200
+
+	)
+
+201 
+	#IFM_TOK_SRCRT
+ 0x00000400
+
+	)
+
+202 
+	#IFM_TOK_ALLR
+ 0x00000800
+
+	)
+
+207 
+	#IFM_FDDI
+ 0x00000060
+
+	)
+
+208 
+	#IFM_FDDI_SMF
+ 3
+
+	)
+
+209 
+	#IFM_FDDI_MMF
+ 4
+
+	)
+
+210 
+	#IFM_FDDI_UTP
+ 5
+
+	)
+
+211 
+	#IFM_FDDI_DA
+ 0x00000100
+
+	)
+
+216 
+	#IFM_IEEE80211
+ 0x00000080
+
+	)
+
+217 
+	#IFM_IEEE80211_FH1
+ 3
+
+	)
+
+218 
+	#IFM_IEEE80211_FH2
+ 4
+
+	)
+
+219 
+	#IFM_IEEE80211_DS2
+ 5
+
+	)
+
+220 
+	#IFM_IEEE80211_DS5
+ 6
+
+	)
+
+221 
+	#IFM_IEEE80211_DS11
+ 7
+
+	)
+
+222 
+	#IFM_IEEE80211_DS1
+ 8
+
+	)
+
+223 
+	#IFM_IEEE80211_DS22
+ 9
+
+	)
+
+224 
+	#IFM_IEEE80211_OFDM6
+ 10
+
+	)
+
+225 
+	#IFM_IEEE80211_OFDM9
+ 11
+
+	)
+
+226 
+	#IFM_IEEE80211_OFDM12
+ 12
+
+	)
+
+227 
+	#IFM_IEEE80211_OFDM18
+ 13
+
+	)
+
+228 
+	#IFM_IEEE80211_OFDM24
+ 14
+
+	)
+
+229 
+	#IFM_IEEE80211_OFDM36
+ 15
+
+	)
+
+230 
+	#IFM_IEEE80211_OFDM48
+ 16
+
+	)
+
+231 
+	#IFM_IEEE80211_OFDM54
+ 17
+
+	)
+
+232 
+	#IFM_IEEE80211_OFDM72
+ 18
+
+	)
+
+233 
+	#IFM_IEEE80211_DS354k
+ 19
+
+	)
+
+234 
+	#IFM_IEEE80211_DS512k
+ 20
+
+	)
+
+235 
+	#IFM_IEEE80211_OFDM3
+ 21
+
+	)
+
+236 
+	#IFM_IEEE80211_OFDM4
+ 22
+
+	)
+
+237 
+	#IFM_IEEE80211_OFDM27
+ 23
+
+	)
+
+239 
+	#IFM_IEEE80211_MCS
+ 24
+
+	)
+
+241 
+	#IFM_IEEE80211_ADHOC
+ 0x00000100
+
+	)
+
+242 
+	#IFM_IEEE80211_HOSTAP
+ 0x00000200
+
+	)
+
+243 
+	#IFM_IEEE80211_MONITOR
+ 0x00000400
+
+	)
+
+244 
+	#IFM_IEEE80211_TURBO
+ 0x00000800
+
+	)
+
+245 
+	#IFM_IEEE80211_IBSS
+ 0x00001000
+
+	)
+
+246 
+	#IFM_IEEE80211_WDS
+ 0x00002000
+
+	)
+
+247 
+	#IFM_IEEE80211_MBSS
+ 0x00004000
+
+	)
+
+250 
+	#IFM_IEEE80211_11A
+ 0x00010000
+
+	)
+
+251 
+	#IFM_IEEE80211_11B
+ 0x00020000
+
+	)
+
+252 
+	#IFM_IEEE80211_11G
+ 0x00030000
+
+	)
+
+253 
+	#IFM_IEEE80211_FH
+ 0x00040000
+
+	)
+
+254 
+	#IFM_IEEE80211_11NA
+ 0x00050000
+
+	)
+
+255 
+	#IFM_IEEE80211_11NG
+ 0x00060000
+
+	)
+
+261 
+	#IFM_CARP
+ 0x000000c0
+
+	)
+
+266 
+	#IFM_AUTO
+ 0
+
+	)
+
+267 
+	#IFM_MANUAL
+ 1
+
+	)
+
+268 
+	#IFM_NONE
+ 2
+
+	)
+
+273 
+	#IFM_FDX
+ 0x00100000
+
+	)
+
+274 
+	#IFM_HDX
+ 0x00200000
+
+	)
+
+275 
+	#IFM_FLOW
+ 0x00400000
+
+	)
+
+276 
+	#IFM_FLAG0
+ 0x01000000
+
+	)
+
+277 
+	#IFM_FLAG1
+ 0x02000000
+
+	)
+
+278 
+	#IFM_FLAG2
+ 0x04000000
+
+	)
+
+279 
+	#IFM_LOOP
+ 0x08000000
+
+	)
+
+284 
+	#IFM_NMASK
+ 0x000000e0
+
+	)
+
+285 
+	#IFM_TMASK
+ 0x0000001
+
+	)
+
+286 
+	#IFM_IMASK
+ 0xf0000000
+
+	)
+
+287 
+	#IFM_ISHIFT
+ 28
+
+	)
+
+288 
+	#IFM_OMASK
+ 0x0000ff00
+
+	)
+
+289 
+	#IFM_MMASK
+ 0x00070000
+
+	)
+
+290 
+	#IFM_MSHIFT
+ 16
+
+	)
+
+291 
+	#IFM_GMASK
+ 0x0ff00000
+
+	)
+
+294 
+	#IFM_ETH_FMASK
+ (
+IFM_FLOW
+ | 
+IFM_ETH_RXPAUSE
+ | 
+IFM_ETH_TXPAUSE
+)
+
+	)
+
+296 
+	#IFM_NMIN
+ 
+IFM_ETHER
+
+
+	)
+
+297 
+	#IFM_NMAX
+ 
+IFM_NMASK
+
+
+	)
+
+302 
+	#IFM_AVALID
+ 0x00000001
+
+	)
+
+303 
+	#IFM_ACTIVE
+ 0x00000002
+
+	)
+
+306 
+	#IFM_STATUS_VALID
+ 
+IFM_AVALID
+
+
+	)
+
+309 
+	#IFM_STATUS_VALID_LIST
+ { \
+
+310 
+IFM_AVALID
+, \
+
+312 
+	}
+
+	)
+}
+
+317 
+	#IFM_TYPE
+(
+x
+((x& 
+IFM_NMASK
+)
+
+	)
+
+318 
+	#IFM_SUBTYPE
+(
+x
+((x& 
+IFM_TMASK
+)
+
+	)
+
+319 
+	#IFM_INST
+(
+x
+(((x& 
+IFM_IMASK
+>> 
+IFM_ISHIFT
+)
+
+	)
+
+320 
+	#IFM_OPTIONS
+(
+x
+((x& (
+IFM_OMASK
+ | 
+IFM_GMASK
+))
+
+	)
+
+321 
+	#IFM_MODE
+(
+x
+((x& 
+IFM_MMASK
+)
+
+	)
+
+323 
+	#IFM_INST_MAX
+ 
+	`IFM_INST
+(
+IFM_IMASK
+)
+
+	)
+
+324 
+	#IFM_INST_ANY
+ ((
+u_t
+-1)
+
+	)
+
+329 
+	#IFM_MAKEWORD
+(
+ty
+, 
+subty
+, 
+tis
+, 
+
+) \
+
+330 ((
+ty
+| (
+subty
+| (
+tis
+| ((
+
+<< 
+IFM_ISHIFT
+))
+
+	)
+
+331 
+	#IFM_MAKEMODE
+(
+mode
+) \
+
+332 (((
+mode
+<< 
+IFM_MSHIFT
+& 
+IFM_MMASK
+)
+
+	)
+
+347 
+	sifmed_desti
+ {
+
+348 
+	mifmt_wd
+;
+
+349 c *
+	mifmt_rg
+;
+
+352 
+	#IFM_TYPE_DESCRIPTIONS
+ { \
+
+353 { 
+IFM_ETHER
+, "Ethernet" }, \
+
+354 { 
+IFM_ETHER
+, "ether" }, \
+
+355 { 
+IFM_TOKEN
+, "TokenRing" }, \
+
+356 { 
+IFM_TOKEN
+, "token" }, \
+
+357 { 
+IFM_FDDI
+, "FDDI" }, \
+
+358 { 
+IFM_IEEE80211
+, "IEEE802.11" }, \
+
+359 { 
+IFM_CARP
+, "CARP" }, \
+
+360 { 0, 
+NULL
+ }, \
+
+361 }
+
+	)
+
+363 
+	#IFM_TYPE_MATCH
+(
+dt
+, 
+t
+) \
+
+364 (
+	`IFM_TYPE
+((
+dt
+)=0 || IFM_TYPE((dt)=IFM_TYPE((
+t
+)))
+
+	)
+
+366 
+	#IFM_SUBTYPE_DESCRIPTIONS
+ { \
+
+367 { 
+IFM_AUTO
+, "autoselect" }, \
+
+368 { 
+IFM_AUTO
+, "auto" }, \
+
+369 { 
+IFM_MANUAL
+, "manual" }, \
+
+370 { 
+IFM_NONE
+, "none" }, \
+
+372 { 
+IFM_ETHER
+ | 
+IFM_10_T
+, "10baseT" }, \
+
+373 { 
+IFM_ETHER
+ | 
+IFM_10_T
+, "10baseT/UTP" }, \
+
+374 { 
+IFM_ETHER
+ | 
+IFM_10_T
+, "UTP" }, \
+
+375 { 
+IFM_ETHER
+ | 
+IFM_10_T
+, "10UTP" }, \
+
+376 { 
+IFM_ETHER
+ | 
+IFM_10_T
+, "10BASE-T" }, \
+
+377 { 
+IFM_ETHER
+ | 
+IFM_10_2
+, "10base2" }, \
+
+378 { 
+IFM_ETHER
+ | 
+IFM_10_2
+, "10base2/BNC" }, \
+
+379 { 
+IFM_ETHER
+ | 
+IFM_10_2
+, "BNC" }, \
+
+380 { 
+IFM_ETHER
+ | 
+IFM_10_2
+, "10BNC" }, \
+
+381 { 
+IFM_ETHER
+ | 
+IFM_10_2
+, "10BASE2" }, \
+
+382 { 
+IFM_ETHER
+ | 
+IFM_10_5
+, "10base5" }, \
+
+383 { 
+IFM_ETHER
+ | 
+IFM_10_5
+, "10base5/AUI" }, \
+
+384 { 
+IFM_ETHER
+ | 
+IFM_10_5
+, "AUI" }, \
+
+385 { 
+IFM_ETHER
+ | 
+IFM_10_5
+, "10AUI" }, \
+
+386 { 
+IFM_ETHER
+ | 
+IFM_10_5
+, "10BASE5" }, \
+
+387 { 
+IFM_ETHER
+ | 
+IFM_100_TX
+, "100baseTX" }, \
+
+388 { 
+IFM_ETHER
+ | 
+IFM_100_TX
+, "100TX" }, \
+
+389 { 
+IFM_ETHER
+ | 
+IFM_100_TX
+, "100BASE-TX" }, \
+
+390 { 
+IFM_ETHER
+ | 
+IFM_100_FX
+, "100baseFX" }, \
+
+391 { 
+IFM_ETHER
+ | 
+IFM_100_FX
+, "100FX" }, \
+
+392 { 
+IFM_ETHER
+ | 
+IFM_100_FX
+, "100BASE-FX" }, \
+
+393 { 
+IFM_ETHER
+ | 
+IFM_100_T4
+, "100baseT4" }, \
+
+394 { 
+IFM_ETHER
+ | 
+IFM_100_T4
+, "100T4" }, \
+
+395 { 
+IFM_ETHER
+ | 
+IFM_100_T4
+, "100BASE-T4" }, \
+
+396 { 
+IFM_ETHER
+ | 
+IFM_100_VG
+, "100baseVG" }, \
+
+397 { 
+IFM_ETHER
+ | 
+IFM_100_VG
+, "100VG" }, \
+
+398 { 
+IFM_ETHER
+ | 
+IFM_100_VG
+, "100VG-AnyLAN" }, \
+
+399 { 
+IFM_ETHER
+ | 
+IFM_100_T2
+, "100baseT2" }, \
+
+400 { 
+IFM_ETHER
+ | 
+IFM_100_T2
+, "100T2" }, \
+
+401 { 
+IFM_ETHER
+ | 
+IFM_100_T2
+, "100BASE-T2" }, \
+
+402 { 
+IFM_ETHER
+ | 
+IFM_1000_SX
+, "1000baseSX" }, \
+
+403 { 
+IFM_ETHER
+ | 
+IFM_1000_SX
+, "1000SX" }, \
+
+404 { 
+IFM_ETHER
+ | 
+IFM_1000_SX
+, "1000BASE-SX" }, \
+
+405 { 
+IFM_ETHER
+ | 
+IFM_10_STP
+, "10baseSTP" }, \
+
+406 { 
+IFM_ETHER
+ | 
+IFM_10_STP
+, "STP" }, \
+
+407 { 
+IFM_ETHER
+ | 
+IFM_10_STP
+, "10STP" }, \
+
+408 { 
+IFM_ETHER
+ | 
+IFM_10_STP
+, "10BASE-STP" }, \
+
+409 { 
+IFM_ETHER
+ | 
+IFM_10_FL
+, "10baseFL" }, \
+
+410 { 
+IFM_ETHER
+ | 
+IFM_10_FL
+, "FL" }, \
+
+411 { 
+IFM_ETHER
+ | 
+IFM_10_FL
+, "10FL" }, \
+
+412 { 
+IFM_ETHER
+ | 
+IFM_10_FL
+, "10BASE-FL" }, \
+
+413 { 
+IFM_ETHER
+ | 
+IFM_1000_LX
+, "1000baseLX" }, \
+
+414 { 
+IFM_ETHER
+ | 
+IFM_1000_LX
+, "1000LX" }, \
+
+415 { 
+IFM_ETHER
+ | 
+IFM_1000_LX
+, "1000BASE-LX" }, \
+
+416 { 
+IFM_ETHER
+ | 
+IFM_1000_CX
+, "1000baseCX" }, \
+
+417 { 
+IFM_ETHER
+ | 
+IFM_1000_CX
+, "1000CX" }, \
+
+418 { 
+IFM_ETHER
+ | 
+IFM_1000_CX
+, "1000BASE-CX" }, \
+
+419 { 
+IFM_ETHER
+ | 
+IFM_1000_BX10
+, "1000BASE-BX10" }, \
+
+420 { 
+IFM_ETHER
+ | 
+IFM_1000_T
+, "1000baseT" }, \
+
+421 { 
+IFM_ETHER
+ | 
+IFM_1000_T
+, "1000T" }, \
+
+422 { 
+IFM_ETHER
+ | 
+IFM_1000_T
+, "1000BASE-T" }, \
+
+423 { 
+IFM_ETHER
+ | 
+IFM_HPNA_1
+, "HomePNA1" }, \
+
+424 { 
+IFM_ETHER
+ | 
+IFM_HPNA_1
+, "HPNA1" }, \
+
+425 { 
+IFM_ETHER
+ | 
+IFM_10G_LR
+, "10GbaseLR" }, \
+
+426 { 
+IFM_ETHER
+ | 
+IFM_10G_LR
+, "10GLR" }, \
+
+427 { 
+IFM_ETHER
+ | 
+IFM_10G_LR
+, "10GBASE-LR" }, \
+
+428 { 
+IFM_ETHER
+ | 
+IFM_10G_SR
+, "10GbaseSR" }, \
+
+429 { 
+IFM_ETHER
+ | 
+IFM_10G_SR
+, "10GSR" }, \
+
+430 { 
+IFM_ETHER
+ | 
+IFM_10G_SR
+, "10GBASE-SR" }, \
+
+431 { 
+IFM_ETHER
+ | 
+IFM_10G_LRM
+, "10Gbase-LRM" }, \
+
+432 { 
+IFM_ETHER
+ | 
+IFM_10G_TWINAX
+, "10Gbase-Twinax" }, \
+
+433 { 
+IFM_ETHER
+ | 
+IFM_10G_TWINAX_LONG
+, "10Gbase-Twinax-Long" },\
+
+434 { 
+IFM_ETHER
+ | 
+IFM_10G_T
+, "10Gbase-T" }, \
+
+435 { 
+IFM_ETHER
+ | 
+IFM_10G_CX4
+, "10GbaseCX4" }, \
+
+436 { 
+IFM_ETHER
+ | 
+IFM_10G_CX4
+, "10GCX4" }, \
+
+437 { 
+IFM_ETHER
+ | 
+IFM_10G_CX4
+, "10GBASE-CX4" }, \
+
+438 { 
+IFM_ETHER
+ | 
+IFM_2500_SX
+, "2500baseSX" }, \
+
+439 { 
+IFM_ETHER
+ | 
+IFM_2500_SX
+, "2500SX" }, \
+
+441 { 
+IFM_TOKEN
+ | 
+IFM_TOK_STP4
+, "DB9/4Mbit" }, \
+
+442 { 
+IFM_TOKEN
+ | 
+IFM_TOK_STP4
+, "4STP" }, \
+
+443 { 
+IFM_TOKEN
+ | 
+IFM_TOK_STP16
+, "DB9/16Mbit" }, \
+
+444 { 
+IFM_TOKEN
+ | 
+IFM_TOK_STP16
+, "16STP" }, \
+
+445 { 
+IFM_TOKEN
+ | 
+IFM_TOK_UTP4
+, "UTP/4Mbit" }, \
+
+446 { 
+IFM_TOKEN
+ | 
+IFM_TOK_UTP4
+, "4UTP" }, \
+
+447 { 
+IFM_TOKEN
+ | 
+IFM_TOK_UTP16
+, "UTP/16Mbit" }, \
+
+448 { 
+IFM_TOKEN
+ | 
+IFM_TOK_UTP16
+, "16UTP" }, \
+
+450 { 
+IFM_FDDI
+ | 
+IFM_FDDI_SMF
+, "Single-mode" }, \
+
+451 { 
+IFM_FDDI
+ | 
+IFM_FDDI_SMF
+, "SMF" }, \
+
+452 { 
+IFM_FDDI
+ | 
+IFM_FDDI_MMF
+, "Multi-mode" }, \
+
+453 { 
+IFM_FDDI
+ | 
+IFM_FDDI_MMF
+, "MMF" }, \
+
+454 { 
+IFM_FDDI
+ | 
+IFM_FDDI_UTP
+, "UTP" }, \
+
+455 { 
+IFM_FDDI
+ | 
+IFM_FDDI_UTP
+, "CDDI" }, \
+
+460 { 
+IFM_ETHER
+ | 
+IFM_10_T
+ | 
+IFM_FDX
+, "10baseT-FDX" }, \
+
+461 { 
+IFM_ETHER
+ | 
+IFM_10_T
+ | 
+IFM_FDX
+, "10BASE-T-FDX" }, \
+
+462 { 
+IFM_ETHER
+ | 
+IFM_100_TX
+ | 
+IFM_FDX
+, "100baseTX-FDX" }, \
+
+463 { 
+IFM_ETHER
+ | 
+IFM_100_TX
+ | 
+IFM_FDX
+, "100BASE-TX-FDX" }, \
+
+464 { 
+IFM_ETHER
+ | 
+IFM_1000_T
+ | 
+IFM_FDX
+, "1000baseT-FDX" }, \
+
+469 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_FH1
+, "FH1" }, \
+
+470 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_FH2
+, "FH2" }, \
+
+471 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_DS1
+, "DS1" }, \
+
+472 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_DS2
+, "DS2" }, \
+
+473 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_DS5
+, "DS5" }, \
+
+474 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_DS11
+, "DS11" }, \
+
+475 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_DS22
+, "DS22" }, \
+
+476 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_OFDM6
+, "OFDM6" }, \
+
+477 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_OFDM9
+, "OFDM9" }, \
+
+478 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_OFDM12
+, "OFDM12" }, \
+
+479 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_OFDM18
+, "OFDM18" }, \
+
+480 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_OFDM24
+, "OFDM24" }, \
+
+481 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_OFDM36
+, "OFDM36" }, \
+
+482 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_OFDM48
+, "OFDM48" }, \
+
+483 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_OFDM54
+, "OFDM54" }, \
+
+484 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_OFDM72
+, "OFDM72" }, \
+
+485 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_DS354k
+, "DS/354Kbps" }, \
+
+486 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_DS512k
+, "DS/512Kbps" }, \
+
+487 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_OFDM3
+, "OFDM/3Mbps" }, \
+
+488 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_OFDM4
+, "OFDM/4.5Mbps" }, \
+
+489 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_OFDM27
+, "OFDM/27Mbps" }, \
+
+491 { 0, 
+NULL
+ }, \
+
+492 }
+
+	)
+
+494 
+	#IFM_MODE_DESCRIPTIONS
+ { \
+
+495 { 
+IFM_AUTO
+, "autoselect" }, \
+
+496 { 
+IFM_AUTO
+, "auto" }, \
+
+497 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_11A
+, "11a" }, \
+
+498 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_11B
+, "11b" }, \
+
+499 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_11G
+, "11g" }, \
+
+500 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_FH
+, "fh" }, \
+
+501 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_11NA
+, "11na" }, \
+
+502 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_11NG
+, "11ng" }, \
+
+503 { 0, 
+NULL
+ }, \
+
+504 }
+
+	)
+
+506 
+	#IFM_OPTION_DESCRIPTIONS
+ { \
+
+507 { 
+IFM_FDX
+, "full-duplex" }, \
+
+508 { 
+IFM_FDX
+, "fdx" }, \
+
+509 { 
+IFM_HDX
+, "half-duplex" }, \
+
+510 { 
+IFM_HDX
+, "hdx" }, \
+
+511 { 
+IFM_FLOW
+, "flowcontrol" }, \
+
+512 { 
+IFM_FLOW
+, "flow" }, \
+
+513 { 
+IFM_FLAG0
+, "flag0" }, \
+
+514 { 
+IFM_FLAG1
+, "flag1" }, \
+
+515 { 
+IFM_FLAG2
+, "flag2" }, \
+
+516 { 
+IFM_LOOP
+, "loopback" }, \
+
+517 { 
+IFM_LOOP
+, "hw-loopback"}, \
+
+518 { 
+IFM_LOOP
+, "loop" }, \
+
+520 { 
+IFM_ETHER
+ | 
+IFM_ETH_MASTER
+, "master" }, \
+
+521 { 
+IFM_ETHER
+ | 
+IFM_ETH_RXPAUSE
+, "rxpause" }, \
+
+522 { 
+IFM_ETHER
+ | 
+IFM_ETH_TXPAUSE
+, "txpause" }, \
+
+524 { 
+IFM_TOKEN
+ | 
+IFM_TOK_ETR
+, "EarlyTokenRelease" }, \
+
+525 { 
+IFM_TOKEN
+ | 
+IFM_TOK_ETR
+, "ETR" }, \
+
+526 { 
+IFM_TOKEN
+ | 
+IFM_TOK_SRCRT
+, "SourceRouting" }, \
+
+527 { 
+IFM_TOKEN
+ | 
+IFM_TOK_SRCRT
+, "SRCRT" }, \
+
+528 { 
+IFM_TOKEN
+ | 
+IFM_TOK_ALLR
+, "AllRoutes" }, \
+
+529 { 
+IFM_TOKEN
+ | 
+IFM_TOK_ALLR
+, "ALLR" }, \
+
+531 { 
+IFM_FDDI
+ | 
+IFM_FDDI_DA
+, "dual-attach" }, \
+
+532 { 
+IFM_FDDI
+ | 
+IFM_FDDI_DA
+, "das" }, \
+
+534 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_ADHOC
+, "adhoc" }, \
+
+535 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_HOSTAP
+, "hostap" }, \
+
+536 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_MONITOR
+,"monitor" }, \
+
+537 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_TURBO
+, "turbo" }, \
+
+538 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_IBSS
+, "ibss" }, \
+
+539 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_WDS
+, "wds" }, \
+
+540 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_MBSS
+, "mesh" }, \
+
+542 { 0, 
+NULL
+ }, \
+
+543 }
+
+	)
+
+548 
+	sifmed_baud
+ {
+
+549 
+	mifmb_wd
+;
+
+550 
+ut64_t
+ 
+	mifmb_baud
+;
+
+553 
+	#IFM_BAUDRATE_DESCRIPTIONS
+ { \
+
+554 { 
+IFM_ETHER
+ | 
+IFM_10_T
+, 
+	`IF_Mbps
+(10) }, \
+
+555 { 
+IFM_ETHER
+ | 
+IFM_10_2
+, 
+	`IF_Mbps
+(10) }, \
+
+556 { 
+IFM_ETHER
+ | 
+IFM_10_5
+, 
+	`IF_Mbps
+(10) }, \
+
+557 { 
+IFM_ETHER
+ | 
+IFM_100_TX
+, 
+	`IF_Mbps
+(100) }, \
+
+558 { 
+IFM_ETHER
+ | 
+IFM_100_FX
+, 
+	`IF_Mbps
+(100) }, \
+
+559 { 
+IFM_ETHER
+ | 
+IFM_100_T4
+, 
+	`IF_Mbps
+(100) }, \
+
+560 { 
+IFM_ETHER
+ | 
+IFM_100_VG
+, 
+	`IF_Mbps
+(100) }, \
+
+561 { 
+IFM_ETHER
+ | 
+IFM_100_T2
+, 
+	`IF_Mbps
+(100) }, \
+
+562 { 
+IFM_ETHER
+ | 
+IFM_1000_SX
+, 
+	`IF_Mbps
+(1000) }, \
+
+563 { 
+IFM_ETHER
+ | 
+IFM_10_STP
+, 
+	`IF_Mbps
+(10) }, \
+
+564 { 
+IFM_ETHER
+ | 
+IFM_10_FL
+, 
+	`IF_Mbps
+(10) }, \
+
+565 { 
+IFM_ETHER
+ | 
+IFM_1000_LX
+, 
+	`IF_Mbps
+(1000) }, \
+
+566 { 
+IFM_ETHER
+ | 
+IFM_1000_CX
+, 
+	`IF_Mbps
+(1000) }, \
+
+567 { 
+IFM_ETHER
+ | 
+IFM_1000_T
+, 
+	`IF_Mbps
+(1000) }, \
+
+568 { 
+IFM_ETHER
+ | 
+IFM_HPNA_1
+, 
+	`IF_Mbps
+(1) }, \
+
+569 { 
+IFM_ETHER
+ | 
+IFM_10G_LR
+, 
+	`IF_Gbps
+(10ULL) }, \
+
+570 { 
+IFM_ETHER
+ | 
+IFM_10G_SR
+, 
+	`IF_Gbps
+(10ULL) }, \
+
+571 { 
+IFM_ETHER
+ | 
+IFM_10G_CX4
+, 
+	`IF_Gbps
+(10ULL) }, \
+
+572 { 
+IFM_ETHER
+ | 
+IFM_2500_SX
+, 
+	`IF_Mbps
+(2500ULL) }, \
+
+574 { 
+IFM_TOKEN
+ | 
+IFM_TOK_STP4
+, 
+	`IF_Mbps
+(4) }, \
+
+575 { 
+IFM_TOKEN
+ | 
+IFM_TOK_STP16
+, 
+	`IF_Mbps
+(16) }, \
+
+576 { 
+IFM_TOKEN
+ | 
+IFM_TOK_UTP4
+, 
+	`IF_Mbps
+(4) }, \
+
+577 { 
+IFM_TOKEN
+ | 
+IFM_TOK_UTP16
+, 
+	`IF_Mbps
+(16) }, \
+
+579 { 
+IFM_FDDI
+ | 
+IFM_FDDI_SMF
+, 
+	`IF_Mbps
+(100) }, \
+
+580 { 
+IFM_FDDI
+ | 
+IFM_FDDI_MMF
+, 
+	`IF_Mbps
+(100) }, \
+
+581 { 
+IFM_FDDI
+ | 
+IFM_FDDI_UTP
+, 
+	`IF_Mbps
+(100) }, \
+
+583 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_FH1
+, 
+	`IF_Mbps
+(1) }, \
+
+584 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_FH2
+, 
+	`IF_Mbps
+(2) }, \
+
+585 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_DS2
+, 
+	`IF_Mbps
+(2) }, \
+
+586 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_DS5
+, 
+	`IF_Kbps
+(5500) }, \
+
+587 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_DS11
+, 
+	`IF_Mbps
+(11) }, \
+
+588 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_DS1
+, 
+	`IF_Mbps
+(1) }, \
+
+589 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_DS22
+, 
+	`IF_Mbps
+(22) }, \
+
+590 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_OFDM6
+, 
+	`IF_Mbps
+(6) }, \
+
+591 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_OFDM9
+, 
+	`IF_Mbps
+(9) }, \
+
+592 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_OFDM12
+, 
+	`IF_Mbps
+(12) }, \
+
+593 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_OFDM18
+, 
+	`IF_Mbps
+(18) }, \
+
+594 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_OFDM24
+, 
+	`IF_Mbps
+(24) }, \
+
+595 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_OFDM36
+, 
+	`IF_Mbps
+(36) }, \
+
+596 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_OFDM48
+, 
+	`IF_Mbps
+(48) }, \
+
+597 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_OFDM54
+, 
+	`IF_Mbps
+(54) }, \
+
+598 { 
+IFM_IEEE80211
+ | 
+IFM_IEEE80211_OFDM72
+, 
+	`IF_Mbps
+(72) }, \
+
+601 }
+
+	)
+
+606 
+	sifmed_us_desti
+ {
+
+607 
+	mifms_ty
+;
+
+608 
+	mifms_vid
+;
+
+609 
+	mifms_b
+;
+
+610 c *
+	mifms_rg
+[2];
+
+613 
+	#IFM_STATUS_DESC
+(
+ifms
+, 
+b
+) \
+
+614 (
+ifms
+)->
+ifms_rg
+[((ifms)->
+ifms_b
+ & (
+b
+)? 1 : 0]
+
+	)
+
+616 
+	#IFM_STATUS_DESCRIPTIONS
+ { \
+
+617 { 
+IFM_ETHER
+, 
+IFM_AVALID
+, 
+IFM_ACTIVE
+, \
+
+620 { 
+IFM_FDDI
+, 
+IFM_AVALID
+, 
+IFM_ACTIVE
+, \
+
+623 { 
+IFM_TOKEN
+, 
+IFM_AVALID
+, 
+IFM_ACTIVE
+, \
+
+626 { 
+IFM_IEEE80211
+, 
+IFM_AVALID
+, 
+IFM_ACTIVE
+, \
+
+629 { 
+IFM_CARP
+, 
+IFM_AVALID
+, 
+IFM_ACTIVE
+, \
+
+633 { 
+NULL
+, NULL } }, \
+
+634 }
+
+	)
+
+636 #ide
+_KERNEL
+
+
+638 c *
+g_med_ty_rg
+();
+
+639 c *
+g_med_subty_rg
+();
+
+640 c *
+g_med_mode_rg
+();
+
+641 c *
+g_med_ti_rg
+(*);
+
+642 
+g_med_mode
+(, const *);
+
+643 
+g_med_subty
+(, const *);
+
+644 
+g_med_tis
+(, const *, **);
+
+645 
+lookup_med_wd
+(
+ifmed_desti
+ *, , const *);
+
+	@if_mpls.c
+
+32 
+	~<sys/cdefs.h
+>
+
+33 
+__KERNEL_RCSID
+(0, "$NetBSD: if_mpls.c,v 1.16 2014/07/17 10:46:57 bouyer Exp $");
+
+35 
+	~"t_.h
+"
+
+36 
+	~"t_ms.h
+"
+
+38 
+	~<sys/m.h
+>
+
+40 
+	~<sys/o.h
+>
+
+41 
+	~<sys/mloc.h
+>
+
+42 
+	~<sys/mbuf.h
+>
+
+43 
+	~<sys/sysl.h
+>
+
+45 
+	~<t/bpf.h
+>
+
+46 
+	~<t/if.h
+>
+
+47 
+	~<t/if_tys.h
+>
+
+48 
+	~<t/ti.h
+>
+
+49 
+	~<t/rou.h
+>
+
+51 #ifde
+INET
+
+
+52 
+	~<t/.h
+>
+
+53 
+	~<t/_sym.h
+>
+
+54 
+	~<t/_v.h
+>
+
+55 
+	~<t/.h
+>
+
+58 #ifde
+INET6
+
+
+59 
+	~<t/6.h
+>
+
+60 
+	~<t6/6_v.h
+>
+
+61 
+	~<t6/6_v.h
+>
+
+64 
+	~<tms/ms.h
+>
+
+65 
+	~<tms/ms_v.h
+>
+
+67 
+	~"if_ms.h
+"
+
+69 
+	#TRIM_LABEL
+ do { \
+
+70 
+	`m_adj
+(
+m
+, (
+ms_shim
+)); \
+
+71 i(
+m
+->
+m_n
+ < (
+ms_shim
+) && \
+
+72 (
+m
+ = 
+	`m_puup
+(m, (
+ms_shim
+))=
+NULL
+) \
+
+73 
+de
+; \
+
+74 
+d
+.
+sms_addr
+.
+s_addr
+ = 
+	`ohl
+(
+	`mtod
+(
+m
+, 
+ms_shim
+ *)->s_addr); \
+
+75 }  0)
+
+	)
+
+78 
+ifmach
+();
+
+80 
+ms_e_
+(
+if_e
+ *, );
+
+81 
+ms_e_deroy
+(
+i
+ *);
+
+83 
+if_e
+ 
+	gms_if_
+ =
+
+84 
+IF_CLONE_INITIALIZER
+("ms", 
+ms_e_
+, 
+ms_e_deroy
+);
+
+87 
+ms_put
+(
+i
+ *, 
+mbuf
+ *);
+
+88 
+ms_ouut
+(
+i
+ *, 
+mbuf
+ *, c 
+sockaddr
+ *,
+
+89 
+y
+ *);
+
+90 
+ms_iol
+(
+i
+ *, 
+u_lg
+, *);
+
+91 
+ms_nd_ame
+(
+mbuf
+ *, 
+i
+ *, 
+y
+ *);
+
+92 
+ms_l
+(
+mbuf
+ *);
+
+94 #ifde
+INET
+
+
+95 
+ms_uab_
+(
+mbuf
+ *);
+
+96 
+mbuf
+ *
+ms_b_
+(mbu*, 
+ms_shim
+ *, 
+ut
+);
+
+99 #ifde
+INET6
+
+
+100 
+ms_uab_6
+(
+mbuf
+ *);
+
+101 
+mbuf
+ *
+ms_b_6
+(mbu*, 
+ms_shim
+ *, 
+ut
+);
+
+104 
+mbuf
+ *
+ms_d_shim
+(mbu*, 
+ms_shim
+ *);
+
+106 
+ms_de
+, 
+ms_ml_
+, 
+ms_ml_6
+, 
+ms_icmp_d
+,
+
+107 
+ms_fwdg
+, 
+ms_ame_ac
+, 
+ms_mec_
+, 
+ms_mass_6
+,
+
+108 
+ms_rfc4182
+;
+
+112 
+	$ifmach
+(
+cou
+)
+
+114 
+	`if_e_ch
+(&
+ms_if_
+);
+
+115 
+	}
+}
+
+118 
+	$ms_e_
+(
+if_e
+ *
+ifc
+, 
+un
+)
+
+120 
+ms_soc
+ *
+sc
+;
+
+122 
+sc
+ = 
+	`mloc
+((*sc), 
+M_DEVBUF
+, 
+M_WAITOK
+ | 
+M_ZERO
+);
+
+124 
+	`if_me
+(&
+sc
+->
+sc_if
+, 
+ifc
+->
+ifc_me
+, 
+un
+);
+
+125 
+sc
+->
+sc_if
+.
+if_soc
+ = sc;
+
+126 
+sc
+->
+sc_if
+.
+if_ty
+ = 
+IFT_MPLS
+;
+
+127 
+sc
+->
+sc_if
+.
+if_add
+ = 0;
+
+128 
+sc
+->
+sc_if
+.
+if_hd
+ = (
+ms_shim
+);
+
+129 
+sc
+->
+sc_if
+.
+if_d
+ = 
+DLT_NULL
+;
+
+130 
+sc
+->
+sc_if
+.
+if_mtu
+ = 1500;
+
+131 
+sc
+->
+sc_if
+.
+if_ags
+ = 0;
+
+132 
+sc
+->
+sc_if
+.
+if_put
+ = 
+ms_put
+;
+
+133 
+sc
+->
+sc_if
+.
+if_ouut
+ = 
+ms_ouut
+;
+
+134 
+sc
+->
+sc_if
+.
+if_iol
+ = 
+ms_iol
+;
+
+136 
+	`if_ch
+(&
+sc
+->
+sc_if
+);
+
+137 
+	`if_loc_dl
+(&
+sc
+->
+sc_if
+);
+
+138 
+	`bpf_ch
+(&
+sc
+->
+sc_if
+, 
+DLT_NULL
+, (
+ut32_t
+));
+
+140 
+	}
+}
+
+143 
+	$ms_e_deroy
+(
+i
+ *
+i
+)
+
+145 
+s
+;
+
+147 
+	`bpf_dach
+(
+i
+);
+
+149 
+s
+ = 
+	`
+();
+
+150 
+	`if_dach
+(
+i
+);
+
+151 
+	`lx
+(
+s
+);
+
+153 
+	`
+(
+i
+->
+if_soc
+, 
+M_DEVBUF
+);
+
+155 
+	}
+}
+
+158 
+	$ms_put
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+)
+
+166 
+	`bpf_mp_af
+(
+i
+, 
+AF_MPLS
+, 
+m
+);
+
+169 
+	`ms_l
+(
+m
+);
+
+170 
+	}
+}
+
+173 
+	$ms
+()
+
+175 
+mbuf
+ *
+m
+;
+
+176 
+s
+;
+
+178 !
+	`IF_IS_EMPTY
+(&
+msq
+)) {
+
+179 
+s
+ = 
+	`
+();
+
+180 
+	`IF_DEQUEUE
+(&
+msq
+, 
+m
+);
+
+181 
+	`lx
+(
+s
+);
+
+183 i(!
+m
+)
+
+186 i(((
+m
+->
+m_ags
+ & 
+M_PKTHDR
+) == 0) ||
+
+187 (
+m
+->
+m_pkthdr
+.
+rcvif
+ == 0))
+
+188 
+	`nic
+("mplsintr():okthdr orcvif");
+
+190 #ifde
+MBUFTRACE
+
+
+191 
+	`m_aimm
+(
+m
+, &
+ms_owr
+);
+
+193 
+	`ms_put
+(
+m
+->
+m_pkthdr
+.
+rcvif
+, m);
+
+195 
+	}
+}
+
+201 
+	$ms_ouut
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+, c 
+sockaddr
+ *
+d
+, 
+y
+ *
+
+)
+
+203 
+ms_shim
+ 
+mh
+, *
+pms
+;
+
+204 
+y
+ *
+1
+;
+
+205 
+r
+;
+
+206 
+ut
+ 
+psize
+ = (
+sockaddr_ms
+);
+
+208 
+	`KASSERT
+(
+	`KERNEL_LOCKED_P
+());
+
+210 i((
+i
+->
+if_ags
+ & (
+IFF_UP
+|
+IFF_RUNNING
+)) != (IFF_UP|IFF_RUNNING)) {
+
+211 
+	`m_m
+(
+m
+);
+
+212  
+ENETDOWN
+;
+
+215 i(
+	`_gg
+(
+
+=
+NULL
+ ||t_ggt)->
+_my
+ !
+AF_MPLS
+) {
+
+216 
+	`m_m
+(
+m
+);
+
+217  
+EINVAL
+;
+
+220 
+	`bpf_mp_af
+(
+i
+, 
+d
+->
+_my
+, 
+m
+);
+
+222 
+	`memt
+(&
+mh
+, 0, (mh));
+
+223 
+mh
+.
+s_addr
+ = 
+	`MPLS_GETSADDR
+(
+
+);
+
+224 
+mh
+.
+shim
+.
+bos
+ = 1;
+
+225 
+mh
+.
+shim
+.
+exp
+ = 0;
+
+226 
+mh
+.
+shim
+.
+l
+ = 
+ms_de
+;
+
+228 
+pms
+ = &((
+sockaddr_ms
+*)
+	`_gg
+(
+
+))->
+sms_addr
+;
+
+230 
+psize
+ <
+	`_gg
+(
+
+)->
+_n
+ - (
+mh
+)) {
+
+231 
+pms
+++;
+
+232 i(
+mh
+.
+shim
+.
+b
+ !
+MPLS_LABEL_IMPLNULL
+ &&
+
+233 ((
+m
+ = 
+	`ms_d_shim
+(m, &
+mh
+)=
+NULL
+))
+
+234  
+ENOBUFS
+;
+
+235 
+	`memt
+(&
+mh
+, 0, (mh));
+
+236 
+mh
+.
+s_addr
+ = 
+	`ohl
+(
+pms
+->s_addr);
+
+237 
+mh
+.
+shim
+.
+bos
+ = mh.shim.
+exp
+ = 0;
+
+238 
+mh
+.
+shim
+.
+l
+ = 
+ms_de
+;
+
+239 
+psize
+ +(
+mh
+);
+
+242 
+d
+->
+_my
+) {
+
+243 #ifde
+INET
+
+
+244 
+AF_INET
+:
+
+245 
+m
+ = 
+	`ms_b_
+(m, &
+mh
+, 
+psize
+ - (
+sockaddr_ms
+));
+
+248 #ifde
+INET6
+
+
+249 
+AF_INET6
+:
+
+250 
+m
+ = 
+	`ms_b_6
+(m, &
+mh
+, 
+psize
+ - (
+sockaddr_ms
+));
+
+254 
+m
+ = 
+	`ms_d_shim
+(m, &
+mh
+);
+
+258 i(
+m
+ =
+NULL
+) {
+
+259 
+	`IF_DROP
+(&
+i
+->
+if_d
+);
+
+260 
+i
+->
+if_s
+++;
+
+261  
+ENOBUFS
+;
+
+264 
+i
+->
+if_acks
+++;
+
+265 
+i
+->
+if_obys
+ +
+m
+->
+m_pkthdr
+.
+n
+;
+
+267 i((
+1
+=
+	`loc1
+(
+
+->
+_geway
+, 1)=
+NULL
+) {
+
+268 
+	`m_m
+(
+m
+);
+
+269  
+EHOSTUNREACH
+;
+
+272 
+r
+ = 
+	`ms_nd_ame
+(
+m
+, 
+1
+->
+_i
+, 
+
+);
+
+273 
+	`
+(
+1
+);
+
+274  
+r
+;
+
+275 
+	}
+}
+
+278 
+	$ms_iol
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+280 
+r
+ = 0, 
+s
+ = 
+	`
+();
+
+281 
+ieq
+ *
+i
+ = 
+da
+;
+
+283 
+cmd
+) {
+
+284 
+SIOCINITIFADDR
+:
+
+285 
+i
+->
+if_ags
+ |
+IFF_UP
+ | 
+IFF_RUNNING
+;
+
+287 
+SIOCSIFMTU
+:
+
+288 i(
+i
+ !
+NULL
+ && i->
+i_mtu
+ < 576) {
+
+289 
+r
+ = 
+EINVAL
+;
+
+293 
+SIOCGIFMTU
+:
+
+294 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)=
+ENETRESET
+)
+
+295 
+r
+ = 0;
+
+297 
+SIOCSIFFLAGS
+:
+
+298 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)) != 0)
+
+300 i(
+i
+->
+if_ags
+ & 
+IFF_UP
+)
+
+301 
+i
+->
+if_ags
+ |
+IFF_RUNNING
+;
+
+304 
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+);
+
+307 
+	`lx
+(
+s
+);
+
+308  
+r
+;
+
+309 
+	}
+}
+
+315 
+	$ms_l
+(
+mbuf
+ *
+m
+)
+
+317 
+sockaddr_ms
+ 
+d
+;
+
+318 
+ms_shim
+ 
+tshim
+, *
+hg
+;
+
+319 
+y
+ *
+
+ = 
+NULL
+;
+
+320 
+r
+ = 
+ENOBUFS
+;
+
+321 
+ut
+ 
+psize
+ = (
+sockaddr_ms
+);
+
+322 
+bo
+ 
+push_back_t
+ = 
+l
+;
+
+324 i(
+m
+->
+m_n
+ < (
+ms_shim
+) &&
+
+325 (
+m
+ = 
+	`m_puup
+(m, (
+ms_shim
+))=
+NULL
+)
+
+326 
+de
+;
+
+328 
+d
+.
+sms_n
+ = (
+sockaddr_ms
+);
+
+329 
+d
+.
+sms_my
+ = 
+AF_MPLS
+;
+
+330 
+d
+.
+sms_addr
+.
+s_addr
+ = 
+	`ohl
+(
+	`mtod
+(
+m
+, 
+ms_shim
+ *)->s_addr);
+
+333 
+r
+ = 
+EINVAL
+;
+
+334 i(!
+ms_ame_ac
+)
+
+335 
+de
+;
+
+338 i((
+m
+ = 
+	`ms_l_dec
+(m)=
+NULL
+)
+
+339 
+de
+;
+
+342 i(
+ms_rfc4182
+ != 0)
+
+343 (
+d
+.
+sms_addr
+.
+shim
+.
+b
+ =
+MPLS_LABEL_IPV4NULL
+ ||
+
+344 
+d
+.
+sms_addr
+.
+shim
+.
+b
+ =
+MPLS_LABEL_IPV6NULL
+) &&
+
+345 
+	`__edi_l
+(
+d
+.
+sms_addr
+.
+shim
+.
+bos
+ == 0))
+
+346 
+TRIM_LABEL
+;
+
+349 i(
+	`__edi_l
+(
+d
+.
+sms_addr
+.
+shim
+.
+b
+ =
+MPLS_LABEL_RTALERT
+) &&
+
+350 
+d
+.
+sms_addr
+.
+shim
+.
+bos
+ == 0) {
+
+351 
+TRIM_LABEL
+;
+
+352 
+push_back_t
+ = 
+ue
+;
+
+355 i(
+d
+.
+sms_addr
+.
+shim
+.
+b
+ <
+MPLS_LABEL_RESMAX
+) {
+
+357 
+d
+.
+sms_addr
+.
+shim
+.
+b
+) {
+
+358 #ifde
+INET
+
+
+359 
+MPLS_LABEL_IPV4NULL
+:
+
+361 i(
+d
+.
+sms_addr
+.
+shim
+.
+bos
+)
+
+362 
+r
+ = 
+	`ms_uab_
+(
+m
+);
+
+365 #ifde
+INET6
+
+
+366 
+MPLS_LABEL_IPV6NULL
+:
+
+368 i(
+d
+.
+sms_addr
+.
+shim
+.
+bos
+)
+
+369 
+r
+ = 
+	`ms_uab_6
+(
+m
+);
+
+372 
+MPLS_LABEL_RTALERT
+:
+
+373 
+MPLS_LABEL_IMPLNULL
+:
+
+377 
+de
+;
+
+381 
+r
+ = 
+EHOSTUNREACH
+;
+
+382 i(!
+ms_fwdg
+)
+
+383 
+de
+;
+
+386 
+d
+.
+sms_addr
+.
+shim
+.
+l
+ =
+
+387 
+d
+.
+sms_addr
+.
+shim
+.
+bos
+ =
+
+388 
+d
+.
+sms_addr
+.
+shim
+.
+exp
+ = 0;
+
+389 
+d
+.
+sms_addr
+.
+s_addr
+ = 
+	`htl
+(dst.smpls_addr.s_addr);
+
+390 i((
+
+ = 
+	`loc1
+((c 
+sockaddr
+*)&
+d
+, 1)=
+NULL
+)
+
+391 
+de
+;
+
+394 i((
+
+->
+_ags
+ & 
+RTF_GATEWAY
+) == 0 ||
+
+395 
+	`_gg
+(
+
+=
+NULL
+ ||
+
+396 
+	`_gg
+(
+
+)->
+_my
+ !
+AF_MPLS
+)
+
+397 
+de
+;
+
+399 
+tshim
+.
+s_addr
+ = 
+	`MPLS_GETSADDR
+(
+
+);
+
+402 i((
+m
+->
+m_n
+ < (
+ms_shim
+)) &&
+
+403 (
+m
+ = 
+	`m_puup
+(m, (
+ms_shim
+))) == 0) {
+
+404 
+r
+ = 
+ENOBUFS
+;
+
+405 
+de
+;
+
+409 
+hg
+ = 
+	`mtod
+(
+m
+, 
+ms_shim
+ *);
+
+410 
+hg
+->
+s_addr
+ = 
+	`ohl
+(htag->s_addr);
+
+411 
+hg
+->
+shim
+.
+b
+ = 
+tshim
+.shim.label;
+
+412 
+hg
+->
+s_addr
+ = 
+	`htl
+(htag->s_addr);
+
+415 
+hg
+ = &((
+sockaddr_ms
+*)
+	`_gg
+(
+
+))->
+sms_addr
+;
+
+416 
+psize
+ <
+	`_gg
+(
+
+)->
+_n
+ - (
+tshim
+)) {
+
+417 
+hg
+++;
+
+418 
+	`memt
+(&
+tshim
+, 0, (tshim));
+
+419 
+tshim
+.
+s_addr
+ = 
+	`ohl
+(
+hg
+->s_addr);
+
+420 
+tshim
+.
+shim
+.
+bos
+ =shim.shim.
+exp
+ = 0;
+
+421 
+tshim
+.
+shim
+.
+l
+ = 
+ms_de
+;
+
+422 i(
+tshim
+.
+shim
+.
+b
+ !
+MPLS_LABEL_IMPLNULL
+ &&
+
+423 ((
+m
+ = 
+	`ms_d_shim
+(m, &
+tshim
+)=
+NULL
+))
+
+424  
+ENOBUFS
+;
+
+425 
+psize
+ +(
+tshim
+);
+
+428 i(
+	`__edi_l
+(
+push_back_t
+ =
+ue
+)) {
+
+430 
+	`memt
+(&
+tshim
+, 0, (tshim));
+
+431 
+tshim
+.
+s_addr
+ = 
+MPLS_LABEL_RTALERT
+;
+
+432 
+tshim
+.
+shim
+.
+bos
+ =shim.shim.
+exp
+ = 0;
+
+433 
+tshim
+.
+shim
+.
+l
+ = 
+ms_de
+;
+
+434 i((
+m
+ = 
+	`ms_d_shim
+(m, &
+tshim
+)=
+NULL
+)
+
+435  
+ENOBUFS
+;
+
+438 
+r
+ = 
+	`ms_nd_ame
+(
+m
+, 
+
+->
+_i
+,t);
+
+440 
+de
+:
+
+441 i(
+r
+ !0 && 
+m
+ !
+NULL
+)
+
+442 
+	`m_m
+(
+m
+);
+
+443 i(
+
+ !
+NULL
+)
+
+444 
+	`
+(
+
+);
+
+446  
+r
+;
+
+447 
+	}
+}
+
+450 
+	$ms_nd_ame
+(
+mbuf
+ *
+m
+, 
+i
+ *
+i
+, 
+y
+ *
+
+)
+
+452 
+ms_shim
+ 
+msh
+;
+
+453 
+t
+;
+
+455 i((
+
+->
+_ags
+ & 
+RTF_GATEWAY
+) == 0)
+
+456  
+EHOSTUNREACH
+;
+
+458 
+
+->
+_u
+++;
+
+460 
+msh
+.
+s_addr
+ = 
+	`MPLS_GETSADDR
+(
+
+);
+
+461 i(
+msh
+.
+shim
+.
+b
+ =
+MPLS_LABEL_IMPLNULL
+ ||
+
+462 (
+m
+->
+m_ags
+ & (
+M_MCAST
+ | 
+M_BCAST
+))) {
+
+463 
+	`m_adj
+(
+m
+, (
+ms_shim
+));
+
+464 
+m
+->
+m_pkthdr
+.
+csum_ags
+ = 0;
+
+467 
+i
+->
+if_ty
+) {
+
+469 
+IFT_ETHER
+:
+
+470 
+IFT_TUNNEL
+:
+
+471 
+IFT_LOOP
+:
+
+472 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+473 
+t
+ = (*
+i
+->
+if_ouut
+)(i, 
+m
+, 
+
+->
+_geway
+,t);
+
+474 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+475  
+t
+;
+
+478  
+ENETUNREACH
+;
+
+481 
+	}
+}
+
+485 #ifde
+INET
+
+
+487 
+	$ms_uab_
+(
+mbuf
+ *
+m
+)
+
+489 
+
+ *
+h
+;
+
+490 
+ms_shim
+ *
+ms
+;
+
+491 
+hn
+;
+
+493 i(
+ms_ml_
+ || 
+ms_mec_
+) {
+
+496 
+ms
+ = 
+	`mtod
+(
+m
+, 
+ms_shim
+ *);
+
+497 
+ms
+->
+s_addr
+ = 
+	`ohl
+(ms->s_addr);
+
+500 
+	`m_adj
+(
+m
+, (
+ms_shim
+));
+
+503 i(
+m
+->
+m_n
+ <  (
+
+) &&
+
+504 (
+m
+ = 
+	`m_puup
+(m, (
+
+))=
+NULL
+)
+
+505  
+ENOBUFS
+;
+
+506 
+h
+ = 
+	`mtod
+(
+m
+, 
+
+ *);
+
+507 
+hn
+ = 
+h
+->
+_hl
+ << 2;
+
+510 i(
+m
+->
+m_n
+ < 
+hn
+) {
+
+511 i((
+m
+ = 
+	`m_puup
+(m, 
+hn
+)=
+NULL
+)
+
+512  
+ENOBUFS
+;
+
+513 
+h
+ = 
+	`mtod
+(
+m
+, 
+
+ *);
+
+517 i(
+	`_cksum
+(
+m
+, 
+hn
+) != 0) {
+
+518 
+	`m_m
+(
+m
+);
+
+519  
+EINVAL
+;
+
+523 i(
+ms_ml_
+)
+
+524 
+h
+->
+_l
+ = 
+ms
+->
+shim
+.
+l
+;
+
+527 i(
+ms_mec_
+) {
+
+528 
+h
+->
+_tos
+ = (iph->ip_tos << 3) >> 3;
+
+529 
+h
+->
+_tos
+ |
+ms
+->
+shim
+.
+exp
+ << 5;
+
+533 
+h
+->
+_sum
+ = 0;
+
+534 
+h
+->
+_sum
+ = 
+	`_cksum
+(
+m
+, 
+hn
+);
+
+536 
+	`m_adj
+(
+m
+, (
+ms_shim
+));
+
+539 i(
+	`__edi_l
+(!
+	`pktq_queue
+(
+_pktq
+, 
+m
+, 0))) {
+
+540 
+	`m_m
+(
+m
+);
+
+541  
+ENOBUFS
+;
+
+544 
+	}
+}
+
+549 
+mbuf
+ *
+
+550 
+	$ms_b_
+(
+mbuf
+ *
+m
+, 
+ms_shim
+ *
+ms
+, 
+ut
+ 
+offt
+)
+
+552 
+
+ 
+hdr
+;
+
+554 i(
+ms_ml_
+ || 
+ms_mec_
+) {
+
+555 i((
+m
+->
+m_n
+ < (
+
+)) &&
+
+556 (
+m
+ = 
+	`m_puup
+(m, 
+offt
+ + (
+
+))) == 0)
+
+557  
+NULL
+;
+
+558 
+	`m_cyda
+(
+m
+, 
+offt
+, (
+
+), &
+hdr
+);
+
+561 i(
+ms_ml_
+)
+
+562 
+ms
+->
+shim
+.
+l
+ = 
+hdr
+.
+_l
+;
+
+565 i(
+ms_mec_
+)
+
+566 
+ms
+->
+shim
+.
+exp
+ = ((
+u_t8_t
+)
+hdr
+.
+_tos
+) >> 5;
+
+569 i((
+m
+ = 
+	`ms_d_shim
+(m, 
+ms
+)=
+NULL
+)
+
+570  
+NULL
+;
+
+572  
+m
+;
+
+573 
+	}
+}
+
+577 #ifde
+INET6
+
+
+580 
+	$ms_uab_6
+(
+mbuf
+ *
+m
+)
+
+582 
+6_hdr
+ *
+6hdr
+;
+
+583 
+ms_shim
+ 
+ms
+;
+
+586 i(
+ms_ml_6
+) {
+
+587 
+ms
+.
+s_addr
+ = 
+	`ohl
+(
+	`mtod
+(
+m
+, 
+ms_shim
+ *)->s_addr);
+
+588 
+	`m_adj
+(
+m
+, (
+ms_shim
+));
+
+590 i(
+m
+->
+m_n
+ <  (
+6_hdr
+) &&
+
+591 (
+m
+ = 
+	`m_puup
+(m, (
+6_hdr
+))) == 0)
+
+592  
+ENOBUFS
+;
+
+593 
+6hdr
+ = 
+	`mtod
+(
+m
+, 
+6_hdr
+ *);
+
+596 
+6hdr
+->
+6_hlim
+ = 
+ms
+.
+shim
+.
+l
+ + 1;
+
+598 
+	`m_adj
+(
+m
+, (
+ms_shim
+));
+
+601 i(
+	`__edi_l
+(!
+	`pktq_queue
+(
+6_pktq
+, 
+m
+, 0))) {
+
+602 
+	`m_m
+(
+m
+);
+
+603  
+ENOBUFS
+;
+
+606 
+	}
+}
+
+608 
+mbuf
+ *
+
+609 
+	$ms_b_6
+(
+mbuf
+ *
+m
+, 
+ms_shim
+ *
+ms
+, 
+ut
+ 
+offt
+)
+
+611 
+6_hdr
+ 
+6h
+;
+
+613 i(
+ms_ml_6
+ || 
+ms_mass_6
+) {
+
+614 i(
+m
+->
+m_n
+ < (
+6_hdr
+) &&
+
+615 (
+m
+ = 
+	`m_puup
+(m, 
+offt
+ + (
+6_hdr
+))) == 0)
+
+616  
+NULL
+;
+
+617 
+	`m_cyda
+(
+m
+, 
+offt
+, (
+6_hdr
+), &
+6h
+);
+
+619 i(
+ms_ml_6
+)
+
+620 
+ms
+->
+shim
+.
+l
+ = 
+6h
+.
+6_hlim
+;
+
+622 i(
+ms_mass_6
+)
+
+623 
+ms
+->
+shim
+.
+exp
+ = 
+6h
+.
+6_vfc
+ << 1 >> 5;
+
+626 i((
+m
+ = 
+	`ms_d_shim
+(m, 
+ms
+)=
+NULL
+)
+
+627  
+NULL
+;
+
+629  
+m
+;
+
+630 
+	}
+}
+
+634 
+mbuf
+ *
+
+635 
+	$ms_d_shim
+(
+mbuf
+ *
+m
+, 
+ms_shim
+ *
+ms
+)
+
+637 
+ms_shim
+ *
+shim
+;
+
+639 
+	`M_PREPEND
+(
+m
+, (*
+ms
+), 
+M_DONTWAIT
+);
+
+640 i(
+m
+ =
+NULL
+)
+
+641  
+NULL
+;
+
+643 i(
+m
+->
+m_n
+ < (
+ms_shim
+) &&
+
+644 (
+m
+ = 
+	`m_puup
+(m, (
+ms_shim
+))) == 0)
+
+645  
+NULL
+;
+
+647 
+shim
+ = 
+	`mtod
+(
+m
+, 
+ms_shim
+ *);
+
+649 
+	`memy
+(
+shim
+, 
+ms
+, (*shim));
+
+650 
+shim
+->
+s_addr
+ = 
+	`htl
+(shim->s_addr);
+
+652  
+m
+;
+
+653 
+	}
+}
+
+	@if_mpls.h
+
+32 #ide
+_NET_IF_MPLS_H_
+
+
+33 
+	#_NET_IF_MPLS_H_
+
+
+	)
+
+36 
+	sms_soc
+ {
+
+37 
+i
+ 
+	msc_if
+;
+
+	@if_ppp.c
+
+104 
+	~<sys/cdefs.h
+>
+
+105 
+__KERNEL_RCSID
+(0, "$NetBSD: if_ppp.c,v 1.147 2015/04/20 10:19:54oy Exp $");
+
+107 
+	~"p.h
+"
+
+109 
+	~"t_.h
+"
+
+110 
+	~"t_geway.h
+"
+
+111 
+	~"t_p.h
+"
+
+113 #ifde
+INET
+
+
+114 
+	#VJC
+
+
+	)
+
+116 
+	#PPP_COMPRESS
+
+
+	)
+
+118 
+	~<sys/m.h
+>
+
+119 
+	~<sys/oc.h
+>
+
+120 
+	~<sys/mbuf.h
+>
+
+121 
+	~<sys/sock.h
+>
+
+122 
+	~<sys/iol.h
+>
+
+123 
+	~<sys/kl.h
+>
+
+124 
+	~<sys/sym.h
+>
+
+125 
+	~<sys/time.h
+>
+
+126 
+	~<sys/mloc.h
+>
+
+127 
+	~<sys/modu.h
+>
+
+128 
+	~<sys/mux.h
+>
+
+129 
+	~<sys/.h
+>
+
+130 
+	~<sys/cf.h
+>
+
+131 
+	~<sys/kauth.h
+>
+
+132 
+	~<sys/.h
+>
+
+133 
+	~<sys/sockv.h
+>
+
+135 
+	~<t/if.h
+>
+
+136 
+	~<t/if_tys.h
+>
+
+137 
+	~<t/ti.h
+>
+
+138 
+	~<t/rou.h
+>
+
+139 #ifde
+PPP_FILTER
+
+
+140 
+	~<t/bpf.h
+>
+
+143 
+	~<t/.h
+>
+
+144 
+	~<t/_sym.h
+>
+
+145 
+	~<t/_v.h
+>
+
+146 #ifde
+INET
+
+
+147 
+	~<t/.h
+>
+
+150 
+	~<t/bpf.h
+>
+
+152 
+	~<t/.h
+>
+
+154 #ifde
+VJC
+
+
+155 
+	~<t/comess.h
+>
+
+158 
+	~<t/p_defs.h
+>
+
+159 
+	~<t/if_p.h
+>
+
+160 
+	~<t/if_pv.h
+>
+
+161 
+	~<sys/u.h
+>
+
+163 #ifde
+PPP_COMPRESS
+
+
+164 
+	#PACKETPTR
+ 
+mbuf
+ *
+
+	)
+
+165 
+	~<t/p-comp.h
+>
+
+168 
+psiol
+(
+i
+ *, 
+u_lg
+, *);
+
+169 
+p_queue
+(
+p_soc
+ *);
+
+170 
+p_c
+(
+p_soc
+ *, 
+mbuf
+ *
+m
+, 
+rcvd
+);
+
+171 
+p_c_od
+(
+p_soc
+ *);
+
+172 
+p_oc
+(
+p_soc
+ *, 
+mbuf
+ *);
+
+173 
+pdumpm
+(
+mbuf
+ *
+m0
+);
+
+174 #ifde
+ALTQ
+
+
+175 
+p_ift
+(
+i
+ *
+i
+);
+
+178 
+p
+(*);
+
+183 
+	#M_IS_CLUSTER
+(
+m
+((m)->
+m_ags
+ & 
+M_EXT
+)
+
+	)
+
+185 
+	#M_DATASTART
+(
+m
+) \
+
+186 (
+	`M_IS_CLUSTER
+(
+m
+? (m)->
+m_ext
+.
+ext_buf
+ : \
+
+187 (
+m
+)->
+m_ags
+ & 
+M_PKTHDR
+ ? (m)->
+m_pktd
+ : (m)->
+m_d
+)
+
+	)
+
+189 
+	#M_DATASIZE
+(
+m
+) \
+
+190 (
+	`M_IS_CLUSTER
+(
+m
+? (m)->
+m_ext
+.
+ext_size
+ : \
+
+191 (
+m
+)->
+m_ags
+ & 
+M_PKTHDR
+ ? 
+MHLEN
+: 
+MLEN
+)
+
+	)
+
+198 
+	#M_HIGHPRI
+ 
+M_LINK0
+
+
+	)
+
+199 
+	#M_ERRMARK
+ 
+M_LINK1
+
+
+	)
+
+201 
+p_e_
+(
+if_e
+ *, );
+
+202 
+p_e_deroy
+(
+i
+ *);
+
+204 
+p_soc
+ *
+p_
+(const *, );
+
+206 
+	$LIST_HEAD
+(, 
+p_soc
+
+p_soc_li
+;
+
+207 
+kmux_t
+ 
+p_li_lock
+;
+
+209 
+if_e
+ 
+p_
+ =
+
+210 
+	`IF_CLONE_INITIALIZER
+("p", 
+p_e_
+, 
+p_e_deroy
+);
+
+212 #ifde
+PPP_COMPRESS
+
+
+213 
+	`ONCE_DECL
+(
+p_comess_mtx_
+);
+
+214 
+	$LIST_HEAD
+(, 
+comess
+
+p_comesss
+ = { 
+NULL
+ 
+	}
+};
+
+215 
+kmux_t
+ 
+	gp_comesss_mtx
+;
+
+217 
+p_comess_
+();
+
+218 
+comess
+ *
+p_g_comess
+(
+ut8_t
+);
+
+219 
+p_comess_
+(
+comess
+ *);
+
+227 
+	$ach
+()
+
+229 
+lesw
+ 
+p_disc
+;
+
+231 i(
+	`yldisc_ch
+(&
+p_disc
+) != 0)
+
+232 
+	`nic
+("pppattach");
+
+234 
+	`mux_
+(&
+p_li_lock
+, 
+MUTEX_DEFAULT
+, 
+IPL_NONE
+);
+
+235 
+	`LIST_INIT
+(&
+p_soc_li
+);
+
+236 
+	`if_e_ch
+(&
+p_
+);
+
+237 
+	`RUN_ONCE
+(&
+p_comess_mtx_
+, 
+p_comess_
+);
+
+238 
+	}
+}
+
+240 
+p_soc
+ *
+
+241 
+	$p_
+(c *
+me
+, 
+un
+)
+
+243 
+p_soc
+ *
+sc
+, *
+sci
+, *
+s
+ = 
+NULL
+;
+
+245 
+sc
+ = 
+	`mloc
+((*sc), 
+M_DEVBUF
+, 
+M_WAIT
+|
+M_ZERO
+);
+
+247 
+	`mux_r
+(&
+p_li_lock
+);
+
+248 i(
+un
+ == -1) {
+
+249 
+i
+ = 0;
+
+250 
+	`LIST_FOREACH
+(
+sci
+, &
+p_soc_li
+, 
+sc_ii
+) {
+
+251 
+s
+ = 
+sci
+;
+
+252 i(
+i
+ < 
+sci
+->
+sc_un
+) {
+
+253 
+un
+ = 
+i
+;
+
+256 #ifde
+DIAGNOSTIC
+
+
+257 
+	`KASSERT
+(
+i
+ =
+sci
+->
+sc_un
+);
+
+259 
+i
+++;
+
+262 i(
+un
+ == -1)
+
+263 
+un
+ = 
+i
+;
+
+265 
+	`LIST_FOREACH
+(
+sci
+, &
+p_soc_li
+, 
+sc_ii
+) {
+
+266 
+s
+ = 
+sci
+;
+
+267 i(
+un
+ < 
+sci
+->
+sc_un
+)
+
+269 i(
+un
+ =
+sci
+->
+sc_un
+) {
+
+270 
+	`
+(
+sc
+, 
+M_DEVBUF
+);
+
+271  
+NULL
+;
+
+276 i(
+sci
+ !
+NULL
+)
+
+277 
+	`LIST_INSERT_BEFORE
+(
+sci
+, 
+sc
+, 
+sc_ii
+);
+
+278 i(
+s
+ !
+NULL
+)
+
+279 
+	`LIST_INSERT_AFTER
+(
+s
+, 
+sc
+, 
+sc_ii
+);
+
+281 
+	`LIST_INSERT_HEAD
+(&
+p_soc_li
+, 
+sc
+, 
+sc_ii
+);
+
+283 
+	`mux_ex
+(&
+p_li_lock
+);
+
+285 
+	`if_me
+(&
+sc
+->
+sc_if
+, 
+me
+, sc->
+sc_un
+ = 
+un
+);
+
+286 
+	`out_
+(&
+sc
+->
+sc_timo_ch
+, 0);
+
+287 
+sc
+->
+sc_if
+.
+if_soc
+ = sc;
+
+288 
+sc
+->
+sc_if
+.
+if_mtu
+ = 
+PPP_MTU
+;
+
+289 
+sc
+->
+sc_if
+.
+if_ags
+ = 
+IFF_POINTOPOINT
+ | 
+IFF_MULTICAST
+;
+
+290 
+sc
+->
+sc_if
+.
+if_ty
+ = 
+IFT_PPP
+;
+
+291 
+sc
+->
+sc_if
+.
+if_hd
+ = 
+PPP_HDRLEN
+;
+
+292 
+sc
+->
+sc_if
+.
+if_d
+ = 
+DLT_NULL
+;
+
+293 
+sc
+->
+sc_if
+.
+if_iol
+ = 
+psiol
+;
+
+294 
+sc
+->
+sc_if
+.
+if_ouut
+ = 
+pouut
+;
+
+295 #ifde
+ALTQ
+
+
+296 
+sc
+->
+sc_if
+.
+if_t
+ = 
+p_ift
+;
+
+298 
+	`IFQ_SET_MAXLEN
+(&
+sc
+->
+sc_if
+.
+if_d
+, 
+IFQ_MAXLEN
+);
+
+299 
+sc
+->
+sc_q
+.
+ifq_maxn
+ = 
+IFQ_MAXLEN
+;
+
+300 
+sc
+->
+sc_q
+.
+ifq_maxn
+ = 
+IFQ_MAXLEN
+;
+
+301 
+sc
+->
+sc_wq
+.
+ifq_maxn
+ = 
+IFQ_MAXLEN
+;
+
+303 
+sc
+->
+sc_maxq
+ = 2;
+
+304 
+	`IFQ_SET_READY
+(&
+sc
+->
+sc_if
+.
+if_d
+);
+
+305 
+	`if_ch
+(&
+sc
+->
+sc_if
+);
+
+306 
+	`if_loc_dl
+(&
+sc
+->
+sc_if
+);
+
+307 
+	`bpf_ch
+(&
+sc
+->
+sc_if
+, 
+DLT_NULL
+, 0);
+
+308  
+sc
+;
+
+309 
+	}
+}
+
+312 
+	$p_e_
+(
+if_e
+ *
+ifc
+, 
+un
+)
+
+314  
+	`p_
+(
+ifc
+->
+ifc_me
+, 
+un
+=
+NULL
+ ? 
+EEXIST
+ : 0;
+
+315 
+	}
+}
+
+318 
+	$p_e_deroy
+(
+i
+ *
+i
+)
+
+320 
+p_soc
+ *
+sc
+ = (p_so*)
+i
+->
+if_soc
+;
+
+322 i(
+sc
+->
+sc_devp
+ !
+NULL
+)
+
+323  
+EBUSY
+;
+
+325 
+	`mux_r
+(&
+p_li_lock
+);
+
+326 
+	`LIST_REMOVE
+(
+sc
+, 
+sc_ii
+);
+
+327 
+	`mux_ex
+(&
+p_li_lock
+);
+
+329 
+	`bpf_dach
+(
+i
+);
+
+330 
+	`if_dach
+(
+i
+);
+
+332 
+	`
+(
+sc
+, 
+M_DEVBUF
+);
+
+334 
+	}
+}
+
+339 
+p_soc
+ *
+
+340 
+	$oc
+(
+pid_t
+ 
+pid
+)
+
+342 
+p_soc
+ *
+sc
+ = 
+NULL
+, *
+scf
+;
+
+343 
+i
+;
+
+345 
+	`mux_r
+(&
+p_li_lock
+);
+
+346 
+	`LIST_FOREACH
+(
+scf
+, &
+p_soc_li
+, 
+sc_ii
+) {
+
+347 i(
+scf
+->
+sc_xr
+ =
+pid
+) {
+
+348 
+scf
+->
+sc_xr
+ = 0;
+
+349 
+	`mux_ex
+(&
+p_li_lock
+);
+
+350  
+scf
+;
+
+352 i(
+scf
+->
+sc_devp
+ =
+NULL
+ && 
+sc
+ == NULL)
+
+353 
+sc
+ = 
+scf
+;
+
+355 
+	`mux_ex
+(&
+p_li_lock
+);
+
+357 i(
+sc
+ =
+NULL
+)
+
+358 
+sc
+ = 
+	`p_
+(
+p_
+.
+ifc_me
+, -1);
+
+360 
+sc
+->
+sc_si
+ = 
+	`sot_eablish
+(
+SOFTINT_NET
+, 
+p
+, sc);
+
+361 i(
+sc
+->
+sc_si
+ =
+NULL
+) {
+
+362 
+	`tf
+("%s: unableostablish softintr\n",
+
+363 
+sc
+->
+sc_if
+.
+if_xme
+);
+
+364  (
+NULL
+);
+
+366 
+sc
+->
+sc_ags
+ = 0;
+
+367 
+sc
+->
+sc_mru
+ = 
+PPP_MRU
+;
+
+368 
+sc
+->
+sc_lq
+ = 
+NULL
+;
+
+369 ()
+	`memt
+(&
+sc
+->
+sc_s
+, 0, (sc->sc_stats));
+
+370 #ifde
+VJC
+
+
+371 
+sc
+->
+sc_comp
+ = 
+	`mloc
+((
+comess
+), 
+M_DEVBUF
+, 
+M_NOWAIT
+);
+
+372 i(
+sc
+->
+sc_comp
+)
+
+373 
+	`_comess_
+(
+sc
+->
+sc_comp
+);
+
+375 #ifde
+PPP_COMPRESS
+
+
+376 
+sc
+->
+sc_xc_e
+ = 
+NULL
+;
+
+377 
+sc
+->
+sc_rc_e
+ = 
+NULL
+;
+
+379 
+i
+ = 0; i < 
+NUM_NP
+; ++i)
+
+380 
+sc
+->
+sc_mode
+[
+i
+] = 
+NPMODE_ERROR
+;
+
+381 
+sc
+->
+sc_queue
+ = 
+NULL
+;
+
+382 
+sc
+->
+sc_q
+ = &sc->
+sc_queue
+;
+
+383 
+sc
+->
+sc__
+ = sc->
+sc__cv
+ = 
+time_cd
+;
+
+385  
+sc
+;
+
+386 
+	}
+}
+
+392 
+	$pdoc
+(
+p_soc
+ *
+sc
+)
+
+394 
+mbuf
+ *
+m
+;
+
+396 
+	`sot_diablish
+(
+sc
+->
+sc_si
+);
+
+397 
+	`if_down
+(&
+sc
+->
+sc_if
+);
+
+398 
+sc
+->
+sc_if
+.
+if_ags
+ &~(
+IFF_UP
+|
+IFF_RUNNING
+);
+
+399 
+sc
+->
+sc_devp
+ = 
+NULL
+;
+
+400 
+sc
+->
+sc_xr
+ = 0;
+
+402 
+	`IF_DEQUEUE
+(&
+sc
+->
+sc_wq
+, 
+m
+);
+
+403 i(
+m
+ =
+NULL
+)
+
+405 
+	`m_m
+(
+m
+);
+
+408 
+	`IF_DEQUEUE
+(&
+sc
+->
+sc_q
+, 
+m
+);
+
+409 i(
+m
+ =
+NULL
+)
+
+411 
+	`m_m
+(
+m
+);
+
+414 
+	`IF_DEQUEUE
+(&
+sc
+->
+sc_q
+, 
+m
+);
+
+415 i(
+m
+ =
+NULL
+)
+
+417 
+	`m_m
+(
+m
+);
+
+419 (
+m
+ = 
+sc
+->
+sc_queue
+!
+NULL
+) {
+
+420 
+sc
+->
+sc_queue
+ = 
+m
+->
+m_xkt
+;
+
+421 
+	`m_m
+(
+m
+);
+
+423 i(
+sc
+->
+sc_togo
+ !
+NULL
+) {
+
+424 
+	`m_m
+(
+sc
+->
+sc_togo
+);
+
+425 
+sc
+->
+sc_togo
+ = 
+NULL
+;
+
+427 #ifde
+PPP_COMPRESS
+
+
+428 
+	`p_c_od
+(
+sc
+);
+
+429 
+sc
+->
+sc_xc_e
+ = 
+NULL
+;
+
+430 
+sc
+->
+sc_rc_e
+ = 
+NULL
+;
+
+432 #ifde
+PPP_FILTER
+
+
+433 i(
+sc
+->
+sc_ss_ft_
+.
+bf_s
+ != 0) {
+
+434 
+	`
+(
+sc
+->
+sc_ss_ft_
+.
+bf_s
+, 
+M_DEVBUF
+);
+
+435 
+sc
+->
+sc_ss_ft_
+.
+bf_s
+ = 0;
+
+436 
+sc
+->
+sc_ss_ft_
+.
+bf_n
+ = 0;
+
+438 i(
+sc
+->
+sc_ss_ft_out
+.
+bf_s
+ != 0) {
+
+439 
+	`
+(
+sc
+->
+sc_ss_ft_out
+.
+bf_s
+, 
+M_DEVBUF
+);
+
+440 
+sc
+->
+sc_ss_ft_out
+.
+bf_s
+ = 0;
+
+441 
+sc
+->
+sc_ss_ft_out
+.
+bf_n
+ = 0;
+
+443 i(
+sc
+->
+sc_aive_ft_
+.
+bf_s
+ != 0) {
+
+444 
+	`
+(
+sc
+->
+sc_aive_ft_
+.
+bf_s
+, 
+M_DEVBUF
+);
+
+445 
+sc
+->
+sc_aive_ft_
+.
+bf_s
+ = 0;
+
+446 
+sc
+->
+sc_aive_ft_
+.
+bf_n
+ = 0;
+
+448 i(
+sc
+->
+sc_aive_ft_out
+.
+bf_s
+ != 0) {
+
+449 
+	`
+(
+sc
+->
+sc_aive_ft_out
+.
+bf_s
+, 
+M_DEVBUF
+);
+
+450 
+sc
+->
+sc_aive_ft_out
+.
+bf_s
+ = 0;
+
+451 
+sc
+->
+sc_aive_ft_out
+.
+bf_n
+ = 0;
+
+454 #ifde
+VJC
+
+
+455 i(
+sc
+->
+sc_comp
+ != 0) {
+
+456 
+	`
+(
+sc
+->
+sc_comp
+, 
+M_DEVBUF
+);
+
+457 
+sc
+->
+sc_comp
+ = 0;
+
+460 ()
+	`p_e_deroy
+(&
+sc
+->
+sc_if
+);
+
+461 
+	}
+}
+
+467 
+	$piol
+(
+p_soc
+ *
+sc
+, 
+u_lg
+ 
+cmd
+, *
+da
+, 
+ag
+,
+
+468 
+lwp
+ *
+l
+)
+
+470 
+s
+, 
+r
+, 
+ags
+, 
+mru
+, 
+x
+;
+
+471 
+u_t
+ 
+nb
+;
+
+472 
+p_ti_da
+ *
+odp
+;
+
+473 
+comess
+ *
+
+;
+
+474 
+iol
+ *
+i
+;
+
+475 
+time_t
+ 
+t
+;
+
+476 #ifde
+PPP_FILTER
+
+
+477 
+bpf_ogm
+ *
+bp
+, *
+nbp
+;
+
+478 
+bpf_
+ *
+wcode
+, *
+dcode
+;
+
+479 
+wcod
+;
+
+481 #ifdef 
+PPP_COMPRESS
+
+
+482 
+u_ch
+ 
+c_ti
+[
+CCP_MAX_OPTION_LENGTH
+];
+
+485 
+cmd
+) {
+
+486 
+PPPIOCSFLAGS
+:
+
+487 
+PPPIOCSMRU
+:
+
+488 
+PPPIOCSMAXCID
+:
+
+489 
+PPPIOCSCOMPRESS
+:
+
+490 
+PPPIOCSNPMODE
+:
+
+491 i(
+	`kauth_authize_twk
+(
+l
+->
+l_ed
+, 
+KAUTH_NETWORK_INTERFACE
+,
+
+492 
+KAUTH_REQ_NETWORK_INTERFACE_SETPRIV
+, &
+sc
+->
+sc_if
+,
+
+493 
+	`KAUTH_ARG
+(
+cmd
+), 
+NULL
+) != 0)
+
+494  (
+EPERM
+);
+
+496 
+PPPIOCXFERUNIT
+:
+
+498 i(
+	`kauth_authize_twk
+(
+l
+->
+l_ed
+, 
+KAUTH_NETWORK_INTERFACE
+,
+
+499 
+KAUTH_REQ_NETWORK_INTERFACE_GETPRIV
+, &
+sc
+->
+sc_if
+,
+
+500 
+	`KAUTH_ARG
+(
+cmd
+), 
+NULL
+) != 0)
+
+501  (
+EPERM
+);
+
+507 
+cmd
+) {
+
+508 
+FIONREAD
+:
+
+509 *(*)
+da
+ = 
+sc
+->
+sc_q
+.
+ifq_n
+;
+
+512 
+PPPIOCGUNIT
+:
+
+513 *(*)
+da
+ = 
+sc
+->
+sc_un
+;
+
+516 
+PPPIOCGFLAGS
+:
+
+517 *(
+u_t
+ *)
+da
+ = 
+sc
+->
+sc_ags
+;
+
+520 
+PPPIOCGRAWIN
+:
+
+522 
+p_w
+ *
+rw
+ = (p_w *)
+da
+;
+
+523 
+u_ch
+ 
+c
+, 
+q
+ = 0;
+
+525 
+c
+ = 
+sc
+->
+sc_w_t
+; c < (sc->
+sc_w
+.
+buf
+);)
+
+526 
+rw
+->
+buf
+[
+q
+++] = 
+sc
+->
+sc_w
+.buf[
+c
+++];
+
+528 
+c
+ = 0; c < 
+sc
+->
+sc_w_t
+;)
+
+529 
+rw
+->
+buf
+[
+q
+++] = 
+sc
+->
+sc_w
+.buf[
+c
+++];
+
+531 
+rw
+->
+cou
+ = 
+sc
+->
+sc_w
+.count;
+
+535 
+PPPIOCSFLAGS
+:
+
+536 
+ags
+ = *(*)
+da
+ & 
+SC_MASK
+;
+
+537 
+s
+ = 
+	`lsot
+();
+
+538 #ifde
+PPP_COMPRESS
+
+
+539 i(
+sc
+->
+sc_ags
+ & 
+SC_CCP_OPEN
+ && !(
+ags
+ & SC_CCP_OPEN))
+
+540 
+	`p_c_od
+(
+sc
+);
+
+542 
+	`lhigh
+();
+
+543 
+sc
+->
+sc_ags
+ = (sc->sc_ag& ~
+SC_MASK
+| 
+ags
+;
+
+544 
+	`lx
+(
+s
+);
+
+547 
+PPPIOCSMRU
+:
+
+548 
+mru
+ = *(*)
+da
+;
+
+549 i(
+mru
+ >
+PPP_MINMRU
+ && mru <
+PPP_MAXMRU
+)
+
+550 
+sc
+->
+sc_mru
+ = 
+mru
+;
+
+553 
+PPPIOCGMRU
+:
+
+554 *(*)
+da
+ = 
+sc
+->
+sc_mru
+;
+
+557 #ifde
+VJC
+
+
+558 
+PPPIOCSMAXCID
+:
+
+559 i(
+sc
+->
+sc_comp
+) {
+
+560 
+s
+ = 
+	`lsot
+();
+
+561 
+	`_comess_tup
+(
+sc
+->
+sc_comp
+, *(*)
+da
+);
+
+562 
+	`lx
+(
+s
+);
+
+567 
+PPPIOCXFERUNIT
+:
+
+568 
+sc
+->
+sc_xr
+ = 
+l
+->
+l_oc
+->
+p_pid
+;
+
+571 #ifde
+PPP_COMPRESS
+
+
+572 
+PPPIOCSCOMPRESS
+:
+
+573 
+odp
+ = (
+p_ti_da
+ *
+da
+;
+
+574 
+nb
+ = 
+odp
+->
+ngth
+;
+
+575 i(
+nb
+ > (
+c_ti
+))
+
+576 
+nb
+ = (
+c_ti
+);
+
+577 i((
+r
+ = 
+	`cy
+(
+odp
+->
+r
+, 
+c_ti
+, 
+nb
+)) != 0)
+
+578  (
+r
+);
+
+580 i(
+c_ti
+[1] < 2)
+
+581  (
+EINVAL
+);
+
+582 
+
+ = 
+	`p_g_comess
+(
+c_ti
+[0]);
+
+583 i(
+
+ =
+NULL
+) {
+
+584 i(
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)
+
+585 
+	`tf
+("%s:o compressor for [%x %x %x], %x\n",
+
+586 
+sc
+->
+sc_if
+.
+if_xme
+, 
+c_ti
+[0],
+
+587 
+c_ti
+[1], c_ti[2], 
+nb
+);
+
+588  (
+EINVAL
+);
+
+594 
+r
+ = 0;
+
+595 i(
+odp
+->
+sm
+) {
+
+596 
+s
+ = 
+	`lsot
+();
+
+597 i(
+sc
+->
+sc_xc_e
+ !
+NULL
+) {
+
+598 (*
+sc
+->
+sc_xcomp
+->
+comp_
+)(sc->
+sc_xc_e
+);
+
+599 
+	`p_comess_
+(
+sc
+->
+sc_xcomp
+);
+
+601 
+sc
+->
+sc_xcomp
+ = 
+
+;
+
+602 
+sc
+->
+sc_xc_e
+ = 
+
+->
+	`comp_loc
+(
+c_ti
+, 
+nb
+);
+
+603 i(
+sc
+->
+sc_xc_e
+ =
+NULL
+) {
+
+604 i(
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)
+
+605 
+	`tf
+("%s: comp_alloc failed\n",
+
+606 
+sc
+->
+sc_if
+.
+if_xme
+);
+
+607 
+r
+ = 
+ENOBUFS
+;
+
+609 
+	`lhigh
+();
+
+610 
+sc
+->
+sc_ags
+ &~
+SC_COMP_RUN
+;
+
+611 
+	`lx
+(
+s
+);
+
+613 
+s
+ = 
+	`lsot
+();
+
+614 i(
+sc
+->
+sc_rc_e
+ !
+NULL
+) {
+
+615 (*
+sc
+->
+sc_rcomp
+->
+decomp_
+)(sc->
+sc_rc_e
+);
+
+616 
+	`p_comess_
+(
+sc
+->
+sc_rcomp
+);
+
+618 
+sc
+->
+sc_rcomp
+ = 
+
+;
+
+619 
+sc
+->
+sc_rc_e
+ = 
+
+->
+	`decomp_loc
+(
+c_ti
+, 
+nb
+);
+
+620 i(
+sc
+->
+sc_rc_e
+ =
+NULL
+) {
+
+621 i(
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)
+
+622 
+	`tf
+("%s: decomp_alloc failed\n",
+
+623 
+sc
+->
+sc_if
+.
+if_xme
+);
+
+624 
+r
+ = 
+ENOBUFS
+;
+
+626 
+	`lhigh
+();
+
+627 
+sc
+->
+sc_ags
+ &~
+SC_DECOMP_RUN
+;
+
+628 
+	`lx
+(
+s
+);
+
+630  (
+r
+);
+
+633 
+PPPIOCGNPMODE
+:
+
+634 
+PPPIOCSNPMODE
+:
+
+635 
+i
+ = (
+iol
+ *
+da
+;
+
+636 
+i
+->
+oc
+) {
+
+637 
+PPP_IP
+:
+
+638 
+x
+ = 
+NP_IP
+;
+
+640 
+PPP_IPV6
+:
+
+641 
+x
+ = 
+NP_IPV6
+;
+
+644  
+EINVAL
+;
+
+646 i(
+cmd
+ =
+PPPIOCGNPMODE
+) {
+
+647 
+i
+->
+mode
+ = 
+sc
+->
+sc_mode
+[
+x
+];
+
+649 i(
+i
+->
+mode
+ !
+sc
+->
+sc_mode
+[
+x
+]) {
+
+650 
+s
+ = 
+	`
+();
+
+651 
+sc
+->
+sc_mode
+[
+x
+] = 
+i
+->
+mode
+;
+
+652 i(
+i
+->
+mode
+ !
+NPMODE_QUEUE
+) {
+
+653 
+	`p_queue
+(
+sc
+);
+
+654 
+	`p_t
+(
+sc
+);
+
+656 
+	`lx
+(
+s
+);
+
+661 
+PPPIOCGIDLE
+:
+
+662 
+s
+ = 
+	`lsot
+();
+
+663 
+t
+ = 
+time_cd
+;
+
+664 ((
+p_id
+ *)
+da
+)->
+xm_id
+ = 
+t
+ - 
+sc
+->
+sc__
+;
+
+665 ((
+p_id
+ *)
+da
+)->
+cv_id
+ = 
+t
+ - 
+sc
+->
+sc__cv
+;
+
+666 
+	`lx
+(
+s
+);
+
+669 #ifde
+PPP_FILTER
+
+
+670 
+PPPIOCSPASS
+:
+
+671 
+PPPIOCSACTIVE
+:
+
+673  
+EOPNOTSUPP
+;
+
+675 
+PPPIOCSIPASS
+:
+
+676 
+PPPIOCSOPASS
+:
+
+677 
+PPPIOCSIACTIVE
+:
+
+678 
+PPPIOCSOACTIVE
+:
+
+679 
+nbp
+ = (
+bpf_ogm
+ *
+da
+;
+
+680 i((
+nbp
+->
+bf_n
+ > 
+BPF_MAXINSNS
+)
+
+681  
+EINVAL
+;
+
+682 
+wcod
+ = 
+nbp
+->
+bf_n
+ * (
+bpf_
+);
+
+683 i(
+wcod
+ != 0) {
+
+684 
+wcode
+ = 
+	`mloc
+(
+wcod
+, 
+M_DEVBUF
+, 
+M_WAITOK
+);
+
+686 i((
+r
+ = 
+	`cy
+((*)
+nbp
+->
+bf_s
+,
+
+687 (*)
+wcode
+, 
+wcod
+)) != 0) {
+
+688 
+	`
+(
+wcode
+, 
+M_DEVBUF
+);
+
+689  
+r
+;
+
+691 i(!
+	`bpf_vide
+(
+wcode
+, 
+nbp
+->
+bf_n
+)) {
+
+692 
+	`
+(
+wcode
+, 
+M_DEVBUF
+);
+
+693  
+EINVAL
+;
+
+696 
+wcode
+ = 0;
+
+697 
+cmd
+) {
+
+698 
+PPPIOCSIPASS
+:
+
+699 
+bp
+ = &
+sc
+->
+sc_ss_ft_
+;
+
+702 
+PPPIOCSOPASS
+:
+
+703 
+bp
+ = &
+sc
+->
+sc_ss_ft_out
+;
+
+706 
+PPPIOCSIACTIVE
+:
+
+707 
+bp
+ = &
+sc
+->
+sc_aive_ft_
+;
+
+710 
+PPPIOCSOACTIVE
+:
+
+711 
+bp
+ = &
+sc
+->
+sc_aive_ft_out
+;
+
+714 
+	`
+(
+wcode
+, 
+M_DEVBUF
+);
+
+715  (
+EPASSTHROUGH
+);
+
+717 
+dcode
+ = 
+bp
+->
+bf_s
+;
+
+718 
+s
+ = 
+	`
+();
+
+719 
+bp
+->
+bf_n
+ = 
+nbp
+->bf_len;
+
+720 
+bp
+->
+bf_s
+ = 
+wcode
+;
+
+721 
+	`lx
+(
+s
+);
+
+722 i(
+dcode
+ != 0)
+
+723 
+	`
+(
+dcode
+, 
+M_DEVBUF
+);
+
+728  (
+EPASSTHROUGH
+);
+
+731 
+	}
+}
+
+737 
+	$psiol
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+739 
+p_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+740 
+iddr
+ *
+i
+ = (idd*)
+da
+;
+
+741 
+ieq
+ *
+i
+ = (ieq *)
+da
+;
+
+742 
+p_s
+ *
+p
+;
+
+743 #ifdef 
+PPP_COMPRESS
+
+
+744 
+p_comp_s
+ *
+p
+;
+
+746 
+s
+ = 
+	`
+(), 
+r
+ = 0;
+
+748 
+cmd
+) {
+
+749 
+SIOCSIFFLAGS
+:
+
+750 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)) != 0)
+
+752 i((
+i
+->
+if_ags
+ & 
+IFF_RUNNING
+) == 0)
+
+753 
+i
+->
+if_ags
+ &~
+IFF_UP
+;
+
+756 
+SIOCINITIFADDR
+:
+
+757 
+i
+->
+i_addr
+->
+_my
+) {
+
+758 #ifde
+INET
+
+
+759 
+AF_INET
+:
+
+762 #ifde
+INET6
+
+
+763 
+AF_INET6
+:
+
+767 
+r
+ = 
+EAFNOSUPPORT
+;
+
+770 
+i
+->
+i_que
+ = 
+p2p_que
+;
+
+773 
+SIOCADDMULTI
+:
+
+774 
+SIOCDELMULTI
+:
+
+775 i(
+i
+ =
+NULL
+) {
+
+776 
+r
+ = 
+EAFNOSUPPORT
+;
+
+779 
+	`ieq_gaddr
+(
+cmd
+, 
+i
+)->
+_my
+) {
+
+780 #ifde
+INET
+
+
+781 
+AF_INET
+:
+
+784 #ifde
+INET6
+
+
+785 
+AF_INET6
+:
+
+789 
+r
+ = 
+EAFNOSUPPORT
+;
+
+794 
+SIOCGPPPSTATS
+:
+
+795 
+p
+ = &((
+ieq
+ *
+da
+)->
+s
+;
+
+796 
+	`memt
+(
+p
+, 0, (*psp));
+
+797 
+p
+->
+p
+ = 
+sc
+->
+sc_s
+;
+
+798 #i
+	`defed
+(
+VJC
+&& !defed(
+SL_NO_STATS
+)
+
+799 i(
+sc
+->
+sc_comp
+) {
+
+800 
+p
+->
+vj
+.
+vjs_cks
+ = 
+sc
+->
+sc_comp
+->
+s_cks
+;
+
+801 
+p
+->
+vj
+.
+vjs_comesd
+ = 
+sc
+->
+sc_comp
+->
+s_comesd
+;
+
+802 
+p
+->
+vj
+.
+vjs_ches
+ = 
+sc
+->
+sc_comp
+->
+s_ches
+;
+
+803 
+p
+->
+vj
+.
+vjs_miss
+ = 
+sc
+->
+sc_comp
+->
+s_miss
+;
+
+804 
+p
+->
+vj
+.
+vjs_uncomesd
+ = 
+sc
+->
+sc_comp
+->
+s_uncomesd
+;
+
+805 
+p
+->
+vj
+.
+vjs_comesd
+ = 
+sc
+->
+sc_comp
+->
+s_comesd
+;
+
+806 
+p
+->
+vj
+.
+vjs_r
+ = 
+sc
+->
+sc_comp
+->
+s_r
+;
+
+807 
+p
+->
+vj
+.
+vjs_tosd
+ = 
+sc
+->
+sc_comp
+->
+s_tosd
+;
+
+812 #ifde
+PPP_COMPRESS
+
+
+813 
+SIOCGPPPCSTATS
+:
+
+814 
+p
+ = &((
+iceq
+ *
+da
+)->
+s
+;
+
+815 
+	`memt
+(
+p
+, 0, (*pcp));
+
+816 i(
+sc
+->
+sc_xc_e
+ !
+NULL
+)
+
+817 (*
+sc
+->
+sc_xcomp
+->
+comp_
+)(sc->
+sc_xc_e
+, &
+p
+->
+c
+);
+
+818 i(
+sc
+->
+sc_rc_e
+ !
+NULL
+)
+
+819 (*
+sc
+->
+sc_rcomp
+->
+decomp_
+)(sc->
+sc_rc_e
+, &
+p
+->
+d
+);
+
+824 i((
+r
+ = 
+	`ifiol_comm
+(&
+sc
+->
+sc_if
+, 
+cmd
+, 
+da
+)=
+ENETRESET
+)
+
+825 
+r
+ = 0;
+
+828 
+	`lx
+(
+s
+);
+
+829  (
+r
+);
+
+830 
+	}
+}
+
+837 
+	$pouut
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m0
+, c 
+sockaddr
+ *
+d
+,
+
+838 
+y
+ *
+p
+)
+
+840 
+p_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+841 
+oc
+, 
+addss
+, 
+c
+;
+
+842 
+u_ch
+ *
+
+;
+
+843 
+s
+, 
+r
+;
+
+844 #ifde
+INET
+
+
+845 
+
+ *ip;
+
+847 
+ifqueue
+ *
+ifq
+;
+
+848 
+NPmode
+ 
+mode
+;
+
+849 
+n
+;
+
+850 
+	`ALTQ_DECL
+(
+tq_pkr
+ 
+pkr
+;)
+
+852 i(
+sc
+->
+sc_devp
+ =
+NULL
+ || (
+i
+->
+if_ags
+ & 
+IFF_RUNNING
+) == 0
+
+853 || ((
+i
+->
+if_ags
+ & 
+IFF_UP
+=0 && 
+d
+->
+_my
+ !
+AF_UNSPEC
+)) {
+
+854 
+r
+ = 
+ENETDOWN
+;
+
+855 
+bad
+;
+
+858 
+	`IFQ_CLASSIFY
+(&
+i
+->
+if_d
+, 
+m0
+, 
+d
+->
+_my
+, &
+pkr
+);
+
+863 
+m0
+->
+m_ags
+ &~
+M_HIGHPRI
+;
+
+864 
+d
+->
+_my
+) {
+
+865 #ifde
+INET
+
+
+866 
+AF_INET
+:
+
+867 
+addss
+ = 
+PPP_ALLSTATIONS
+;
+
+868 
+c
+ = 
+PPP_UI
+;
+
+869 
+oc
+ = 
+PPP_IP
+;
+
+870 
+mode
+ = 
+sc
+->
+sc_mode
+[
+NP_IP
+];
+
+876 
+
+ = 
+	`mtod
+(
+m0
+, ip *);
+
+877 i(
+
+->
+_tos
+ & 
+IPTOS_LOWDELAY
+)
+
+878 
+m0
+->
+m_ags
+ |
+M_HIGHPRI
+;
+
+881 #ifde
+INET6
+
+
+882 
+AF_INET6
+:
+
+883 
+addss
+ = 
+PPP_ALLSTATIONS
+;
+
+884 
+c
+ = 
+PPP_UI
+;
+
+885 
+oc
+ = 
+PPP_IPV6
+;
+
+886 
+mode
+ = 
+sc
+->
+sc_mode
+[
+NP_IPV6
+];
+
+893 
+
+ = 
+	`mtod
+(
+m0
+, ip *);
+
+894 i(
+
+->
+_tos
+ & 
+IPTOS_LOWDELAY
+)
+
+895 
+m0
+->
+m_ags
+ |
+M_HIGHPRI
+;
+
+899 
+AF_UNSPEC
+:
+
+900 
+addss
+ = 
+	`PPP_ADDRESS
+(
+d
+->
+_da
+);
+
+901 
+c
+ = 
+	`PPP_CONTROL
+(
+d
+->
+_da
+);
+
+902 
+oc
+ = 
+	`PPP_PROTOCOL
+(
+d
+->
+_da
+);
+
+903 
+mode
+ = 
+NPMODE_PASS
+;
+
+906 
+	`tf
+("%s:f%d sud\n", 
+i
+->
+if_xme
+,
+
+907 
+d
+->
+_my
+);
+
+908 
+r
+ = 
+EAFNOSUPPORT
+;
+
+909 
+bad
+;
+
+915 i(
+mode
+ =
+NPMODE_ERROR
+) {
+
+916 
+r
+ = 
+ENETDOWN
+;
+
+917 
+bad
+;
+
+919 i(
+mode
+ =
+NPMODE_DROP
+) {
+
+920 
+r
+ = 0;
+
+921 
+bad
+;
+
+927 
+	`M_PREPEND
+(
+m0
+, 
+PPP_HDRLEN
+, 
+M_DONTWAIT
+);
+
+928 i(
+m0
+ =
+NULL
+) {
+
+929 
+r
+ = 
+ENOBUFS
+;
+
+930 
+bad
+;
+
+933 
+
+ = 
+	`mtod
+(
+m0
+, 
+u_ch
+ *);
+
+934 *
+
+++ = 
+addss
+;
+
+935 *
+
+++ = 
+c
+;
+
+936 *
+
+++ = 
+oc
+ >> 8;
+
+937 *
+
+++ = 
+oc
+ & 0xff;
+
+939 
+n
+ = 
+	`m_ngth
+(
+m0
+);
+
+941 i(
+sc
+->
+sc_ags
+ & 
+SC_LOG_OUTPKT
+) {
+
+942 
+	`tf
+("%ouut: ", 
+i
+->
+if_xme
+);
+
+943 
+	`pdumpm
+(
+m0
+);
+
+946 i((
+oc
+ & 0x8000) == 0) {
+
+947 #ifde
+PPP_FILTER
+
+
+952 i(
+sc
+->
+sc_ss_ft_out
+.
+bf_s
+ != 0
+
+953 && 
+	`bpf_fr
+(
+sc
+->
+sc_ss_ft_out
+.
+bf_s
+,
+
+954 (
+u_ch
+ *)
+m0
+, 
+n
+, 0) == 0) {
+
+955 
+r
+ = 0;
+
+956 
+bad
+;
+
+962 i(
+sc
+->
+sc_aive_ft_out
+.
+bf_s
+ == 0
+
+963 || 
+	`bpf_fr
+(
+sc
+->
+sc_aive_ft_out
+.
+bf_s
+,
+
+964 (
+u_ch
+ *)
+m0
+, 
+n
+, 0))
+
+965 
+sc
+->
+sc__
+ = 
+time_cd
+;
+
+970 
+sc
+->
+sc__
+ = 
+time_cd
+;
+
+977 
+	`bpf_mp
+(&
+sc
+->
+sc_if
+, 
+m0
+);
+
+982 
+s
+ = 
+	`
+();
+
+983 i(
+mode
+ =
+NPMODE_QUEUE
+) {
+
+985 *
+sc
+->
+sc_q
+ = 
+m0
+;
+
+986 
+m0
+->
+m_xkt
+ = 
+NULL
+;
+
+987 
+sc
+->
+sc_q
+ = &
+m0
+->
+m_xkt
+;
+
+989 
+ifq
+ = (
+m0
+->
+m_ags
+ & 
+M_HIGHPRI
+? &
+sc
+->
+sc_q
+ : 
+NULL
+;
+
+990 i((
+r
+ = 
+	`ifq_queue2
+(&
+sc
+->
+sc_if
+, 
+ifq
+, 
+m0
+
+
+991 
+ALTQ_COMMA
+ 
+	`ALTQ_DECL
+(&
+pkr
+))) != 0) {
+
+992 
+	`lx
+(
+s
+);
+
+993 
+sc
+->
+sc_if
+.
+if_s
+++;
+
+994 
+sc
+->
+sc_s
+.
+p_s
+++;
+
+995  (
+r
+);
+
+997 
+	`p_t
+(
+sc
+);
+
+999 
+i
+->
+if_acks
+++;
+
+1000 
+i
+->
+if_obys
+ +
+n
+;
+
+1002 
+	`lx
+(
+s
+);
+
+1005 
+bad
+:
+
+1006 
+	`m_m
+(
+m0
+);
+
+1007  (
+r
+);
+
+1008 
+	}
+}
+
+1016 
+	$p_queue
+(
+p_soc
+ *
+sc
+)
+
+1018 
+mbuf
+ *
+m
+, **
+m
+;
+
+1019 
+ifqueue
+ *
+ifq
+;
+
+1020 
+NPmode
+ 
+mode
+;
+
+1021 
+r
+;
+
+1023 
+m
+ = &
+sc
+->
+sc_queue
+; (
+m
+ = *m!
+NULL
+; ) {
+
+1024 
+	`PPP_PROTOCOL
+(
+	`mtod
+(
+m
+, 
+u_ch
+ *))) {
+
+1025 
+PPP_IP
+:
+
+1026 
+mode
+ = 
+sc
+->
+sc_mode
+[
+NP_IP
+];
+
+1028 
+PPP_IPV6
+:
+
+1029 
+mode
+ = 
+sc
+->
+sc_mode
+[
+NP_IPV6
+];
+
+1032 
+mode
+ = 
+NPMODE_PASS
+;
+
+1035 
+mode
+) {
+
+1036 
+NPMODE_PASS
+:
+
+1041 *
+m
+ = 
+m
+->
+m_xkt
+;
+
+1042 
+m
+->
+m_xkt
+ = 
+NULL
+;
+
+1043 
+ifq
+ = (
+m
+->
+m_ags
+ & 
+M_HIGHPRI
+? &
+sc
+->
+sc_q
+ : 
+NULL
+;
+
+1044 i((
+r
+ = 
+	`ifq_queue2
+(&
+sc
+->
+sc_if
+, 
+ifq
+, 
+m
+ 
+ALTQ_COMMA
+
+
+1045 
+	`ALTQ_DECL
+(
+NULL
+))) != 0) {
+
+1046 
+sc
+->
+sc_if
+.
+if_s
+++;
+
+1047 
+sc
+->
+sc_s
+.
+p_s
+++;
+
+1051 
+NPMODE_DROP
+:
+
+1052 
+NPMODE_ERROR
+:
+
+1053 *
+m
+ = 
+m
+->
+m_xkt
+;
+
+1054 
+	`m_m
+(
+m
+);
+
+1057 
+NPMODE_QUEUE
+:
+
+1058 
+m
+ = &
+m
+->
+m_xkt
+;
+
+1062 
+sc
+->
+sc_q
+ = 
+m
+;
+
+1063 
+	}
+}
+
+1070 
+	$p_t
+(
+p_soc
+ *
+sc
+)
+
+1072 
+s
+ = 
+	`lhigh
+();
+
+1074 
+sc
+->
+sc_ags
+ &~
+SC_TBUSY
+;
+
+1075 
+	`sot_schedu
+(
+sc
+->
+sc_si
+);
+
+1076 
+	`lx
+(
+s
+);
+
+1077 
+	}
+}
+
+1085 
+mbuf
+ *
+
+1086 
+	$p_dequeue
+(
+p_soc
+ *
+sc
+)
+
+1088 
+mbuf
+ *
+m
+, *
+mp
+;
+
+1089 
+u_ch
+ *
+
+;
+
+1090 
+addss
+, 
+c
+, 
+oc
+;
+
+1091 
+s
+;
+
+1097 
+s
+ = 
+	`
+();
+
+1098 i(
+sc
+->
+sc_nq
+ < sc->
+sc_maxq
+) {
+
+1099 
+	`IF_DEQUEUE
+(&
+sc
+->
+sc_q
+, 
+m
+);
+
+1100 i(
+m
+ !
+NULL
+)
+
+1101 
+sc
+->
+sc_nq
+++;
+
+1103 
+	`IFQ_DEQUEUE
+(&
+sc
+->
+sc_if
+.
+if_d
+, 
+m
+);
+
+1105 
+sc
+->
+sc_nq
+ = 0;
+
+1106 
+	`IFQ_DEQUEUE
+(&
+sc
+->
+sc_if
+.
+if_d
+, 
+m
+);
+
+1107 i(
+m
+ =
+NULL
+) {
+
+1108 
+	`IF_DEQUEUE
+(&
+sc
+->
+sc_q
+, 
+m
+);
+
+1109 i(
+m
+ !
+NULL
+)
+
+1110 
+sc
+->
+sc_nq
+++;
+
+1113 
+	`lx
+(
+s
+);
+
+1115 i(
+m
+ =
+NULL
+)
+
+1116  
+NULL
+;
+
+1118 ++
+sc
+->
+sc_s
+.
+p_acks
+;
+
+1124 
+
+ = 
+	`mtod
+(
+m
+, 
+u_ch
+ *);
+
+1125 
+addss
+ = 
+	`PPP_ADDRESS
+(
+
+);
+
+1126 
+c
+ = 
+	`PPP_CONTROL
+(
+
+);
+
+1127 
+oc
+ = 
+	`PPP_PROTOCOL
+(
+
+);
+
+1129 
+oc
+) {
+
+1130 
+PPP_IP
+:
+
+1131 #ifde
+VJC
+
+
+1135 i((
+sc
+->
+sc_ags
+ & 
+SC_COMP_TCP
+&& sc->
+sc_comp
+ !
+NULL
+) {
+
+1136 
+
+ *ip;
+
+1137 
+ty
+;
+
+1139 
+mp
+ = 
+m
+;
+
+1140 
+
+ = ( *(
+
+ + 
+PPP_HDRLEN
+);
+
+1141 i(
+mp
+->
+m_n
+ <
+PPP_HDRLEN
+) {
+
+1142 
+mp
+ = mp->
+m_xt
+;
+
+1143 i(
+mp
+ =
+NULL
+)
+
+1145 
+
+ = 
+	`mtod
+(
+mp
+, ip *);
+
+1151 i(
+
+->
+_p
+ =
+IPPROTO_TCP
+) {
+
+1152 
+ty
+ = 
+	`_comess_t
+(
+mp
+, 
+
+, 
+sc
+->
+sc_comp
+,
+
+1153 !(
+sc
+->
+sc_ags
+ & 
+SC_NO_TCP_CCID
+));
+
+1154 
+ty
+) {
+
+1155 
+TYPE_UNCOMPRESSED_TCP
+:
+
+1156 
+oc
+ = 
+PPP_VJC_UNCOMP
+;
+
+1158 
+TYPE_COMPRESSED_TCP
+:
+
+1159 
+oc
+ = 
+PPP_VJC_COMP
+;
+
+1160 
+
+ = 
+	`mtod
+(
+m
+, 
+u_ch
+ *);
+
+1161 
+
+[0] = 
+addss
+;
+
+1162 
+
+[1] = 
+c
+;
+
+1163 
+
+[2] = 0;
+
+1167 
+
+[3] = 
+oc
+;
+
+1173 #ifde
+PPP_COMPRESS
+
+
+1174 
+PPP_CCP
+:
+
+1175 
+	`p_c
+(
+sc
+, 
+m
+, 0);
+
+1180 #ifde
+PPP_COMPRESS
+
+
+1181 i(
+oc
+ !
+PPP_LCP
+ &&roc !
+PPP_CCP
+
+
+1182 && 
+sc
+->
+sc_xc_e
+ && (sc->
+sc_ags
+ & 
+SC_COMP_RUN
+)) {
+
+1183 
+mbuf
+ *
+mcomp
+ = 
+NULL
+;
+
+1184 
+
+;
+
+1186 
+
+ = 0;
+
+1187 
+mp
+ = 
+m
+; m!
+NULL
+; mmp->
+m_xt
+)
+
+1188 
+
+ +
+mp
+->
+m_n
+;
+
+1189 (*
+sc
+->
+sc_xcomp
+->
+comess
+)
+
+1190 (
+sc
+->
+sc_xc_e
+, &
+mcomp
+, 
+m
+, 
+
+, sc->
+sc_if
+.
+if_mtu
+ + 
+PPP_HDRLEN
+);
+
+1191 i(
+mcomp
+ !
+NULL
+) {
+
+1192 i(
+sc
+->
+sc_ags
+ & 
+SC_CCP_UP
+) {
+
+1197 
+	`m_m
+(
+m
+);
+
+1198 
+m
+ = 
+mcomp
+;
+
+1199 
+
+ = 
+	`mtod
+(
+m
+, 
+u_ch
+ *);
+
+1200 
+oc
+ = 
+
+[3];
+
+1206 
+	`m_m
+(
+mcomp
+);
+
+1215 i(
+sc
+->
+sc_ags
+ & 
+SC_COMP_AC
+ && 
+addss
+ =
+PPP_ALLSTATIONS
+ &&
+
+1216 
+c
+ =
+PPP_UI
+ && 
+oc
+ !
+PPP_ALLSTATIONS
+ &&
+
+1217 
+oc
+ !
+PPP_LCP
+) {
+
+1219 
+m
+->
+m_da
+ += 2;
+
+1220 
+m
+->
+m_n
+ -= 2;
+
+1222 i(
+sc
+->
+sc_ags
+ & 
+SC_COMP_PROT
+ && 
+oc
+ < 0xFF) {
+
+1224 i(
+	`mtod
+(
+m
+, 
+u_ch
+ *=
+
+) {
+
+1225 
+
+[2] = cp[1];
+
+1226 
+
+[1] = cp[0];
+
+1228 ++
+m
+->
+m_da
+;
+
+1229 --
+m
+->
+m_n
+;
+
+1232  
+m
+;
+
+1233 
+	}
+}
+
+1239 
+	$p
+(*
+g
+)
+
+1241 
+p_soc
+ *
+sc
+ = 
+g
+;
+
+1242 
+mbuf
+ *
+m
+;
+
+1243 
+s
+;
+
+1245 
+	`mux_r
+(
+sot_lock
+);
+
+1246 i(!(
+sc
+->
+sc_ags
+ & 
+SC_TBUSY
+)
+
+1247 && (
+	`IFQ_IS_EMPTY
+(&
+sc
+->
+sc_if
+.
+if_d
+=0 || sc->
+sc_q
+.
+ifq_hd
+
+
+1248 || 
+sc
+->
+sc_outm
+)) {
+
+1249 
+s
+ = 
+	`lhigh
+();
+
+1250 
+sc
+->
+sc_ags
+ |
+SC_TBUSY
+;
+
+1251 
+	`lx
+(
+s
+);
+
+1252 (*
+sc
+->
+sc_t
+)(sc);
+
+1255 
+s
+ = 
+	`
+();
+
+1256 
+	`IF_DEQUEUE
+(&
+sc
+->
+sc_wq
+, 
+m
+);
+
+1257 
+	`lx
+(
+s
+);
+
+1258 i(
+m
+ =
+NULL
+)
+
+1260 
+	`p_oc
+(
+sc
+, 
+m
+);
+
+1262 
+	`mux_ex
+(
+sot_lock
+);
+
+1263 
+	}
+}
+
+1265 #ifde
+PPP_COMPRESS
+
+
+1271 
+	$p_c
+(
+p_soc
+ *
+sc
+, 
+mbuf
+ *
+m
+, 
+rcvd
+)
+
+1273 
+u_ch
+ *
+dp
+, *
+
+;
+
+1274 
+mbuf
+ *
+mp
+;
+
+1275 
+
+, 
+s
+;
+
+1280 i(
+m
+->
+m_n
+ <
+PPP_HDRLEN
+) {
+
+1281 
+mp
+ = 
+m
+->
+m_xt
+;
+
+1282 i(
+mp
+ =
+NULL
+)
+
+1284 
+dp
+ = 
+	`mtod
+(
+mp
+, 
+u_ch
+ *);
+
+1286 
+mp
+ = 
+m
+;
+
+1287 
+dp
+ = 
+	`mtod
+(
+mp
+, 
+u_ch
+ *+ 
+PPP_HDRLEN
+;
+
+1290 
+
+ = 
+	`mtod
+(
+mp
+, 
+u_ch
+ *+ mp->
+m_n
+;
+
+1291 i(
+dp
+ + 
+CCP_HDRLEN
+ > 
+
+)
+
+1293 
+
+ = 
+	`CCP_LENGTH
+(
+dp
+);
+
+1294 i(
+dp
+ + 
+
+ > 
+
+) {
+
+1295 i(
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)
+
+1296 
+	`tf
+("if_ppp/ccp:otnough data in mbuf (%p+%x > %p+%x)\n",
+
+1297 
+dp
+, 
+
+, 
+	`mtod
+(
+mp
+, 
+u_ch
+ *), mp->
+m_n
+);
+
+1301 
+	`CCP_CODE
+(
+dp
+)) {
+
+1302 
+CCP_CONFREQ
+:
+
+1303 
+CCP_TERMREQ
+:
+
+1304 
+CCP_TERMACK
+:
+
+1306 i(
+sc
+->
+sc_ags
+ & 
+SC_CCP_UP
+) {
+
+1307 
+s
+ = 
+	`lhigh
+();
+
+1308 
+sc
+->
+sc_ags
+ &~(
+SC_CCP_UP
+ | 
+SC_COMP_RUN
+ | 
+SC_DECOMP_RUN
+);
+
+1309 
+	`lx
+(
+s
+);
+
+1313 
+CCP_CONFACK
+:
+
+1314 i(
+sc
+->
+sc_ags
+ & 
+SC_CCP_OPEN
+ && !(sc->sc_ag& 
+SC_CCP_UP
+)
+
+1315 && 
+
+ >
+CCP_HDRLEN
+ + 
+CCP_OPT_MINLEN
+
+
+1316 && 
+
+ >
+	`CCP_OPT_LENGTH
+(
+dp
+ + 
+CCP_HDRLEN
+) + CCP_HDRLEN) {
+
+1317 i(!
+rcvd
+) {
+
+1319 i(
+sc
+->
+sc_xc_e
+ !
+NULL
+
+
+1320 && (*
+sc
+->
+sc_xcomp
+->
+comp_
+)
+
+1321 (
+sc
+->
+sc_xc_e
+, 
+dp
+ + 
+CCP_HDRLEN
+,
+
+1322 
+
+ - 
+CCP_HDRLEN
+, 
+sc
+->
+sc_un
+, 0,
+
+1323 
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)) {
+
+1324 
+s
+ = 
+	`lhigh
+();
+
+1325 
+sc
+->
+sc_ags
+ |
+SC_COMP_RUN
+;
+
+1326 
+	`lx
+(
+s
+);
+
+1333 i(
+sc
+->
+sc_rc_e
+ !
+NULL
+
+
+1334 && (*
+sc
+->
+sc_rcomp
+->
+decomp_
+)
+
+1335 (
+sc
+->
+sc_rc_e
+, 
+dp
+ + 
+CCP_HDRLEN
+, 
+
+ - CCP_HDRLEN,
+
+1336 
+sc
+->
+sc_un
+, 0, sc->
+sc_mru
+,
+
+1337 
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)) {
+
+1338 
+s
+ = 
+	`lhigh
+();
+
+1339 
+sc
+->
+sc_ags
+ |
+SC_DECOMP_RUN
+;
+
+1340 
+sc
+->
+sc_ags
+ &~(
+SC_DC_ERROR
+ | 
+SC_DC_FERROR
+);
+
+1341 
+	`lx
+(
+s
+);
+
+1347 
+CCP_RESETACK
+:
+
+1348 i(
+sc
+->
+sc_ags
+ & 
+SC_CCP_UP
+) {
+
+1349 i(!
+rcvd
+) {
+
+1350 i(
+sc
+->
+sc_xc_e
+ && (sc->
+sc_ags
+ & 
+SC_COMP_RUN
+))
+
+1351 (*
+sc
+->
+sc_xcomp
+->
+comp_t
+)(sc->
+sc_xc_e
+);
+
+1353 i(
+sc
+->
+sc_rc_e
+ && (sc->
+sc_ags
+ & 
+SC_DECOMP_RUN
+)) {
+
+1354 (*
+sc
+->
+sc_rcomp
+->
+decomp_t
+)(sc->
+sc_rc_e
+);
+
+1355 
+s
+ = 
+	`lhigh
+();
+
+1356 
+sc
+->
+sc_ags
+ &~
+SC_DC_ERROR
+;
+
+1357 
+	`lx
+(
+s
+);
+
+1363 
+	}
+}
+
+1369 
+	$p_c_od
+(
+p_soc
+ *
+sc
+)
+
+1371 i(
+sc
+->
+sc_xc_e
+) {
+
+1372 (*
+sc
+->
+sc_xcomp
+->
+comp_
+)(sc->
+sc_xc_e
+);
+
+1373 
+	`p_comess_
+(
+sc
+->
+sc_xcomp
+);
+
+1374 
+sc
+->
+sc_xc_e
+ = 
+NULL
+;
+
+1376 i(
+sc
+->
+sc_rc_e
+) {
+
+1377 (*
+sc
+->
+sc_rcomp
+->
+decomp_
+)(sc->
+sc_rc_e
+);
+
+1378 
+	`p_comess_
+(
+sc
+->
+sc_rcomp
+);
+
+1379 
+sc
+->
+sc_rc_e
+ = 
+NULL
+;
+
+1381 
+	}
+}
+
+1391 
+	$kt
+(
+p_soc
+ *
+sc
+, 
+mbuf
+ *
+m
+, 
+lo
+)
+
+1393 
+s
+ = 
+	`lhigh
+();
+
+1395 i(
+lo
+)
+
+1396 
+m
+->
+m_ags
+ |
+M_ERRMARK
+;
+
+1397 
+	`IF_ENQUEUE
+(&
+sc
+->
+sc_wq
+, 
+m
+);
+
+1398 
+	`sot_schedu
+(
+sc
+->
+sc_si
+);
+
+1399 
+	`lx
+(
+s
+);
+
+1400 
+	}
+}
+
+1406 
+	#COMPTYPE
+(
+o
+(ro=
+PPP_VJC_COMP
+ ? 
+TYPE_COMPRESSED_TCP
+: \
+
+1407 
+TYPE_UNCOMPRESSED_TCP
+)
+
+	)
+
+1410 
+	$p_oc
+(
+p_soc
+ *
+sc
+, 
+mbuf
+ *
+m
+)
+
+1412 
+i
+ *
+i
+ = &
+sc
+->
+sc_if
+;
+
+1413 
+pktqueue_t
+ *
+pktq
+ = 
+NULL
+;
+
+1414 
+ifqueue
+ *
+q
+ = 
+NULL
+;
+
+1415 
+s
+, 
+
+, 
+o
+, 
+rv
+;
+
+1416 
+u_ch
+ *
+
+, 
+adrs
+, 
+
+;
+
+1417 
+mbuf
+ *
+mp
+, *
+dmp
+ = 
+NULL
+;
+
+1418 #ifde
+VJC
+
+
+1419 
+xn
+;
+
+1420 
+u_ch
+ *
+hdr
+;
+
+1421 
+u_t
+ 
+hn
+;
+
+1424 
+sc
+->
+sc_s
+.
+p_acks
+++;
+
+1426 i(
+sc
+->
+sc_ags
+ & 
+SC_LOG_INPKT
+) {
+
+1427 
+
+ = 0;
+
+1428 
+mp
+ = 
+m
+; m!
+NULL
+; mmp->
+m_xt
+)
+
+1429 
+
+ +
+mp
+->
+m_n
+;
+
+1430 
+	`tf
+("%s: g %d bys\n", 
+i
+->
+if_xme
+, 
+
+);
+
+1431 
+	`pdumpm
+(
+m
+);
+
+1434 
+
+ = 
+	`mtod
+(
+m
+, 
+u_ch
+ *);
+
+1435 
+adrs
+ = 
+	`PPP_ADDRESS
+(
+
+);
+
+1436 
+
+ = 
+	`PPP_CONTROL
+(
+
+);
+
+1437 
+o
+ = 
+	`PPP_PROTOCOL
+(
+
+);
+
+1439 i(
+m
+->
+m_ags
+ & 
+M_ERRMARK
+) {
+
+1440 
+m
+->
+m_ags
+ &~
+M_ERRMARK
+;
+
+1441 
+s
+ = 
+	`lhigh
+();
+
+1442 
+sc
+->
+sc_ags
+ |
+SC_VJ_RESET
+;
+
+1443 
+	`lx
+(
+s
+);
+
+1446 #ifde
+PPP_COMPRESS
+
+
+1451 i(
+o
+ =
+PPP_COMP
+ && 
+sc
+->
+sc_rc_e
+ && (sc->
+sc_ags
+ & 
+SC_DECOMP_RUN
+)
+
+1452 && !(
+sc
+->
+sc_ags
+ & 
+SC_DC_ERROR
+&& !(sc->sc_ag& 
+SC_DC_FERROR
+)) {
+
+1454 
+rv
+ = (*
+sc
+->
+sc_rcomp
+->
+decomess
+)(sc->
+sc_rc_e
+, 
+m
+, &
+dmp
+);
+
+1455 i(
+rv
+ =
+DECOMP_OK
+) {
+
+1456 
+	`m_m
+(
+m
+);
+
+1457 i(
+dmp
+ =
+NULL
+) {
+
+1464 
+m
+ = 
+dmp
+;
+
+1465 
+
+ = 
+	`mtod
+(
+m
+, 
+u_ch
+ *);
+
+1466 
+o
+ = 
+	`PPP_PROTOCOL
+(
+
+);
+
+1474 i(
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)
+
+1475 
+	`tf
+("%s: decompress failed %d\n",
+
+1476 
+i
+->
+if_xme
+, 
+rv
+);
+
+1477 
+s
+ = 
+	`lhigh
+();
+
+1478 
+sc
+->
+sc_ags
+ |
+SC_VJ_RESET
+;
+
+1479 i(
+rv
+ =
+DECOMP_ERROR
+)
+
+1480 
+sc
+->
+sc_ags
+ |
+SC_DC_ERROR
+;
+
+1482 
+sc
+->
+sc_ags
+ |
+SC_DC_FERROR
+;
+
+1483 
+	`lx
+(
+s
+);
+
+1487 i(
+sc
+->
+sc_rc_e
+ && (sc->
+sc_ags
+ & 
+SC_DECOMP_RUN
+))
+
+1488 (*
+sc
+->
+sc_rcomp
+->
+comp
+)(sc->
+sc_rc_e
+, 
+m
+);
+
+1489 i(
+o
+ =
+PPP_CCP
+)
+
+1490 
+	`p_c
+(
+sc
+, 
+m
+, 1);
+
+1494 
+
+ = 0;
+
+1495 
+mp
+ = 
+m
+; m!
+NULL
+; mmp->
+m_xt
+)
+
+1496 
+
+ +
+mp
+->
+m_n
+;
+
+1498 #ifde
+VJC
+
+
+1499 i(
+sc
+->
+sc_ags
+ & 
+SC_VJ_RESET
+) {
+
+1504 i(
+sc
+->
+sc_comp
+)
+
+1505 
+	`_uncomess_t
+(
+NULL
+, 0, 
+TYPE_ERROR
+, 
+sc
+->
+sc_comp
+);
+
+1506 
+s
+ = 
+	`lhigh
+();
+
+1507 
+sc
+->
+sc_ags
+ &~
+SC_VJ_RESET
+;
+
+1508 
+	`lx
+(
+s
+);
+
+1514 i(
+o
+ =
+PPP_VJC_COMP
+) {
+
+1515 i((
+sc
+->
+sc_ags
+ & 
+SC_REJ_COMP_TCP
+|| sc->
+sc_comp
+ == 0)
+
+1516 
+bad
+;
+
+1518 
+xn
+ = 
+	`_uncomess_t_ce
+(
+
+ + 
+PPP_HDRLEN
+,
+
+1519 
+m
+->
+m_n
+ - 
+PPP_HDRLEN
+, 
+
+ - PPP_HDRLEN,
+
+1520 
+TYPE_COMPRESSED_TCP
+, 
+sc
+->
+sc_comp
+, &
+hdr
+, &
+hn
+);
+
+1522 i(
+xn
+ <= 0) {
+
+1523 i(
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)
+
+1524 
+	`tf
+("%s: VJ uncompress failed onype comp\n",
+
+1525 
+i
+->
+if_xme
+);
+
+1526 
+bad
+;
+
+1530 
+	`MGETHDR
+(
+mp
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+1531 i(
+mp
+ =
+NULL
+)
+
+1532 
+bad
+;
+
+1533 
+mp
+->
+m_n
+ = 0;
+
+1534 
+mp
+->
+m_xt
+ = 
+NULL
+;
+
+1535 i(
+hn
+ + 
+PPP_HDRLEN
+ > 
+MHLEN
+) {
+
+1536 
+	`MCLGET
+(
+mp
+, 
+M_DONTWAIT
+);
+
+1537 i(
+	`M_TRAILINGSPACE
+(
+mp
+< 
+hn
+ + 
+PPP_HDRLEN
+) {
+
+1539 
+	`m_m
+(
+mp
+);
+
+1540 
+bad
+;
+
+1543 
+
+ = 
+	`mtod
+(
+mp
+, 
+u_ch
+ *);
+
+1544 
+
+[0] = 
+adrs
+;
+
+1545 
+
+[1] = 
+
+;
+
+1546 
+
+[2] = 0;
+
+1547 
+
+[3] = 
+PPP_IP
+;
+
+1548 
+o
+ = 
+PPP_IP
+;
+
+1549 
+	`bcy
+(
+hdr
+, 
+
+ + 
+PPP_HDRLEN
+, 
+hn
+);
+
+1550 
+mp
+->
+m_n
+ = 
+hn
+ + 
+PPP_HDRLEN
+;
+
+1556 
+m
+->
+m_da
+ +
+PPP_HDRLEN
+ + 
+xn
+;
+
+1557 
+m
+->
+m_n
+ -
+PPP_HDRLEN
+ + 
+xn
+;
+
+1558 i(
+m
+->
+m_n
+ <
+	`M_TRAILINGSPACE
+(
+mp
+)) {
+
+1559 
+	`bcy
+(
+	`mtod
+(
+m
+, 
+u_ch
+ *),
+
+1560 
+	`mtod
+(
+mp
+, 
+u_ch
+ *+ mp->
+m_n
+, 
+m
+->m_len);
+
+1561 
+mp
+->
+m_n
+ +
+m
+->m_len;
+
+1562 
+	`MFREE
+(
+m
+, 
+mp
+->
+m_xt
+);
+
+1564 
+mp
+->
+m_xt
+ = 
+m
+;
+
+1565 
+m
+ = 
+mp
+;
+
+1566 
+
+ +
+hn
+ - 
+xn
+;
+
+1568 } i(
+o
+ =
+PPP_VJC_UNCOMP
+) {
+
+1569 i((
+sc
+->
+sc_ags
+ & 
+SC_REJ_COMP_TCP
+|| sc->
+sc_comp
+ == 0)
+
+1570 
+bad
+;
+
+1572 
+xn
+ = 
+	`_uncomess_t_ce
+(
+
+ + 
+PPP_HDRLEN
+,
+
+1573 
+m
+->
+m_n
+ - 
+PPP_HDRLEN
+, 
+
+ - PPP_HDRLEN,
+
+1574 
+TYPE_UNCOMPRESSED_TCP
+, 
+sc
+->
+sc_comp
+, &
+hdr
+, &
+hn
+);
+
+1576 i(
+xn
+ < 0) {
+
+1577 i(
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)
+
+1578 
+	`tf
+("%s: VJ uncompress failed onype uncomp\n",
+
+1579 
+i
+->
+if_xme
+);
+
+1580 
+bad
+;
+
+1583 
+o
+ = 
+PPP_IP
+;
+
+1584 
+
+[3] = 
+PPP_IP
+;
+
+1592 i(
+
+ <
+MHLEN
+ && 
+	`M_IS_CLUSTER
+(
+m
+)) {
+
+1593 
+	`MGETHDR
+(
+mp
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+1594 i(
+mp
+ !
+NULL
+) {
+
+1595 
+	`m_cyda
+(
+m
+, 0, 
+
+, 
+	`mtod
+(
+mp
+, *));
+
+1596 
+	`m_m
+(
+m
+);
+
+1597 
+m
+ = 
+mp
+;
+
+1598 
+m
+->
+m_n
+ = 
+
+;
+
+1601 
+m
+->
+m_pkthdr
+.
+n
+ = 
+
+;
+
+1602 
+m
+->
+m_pkthdr
+.
+rcvif
+ = 
+i
+;
+
+1604 i((
+o
+ & 0x8000) == 0) {
+
+1605 #ifde
+PPP_FILTER
+
+
+1610 i(
+sc
+->
+sc_ss_ft_
+.
+bf_s
+ != 0
+
+1611 && 
+	`bpf_fr
+(
+sc
+->
+sc_ss_ft_
+.
+bf_s
+,
+
+1612 (
+u_ch
+ *)
+m
+, 
+
+, 0) == 0) {
+
+1614 
+	`m_m
+(
+m
+);
+
+1617 i(
+sc
+->
+sc_aive_ft_
+.
+bf_s
+ == 0
+
+1618 || 
+	`bpf_fr
+(
+sc
+->
+sc_aive_ft_
+.
+bf_s
+,
+
+1619 (
+u_ch
+ *)
+m
+, 
+
+, 0))
+
+1620 
+sc
+->
+sc__cv
+ = 
+time_cd
+;
+
+1625 
+sc
+->
+sc__cv
+ = 
+time_cd
+;
+
+1630 
+	`bpf_mp
+(&
+sc
+->
+sc_if
+, 
+m
+);
+
+1632 
+o
+) {
+
+1633 #ifde
+INET
+
+
+1634 
+PPP_IP
+:
+
+1638 i((
+i
+->
+if_ags
+ & 
+IFF_UP
+) == 0
+
+1639 || 
+sc
+->
+sc_mode
+[
+NP_IP
+] !
+NPMODE_PASS
+) {
+
+1641 
+	`m_m
+(
+m
+);
+
+1644 
+m
+->
+m_pkthdr
+.
+n
+ -
+PPP_HDRLEN
+;
+
+1645 
+m
+->
+m_da
+ +
+PPP_HDRLEN
+;
+
+1646 
+m
+->
+m_n
+ -
+PPP_HDRLEN
+;
+
+1647 #ifde
+GATEWAY
+
+
+1648 i(
+	`ow_fwd
+(
+m
+))
+
+1651 
+pktq
+ = 
+_pktq
+;
+
+1655 #ifde
+INET6
+
+
+1656 
+PPP_IPV6
+:
+
+1661 i((
+i
+->
+if_ags
+ & 
+IFF_UP
+) == 0
+
+1662 || 
+sc
+->
+sc_mode
+[
+NP_IPV6
+] !
+NPMODE_PASS
+) {
+
+1664 
+	`m_m
+(
+m
+);
+
+1667 
+m
+->
+m_pkthdr
+.
+n
+ -
+PPP_HDRLEN
+;
+
+1668 
+m
+->
+m_da
+ +
+PPP_HDRLEN
+;
+
+1669 
+m
+->
+m_n
+ -
+PPP_HDRLEN
+;
+
+1670 #ifde
+GATEWAY
+
+
+1671 i(
+	`6ow_fwd
+(&
+m
+))
+
+1674 
+pktq
+ = 
+6_pktq
+;
+
+1682 
+q
+ = &
+sc
+->
+sc_q
+;
+
+1683 
+pktq
+ = 
+NULL
+;
+
+1690 
+s
+ = 
+	`
+();
+
+1693 i(
+	`__edi_ue
+(
+pktq
+)) {
+
+1694 i(
+	`__edi_l
+(!
+	`pktq_queue
+(
+pktq
+, 
+m
+, 0))) {
+
+1695 
+i
+->
+if_iqdrs
+++;
+
+1696 
+bad
+;
+
+1698 
+i
+->
+if_acks
+++;
+
+1699 
+i
+->
+if_ibys
+ +
+
+;
+
+1700 
+	`lx
+(
+s
+);
+
+1705 i(!
+q
+) {
+
+1706 
+bad
+;
+
+1708 i(
+	`IF_QFULL
+(
+q
+)) {
+
+1709 
+	`IF_DROP
+(
+q
+);
+
+1710 
+	`lx
+(
+s
+);
+
+1711 i(
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)
+
+1712 
+	`tf
+("%s: iuqueufu\n", 
+i
+->
+if_xme
+);
+
+1713 
+i
+->
+if_iqdrs
+++;
+
+1714 
+bad
+;
+
+1716 
+	`IF_ENQUEUE
+(
+q
+, 
+m
+);
+
+1717 
+	`lx
+(
+s
+);
+
+1718 
+i
+->
+if_acks
+++;
+
+1719 
+i
+->
+if_ibys
+ +
+
+;
+
+1721 (*
+sc
+->
+sc_
+)(sc);
+
+1725 
+bad
+:
+
+1726 
+	`m_m
+(
+m
+);
+
+1727 
+sc
+->
+sc_if
+.
+if_s
+++;
+
+1728 
+sc
+->
+sc_s
+.
+p_s
+++;
+
+1729 
+	}
+}
+
+1731 
+	#MAX_DUMP_BYTES
+ 128
+
+	)
+
+1734 
+	$pdumpm
+(
+mbuf
+ *
+m0
+)
+
+1736 
+buf
+[3*
+MAX_DUMP_BYTES
++4];
+
+1737 *
+bp
+ = 
+buf
+;
+
+1738 
+mbuf
+ *
+m
+;
+
+1740 
+m
+ = 
+m0
+; m; m = m->
+m_xt
+) {
+
+1741 
+l
+ = 
+m
+->
+m_n
+;
+
+1742 
+u_ch
+ *
+
+ = (u_ch *)
+m
+->
+m_da
+;
+
+1744 
+l
+--) {
+
+1745 i(
+bp
+ > 
+buf
+ + (buf) - 4)
+
+1746 
+de
+;
+
+1748 *
+bp
+++ = 
+hexdigs
+[*
+
+ >> 4];
+
+1749 *
+bp
+++ = 
+hexdigs
+[*
+
+++ & 0xf];
+
+1752 i(
+m
+->
+m_xt
+) {
+
+1753 i(
+bp
+ > 
+buf
+ + (buf) - 3)
+
+1754 
+de
+;
+
+1755 *
+bp
+++ = '|';
+
+1757 *
+bp
+++ = ' ';
+
+1759 
+de
+:
+
+1760 i(
+m
+)
+
+1761 *
+bp
+++ = '>';
+
+1762 *
+bp
+ = 0;
+
+1763 
+	`tf
+("%s\n", 
+buf
+);
+
+1764 
+	}
+}
+
+1766 #ifde
+ALTQ
+
+
+1772 
+	$p_ift
+(
+i
+ *
+i
+)
+
+1774 
+p_soc
+ *
+sc
+;
+
+1776 
+sc
+ = 
+i
+->
+if_soc
+;
+
+1777 (*
+sc
+->
+sc_t
+)(sc);
+
+1778 
+	}
+}
+
+1781 c 
+	sp_known_comess
+ {
+
+1782 
+ut8_t
+ 
+	mcode
+;
+
+1783 c *
+	mmodu
+;
+
+1784 } 
+	gp_known_comesss
+[] = {
+
+1785 { 
+CI_DEFLATE
+, "ppp_deflate" },
+
+1786 { 
+CI_DEFLATE_DRAFT
+, "ppp_deflate" },
+
+1787 { 
+CI_BSD_COMPRESS
+, "ppp_bsdcomp" },
+
+1788 { 
+CI_MPPE
+, "ppp_mppe" },
+
+1789 { 0, 
+NULL
+ }
+
+1793 
+	$p_comess_
+()
+
+1796 
+	`mux_
+(&
+p_comesss_mtx
+, 
+MUTEX_DEFAULT
+, 
+IPL_NONE
+);
+
+1798 
+	}
+}
+
+1801 
+	$p_comess_
+(
+comess
+ *
+
+)
+
+1804 
+	`mux_r
+(&
+p_comesss_mtx
+);
+
+1805 --
+
+->
+comp_ft
+;
+
+1806 
+	`mux_ex
+(&
+p_comesss_mtx
+);
+
+1807 
+	}
+}
+
+1809 
+comess
+ *
+
+1810 
+	$p_g_comess_nd
+(
+ut8_t
+ 
+ci
+, 
+bo
+ 
+hd
+)
+
+1812 
+comess
+ *
+
+;
+
+1814 
+	`KASSERT
+(
+	`mux_owd
+(&
+p_comesss_mtx
+));
+
+1815 
+	`LIST_FOREACH
+(
+
+, &
+p_comesss
+, 
+comp_li
+) {
+
+1816 i(
+
+->
+comess_o
+ =
+ci
+) {
+
+1817 i(
+hd
+)
+
+1818 ++
+
+->
+comp_ft
+;
+
+1819  
+
+;
+
+1823  
+NULL
+;
+
+1824 
+	}
+}
+
+1826 
+comess
+ *
+
+1827 
+	$p_g_comess
+(
+ut8_t
+ 
+ci
+)
+
+1829 
+comess
+ *
+
+ = 
+NULL
+;
+
+1830 c 
+p_known_comess
+ *
+pkc
+;
+
+1832 
+	`mux_r
+(&
+p_comesss_mtx
+);
+
+1833 
+
+ = 
+	`p_g_comess_nd
+(
+ci
+, 
+ue
+);
+
+1834 
+	`mux_ex
+(&
+p_comesss_mtx
+);
+
+1835 i(
+
+ !
+NULL
+)
+
+1836  
+
+;
+
+1838 
+	`kncfig_lock
+();
+
+1839 
+	`mux_r
+(&
+p_comesss_mtx
+);
+
+1840 
+
+ = 
+	`p_g_comess_nd
+(
+ci
+, 
+ue
+);
+
+1841 
+	`mux_ex
+(&
+p_comesss_mtx
+);
+
+1842 i(
+
+ =
+NULL
+) {
+
+1844 
+pkc
+ = 
+p_known_comesss
+;kc->
+modu
+ !
+NULL
+;kc++) {
+
+1845 i(
+pkc
+->
+code
+ =
+ci
+) {
+
+1846 i(
+	`modu_autd
+(
+pkc
+->
+modu
+,
+
+1847 
+MODULE_CLASS_MISC
+) != 0)
+
+1849 
+	`mux_r
+(&
+p_comesss_mtx
+);
+
+1850 
+
+ = 
+	`p_g_comess_nd
+(
+ci
+, 
+ue
+);
+
+1851 
+	`mux_ex
+(&
+p_comesss_mtx
+);
+
+1856 
+	`kncfig_uock
+();
+
+1858  
+
+;
+
+1859 
+	}
+}
+
+1862 
+	$p_gi_comess
+(
+comess
+ *
+pc
+, 
+size_t
+ 
+ncomp
+)
+
+1864 
+r
+ = 0;
+
+1865 
+size_t
+ 
+i
+;
+
+1867 
+	`RUN_ONCE
+(&
+p_comess_mtx_
+, 
+p_comess_
+);
+
+1869 
+	`mux_r
+(&
+p_comesss_mtx
+);
+
+1870 
+i
+ = 0; i < 
+ncomp
+; i++) {
+
+1871 i(
+	`p_g_comess_nd
+(
+pc
+[
+i
+].
+comess_o
+,
+
+1872 
+l
+!
+NULL
+)
+
+1873 
+r
+ = 
+EEXIST
+;
+
+1875 i(!
+r
+) {
+
+1876 
+i
+ = 0; i < 
+ncomp
+; i++) {
+
+1877 
+pc
+[
+i
+].
+comp_ft
+ = 0;
+
+1878 
+	`LIST_INSERT_HEAD
+(&
+p_comesss
+, &
+pc
+[
+i
+], 
+comp_li
+);
+
+1881 
+	`mux_ex
+(&
+p_comesss_mtx
+);
+
+1883  
+r
+;
+
+1884 
+	}
+}
+
+1887 
+	$p_uegi_comess
+(
+comess
+ *
+pc
+, 
+size_t
+ 
+ncomp
+)
+
+1889 
+r
+ = 0;
+
+1890 
+size_t
+ 
+i
+;
+
+1892 
+	`mux_r
+(&
+p_comesss_mtx
+);
+
+1893 
+i
+ = 0; i < 
+ncomp
+; i++) {
+
+1894 i(
+	`p_g_comess_nd
+(
+pc
+[
+i
+].
+comess_o
+,
+
+1895 
+l
+!&
+pc
+[
+i
+])
+
+1896 
+r
+ = 
+ENOENT
+;
+
+1897 i(
+pc
+[
+i
+].
+comp_ft
+ != 0)
+
+1898 
+r
+ = 
+EBUSY
+;
+
+1900 i(!
+r
+) {
+
+1901 
+i
+ = 0; i < 
+ncomp
+; i++) {
+
+1902 
+	`LIST_REMOVE
+(&
+pc
+[
+i
+], 
+comp_li
+);
+
+1905 
+	`mux_ex
+(&
+p_comesss_mtx
+);
+
+1907  
+r
+;
+
+1908 
+	}
+}
+
+	@if_ppp.h
+
+46 #ide
+_NET_IF_PPP_H_
+
+
+47 
+	#_NET_IF_PPP_H_
+
+
+	)
+
+52 
+	#SC_COMP_PROT
+ 0x00000001
+
+	)
+
+53 
+	#SC_COMP_AC
+ 0x00000002
+
+	)
+
+54 
+	#SC_COMP_TCP
+ 0x00000004
+
+	)
+
+55 
+	#SC_NO_TCP_CCID
+ 0x00000008
+
+	)
+
+56 
+	#SC_REJ_COMP_AC
+ 0x00000010
+
+	)
+
+57 
+	#SC_REJ_COMP_TCP
+ 0x00000020
+
+	)
+
+58 
+	#SC_CCP_OPEN
+ 0x00000040
+
+	)
+
+59 
+	#SC_CCP_UP
+ 0x00000080
+
+	)
+
+60 
+	#SC_DEBUG
+ 0x00010000
+
+	)
+
+61 
+	#SC_LOG_INPKT
+ 0x00020000
+
+	)
+
+62 
+	#SC_LOG_OUTPKT
+ 0x00040000
+
+	)
+
+63 
+	#SC_LOG_RAWIN
+ 0x00080000
+
+	)
+
+64 
+	#SC_LOG_FLUSH
+ 0x00100000
+
+	)
+
+65 
+	#SC_SYNC
+ 0x00200000
+
+	)
+
+66 
+	#SC_RCV_B7_0
+ 0x01000000
+
+	)
+
+67 
+	#SC_RCV_B7_1
+ 0x02000000
+
+	)
+
+68 
+	#SC_RCV_EVNP
+ 0x04000000
+
+	)
+
+69 
+	#SC_RCV_ODDP
+ 0x08000000
+
+	)
+
+71 
+	#SC_MASK
+ 0x0fff00f
+
+	)
+
+76 
+	#SC_TIMEOUT
+ 0x00000400
+
+	)
+
+77 
+	#SC_VJ_RESET
+ 0x00000800
+
+	)
+
+78 
+	#SC_COMP_RUN
+ 0x00001000
+
+	)
+
+79 
+	#SC_DECOMP_RUN
+ 0x00002000
+
+	)
+
+80 
+	#SC_DC_ERROR
+ 0x00004000
+
+	)
+
+81 
+	#SC_DC_FERROR
+ 0x00008000
+
+	)
+
+82 
+	#SC_TBUSY
+ 0x10000000
+
+	)
+
+83 
+	#SC_PKTLOST
+ 0x20000000
+
+	)
+
+84 
+	#SC_FLUSH
+ 0x40000000
+
+	)
+
+85 
+	#SC_ESCAPED
+ 0x80000000
+
+	)
+
+91 
+	siol
+ {
+
+92 
+	moc
+;
+
+93 
+NPmode
+ 
+	mmode
+;
+
+97 
+	sp_ti_da
+ {
+
+98 
+u_ch
+ *
+	mr
+;
+
+99 
+u_t
+ 
+	mngth
+;
+
+100 
+	msm
+;
+
+103 
+	sieq
+ {
+
+104 
+	mi_me
+[
+IFNAMSIZ
+];
+
+105 
+p_s
+ 
+	ms
+;
+
+108 
+	siceq
+ {
+
+109 
+	mi_me
+[
+IFNAMSIZ
+];
+
+110 
+p_comp_s
+ 
+	ms
+;
+
+113 
+	sp_w
+ {
+
+114 
+u_ch
+ 
+	mbuf
+[63];
+
+115 
+u_ch
+ 
+	mcou
+;
+
+122 
+	#PPPIOCGRAWIN
+ 
+	`_IOR
+('t', 91, 
+p_w
+
+
+	)
+
+123 
+	#PPPIOCGFLAGS
+ 
+	`_IOR
+('t', 90, 
+
+	)
+
+124 
+	#PPPIOCSFLAGS
+ 
+	`_IOW
+('t', 89, 
+
+	)
+
+125 
+	#PPPIOCGASYNCMAP
+ 
+	`_IOR
+('t', 88, 
+
+	)
+
+126 
+	#PPPIOCSASYNCMAP
+ 
+	`_IOW
+('t', 87, 
+
+	)
+
+127 
+	#PPPIOCGUNIT
+ 
+	`_IOR
+('t', 86, 
+
+	)
+
+128 
+	#PPPIOCGRASYNCMAP
+ 
+	`_IOR
+('t', 85, 
+
+	)
+
+129 
+	#PPPIOCSRASYNCMAP
+ 
+	`_IOW
+('t', 84, 
+
+	)
+
+130 
+	#PPPIOCGMRU
+ 
+	`_IOR
+('t', 83, 
+
+	)
+
+131 
+	#PPPIOCSMRU
+ 
+	`_IOW
+('t', 82, 
+
+	)
+
+132 
+	#PPPIOCSMAXCID
+ 
+	`_IOW
+('t', 81, 
+
+	)
+
+133 
+	#PPPIOCGXASYNCMAP
+ 
+	`_IOR
+('t', 80, 
+ext_accm
+
+
+	)
+
+134 
+	#PPPIOCSXASYNCMAP
+ 
+	`_IOW
+('t', 79, 
+ext_accm
+
+
+	)
+
+135 
+	#PPPIOCXFERUNIT
+ 
+	`_IO
+('t', 78
+
+	)
+
+136 
+	#PPPIOCSCOMPRESS
+ 
+	`_IOW
+('t', 77, 
+p_ti_da
+)
+
+	)
+
+137 
+	#PPPIOCGNPMODE
+ 
+	`_IOWR
+('t', 76, 
+iol
+
+
+	)
+
+138 
+	#PPPIOCSNPMODE
+ 
+	`_IOW
+('t', 75, 
+iol
+
+
+	)
+
+139 
+	#PPPIOCGIDLE
+ 
+	`_IOR
+('t', 74, 
+p_id
+
+
+	)
+
+140 #ifde
+PPP_FILTER
+
+
+147 
+	#PPPIOCSPASS
+ 
+	`_IOW
+('t', 71, 
+bpf_ogm
+
+
+	)
+
+148 
+	#PPPIOCSACTIVE
+ 
+	`_IOW
+('t', 70, 
+bpf_ogm
+
+
+	)
+
+153 
+	#PPPIOCSIPASS
+ 
+	`_IOW
+('t', 69, 
+bpf_ogm
+
+
+	)
+
+154 
+	#PPPIOCSOPASS
+ 
+	`_IOW
+('t', 68, 
+bpf_ogm
+
+
+	)
+
+155 
+	#PPPIOCSIACTIVE
+ 
+	`_IOW
+('t', 67, 
+bpf_ogm
+
+
+	)
+
+156 
+	#PPPIOCSOACTIVE
+ 
+	`_IOW
+('t', 66, 
+bpf_ogm
+
+
+	)
+
+160 
+	#PPPIOCGMTU
+ 
+	`_IOR
+('t', 73, 
+
+	)
+
+161 
+	#PPPIOCSMTU
+ 
+	`_IOW
+('t', 72, 
+
+	)
+
+167 
+	#SIOCGPPPSTATS
+ 
+	`_IOWR
+('i', 123, 
+ieq
+)
+
+	)
+
+168 
+	#SIOCGPPPCSTATS
+ 
+	`_IOWR
+('i', 122, 
+iceq
+)
+
+	)
+
+170 #i!
+defed
+(
+i_mtu
+)
+
+171 
+	#i_mtu
+ 
+i_iu
+.
+iu_mric
+
+
+	)
+
+174 #i
+defed
+(
+_KERNEL
+|| defed(
+KERNEL
+)
+
+175 
+ach
+();
+
+177 
+	gcomess
+;
+
+178 
+p_gi_comess
+(
+comess
+ *, 
+size_t
+);
+
+179 
+p_uegi_comess
+(
+comess
+ *, 
+size_t
+);
+
+	@if_pppoe.c
+
+32 
+	~<sys/cdefs.h
+>
+
+33 
+__KERNEL_RCSID
+(0, "$NetBSD: if_pppoe.c,v 1.102 2014/10/18 08:33:29 snj Exp $");
+
+35 
+	~"p.h
+"
+
+36 
+	~"t_p.h
+"
+
+38 
+	~<sys/m.h
+>
+
+39 
+	~<sys/sym.h
+>
+
+40 
+	~<sys/kl.h
+>
+
+41 
+	~<sys/out.h
+>
+
+42 
+	~<sys/mloc.h
+>
+
+43 
+	~<sys/mbuf.h
+>
+
+44 
+	~<sys/sock.h
+>
+
+45 
+	~<sys/oc.h
+>
+
+46 
+	~<sys/iol.h
+>
+
+47 
+	~<sys/kauth.h
+>
+
+48 
+	~<sys/.h
+>
+
+49 
+	~<sys/sockv.h
+>
+
+51 
+	~<t/if.h
+>
+
+52 
+	~<t/if_tys.h
+>
+
+53 
+	~<t/if_h.h
+>
+
+54 
+	~<t/if_.h
+>
+
+55 
+	~<t/if_v.h
+>
+
+56 
+	~<t/if_p.h
+>
+
+58 
+	~<t/bpf.h
+>
+
+61 #unde
+PPPOE_DEBUG
+
+
+64 
+	sphdr
+ {
+
+65 
+ut8_t
+ 
+	mvty
+;
+
+66 
+ut8_t
+ 
+	mcode
+;
+
+67 
+ut16_t
+ 
+	mssi
+;
+
+68 
+ut16_t
+ 
+	m
+;
+
+69 } 
+	g__cked
+;
+
+71 
+	spg
+ {
+
+72 
+ut16_t
+ 
+	mg
+;
+
+73 
+ut16_t
+ 
+	mn
+;
+
+74 } 
+	g__cked
+;
+
+76 
+	#PPPOE_HEADERLEN
+ (
+phdr
+)
+
+	)
+
+77 
+	#PPPOE_OVERHEAD
+ (
+PPPOE_HEADERLEN
+ + 2)
+
+	)
+
+78 
+	#PPPOE_VERTYPE
+ 0x11
+
+	)
+
+80 
+	#PPPOE_TAG_EOL
+ 0x0000
+
+	)
+
+81 
+	#PPPOE_TAG_SNAME
+ 0x0101
+
+	)
+
+82 
+	#PPPOE_TAG_ACNAME
+ 0x0102
+
+	)
+
+83 
+	#PPPOE_TAG_HUNIQUE
+ 0x0103
+
+	)
+
+84 
+	#PPPOE_TAG_ACCOOKIE
+ 0x0104
+
+	)
+
+85 
+	#PPPOE_TAG_VENDOR
+ 0x0105
+
+	)
+
+86 
+	#PPPOE_TAG_RELAYSID
+ 0x0110
+
+	)
+
+87 
+	#PPPOE_TAG_MAX_PAYLOAD
+ 0x0120
+
+	)
+
+88 
+	#PPPOE_TAG_SNAME_ERR
+ 0x0201
+
+	)
+
+89 
+	#PPPOE_TAG_ACSYS_ERR
+ 0x0202
+
+	)
+
+90 
+	#PPPOE_TAG_GENERIC_ERR
+ 0x0203
+
+	)
+
+92 
+	#PPPOE_CODE_PADI
+ 0x09
+
+	)
+
+93 
+	#PPPOE_CODE_PADO
+ 0x07
+
+	)
+
+94 
+	#PPPOE_CODE_PADR
+ 0x19
+
+	)
+
+95 
+	#PPPOE_CODE_PADS
+ 0x65
+
+	)
+
+96 
+	#PPPOE_CODE_PADT
+ 0xA7
+
+	)
+
+99 
+	#PPPOE_MAXMTU
+ (
+ETHERMTU
+ - 
+PPPOE_OVERHEAD
+)
+
+	)
+
+102 
+	#PPPOE_ADD_16
+(
+PTR
+, 
+VAL
+) \
+
+103 *(
+PTR
+)++ = (
+VAL
+) / 256; \
+
+104 *(
+PTR
+)++ = (
+VAL
+% 256
+
+	)
+
+107 
+	#PPPOE_ADD_HEADER
+(
+PTR
+, 
+CODE
+, 
+SESS
+, 
+LEN
+) \
+
+108 *(
+PTR
+)++ = 
+PPPOE_VERTYPE
+; \
+
+109 *(
+PTR
+)++ = (
+CODE
+); \
+
+110 
+	`PPPOE_ADD_16
+(
+PTR
+, 
+SESS
+); \
+
+111 
+	`PPPOE_ADD_16
+(
+PTR
+, 
+LEN
+)
+
+	)
+
+113 
+	#PPPOE_DISC_TIMEOUT
+ (
+hz
+*5
+
+	)
+
+114 
+	#PPPOE_SLOW_RETRY
+ (
+hz
+*60
+
+	)
+
+115 
+	#PPPOE_RECON_FAST
+ (
+hz
+*15
+
+	)
+
+116 
+	#PPPOE_RECON_IMMEDIATE
+ (
+hz
+/10
+
+	)
+
+117 
+	#PPPOE_DISC_MAXPADI
+ 4
+
+	)
+
+118 
+	#PPPOE_DISC_MAXPADR
+ 2
+
+	)
+
+120 #ifde
+PPPOE_SERVER
+
+
+122 
+	#IFF_PASSIVE
+ 
+IFF_LINK0
+
+
+	)
+
+125 
+	sp_soc
+ {
+
+126 
+
+ 
+	msc_
+;
+
+127 
+LIST_ENTRY
+(
+p_soc
+
+	msc_li
+;
+
+128 
+i
+ *
+	msc_h_if
+;
+
+130 
+	msc_e
+;
+
+131 
+h_addr
+ 
+	msc_de
+;
+
+132 
+ut16_t
+ 
+	msc_ssi
+;
+
+134 *
+	msc_rvi_me
+;
+
+135 *
+	msc_ct_me
+;
+
+136 
+ut8_t
+ *
+	msc_ac_cook
+;
+
+137 
+size_t
+ 
+	msc_ac_cook_n
+;
+
+138 
+ut8_t
+ *
+	msc_y_sid
+;
+
+139 
+size_t
+ 
+	msc_y_sid_n
+;
+
+140 #ifde
+PPPOE_SERVER
+
+
+141 
+ut8_t
+ *
+	msc_hunique
+;
+
+142 
+size_t
+ 
+	msc_hunique_n
+;
+
+144 
+out_t
+ 
+	msc_timeout
+;
+
+145 
+	msc_di_d
+;
+
+146 
+	msc_dr_d
+;
+
+150 
+ifqueue
+ 
+	gdiscq
+ = { .
+ifq_maxn
+ = 
+IFQ_MAXLEN
+ };
+
+151 
+ifqueue
+ 
+	gq
+ = { .
+ifq_maxn
+ = 
+IFQ_MAXLEN
+ };
+
+153 *
+	gp_so
+ = 
+NULL
+;
+
+154 
+p_so_hdr
+(*);
+
+156 
+_iol
+(
+i
+ *, , *);
+
+159 
+p_put
+();
+
+160 
+p_disc_put
+(
+mbuf
+ *);
+
+161 
+p_dich_disc_pkt
+(
+mbuf
+ *, );
+
+162 
+p_da_put
+(
+mbuf
+ *);
+
+165 
+pch
+();
+
+166 
+p_c
+(
+p_soc
+ *);
+
+167 
+p_disc
+(
+p_soc
+ *);
+
+168 
+p_abt_c
+(
+p_soc
+ *);
+
+169 
+p_iol
+(
+i
+ *, , *);
+
+170 
+p_s
+(
+
+ *);
+
+171 
+p_f
+(
+
+ *);
+
+172 
+p_t
+(
+i
+ *);
+
+173 
+p_r_soc
+(
+p_soc
+ *, const *);
+
+176 
+p_timeout
+(*);
+
+179 
+p_nd_di
+(
+p_soc
+ *);
+
+180 
+p_nd_dr
+(
+p_soc
+ *);
+
+181 #ifde
+PPPOE_SERVER
+
+
+182 
+p_nd_do
+(
+p_soc
+ *);
+
+183 
+p_nd_ds
+(
+p_soc
+ *);
+
+185 
+p_nd_dt
+(
+i
+ *, 
+u_t
+, c 
+ut8_t
+ *);
+
+188 
+p_ouut
+(
+p_soc
+ *, 
+mbuf
+ *);
+
+191 
+p_soc
+ * 
+p_fd_soc_by_ssi
+(
+u_t
+, 
+i
+ *);
+
+192 
+p_soc
+ * 
+p_fd_soc_by_hunique
+(
+ut8_t
+ *, 
+size_t
+, 
+i
+ *);
+
+193 
+mbuf
+ *
+p_g_mbuf
+(
+size_t
+ 
+n
+);
+
+195 
+p_iach_hook
+(*, 
+mbuf
+ **, 
+i
+ *, );
+
+197 
+	$LIST_HEAD
+(
+p_soc_hd
+, 
+p_soc
+
+p_soc_li
+;
+
+199 
+	`p_e_
+(
+if_e
+ *, );
+
+200 
+	`p_e_deroy
+(
+i
+ *);
+
+202 
+if_e
+ 
+p_
+ =
+
+203 
+	`IF_CLONE_INITIALIZER
+("p", 
+p_e_
+, 
+p_e_deroy
+);
+
+207 
+	$pch
+(
+cou
+)
+
+209 
+	`LIST_INIT
+(&
+p_soc_li
+);
+
+210 
+	`if_e_ch
+(&
+p_
+);
+
+212 
+p_so
+ = 
+	`sot_eablish
+(
+SOFTINT_NET
+, 
+p_so_hdr
+, 
+NULL
+);
+
+213 
+	}
+}
+
+216 
+	$p_e_
+(
+if_e
+ *
+ifc
+, 
+un
+)
+
+218 
+p_soc
+ *
+sc
+;
+
+220 
+sc
+ = 
+	`mloc
+((
+p_soc
+), 
+M_DEVBUF
+, 
+M_WAITOK
+|
+M_ZERO
+);
+
+222 
+	`if_me
+(&
+sc
+->
+sc_
+.
+_if
+, "p", 
+un
+);
+
+223 
+sc
+->
+sc_
+.
+_if
+.
+if_soc
+ = sc;
+
+224 
+sc
+->
+sc_
+.
+_if
+.
+if_mtu
+ = 
+PPPOE_MAXMTU
+;
+
+225 
+sc
+->
+sc_
+.
+_if
+.
+if_ags
+ = 
+IFF_SIMPLEX
+|
+IFF_POINTOPOINT
+|
+IFF_MULTICAST
+;
+
+226 
+sc
+->
+sc_
+.
+_if
+.
+if_ty
+ = 
+IFT_PPP
+;
+
+227 
+sc
+->
+sc_
+.
+_if
+.
+if_hd
+ = (
+h_hd
++ 
+PPPOE_HEADERLEN
+;
+
+228 
+sc
+->
+sc_
+.
+_if
+.
+if_d
+ = 
+DLT_PPP_ETHER
+;
+
+229 
+sc
+->
+sc_
+.
+_ags
+ |
+PP_KEEPALIVE
+ |
+
+230 
+PP_NOFRAMING
+;
+
+231 
+sc
+->
+sc_
+.
+_if
+.
+if_iol
+ = 
+p_iol
+;
+
+232 
+	`IFQ_SET_MAXLEN
+(&
+sc
+->
+sc_
+.
+_if
+.
+if_d
+, 
+IFQ_MAXLEN
+);
+
+233 
+	`IFQ_SET_READY
+(&
+sc
+->
+sc_
+.
+_if
+.
+if_d
+);
+
+236 
+	`memy
+(&
+sc
+->
+sc_de
+, 
+hbrdaddr
+, (sc->sc_dest));
+
+238 
+	`out_
+(&
+sc
+->
+sc_timeout
+, 0);
+
+240 
+sc
+->
+sc_
+.
+_if
+.
+if_t
+ = 
+p_t
+;
+
+241 
+sc
+->
+sc_
+.
+_s
+ = 
+p_s
+;
+
+242 
+sc
+->
+sc_
+.
+_f
+ = 
+p_f
+;
+
+243 
+sc
+->
+sc_
+.
+_amebys
+ = 
+PPPOE_HEADERLEN
+;
+
+245 
+	`if_ch
+(&
+sc
+->
+sc_
+.
+_if
+);
+
+246 
+	`_ch
+(&
+sc
+->
+sc_
+.
+_if
+);
+
+248 
+	`bpf_ch
+(&
+sc
+->
+sc_
+.
+_if
+, 
+DLT_PPP_ETHER
+, 0);
+
+249 i(
+	`LIST_EMPTY
+(&
+p_soc_li
+)) {
+
+250 
+	`pf_add_hook
+(
+p_iach_hook
+, 
+NULL
+, 
+PFIL_IFNET
+, 
+if_pf
+);
+
+252 
+	`LIST_INSERT_HEAD
+(&
+p_soc_li
+, 
+sc
+, 
+sc_li
+);
+
+254 
+	}
+}
+
+257 
+	$p_e_deroy
+(
+i
+ *
+i
+)
+
+259 
+p_soc
+ * 
+sc
+ = 
+i
+->
+if_soc
+;
+
+261 
+	`out_
+(&
+sc
+->
+sc_timeout
+);
+
+262 
+	`LIST_REMOVE
+(
+sc
+, 
+sc_li
+);
+
+263 i(
+	`LIST_EMPTY
+(&
+p_soc_li
+)) {
+
+264 
+	`pf_move_hook
+(
+p_iach_hook
+, 
+NULL
+, 
+PFIL_IFNET
+, 
+if_pf
+);
+
+266 
+	`bpf_dach
+(
+i
+);
+
+267 
+	`_dach
+(&
+sc
+->
+sc_
+.
+_if
+);
+
+268 
+	`if_dach
+(
+i
+);
+
+269 i(
+sc
+->
+sc_ct_me
+)
+
+270 
+	`
+(
+sc
+->
+sc_ct_me
+, 
+M_DEVBUF
+);
+
+271 i(
+sc
+->
+sc_rvi_me
+)
+
+272 
+	`
+(
+sc
+->
+sc_rvi_me
+, 
+M_DEVBUF
+);
+
+273 i(
+sc
+->
+sc_ac_cook
+)
+
+274 
+	`
+(
+sc
+->
+sc_ac_cook
+, 
+M_DEVBUF
+);
+
+275 i(
+sc
+->
+sc_y_sid
+)
+
+276 
+	`
+(
+sc
+->
+sc_y_sid
+, 
+M_DEVBUF
+);
+
+277 
+	`out_deroy
+(&
+sc
+->
+sc_timeout
+);
+
+278 
+	`
+(
+sc
+, 
+M_DEVBUF
+);
+
+281 
+	}
+}
+
+289 
+p_soc
+ *
+
+290 
+	$p_fd_soc_by_ssi
+(
+u_t
+ 
+ssi
+, 
+i
+ *
+rcvif
+)
+
+292 
+p_soc
+ *
+sc
+;
+
+294 i(
+ssi
+ == 0)
+
+295  
+NULL
+;
+
+297 
+	`LIST_FOREACH
+(
+sc
+, &
+p_soc_li
+, 
+sc_li
+) {
+
+298 i(
+sc
+->
+sc_e
+ =
+PPPOE_STATE_SESSION
+
+
+299 && 
+sc
+->
+sc_ssi
+ =
+ssi
+
+
+300 && 
+sc
+->
+sc_h_if
+ =
+rcvif
+)
+
+301  
+sc
+;
+
+303  
+NULL
+;
+
+304 
+	}
+}
+
+308 
+p_soc
+ *
+
+309 
+	$p_fd_soc_by_hunique
+(
+ut8_t
+ *
+tok
+, 
+size_t
+ 
+n
+, 
+i
+ *
+rcvif
+)
+
+311 
+p_soc
+ *
+sc
+, *
+t
+;
+
+313 i(
+	`LIST_EMPTY
+(&
+p_soc_li
+))
+
+314  
+NULL
+;
+
+316 i(
+n
+ ! 
+sc
+)
+
+317  
+NULL
+;
+
+318 
+	`memy
+(&
+t
+, 
+tok
+, 
+n
+);
+
+320 
+	`LIST_FOREACH
+(
+sc
+, &
+p_soc_li
+, 
+sc_li
+)
+
+321 i(
+sc
+ =
+t
+) ;
+
+323 i(
+sc
+ =
+NULL
+) {
+
+324 #ifde
+PPPOE_DEBUG
+
+
+325 
+	`tf
+("pppoe:lien host uniqueag,o session found\n");
+
+327  
+NULL
+;
+
+331 i(
+sc
+->
+sc_e
+ < 
+PPPOE_STATE_PADI_SENT
+ || sc->sc_>
+PPPOE_STATE_SESSION
+) {
+
+332 
+	`tf
+("%s: host uniqueag found, but it belongso connection in state %d\n",
+
+333 
+sc
+->
+sc_
+.
+_if
+.
+if_xme
+, sc->
+sc_e
+);
+
+334  
+NULL
+;
+
+336 i(
+sc
+->
+sc_h_if
+ !
+rcvif
+) {
+
+337 
+	`tf
+("%s: wrong interface,otccepting host unique\n",
+
+338 
+sc
+->
+sc_
+.
+_if
+.
+if_xme
+);
+
+339  
+NULL
+;
+
+341  
+sc
+;
+
+342 
+	}
+}
+
+345 
+	$p_so_hdr
+(*
+dummy
+)
+
+348 
+	`mux_r
+(
+sot_lock
+);
+
+349 
+	`p_put
+();
+
+350 
+	`mux_ex
+(
+sot_lock
+);
+
+351 
+	}
+}
+
+355 
+	$p_put
+()
+
+357 
+mbuf
+ *
+m
+;
+
+358 
+s
+, 
+disc_de
+, 
+da_de
+;
+
+361 
+disc_de
+ = 0;
+
+362 
+da_de
+ = 0;
+
+364 
+s
+ = 
+	`
+();
+
+365 
+	`IF_DEQUEUE
+(&
+discq
+, 
+m
+);
+
+366 
+	`lx
+(
+s
+);
+
+367 i(
+m
+ =
+NULL
+) ;
+
+368 
+disc_de
+ = 1;
+
+369 
+	`p_disc_put
+(
+m
+);
+
+373 
+s
+ = 
+	`
+();
+
+374 
+	`IF_DEQUEUE
+(&
+q
+, 
+m
+);
+
+375 
+	`lx
+(
+s
+);
+
+376 i(
+m
+ =
+NULL
+) ;
+
+377 
+da_de
+ = 1;
+
+378 
+	`p_da_put
+(
+m
+);
+
+380 } 
+disc_de
+ || 
+da_de
+);
+
+381 
+	}
+}
+
+385 
+	$p_dich_disc_pkt
+(
+mbuf
+ *
+m
+, 
+off
+)
+
+387 
+ut16_t
+ 
+g
+, 
+n
+;
+
+388 
+ut16_t
+ 
+ssi
+, 
+
+;
+
+389 
+p_soc
+ *
+sc
+;
+
+390 c *
+r_msg
+, *
+devme
+;
+
+391 *
+r
+;
+
+392 
+ut8_t
+ *
+ac_cook
+;
+
+393 
+size_t
+ 
+ac_cook_n
+;
+
+394 
+ut8_t
+ *
+y_sid
+;
+
+395 
+size_t
+ 
+y_sid_n
+;
+
+396 #ifde
+PPPOE_SERVER
+
+
+397 
+ut8_t
+ *
+hunique
+;
+
+398 
+size_t
+ 
+hunique_n
+;
+
+400 
+phdr
+ *
+ph
+;
+
+401 
+pg
+ *
+
+;
+
+402 
+mbuf
+ *
+n
+;
+
+403 
+noff
+, 
+r
+, 
+rg
+;
+
+404 
+h_hd
+ *
+eh
+;
+
+406 
+devme
+ = "pppoe";
+
+407 
+r_msg
+ = 
+NULL
+;
+
+408 
+rg
+ = 0;
+
+409 i(
+m
+->
+m_n
+ < (*
+eh
+)) {
+
+410 
+m
+ = 
+	`m_puup
+(m, (*
+eh
+));
+
+411 i(!
+m
+)
+
+412 
+de
+;
+
+414 
+eh
+ = 
+	`mtod
+(
+m
+, 
+h_hd
+ *);
+
+415 
+off
+ +(*
+eh
+);
+
+417 
+ac_cook
+ = 
+NULL
+;
+
+418 
+ac_cook_n
+ = 0;
+
+419 
+y_sid
+ = 
+NULL
+;
+
+420 
+y_sid_n
+ = 0;
+
+421 #ifde
+PPPOE_SERVER
+
+
+422 
+hunique
+ = 
+NULL
+;
+
+423 
+hunique_n
+ = 0;
+
+425 
+ssi
+ = 0;
+
+426 i(
+m
+->
+m_pkthdr
+.
+n
+ - 
+off
+ <
+PPPOE_HEADERLEN
+) {
+
+427 
+	`tf
+("p:ackosht: %d\n", 
+m
+->
+m_pkthdr
+.
+n
+);
+
+428 
+de
+;
+
+431 
+n
+ = 
+	`m_pudown
+(
+m
+, 
+off
+, (*
+ph
+), &
+noff
+);
+
+432 i(!
+n
+) {
+
+433 
+	`tf
+("pppoe: couldot get PPPoE header\n");
+
+434 
+m
+ = 
+NULL
+;
+
+435 
+de
+;
+
+437 
+ph
+ = (
+phdr
+ *)(
+	`mtod
+(
+n
+, *+ 
+noff
+);
+
+438 i(
+ph
+->
+vty
+ !
+PPPOE_VERTYPE
+) {
+
+439 
+	`tf
+("pppoe: unknown version/typeacket: 0x%x\n",
+
+440 
+ph
+->
+vty
+);
+
+441 
+de
+;
+
+443 
+ssi
+ = 
+	`ohs
+(
+ph
+->session);
+
+444 
+
+ = 
+	`ohs
+(
+ph
+->plen);
+
+445 
+off
+ +(*
+ph
+);
+
+447 i(
+
+ + 
+off
+ > 
+m
+->
+m_pkthdr
+.
+n
+) {
+
+448 
+	`tf
+("pppoe:acket content doesot fit: datavailable = %d,acket size = %u\n",
+
+449 
+m
+->
+m_pkthdr
+.
+n
+ - 
+off
+, 
+
+);
+
+450 
+de
+;
+
+452 
+	`m_adj
+(
+m
+, 
+off
+ + 
+
+ - m->
+m_pkthdr
+.
+n
+);
+
+453 
+g
+ = 0;
+
+454 
+n
+ = 0;
+
+455 
+sc
+ = 
+NULL
+;
+
+456 
+off
+ + (*
+
+<
+m
+->
+m_pkthdr
+.
+n
+) {
+
+457 
+n
+ = 
+	`m_pudown
+(
+m
+, 
+off
+, (*
+
+), &
+noff
+);
+
+458 i(!
+n
+) {
+
+459 
+	`tf
+("%s:\n", 
+devme
+);
+
+460 
+m
+ = 
+NULL
+;
+
+461 
+de
+;
+
+463 
+
+ = (
+pg
+ *)(
+	`mtod
+(
+n
+, *+ 
+noff
+);
+
+464 
+g
+ = 
+	`ohs
+(
+
+->tag);
+
+465 
+n
+ = 
+	`ohs
+(
+
+->len);
+
+466 i(
+off
+ + 
+n
+ + (*
+
+> 
+m
+->
+m_pkthdr
+.len) {
+
+467 
+	`tf
+("pppoe:ag 0x%xen 0x%x isooong\n",
+
+468 
+g
+, 
+n
+);
+
+469 
+de
+;
+
+471 
+g
+) {
+
+472 
+PPPOE_TAG_EOL
+:
+
+473 
+bakbak
+;
+
+474 
+PPPOE_TAG_SNAME
+:
+
+476 
+PPPOE_TAG_ACNAME
+:
+
+477 
+r
+ = 
+NULL
+;
+
+478 i(
+sc
+ !
+NULL
+ && 
+n
+ > 0) {
+
+479 
+r
+ = 
+	`mloc
+(
+n
++1, 
+M_TEMP
+, 
+M_NOWAIT
+);
+
+480 i(
+r
+) {
+
+481 
+n
+ = 
+	`m_pudown
+(
+m
+, 
+off
+ + (*
+
+),
+
+482 
+n
+, &
+noff
+);
+
+483 i(
+n
+) {
+
+484 
+	`y
+(
+r
+,
+
+485 
+	`mtod
+(
+n
+, *+ 
+noff
+,
+
+486 
+n
+);
+
+487 
+r
+[
+n
+] = '\0';
+
+489 
+	`tf
+("%s: connectedo %s\n",
+
+490 
+devme
+, 
+r
+);
+
+491 
+	`
+(
+r
+, 
+M_TEMP
+);
+
+495 
+PPPOE_TAG_HUNIQUE
+:
+
+496 i(
+sc
+ !
+NULL
+)
+
+498 
+n
+ = 
+	`m_pudown
+(
+m
+, 
+off
+ + (*
+
+), 
+n
+, &
+noff
+);
+
+499 i(!
+n
+) {
+
+500 
+m
+ = 
+NULL
+;
+
+501 
+r_msg
+ = "TAG HUNIQUE ERROR";
+
+504 #ifde
+PPPOE_SERVER
+
+
+505 
+hunique
+ = 
+	`mtod
+(
+n
+, 
+ut8_t
+ *+ 
+noff
+;
+
+506 
+hunique_n
+ = 
+n
+;
+
+508 
+sc
+ = 
+	`p_fd_soc_by_hunique
+(
+	`mtod
+(
+n
+, *+ 
+noff
+,
+
+509 
+n
+, 
+m
+->
+m_pkthdr
+.
+rcvif
+);
+
+510 i(
+sc
+ !
+NULL
+)
+
+511 
+devme
+ = 
+sc
+->
+sc_
+.
+_if
+.
+if_xme
+;
+
+513 
+PPPOE_TAG_ACCOOKIE
+:
+
+514 i(
+ac_cook
+ =
+NULL
+) {
+
+515 
+n
+ = 
+	`m_pudown
+(
+m
+, 
+off
+ + (*
+
+), 
+n
+,
+
+516 &
+noff
+);
+
+517 i(!
+n
+) {
+
+518 
+r_msg
+ = "TAG ACCOOKIE ERROR";
+
+519 
+m
+ = 
+NULL
+;
+
+522 
+ac_cook
+ = 
+	`mtod
+(
+n
+, *+ 
+noff
+;
+
+523 
+ac_cook_n
+ = 
+n
+;
+
+526 
+PPPOE_TAG_RELAYSID
+:
+
+527 i(
+y_sid
+ =
+NULL
+) {
+
+528 
+n
+ = 
+	`m_pudown
+(
+m
+, 
+off
+ + (*
+
+), 
+n
+,
+
+529 &
+noff
+);
+
+530 i(!
+n
+) {
+
+531 
+r_msg
+ = "TAG RELAYSID ERROR";
+
+532 
+m
+ = 
+NULL
+;
+
+535 
+y_sid
+ = 
+	`mtod
+(
+n
+, *+ 
+noff
+;
+
+536 
+y_sid_n
+ = 
+n
+;
+
+539 
+PPPOE_TAG_SNAME_ERR
+:
+
+540 
+r_msg
+ = "SERVICE NAME ERROR";
+
+541 
+rg
+ = 1;
+
+543 
+PPPOE_TAG_ACSYS_ERR
+:
+
+544 
+r_msg
+ = "AC SYSTEM ERROR";
+
+545 
+rg
+ = 1;
+
+547 
+PPPOE_TAG_GENERIC_ERR
+:
+
+548 
+r_msg
+ = "GENERIC ERROR";
+
+549 
+rg
+ = 1;
+
+552 i(
+r_msg
+) {
+
+553 
+r
+ = 
+NULL
+;
+
+554 i(
+rg
+ && 
+n
+) {
+
+555 
+r
+ = 
+	`mloc
+(
+n
++1, 
+M_TEMP
+, 
+M_NOWAIT
+);
+
+556 
+n
+ = 
+	`m_pudown
+(
+m
+, 
+off
+ + (*
+
+), 
+n
+,
+
+557 &
+noff
+);
+
+558 i(
+n
+ && 
+r
+) {
+
+559 
+	`y
+(
+r
+,
+
+560 
+	`mtod
+(
+n
+, *+ 
+noff
+, 
+n
+);
+
+561 
+r
+[
+n
+] = '\0';
+
+564 i(
+r
+) {
+
+565 
+	`tf
+("%s: %s: %s\n", 
+devme
+,
+
+566 
+r_msg
+, 
+r
+);
+
+567 
+	`
+(
+r
+, 
+M_TEMP
+);
+
+569 
+	`tf
+("%s: %s\n", 
+devme
+, 
+r_msg
+);
+
+570 i(
+rg
+ || 
+m
+ =
+NULL
+)
+
+571 
+de
+;
+
+573 
+off
+ +(*
+
++ 
+n
+;
+
+575 
+bakbak
+:;
+
+576 
+ph
+->
+code
+) {
+
+577 
+PPPOE_CODE_PADI
+:
+
+578 #ifde
+PPPOE_SERVER
+
+
+583 i(
+	`LIST_EMPTY
+(&
+p_soc_li
+))
+
+584 
+de
+;
+
+585 
+	`LIST_FOREACH
+(
+sc
+, &
+p_soc_li
+, 
+sc_li
+) {
+
+586 i(!(
+sc
+->
+sc_
+.
+_if
+.
+if_ags
+ & 
+IFF_UP
+))
+
+588 i(!(
+sc
+->
+sc_
+.
+_if
+.
+if_ags
+ & 
+IFF_PASSIVE
+))
+
+590 i(
+sc
+->
+sc_e
+ =
+PPPOE_STATE_INITIAL
+)
+
+593 i(
+sc
+ =
+NULL
+) {
+
+595 
+de
+;
+
+597 i(
+hunique
+) {
+
+598 i(
+sc
+->
+sc_hunique
+)
+
+599 
+	`
+(
+sc
+->
+sc_hunique
+, 
+M_DEVBUF
+);
+
+600 
+sc
+->
+sc_hunique
+ = 
+	`mloc
+(
+hunique_n
+, 
+M_DEVBUF
+,
+
+601 
+M_DONTWAIT
+);
+
+602 i(
+sc
+->
+sc_hunique
+ =
+NULL
+)
+
+603 
+de
+;
+
+604 
+sc
+->
+sc_hunique_n
+ = 
+hunique_n
+;
+
+605 
+	`memy
+(
+sc
+->
+sc_hunique
+, 
+hunique
+, 
+hunique_n
+);
+
+607 
+	`memy
+(&
+sc
+->
+sc_de
+, 
+eh
+->
+h_sho
+,  sc->sc_dest);
+
+608 
+sc
+->
+sc_e
+ = 
+PPPOE_STATE_PADO_SENT
+;
+
+609 
+	`p_nd_do
+(
+sc
+);
+
+612 
+PPPOE_CODE_PADR
+:
+
+613 #ifde
+PPPOE_SERVER
+
+
+617 i(
+ac_cook
+ =
+NULL
+) {
+
+619 
+	`tf
+("pppoe:eceived PADR butot includesc_cookie\n");
+
+620 
+de
+;
+
+622 
+sc
+ = 
+	`p_fd_soc_by_hunique
+(
+ac_cook
+,
+
+623 
+ac_cook_n
+,
+
+624 
+m
+->
+m_pkthdr
+.
+rcvif
+);
+
+625 i(
+sc
+ =
+NULL
+) {
+
+627 i(!
+	`LIST_EMPTY
+(&
+p_soc_li
+))
+
+628 
+	`tf
+("pppoe:eceived PADR but couldot findequest for it\n");
+
+629 
+de
+;
+
+631 i(
+sc
+->
+sc_e
+ !
+PPPOE_STATE_PADO_SENT
+) {
+
+632 
+	`tf
+("%s:eceived unexpected PADR\n",
+
+633 
+sc
+->
+sc_
+.
+_if
+.
+if_xme
+);
+
+634 
+de
+;
+
+636 i(
+hunique
+) {
+
+637 i(
+sc
+->
+sc_hunique
+)
+
+638 
+	`
+(
+sc
+->
+sc_hunique
+, 
+M_DEVBUF
+);
+
+639 
+sc
+->
+sc_hunique
+ = 
+	`mloc
+(
+hunique_n
+, 
+M_DEVBUF
+,
+
+640 
+M_DONTWAIT
+);
+
+641 i(
+sc
+->
+sc_hunique
+ =
+NULL
+)
+
+642 
+de
+;
+
+643 
+sc
+->
+sc_hunique_n
+ = 
+hunique_n
+;
+
+644 
+	`memy
+(
+sc
+->
+sc_hunique
+, 
+hunique
+, 
+hunique_n
+);
+
+646 
+	`p_nd_ds
+(
+sc
+);
+
+647 
+sc
+->
+sc_e
+ = 
+PPPOE_STATE_SESSION
+;
+
+648 
+sc
+->
+sc_
+.
+	`_up
+(&sc->sc_sppp);
+
+652 
+de
+;
+
+654 
+PPPOE_CODE_PADO
+:
+
+655 i(
+sc
+ =
+NULL
+) {
+
+657 i(!
+	`LIST_EMPTY
+(&
+p_soc_li
+))
+
+658 
+	`tf
+("pppoe:eceived PADO but couldot findequest for it\n");
+
+659 
+de
+;
+
+661 i(
+sc
+->
+sc_e
+ !
+PPPOE_STATE_PADI_SENT
+) {
+
+662 
+	`tf
+("%s:eceived unexpected PADO\n",
+
+663 
+sc
+->
+sc_
+.
+_if
+.
+if_xme
+);
+
+664 
+de
+;
+
+666 i(
+ac_cook
+) {
+
+667 i(
+sc
+->
+sc_ac_cook
+)
+
+668 
+	`
+(
+sc
+->
+sc_ac_cook
+, 
+M_DEVBUF
+);
+
+669 
+sc
+->
+sc_ac_cook
+ = 
+	`mloc
+(
+ac_cook_n
+, 
+M_DEVBUF
+,
+
+670 
+M_DONTWAIT
+);
+
+671 i(
+sc
+->
+sc_ac_cook
+ =
+NULL
+) {
+
+672 
+	`tf
+("%s: FATAL: couldotllocate memory "
+
+674 
+sc
+->
+sc_
+.
+_if
+.
+if_xme
+);
+
+675 
+de
+;
+
+677 
+sc
+->
+sc_ac_cook_n
+ = 
+ac_cook_n
+;
+
+678 
+	`memy
+(
+sc
+->
+sc_ac_cook
+, 
+ac_cook
+, 
+ac_cook_n
+);
+
+680 i(
+y_sid
+) {
+
+681 i(
+sc
+->
+sc_y_sid
+)
+
+682 
+	`
+(
+sc
+->
+sc_y_sid
+, 
+M_DEVBUF
+);
+
+683 
+sc
+->
+sc_y_sid
+ = 
+	`mloc
+(
+y_sid_n
+, 
+M_DEVBUF
+,
+
+684 
+M_DONTWAIT
+);
+
+685 i(
+sc
+->
+sc_y_sid
+ =
+NULL
+) {
+
+686 
+	`tf
+("%s: FATAL: couldotllocate memory "
+
+688 
+sc
+->
+sc_
+.
+_if
+.
+if_xme
+);
+
+689 
+de
+;
+
+691 
+sc
+->
+sc_y_sid_n
+ = 
+y_sid_n
+;
+
+692 
+	`memy
+(
+sc
+->
+sc_y_sid
+, 
+y_sid
+, 
+y_sid_n
+);
+
+694 
+	`memy
+(&
+sc
+->
+sc_de
+, 
+eh
+->
+h_sho
+,  sc->sc_dest);
+
+695 
+	`out_
+(&
+sc
+->
+sc_timeout
+);
+
+696 
+sc
+->
+sc_dr_d
+ = 0;
+
+697 
+sc
+->
+sc_e
+ = 
+PPPOE_STATE_PADR_SENT
+;
+
+698 i((
+r
+ = 
+	`p_nd_dr
+(
+sc
+)) != 0) {
+
+699 i(
+sc
+->
+sc_
+.
+_if
+.
+if_ags
+ & 
+IFF_DEBUG
+)
+
+700 
+	`tf
+("%s: failedo send PADR, "
+
+701 "r=%d\n", 
+sc
+->
+sc_
+.
+_if
+.
+if_xme
+,
+
+702 
+r
+);
+
+704 
+	`out_t
+(&
+sc
+->
+sc_timeout
+,
+
+705 
+PPPOE_DISC_TIMEOUT
+ * (1 + 
+sc
+->
+sc_dr_d
+),
+
+706 
+p_timeout
+, 
+sc
+);
+
+708 
+PPPOE_CODE_PADS
+:
+
+709 i(
+sc
+ =
+NULL
+)
+
+710 
+de
+;
+
+711 
+sc
+->
+sc_ssi
+ = 
+ssi
+;
+
+712 
+	`out_
+(&
+sc
+->
+sc_timeout
+);
+
+713 i(
+sc
+->
+sc_
+.
+_if
+.
+if_ags
+ & 
+IFF_DEBUG
+)
+
+714 
+	`tf
+("%s: session 0x%x connected\n",
+
+715 
+sc
+->
+sc_
+.
+_if
+.
+if_xme
+, 
+ssi
+);
+
+716 
+sc
+->
+sc_e
+ = 
+PPPOE_STATE_SESSION
+;
+
+717 
+sc
+->
+sc_
+.
+	`_up
+(&sc->sc_sppp);
+
+719 
+PPPOE_CODE_PADT
+:
+
+720 
+sc
+ = 
+	`p_fd_soc_by_ssi
+(
+ssi
+, 
+m
+->
+m_pkthdr
+.
+rcvif
+);
+
+721 i(
+sc
+ =
+NULL
+)
+
+722 
+de
+;
+
+723 
+	`p_r_soc
+(
+sc
+, "received PADT");
+
+726 
+	`tf
+("%s: unknown code (0x%04x) session = 0x%04x\n",
+
+727 
+sc
+? sc->
+sc_
+.
+_if
+.
+if_xme
+ : "pppoe",
+
+728 
+ph
+->
+code
+, 
+ssi
+);
+
+732 
+de
+:
+
+733 i(
+m
+)
+
+734 
+	`m_m
+(
+m
+);
+
+736 
+	}
+}
+
+739 
+	$p_disc_put
+(
+mbuf
+ *
+m
+)
+
+743 i(!
+	`LIST_EMPTY
+(&
+p_soc_li
+)) {
+
+744 
+	`KASSERT
+(
+m
+->
+m_ags
+ & 
+M_PKTHDR
+);
+
+745 
+	`p_dich_disc_pkt
+(
+m
+, 0);
+
+747 
+	`m_m
+(
+m
+);
+
+748 
+	}
+}
+
+751 
+	$p_da_put
+(
+mbuf
+ *
+m
+)
+
+753 
+ut16_t
+ 
+ssi
+, 
+
+;
+
+754 
+p_soc
+ *
+sc
+;
+
+755 
+phdr
+ *
+ph
+;
+
+756 #ifde
+PPPOE_TERM_UNKNOWN_SESSIONS
+
+
+757 
+ut8_t
+ 
+sho
+[
+ETHER_ADDR_LEN
+];
+
+760 
+	`KASSERT
+(
+m
+->
+m_ags
+ & 
+M_PKTHDR
+);
+
+762 #ifde
+PPPOE_TERM_UNKNOWN_SESSIONS
+
+
+763 
+	`memy
+(
+sho
+, 
+	`mtod
+(
+m
+, 
+h_hd
+*)->
+h_sho
+, 
+ETHER_ADDR_LEN
+);
+
+765 
+	`m_adj
+(
+m
+, (
+h_hd
+));
+
+766 i(
+m
+->
+m_pkthdr
+.
+n
+ <
+PPPOE_HEADERLEN
+) {
+
+767 
+	`tf
+("pppoe (data): droppingoo shortacket: %d bytes\n",
+
+768 
+m
+->
+m_pkthdr
+.
+n
+);
+
+769 
+dr
+;
+
+772 i(
+m
+->
+m_n
+ < (*
+ph
+)) {
+
+773 
+m
+ = 
+	`m_puup
+(m, (*
+ph
+));
+
+774 i(!
+m
+) {
+
+775 
+	`tf
+("pppoe: couldot get PPPoE header\n");
+
+779 
+ph
+ = 
+	`mtod
+(
+m
+, 
+phdr
+ *);
+
+781 i(
+ph
+->
+vty
+ !
+PPPOE_VERTYPE
+) {
+
+782 
+	`tf
+("pppoe (data): unknown version/typeacket: 0x%x\n",
+
+783 
+ph
+->
+vty
+);
+
+784 
+dr
+;
+
+786 i(
+ph
+->
+code
+ != 0)
+
+787 
+dr
+;
+
+789 
+ssi
+ = 
+	`ohs
+(
+ph
+->session);
+
+790 
+sc
+ = 
+	`p_fd_soc_by_ssi
+(
+ssi
+, 
+m
+->
+m_pkthdr
+.
+rcvif
+);
+
+791 i(
+sc
+ =
+NULL
+) {
+
+792 #ifde
+PPPOE_TERM_UNKNOWN_SESSIONS
+
+
+793 
+	`tf
+("pppoe: input for unknown session 0x%x, sending PADT\n",
+
+794 
+ssi
+);
+
+795 
+	`p_nd_dt
+(
+m
+->
+m_pkthdr
+.
+rcvif
+, 
+ssi
+, 
+sho
+);
+
+797 
+dr
+;
+
+800 
+
+ = 
+	`ohs
+(
+ph
+->plen);
+
+802 
+	`bpf_mp
+(&
+sc
+->
+sc_
+.
+_if
+, 
+m
+);
+
+804 
+	`m_adj
+(
+m
+, 
+PPPOE_HEADERLEN
+);
+
+806 #ifde
+PPPOE_DEBUG
+
+
+808 
+mbuf
+ *
+p
+;
+
+810 
+	`tf
+("%s:kthdr.len=%d,ppoe.len=%d",
+
+811 
+sc
+->
+sc_
+.
+_if
+.
+if_xme
+,
+
+812 
+m
+->
+m_pkthdr
+.
+n
+, 
+
+);
+
+813 
+p
+ = 
+m
+;
+
+814 
+p
+) {
+
+815 
+	`tf
+("=%d", 
+p
+->
+m_n
+);
+
+816 
+p
+ =->
+m_xt
+;
+
+818 
+	`tf
+("\n");
+
+822 i(
+m
+->
+m_pkthdr
+.
+n
+ < 
+
+)
+
+823 
+dr
+;
+
+826 
+m
+->
+m_pkthdr
+.
+rcvif
+ = &
+sc
+->
+sc_
+.
+_if
+;
+
+829 
+sc
+->
+sc_
+.
+_if
+.
+if_acks
+++;
+
+830 
+	`_put
+(&
+sc
+->
+sc_
+.
+_if
+, 
+m
+);
+
+833 
+dr
+:
+
+834 
+	`m_m
+(
+m
+);
+
+835 
+	}
+}
+
+838 
+	$p_ouut
+(
+p_soc
+ *
+sc
+, 
+mbuf
+ *
+m
+)
+
+840 
+sockaddr
+ 
+d
+;
+
+841 
+h_hd
+ *
+eh
+;
+
+842 
+ut16_t
+ 
+y
+;
+
+844 i(
+sc
+->
+sc_h_if
+ =
+NULL
+) {
+
+845 
+	`m_m
+(
+m
+);
+
+846  
+EIO
+;
+
+849 
+	`memt
+(&
+d
+, 0,  dst);
+
+850 
+d
+.
+_my
+ = 
+AF_UNSPEC
+;
+
+851 
+eh
+ = (
+h_hd
+*)&
+d
+.
+_da
+;
+
+852 
+y
+ = 
+sc
+->
+sc_e
+ =
+PPPOE_STATE_SESSION
+ ? 
+ETHERTYPE_PPPOE
+ : 
+ETHERTYPE_PPPOEDISC
+;
+
+853 
+eh
+->
+h_ty
+ = 
+	`hts
+(
+y
+);
+
+854 
+	`memy
+(&
+eh
+->
+h_dho
+, &
+sc
+->
+sc_de
+,  sc->sc_dest);
+
+856 #ifde
+PPPOE_DEBUG
+
+
+857 
+	`tf
+("%s (%x) state=%d, session=0x%x output -> %s,en=%d\n",
+
+858 
+sc
+->
+sc_
+.
+_if
+.
+if_xme
+, 
+y
+,
+
+859 
+sc
+->
+sc_e
+, sc->
+sc_ssi
+,
+
+860 
+	`h_rtf
+((c *)&
+sc
+->
+sc_de
+), 
+m
+->
+m_pkthdr
+.
+n
+);
+
+863 
+m
+->
+m_ags
+ &~(
+M_BCAST
+|
+M_MCAST
+);
+
+864 
+sc
+->
+sc_
+.
+_if
+.
+if_acks
+++;
+
+865  
+sc
+->
+sc_h_if
+->
+	`if_ouut
+(sc->sc_h_if, 
+m
+, &
+d
+, 
+NULL
+);
+
+866 
+	}
+}
+
+869 
+	$p_iol
+(
+i
+ *
+i
+, 
+cmd
+, *
+da
+)
+
+871 
+lwp
+ *
+l
+ = 
+cuwp
+;
+
+872 
+p_soc
+ *
+sc
+ = (p_soc*)
+i
+;
+
+873 
+ieq
+ *
+i
+ = 
+da
+;
+
+874 
+r
+ = 0;
+
+876 
+cmd
+) {
+
+877 
+PPPOESETPARMS
+:
+
+879 
+pdisms
+ *
+rms
+ = (pdisms*)
+da
+;
+
+880 i(
+	`kauth_authize_twk
+(
+l
+->
+l_ed
+, 
+KAUTH_NETWORK_INTERFACE
+,
+
+881 
+KAUTH_REQ_NETWORK_INTERFACE_SETPRIV
+, 
+i
+, (*)
+cmd
+,
+
+882 
+NULL
+) != 0)
+
+883  (
+EPERM
+);
+
+884 i(
+rms
+->
+h_iame
+[0] != 0) {
+
+885 
+i
+ *
+h_if
+;
+
+887 
+h_if
+ = 
+	`ifun
+(
+rms
+->
+h_iame
+);
+
+888 i(
+h_if
+ =
+NULL
+ ||th_if->
+if_d
+ !
+DLT_EN10MB
+) {
+
+889 
+sc
+->
+sc_h_if
+ = 
+NULL
+;
+
+890  
+ENXIO
+;
+
+893 i(
+sc
+->
+sc_
+.
+_if
+.
+if_mtu
+ !=
+
+894 
+h_if
+->
+if_mtu
+ - 
+PPPOE_OVERHEAD
+) {
+
+895 
+sc
+->
+sc_
+.
+_if
+.
+if_mtu
+ = 
+h_if
+->if_mtu -
+
+896 
+PPPOE_OVERHEAD
+;
+
+898 
+sc
+->
+sc_h_if
+ = 
+h_if
+;
+
+900 i(
+rms
+->
+ac_me
+ !
+NULL
+) {
+
+901 
+size_t
+ 
+s
+;
+
+902 *
+b
+ = 
+	`mloc
+(
+rms
+->
+ac_me_n
+ + 1, 
+M_DEVBUF
+,
+
+903 
+M_WAITOK
+);
+
+904 i(
+b
+ =
+NULL
+)
+
+905  
+ENOMEM
+;
+
+906 
+r
+ = 
+	`cyr
+(
+rms
+->
+ac_me
+, 
+b
+,
+
+907 
+rms
+->
+ac_me_n
++1, &
+s
+);
+
+908 i(
+r
+ != 0) {
+
+909 
+	`
+(
+b
+, 
+M_DEVBUF
+);
+
+910  
+r
+;
+
+912 i(
+s
+ !
+rms
+->
+ac_me_n
++1) {
+
+913 
+	`
+(
+b
+, 
+M_DEVBUF
+);
+
+914  
+EINVAL
+;
+
+916 i(
+sc
+->
+sc_ct_me
+)
+
+917 
+	`
+(
+sc
+->
+sc_ct_me
+, 
+M_DEVBUF
+);
+
+918 
+sc
+->
+sc_ct_me
+ = 
+b
+;
+
+920 i(
+rms
+->
+rvi_me
+ !
+NULL
+) {
+
+921 
+size_t
+ 
+s
+;
+
+922 *
+b
+ = 
+	`mloc
+(
+rms
+->
+rvi_me_n
+ + 1, 
+M_DEVBUF
+,
+
+923 
+M_WAITOK
+);
+
+924 i(
+b
+ =
+NULL
+)
+
+925  
+ENOMEM
+;
+
+926 
+r
+ = 
+	`cyr
+(
+rms
+->
+rvi_me
+, 
+b
+,
+
+927 
+rms
+->
+rvi_me_n
++1, &
+s
+);
+
+928 i(
+r
+ != 0) {
+
+929 
+	`
+(
+b
+, 
+M_DEVBUF
+);
+
+930  
+r
+;
+
+932 i(
+s
+ !
+rms
+->
+rvi_me_n
++1) {
+
+933 
+	`
+(
+b
+, 
+M_DEVBUF
+);
+
+934  
+EINVAL
+;
+
+936 i(
+sc
+->
+sc_rvi_me
+)
+
+937 
+	`
+(
+sc
+->
+sc_rvi_me
+, 
+M_DEVBUF
+);
+
+938 
+sc
+->
+sc_rvi_me
+ = 
+b
+;
+
+943 
+PPPOEGETPARMS
+:
+
+945 
+pdisms
+ *
+rms
+ = (pdisms*)
+da
+;
+
+946 
+	`memt
+(
+rms
+, 0,  *parms);
+
+947 i(
+sc
+->
+sc_h_if
+)
+
+948 
+	`y
+(
+rms
+->
+iame
+, 
+sc
+->
+sc_h_if
+->
+if_xme
+, 
+IFNAMSIZ
+);
+
+952 
+PPPOEGETSESSION
+:
+
+954 
+pcie
+ *
+e
+ = (pcie*)
+da
+;
+
+955 
+e
+->
+sc
+->
+sc_e
+;
+
+956 
+e
+->
+ssi_id
+ = 
+sc
+->
+sc_ssi
+;
+
+957 
+e
+->
+di_y_no
+ = 
+sc
+->
+sc_di_d
+;
+
+958 
+e
+->
+dr_y_no
+ = 
+sc
+->
+sc_dr_d
+;
+
+962 
+SIOCSIFFLAGS
+:
+
+967 i((
+i
+->
+i_ags
+ & 
+IFF_UP
+) == 0
+
+968 && 
+sc
+->
+sc_e
+ >
+PPPOE_STATE_PADI_SENT
+
+
+969 && 
+sc
+->
+sc_e
+ < 
+PPPOE_STATE_SESSION
+) {
+
+970 
+	`out_
+(&
+sc
+->
+sc_timeout
+);
+
+971 
+sc
+->
+sc_e
+ = 
+PPPOE_STATE_INITIAL
+;
+
+972 
+sc
+->
+sc_di_d
+ = 0;
+
+973 
+sc
+->
+sc_dr_d
+ = 0;
+
+974 
+	`memy
+(&
+sc
+->
+sc_de
+, 
+hbrdaddr
+,
+
+975 (
+sc
+->
+sc_de
+));
+
+977  
+	`_iol
+(
+i
+, 
+cmd
+, 
+da
+);
+
+978 
+SIOCSIFMTU
+:
+
+979 i(
+i
+->
+i_mtu
+ > (
+sc
+->
+sc_h_if
+ =
+NULL
+ ?
+
+980 
+PPPOE_MAXMTU
+ : (
+sc
+->
+sc_h_if
+->
+if_mtu
+ - 
+PPPOE_OVERHEAD
+))) {
+
+981  
+EINVAL
+;
+
+985  
+	`_iol
+(
+i
+, 
+cmd
+, 
+da
+);
+
+988 
+	}
+}
+
+995 
+mbuf
+ *
+
+996 
+	$p_g_mbuf
+(
+size_t
+ 
+n
+)
+
+998 
+mbuf
+ *
+m
+;
+
+1000 
+	`MGETHDR
+(
+m
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+1001 i(
+m
+ =
+NULL
+)
+
+1002  
+NULL
+;
+
+1003 i(
+n
+ + (
+h_hd
+> 
+MHLEN
+) {
+
+1004 
+	`MCLGET
+(
+m
+, 
+M_DONTWAIT
+);
+
+1005 i((
+m
+->
+m_ags
+ & 
+M_EXT
+) == 0) {
+
+1006 
+	`m_
+(
+m
+);
+
+1007  
+NULL
+;
+
+1010 
+m
+->
+m_da
+ +(
+h_hd
+);
+
+1011 
+m
+->
+m_n
+ = 
+n
+;
+
+1012 
+m
+->
+m_pkthdr
+.
+n
+ =en;
+
+1013 
+m
+->
+m_pkthdr
+.
+rcvif
+ = 
+NULL
+;
+
+1015  
+m
+;
+
+1016 
+	}
+}
+
+1019 
+	$p_nd_di
+(
+p_soc
+ *
+sc
+)
+
+1021 
+mbuf
+ *
+m0
+;
+
+1022 
+n
+, 
+l1
+ = 0, 
+l2
+ = 0;
+
+1023 
+ut8_t
+ *
+p
+;
+
+1025 i(
+sc
+->
+sc_e
+ >
+PPPOE_STATE_PADI_SENT
+)
+
+1026 
+	`nic
+("p_nd_d s %d", 
+sc
+->
+sc_e
+);
+
+1029 
+n
+ = 2 + 2 + 2 + 2 +  
+sc
+;
+
+1030 i(
+sc
+->
+sc_rvi_me
+ !
+NULL
+) {
+
+1031 
+l1
+ = 
+	`
+(
+sc
+->
+sc_rvi_me
+);
+
+1032 
+n
+ +
+l1
+;
+
+1034 i(
+sc
+->
+sc_ct_me
+ !
+NULL
+) {
+
+1035 
+l2
+ = 
+	`
+(
+sc
+->
+sc_ct_me
+);
+
+1036 
+n
+ +2 + 2 + 
+l2
+;
+
+1038 i(
+sc
+->
+sc_
+.
+_if
+.
+if_mtu
+ > 
+PPPOE_MAXMTU
+) {
+
+1039 
+n
+ += 2 + 2 + 2;
+
+1043 
+m0
+ = 
+	`p_g_mbuf
+(
+n
+ + 
+PPPOE_HEADERLEN
+);
+
+1044 i(!
+m0
+)
+
+1045  
+ENOBUFS
+;
+
+1048 
+p
+ = 
+	`mtod
+(
+m0
+, 
+ut8_t
+ *);
+
+1049 
+	`PPPOE_ADD_HEADER
+(
+p
+, 
+PPPOE_CODE_PADI
+, 0, 
+n
+);
+
+1050 
+	`PPPOE_ADD_16
+(
+p
+, 
+PPPOE_TAG_SNAME
+);
+
+1051 i(
+sc
+->
+sc_rvi_me
+ !
+NULL
+) {
+
+1052 
+	`PPPOE_ADD_16
+(
+p
+, 
+l1
+);
+
+1053 
+	`memy
+(
+p
+, 
+sc
+->
+sc_rvi_me
+, 
+l1
+);
+
+1054 
+p
+ +
+l1
+;
+
+1056 
+	`PPPOE_ADD_16
+(
+p
+, 0);
+
+1058 i(
+sc
+->
+sc_ct_me
+ !
+NULL
+) {
+
+1059 
+	`PPPOE_ADD_16
+(
+p
+, 
+PPPOE_TAG_ACNAME
+);
+
+1060 
+	`PPPOE_ADD_16
+(
+p
+, 
+l2
+);
+
+1061 
+	`memy
+(
+p
+, 
+sc
+->
+sc_ct_me
+, 
+l2
+);
+
+1062 
+p
+ +
+l2
+;
+
+1064 
+	`PPPOE_ADD_16
+(
+p
+, 
+PPPOE_TAG_HUNIQUE
+);
+
+1065 
+	`PPPOE_ADD_16
+(
+p
+, (
+sc
+));
+
+1066 
+	`memy
+(
+p
+, &
+sc
+,  sc);
+
+1067 
+p
+ +(
+sc
+);
+
+1069 i(
+sc
+->
+sc_
+.
+_if
+.
+if_mtu
+ > 
+PPPOE_MAXMTU
+) {
+
+1070 
+	`PPPOE_ADD_16
+(
+p
+, 
+PPPOE_TAG_MAX_PAYLOAD
+);
+
+1071 
+	`PPPOE_ADD_16
+(
+p
+, 2);
+
+1072 
+	`PPPOE_ADD_16
+(
+p
+, (
+ut16_t
+)
+sc
+->
+sc_
+.
+_if
+.
+if_mtu
+);
+
+1075 #ifde
+PPPOE_DEBUG
+
+
+1076 
+p
+ + 
+sc
+;
+
+1077 i(
+p
+ - 
+	`mtod
+(
+m0
+, 
+ut8_t
+ *!
+n
+ + 
+PPPOE_HEADERLEN
+)
+
+1078 
+	`nic
+("pppoe_send_padi: garbled outputen, should be %ld, is %ld",
+
+1079 ()(
+n
+ + 
+PPPOE_HEADERLEN
+), ()(
+p
+ - 
+	`mtod
+(
+m0
+, 
+ut8_t
+ *)));
+
+1083  
+	`p_ouut
+(
+sc
+, 
+m0
+);
+
+1084 
+	}
+}
+
+1087 
+	$p_timeout
+(*
+g
+)
+
+1089 
+x
+, 
+y_wa
+, 
+r
+;
+
+1090 
+p_soc
+ *
+sc
+ = (p_soc*)
+g
+;
+
+1092 #ifde
+PPPOE_DEBUG
+
+
+1093 
+	`tf
+("%s:imeout\n", 
+sc
+->
+sc_
+.
+_if
+.
+if_xme
+);
+
+1096 
+sc
+->
+sc_e
+) {
+
+1097 
+PPPOE_STATE_INITIAL
+:
+
+1099 
+	`p_c
+(
+sc
+);
+
+1101 
+PPPOE_STATE_PADI_SENT
+:
+
+1113 
+y_wa
+ = 
+PPPOE_DISC_TIMEOUT
+ * (1 + 
+sc
+->
+sc_di_d
+);
+
+1115 
+x
+ = 
+	`
+();
+
+1116 
+sc
+->
+sc_di_d
+++;
+
+1117 i(
+sc
+->
+sc_di_d
+ >
+PPPOE_DISC_MAXPADI
+) {
+
+1118 i((
+sc
+->
+sc_
+.
+_if
+.
+if_ags
+ & 
+IFF_LINK1
+) == 0) {
+
+1120 
+y_wa
+ = 
+PPPOE_SLOW_RETRY
+;
+
+1122 
+	`p_abt_c
+(
+sc
+);
+
+1123 
+	`lx
+(
+x
+);
+
+1127 i((
+r
+ = 
+	`p_nd_di
+(
+sc
+)) != 0) {
+
+1128 
+sc
+->
+sc_di_d
+--;
+
+1129 i(
+sc
+->
+sc_
+.
+_if
+.
+if_ags
+ & 
+IFF_DEBUG
+)
+
+1130 
+	`tf
+("%s: failedoransmit PADI, "
+
+1132 
+sc
+->
+sc_
+.
+_if
+.
+if_xme
+, 
+r
+);
+
+1134 
+	`out_t
+(&
+sc
+->
+sc_timeout
+, 
+y_wa
+,
+
+1135 
+p_timeout
+, 
+sc
+);
+
+1136 
+	`lx
+(
+x
+);
+
+1139 
+PPPOE_STATE_PADR_SENT
+:
+
+1140 
+x
+ = 
+	`
+();
+
+1141 
+sc
+->
+sc_dr_d
+++;
+
+1142 i(
+sc
+->
+sc_dr_d
+ >
+PPPOE_DISC_MAXPADR
+) {
+
+1143 
+	`memy
+(&
+sc
+->
+sc_de
+, 
+hbrdaddr
+,
+
+1144 (
+sc
+->
+sc_de
+));
+
+1145 
+sc
+->
+sc_e
+ = 
+PPPOE_STATE_PADI_SENT
+;
+
+1146 
+sc
+->
+sc_dr_d
+ = 0;
+
+1147 i((
+r
+ = 
+	`p_nd_di
+(
+sc
+)) != 0) {
+
+1148 i(
+sc
+->
+sc_
+.
+_if
+.
+if_ags
+ & 
+IFF_DEBUG
+)
+
+1149 
+	`tf
+("%s: failedo send PADI"
+
+1151 
+sc
+->
+sc_
+.
+_if
+.
+if_xme
+,
+
+1152 
+r
+);
+
+1154 
+	`out_t
+(&
+sc
+->
+sc_timeout
+,
+
+1155 
+PPPOE_DISC_TIMEOUT
+ * (1 + 
+sc
+->
+sc_di_d
+),
+
+1156 
+p_timeout
+, 
+sc
+);
+
+1157 
+	`lx
+(
+x
+);
+
+1160 i((
+r
+ = 
+	`p_nd_dr
+(
+sc
+)) != 0) {
+
+1161 
+sc
+->
+sc_dr_d
+--;
+
+1162 i(
+sc
+->
+sc_
+.
+_if
+.
+if_ags
+ & 
+IFF_DEBUG
+)
+
+1163 
+	`tf
+("%s: failedo send PADR, "
+
+1164 "r=%d\n", 
+sc
+->
+sc_
+.
+_if
+.
+if_xme
+,
+
+1165 
+r
+);
+
+1167 
+	`out_t
+(&
+sc
+->
+sc_timeout
+,
+
+1168 
+PPPOE_DISC_TIMEOUT
+ * (1 + 
+sc
+->
+sc_dr_d
+),
+
+1169 
+p_timeout
+, 
+sc
+);
+
+1170 
+	`lx
+(
+x
+);
+
+1172 
+PPPOE_STATE_CLOSING
+:
+
+1173 
+	`p_disc
+(
+sc
+);
+
+1178 
+	}
+}
+
+1182 
+	$p_c
+(
+p_soc
+ *
+sc
+)
+
+1184 
+x
+, 
+r
+;
+
+1186 i(
+sc
+->
+sc_e
+ !
+PPPOE_STATE_INITIAL
+)
+
+1187  
+EBUSY
+;
+
+1189 #ifde
+PPPOE_SERVER
+
+
+1191 i((
+sc
+->
+sc_
+.
+_if
+.
+if_ags
+ & 
+IFF_PASSIVE
+))
+
+1194 
+x
+ = 
+	`
+();
+
+1196 
+sc
+->
+sc_e
+ = 
+PPPOE_STATE_PADI_SENT
+;
+
+1197 
+sc
+->
+sc_dr_d
+ = 0;
+
+1198 
+r
+ = 
+	`p_nd_di
+(
+sc
+);
+
+1199 i(
+r
+ !0 && 
+sc
+->
+sc_
+.
+_if
+.
+if_ags
+ & 
+IFF_DEBUG
+)
+
+1200 
+	`tf
+("%s: failedo send PADI,rror=%d\n",
+
+1201 
+sc
+->
+sc_
+.
+_if
+.
+if_xme
+, 
+r
+);
+
+1202 
+	`out_t
+(&
+sc
+->
+sc_timeout
+, 
+PPPOE_DISC_TIMEOUT
+, 
+p_timeout
+, sc);
+
+1203 
+	`lx
+(
+x
+);
+
+1204  
+r
+;
+
+1205 
+	}
+}
+
+1209 
+	$p_disc
+(
+p_soc
+ *
+sc
+)
+
+1211 
+r
+, 
+x
+;
+
+1213 
+x
+ = 
+	`
+();
+
+1215 i(
+sc
+->
+sc_e
+ < 
+PPPOE_STATE_SESSION
+)
+
+1216 
+r
+ = 
+EBUSY
+;
+
+1218 i(
+sc
+->
+sc_
+.
+_if
+.
+if_ags
+ & 
+IFF_DEBUG
+)
+
+1219 
+	`tf
+("%s: disconnecting\n",
+
+1220 
+sc
+->
+sc_
+.
+_if
+.
+if_xme
+);
+
+1221 
+r
+ = 
+	`p_nd_dt
+(
+sc
+->
+sc_h_if
+, sc->
+sc_ssi
+, (c 
+ut8_t
+ *)&sc->
+sc_de
+);
+
+1225 
+sc
+->
+sc_e
+ = 
+PPPOE_STATE_INITIAL
+;
+
+1226 
+	`memy
+(&
+sc
+->
+sc_de
+, 
+hbrdaddr
+, (sc->sc_dest));
+
+1227 i(
+sc
+->
+sc_ac_cook
+) {
+
+1228 
+	`
+(
+sc
+->
+sc_ac_cook
+, 
+M_DEVBUF
+);
+
+1229 
+sc
+->
+sc_ac_cook
+ = 
+NULL
+;
+
+1231 
+sc
+->
+sc_ac_cook_n
+ = 0;
+
+1232 i(
+sc
+->
+sc_y_sid
+) {
+
+1233 
+	`
+(
+sc
+->
+sc_y_sid
+, 
+M_DEVBUF
+);
+
+1234 
+sc
+->
+sc_y_sid
+ = 
+NULL
+;
+
+1236 
+sc
+->
+sc_y_sid_n
+ = 0;
+
+1237 #ifde
+PPPOE_SERVER
+
+
+1238 i(
+sc
+->
+sc_hunique
+) {
+
+1239 
+	`
+(
+sc
+->
+sc_hunique
+, 
+M_DEVBUF
+);
+
+1240 
+sc
+->
+sc_hunique
+ = 
+NULL
+;
+
+1242 
+sc
+->
+sc_hunique_n
+ = 0;
+
+1244 
+sc
+->
+sc_ssi
+ = 0;
+
+1247 
+sc
+->
+sc_
+.
+	`_down
+(&sc->sc_sppp);
+
+1249 
+	`lx
+(
+x
+);
+
+1251  
+r
+;
+
+1252 
+	}
+}
+
+1256 
+	$p_abt_c
+(
+p_soc
+ *
+sc
+)
+
+1258 
+	`tf
+("%s: couldotstablish connection\n",
+
+1259 
+sc
+->
+sc_
+.
+_if
+.
+if_xme
+);
+
+1260 
+sc
+->
+sc_e
+ = 
+PPPOE_STATE_CLOSING
+;
+
+1263 
+sc
+->
+sc_
+.
+	`_down
+(&sc->sc_sppp);
+
+1266 
+	`memy
+(&
+sc
+->
+sc_de
+, 
+hbrdaddr
+, (sc->sc_dest));
+
+1267 
+sc
+->
+sc_e
+ = 
+PPPOE_STATE_INITIAL
+;
+
+1268 
+	}
+}
+
+1272 
+	$p_nd_dr
+(
+p_soc
+ *
+sc
+)
+
+1274 
+mbuf
+ *
+m0
+;
+
+1275 
+ut8_t
+ *
+p
+;
+
+1276 
+size_t
+ 
+n
+, 
+l1
+ = 0;
+
+1278 i(
+sc
+->
+sc_e
+ !
+PPPOE_STATE_PADR_SENT
+)
+
+1279  
+EIO
+;
+
+1281 
+n
+ = 2 + 2 + 2 + 2 + (
+sc
+);
+
+1282 i(
+sc
+->
+sc_rvi_me
+ !
+NULL
+) {
+
+1283 
+l1
+ = 
+	`
+(
+sc
+->
+sc_rvi_me
+);
+
+1284 
+n
+ +
+l1
+;
+
+1286 i(
+sc
+->
+sc_ac_cook_n
+ > 0)
+
+1287 
+n
+ +2 + 2 + 
+sc
+->
+sc_ac_cook_n
+;
+
+1288 i(
+sc
+->
+sc_y_sid_n
+ > 0)
+
+1289 
+n
+ +2 + 2 + 
+sc
+->
+sc_y_sid_n
+;
+
+1290 i(
+sc
+->
+sc_
+.
+_if
+.
+if_mtu
+ > 
+PPPOE_MAXMTU
+) {
+
+1291 
+n
+ += 2 + 2 + 2;
+
+1293 
+m0
+ = 
+	`p_g_mbuf
+(
+n
+ + 
+PPPOE_HEADERLEN
+);
+
+1294 i(!
+m0
+)
+
+1295  
+ENOBUFS
+;
+
+1296 
+p
+ = 
+	`mtod
+(
+m0
+, 
+ut8_t
+ *);
+
+1297 
+	`PPPOE_ADD_HEADER
+(
+p
+, 
+PPPOE_CODE_PADR
+, 0, 
+n
+);
+
+1298 
+	`PPPOE_ADD_16
+(
+p
+, 
+PPPOE_TAG_SNAME
+);
+
+1299 i(
+sc
+->
+sc_rvi_me
+ !
+NULL
+) {
+
+1300 
+	`PPPOE_ADD_16
+(
+p
+, 
+l1
+);
+
+1301 
+	`memy
+(
+p
+, 
+sc
+->
+sc_rvi_me
+, 
+l1
+);
+
+1302 
+p
+ +
+l1
+;
+
+1304 
+	`PPPOE_ADD_16
+(
+p
+, 0);
+
+1306 i(
+sc
+->
+sc_ac_cook_n
+ > 0) {
+
+1307 
+	`PPPOE_ADD_16
+(
+p
+, 
+PPPOE_TAG_ACCOOKIE
+);
+
+1308 
+	`PPPOE_ADD_16
+(
+p
+, 
+sc
+->
+sc_ac_cook_n
+);
+
+1309 
+	`memy
+(
+p
+, 
+sc
+->
+sc_ac_cook
+, sc->
+sc_ac_cook_n
+);
+
+1310 
+p
+ +
+sc
+->
+sc_ac_cook_n
+;
+
+1312 i(
+sc
+->
+sc_y_sid_n
+ > 0) {
+
+1313 
+	`PPPOE_ADD_16
+(
+p
+, 
+PPPOE_TAG_RELAYSID
+);
+
+1314 
+	`PPPOE_ADD_16
+(
+p
+, 
+sc
+->
+sc_y_sid_n
+);
+
+1315 
+	`memy
+(
+p
+, 
+sc
+->
+sc_y_sid
+, sc->
+sc_y_sid_n
+);
+
+1316 
+p
+ +
+sc
+->
+sc_y_sid_n
+;
+
+1318 
+	`PPPOE_ADD_16
+(
+p
+, 
+PPPOE_TAG_HUNIQUE
+);
+
+1319 
+	`PPPOE_ADD_16
+(
+p
+, (
+sc
+));
+
+1320 
+	`memy
+(
+p
+, &
+sc
+,  sc);
+
+1321 
+p
+ +(
+sc
+);
+
+1323 i(
+sc
+->
+sc_
+.
+_if
+.
+if_mtu
+ > 
+PPPOE_MAXMTU
+) {
+
+1324 
+	`PPPOE_ADD_16
+(
+p
+, 
+PPPOE_TAG_MAX_PAYLOAD
+);
+
+1325 
+	`PPPOE_ADD_16
+(
+p
+, 2);
+
+1326 
+	`PPPOE_ADD_16
+(
+p
+, (
+ut16_t
+)
+sc
+->
+sc_
+.
+_if
+.
+if_mtu
+);
+
+1329 #ifde
+PPPOE_DEBUG
+
+
+1330 
+p
+ + 
+sc
+;
+
+1331 i(
+p
+ - 
+	`mtod
+(
+m0
+, 
+ut8_t
+ *!
+n
+ + 
+PPPOE_HEADERLEN
+)
+
+1332 
+	`nic
+("pppoe_send_padr: garbled outputen, should be %ld, is %ld",
+
+1333 ()(
+n
+ + 
+PPPOE_HEADERLEN
+), ()(
+p
+ - 
+	`mtod
+(
+m0
+, 
+ut8_t
+ *)));
+
+1336  
+	`p_ouut
+(
+sc
+, 
+m0
+);
+
+1337 
+	}
+}
+
+1341 
+	$p_nd_dt
+(
+i
+ *
+outgog_if
+, 
+u_t
+ 
+ssi
+, c 
+ut8_t
+ *
+de
+)
+
+1343 
+h_hd
+ *
+eh
+;
+
+1344 
+sockaddr
+ 
+d
+;
+
+1345 
+mbuf
+ *
+m0
+;
+
+1346 
+ut8_t
+ *
+p
+;
+
+1348 
+m0
+ = 
+	`p_g_mbuf
+(
+PPPOE_HEADERLEN
+);
+
+1349 i(!
+m0
+)
+
+1350  
+EIO
+;
+
+1351 
+p
+ = 
+	`mtod
+(
+m0
+, 
+ut8_t
+ *);
+
+1352 
+	`PPPOE_ADD_HEADER
+(
+p
+, 
+PPPOE_CODE_PADT
+, 
+ssi
+, 0);
+
+1354 
+	`memt
+(&
+d
+, 0,  dst);
+
+1355 
+d
+.
+_my
+ = 
+AF_UNSPEC
+;
+
+1356 
+eh
+ = (
+h_hd
+*)&
+d
+.
+_da
+;
+
+1357 
+eh
+->
+h_ty
+ = 
+	`hts
+(
+ETHERTYPE_PPPOEDISC
+);
+
+1358 
+	`memy
+(&
+eh
+->
+h_dho
+, 
+de
+, 
+ETHER_ADDR_LEN
+);
+
+1360 
+m0
+->
+m_ags
+ &~(
+M_BCAST
+|
+M_MCAST
+);
+
+1361  
+outgog_if
+->
+	`if_ouut
+(outgog_if, 
+m0
+, &
+d
+, 
+NULL
+);
+
+1362 
+	}
+}
+
+1364 #ifde
+PPPOE_SERVER
+
+
+1366 
+	$p_nd_do
+(
+p_soc
+ *
+sc
+)
+
+1368 
+mbuf
+ *
+m0
+;
+
+1369 
+ut8_t
+ *
+p
+;
+
+1370 
+size_t
+ 
+n
+;
+
+1372 i(
+sc
+->
+sc_e
+ !
+PPPOE_STATE_PADO_SENT
+)
+
+1373  
+EIO
+;
+
+1376 
+n
+ = 0;
+
+1378 
+n
+ +2 + 2 + (
+sc
+);
+
+1380 
+n
+ +2 + 2 + 
+sc
+->
+sc_hunique_n
+;
+
+1381 
+m0
+ = 
+	`p_g_mbuf
+(
+n
+ + 
+PPPOE_HEADERLEN
+);
+
+1382 i(!
+m0
+)
+
+1383  
+EIO
+;
+
+1384 
+p
+ = 
+	`mtod
+(
+m0
+, 
+ut8_t
+ *);
+
+1385 
+	`PPPOE_ADD_HEADER
+(
+p
+, 
+PPPOE_CODE_PADO
+, 0, 
+n
+);
+
+1386 
+	`PPPOE_ADD_16
+(
+p
+, 
+PPPOE_TAG_ACCOOKIE
+);
+
+1387 
+	`PPPOE_ADD_16
+(
+p
+, (
+sc
+));
+
+1388 
+	`memy
+(
+p
+, &
+sc
+, (sc));
+
+1389 
+p
+ +(
+sc
+);
+
+1390 
+	`PPPOE_ADD_16
+(
+p
+, 
+PPPOE_TAG_HUNIQUE
+);
+
+1391 
+	`PPPOE_ADD_16
+(
+p
+, 
+sc
+->
+sc_hunique_n
+);
+
+1392 
+	`memy
+(
+p
+, 
+sc
+->
+sc_hunique
+, sc->
+sc_hunique_n
+);
+
+1393  
+	`p_ouut
+(
+sc
+, 
+m0
+);
+
+1394 
+	}
+}
+
+1397 
+	$p_nd_ds
+(
+p_soc
+ *
+sc
+)
+
+1399 
+btime
+ 
+bt
+;
+
+1400 
+mbuf
+ *
+m0
+;
+
+1401 
+ut8_t
+ *
+p
+;
+
+1402 
+size_t
+ 
+n
+, 
+l1
+ = 0;
+
+1404 i(
+sc
+->
+sc_e
+ !
+PPPOE_STATE_PADO_SENT
+)
+
+1405  
+EIO
+;
+
+1407 
+	`gbuime
+(&
+bt
+);
+
+1408 
+sc
+->
+sc_ssi
+ = 
+bt
+.
+c
+ % 0xff + 1;
+
+1410 
+n
+ = 0;
+
+1412 
+n
+ +2 + 2 + 2 + 2 + 
+sc
+->
+sc_hunique_n
+;
+
+1413 i(
+sc
+->
+sc_rvi_me
+ !
+NULL
+) {
+
+1414 
+l1
+ = 
+	`
+(
+sc
+->
+sc_rvi_me
+);
+
+1415 
+n
+ +
+l1
+;
+
+1417 
+m0
+ = 
+	`p_g_mbuf
+(
+n
+ + 
+PPPOE_HEADERLEN
+);
+
+1418 i(!
+m0
+)
+
+1419  
+ENOBUFS
+;
+
+1420 
+p
+ = 
+	`mtod
+(
+m0
+, 
+ut8_t
+ *);
+
+1421 
+	`PPPOE_ADD_HEADER
+(
+p
+, 
+PPPOE_CODE_PADS
+, 
+sc
+->
+sc_ssi
+, 
+n
+);
+
+1422 
+	`PPPOE_ADD_16
+(
+p
+, 
+PPPOE_TAG_SNAME
+);
+
+1423 i(
+sc
+->
+sc_rvi_me
+ !
+NULL
+) {
+
+1424 
+	`PPPOE_ADD_16
+(
+p
+, 
+l1
+);
+
+1425 
+	`memy
+(
+p
+, 
+sc
+->
+sc_rvi_me
+, 
+l1
+);
+
+1426 
+p
+ +
+l1
+;
+
+1428 
+	`PPPOE_ADD_16
+(
+p
+, 0);
+
+1430 
+	`PPPOE_ADD_16
+(
+p
+, 
+PPPOE_TAG_HUNIQUE
+);
+
+1431 
+	`PPPOE_ADD_16
+(
+p
+, 
+sc
+->
+sc_hunique_n
+);
+
+1432 
+	`memy
+(
+p
+, 
+sc
+->
+sc_hunique
+, sc->
+sc_hunique_n
+);
+
+1433  
+	`p_ouut
+(
+sc
+, 
+m0
+);
+
+1434 
+	}
+}
+
+1438 
+	$p_s
+(
+
+ *
+
+)
+
+1440 
+p_soc
+ *
+sc
+ = (*)
+
+;
+
+1441 
+wtime
+;
+
+1443 i(
+sc
+->
+sc_e
+ !
+PPPOE_STATE_INITIAL
+)
+
+1446 i(
+sc
+->
+sc_
+.
+_pha
+ =
+SPPP_PHASE_ESTABLISH
+ &&
+
+1447 
+sc
+->
+sc_
+.
+_auth_us
+ > 0) {
+
+1452 
+wtime
+ = 
+PPPOE_RECON_FAST
+ * 
+sc
+->
+sc_
+.
+_auth_us
+;
+
+1453 i(
+wtime
+ > 
+PPPOE_SLOW_RETRY
+)
+
+1454 
+wtime
+ = 
+PPPOE_SLOW_RETRY
+;
+
+1456 
+wtime
+ = 
+PPPOE_RECON_IMMEDIATE
+;
+
+1458 
+	`out_t
+(&
+sc
+->
+sc_timeout
+, 
+wtime
+, 
+p_timeout
+, sc);
+
+1459 
+	}
+}
+
+1462 
+	$p_f
+(
+
+ *
+
+)
+
+1464 
+p_soc
+ *
+sc
+ = (*)
+
+;
+
+1465 i(
+sc
+->
+sc_e
+ < 
+PPPOE_STATE_SESSION
+)
+
+1472 
+sc
+->
+sc_e
+ = 
+PPPOE_STATE_CLOSING
+;
+
+1473 
+	`out_t
+(&
+sc
+->
+sc_timeout
+, 
+hz
+/50, 
+p_timeout
+, sc);
+
+1474 
+	}
+}
+
+1477 
+	$p_t
+(
+i
+ *
+i
+)
+
+1479 
+p_soc
+ *
+sc
+ = (*)
+i
+;
+
+1480 
+mbuf
+ *
+m
+;
+
+1481 
+ut8_t
+ *
+p
+;
+
+1482 
+size_t
+ 
+n
+;
+
+1484 i(
+	`_imy
+(
+i
+))
+
+1488 i(
+sc
+->
+sc_e
+ < 
+PPPOE_STATE_SESSION
+) {
+
+1489 
+	`_ush
+(&
+sc
+->
+sc_
+.
+_if
+);
+
+1493 (
+m
+ = 
+	`_dequeue
+(
+i
+)!
+NULL
+) {
+
+1494 
+n
+ = 
+m
+->
+m_pkthdr
+.len;
+
+1495 
+	`M_PREPEND
+(
+m
+, 
+PPPOE_HEADERLEN
+, 
+M_DONTWAIT
+);
+
+1496 i(
+m
+ =
+NULL
+) {
+
+1497 
+i
+->
+if_s
+++;
+
+1500 
+p
+ = 
+	`mtod
+(
+m
+, 
+ut8_t
+ *);
+
+1501 
+	`PPPOE_ADD_HEADER
+(
+p
+, 0, 
+sc
+->
+sc_ssi
+, 
+n
+);
+
+1503 
+	`bpf_mp
+(&
+sc
+->
+sc_
+.
+_if
+, 
+m
+);
+
+1505 
+	`p_ouut
+(
+sc
+, 
+m
+);
+
+1507 
+	}
+}
+
+1511 
+	$p_iach_hook
+(*
+g
+, 
+mbuf
+ **
+mp
+, 
+i
+ *
+i
+, 
+d
+)
+
+1513 
+p_soc
+ *
+sc
+;
+
+1514 
+s
+;
+
+1516 i(
+mp
+ !(
+mbuf
+ **)
+PFIL_IFNET_DETACH
+)
+
+1519 
+s
+ = 
+	`
+();
+
+1520 
+	`LIST_FOREACH
+(
+sc
+, &
+p_soc_li
+, 
+sc_li
+) {
+
+1521 i(
+sc
+->
+sc_h_if
+ !
+i
+)
+
+1523 i(
+sc
+->
+sc_
+.
+_if
+.
+if_ags
+ & 
+IFF_UP
+) {
+
+1524 
+sc
+->
+sc_
+.
+_if
+.
+if_ags
+ &~(
+IFF_UP
+|
+IFF_RUNNING
+);
+
+1525 
+	`tf
+("%s:thernet interface detached, going down\n",
+
+1526 
+sc
+->
+sc_
+.
+_if
+.
+if_xme
+);
+
+1528 
+sc
+->
+sc_h_if
+ = 
+NULL
+;
+
+1529 
+	`p_r_soc
+(
+sc
+, "ethernet interface detached");
+
+1531 
+	`lx
+(
+s
+);
+
+1534 
+	}
+}
+
+1537 
+	$p_r_soc
+(
+p_soc
+ *
+sc
+, c *
+mesge
+)
+
+1540 
+	`out_
+(&
+sc
+->
+sc_timeout
+);
+
+1541 i(
+sc
+->
+sc_
+.
+_if
+.
+if_ags
+ & 
+IFF_DEBUG
+)
+
+1542 
+	`tf
+("%s: session 0x%xerminated, %s\n",
+
+1543 
+sc
+->
+sc_
+.
+_if
+.
+if_xme
+, sc->
+sc_ssi
+, 
+mesge
+);
+
+1546 
+sc
+->
+sc_e
+ = 
+PPPOE_STATE_INITIAL
+;
+
+1549 
+sc
+->
+sc_
+.
+	`_down
+(&sc->sc_sppp);
+
+1552 
+	`memy
+(&
+sc
+->
+sc_de
+, 
+hbrdaddr
+, (sc->sc_dest));
+
+1553 i(
+sc
+->
+sc_ac_cook
+) {
+
+1554 
+	`
+(
+sc
+->
+sc_ac_cook
+, 
+M_DEVBUF
+);
+
+1555 
+sc
+->
+sc_ac_cook
+ = 
+NULL
+;
+
+1557 i(
+sc
+->
+sc_y_sid
+) {
+
+1558 
+	`
+(
+sc
+->
+sc_y_sid
+, 
+M_DEVBUF
+);
+
+1559 
+sc
+->
+sc_y_sid
+ = 
+NULL
+;
+
+1561 
+sc
+->
+sc_ac_cook_n
+ = 0;
+
+1562 
+sc
+->
+sc_ssi
+ = 0;
+
+1563 
+	}
+}
+
+	@if_pppoe.h
+
+32 #ide
+_NET_IF_PPPOE_H_
+
+
+33 
+	#_NET_IF_PPPOE_H_
+
+
+	)
+
+35 
+	spdisms
+ {
+
+36 
+	miame
+[
+IFNAMSIZ
+];
+
+37 
+	mh_iame
+[
+IFNAMSIZ
+];
+
+38 c *
+	mac_me
+;
+
+39 
+size_t
+ 
+	mac_me_n
+;
+
+40 c *
+	mrvi_me
+;
+
+41 
+size_t
+ 
+	mrvi_me_n
+;
+
+44 
+	#PPPOESETPARMS
+ 
+	`_IOW
+('i', 110, 
+pdisms
+)
+
+	)
+
+45 
+	#PPPOEGETPARMS
+ 
+	`_IOWR
+('i', 111, 
+pdisms
+)
+
+	)
+
+47 
+	#PPPOE_STATE_INITIAL
+ 0
+
+	)
+
+48 
+	#PPPOE_STATE_PADI_SENT
+ 1
+
+	)
+
+49 
+	#PPPOE_STATE_PADR_SENT
+ 2
+
+	)
+
+50 
+	#PPPOE_STATE_SESSION
+ 3
+
+	)
+
+51 
+	#PPPOE_STATE_CLOSING
+ 4
+
+	)
+
+53 
+	#PPPOE_STATE_PADO_SENT
+ 1
+
+	)
+
+55 
+	spcie
+ {
+
+56 
+	miame
+[
+IFNAMSIZ
+];
+
+57 
+u_t
+ 
+	me
+;
+
+58 
+u_t
+ 
+	mssi_id
+;
+
+59 
+u_t
+ 
+	mdi_y_no
+;
+
+60 
+u_t
+ 
+	mdr_y_no
+;
+
+63 
+	#PPPOEGETSESSION
+ 
+	`_IOWR
+('i', 112, 
+pcie
+)
+
+	)
+
+65 #ifde
+_KERNEL
+
+
+67 
+ifqueue
+ 
+discq
+;
+
+68 
+ifqueue
+ 
+q
+;
+
+70 *
+p_so
+;
+
+	@if_pppvar.h
+
+77 #ide
+_NET_IF_PPPVAR_H_
+
+
+78 
+	#_NET_IF_PPPVAR_H_
+
+
+	)
+
+80 
+	~<sys/out.h
+>
+
+86 
+	#NP_IP
+ 0
+
+	)
+
+87 
+	#NP_IPV6
+ 1
+
+	)
+
+88 
+	#NUM_NP
+ 2
+
+	)
+
+93 
+	sp_soc
+ {
+
+94 
+i
+ 
+	msc_if
+;
+
+95 
+	msc_un
+;
+
+96 
+u_t
+ 
+	msc_ags
+;
+
+97 *
+	msc_devp
+;
+
+98 (*
+	msc_t
+)(
+	mp_soc
+ *);
+
+99 (*
+	msc_
+)(
+	mp_soc
+ *);
+
+100 (*
+	msc_lq
+)(
+	mp_soc
+ *);
+
+101 
+out
+ 
+	msc_timo_ch
+;
+
+102 
+ut16_t
+ 
+	msc_mru
+;
+
+103 
+pid_t
+ 
+	msc_xr
+;
+
+104 
+ifqueue
+ 
+	msc_wq
+;
+
+105 
+ifqueue
+ 
+	msc_q
+;
+
+106 
+ifqueue
+ 
+	msc_q
+;
+
+107 
+mbuf
+ *
+	msc_togo
+;
+
+108 
+mbuf
+ *
+	msc_queue
+;
+
+109 
+mbuf
+ **
+	msc_q
+;
+
+110 
+p
+ 
+	msc_s
+;
+
+111 
+NPmode
+ 
+	msc_mode
+[
+NUM_NP
+];
+
+112 
+comess
+ *
+	msc_xcomp
+;
+
+113 *
+	msc_xc_e
+;
+
+114 
+comess
+ *
+	msc_rcomp
+;
+
+115 *
+	msc_rc_e
+;
+
+116 
+time_t
+ 
+	msc__
+;
+
+117 
+time_t
+ 
+	msc__cv
+;
+
+118 *
+	msc_si
+;
+
+119 #ifde
+PPP_FILTER
+
+
+121 
+bpf_ogm
+ 
+	msc_ss_ft_
+;
+
+122 
+bpf_ogm
+ 
+	msc_ss_ft_out
+;
+
+125 
+bpf_ogm
+ 
+	msc_aive_ft_
+;
+
+126 
+bpf_ogm
+ 
+	msc_aive_ft_out
+;
+
+128 #ifdef 
+VJC
+
+
+129 
+comess
+ *
+	msc_comp
+;
+
+133 
+ext_accm
+ 
+	msc_asyncm
+;
+
+134 
+ut32_t
+ 
+	msc_syncm
+;
+
+135 
+mbuf
+ *
+	msc_outm
+;
+
+136 
+mbuf
+ *
+	msc_m
+;
+
+137 
+mbuf
+ *
+	msc_mc
+;
+
+138 *
+	msc_mp
+;
+
+139 
+ut16_t
+ 
+	msc_
+;
+
+140 
+ut16_t
+ 
+	msc_fcs
+;
+
+141 
+ut16_t
+ 
+	msc_outfcs
+;
+
+142 
+ut16_t
+ 
+	msc_maxq
+;
+
+145 
+ut8_t
+ 
+	msc_nq
+;
+
+148 
+u_ch
+ 
+	msc_w_t
+;
+
+149 
+p_w
+ 
+	msc_w
+;
+
+150 
+LIST_ENTRY
+(
+p_soc
+
+	msc_ii
+;
+
+153 #ifde
+_KERNEL
+
+
+155 
+p_soc
+ *
+oc
+(
+pid_t
+);
+
+156 
+pdoc
+(
+p_soc
+ *);
+
+157 
+piol
+(
+p_soc
+ *, 
+u_lg
+, *, , 
+lwp
+ *);
+
+158 
+p_t
+(
+p_soc
+ *);
+
+159 
+kt
+(
+p_soc
+ *, 
+mbuf
+ *, );
+
+160 
+mbuf
+ *
+p_dequeue
+(
+p_soc
+ *);
+
+161 
+pouut
+(
+i
+ *, 
+mbuf
+ *, c 
+sockaddr
+ *,
+
+162 
+y
+ *);
+
+	@if_sl.c
+
+62 
+	~<sys/cdefs.h
+>
+
+63 
+__KERNEL_RCSID
+(0, "$NetBSD: if_sl.c,v 1.119 2014/06/05 23:48:16mind Exp $");
+
+65 
+	~"t_.h
+"
+
+67 
+	~<sys/m.h
+>
+
+68 
+	~<sys/oc.h
+>
+
+69 
+	~<sys/mloc.h
+>
+
+70 
+	~<sys/mbuf.h
+>
+
+71 
+	~<sys/buf.h
+>
+
+72 
+	~<sys/dk.h
+>
+
+73 
+	~<sys/sock.h
+>
+
+74 
+	~<sys/iol.h
+>
+
+75 
+	~<sys/fe.h
+>
+
+76 
+	~<sys/cf.h
+>
+
+77 
+	~<sys/y.h
+>
+
+78 
+	~<sys/kl.h
+>
+
+79 
+	~<sys/sockv.h
+>
+
+80 #i
+__NBSD__
+
+
+81 
+	~<sys/sym.h
+>
+
+82 
+	~<sys/kauth.h
+>
+
+84 
+	~<sys/u.h
+>
+
+85 
+	~<sys/.h
+>
+
+87 
+	~<t/if.h
+>
+
+88 
+	~<t/if_tys.h
+>
+
+89 
+	~<t/ti.h
+>
+
+90 
+	~<t/rou.h
+>
+
+92 #ifde
+INET
+
+
+93 
+	~<t/.h
+>
+
+94 
+	~<t/_sym.h
+>
+
+95 
+	~<t/_v.h
+>
+
+96 
+	~<t/.h
+>
+
+99 
+	~<t/comess.h
+>
+
+100 
+	~<t/if_v.h
+>
+
+101 
+	~<t/.h
+>
+
+102 
+	~<t/p_defs.h
+>
+
+103 
+	~<t/if_p.h
+>
+
+105 
+	~<sys/time.h
+>
+
+106 
+	~<t/bpf.h
+>
+
+148 
+	#BUFOFFSET
+ (128+(
+i
+ **)+
+SLIP_HDRLEN
+)
+
+	)
+
+149 
+	#SLMAX
+ (
+MCLBYTES
+ - 
+BUFOFFSET
+)
+
+	)
+
+150 
+	#SLBUFSIZE
+ (
+SLMAX
+ + 
+BUFOFFSET
+)
+
+	)
+
+151 #ide
+SLMTU
+
+
+152 
+	#SLMTU
+ 296
+
+	)
+
+154 #i(
+SLMTU
+ < 3)
+
+155 #r 
+SLMTU
+ 
+way
+ 
+too
+ 
+sml
+.
+
+157 
+	#SLIP_HIWAT
+ 
+	`roundup
+(50, 
+TTROUND
+)
+
+	)
+
+158 #ide
+__NBSD__
+
+
+159 
+	#CLISTRESERVE
+ 1024
+
+	)
+
+169 
+	#ABT_ESC
+ '\033'
+
+	)
+
+170 
+	#ABT_IDLE
+ 1
+
+	)
+
+171 
+	#ABT_COUNT
+ 3
+
+	)
+
+172 
+	#ABT_WINDOW
+ (
+ABT_COUNT
+*2+2
+
+	)
+
+174 
+_e_
+(
+if_e
+ *, );
+
+175 
+_e_deroy
+(
+i
+ *);
+
+177 
+	$LIST_HEAD
+(, 
+_soc
+
+_soc_li
+;
+
+179 
+if_e
+ 
+_
+ =
+
+180 
+	`IF_CLONE_INITIALIZER
+("", 
+_e_
+, 
+_e_deroy
+);
+
+182 
+	#FRAME_END
+ 0xc0
+
+	)
+
+183 
+	#FRAME_ESCAPE
+ 0xdb
+
+	)
+
+184 
+	#TRANS_FRAME_END
+ 0xd
+
+	)
+
+185 
+	#TRANS_FRAME_ESCAPE
+ 0xdd
+
+	)
+
+187 
+	`
+(*);
+
+189 
+	`
+(
+_soc
+ *);
+
+190 
+mbuf
+ *
+	`_btom
+(
+_soc
+ *, );
+
+192 
+	`o
+(
+y
+ *, );
+
+193 
+	`put
+(, 
+y
+ *);
+
+194 
+	`iol
+(
+i
+ *, 
+u_lg
+, *);
+
+195 
+	`
+(
+dev_t
+, 
+y
+ *);
+
+196 
+	`ouut
+(
+i
+ *, 
+mbuf
+ *, c 
+sockaddr
+ *,
+
+197 
+y
+ *);
+
+198 
+	`t
+(
+y
+ *);
+
+199 
+	`tiol
+(
+y
+ *, 
+u_lg
+, *, , 
+lwp
+ *);
+
+201 
+lesw
+ 
+_disc
+ = {
+
+202 .
+l_me
+ = "slip",
+
+203 .
+l_
+ = 
+
+,
+
+204 .
+l_o
+ = 
+o
+,
+
+205 .
+l_ad
+ = 
+yrio
+,
+
+206 .
+l_wre
+ = 
+yrio
+,
+
+207 .
+l_iol
+ = 
+tiol
+,
+
+208 .
+l_rt
+ = 
+put
+,
+
+209 .
+l_t
+ = 
+t
+,
+
+210 .
+l_modem
+ = 
+numodem
+,
+
+211 .
+l_pl
+ = 
+yl
+
+
+212 
+	}
+};
+
+214 
+ch
+();
+
+217 
+	$ch
+()
+
+220 i(
+	`yldisc_ch
+(&
+_disc
+) != 0)
+
+221 
+	`nic
+("slattach");
+
+222 
+	`LIST_INIT
+(&
+_soc_li
+);
+
+223 
+	`if_e_ch
+(&
+_
+);
+
+224 
+	}
+}
+
+227 
+	$_e_
+(
+if_e
+ *
+ifc
+, 
+un
+)
+
+229 
+_soc
+ *
+sc
+;
+
+231 
+sc
+ = 
+	`mloc
+((*sc), 
+M_DEVBUF
+, 
+M_WAIT
+|
+M_ZERO
+);
+
+232 
+sc
+->
+sc_un
+ = 
+un
+;
+
+233 
+	`if_me
+(&
+sc
+->
+sc_if
+, 
+ifc
+->
+ifc_me
+, 
+un
+);
+
+234 
+sc
+->
+sc_if
+.
+if_soc
+ = sc;
+
+235 
+sc
+->
+sc_if
+.
+if_mtu
+ = 
+SLMTU
+;
+
+236 
+sc
+->
+sc_if
+.
+if_ags
+ = 
+IFF_POINTOPOINT
+ | 
+SC_AUTOCOMP
+ | 
+IFF_MULTICAST
+;
+
+237 
+sc
+->
+sc_if
+.
+if_ty
+ = 
+IFT_SLIP
+;
+
+238 
+sc
+->
+sc_if
+.
+if_iol
+ = 
+iol
+;
+
+239 
+sc
+->
+sc_if
+.
+if_ouut
+ = 
+ouut
+;
+
+240 
+sc
+->
+sc_if
+.
+if_d
+ = 
+DLT_SLIP
+;
+
+241 
+sc
+->
+sc_q
+.
+ifq_maxn
+ = 32;
+
+242 
+	`IFQ_SET_READY
+(&
+sc
+->
+sc_if
+.
+if_d
+);
+
+243 
+	`if_ch
+(&
+sc
+->
+sc_if
+);
+
+244 
+	`if_loc_dl
+(&
+sc
+->
+sc_if
+);
+
+245 
+	`bpf_ch
+(&
+sc
+->
+sc_if
+, 
+DLT_SLIP
+, 
+SLIP_HDRLEN
+);
+
+246 
+	`LIST_INSERT_HEAD
+(&
+_soc_li
+, 
+sc
+, 
+sc_ii
+);
+
+248 
+	}
+}
+
+251 
+	$_e_deroy
+(
+i
+ *
+i
+)
+
+253 
+_soc
+ *
+sc
+ = (_so*)
+i
+->
+if_soc
+;
+
+255 i(
+sc
+->
+sc_yp
+ !
+NULL
+)
+
+256  
+EBUSY
+;
+
+258 
+	`LIST_REMOVE
+(
+sc
+, 
+sc_ii
+);
+
+260 
+	`bpf_dach
+(
+i
+);
+
+261 
+	`if_dach
+(
+i
+);
+
+263 
+	`
+(
+sc
+, 
+M_DEVBUF
+);
+
+265 
+	}
+}
+
+268 
+	$
+(
+_soc
+ *
+sc
+)
+
+271 i(
+sc
+->
+sc_mbuf
+ =
+NULL
+) {
+
+272 
+sc
+->
+sc_mbuf
+ = 
+	`m_ghdr
+(
+M_WAIT
+, 
+MT_DATA
+);
+
+273 
+	`m_g
+(
+sc
+->
+sc_mbuf
+, 
+M_WAIT
+);
+
+275 
+sc
+->
+sc_
+ = (
+u_ch
+ *)sc->
+sc_mbuf
+->
+m_ext
+.
+ext_buf
+ +
+
+276 
+sc
+->
+sc_mbuf
+->
+m_ext
+.
+ext_size
+;
+
+277 
+sc
+->
+sc_mp
+ = sc->
+sc_pktt
+ = (
+u_ch
+ *)sc->
+sc_mbuf
+->
+m_ext
+.
+ext_buf
+ +
+
+278 
+BUFOFFSET
+;
+
+280 #ifde
+INET
+
+
+281 
+	`_comess_
+(&
+sc
+->
+sc_comp
+);
+
+285 
+	}
+}
+
+293 
+	$
+(
+dev_t
+ 
+dev
+, 
+y
+ *
+
+)
+
+295 
+lwp
+ *
+l
+ = 
+cuwp
+;
+
+296 
+_soc
+ *
+sc
+;
+
+297 
+r
+;
+
+299 
+r
+ = 
+	`kauth_authize_twk
+(
+l
+->
+l_ed
+, 
+KAUTH_NETWORK_INTERFACE_SLIP
+,
+
+300 
+KAUTH_REQ_NETWORK_INTERFACE_SLIP_ADD
+, 
+NULL
+, NULL, NULL);
+
+301 i(
+r
+)
+
+302  
+r
+;
+
+304 i(
+
+->
+t_lesw
+ =&
+_disc
+)
+
+307 
+	`LIST_FOREACH
+(
+sc
+, &
+_soc_li
+, 
+sc_ii
+)
+
+308 i(
+sc
+->
+sc_yp
+ =
+NULL
+) {
+
+309 
+sc
+->
+sc_si
+ = 
+	`sot_eablish
+(
+SOFTINT_NET
+,
+
+310 
+
+, 
+sc
+);
+
+311 i(
+sc
+->
+sc_si
+ =
+NULL
+)
+
+312  
+ENOMEM
+;
+
+313 i(
+	`
+(
+sc
+) == 0) {
+
+314 
+	`sot_diablish
+(
+sc
+->
+sc_si
+);
+
+315  
+ENOBUFS
+;
+
+317 
+
+->
+t_sc
+ = (*)
+sc
+;
+
+318 
+sc
+->
+sc_yp
+ = 
+
+;
+
+319 
+sc
+->
+sc_if
+.
+if_baud
+ = 
+
+->
+t_od
+;
+
+320 
+	`mux__r
+(&
+y_lock
+);
+
+321 
+
+->
+t_e
+ |
+TS_ISOPEN
+ | 
+TS_XCLUDE
+;
+
+322 
+	`yush
+(
+
+, 
+FREAD
+ | 
+FWRITE
+);
+
+331 i(
+
+->
+t_outq
+.
+c_
+ < 2 * 
+SLMAX
+ + 2) {
+
+332 
+sc
+->
+sc_dbufsize
+ = 
+
+->
+t_outq
+.
+c_
+;
+
+333 
+sc
+->
+sc_dbufqu
+ = 
+
+->
+t_outq
+.
+c_cq
+ != 0;
+
+335 
+	`
+(&
+
+->
+t_outq
+);
+
+336 
+	`mux__ex
+(&
+y_lock
+);
+
+337 
+r
+ = 
+	`loc
+(&
+
+->
+t_outq
+, 2 * 
+SLMAX
+ + 2, 0);
+
+338 i(
+r
+) {
+
+339 
+	`sot_diablish
+(
+sc
+->
+sc_si
+);
+
+345  
+ENOMEM
+;
+
+348 
+sc
+->
+sc_dbufsize
+ = sc->
+sc_dbufqu
+ = 0;
+
+349 
+	`mux__ex
+(&
+y_lock
+);
+
+353  
+ENXIO
+;
+
+354 
+	}
+}
+
+361 
+	$o
+(
+y
+ *
+
+, 
+ag
+)
+
+363 
+_soc
+ *
+sc
+;
+
+364 
+s
+;
+
+366 
+	`ywush
+(
+
+);
+
+367 
+sc
+ = 
+
+->
+t_sc
+;
+
+369 i(
+sc
+ !
+NULL
+) {
+
+370 
+	`sot_diablish
+(
+sc
+->
+sc_si
+);
+
+371 
+s
+ = 
+	`
+();
+
+372 
+	`if_down
+(&
+sc
+->
+sc_if
+);
+
+373 
+	`IF_PURGE
+(&
+sc
+->
+sc_q
+);
+
+374 
+	`lx
+(
+s
+);
+
+376 
+s
+ = 
+	`ty
+();
+
+377 
+	`yldisc_a
+(
+
+->
+t_lesw
+);
+
+378 
+
+->
+t_lesw
+ = 
+	`yldisc_deu
+();
+
+379 
+
+->
+t_e
+ = 0;
+
+381 
+sc
+->
+sc_yp
+ = 
+NULL
+;
+
+382 
+
+->
+t_sc
+ = 
+NULL
+;
+
+384 
+	`m_m
+(
+sc
+->
+sc_mbuf
+);
+
+385 
+sc
+->
+sc_mbuf
+ = 
+NULL
+;
+
+386 
+sc
+->
+sc_
+ = sc->
+sc_mp
+ = sc->
+sc_pktt
+ = 
+NULL
+;
+
+387 
+	`IF_PURGE
+(&
+sc
+->
+sc_q
+);
+
+393 i(
+sc
+->
+sc_dbufsize
+ != 0) {
+
+394 
+	`
+(&
+
+->
+t_outq
+);
+
+395 
+	`loc
+(&
+
+->
+t_outq
+, 
+sc
+->
+sc_dbufsize
+,
+
+396 
+sc
+->
+sc_dbufqu
+);
+
+398 
+	`lx
+(
+s
+);
+
+402 
+	}
+}
+
+410 
+	$tiol
+(
+y
+ *
+
+, 
+u_lg
+ 
+cmd
+, *
+da
+, 
+ag
+,
+
+411 
+lwp
+ *
+l
+)
+
+413 
+_soc
+ *
+sc
+ = (_so*)
+
+->
+t_sc
+;
+
+415 
+cmd
+) {
+
+416 
+SLIOCGUNIT
+:
+
+417 *(*)
+da
+ = 
+sc
+->
+sc_un
+;
+
+421  
+EPASSTHROUGH
+;
+
+424 
+	}
+}
+
+433 
+	$ouut
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+, c 
+sockaddr
+ *
+d
+,
+
+434 
+y
+ *
+p
+)
+
+436 
+_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+437 
+
+ *ip;
+
+438 
+ifqueue
+ *
+ifq
+ = 
+NULL
+;
+
+439 
+s
+, 
+r
+;
+
+440 
+	`ALTQ_DECL
+(
+tq_pkr
+ 
+pkr
+;)
+
+442 
+	`IFQ_CLASSIFY
+(&
+i
+->
+if_d
+, 
+m
+, 
+d
+->
+_my
+, &
+pkr
+);
+
+448 i(
+d
+->
+_my
+ !
+AF_INET
+) {
+
+449 
+	`tf
+("%s:f%d sud\n", 
+sc
+->
+sc_if
+.
+if_xme
+,
+
+450 
+d
+->
+_my
+);
+
+451 
+	`m_m
+(
+m
+);
+
+452 
+sc
+->
+sc_if
+.
+if_nro
+++;
+
+453  
+EAFNOSUPPORT
+;
+
+456 i(
+sc
+->
+sc_yp
+ =
+NULL
+) {
+
+457 
+	`m_m
+(
+m
+);
+
+458  
+ENETDOWN
+;
+
+460 i((
+sc
+->
+sc_yp
+->
+t_e
+ & 
+TS_CARR_ON
+) == 0 &&
+
+461 (
+sc
+->
+sc_yp
+->
+t_cag
+ & 
+CLOCAL
+) == 0) {
+
+462 
+	`m_m
+(
+m
+);
+
+463 
+	`tf
+("%s:dol\n", 
+sc
+->
+sc_if
+.
+if_xme
+);
+
+464  
+EHOSTUNREACH
+;
+
+466 
+
+ = 
+	`mtod
+(
+m
+, ip *);
+
+467 #ifde
+INET
+
+
+468 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+SC_NOICMP
+ && 
+
+->
+_p
+ =
+IPPROTO_ICMP
+) {
+
+469 
+	`m_m
+(
+m
+);
+
+470  
+ENETRESET
+;
+
+474 
+s
+ = 
+	`ty
+();
+
+475 i(
+sc
+->
+sc_oqn
+ && sc->
+sc_yp
+->
+t_outq
+.
+c_cc
+ == sc->sc_oqlen) {
+
+476 
+btime
+ 
+bt
+;
+
+479 
+	`gbuime
+(&
+bt
+);
+
+480 
+	`btime_sub
+(&
+bt
+, &
+sc
+->
+sc_ck
+);
+
+481 i(
+bt
+.
+c
+ > 0) {
+
+482 
+sc
+->
+sc_imeout
+++;
+
+483 
+	`t
+(
+sc
+->
+sc_yp
+);
+
+486 
+	`lx
+(
+s
+);
+
+488 
+s
+ = 
+	`
+();
+
+489 #ifde
+INET
+
+
+490 i((
+
+->
+_tos
+ & 
+IPTOS_LOWDELAY
+) != 0)
+
+491 
+ifq
+ = &
+sc
+->
+sc_q
+;
+
+493 i((
+r
+ = 
+	`ifq_queue2
+(
+i
+, 
+ifq
+, 
+m
+ 
+ALTQ_COMMA
+
+
+494 
+	`ALTQ_DECL
+(&
+pkr
+))) != 0) {
+
+495 
+	`lx
+(
+s
+);
+
+496  
+r
+;
+
+498 
+	`gbuime
+(&
+sc
+->
+sc_ck
+);
+
+499 
+	`lx
+(
+s
+);
+
+501 
+s
+ = 
+	`ty
+();
+
+502 i((
+sc
+->
+sc_oqn
+ = sc->
+sc_yp
+->
+t_outq
+.
+c_cc
+) == 0)
+
+503 
+	`t
+(
+sc
+->
+sc_yp
+);
+
+504 
+	`lx
+(
+s
+);
+
+507 
+	}
+}
+
+515 
+	$t
+(
+y
+ *
+
+)
+
+517 
+_soc
+ *
+sc
+ = 
+
+->
+t_sc
+;
+
+524 i(
+
+->
+t_outq
+.
+c_cc
+ != 0) {
+
+525 (*
+
+->
+t_roc
+)(tp);
+
+526 i(
+
+->
+t_outq
+.
+c_cc
+ > 
+SLIP_HIWAT
+)
+
+533 i(
+sc
+ =
+NULL
+)
+
+535 
+	`sot_schedu
+(
+sc
+->
+sc_si
+);
+
+537 
+	}
+}
+
+542 
+mbuf
+ *
+
+543 
+	$_btom
+(
+_soc
+ *
+sc
+, 
+n
+)
+
+545 
+mbuf
+ *
+m
+;
+
+550 
+m
+ = 
+sc
+->
+sc_mbuf
+;
+
+551 
+	`MGETHDR
+(
+sc
+->
+sc_mbuf
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+552 i(
+sc
+->
+sc_mbuf
+ =
+NULL
+) {
+
+553 
+sc
+->
+sc_mbuf
+ = 
+m
+;
+
+554  
+NULL
+;
+
+556 
+	`MCLGET
+(
+sc
+->
+sc_mbuf
+, 
+M_DONTWAIT
+);
+
+557 i((
+sc
+->
+sc_mbuf
+->
+m_ags
+ & 
+M_EXT
+) == 0) {
+
+558 
+	`m_m
+(
+sc
+->
+sc_mbuf
+);
+
+559 
+sc
+->
+sc_mbuf
+ = 
+m
+;
+
+560  
+NULL
+;
+
+562 
+sc
+->
+sc_
+ = (
+u_ch
+ *)sc->
+sc_mbuf
+->
+m_ext
+.
+ext_buf
+ +
+
+563 
+sc
+->
+sc_mbuf
+->
+m_ext
+.
+ext_size
+;
+
+565 
+m
+->
+m_da
+ = 
+sc
+->
+sc_pktt
+;
+
+567 
+m
+->
+m_pkthdr
+.
+n
+ = m->
+m_n
+ =en;
+
+568 
+m
+->
+m_pkthdr
+.
+rcvif
+ = &
+sc
+->
+sc_if
+;
+
+569  
+m
+;
+
+570 
+	}
+}
+
+576 
+	$put
+(
+c
+, 
+y
+ *
+
+)
+
+578 
+_soc
+ *
+sc
+;
+
+579 
+mbuf
+ *
+m
+;
+
+580 
+n
+;
+
+582 
+tk_n
+++;
+
+583 
+sc
+ = (
+_soc
+ *)
+
+->
+t_sc
+;
+
+584 i(
+sc
+ =
+NULL
+)
+
+586 i((
+c
+ & 
+TTY_ERRORMASK
+|| ((
+
+->
+t_e
+ & 
+TS_CARR_ON
+) == 0 &&
+
+587 (
+
+->
+t_cag
+ & 
+CLOCAL
+) == 0)) {
+
+588 
+sc
+->
+sc_ags
+ |
+SC_ERROR
+;
+
+591 
+c
+ &
+TTY_CHARMASK
+;
+
+593 ++
+sc
+->
+sc_if
+.
+if_ibys
+;
+
+595 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_DEBUG
+) {
+
+596 i(
+c
+ =
+ABT_ESC
+) {
+
+601 i(
+sc
+->
+sc_abtcou
+ &&
+
+602 
+time_cd
+ >
+sc
+->
+sc_ime
+ + 
+ABT_WINDOW
+)
+
+603 
+sc
+->
+sc_abtcou
+ = 0;
+
+608 i(
+time_cd
+ >
+sc
+->
+sc_time
+ + 
+ABT_IDLE
+) {
+
+609 i(++
+sc
+->
+sc_abtcou
+ == 1)
+
+610 
+sc
+->
+sc_ime
+ = 
+time_cd
+;
+
+611 i(
+sc
+->
+sc_abtcou
+ >
+ABT_COUNT
+) {
+
+612 
+	`o
+(
+
+, 0);
+
+617 
+sc
+->
+sc_abtcou
+ = 0;
+
+618 
+sc
+->
+sc_time
+ = 
+time_cd
+;
+
+621 
+c
+) {
+
+623 
+TRANS_FRAME_ESCAPE
+:
+
+624 i(
+sc
+->
+sc_es
+)
+
+625 
+c
+ = 
+FRAME_ESCAPE
+;
+
+628 
+TRANS_FRAME_END
+:
+
+629 i(
+sc
+->
+sc_es
+)
+
+630 
+c
+ = 
+FRAME_END
+;
+
+633 
+FRAME_ESCAPE
+:
+
+634 
+sc
+->
+sc_es
+ = 1;
+
+637 
+FRAME_END
+:
+
+638 i(
+sc
+->
+sc_ags
+ & 
+SC_ERROR
+) {
+
+639 
+sc
+->
+sc_ags
+ &~
+SC_ERROR
+;
+
+640 
+wck
+;
+
+642 
+n
+ = 
+sc
+->
+sc_mp
+ - sc->
+sc_pktt
+;
+
+643 i(
+n
+ < 3)
+
+645 
+wck
+;
+
+647 
+m
+ = 
+	`_btom
+(
+sc
+, 
+n
+);
+
+648 i(
+m
+ =
+NULL
+)
+
+649 
+r
+;
+
+651 
+	`IF_ENQUEUE
+(&
+sc
+->
+sc_q
+, 
+m
+);
+
+652 
+	`sot_schedu
+(
+sc
+->
+sc_si
+);
+
+653 
+wck
+;
+
+655 i(
+sc
+->
+sc_mp
+ < sc->
+sc_
+) {
+
+656 *
+sc
+->
+sc_mp
+++ = 
+c
+;
+
+657 
+sc
+->
+sc_es
+ = 0;
+
+662 
+sc
+->
+sc_ags
+ |
+SC_ERROR
+;
+
+664 
+r
+:
+
+665 
+sc
+->
+sc_if
+.
+if_s
+++;
+
+666 
+wck
+:
+
+667 
+sc
+->
+sc_mp
+ = sc->
+sc_pktt
+ = (
+u_ch
+ *)sc->
+sc_mbuf
+->
+m_ext
+.
+ext_buf
+ +
+
+668 
+BUFOFFSET
+;
+
+669 
+sc
+->
+sc_es
+ = 0;
+
+672 
+	}
+}
+
+675 
+	$
+(*
+g
+)
+
+677 
+_soc
+ *
+sc
+ = 
+g
+;
+
+678 
+y
+ *
+
+ = 
+sc
+->
+sc_yp
+;
+
+679 
+mbuf
+ *
+m
+;
+
+680 
+s
+, 
+n
+;
+
+681 
+u_ch
+ *
+pktt
+;
+
+682 #ifde
+INET
+
+
+683 
+u_ch
+ 
+c
+;
+
+685 
+u_ch
+ 
+chdr
+[
+CHDR_LEN
+];
+
+687 
+	`KASSERT
+(
+
+ !
+NULL
+);
+
+692 
+	`mux_r
+(
+sot_lock
+);
+
+694 #ifde
+INET
+
+
+695 
+
+ *ip;
+
+697 
+mbuf
+ *
+m2
+;
+
+698 
+mbuf
+ *
+bpf_m
+;
+
+706 
+s
+ = 
+	`ty
+();
+
+707 i(
+
+->
+t_outq
+.
+c_
+ -p->t_outq.
+c_cc
+ <
+
+708 2 * 
+sc
+->
+sc_if
+.
+if_mtu
+ + 2) {
+
+709 
+	`lx
+(
+s
+);
+
+712 
+	`lx
+(
+s
+);
+
+717 
+s
+ = 
+	`
+();
+
+718 
+	`IF_DEQUEUE
+(&
+sc
+->
+sc_q
+, 
+m
+);
+
+719 i(
+m
+)
+
+720 
+sc
+->
+sc_if
+.
+if_oms
+++;
+
+722 
+	`IFQ_DEQUEUE
+(&
+sc
+->
+sc_if
+.
+if_d
+, 
+m
+);
+
+723 
+	`lx
+(
+s
+);
+
+725 i(
+m
+ =
+NULL
+)
+
+734 i(
+sc
+->
+sc_if
+.
+if_bpf
+) {
+
+744 
+bpf_m
+ = 
+	`m_dup
+(
+m
+, 0, 
+M_COPYALL
+, 
+M_DONTWAIT
+);
+
+746 
+bpf_m
+ = 
+NULL
+;
+
+747 #ifde
+INET
+
+
+748 i((
+
+ = 
+	`mtod
+(
+m
+,  *))->
+_p
+ =
+IPPROTO_TCP
+) {
+
+749 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+SC_COMPRESS
+)
+
+750 *
+	`mtod
+(
+m
+, 
+u_ch
+ *) |=
+
+751 
+	`_comess_t
+(
+m
+, 
+
+, &
+sc
+->
+sc_comp
+, 1);
+
+754 i(
+bpf_m
+)
+
+755 
+	`bpf_mp__out
+(&
+sc
+->
+sc_if
+, 
+	`mtod
+(
+m
+, 
+u_ch
+ *), 
+bpf_m
+);
+
+756 
+	`gbuime
+(&
+sc
+->
+sc_ck
+);
+
+758 
+s
+ = 
+	`ty
+();
+
+766 i(
+
+->
+t_outq
+.
+c_cc
+ == 0) {
+
+767 
+sc
+->
+sc_if
+.
+if_obys
+++;
+
+768 ()
+	`putc
+(
+FRAME_END
+, &
+
+->
+t_outq
+);
+
+771 
+m
+) {
+
+772 
+u_ch
+ *
+bp
+, *
+
+, *
+
+;
+
+774 
+bp
+ = 
+
+ = 
+	`mtod
+(
+m
+, 
+u_ch
+ *);
+
+775 
+
+ = 
+
+ + 
+m
+->
+m_n
+;
+
+776 
+
+ < 
+
+) {
+
+782 
+
+ < 
+
+) {
+
+783 *
+
+++) {
+
+784 
+FRAME_ESCAPE
+:
+
+785 
+FRAME_END
+:
+
+786 
+
+--;
+
+787 
+out
+;
+
+790 
+out
+:
+
+791 i(
+
+ > 
+bp
+) {
+
+796 i(
+	`b_to_q
+(
+bp
+, 
+
+ - bp, &
+
+->
+t_outq
+))
+
+798 
+sc
+->
+sc_if
+.
+if_obys
+ +
+
+ - 
+bp
+;
+
+806 i(
+
+ < 
+
+) {
+
+807 i(
+	`putc
+(
+FRAME_ESCAPE
+, &
+
+->
+t_outq
+))
+
+809 i(
+	`putc
+(*
+
+++ =
+FRAME_ESCAPE
+ ?
+
+810 
+TRANS_FRAME_ESCAPE
+ :
+
+811 
+TRANS_FRAME_END
+,
+
+812 &
+
+->
+t_outq
+)) {
+
+813 ()
+	`uutc
+(&
+
+->
+t_outq
+);
+
+816 
+sc
+->
+sc_if
+.
+if_obys
+ += 2;
+
+818 
+bp
+ = 
+
+;
+
+820 
+	`MFREE
+(
+m
+, 
+m2
+);
+
+821 
+m
+ = 
+m2
+;
+
+824 i(
+	`putc
+(
+FRAME_END
+, &
+
+->
+t_outq
+)) {
+
+833 ()
+	`uutc
+(&
+
+->
+t_outq
+);
+
+834 ()
+	`putc
+(
+FRAME_END
+, &
+
+->
+t_outq
+);
+
+835 
+sc
+->
+sc_if
+.
+if_clisis
+++;
+
+837 
+sc
+->
+sc_if
+.
+if_obys
+++;
+
+838 
+sc
+->
+sc_if
+.
+if_acks
+++;
+
+845 (*
+
+->
+t_roc
+)(tp);
+
+846 
+	`lx
+(
+s
+);
+
+853 
+s
+ = 
+	`ty
+();
+
+854 
+	`IF_DEQUEUE
+(&
+sc
+->
+sc_q
+, 
+m
+);
+
+855 
+	`lx
+(
+s
+);
+
+856 i(
+m
+ =
+NULL
+)
+
+858 
+pktt
+ = 
+	`mtod
+(
+m
+, 
+u_ch
+ *);
+
+859 
+n
+ = 
+m
+->
+m_pkthdr
+.len;
+
+860 i(
+sc
+->
+sc_if
+.
+if_bpf
+) {
+
+869 
+	`memy
+(
+chdr
+, 
+pktt
+, 
+CHDR_LEN
+);
+
+871 #ifde
+INET
+
+
+872 i((
+c
+ = (*
+pktt
+ & 0xf0)!(
+IPVERSION
+ << 4)) {
+
+873 i(
+c
+ & 0x80)
+
+874 
+c
+ = 
+TYPE_COMPRESSED_TCP
+;
+
+875 i(
+c
+ =
+TYPE_UNCOMPRESSED_TCP
+)
+
+876 *
+pktt
+ &= 0x4f;
+
+886 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+SC_COMPRESS
+) {
+
+887 
+n
+ = 
+	`_uncomess_t
+(&
+pktt
+,en,
+
+888 (
+u_t
+)
+c
+, &
+sc
+->
+sc_comp
+);
+
+889 i(
+n
+ <= 0) {
+
+890 
+	`m_m
+(
+m
+);
+
+893 } i((
+sc
+->
+sc_if
+.
+if_ags
+ & 
+SC_AUTOCOMP
+) &&
+
+894 
+c
+ =
+TYPE_UNCOMPRESSED_TCP
+ && 
+n
+ >= 40) {
+
+895 
+n
+ = 
+	`_uncomess_t
+(&
+pktt
+,en,
+
+896 (
+u_t
+)
+c
+, &
+sc
+->
+sc_comp
+);
+
+897 i(
+n
+ <= 0) {
+
+898 
+	`m_m
+(
+m
+);
+
+901 
+sc
+->
+sc_if
+.
+if_ags
+ |
+SC_COMPRESS
+;
+
+903 
+	`m_m
+(
+m
+);
+
+908 
+m
+->
+m_da
+ = (*
+pktt
+;
+
+909 
+m
+->
+m_pkthdr
+.
+n
+ = m->
+m_n
+ =en;
+
+910 i(
+sc
+->
+sc_if
+.
+if_bpf
+) {
+
+911 
+	`bpf_mp__
+(&
+sc
+->
+sc_if
+, 
+chdr
+, &
+m
+);
+
+912 i(
+m
+ =
+NULL
+)
+
+920 i(
+m
+->
+m_pkthdr
+.
+n
+ < 
+MHLEN
+) {
+
+921 
+mbuf
+ *
+n
+;
+
+922 
+pk
+;
+
+924 
+	`MGETHDR
+(
+n
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+925 
+pk
+ = 
+m
+->
+m_pkthdr
+.
+n
+;
+
+926 
+	`M_MOVE_PKTHDR
+(
+n
+, 
+m
+);
+
+927 
+	`memy
+(
+	`mtod
+(
+n
+, *), mtod(
+m
+, *), 
+pk
+);
+
+928 
+n
+->
+m_n
+ = 
+m
+->m_len;
+
+929 
+	`m_m
+(
+m
+);
+
+930 
+m
+ = 
+n
+;
+
+933 
+sc
+->
+sc_if
+.
+if_acks
+++;
+
+934 
+	`gbuime
+(&
+sc
+->
+sc_ck
+);
+
+936 #ifde
+INET
+
+
+937 
+s
+ = 
+	`
+();
+
+938 i(
+	`__edi_l
+(!
+	`pktq_queue
+(
+_pktq
+, 
+m
+, 0))) {
+
+939 
+sc
+->
+sc_if
+.
+if_s
+++;
+
+940 
+sc
+->
+sc_if
+.
+if_iqdrs
+++;
+
+941 
+	`m_m
+(
+m
+);
+
+943 
+	`lx
+(
+s
+);
+
+946 
+	`mux_ex
+(
+sot_lock
+);
+
+947 
+	}
+}
+
+953 
+	$iol
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+955 
+iddr
+ *
+i
+ = (idd*)
+da
+;
+
+956 
+ieq
+ *
+i
+ = (ieq *)
+da
+;
+
+957 
+s
+ = 
+	`
+(), 
+r
+ = 0;
+
+958 
+_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+959 
+p_s
+ *
+p
+;
+
+960 
+p_comp_s
+ *
+p
+;
+
+962 
+cmd
+) {
+
+964 
+SIOCINITIFADDR
+:
+
+965 i(
+i
+->
+i_addr
+->
+_my
+ =
+AF_INET
+)
+
+966 
+i
+->
+if_ags
+ |
+IFF_UP
+;
+
+968 
+r
+ = 
+EAFNOSUPPORT
+;
+
+971 
+SIOCSIFDSTADDR
+:
+
+972 i(
+i
+->
+i_addr
+->
+_my
+ !
+AF_INET
+)
+
+973 
+r
+ = 
+EAFNOSUPPORT
+;
+
+976 
+SIOCSIFMTU
+:
+
+977 i((
+i
+->
+i_mtu
+ < 3|| (i->i_mtu > 
+SLMAX
+)) {
+
+978 
+r
+ = 
+EINVAL
+;
+
+982 
+SIOCGIFMTU
+:
+
+983 i((
+r
+ = 
+	`ifiol_comm
+(&
+sc
+->
+sc_if
+, 
+cmd
+, 
+da
+)=
+ENETRESET
+)
+
+984 
+r
+ = 0;
+
+987 
+SIOCADDMULTI
+:
+
+988 
+SIOCDELMULTI
+:
+
+989 i(
+i
+ == 0) {
+
+990 
+r
+ = 
+EAFNOSUPPORT
+;
+
+993 
+	`ieq_gaddr
+(
+cmd
+, 
+i
+)->
+_my
+) {
+
+995 #ifde
+INET
+
+
+996 
+AF_INET
+:
+
+1001 
+r
+ = 
+EAFNOSUPPORT
+;
+
+1006 
+SIOCGPPPSTATS
+:
+
+1007 
+p
+ = &((
+ieq
+ *
+da
+)->
+s
+;
+
+1008 ()
+	`memt
+(
+p
+, 0, (*psp));
+
+1009 
+p
+->
+p
+.
+p_ibys
+ = 
+sc
+->
+sc_if
+.
+if_ibys
+;
+
+1010 
+p
+->
+p
+.
+p_acks
+ = 
+sc
+->
+sc_if
+.
+if_acks
+;
+
+1011 
+p
+->
+p
+.
+p_s
+ = 
+sc
+->
+sc_if
+.
+if_s
+;
+
+1012 
+p
+->
+p
+.
+p_obys
+ = 
+sc
+->
+sc_if
+.
+if_obys
+;
+
+1013 
+p
+->
+p
+.
+p_acks
+ = 
+sc
+->
+sc_if
+.
+if_acks
+;
+
+1014 
+p
+->
+p
+.
+p_s
+ = 
+sc
+->
+sc_if
+.
+if_s
+;
+
+1015 #ifde
+INET
+
+
+1016 
+p
+->
+vj
+.
+vjs_cks
+ = 
+sc
+->
+sc_comp
+.
+s_cks
+;
+
+1017 
+p
+->
+vj
+.
+vjs_comesd
+ = 
+sc
+->
+sc_comp
+.
+s_comesd
+;
+
+1018 
+p
+->
+vj
+.
+vjs_ches
+ = 
+sc
+->
+sc_comp
+.
+s_ches
+;
+
+1019 
+p
+->
+vj
+.
+vjs_miss
+ = 
+sc
+->
+sc_comp
+.
+s_miss
+;
+
+1020 
+p
+->
+vj
+.
+vjs_uncomesd
+ = 
+sc
+->
+sc_comp
+.
+s_uncomesd
+;
+
+1021 
+p
+->
+vj
+.
+vjs_comesd
+ = 
+sc
+->
+sc_comp
+.
+s_comesd
+;
+
+1022 
+p
+->
+vj
+.
+vjs_r
+ = 
+sc
+->
+sc_comp
+.
+s_r
+;
+
+1023 
+p
+->
+vj
+.
+vjs_tosd
+ = 
+sc
+->
+sc_comp
+.
+s_tosd
+;
+
+1027 
+SIOCGPPPCSTATS
+:
+
+1028 
+p
+ = &((
+iceq
+ *
+da
+)->
+s
+;
+
+1029 ()
+	`memt
+(
+p
+, 0, (*pcp));
+
+1033 
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+);
+
+1036 
+	`lx
+(
+s
+);
+
+1037  
+r
+;
+
+1038 
+	}
+}
+
+	@if_slvar.h
+
+34 #ide
+_NET_IF_SLVAR_H_
+
+
+35 
+	#_NET_IF_SLVAR_H_
+
+
+	)
+
+43 
+	s_soc
+ {
+
+44 
+i
+ 
+	msc_if
+;
+
+45 
+	msc_un
+;
+
+46 
+ifqueue
+ 
+	msc_q
+;
+
+47 
+ifqueue
+ 
+	msc_q
+;
+
+48 
+y
+ *
+	msc_yp
+;
+
+49 
+u_ch
+ *
+	msc_mp
+;
+
+50 
+u_ch
+ *
+	msc_
+;
+
+51 
+u_ch
+ *
+	msc_pktt
+;
+
+52 
+mbuf
+ *
+	msc_mbuf
+;
+
+53 
+u_t
+ 
+	msc_ags
+;
+
+54 
+u_t
+ 
+	msc_es
+;
+
+55 
+	msc_time
+;
+
+56 
+	msc_abtcou
+;
+
+57 
+	msc_ime
+;
+
+58 
+	msc_oqn
+;
+
+59 
+	msc_imeout
+;
+
+60 *
+	msc_si
+;
+
+61 #ifde
+__NBSD__
+
+
+62 
+	msc_dbufsize
+;
+
+63 
+	msc_dbufqu
+;
+
+65 #ifde
+INET
+
+
+66 
+comess
+ 
+	msc_comp
+;
+
+68 
+btime
+ 
+	msc_ck
+;
+
+69 
+LIST_ENTRY
+(
+_soc
+
+	msc_ii
+;
+
+73 
+	#SC_ERROR
+ 0x0001
+
+	)
+
+76 
+	#SC_COMPRESS
+ 
+IFF_LINK0
+
+
+	)
+
+77 
+	#SC_NOICMP
+ 
+IFF_LINK1
+
+
+	)
+
+78 
+	#SC_AUTOCOMP
+ 
+IFF_LINK2
+
+
+	)
+
+	@if_sppp.h
+
+32 #ide
+_NET_IF_SPPP_H_
+
+
+33 
+	#_NET_IF_SPPP_H_
+
+
+	)
+
+37 
+	#SPPP_AUTHPROTO_NONE
+ 0
+
+	)
+
+38 
+	#SPPP_AUTHPROTO_PAP
+ 1
+
+	)
+
+39 
+	#SPPP_AUTHPROTO_CHAP
+ 2
+
+	)
+
+41 
+	#SPPP_AUTHFLAG_NOCALLOUT
+ 1
+
+	)
+
+43 
+	#SPPP_AUTHFLAG_NORECHALLENGE
+ 2
+
+	)
+
+45 
+	sauthcfg
+ {
+
+46 
+	miame
+[
+IFNAMSIZ
+];
+
+47 
+u_t
+ 
+	mhiuth
+;
+
+48 
+u_t
+ 
+	mmyauth
+;
+
+49 
+u_t
+ 
+	mmyme_ngth
+;
+
+50 
+u_t
+ 
+	mmy_ngth
+;
+
+51 
+u_t
+ 
+	mhiame_ngth
+;
+
+52 
+u_t
+ 
+	mhis_ngth
+;
+
+53 
+u_t
+ 
+	mmyauthags
+;
+
+54 
+u_t
+ 
+	mhiuthags
+;
+
+55 *
+	mmyme
+;
+
+56 *
+	mmy
+;
+
+57 *
+	mhiame
+;
+
+58 *
+	mhis
+;
+
+61 
+	#SPPPGETAUTHCFG
+ 
+	`_IOWR
+('i', 120, 
+authcfg
+)
+
+	)
+
+62 
+	#SPPPSETAUTHCFG
+ 
+	`_IOW
+('i', 121, 
+authcfg
+)
+
+	)
+
+64 
+	slcfg
+ {
+
+65 
+	miame
+[
+IFNAMSIZ
+];
+
+66 
+	ml_timeout
+;
+
+69 
+	#SPPPGETLCPCFG
+ 
+	`_IOWR
+('i', 122, 
+lcfg
+)
+
+	)
+
+70 
+	#SPPPSETLCPCFG
+ 
+	`_IOW
+('i', 123, 
+lcfg
+)
+
+	)
+
+77 
+	#SPPP_PHASE_DEAD
+ 0
+
+	)
+
+78 
+	#SPPP_PHASE_ESTABLISH
+ 1
+
+	)
+
+79 
+	#SPPP_PHASE_TERMINATE
+ 2
+
+	)
+
+80 
+	#SPPP_PHASE_AUTHENTICATE
+ 3
+
+	)
+
+81 
+	#SPPP_PHASE_NETWORK
+ 4
+
+	)
+
+83 
+	sus
+ {
+
+84 
+	miame
+[
+IFNAMSIZ
+];
+
+85 
+	mpha
+;
+
+88 
+	#SPPPGETSTATUS
+ 
+	`_IOWR
+('i', 124, 
+us
+)
+
+	)
+
+90 
+	su
+ {
+
+91 
+	miame
+[
+IFNAMSIZ
+];
+
+92 
+	mpha
+;
+
+93 
+	mnup
+;
+
+96 
+	#SPPPGETSTATUSNCP
+ 
+	`_IOWR
+('i', 134, 
+u
+)
+
+	)
+
+98 
+	sidtimeout
+ {
+
+99 
+	miame
+[
+IFNAMSIZ
+];
+
+100 
+time_t
+ 
+	mid_cds
+;
+
+104 
+	sidtimeout50
+ {
+
+105 
+	miame
+[
+IFNAMSIZ
+];
+
+106 
+ut32_t
+ 
+	mid_cds
+;
+
+110 
+	#SPPPGETIDLETO
+ 
+	`_IOWR
+('i', 125, 
+idtimeout
+)
+
+	)
+
+111 
+	#SPPPSETIDLETO
+ 
+	`_IOW
+('i', 126, 
+idtimeout
+)
+
+	)
+
+112 
+	#__SPPPGETIDLETO50
+ 
+	`_IOWR
+('i', 125, 
+idtimeout50
+)
+
+	)
+
+113 
+	#__SPPPSETIDLETO50
+ 
+	`_IOW
+('i', 126, 
+idtimeout50
+)
+
+	)
+
+115 
+	sauthus
+ {
+
+116 
+	miame
+[
+IFNAMSIZ
+];
+
+117 
+	mauth_us
+;
+
+118 
+	mmax_us
+;
+
+121 
+	#SPPPGETAUTHFAILURES
+ 
+	`_IOWR
+('i', 127, 
+authus
+)
+
+	)
+
+123 
+	sauthugs
+ {
+
+124 
+	miame
+[
+IFNAMSIZ
+];
+
+125 
+	mmax_us
+;
+
+127 
+	#SPPPSETAUTHFAILURE
+ 
+	`_IOW
+('i', 128, 
+authugs
+)
+
+	)
+
+130 
+	sdnsgs
+ {
+
+131 
+	miame
+[
+IFNAMSIZ
+];
+
+132 
+	mquy_dns
+;
+
+134 
+	#SPPPSETDNSOPTS
+ 
+	`_IOW
+('i', 129, 
+dnsgs
+)
+
+	)
+
+135 
+	#SPPPGETDNSOPTS
+ 
+	`_IOWR
+('i', 130, 
+dnsgs
+)
+
+	)
+
+138 
+	sdnddrs
+ {
+
+139 
+	miame
+[
+IFNAMSIZ
+];
+
+140 
+ut32_t
+ 
+	mdns
+[2];
+
+143 
+	#SPPPGETDNSADDRS
+ 
+	`_IOWR
+('i', 131, 
+dnddrs
+)
+
+	)
+
+146 
+	sklivegs
+ {
+
+147 
+	miame
+[
+IFNAMSIZ
+];
+
+148 
+u_t
+ 
+	mmaxive
+;
+
+149 
+time_t
+ 
+	mmax_neive
+;
+
+152 
+	sklivegs50
+ {
+
+153 
+	miame
+[
+IFNAMSIZ
+];
+
+154 
+u_t
+ 
+	mmaxive
+;
+
+155 
+ut32_t
+ 
+	mmax_neive
+;
+
+158 
+	#SPPPSETKEEPALIVE
+ 
+	`_IOW
+('i', 132, 
+klivegs
+)
+
+	)
+
+159 
+	#SPPPGETKEEPALIVE
+ 
+	`_IOWR
+('i', 133, 
+klivegs
+)
+
+	)
+
+160 
+	#__SPPPSETKEEPALIVE50
+ 
+	`_IOW
+('i', 132, 
+klivegs50
+)
+
+	)
+
+161 
+	#__SPPPGETKEEPALIVE50
+ 
+	`_IOWR
+('i', 133, 
+klivegs50
+)
+
+	)
+
+	@if_spppsubr.c
+
+43 
+	~<sys/cdefs.h
+>
+
+44 
+__KERNEL_RCSID
+(0, "$NetBSD: if_spppsubr.c,v 1.133 2015/05/02 14:41:32oy Exp $");
+
+46 #i
+defed
+(
+_KERNEL_OPT
+)
+
+47 
+	~"t_.h
+"
+
+48 
+	~"t_x.h
+"
+
+49 
+	~"t_modur.h
+"
+
+50 
+	~"t_comt_tbsd.h
+"
+
+54 
+	~<sys/m.h
+>
+
+55 
+	~<sys/oc.h
+>
+
+56 
+	~<sys/sym.h
+>
+
+57 
+	~<sys/kl.h
+>
+
+58 
+	~<sys/sockio.h
+>
+
+59 
+	~<sys/sock.h
+>
+
+60 
+	~<sys/syog.h
+>
+
+61 
+	~<sys/mloc.h
+>
+
+62 
+	~<sys/mbuf.h
+>
+
+63 
+	~<sys/out.h
+>
+
+64 
+	~<sys/md5.h
+>
+
+65 
+	~<sys/ys.h
+>
+
+66 
+	~<sys/kauth.h
+>
+
+67 
+	~<sys/g.h
+>
+
+69 
+	~<t/if.h
+>
+
+70 
+	~<t/ti.h
+>
+
+71 
+	~<t/if_tys.h
+>
+
+72 
+	~<t/rou.h
+>
+
+73 
+	~<t/p_defs.h
+>
+
+75 
+	~<t/.h
+>
+
+76 
+	~<t/_sym.h
+>
+
+77 
+	~<t/_v.h
+>
+
+78 #ifde
+INET
+
+
+79 
+	~<t/.h
+>
+
+80 
+	~<t/t.h
+>
+
+82 
+	~<t/htys.h
+>
+
+84 #ifde
+INET6
+
+
+85 
+	~<t6/sce6_v.h
+>
+
+88 #ifde
+IPX
+
+
+89 
+	~<tx/x.h
+>
+
+90 
+	~<tx/x_if.h
+>
+
+93 
+	~<t/if_.h
+>
+
+94 
+	~<t/if_v.h
+>
+
+96 
+	#LCP_KEEPALIVE_INTERVAL
+ 10
+
+	)
+
+97 
+	#LOOPALIVECNT
+ 3
+
+	)
+
+98 
+	#DEFAULT_MAXALIVECNT
+ 3
+
+	)
+
+99 
+	#DEFAULT_NORECV_TIME
+ 15
+
+	)
+
+100 
+	#DEFAULT_MAX_AUTH_FAILURES
+ 5
+
+	)
+
+123 
+	#IFF_PASSIVE
+ 
+IFF_LINK0
+
+
+	)
+
+124 
+	#IFF_AUTO
+ 
+IFF_LINK1
+
+
+	)
+
+126 
+	#CONF_REQ
+ 1
+
+	)
+
+127 
+	#CONF_ACK
+ 2
+
+	)
+
+128 
+	#CONF_NAK
+ 3
+
+	)
+
+129 
+	#CONF_REJ
+ 4
+
+	)
+
+130 
+	#TERM_REQ
+ 5
+
+	)
+
+131 
+	#TERM_ACK
+ 6
+
+	)
+
+132 
+	#CODE_REJ
+ 7
+
+	)
+
+133 
+	#PROTO_REJ
+ 8
+
+	)
+
+134 
+	#ECHO_REQ
+ 9
+
+	)
+
+135 
+	#ECHO_REPLY
+ 10
+
+	)
+
+136 
+	#DISC_REQ
+ 11
+
+	)
+
+138 
+	#LCP_OPT_MRU
+ 1
+
+	)
+
+139 
+	#LCP_OPT_ASYNC_MAP
+ 2
+
+	)
+
+140 
+	#LCP_OPT_AUTH_PROTO
+ 3
+
+	)
+
+141 
+	#LCP_OPT_QUAL_PROTO
+ 4
+
+	)
+
+142 
+	#LCP_OPT_MAGIC
+ 5
+
+	)
+
+143 
+	#LCP_OPT_RESERVED
+ 6
+
+	)
+
+144 
+	#LCP_OPT_PROTO_COMP
+ 7
+
+	)
+
+145 
+	#LCP_OPT_ADDR_COMP
+ 8
+
+	)
+
+147 
+	#IPCP_OPT_ADDRESSES
+ 1
+
+	)
+
+148 
+	#IPCP_OPT_COMPRESSION
+ 2
+
+	)
+
+149 
+	#IPCP_OPT_ADDRESS
+ 3
+
+	)
+
+150 
+	#IPCP_OPT_PRIMDNS
+ 129
+
+	)
+
+151 
+	#IPCP_OPT_SECDNS
+ 131
+
+	)
+
+153 
+	#IPV6CP_OPT_IFID
+ 1
+
+	)
+
+154 
+	#IPV6CP_OPT_COMPRESSION
+ 2
+
+	)
+
+156 
+	#PAP_REQ
+ 1
+
+	)
+
+157 
+	#PAP_ACK
+ 2
+
+	)
+
+158 
+	#PAP_NAK
+ 3
+
+	)
+
+160 
+	#CHAP_CHALLENGE
+ 1
+
+	)
+
+161 
+	#CHAP_RESPONSE
+ 2
+
+	)
+
+162 
+	#CHAP_SUCCESS
+ 3
+
+	)
+
+163 
+	#CHAP_FAILURE
+ 4
+
+	)
+
+165 
+	#CHAP_MD5
+ 5
+
+	)
+
+167 
+	#CISCO_MULTICAST
+ 0x8
+
+	)
+
+168 
+	#CISCO_UNICAST
+ 0x0
+
+	)
+
+169 
+	#CISCO_KEEPALIVE
+ 0x8035
+
+	)
+
+170 
+	#CISCO_ADDR_REQ
+ 0
+
+	)
+
+171 
+	#CISCO_ADDR_REPLY
+ 1
+
+	)
+
+172 
+	#CISCO_KEEPALIVE_REQ
+ 2
+
+	)
+
+175 
+	#STATE_INITIAL
+ 0
+
+	)
+
+176 
+	#STATE_STARTING
+ 1
+
+	)
+
+177 
+	#STATE_CLOSED
+ 2
+
+	)
+
+178 
+	#STATE_STOPPED
+ 3
+
+	)
+
+179 
+	#STATE_CLOSING
+ 4
+
+	)
+
+180 
+	#STATE_STOPPING
+ 5
+
+	)
+
+181 
+	#STATE_REQ_SENT
+ 6
+
+	)
+
+182 
+	#STATE_ACK_RCVD
+ 7
+
+	)
+
+183 
+	#STATE_ACK_SENT
+ 8
+
+	)
+
+184 
+	#STATE_OPENED
+ 9
+
+	)
+
+186 
+	sp_hd
+ {
+
+187 
+ut8_t
+ 
+	maddss
+;
+
+188 
+ut8_t
+ 
+	mc
+;
+
+189 
+ut16_t
+ 
+	moc
+;
+
+190 } 
+	g__cked
+;
+
+191 
+	#PPP_HEADER_LEN
+  (
+p_hd
+)
+
+	)
+
+193 
+	sl_hd
+ {
+
+194 
+ut8_t
+ 
+	mty
+;
+
+195 
+ut8_t
+ 
+	midt
+;
+
+196 
+ut16_t
+ 
+	mn
+;
+
+197 } 
+	g__cked
+;
+
+198 
+	#LCP_HEADER_LEN
+  (
+l_hd
+)
+
+	)
+
+200 
+	scisco_ck
+ {
+
+201 
+ut32_t
+ 
+	mty
+;
+
+202 
+ut32_t
+ 
+	mr1
+;
+
+203 
+ut32_t
+ 
+	mr2
+;
+
+204 
+ut16_t
+ 
+	ml
+;
+
+205 
+ut16_t
+ 
+	mtime0
+;
+
+206 
+ut16_t
+ 
+	mtime1
+;
+
+207 } 
+	g__cked
+;
+
+208 
+	#CISCO_PACKET_LEN
+ 18
+
+	)
+
+216 
+	s
+ {
+
+217 
+u_sht
+ 
+	mo
+;
+
+218 
+u_ch
+ 
+	moidx
+;
+
+219 
+u_ch
+ 
+	mags
+;
+
+220 
+	#CP_LCP
+ 0x01
+
+	)
+
+221 
+	#CP_AUTH
+ 0x02
+
+	)
+
+222 
+	#CP_NCP
+ 0x04
+
+	)
+
+223 
+	#CP_QUAL
+ 0x08
+
+	)
+
+224 c *
+	mme
+;
+
+226 (*
+	mUp
+)(
+
+ *
+	m
+);
+
+227 (*
+	mDown
+)(
+
+ *
+	m
+);
+
+228 (*
+	mOn
+)(
+
+ *
+	m
+);
+
+229 (*
+	mClo
+)(
+
+ *
+	m
+);
+
+230 (*
+	mTO
+)(*
+	m
+);
+
+231 (*
+	mRCR
+)(
+
+ *
+	m
+, 
+l_hd
+ *
+	mh
+, 
+	mn
+);
+
+232 (*
+	mRCN_j
+)(
+
+ *
+	m
+, 
+l_hd
+ *
+	mh
+, 
+	mn
+);
+
+233 (*
+	mRCN_k
+)(
+
+ *
+	m
+, 
+l_hd
+ *
+	mh
+, 
+	mn
+);
+
+235 (*
+	mu
+)(
+
+ *
+	m
+);
+
+236 (*
+	md
+)(
+
+ *
+	m
+);
+
+237 (*
+	ms
+)(
+
+ *
+	m
+);
+
+238 (*
+	mf
+)(
+
+ *
+	m
+);
+
+239 (*
+	ms
+)(
+
+ *
+	m
+);
+
+242 
+
+ *
+	gq
+;
+
+243 
+out_t
+ 
+	gklive_ch
+;
+
+245 #ifde
+INET
+
+
+254 
+u_sht
+ 
+	give_pts
+[8] = {
+
+258 
+	#INTERACTIVE
+(
+p
+(
+ive_pts
+[& 7] =))
+
+	)
+
+262 
+	#STDDCL
+ \
+
+263 
+i
+ *
+i
+ = &
+
+->
+_if
+; \
+
+264 
+debug
+ = 
+i
+->
+if_ags
+ & 
+IFF_DEBUG
+
+
+	)
+
+266 
+_ouut
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+,
+
+267 c 
+sockaddr
+ *
+d
+, 
+y
+ *
+
+);
+
+269 
+_cisco_nd
+(
+
+ *
+
+, 
+ty
+, 
+t32_t
+ 
+r1
+, i32_
+r2
+);
+
+270 
+_cisco_put
+(
+
+ *
+
+, 
+mbuf
+ *
+m
+);
+
+272 
+__put
+(c 
+
+ *, 
+
+ *
+
+,
+
+273 
+mbuf
+ *
+m
+);
+
+274 
+__nd
+(
+
+ *
+
+, 
+u_sht
+ 
+o
+, 
+u_ch
+ 
+ty
+,
+
+275 
+u_ch
+ 
+idt
+, 
+u_sht
+ 
+n
+, *
+da
+);
+
+277 
+__chge_e
+(c 
+
+ *, 
+
+ *
+
+,
+
+278 
+we
+);
+
+279 
+_auth_nd
+(c 
+
+ *cp,
+
+280 
+
+ *
+
+, 
+ty
+, 
+id
+,
+
+283 
+_up_evt
+(c 
+
+ *, 
+
+ *
+
+);
+
+284 
+_down_evt
+(c 
+
+ *, 
+
+ *
+
+);
+
+285 
+__evt
+(c 
+
+ *, 
+
+ *
+
+);
+
+286 
+_o_evt
+(c 
+
+ *, 
+
+ *
+
+);
+
+287 
+_to_evt
+(c 
+
+ *, 
+
+ *
+
+);
+
+289 
+_nu
+(
+
+ *
+
+);
+
+291 
+_l_
+(
+
+ *
+
+);
+
+292 
+_l_up
+(
+
+ *
+
+);
+
+293 
+_l_down
+(
+
+ *
+
+);
+
+294 
+_l_
+(
+
+ *
+
+);
+
+295 
+_l_o
+(
+
+ *
+
+);
+
+296 
+_l_TO
+(*
+
+);
+
+297 
+_l_RCR
+(
+
+ *
+
+, 
+l_hd
+ *
+h
+, 
+n
+);
+
+298 
+_l_RCN_j
+(
+
+ *
+
+, 
+l_hd
+ *
+h
+, 
+n
+);
+
+299 
+_l_RCN_k
+(
+
+ *
+
+, 
+l_hd
+ *
+h
+, 
+n
+);
+
+300 
+_l_u
+(
+
+ *
+
+);
+
+301 
+_l_d
+(
+
+ *
+
+);
+
+302 
+_l_s
+(
+
+ *
+
+);
+
+303 
+_l_f
+(
+
+ *
+
+);
+
+304 
+_l_s
+(
+
+ *
+
+);
+
+305 
+_l_check_d_o
+(
+
+ *
+
+);
+
+306 
+_n_check
+(
+
+ *
+
+);
+
+308 
+__
+(
+
+ *
+
+);
+
+309 
+__up
+(
+
+ *
+
+);
+
+310 
+__down
+(
+
+ *
+
+);
+
+311 
+__
+(
+
+ *
+
+);
+
+312 
+__o
+(
+
+ *
+
+);
+
+313 
+__TO
+(*
+
+);
+
+314 
+__RCR
+(
+
+ *
+
+, 
+l_hd
+ *
+h
+, 
+n
+);
+
+315 
+__RCN_j
+(
+
+ *
+
+, 
+l_hd
+ *
+h
+, 
+n
+);
+
+316 
+__RCN_k
+(
+
+ *
+
+, 
+l_hd
+ *
+h
+, 
+n
+);
+
+317 
+__u
+(
+
+ *
+
+);
+
+318 
+__d
+(
+
+ *
+
+);
+
+319 
+__s
+(
+
+ *
+
+);
+
+320 
+__f
+(
+
+ *
+
+);
+
+321 
+__s
+(
+
+ *
+
+);
+
+323 
+_v6_
+(
+
+ *
+
+);
+
+324 
+_v6_up
+(
+
+ *
+
+);
+
+325 
+_v6_down
+(
+
+ *
+
+);
+
+326 
+_v6_
+(
+
+ *
+
+);
+
+327 
+_v6_o
+(
+
+ *
+
+);
+
+328 
+_v6_TO
+(*
+
+);
+
+329 
+_v6_RCR
+(
+
+ *
+
+, 
+l_hd
+ *
+h
+, 
+n
+);
+
+330 
+_v6_RCN_j
+(
+
+ *
+
+, 
+l_hd
+ *
+h
+, 
+n
+);
+
+331 
+_v6_RCN_k
+(
+
+ *
+
+, 
+l_hd
+ *
+h
+, 
+n
+);
+
+332 
+_v6_u
+(
+
+ *
+
+);
+
+333 
+_v6_d
+(
+
+ *
+
+);
+
+334 
+_v6_s
+(
+
+ *
+
+);
+
+335 
+_v6_f
+(
+
+ *
+
+);
+
+336 
+_v6_s
+(
+
+ *
+
+);
+
+338 
+_p_put
+(
+
+ *
+
+, 
+mbuf
+ *
+m
+);
+
+339 
+_p_
+(
+
+ *
+
+);
+
+340 
+_p_
+(
+
+ *
+
+);
+
+341 
+_p_o
+(
+
+ *
+
+);
+
+342 
+_p_TO
+(*
+
+);
+
+343 
+_p_my_TO
+(*
+
+);
+
+344 
+_p_u
+(
+
+ *
+
+);
+
+345 
+_p_d
+(
+
+ *
+
+);
+
+346 
+_p_s
+(
+
+ *
+
+);
+
+348 
+_ch_put
+(
+
+ *
+
+, 
+mbuf
+ *
+m
+);
+
+349 
+_ch_
+(
+
+ *
+
+);
+
+350 
+_ch_
+(
+
+ *
+
+);
+
+351 
+_ch_o
+(
+
+ *
+
+);
+
+352 
+_ch_TO
+(*
+
+);
+
+353 
+_ch_u
+(
+
+ *
+
+);
+
+354 
+_ch_d
+(
+
+ *
+
+);
+
+355 
+_ch_s
+(
+
+ *
+
+);
+
+357 c *
+_auth_ty_me
+(
+u_sht
+ 
+o
+, 
+u_ch
+ 
+ty
+);
+
+358 c *
+__ty_me
+(
+u_ch
+ 
+ty
+);
+
+359 c *
+_dd_quad
+(
+ut32_t
+ 
+addr
+);
+
+360 c *
+__t_me
+(
+u_ch
+ 
+t
+);
+
+361 #ifde
+INET6
+
+
+362 c *
+_v6_t_me
+(
+u_ch
+ 
+t
+);
+
+364 c *
+_l_t_me
+(
+u_ch
+ 
+t
+);
+
+365 c *
+_pha_me
+(
+pha
+);
+
+366 c *
+_o_me
+(
+u_sht
+ 
+o
+);
+
+367 c *
+_e_me
+(
+e
+);
+
+368 
+_ms
+(
+
+ *
+
+, 
+u_lg
+ 
+cmd
+, *
+da
+);
+
+369 #ifde
+INET
+
+
+370 
+_g__addrs
+(
+
+ *
+
+, 
+ut32_t
+ *
+c
+, ut32_*
+d
+,
+
+371 
+ut32_t
+ *
+cmask
+);
+
+372 
+_t__addrs
+(
+
+ *
+
+, 
+ut32_t
+ 
+myaddr
+, ut32_
+hiddr
+);
+
+373 
+_r__addrs
+(
+
+ *
+
+);
+
+375 
+_klive
+(*
+dummy
+);
+
+376 
+_pha_twk
+(
+
+ *
+
+);
+
+377 
+_t_bys
+(c 
+u_ch
+ *
+p
+, 
+u_sht
+ 
+n
+);
+
+378 
+_t_rg
+(c *
+p
+, 
+u_sht
+ 
+n
+);
+
+379 #ifde
+INET6
+
+
+380 
+_g_6_addrs
+(
+
+ *
+
+, 
+6_addr
+ *
+c
+,
+
+381 
+6_addr
+ *
+d
+, 6_add*
+cmask
+);
+
+382 #ifde
+IPV6CP_MYIFID_DYN
+
+
+383 
+_t_6_addr
+(
+
+ *
+
+, c 
+6_addr
+ *
+c
+);
+
+384 
+_g_6_addr
+(
+
+ *
+
+, c 
+6_addr
+ *
+c
+);
+
+386 
+_sugge_6_addr
+(
+
+ *
+
+, 
+6_addr
+ *
+c
+);
+
+390 c 
+
+ 
+	gl
+ = {
+
+391 
+PPP_LCP
+, 
+IDX_LCP
+, 
+CP_LCP
+, "lcp",
+
+392 
+_l_up
+, 
+_l_down
+, 
+_l_
+, 
+_l_o
+,
+
+393 
+_l_TO
+, 
+_l_RCR
+, 
+_l_RCN_j
+, 
+_l_RCN_k
+,
+
+394 
+_l_u
+, 
+_l_d
+, 
+_l_s
+, 
+_l_f
+,
+
+395 
+_l_s
+
+
+398 c 
+
+ 
+	g
+ = {
+
+399 
+PPP_IPCP
+, 
+IDX_IPCP
+,
+
+400 #ifde
+INET
+
+
+401 
+CP_NCP
+,
+
+406 
+__up
+, 
+__down
+, 
+__
+, 
+__o
+,
+
+407 
+__TO
+, 
+__RCR
+, 
+__RCN_j
+, 
+__RCN_k
+,
+
+408 
+__u
+, 
+__d
+, 
+__s
+, 
+__f
+,
+
+409 
+__s
+
+
+412 c 
+
+ 
+	gv6
+ = {
+
+413 
+PPP_IPV6CP
+, 
+IDX_IPV6CP
+,
+
+414 #ifde
+INET6
+
+
+415 
+CP_NCP
+,
+
+420 
+_v6_up
+, 
+_v6_down
+, 
+_v6_
+, 
+_v6_o
+,
+
+421 
+_v6_TO
+, 
+_v6_RCR
+, 
+_v6_RCN_j
+, 
+_v6_RCN_k
+,
+
+422 
+_v6_u
+, 
+_v6_d
+, 
+_v6_s
+, 
+_v6_f
+,
+
+423 
+_v6_s
+
+
+426 c 
+
+ 
+	gp
+ = {
+
+427 
+PPP_PAP
+, 
+IDX_PAP
+, 
+CP_AUTH
+, "pap",
+
+428 
+_nu
+, sp_nu, 
+_p_
+, 
+_p_o
+,
+
+429 
+_p_TO
+, 0, 0, 0,
+
+430 
+_p_u
+, 
+_p_d
+, 
+_nu
+, sppp_null,
+
+431 
+_p_s
+
+
+434 c 
+
+ 
+	gch
+ = {
+
+435 
+PPP_CHAP
+, 
+IDX_CHAP
+, 
+CP_AUTH
+, "chap",
+
+436 
+_nu
+, sp_nu, 
+_ch_
+, 
+_ch_o
+,
+
+437 
+_ch_TO
+, 0, 0, 0,
+
+438 
+_ch_u
+, 
+_ch_d
+, 
+_nu
+, sppp_null,
+
+439 
+_ch_s
+
+
+442 c 
+
+ *
+	gs
+[
+IDX_COUNT
+] = {
+
+443 &
+l
+,
+
+444 &
+
+,
+
+445 &
+v6
+,
+
+446 &
+p
+,
+
+447 &
+ch
+,
+
+451 
+ch
+();
+
+454 
+	$ch
+(
+cou
+)
+
+456 
+	}
+}
+
+466 
+	$_put
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+)
+
+468 
+p_hd
+ *
+h
+ = 
+NULL
+;
+
+469 
+pktqueue_t
+ *
+pktq
+ = 
+NULL
+;
+
+470 
+ifqueue
+ *
+q
+ = 
+NULL
+;
+
+471 
+ut16_t
+ 
+oc
+;
+
+472 
+s
+;
+
+473 
+
+ *
+
+ = ( *)
+i
+;
+
+474 
+debug
+ = 
+i
+->
+if_ags
+ & 
+IFF_DEBUG
+;
+
+475 
+i
+ = 0;
+
+477 i(
+i
+->
+if_ags
+ & 
+IFF_UP
+) {
+
+479 
+i
+->
+if_ibys
+ +
+m
+->
+m_pkthdr
+.
+n
+ + 
+
+->
+_amebys
+;
+
+481 
+
+->
+__ive
+ = 
+time_uime
+;
+
+484 i(
+m
+->
+m_pkthdr
+.
+n
+ <
+PPP_HEADER_LEN
+) {
+
+486 i(
+debug
+)
+
+487 
+	`log
+(
+LOG_DEBUG
+,
+
+489 
+i
+->
+if_xme
+, 
+m
+->
+m_pkthdr
+.
+n
+);
+
+490 
+dr
+:
+
+491 ++
+i
+->
+if_s
+;
+
+492 ++
+i
+->
+if_iqdrs
+;
+
+493 
+	`m_m
+(
+m
+);
+
+497 i(
+
+->
+_ags
+ & 
+PP_NOFRAMING
+) {
+
+498 
+	`memy
+(&
+oc
+, 
+	`mtod
+(
+m
+, *), 2);
+
+499 
+oc
+ = 
+	`ohs
+(protocol);
+
+500 
+	`m_adj
+(
+m
+, 2);
+
+504 
+h
+ = 
+	`mtod
+(
+m
+, 
+p_hd
+ *);
+
+505 
+	`m_adj
+(
+m
+, 
+PPP_HEADER_LEN
+);
+
+507 
+h
+->
+addss
+) {
+
+508 
+PPP_ALLSTATIONS
+:
+
+509 i(
+h
+->
+c
+ !
+PPP_UI
+)
+
+510 
+vid
+;
+
+511 i(
+
+->
+_ags
+ & 
+PP_CISCO
+) {
+
+512 i(
+debug
+)
+
+513 
+	`log
+(
+LOG_DEBUG
+,
+
+516 
+i
+->
+if_xme
+,
+
+517 
+h
+->
+addss
+, h->
+c
+, 
+	`ohs
+(h->
+oc
+));
+
+518 
+dr
+;
+
+521 
+CISCO_MULTICAST
+:
+
+522 
+CISCO_UNICAST
+:
+
+524 i(! (
+
+->
+_ags
+ & 
+PP_CISCO
+)) {
+
+525 i(
+debug
+)
+
+526 
+	`log
+(
+LOG_DEBUG
+,
+
+529 
+i
+->
+if_xme
+,
+
+530 
+h
+->
+addss
+, h->
+c
+, 
+	`ohs
+(h->
+oc
+));
+
+531 
+dr
+;
+
+533 
+	`ohs
+(
+h
+->
+oc
+)) {
+
+535 ++
+i
+->
+if_nro
+;
+
+536 
+vid
+;
+
+537 
+CISCO_KEEPALIVE
+:
+
+538 
+	`_cisco_put
+((
+
+ *
+i
+, 
+m
+);
+
+539 
+	`m_m
+(
+m
+);
+
+541 #ifde
+INET
+
+
+542 
+ETHERTYPE_IP
+:
+
+543 
+pktq
+ = 
+_pktq
+;
+
+546 #ifde
+INET6
+
+
+547 
+ETHERTYPE_IPV6
+:
+
+548 
+pktq
+ = 
+6_pktq
+;
+
+551 #ifde
+IPX
+
+
+552 
+ETHERTYPE_IPX
+:
+
+553 
+i
+ = 
+NETISR_IPX
+;
+
+554 
+q
+ = &
+xq
+;
+
+558 
+queue_pkt
+;
+
+560 
+vid
+:
+
+561 i(
+debug
+)
+
+562 
+	`log
+(
+LOG_DEBUG
+,
+
+565 
+i
+->
+if_xme
+,
+
+566 
+h
+->
+addss
+, h->
+c
+, 
+	`ohs
+(h->
+oc
+));
+
+567 
+dr
+;
+
+569 
+oc
+ = 
+	`ohs
+(
+h
+->protocol);
+
+572 
+oc
+) {
+
+574 i(
+
+->
+e
+[
+IDX_LCP
+] =
+STATE_OPENED
+) {
+
+575 
+ut16_t
+ 
+
+ = 
+	`hts
+(
+oc
+);
+
+576 
+	`__nd
+(
+
+, 
+PPP_LCP
+, 
+PROTO_REJ
+,
+
+577 ++
+
+->
+_q
+[
+IDX_LCP
+], 
+m
+->
+m_pkthdr
+.
+n
+ + 2,
+
+578 &
+
+);
+
+580 i(
+debug
+)
+
+581 
+	`log
+(
+LOG_DEBUG
+,
+
+583 "<o=0x%x>\n", 
+i
+->
+if_xme
+, 
+	`ohs
+(
+oc
+));
+
+584 ++
+i
+->
+if_nro
+;
+
+585 
+dr
+;
+
+586 
+PPP_LCP
+:
+
+587 
+	`__put
+(&
+l
+, 
+
+, 
+m
+);
+
+588 
+	`m_m
+(
+m
+);
+
+590 
+PPP_PAP
+:
+
+591 i(
+
+->
+_pha
+ >
+SPPP_PHASE_AUTHENTICATE
+)
+
+592 
+	`_p_put
+(
+
+, 
+m
+);
+
+593 
+	`m_m
+(
+m
+);
+
+595 
+PPP_CHAP
+:
+
+596 i(
+
+->
+_pha
+ >
+SPPP_PHASE_AUTHENTICATE
+)
+
+597 
+	`_ch_put
+(
+
+, 
+m
+);
+
+598 
+	`m_m
+(
+m
+);
+
+600 #ifde
+INET
+
+
+601 
+PPP_IPCP
+:
+
+602 i(
+
+->
+_pha
+ =
+SPPP_PHASE_NETWORK
+)
+
+603 
+	`__put
+(&
+
+, 
+
+, 
+m
+);
+
+604 
+	`m_m
+(
+m
+);
+
+606 
+PPP_IP
+:
+
+607 i(
+
+->
+e
+[
+IDX_IPCP
+] =
+STATE_OPENED
+) {
+
+608 
+
+->
+__aivy
+ = 
+time_uime
+;
+
+609 
+pktq
+ = 
+_pktq
+;
+
+613 #ifde
+INET6
+
+
+614 
+PPP_IPV6CP
+:
+
+615 i(
+
+->
+_pha
+ =
+SPPP_PHASE_NETWORK
+)
+
+616 
+	`__put
+(&
+v6
+, 
+
+, 
+m
+);
+
+617 
+	`m_m
+(
+m
+);
+
+620 
+PPP_IPV6
+:
+
+621 i(
+
+->
+e
+[
+IDX_IPV6CP
+] =
+STATE_OPENED
+) {
+
+622 
+
+->
+__aivy
+ = 
+time_uime
+;
+
+623 
+pktq
+ = 
+6_pktq
+;
+
+627 #ifde
+IPX
+
+
+628 
+PPP_IPX
+:
+
+630 i(
+
+->
+_pha
+ =
+SPPP_PHASE_NETWORK
+) {
+
+631 
+i
+ = 
+NETISR_IPX
+;
+
+632 
+q
+ = &
+xq
+;
+
+638 
+queue_pkt
+:
+
+639 i((
+i
+->
+if_ags
+ & 
+IFF_UP
+=0 || (!
+q
+ && !
+pktq
+)) {
+
+640 
+dr
+;
+
+644 i(
+	`__edi_ue
+(
+pktq
+)) {
+
+645 i(
+	`__edi_l
+(!
+	`pktq_queue
+(
+pktq
+, 
+m
+, 0))) {
+
+646 
+dr
+;
+
+651 
+s
+ = 
+	`
+();
+
+652 i(
+	`IF_QFULL
+(
+q
+)) {
+
+654 
+	`IF_DROP
+(
+q
+);
+
+655 
+	`lx
+(
+s
+);
+
+656 i(
+debug
+)
+
+657 
+	`log
+(
+LOG_DEBUG
+, "%s:rotocol queue overflow\n",
+
+658 
+i
+->
+if_xme
+);
+
+659 
+dr
+;
+
+661 
+	`IF_ENQUEUE
+(
+q
+, 
+m
+);
+
+662 
+	`schedti
+(
+i
+);
+
+663 
+	`lx
+(
+s
+);
+
+664 
+	}
+}
+
+670 
+	$_ouut
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+,
+
+671 c 
+sockaddr
+ *
+d
+, 
+y
+ *
+
+)
+
+673 
+
+ *
+
+ = ( *
+i
+;
+
+674 
+p_hd
+ *
+h
+ = 
+NULL
+;
+
+675 
+ifqueue
+ *
+ifq
+ = 
+NULL
+;
+
+676 
+s
+, 
+r
+ = 0;
+
+677 
+ut16_t
+ 
+oc
+;
+
+678 
+	`ALTQ_DECL
+(
+tq_pkr
+ 
+pkr
+;)
+
+680 
+s
+ = 
+	`
+();
+
+682 
+
+->
+__aivy
+ = 
+time_uime
+;
+
+684 i((
+i
+->
+if_ags
+ & 
+IFF_UP
+) == 0 ||
+
+685 (
+i
+->
+if_ags
+ & (
+IFF_RUNNING
+ | 
+IFF_AUTO
+)) == 0) {
+
+686 
+	`m_m
+(
+m
+);
+
+687 
+	`lx
+(
+s
+);
+
+688  (
+ENETDOWN
+);
+
+691 i((
+i
+->
+if_ags
+ & (
+IFF_RUNNING
+ | 
+IFF_AUTO
+)) == IFF_AUTO) {
+
+696 
+i
+->
+if_ags
+ |
+IFF_RUNNING
+;
+
+697 
+	`lx
+(
+s
+);
+
+698 
+l
+.
+	`On
+(
+
+);
+
+699 
+s
+ = 
+	`
+();
+
+706 
+	`IFQ_CLASSIFY
+(&
+i
+->
+if_d
+, 
+m
+, 
+d
+->
+_my
+, &
+pkr
+);
+
+708 #ifde
+INET
+
+
+709 i(
+d
+->
+_my
+ =
+AF_INET
+) {
+
+710 
+
+ * = 
+NULL
+;
+
+711 
+thdr
+ *
+th
+ = 
+NULL
+;
+
+713 i(
+m
+->
+m_n
+ >(
+
+)) {
+
+714 
+
+ = 
+	`mtod
+(
+m
+, ip *);
+
+715 i(
+
+->
+_p
+ =
+IPPROTO_TCP
+ &&
+
+716 
+m
+->
+m_n
+ >(
+
++ (->
+_hl
+ << 2) +
+
+717 (
+thdr
+)) {
+
+718 
+th
+ = (
+thdr
+ *)
+
+719 ((*)
+
+ + (->
+_hl
+ << 2));
+
+722 
+
+ = 
+NULL
+;
+
+734 i(
+
+ && ip->
+_c
+.
+s_addr
+ =
+INADDR_ANY
+) {
+
+735 
+ut8_t
+ 
+o
+ = 
+
+->
+_p
+;
+
+737 
+	`m_m
+(
+m
+);
+
+738 
+	`lx
+(
+s
+);
+
+739 i(
+o
+ =
+IPPROTO_TCP
+)
+
+740  (
+EADDRNOTAVAIL
+);
+
+750 i(!
+	`IF_QFULL
+(&
+
+->
+_q
+) &&
+
+751 ((
+
+ && (->
+_tos
+ & 
+IPTOS_LOWDELAY
+)) ||
+
+752 (
+th
+ && (
+	`INTERACTIVE
+(
+	`ohs
+h->
+th_t
+)) ||
+
+753 
+	`INTERACTIVE
+(
+	`ohs
+(
+th
+->
+th_dpt
+))))))
+
+754 
+ifq
+ = &
+
+->
+_q
+;
+
+758 #ifde
+INET6
+
+
+759 i(
+d
+->
+_my
+ =
+AF_INET6
+) {
+
+764 i((
+
+->
+_ags
+ & 
+PP_NOFRAMING
+) == 0) {
+
+768 
+	`M_PREPEND
+(
+m
+, 
+PPP_HEADER_LEN
+, 
+M_DONTWAIT
+);
+
+769 i(! 
+m
+) {
+
+770 i(
+i
+->
+if_ags
+ & 
+IFF_DEBUG
+)
+
+771 
+	`log
+(
+LOG_DEBUG
+, "%s:o memory forransmit header\n",
+
+772 
+i
+->
+if_xme
+);
+
+773 ++
+i
+->
+if_s
+;
+
+774 
+	`lx
+(
+s
+);
+
+775  (
+ENOBUFS
+);
+
+781 
+h
+ = 
+	`mtod
+(
+m
+, 
+p_hd
+ *);
+
+782 i(
+
+->
+_ags
+ & 
+PP_CISCO
+) {
+
+783 
+h
+->
+addss
+ = 
+CISCO_UNICAST
+;
+
+784 
+h
+->
+c
+ = 0;
+
+786 
+h
+->
+addss
+ = 
+PPP_ALLSTATIONS
+;
+
+787 
+h
+->
+c
+ = 
+PPP_UI
+;
+
+791 
+d
+->
+_my
+) {
+
+792 #ifde
+INET
+
+
+793 
+AF_INET
+:
+
+794 i(
+
+->
+_ags
+ & 
+PP_CISCO
+)
+
+795 
+oc
+ = 
+	`hts
+(
+ETHERTYPE_IP
+);
+
+806 
+oc
+ = 
+	`hts
+(
+PPP_IP
+);
+
+807 i(
+
+->
+e
+[
+IDX_IPCP
+] !
+STATE_OPENED
+)
+
+808 
+r
+ = 
+ENETDOWN
+;
+
+812 #ifde
+INET6
+
+
+813 
+AF_INET6
+:
+
+814 i(
+
+->
+_ags
+ & 
+PP_CISCO
+)
+
+815 
+oc
+ = 
+	`hts
+(
+ETHERTYPE_IPV6
+);
+
+826 
+oc
+ = 
+	`hts
+(
+PPP_IPV6
+);
+
+827 i(
+
+->
+e
+[
+IDX_IPV6CP
+] !
+STATE_OPENED
+)
+
+828 
+r
+ = 
+ENETDOWN
+;
+
+832 #ifde
+IPX
+
+
+833 
+AF_IPX
+:
+
+834 
+oc
+ = 
+	`hts
+((
+
+->
+_ags
+ & 
+PP_CISCO
+) ?
+
+835 
+ETHERTYPE_IPX
+ : 
+PPP_IPX
+);
+
+839 
+	`m_m
+(
+m
+);
+
+840 ++
+i
+->
+if_s
+;
+
+841 
+	`lx
+(
+s
+);
+
+842  (
+EAFNOSUPPORT
+);
+
+845 i(
+
+->
+_ags
+ & 
+PP_NOFRAMING
+) {
+
+846 
+	`M_PREPEND
+(
+m
+, 2, 
+M_DONTWAIT
+);
+
+847 i(
+m
+ =
+NULL
+) {
+
+848 i(
+i
+->
+if_ags
+ & 
+IFF_DEBUG
+)
+
+849 
+	`log
+(
+LOG_DEBUG
+, "%s:o memory forransmit header\n",
+
+850 
+i
+->
+if_xme
+);
+
+851 ++
+i
+->
+if_s
+;
+
+852 
+	`lx
+(
+s
+);
+
+853  (
+ENOBUFS
+);
+
+855 *
+	`mtod
+(
+m
+, 
+ut16_t
+ *
+oc
+;
+
+857 
+h
+->
+oc
+ =rotocol;
+
+861 
+r
+ = 
+	`ifq_queue2
+(
+i
+, 
+ifq
+, 
+m
+ 
+ALTQ_COMMA
+ 
+	`ALTQ_DECL
+(&
+pkr
+));
+
+863 i(
+r
+ == 0) {
+
+869 i(!(
+i
+->
+if_ags
+ & 
+IFF_OACTIVE
+))
+
+870 (*
+i
+->
+if_t
+)(ifp);
+
+871 
+i
+->
+if_obys
+ +
+m
+->
+m_pkthdr
+.
+n
+ + 
+
+->
+_amebys
+;
+
+873 
+	`lx
+(
+s
+);
+
+874  
+r
+;
+
+875 
+	}
+}
+
+878 
+	$_ch
+(
+i
+ *
+i
+)
+
+880 
+
+ *
+
+ = ( *
+i
+;
+
+883 i(! 
+q
+) {
+
+884 
+	`out_
+(&
+klive_ch
+, 0);
+
+885 
+	`out_t
+(&
+klive_ch
+, 
+hz
+ * 
+LCP_KEEPALIVE_INTERVAL
+, 
+_klive
+, 
+NULL
+);
+
+889 
+
+->
+_xt
+ = 
+q
+;
+
+890 
+q
+ = 
+
+;
+
+892 
+
+->
+_if
+.
+if_ty
+ = 
+IFT_PPP
+;
+
+893 
+
+->
+_if
+.
+if_ouut
+ = 
+_ouut
+;
+
+894 
+
+->
+_q
+.
+ifq_maxn
+ = 32;
+
+895 
+
+->
+_q
+.
+ifq_maxn
+ = 20;
+
+896 
+
+->
+_lot
+ = 0;
+
+897 
+
+->
+_ivet
+ = 0;
+
+898 
+
+->
+__aivy
+ = 0;
+
+899 
+
+->
+__ive
+ = 0;
+
+900 
+
+->
+_maxive
+ = 
+DEFAULT_MAXALIVECNT
+;
+
+901 
+
+->
+_max_neive
+ = 
+DEFAULT_NORECV_TIME
+;
+
+902 
+
+->
+_id_timeout
+ = 0;
+
+903 
+	`memt
+(&
+
+->
+_q
+[0], 0, (sp->pp_seq));
+
+904 
+	`memt
+(&
+
+->
+_rq
+[0], 0, (sp->pp_rseq));
+
+905 
+
+->
+_auth_us
+ = 0;
+
+906 
+
+->
+_max_auth_
+ = 
+DEFAULT_MAX_AUTH_FAILURES
+;
+
+907 
+
+->
+_pha
+ = 
+SPPP_PHASE_DEAD
+;
+
+908 
+
+->
+_up
+ = 
+l
+.
+Up
+;
+
+909 
+
+->
+_down
+ = 
+l
+.
+Down
+;
+
+911 
+	`if_loc_dl
+(
+i
+);
+
+913 
+	`memt
+(&
+
+->
+myauth
+, 0,  sp->myauth);
+
+914 
+	`memt
+(&
+
+->
+hiuth
+, 0,  sp->hisauth);
+
+915 
+	`_l_
+(
+
+);
+
+916 
+	`__
+(
+
+);
+
+917 
+	`_v6_
+(
+
+);
+
+918 
+	`_p_
+(
+
+);
+
+919 
+	`_ch_
+(
+
+);
+
+920 
+	}
+}
+
+923 
+	$_dach
+(
+i
+ *
+i
+)
+
+925 
+
+ **
+q
+, *
+p
+, *
+
+ = ( *
+i
+;
+
+928 
+q
+ = &
+q
+; (
+p
+ = *q); q = &p->
+_xt
+)
+
+929 i(
+p
+ =
+
+) {
+
+930 *
+q
+ = 
+p
+->
+_xt
+;
+
+935 i(! 
+q
+) {
+
+936 
+	`out_
+(&
+klive_ch
+);
+
+939 
+	`out_
+(&
+
+->
+ch
+[
+IDX_LCP
+]);
+
+940 
+	`out_
+(&
+
+->
+ch
+[
+IDX_IPCP
+]);
+
+941 
+	`out_
+(&
+
+->
+ch
+[
+IDX_PAP
+]);
+
+942 
+	`out_
+(&
+
+->
+ch
+[
+IDX_CHAP
+]);
+
+943 #ifde
+INET6
+
+
+944 
+	`out_
+(&
+
+->
+ch
+[
+IDX_IPV6CP
+]);
+
+946 
+	`out_
+(&
+
+->
+p_my_to_ch
+);
+
+949 i(
+
+->
+myauth
+.
+me
+
+	`
+(->myauth.me, 
+M_DEVBUF
+);
+
+950 i(
+
+->
+myauth
+.
+
+
+	`
+(->myauth., 
+M_DEVBUF
+);
+
+951 i(
+
+->
+hiuth
+.
+me
+
+	`
+(->hiuth.me, 
+M_DEVBUF
+);
+
+952 i(
+
+->
+hiuth
+.
+
+
+	`
+(->hiuth., 
+M_DEVBUF
+);
+
+953 
+	}
+}
+
+959 
+	$_ush
+(
+i
+ *
+i
+)
+
+961 
+
+ *
+
+ = ( *
+i
+;
+
+963 
+	`IFQ_PURGE
+(&
+
+->
+_if
+.
+if_d
+);
+
+964 
+	`IF_PURGE
+(&
+
+->
+_q
+);
+
+965 
+	`IF_PURGE
+(&
+
+->
+_q
+);
+
+966 
+	}
+}
+
+972 
+	$_imy
+(
+i
+ *
+i
+)
+
+974 
+
+ *
+
+ = ( *
+i
+;
+
+975 
+emy
+, 
+s
+;
+
+977 
+s
+ = 
+	`
+();
+
+978 
+emy
+ = 
+	`IF_IS_EMPTY
+(&
+
+->
+_q
+&& IF_IS_EMPTY(&->
+_q
+) &&
+
+979 
+	`IFQ_IS_EMPTY
+(&
+
+->
+_if
+.
+if_d
+);
+
+980 
+	`lx
+(
+s
+);
+
+981  (
+emy
+);
+
+982 
+	}
+}
+
+987 
+mbuf
+ *
+
+988 
+	$_dequeue
+(
+i
+ *
+i
+)
+
+990 
+
+ *
+
+ = ( *
+i
+;
+
+991 
+mbuf
+ *
+m
+;
+
+992 
+s
+;
+
+994 
+s
+ = 
+	`
+();
+
+1001 
+	`IF_DEQUEUE
+(&
+
+->
+_q
+, 
+m
+);
+
+1002 i(
+m
+ =
+NULL
+ &&
+
+1003 (
+	`_n_check
+(
+
+|| (->
+_ags
+ & 
+PP_CISCO
+) != 0)) {
+
+1004 
+	`IF_DEQUEUE
+(&
+
+->
+_q
+, 
+m
+);
+
+1005 i(
+m
+ =
+NULL
+)
+
+1006 
+	`IFQ_DEQUEUE
+(&
+
+->
+_if
+.
+if_d
+, 
+m
+);
+
+1008 
+	`lx
+(
+s
+);
+
+1009  
+m
+;
+
+1010 
+	}
+}
+
+1016 
+	$_iol
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+1018 
+lwp
+ *
+l
+ = 
+cuwp
+;
+
+1019 
+ieq
+ *
+i
+ = (ieq *
+da
+;
+
+1020 
+iddr
+ *
+i
+ = (idd*
+da
+;
+
+1021 
+
+ *
+
+ = ( *
+i
+;
+
+1022 
+s
+, 
+r
+=0, 
+gog_up
+, 
+gog_down
+, 
+wmode
+;
+
+1024 
+s
+ = 
+	`
+();
+
+1025 
+cmd
+) {
+
+1026 
+SIOCINITIFADDR
+:
+
+1027 
+i
+->
+i_que
+ = 
+p2p_que
+;
+
+1030 
+SIOCSIFFLAGS
+:
+
+1031 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)) != 0)
+
+1033 
+gog_up
+ = 
+i
+->
+if_ags
+ & 
+IFF_UP
+ &&
+
+1034 (
+i
+->
+if_ags
+ & 
+IFF_RUNNING
+) == 0;
+
+1035 
+gog_down
+ = (
+i
+->
+if_ags
+ & 
+IFF_UP
+) == 0 &&
+
+1036 
+i
+->
+if_ags
+ & 
+IFF_RUNNING
+;
+
+1037 
+wmode
+ = 
+i
+->
+if_ags
+ & (
+IFF_AUTO
+ | 
+IFF_PASSIVE
+);
+
+1038 i(
+wmode
+ =(
+IFF_AUTO
+ | 
+IFF_PASSIVE
+)) {
+
+1040 
+wmode
+ = 
+IFF_PASSIVE
+;
+
+1041 
+i
+->
+if_ags
+ &~
+IFF_AUTO
+;
+
+1044 i(
+gog_up
+ || 
+gog_down
+)
+
+1045 
+l
+.
+	`Clo
+(
+
+);
+
+1046 i(
+gog_up
+ && 
+wmode
+ == 0) {
+
+1048 
+i
+->
+if_ags
+ |
+IFF_RUNNING
+;
+
+1049 i(!(
+
+->
+_ags
+ & 
+PP_CISCO
+))
+
+1050 
+l
+.
+	`On
+(
+
+);
+
+1051 } i(
+gog_down
+) {
+
+1052 
+	`_ush
+(
+i
+);
+
+1053 
+i
+->
+if_ags
+ &~
+IFF_RUNNING
+;
+
+1058 
+SIOCSIFMTU
+:
+
+1059 i(
+i
+->
+i_mtu
+ < 
+PPP_MINMRU
+ ||
+
+1060 
+i
+->
+i_mtu
+ > 
+
+->
+l
+.
+the_mru
+) {
+
+1061 
+r
+ = 
+EINVAL
+;
+
+1065 
+SIOCGIFMTU
+:
+
+1066 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)=
+ENETRESET
+)
+
+1067 
+r
+ = 0;
+
+1069 
+SIOCADDMULTI
+:
+
+1070 
+SIOCDELMULTI
+:
+
+1073 
+SPPPSETAUTHCFG
+:
+
+1074 
+SPPPSETLCPCFG
+:
+
+1075 
+SPPPSETIDLETO
+:
+
+1076 
+SPPPSETAUTHFAILURE
+:
+
+1077 
+SPPPSETDNSOPTS
+:
+
+1078 
+SPPPSETKEEPALIVE
+:
+
+1079 #i
+	`defed
+(
+COMPAT_50
+|| defed(
+MODULAR
+)
+
+1080 
+__SPPPSETIDLETO50
+:
+
+1081 
+__SPPPSETKEEPALIVE50
+:
+
+1083 
+r
+ = 
+	`kauth_authize_twk
+(
+l
+->
+l_ed
+,
+
+1084 
+KAUTH_NETWORK_INTERFACE
+,
+
+1085 
+KAUTH_REQ_NETWORK_INTERFACE_SETPRIV
+, 
+i
+, (*)
+cmd
+,
+
+1086 
+NULL
+);
+
+1087 i(
+r
+)
+
+1089 
+r
+ = 
+	`_ms
+(
+
+, 
+cmd
+, 
+da
+);
+
+1092 
+SPPPGETAUTHCFG
+:
+
+1093 
+SPPPGETLCPCFG
+:
+
+1094 
+SPPPGETAUTHFAILURES
+:
+
+1095 
+r
+ = 
+	`kauth_authize_twk
+(
+l
+->
+l_ed
+,
+
+1096 
+KAUTH_NETWORK_INTERFACE
+,
+
+1097 
+KAUTH_REQ_NETWORK_INTERFACE_GETPRIV
+, 
+i
+, (*)
+cmd
+,
+
+1098 
+NULL
+);
+
+1099 i(
+r
+)
+
+1101 
+r
+ = 
+	`_ms
+(
+
+, 
+cmd
+, 
+da
+);
+
+1104 
+SPPPGETSTATUS
+:
+
+1105 
+SPPPGETSTATUSNCP
+:
+
+1106 
+SPPPGETIDLETO
+:
+
+1107 
+SPPPGETDNSOPTS
+:
+
+1108 
+SPPPGETDNSADDRS
+:
+
+1109 
+SPPPGETKEEPALIVE
+:
+
+1110 #i
+	`defed
+(
+COMPAT_50
+|| defed(
+MODULAR
+)
+
+1111 
+__SPPPGETIDLETO50
+:
+
+1112 
+__SPPPGETKEEPALIVE50
+:
+
+1114 
+r
+ = 
+	`_ms
+(
+
+, 
+cmd
+, 
+da
+);
+
+1118 
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+);
+
+1121 
+	`lx
+(
+s
+);
+
+1122  (
+r
+);
+
+1123 
+	}
+}
+
+1134 
+	$_cisco_put
+(
+
+ *
+
+, 
+mbuf
+ *
+m
+)
+
+1136 
+STDDCL
+;
+
+1137 
+cisco_ck
+ *
+h
+;
+
+1138 #ifde
+INET
+
+
+1139 
+ut32_t
+ 
+me
+, 
+mymask
+ = 0;
+
+1142 i(
+m
+->
+m_pkthdr
+.
+n
+ < 
+CISCO_PACKET_LEN
+) {
+
+1143 i(
+debug
+)
+
+1144 
+	`log
+(
+LOG_DEBUG
+,
+
+1146 
+i
+->
+if_xme
+, 
+m
+->
+m_pkthdr
+.
+n
+);
+
+1149 
+h
+ = 
+	`mtod
+(
+m
+, 
+cisco_ck
+ *);
+
+1150 i(
+debug
+)
+
+1151 
+	`log
+(
+LOG_DEBUG
+,
+
+1154 
+i
+->
+if_xme
+, 
+m
+->
+m_pkthdr
+.
+n
+,
+
+1155 
+	`ohl
+(
+h
+->
+ty
+), h->
+r1
+, h->
+r2
+, (
+u_t
+)h->
+l
+,
+
+1156 (
+u_t
+)
+h
+->
+time0
+, (u_t)h->
+time1
+);
+
+1157 
+	`ohl
+(
+h
+->
+ty
+)) {
+
+1159 i(
+debug
+)
+
+1160 
+	`addlog
+("%s: cisco unknownacketype: 0x%x\n",
+
+1161 
+i
+->
+if_xme
+, 
+	`ohl
+(
+h
+->
+ty
+));
+
+1163 
+CISCO_ADDR_REPLY
+:
+
+1166 
+CISCO_KEEPALIVE_REQ
+:
+
+1167 
+
+->
+_ivet
+ = 0;
+
+1168 
+
+->
+_rq
+[
+IDX_LCP
+] = 
+	`ohl
+(
+h
+->
+r1
+);
+
+1169 i(
+
+->
+_q
+[
+IDX_LCP
+] =->
+_rq
+[IDX_LCP]) {
+
+1172 i(
+
+->
+_lot
+ >
+LOOPALIVECNT
+) {
+
+1173 
+	`tf
+ ("%s:oopback\n",
+
+1174 
+i
+->
+if_xme
+);
+
+1175 
+
+->
+_lot
+ = 0;
+
+1176 i(
+i
+->
+if_ags
+ & 
+IFF_UP
+) {
+
+1177 
+	`if_down
+(
+i
+);
+
+1178 
+	`IF_PURGE
+(&
+
+->
+_q
+);
+
+1181 ++
+
+->
+_lot
+;
+
+1184 
+
+->
+_q
+[
+IDX_LCP
+] = 
+	`g_32
+();
+
+1187 
+
+->
+_lot
+ = 0;
+
+1188 i(! (
+i
+->
+if_ags
+ & 
+IFF_UP
+) &&
+
+1189 (
+i
+->
+if_ags
+ & 
+IFF_RUNNING
+)) {
+
+1190 
+	`if_up
+(
+i
+);
+
+1193 
+CISCO_ADDR_REQ
+:
+
+1194 #ifde
+INET
+
+
+1195 
+	`_g__addrs
+(
+
+, &
+me
+, 0, &
+mymask
+);
+
+1196 i(
+me
+ != 0L)
+
+1197 
+	`_cisco_nd
+(
+
+, 
+CISCO_ADDR_REPLY
+, 
+me
+, 
+mymask
+);
+
+1201 
+	}
+}
+
+1207 
+	$_cisco_nd
+(
+
+ *
+
+, 
+ty
+, 
+t32_t
+ 
+r1
+, i32_
+r2
+)
+
+1209 
+STDDCL
+;
+
+1210 
+p_hd
+ *
+h
+;
+
+1211 
+cisco_ck
+ *
+ch
+;
+
+1212 
+mbuf
+ *
+m
+;
+
+1213 
+ut32_t
+ 
+t
+;
+
+1215 
+t
+ = 
+time_uime
+ * 1000;
+
+1216 
+	`MGETHDR
+(
+m
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+1217 i(! 
+m
+)
+
+1219 
+m
+->
+m_pkthdr
+.
+n
+ = m->
+m_n
+ = 
+PPP_HEADER_LEN
+ + 
+CISCO_PACKET_LEN
+;
+
+1220 
+m
+->
+m_pkthdr
+.
+rcvif
+ = 0;
+
+1222 
+h
+ = 
+	`mtod
+(
+m
+, 
+p_hd
+ *);
+
+1223 
+h
+->
+addss
+ = 
+CISCO_MULTICAST
+;
+
+1224 
+h
+->
+c
+ = 0;
+
+1225 
+h
+->
+oc
+ = 
+	`hts
+(
+CISCO_KEEPALIVE
+);
+
+1227 
+ch
+ = (
+cisco_ck
+ *)(
+h
+ + 1);
+
+1228 
+ch
+->
+ty
+ = 
+	`htl
+(type);
+
+1229 
+ch
+->
+r1
+ = 
+	`htl
+(par1);
+
+1230 
+ch
+->
+r2
+ = 
+	`htl
+(par2);
+
+1231 
+ch
+->
+l
+ = -1;
+
+1233 
+ch
+->
+time0
+ = 
+	`hts
+((
+u_sht
+)(
+t
+ >> 16));
+
+1234 
+ch
+->
+time1
+ = 
+	`hts
+((
+u_sht
+
+t
+);
+
+1236 i(
+debug
+)
+
+1237 
+	`log
+(
+LOG_DEBUG
+,
+
+1239 
+i
+->
+if_xme
+, 
+	`ohl
+(
+ch
+->
+ty
+), ch->
+r1
+,
+
+1240 
+ch
+->
+r2
+, (
+u_t
+)ch->
+l
+, (u_t)ch->
+time0
+,
+
+1241 (
+u_t
+)
+ch
+->
+time1
+);
+
+1243 i(
+	`IF_QFULL
+(&
+
+->
+_q
+)) {
+
+1244 
+	`IF_DROP
+(&
+
+->
+_q
+);
+
+1245 
+	`IF_DROP
+(&
+i
+->
+if_d
+);
+
+1246 
+	`m_m
+(
+m
+);
+
+1247 ++
+i
+->
+if_s
+;
+
+1250 
+	`IF_ENQUEUE
+(&
+
+->
+_q
+, 
+m
+);
+
+1251 i(! (
+i
+->
+if_ags
+ & 
+IFF_OACTIVE
+))
+
+1252 (*
+i
+->
+if_t
+)(ifp);
+
+1253 
+i
+->
+if_obys
+ +
+m
+->
+m_pkthdr
+.
+n
+ + 
+
+->
+_amebys
+;
+
+1254 
+	}
+}
+
+1264 
+	$__nd
+(
+
+ *
+
+, 
+u_sht
+ 
+o
+, 
+u_ch
+ 
+ty
+,
+
+1265 
+u_ch
+ 
+idt
+, 
+u_sht
+ 
+n
+, *
+da
+)
+
+1267 
+STDDCL
+;
+
+1268 
+l_hd
+ *
+lh
+;
+
+1269 
+mbuf
+ *
+m
+;
+
+1270 
+size_t
+ 
+pkthd
+;
+
+1272 
+pkthd
+ = (
+
+->
+_ags
+ & 
+PP_NOFRAMING
+? 2 : 
+PPP_HEADER_LEN
+;
+
+1274 i(
+n
+ > 
+MHLEN
+ - 
+pkthd
+ - 
+LCP_HEADER_LEN
+)
+
+1275 
+n
+ = 
+MHLEN
+ - 
+pkthd
+ - 
+LCP_HEADER_LEN
+;
+
+1276 
+	`MGETHDR
+(
+m
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+1277 i(! 
+m
+)
+
+1279 
+m
+->
+m_pkthdr
+.
+n
+ = m->
+m_n
+ = 
+pkthd
+ + 
+LCP_HEADER_LEN
+ +en;
+
+1280 
+m
+->
+m_pkthdr
+.
+rcvif
+ = 0;
+
+1282 i(
+
+->
+_ags
+ & 
+PP_NOFRAMING
+) {
+
+1283 *
+	`mtod
+(
+m
+, 
+ut16_t
+ *
+	`hts
+(
+o
+);
+
+1284 
+lh
+ = (
+l_hd
+ *)(
+	`mtod
+(
+m
+, 
+ut8_t
+ *) + 2);
+
+1286 
+p_hd
+ *
+h
+;
+
+1287 
+h
+ = 
+	`mtod
+(
+m
+, 
+p_hd
+ *);
+
+1288 
+h
+->
+addss
+ = 
+PPP_ALLSTATIONS
+;
+
+1289 
+h
+->
+c
+ = 
+PPP_UI
+;
+
+1290 
+h
+->
+oc
+ = 
+	`hts
+(
+o
+);
+
+1291 
+lh
+ = (
+l_hd
+ *)(
+h
+ + 1);
+
+1293 
+lh
+->
+ty
+ =ype;
+
+1294 
+lh
+->
+idt
+ = ident;
+
+1295 
+lh
+->
+n
+ = 
+	`hts
+(
+LCP_HEADER_LEN
+ +en);
+
+1296 i(
+n
+)
+
+1297 
+	`bcy
+ (
+da
+, 
+lh
+ + 1, 
+n
+);
+
+1299 i(
+debug
+) {
+
+1300 
+	`log
+(
+LOG_DEBUG
+, "%s: %s output <%s id=0x%xen=%d",
+
+1301 
+i
+->
+if_xme
+,
+
+1302 
+	`_o_me
+(
+o
+),
+
+1303 
+	`__ty_me
+(
+lh
+->
+ty
+),h->
+idt
+, 
+	`ohs
+h->
+n
+));
+
+1304 i(
+n
+)
+
+1305 
+	`_t_bys
+((
+u_ch
+ *)(
+lh
+ + 1), 
+n
+);
+
+1306 
+	`addlog
+(">\n");
+
+1308 i(
+	`IF_QFULL
+(&
+
+->
+_q
+)) {
+
+1309 
+	`IF_DROP
+(&
+
+->
+_q
+);
+
+1310 
+	`IF_DROP
+(&
+i
+->
+if_d
+);
+
+1311 
+	`m_m
+(
+m
+);
+
+1312 ++
+i
+->
+if_s
+;
+
+1315 
+	`IF_ENQUEUE
+(&
+
+->
+_q
+, 
+m
+);
+
+1316 i(! (
+i
+->
+if_ags
+ & 
+IFF_OACTIVE
+))
+
+1317 (*
+i
+->
+if_t
+)(ifp);
+
+1318 
+i
+->
+if_obys
+ +
+m
+->
+m_pkthdr
+.
+n
+ + 
+
+->
+_amebys
+;
+
+1319 
+	}
+}
+
+1325 
+	$__put
+(c 
+
+ *, 
+
+ *
+
+, 
+mbuf
+ *
+m
+)
+
+1327 
+STDDCL
+;
+
+1328 
+l_hd
+ *
+h
+;
+
+1329 
+
+, 
+n
+ = 
+m
+->
+m_pkthdr
+.len;
+
+1330 
+rv
+;
+
+1331 
+u_ch
+ *
+p
+;
+
+1332 
+ut32_t
+ 
+u32
+;
+
+1334 i(
+n
+ < 4) {
+
+1335 i(
+debug
+)
+
+1336 
+	`log
+(
+LOG_DEBUG
+,
+
+1338 
+i
+->
+if_xme
+, 
+
+->
+me
+, 
+n
+);
+
+1341 
+h
+ = 
+	`mtod
+(
+m
+, 
+l_hd
+ *);
+
+1342 i(
+debug
+) {
+
+1343 
+
+ = 
+	`ohs
+(
+h
+->
+n
+);
+
+1344 
+	`log
+(
+LOG_DEBUG
+,
+
+1346 
+i
+->
+if_xme
+, 
+
+->
+me
+,
+
+1347 
+	`_e_me
+(
+
+->
+e
+[
+
+->
+oidx
+]),
+
+1348 
+	`__ty_me
+(
+h
+->
+ty
+), h->
+idt
+, 
+
+);
+
+1349 i(
+n
+ < 
+
+)
+
+1350 
+
+ = 
+n
+;
+
+1351 i(
+
+ > 4)
+
+1352 
+	`_t_bys
+((
+u_ch
+ *)(
+h
+ + 1), 
+
+ - 4);
+
+1353 
+	`addlog
+(">\n");
+
+1355 i(
+n
+ > 
+	`ohs
+(
+h
+->len))
+
+1356 
+n
+ = 
+	`ohs
+(
+h
+->len);
+
+1357 
+p
+ = (
+u_ch
+ *)(
+h
+ + 1);
+
+1358 
+h
+->
+ty
+) {
+
+1359 
+CONF_REQ
+:
+
+1360 i(
+n
+ < 4) {
+
+1361 i(
+debug
+)
+
+1362 
+	`addlog
+("%s: %s invalid conf-reqength %d\n",
+
+1363 
+i
+->
+if_xme
+, 
+
+->
+me
+,
+
+1364 
+n
+);
+
+1365 ++
+i
+->
+if_s
+;
+
+1369 
+
+->
+e
+[
+
+->
+oidx
+]) {
+
+1370 
+STATE_CLOSING
+:
+
+1371 
+STATE_STOPPING
+:
+
+1373 
+STATE_CLOSED
+:
+
+1374 
+	`__nd
+(
+
+, 
+
+->
+o
+, 
+TERM_ACK
+, 
+h
+->
+idt
+,
+
+1378 
+rv
+ = (
+
+->
+RCR
+)(
+
+, 
+h
+, 
+n
+);
+
+1379 i(
+rv
+ < 0) {
+
+1381 (
+
+->
+d
+)(
+
+);
+
+1382 
+	`_l_f
+(
+
+);
+
+1385 
+
+->
+e
+[
+
+->
+oidx
+]) {
+
+1386 
+STATE_OPENED
+:
+
+1387 (
+
+->
+d
+)(
+
+);
+
+1388 (
+
+->
+s
+)(
+
+);
+
+1390 
+STATE_ACK_SENT
+:
+
+1391 
+STATE_REQ_SENT
+:
+
+1392 
+	`__chge_e
+(
+
+, 
+
+, 
+rv
+?
+
+1393 
+STATE_ACK_SENT
+: 
+STATE_REQ_SENT
+);
+
+1395 
+STATE_STOPPED
+:
+
+1396 
+
+->
+r_cou
+[
+
+->
+oidx
+] = sp->
+l
+.
+max_cfigu
+;
+
+1397 (
+
+->
+s
+)(
+
+);
+
+1398 
+	`__chge_e
+(
+
+, 
+
+, 
+rv
+?
+
+1399 
+STATE_ACK_SENT
+: 
+STATE_REQ_SENT
+);
+
+1401 
+STATE_ACK_RCVD
+:
+
+1402 i(
+rv
+) {
+
+1403 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_OPENED
+);
+
+1404 i(
+debug
+)
+
+1405 
+	`log
+(
+LOG_DEBUG
+, "%s: %slu\n",
+
+1406 
+i
+->
+if_xme
+,
+
+1407 
+
+->
+me
+);
+
+1408 (
+
+->
+u
+)(
+
+);
+
+1410 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_ACK_RCVD
+);
+
+1413 
+	`tf
+("%s: %s illegal %s in state %s\n",
+
+1414 
+i
+->
+if_xme
+, 
+
+->
+me
+,
+
+1415 
+	`__ty_me
+(
+h
+->
+ty
+),
+
+1416 
+	`_e_me
+(
+
+->
+e
+[
+
+->
+oidx
+]));
+
+1417 ++
+i
+->
+if_s
+;
+
+1420 
+CONF_ACK
+:
+
+1421 i(
+h
+->
+idt
+ !
+
+->
+cfid
+[
+
+->
+oidx
+]) {
+
+1422 i(
+debug
+)
+
+1423 
+	`addlog
+("%s: %s id mismatch 0x%x != 0x%x\n",
+
+1424 
+i
+->
+if_xme
+, 
+
+->
+me
+,
+
+1425 
+h
+->
+idt
+, 
+
+->
+cfid
+[
+
+->
+oidx
+]);
+
+1426 ++
+i
+->
+if_s
+;
+
+1429 
+
+->
+e
+[
+
+->
+oidx
+]) {
+
+1430 
+STATE_CLOSED
+:
+
+1431 
+STATE_STOPPED
+:
+
+1432 
+	`__nd
+(
+
+, 
+
+->
+o
+, 
+TERM_ACK
+, 
+h
+->
+idt
+, 0, 0);
+
+1434 
+STATE_CLOSING
+:
+
+1435 
+STATE_STOPPING
+:
+
+1437 
+STATE_REQ_SENT
+:
+
+1438 
+
+->
+r_cou
+[
+
+->
+oidx
+] = sp->
+l
+.
+max_cfigu
+;
+
+1439 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_ACK_RCVD
+);
+
+1441 
+STATE_OPENED
+:
+
+1442 (
+
+->
+d
+)(
+
+);
+
+1444 
+STATE_ACK_RCVD
+:
+
+1445 (
+
+->
+s
+)(
+
+);
+
+1446 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_REQ_SENT
+);
+
+1448 
+STATE_ACK_SENT
+:
+
+1449 
+
+->
+r_cou
+[
+
+->
+oidx
+] = sp->
+l
+.
+max_cfigu
+;
+
+1450 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_OPENED
+);
+
+1451 i(
+debug
+)
+
+1452 
+	`log
+(
+LOG_DEBUG
+, "%s: %slu\n",
+
+1453 
+i
+->
+if_xme
+, 
+
+->
+me
+);
+
+1454 (
+
+->
+u
+)(
+
+);
+
+1457 
+	`tf
+("%s: %s illegal %s in state %s\n",
+
+1458 
+i
+->
+if_xme
+, 
+
+->
+me
+,
+
+1459 
+	`__ty_me
+(
+h
+->
+ty
+),
+
+1460 
+	`_e_me
+(
+
+->
+e
+[
+
+->
+oidx
+]));
+
+1461 ++
+i
+->
+if_s
+;
+
+1464 
+CONF_NAK
+:
+
+1465 
+CONF_REJ
+:
+
+1466 i(
+h
+->
+idt
+ !
+
+->
+cfid
+[
+
+->
+oidx
+]) {
+
+1467 i(
+debug
+)
+
+1468 
+	`addlog
+("%s: %s id mismatch 0x%x != 0x%x\n",
+
+1469 
+i
+->
+if_xme
+, 
+
+->
+me
+,
+
+1470 
+h
+->
+idt
+, 
+
+->
+cfid
+[
+
+->
+oidx
+]);
+
+1471 ++
+i
+->
+if_s
+;
+
+1474 i(
+h
+->
+ty
+ =
+CONF_NAK
+)
+
+1475 (
+
+->
+RCN_k
+)(
+
+, 
+h
+, 
+n
+);
+
+1477 (
+
+->
+RCN_j
+)(
+
+, 
+h
+, 
+n
+);
+
+1479 
+
+->
+e
+[
+
+->
+oidx
+]) {
+
+1480 
+STATE_CLOSED
+:
+
+1481 
+STATE_STOPPED
+:
+
+1482 
+	`__nd
+(
+
+, 
+
+->
+o
+, 
+TERM_ACK
+, 
+h
+->
+idt
+, 0, 0);
+
+1484 
+STATE_REQ_SENT
+:
+
+1485 
+STATE_ACK_SENT
+:
+
+1486 
+
+->
+r_cou
+[
+
+->
+oidx
+] = sp->
+l
+.
+max_cfigu
+;
+
+1487 (
+
+->
+s
+)(
+
+);
+
+1489 
+STATE_OPENED
+:
+
+1490 (
+
+->
+d
+)(
+
+);
+
+1492 
+STATE_ACK_RCVD
+:
+
+1493 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_ACK_SENT
+);
+
+1494 (
+
+->
+s
+)(
+
+);
+
+1496 
+STATE_CLOSING
+:
+
+1497 
+STATE_STOPPING
+:
+
+1500 
+	`tf
+("%s: %s illegal %s in state %s\n",
+
+1501 
+i
+->
+if_xme
+, 
+
+->
+me
+,
+
+1502 
+	`__ty_me
+(
+h
+->
+ty
+),
+
+1503 
+	`_e_me
+(
+
+->
+e
+[
+
+->
+oidx
+]));
+
+1504 ++
+i
+->
+if_s
+;
+
+1508 
+TERM_REQ
+:
+
+1509 
+
+->
+e
+[
+
+->
+oidx
+]) {
+
+1510 
+STATE_ACK_RCVD
+:
+
+1511 
+STATE_ACK_SENT
+:
+
+1512 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_REQ_SENT
+);
+
+1514 
+STATE_CLOSED
+:
+
+1515 
+STATE_STOPPED
+:
+
+1516 
+STATE_CLOSING
+:
+
+1517 
+STATE_STOPPING
+:
+
+1518 
+STATE_REQ_SENT
+:
+
+1519 
+a
+:
+
+1521 i(
+debug
+)
+
+1522 
+	`log
+(
+LOG_DEBUG
+, "%s: %s senderminate-ack\n",
+
+1523 
+i
+->
+if_xme
+, 
+
+->
+me
+);
+
+1524 
+	`__nd
+(
+
+, 
+
+->
+o
+, 
+TERM_ACK
+, 
+h
+->
+idt
+, 0, 0);
+
+1526 
+STATE_OPENED
+:
+
+1527 (
+
+->
+d
+)(
+
+);
+
+1528 
+
+->
+r_cou
+[
+
+->
+oidx
+] = 0;
+
+1529 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_STOPPING
+);
+
+1530 
+a
+;
+
+1532 
+	`tf
+("%s: %s illegal %s in state %s\n",
+
+1533 
+i
+->
+if_xme
+, 
+
+->
+me
+,
+
+1534 
+	`__ty_me
+(
+h
+->
+ty
+),
+
+1535 
+	`_e_me
+(
+
+->
+e
+[
+
+->
+oidx
+]));
+
+1536 ++
+i
+->
+if_s
+;
+
+1539 
+TERM_ACK
+:
+
+1540 
+
+->
+e
+[
+
+->
+oidx
+]) {
+
+1541 
+STATE_CLOSED
+:
+
+1542 
+STATE_STOPPED
+:
+
+1543 
+STATE_REQ_SENT
+:
+
+1544 
+STATE_ACK_SENT
+:
+
+1546 
+STATE_CLOSING
+:
+
+1547 (
+
+->
+f
+)(
+
+);
+
+1548 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_CLOSED
+);
+
+1549 
+	`_l_check_d_o
+(
+
+);
+
+1551 
+STATE_STOPPING
+:
+
+1552 (
+
+->
+f
+)(
+
+);
+
+1553 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_STOPPED
+);
+
+1554 
+	`_l_check_d_o
+(
+
+);
+
+1556 
+STATE_ACK_RCVD
+:
+
+1557 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_REQ_SENT
+);
+
+1559 
+STATE_OPENED
+:
+
+1560 (
+
+->
+d
+)(
+
+);
+
+1561 (
+
+->
+s
+)(
+
+);
+
+1562 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_ACK_RCVD
+);
+
+1565 
+	`tf
+("%s: %s illegal %s in state %s\n",
+
+1566 
+i
+->
+if_xme
+, 
+
+->
+me
+,
+
+1567 
+	`__ty_me
+(
+h
+->
+ty
+),
+
+1568 
+	`_e_me
+(
+
+->
+e
+[
+
+->
+oidx
+]));
+
+1569 ++
+i
+->
+if_s
+;
+
+1572 
+CODE_REJ
+:
+
+1574 
+	`log
+(
+LOG_INFO
+,
+
+1577 
+i
+->
+if_xme
+, 
+
+->
+me
+,
+
+1578 
+	`__ty_me
+(
+h
+->
+ty
+));
+
+1579 
+
+->
+e
+[
+
+->
+oidx
+]) {
+
+1580 
+STATE_CLOSED
+:
+
+1581 
+STATE_STOPPED
+:
+
+1582 
+STATE_REQ_SENT
+:
+
+1583 
+STATE_ACK_SENT
+:
+
+1584 
+STATE_CLOSING
+:
+
+1585 
+STATE_STOPPING
+:
+
+1586 
+STATE_OPENED
+:
+
+1588 
+STATE_ACK_RCVD
+:
+
+1589 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_REQ_SENT
+);
+
+1592 
+	`tf
+("%s: %s illegal %s in state %s\n",
+
+1593 
+i
+->
+if_xme
+, 
+
+->
+me
+,
+
+1594 
+	`__ty_me
+(
+h
+->
+ty
+),
+
+1595 
+	`_e_me
+(
+
+->
+e
+[
+
+->
+oidx
+]));
+
+1596 ++
+i
+->
+if_s
+;
+
+1599 
+PROTO_REJ
+:
+
+1601 
+rhic
+;
+
+1602 c 
+
+ *
+u
+;
+
+1603 
+i
+;
+
+1604 
+ut16_t
+ 
+o
+;
+
+1606 
+rhic
+ = 0;
+
+1607 
+u
+ = 
+NULL
+;
+
+1608 
+o
+ = 
+p
+[0] << 8 |[1];
+
+1609 
+i
+ = 0; i < 
+IDX_COUNT
+; i++) {
+
+1610 i(
+s
+[
+i
+]->
+o
+ ==roto) {
+
+1611 
+u
+ = 
+s
+[
+i
+];
+
+1615 i(
+u
+ =
+NULL
+)
+
+1616 
+rhic
+++;
+
+1618 i(
+debug
+)
+
+1619 
+	`log
+(
+LOG_INFO
+,
+
+1621 
+i
+->
+if_xme
+, 
+
+->
+me
+, 
+rhic
+ ? '-' : '+',
+
+1622 
+	`__ty_me
+(
+h
+->
+ty
+), 
+o
+,
+
+1623 
+u
+ ? u->
+me
+ : "unknown",
+
+1624 
+u
+ ? 
+	`_e_me
+(
+
+->
+e
+[u->
+oidx
+]) : "?");
+
+1630 i(
+u
+ && !
+rhic
+) {
+
+1631 i(
+
+->
+e
+[
+u
+->
+oidx
+] =
+STATE_REQ_SENT
+) {
+
+1632 
+u
+->
+	`Clo
+(
+
+);
+
+1638 
+
+->
+e
+[
+
+->
+oidx
+]) {
+
+1639 
+STATE_CLOSED
+:
+
+1640 
+STATE_STOPPED
+:
+
+1641 
+STATE_REQ_SENT
+:
+
+1642 
+STATE_ACK_SENT
+:
+
+1643 
+STATE_CLOSING
+:
+
+1644 
+STATE_STOPPING
+:
+
+1645 
+STATE_OPENED
+:
+
+1647 
+STATE_ACK_RCVD
+:
+
+1648 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_REQ_SENT
+);
+
+1651 
+	`tf
+("%s: %s illegal %s in state %s\n",
+
+1652 
+i
+->
+if_xme
+, 
+
+->
+me
+,
+
+1653 
+	`__ty_me
+(
+h
+->
+ty
+),
+
+1654 
+	`_e_me
+(
+
+->
+e
+[
+
+->
+oidx
+]));
+
+1655 ++
+i
+->
+if_s
+;
+
+1659 
+DISC_REQ
+:
+
+1660 i(
+
+->
+o
+ !
+PPP_LCP
+)
+
+1661 
+g
+;
+
+1664 
+ECHO_REQ
+:
+
+1665 i(
+
+->
+o
+ !
+PPP_LCP
+)
+
+1666 
+g
+;
+
+1667 i(
+
+->
+e
+[
+
+->
+oidx
+] !
+STATE_OPENED
+) {
+
+1668 i(
+debug
+)
+
+1669 
+	`addlog
+("%s:cpchoeq butcp closed\n",
+
+1670 
+i
+->
+if_xme
+);
+
+1671 ++
+i
+->
+if_s
+;
+
+1674 i(
+n
+ < 8) {
+
+1675 i(
+debug
+)
+
+1676 
+	`addlog
+("%s: invalidcpchoequest "
+
+1678 
+i
+->
+if_xme
+, 
+n
+);
+
+1681 
+	`memy
+(&
+u32
+, 
+h
+ + 1,  u32);
+
+1682 i(
+	`ohl
+(
+u32
+=
+
+->
+l
+.
+magic
+) {
+
+1684 
+	`tf
+("%s:oback\n", 
+i
+->
+if_xme
+);
+
+1685 
+	`if_down
+(
+i
+);
+
+1686 
+	`IF_PURGE
+(&
+
+->
+_q
+);
+
+1690 
+l
+.
+	`Down
+(
+
+);
+
+1691 
+l
+.
+	`Up
+(
+
+);
+
+1694 
+u32
+ = 
+	`htl
+(
+
+->
+l
+.
+magic
+);
+
+1695 
+	`memy
+(
+h
+ + 1, &
+u32
+,  u32);
+
+1696 i(
+debug
+)
+
+1697 
+	`addlog
+("%s: gotcpchoeq, sendingchoep\n",
+
+1698 
+i
+->
+if_xme
+);
+
+1699 
+	`__nd
+(
+
+, 
+PPP_LCP
+, 
+ECHO_REPLY
+, 
+h
+->
+idt
+, 
+n
+ - 4,
+
+1700 
+h
+ + 1);
+
+1702 
+ECHO_REPLY
+:
+
+1703 i(
+
+->
+o
+ !
+PPP_LCP
+)
+
+1704 
+g
+;
+
+1705 i(
+h
+->
+idt
+ !
+
+->
+l
+.
+echoid
+) {
+
+1706 ++
+i
+->
+if_s
+;
+
+1709 i(
+n
+ < 8) {
+
+1710 i(
+debug
+)
+
+1711 
+	`addlog
+("%s:cp invalidchoeply "
+
+1713 
+i
+->
+if_xme
+, 
+n
+);
+
+1716 i(
+debug
+)
+
+1717 
+	`addlog
+("%s:cp gotchoep\n",
+
+1718 
+i
+->
+if_xme
+);
+
+1719 
+	`memy
+(&
+u32
+, 
+h
+ + 1,  u32);
+
+1720 i(
+	`ohl
+(
+u32
+!
+
+->
+l
+.
+magic
+)
+
+1721 
+
+->
+_ivet
+ = 0;
+
+1725 
+g
+:
+
+1726 i(
+debug
+)
+
+1727 
+	`addlog
+("%s: %s send code-rej for 0x%x\n",
+
+1728 
+i
+->
+if_xme
+, 
+
+->
+me
+, 
+h
+->
+ty
+);
+
+1729 
+	`__nd
+(
+
+, 
+
+->
+o
+, 
+CODE_REJ
+,
+
+1730 ++
+
+->
+_q
+[
+
+->
+oidx
+], 
+m
+->
+m_pkthdr
+.
+n
+, 
+h
+);
+
+1731 ++
+i
+->
+if_s
+;
+
+1733 
+	}
+}
+
+1741 
+	$_up_evt
+(c 
+
+ *, 
+
+ *
+
+)
+
+1743 
+STDDCL
+;
+
+1745 i(
+debug
+)
+
+1746 
+	`log
+(
+LOG_DEBUG
+, "%s: %s up(%s)\n",
+
+1747 
+i
+->
+if_xme
+, 
+
+->
+me
+,
+
+1748 
+	`_e_me
+(
+
+->
+e
+[
+
+->
+oidx
+]));
+
+1750 
+
+->
+e
+[
+
+->
+oidx
+]) {
+
+1751 
+STATE_INITIAL
+:
+
+1752 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_CLOSED
+);
+
+1754 
+STATE_STARTING
+:
+
+1755 
+
+->
+r_cou
+[
+
+->
+oidx
+] = sp->
+l
+.
+max_cfigu
+;
+
+1756 (
+
+->
+s
+)(
+
+);
+
+1757 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_REQ_SENT
+);
+
+1760 
+	`tf
+("%s: %s illegal up in state %s\n",
+
+1761 
+i
+->
+if_xme
+, 
+
+->
+me
+,
+
+1762 
+	`_e_me
+(
+
+->
+e
+[
+
+->
+oidx
+]));
+
+1764 
+	}
+}
+
+1767 
+	$_down_evt
+(c 
+
+ *, 
+
+ *
+
+)
+
+1769 
+STDDCL
+;
+
+1771 i(
+debug
+)
+
+1772 
+	`log
+(
+LOG_DEBUG
+, "%s: %s down(%s)\n",
+
+1773 
+i
+->
+if_xme
+, 
+
+->
+me
+,
+
+1774 
+	`_e_me
+(
+
+->
+e
+[
+
+->
+oidx
+]));
+
+1776 
+
+->
+e
+[
+
+->
+oidx
+]) {
+
+1777 
+STATE_CLOSED
+:
+
+1778 
+STATE_CLOSING
+:
+
+1779 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_INITIAL
+);
+
+1781 
+STATE_STOPPED
+:
+
+1782 (
+
+->
+s
+)(
+
+);
+
+1784 
+STATE_STOPPING
+:
+
+1785 
+STATE_REQ_SENT
+:
+
+1786 
+STATE_ACK_RCVD
+:
+
+1787 
+STATE_ACK_SENT
+:
+
+1788 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_STARTING
+);
+
+1790 
+STATE_OPENED
+:
+
+1791 (
+
+->
+d
+)(
+
+);
+
+1792 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_STARTING
+);
+
+1795 
+	`tf
+("%s: %s illegal down in state %s\n",
+
+1796 
+i
+->
+if_xme
+, 
+
+->
+me
+,
+
+1797 
+	`_e_me
+(
+
+->
+e
+[
+
+->
+oidx
+]));
+
+1799 
+	}
+}
+
+1803 
+	$__evt
+(c 
+
+ *, 
+
+ *
+
+)
+
+1805 
+STDDCL
+;
+
+1807 i(
+debug
+)
+
+1808 
+	`log
+(
+LOG_DEBUG
+, "%s: %s open(%s)\n",
+
+1809 
+i
+->
+if_xme
+, 
+
+->
+me
+,
+
+1810 
+	`_e_me
+(
+
+->
+e
+[
+
+->
+oidx
+]));
+
+1812 
+
+->
+e
+[
+
+->
+oidx
+]) {
+
+1813 
+STATE_INITIAL
+:
+
+1814 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_STARTING
+);
+
+1815 (
+
+->
+s
+)(
+
+);
+
+1817 
+STATE_STARTING
+:
+
+1819 
+STATE_CLOSED
+:
+
+1820 
+
+->
+r_cou
+[
+
+->
+oidx
+] = sp->
+l
+.
+max_cfigu
+;
+
+1821 (
+
+->
+s
+)(
+
+);
+
+1822 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_REQ_SENT
+);
+
+1824 
+STATE_STOPPED
+:
+
+1825 
+STATE_STOPPING
+:
+
+1826 
+STATE_REQ_SENT
+:
+
+1827 
+STATE_ACK_RCVD
+:
+
+1828 
+STATE_ACK_SENT
+:
+
+1829 
+STATE_OPENED
+:
+
+1831 
+STATE_CLOSING
+:
+
+1832 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_STOPPING
+);
+
+1835 
+	}
+}
+
+1839 
+	$_o_evt
+(c 
+
+ *, 
+
+ *
+
+)
+
+1841 
+STDDCL
+;
+
+1843 i(
+debug
+)
+
+1844 
+	`log
+(
+LOG_DEBUG
+, "%s: %s close(%s)\n",
+
+1845 
+i
+->
+if_xme
+, 
+
+->
+me
+,
+
+1846 
+	`_e_me
+(
+
+->
+e
+[
+
+->
+oidx
+]));
+
+1848 
+
+->
+e
+[
+
+->
+oidx
+]) {
+
+1849 
+STATE_INITIAL
+:
+
+1850 
+STATE_CLOSED
+:
+
+1851 
+STATE_CLOSING
+:
+
+1853 
+STATE_STARTING
+:
+
+1854 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_INITIAL
+);
+
+1855 (
+
+->
+f
+)(
+
+);
+
+1857 
+STATE_STOPPED
+:
+
+1858 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_CLOSED
+);
+
+1860 
+STATE_STOPPING
+:
+
+1861 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_CLOSING
+);
+
+1863 
+STATE_OPENED
+:
+
+1864 (
+
+->
+d
+)(
+
+);
+
+1866 
+STATE_REQ_SENT
+:
+
+1867 
+STATE_ACK_RCVD
+:
+
+1868 
+STATE_ACK_SENT
+:
+
+1869 
+
+->
+r_cou
+[
+
+->
+oidx
+] = sp->
+l
+.
+max_rme
+;
+
+1870 
+	`__nd
+(
+
+, 
+
+->
+o
+, 
+TERM_REQ
+,
+
+1871 ++
+
+->
+_q
+[
+
+->
+oidx
+], 0, 0);
+
+1872 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_CLOSING
+);
+
+1875 
+	}
+}
+
+1878 
+	$_to_evt
+(c 
+
+ *, 
+
+ *
+
+)
+
+1880 
+STDDCL
+;
+
+1881 
+s
+;
+
+1883 
+s
+ = 
+	`
+();
+
+1884 i(
+debug
+)
+
+1885 
+	`log
+(
+LOG_DEBUG
+, "%s: %s TO(%s)st_counter = %d\n",
+
+1886 
+i
+->
+if_xme
+, 
+
+->
+me
+,
+
+1887 
+	`_e_me
+(
+
+->
+e
+[
+
+->
+oidx
+]),
+
+1888 
+
+->
+r_cou
+[
+
+->
+oidx
+]);
+
+1890 i(--
+
+->
+r_cou
+[
+
+->
+oidx
+] < 0)
+
+1892 
+
+->
+e
+[
+
+->
+oidx
+]) {
+
+1893 
+STATE_CLOSING
+:
+
+1894 (
+
+->
+f
+)(
+
+);
+
+1895 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_CLOSED
+);
+
+1896 
+	`_l_check_d_o
+(
+
+);
+
+1898 
+STATE_STOPPING
+:
+
+1899 (
+
+->
+f
+)(
+
+);
+
+1900 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_STOPPED
+);
+
+1901 
+	`_l_check_d_o
+(
+
+);
+
+1903 
+STATE_REQ_SENT
+:
+
+1904 
+STATE_ACK_RCVD
+:
+
+1905 
+STATE_ACK_SENT
+:
+
+1906 (
+
+->
+f
+)(
+
+);
+
+1907 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_STOPPED
+);
+
+1908 
+	`_l_check_d_o
+(
+
+);
+
+1913 
+
+->
+e
+[
+
+->
+oidx
+]) {
+
+1914 
+STATE_CLOSING
+:
+
+1915 
+STATE_STOPPING
+:
+
+1916 
+	`__nd
+(
+
+, 
+
+->
+o
+, 
+TERM_REQ
+,
+
+1917 ++
+
+->
+_q
+[
+
+->
+oidx
+], 0, 0);
+
+1918 
+	`out_t
+(&
+
+->
+ch
+[
+
+->
+oidx
+], sp->
+l
+.
+timeout
+,
+
+1919 
+
+->
+TO
+, 
+
+);
+
+1921 
+STATE_REQ_SENT
+:
+
+1922 
+STATE_ACK_RCVD
+:
+
+1923 (
+
+->
+s
+)(
+
+);
+
+1925 
+	`__chge_e
+(
+
+, 
+
+, 
+STATE_REQ_SENT
+);
+
+1927 
+STATE_ACK_SENT
+:
+
+1928 (
+
+->
+s
+)(
+
+);
+
+1929 
+	`out_t
+(&
+
+->
+ch
+[
+
+->
+oidx
+], sp->
+l
+.
+timeout
+,
+
+1930 
+
+->
+TO
+, 
+
+);
+
+1934 
+	`lx
+(
+s
+);
+
+1935 
+	}
+}
+
+1942 
+	$__chge_e
+(c 
+
+ *, 
+
+ *
+
+, 
+we
+)
+
+1944 
+
+->
+e
+[
+
+->
+oidx
+] = 
+we
+;
+
+1945 
+	`out_
+(&
+
+->
+ch
+[
+
+->
+oidx
+]);
+
+1946 
+we
+) {
+
+1947 
+STATE_INITIAL
+:
+
+1948 
+STATE_STARTING
+:
+
+1949 
+STATE_CLOSED
+:
+
+1950 
+STATE_STOPPED
+:
+
+1951 
+STATE_OPENED
+:
+
+1953 
+STATE_CLOSING
+:
+
+1954 
+STATE_STOPPING
+:
+
+1955 
+STATE_REQ_SENT
+:
+
+1956 
+STATE_ACK_RCVD
+:
+
+1957 
+STATE_ACK_SENT
+:
+
+1958 
+	`out_t
+(&
+
+->
+ch
+[
+
+->
+oidx
+], sp->
+l
+.
+timeout
+,
+
+1959 
+
+->
+TO
+, 
+
+);
+
+1962 
+	}
+}
+
+1972 
+	$_l_
+(
+
+ *
+
+)
+
+1974 
+
+->
+l
+.
+ts
+ = (1 << 
+LCP_OPT_MAGIC
+);
+
+1975 
+
+->
+l
+.
+magic
+ = 0;
+
+1976 
+
+->
+e
+[
+IDX_LCP
+] = 
+STATE_INITIAL
+;
+
+1977 
+
+->
+_cou
+[
+IDX_LCP
+] = 0;
+
+1978 
+
+->
+_q
+[
+IDX_LCP
+] = 0;
+
+1979 
+
+->
+_rq
+[
+IDX_LCP
+] = 0;
+
+1980 
+
+->
+l
+.
+os
+ = 0;
+
+1989 
+
+->
+l
+.
+timeout
+ = 1 * 
+hz
+;
+
+1990 
+
+->
+l
+.
+max_rme
+ = 2;
+
+1991 
+
+->
+l
+.
+max_cfigu
+ = 10;
+
+1992 
+
+->
+l
+.
+max_u
+ = 10;
+
+1993 
+	`out_
+(&
+
+->
+ch
+[
+IDX_LCP
+], 0);
+
+1994 
+	}
+}
+
+1997 
+	$_l_up
+(
+
+ *
+
+)
+
+1999 
+STDDCL
+;
+
+2002 
+
+->
+__ive
+ = sp->
+__aivy
+ = 
+time_uime
+;
+
+2009 i((
+i
+->
+if_ags
+ & (
+IFF_AUTO
+ | 
+IFF_PASSIVE
+)) != 0) {
+
+2010 i(
+debug
+)
+
+2011 
+	`log
+(
+LOG_DEBUG
+,
+
+2012 "%s: Uevt", 
+i
+->
+if_xme
+);
+
+2013 
+i
+->
+if_ags
+ |
+IFF_RUNNING
+;
+
+2014 i(
+
+->
+e
+[
+IDX_LCP
+] =
+STATE_INITIAL
+) {
+
+2015 i(
+debug
+)
+
+2016 
+	`addlog
+("(incoming call)\n");
+
+2017 
+
+->
+_ags
+ |
+PP_CALLIN
+;
+
+2018 
+l
+.
+	`On
+(
+
+);
+
+2019 } i(
+debug
+)
+
+2020 
+	`addlog
+("\n");
+
+2021 } i((
+i
+->
+if_ags
+ & (
+IFF_AUTO
+ | 
+IFF_PASSIVE
+)) == 0 &&
+
+2022 (
+
+->
+e
+[
+IDX_LCP
+] =
+STATE_INITIAL
+)) {
+
+2023 
+i
+->
+if_ags
+ |
+IFF_RUNNING
+;
+
+2024 
+l
+.
+	`On
+(
+
+);
+
+2027 
+	`_up_evt
+(&
+l
+, 
+
+);
+
+2028 
+	}
+}
+
+2031 
+	$_l_down
+(
+
+ *
+
+)
+
+2033 
+STDDCL
+;
+
+2035 
+	`_down_evt
+(&
+l
+, 
+
+);
+
+2044 i((
+i
+->
+if_ags
+ & (
+IFF_AUTO
+ | 
+IFF_PASSIVE
+)) == 0) {
+
+2045 i(
+debug
+)
+
+2046 
+	`log
+(
+LOG_INFO
+,
+
+2048 
+i
+->
+if_xme
+);
+
+2049 
+	`if_down
+(
+i
+);
+
+2051 i(
+debug
+)
+
+2052 
+	`log
+(
+LOG_DEBUG
+,
+
+2054 
+i
+->
+if_xme
+);
+
+2056 
+
+->
+_ags
+ &~
+PP_CALLIN
+;
+
+2057 i(
+
+->
+e
+[
+IDX_LCP
+] !
+STATE_INITIAL
+)
+
+2058 
+l
+.
+	`Clo
+(
+
+);
+
+2059 
+i
+->
+if_ags
+ &~
+IFF_RUNNING
+;
+
+2060 
+	}
+}
+
+2063 
+	$_l_
+(
+
+ *
+
+)
+
+2065 i(
+
+->
+_if
+.
+if_mtu
+ < 
+PP_MTU
+) {
+
+2066 
+
+->
+l
+.
+mru
+ = sp->
+_if
+.
+if_mtu
+;
+
+2067 
+
+->
+l
+.
+ts
+ |(1 << 
+LCP_OPT_MRU
+);
+
+2069 
+
+->
+l
+.
+mru
+ = 
+PP_MTU
+;
+
+2070 
+
+->
+l
+.
+the_mru
+ = 
+PP_MTU
+;
+
+2075 i(
+
+->
+hiuth
+.
+o
+ != 0)
+
+2076 
+
+->
+l
+.
+ts
+ |(1 << 
+LCP_OPT_AUTH_PROTO
+);
+
+2078 
+
+->
+l
+.
+ts
+ &~(1 << 
+LCP_OPT_AUTH_PROTO
+);
+
+2079 
+
+->
+_ags
+ &~
+PP_NEEDAUTH
+;
+
+2080 
+	`__evt
+(&
+l
+, 
+
+);
+
+2081 
+	}
+}
+
+2084 
+	$_l_o
+(
+
+ *
+
+)
+
+2086 
+	`_o_evt
+(&
+l
+, 
+
+);
+
+2087 
+	}
+}
+
+2090 
+	$_l_TO
+(*
+cook
+)
+
+2092 
+	`_to_evt
+(&
+l
+, (
+
+ *)
+cook
+);
+
+2093 
+	}
+}
+
+2102 
+	$_l_RCR
+(
+
+ *
+
+, 
+l_hd
+ *
+h
+, 
+n
+)
+
+2104 
+STDDCL
+;
+
+2105 
+u_ch
+ *
+buf
+, *
+r
+, *
+p
+;
+
+2106 
+ign
+, 
+
+;
+
+2107 
+ut32_t
+ 
+nmagic
+;
+
+2108 
+u_sht
+ 
+autho
+;
+
+2110 
+n
+ -= 4;
+
+2111 
+ign
+ = 
+n
+;
+
+2112 
+buf
+ = 
+r
+ = 
+	`mloc
+ (
+n
+, 
+M_TEMP
+, 
+M_NOWAIT
+);
+
+2113 i(! 
+buf
+)
+
+2116 i(
+debug
+)
+
+2117 
+	`log
+(
+LOG_DEBUG
+, "%s:cparse opts:",
+
+2118 
+i
+->
+if_xme
+);
+
+2121 
+p
+ = (*)(
+h
+ + 1);
+
+2122 
+
+=0; 
+n
+>1 && 
+p
+[1];en-=p[1],+=p[1]) {
+
+2124 i(
+p
+[1] > 
+n
+) {
+
+2129 
+	`addlog
+("%s:eceived malicious LCP option 0x%02x, "
+
+2130 "ngth 0x%02x, (n: 0x%02xdrpg.\n", 
+i
+->
+if_xme
+,
+
+2131 
+p
+[0],[1], 
+n
+);
+
+2132 
+dr
+;
+
+2134 i(
+debug
+)
+
+2135 
+	`addlog
+(" %s", 
+	`_l_t_me
+(*
+p
+));
+
+2136 *
+p
+) {
+
+2137 
+LCP_OPT_MAGIC
+:
+
+2140 
+LCP_OPT_ASYNC_MAP
+:
+
+2142 i(
+n
+ >6 || 
+p
+[1] == 6)
+
+2144 i(
+debug
+)
+
+2145 
+	`addlog
+(" [invalid]");
+
+2147 
+LCP_OPT_MRU
+:
+
+2149 i(
+n
+ >4 && 
+p
+[1] == 4)
+
+2151 i(
+debug
+)
+
+2152 
+	`addlog
+(" [invalid]");
+
+2154 
+LCP_OPT_AUTH_PROTO
+:
+
+2155 i(
+n
+ < 4) {
+
+2156 i(
+debug
+)
+
+2157 
+	`addlog
+(" [invalid]");
+
+2160 
+autho
+ = (
+p
+[2] << 8) +[3];
+
+2161 i(
+autho
+ =
+PPP_CHAP
+ && 
+p
+[1] != 5) {
+
+2162 i(
+debug
+)
+
+2163 
+	`addlog
+(" [invalid chapen]");
+
+2166 i(
+
+->
+myauth
+.
+o
+ == 0) {
+
+2168 i(
+debug
+)
+
+2169 
+	`addlog
+(" [not configured]");
+
+2177 
+
+->
+_ags
+ |
+PP_NEEDAUTH
+;
+
+2181 i(
+debug
+)
+
+2182 
+	`addlog
+(" [rej]");
+
+2186 
+	`bcy
+ (
+p
+, 
+r
+,[1]);
+
+2187 
+r
+ +
+p
+[1];
+
+2188 
+
+ +
+p
+[1];
+
+2190 i(
+
+) {
+
+2191 i(
+debug
+)
+
+2192 
+	`addlog
+(" send conf-rej\n");
+
+2193 
+	`__nd
+(
+
+, 
+PPP_LCP
+, 
+CONF_REJ
+, 
+h
+->
+idt
+, 
+
+, 
+buf
+);
+
+2194 
+d
+;
+
+2195 } i(
+debug
+)
+
+2196 
+	`addlog
+("\n");
+
+2202 i(
+debug
+)
+
+2203 
+	`log
+(
+LOG_DEBUG
+, "%s:cparse opt values: ",
+
+2204 
+i
+->
+if_xme
+);
+
+2206 
+p
+ = (*)(
+h
+ + 1);
+
+2207 
+n
+ = 
+ign
+;
+
+2208 
+
+=0; 
+n
+>1 && 
+p
+[1];en-=p[1],+=p[1]) {
+
+2209 i(
+debug
+)
+
+2210 
+	`addlog
+(" %s", 
+	`_l_t_me
+(*
+p
+));
+
+2211 *
+p
+) {
+
+2212 
+LCP_OPT_MAGIC
+:
+
+2214 
+nmagic
+ = (
+ut32_t
+)
+p
+[2] << 24 |
+
+2215 (
+ut32_t
+)
+p
+[3] << 16 |[4] << 8 |[5];
+
+2216 i(
+nmagic
+ !
+
+->
+l
+.
+magic
+) {
+
+2217 i(
+debug
+)
+
+2218 
+	`addlog
+(" 0x%x", 
+nmagic
+);
+
+2224 i(
+
+->
+_lot
+ >
+LOOPALIVECNT
+*5) {
+
+2225 
+	`tf
+ ("%s:oopback\n",
+
+2226 
+i
+->
+if_xme
+);
+
+2227 
+
+->
+_lot
+ = 0;
+
+2228 i(
+i
+->
+if_ags
+ & 
+IFF_UP
+) {
+
+2229 
+	`if_down
+(
+i
+);
+
+2230 
+	`IF_PURGE
+(&
+
+->
+_q
+);
+
+2232 
+l
+.
+	`Down
+(
+
+);
+
+2233 
+l
+.
+	`Up
+(
+
+);
+
+2235 } i(
+debug
+)
+
+2236 
+	`addlog
+(" [glitch]");
+
+2237 ++
+
+->
+_lot
+;
+
+2243 
+nmagic
+ = ~
+
+->
+l
+.
+magic
+;
+
+2245 
+p
+[2] = 
+nmagic
+ >> 24;
+
+2246 
+p
+[3] = 
+nmagic
+ >> 16;
+
+2247 
+p
+[4] = 
+nmagic
+ >> 8;
+
+2248 
+p
+[5] = 
+nmagic
+;
+
+2251 
+LCP_OPT_ASYNC_MAP
+:
+
+2268 
+LCP_OPT_MRU
+:
+
+2273 
+
+->
+l
+.
+the_mru
+ = 
+p
+[2] * 256 +[3];
+
+2274 i(
+debug
+)
+
+2275 
+	`addlog
+(" %ld", 
+
+->
+l
+.
+the_mru
+);
+
+2278 
+LCP_OPT_AUTH_PROTO
+:
+
+2279 
+autho
+ = (
+p
+[2] << 8) +[3];
+
+2280 i(
+
+->
+myauth
+.
+o
+ !
+autho
+) {
+
+2282 i(
+debug
+)
+
+2283 
+	`addlog
+(" [mine %s != his %s]",
+
+2284 
+	`_o_me
+(
+
+->
+myauth
+.
+o
+),
+
+2285 
+	`_o_me
+(
+autho
+));
+
+2286 
+p
+[2] = 
+
+->
+myauth
+.
+o
+ >> 8;
+
+2287 
+p
+[3] = 
+
+->
+myauth
+.
+o
+;
+
+2290 i(
+autho
+ =
+PPP_CHAP
+ && 
+p
+[4] !
+CHAP_MD5
+) {
+
+2291 i(
+debug
+)
+
+2292 
+	`addlog
+(" [chapot MD5]");
+
+2293 
+p
+[4] = 
+CHAP_MD5
+;
+
+2299 
+	`bcy
+ (
+p
+, 
+r
+,[1]);
+
+2300 
+r
+ +
+p
+[1];
+
+2301 
+
+ +
+p
+[1];
+
+2303 i(
+
+) {
+
+2304 i(++
+
+->
+_cou
+[
+IDX_LCP
+] >->
+l
+.
+max_u
+) {
+
+2305 i(
+debug
+)
+
+2306 
+	`addlog
+(" max_failure (%d)xceeded, "
+
+2308 
+
+->
+l
+.
+max_u
+);
+
+2309 
+	`__nd
+(
+
+, 
+PPP_LCP
+, 
+CONF_REJ
+, 
+h
+->
+idt
+, 
+
+, 
+buf
+);
+
+2311 i(
+debug
+)
+
+2312 
+	`addlog
+(" send conf-nak\n");
+
+2313 
+	`__nd
+(
+
+, 
+PPP_LCP
+, 
+CONF_NAK
+, 
+h
+->
+idt
+, 
+
+, 
+buf
+);
+
+2315 
+d
+;
+
+2317 i(
+debug
+)
+
+2318 
+	`addlog
+(" send conf-ack\n");
+
+2319 
+
+->
+_cou
+[
+IDX_LCP
+] = 0;
+
+2320 
+
+->
+_lot
+ = 0;
+
+2321 
+	`__nd
+(
+
+, 
+PPP_LCP
+, 
+CONF_ACK
+, 
+h
+->
+idt
+, 
+ign
+, h + 1);
+
+2324 
+d
+:
+
+2325 
+	`
+(
+buf
+, 
+M_TEMP
+);
+
+2326  (
+
+ == 0);
+
+2328 
+dr
+:
+
+2329 
+	`
+(
+buf
+, 
+M_TEMP
+);
+
+2331 
+	}
+}
+
+2338 
+	$_l_RCN_j
+(
+
+ *
+
+, 
+l_hd
+ *
+h
+, 
+n
+)
+
+2340 
+STDDCL
+;
+
+2341 
+u_ch
+ *
+buf
+, *
+p
+;
+
+2343 
+n
+ -= 4;
+
+2344 
+buf
+ = 
+	`mloc
+ (
+n
+, 
+M_TEMP
+, 
+M_NOWAIT
+);
+
+2345 i(!
+buf
+)
+
+2348 i(
+debug
+)
+
+2349 
+	`log
+(
+LOG_DEBUG
+, "%s:cpej opts:",
+
+2350 
+i
+->
+if_xme
+);
+
+2352 
+p
+ = (*)(
+h
+ + 1);
+
+2353 ; 
+n
+ > 1 && 
+p
+[1];en -=[1], +=[1]) {
+
+2355 i(
+p
+[1] > 
+n
+) {
+
+2360 
+	`addlog
+("%s:eceived malicious LCP option, "
+
+2361 "drpg.\n", 
+i
+->
+if_xme
+);
+
+2362 
+dr
+;
+
+2364 i(
+debug
+)
+
+2365 
+	`addlog
+(" %s", 
+	`_l_t_me
+(*
+p
+));
+
+2366 *
+p
+) {
+
+2367 
+LCP_OPT_MAGIC
+:
+
+2369 
+
+->
+l
+.
+ts
+ &~(1 << 
+LCP_OPT_MAGIC
+);
+
+2370 
+
+->
+l
+.
+magic
+ = 0;
+
+2372 
+LCP_OPT_MRU
+:
+
+2379 i(
+debug
+) {
+
+2380 
+	`addlog
+("%s: warning:eerejected our MRU of "
+
+2382 
+i
+->
+if_xme
+, 
+
+->
+l
+.
+mru
+, 
+PP_MTU
+);
+
+2384 
+
+->
+l
+.
+ts
+ &~(1 << 
+LCP_OPT_MRU
+);
+
+2385 
+
+->
+l
+.
+mru
+ = 
+PP_MTU
+;
+
+2387 
+LCP_OPT_AUTH_PROTO
+:
+
+2393 i((
+
+->
+_ags
+ & 
+PP_CALLIN
+) == 0 &&
+
+2394 (
+
+->
+hiuth
+.
+ags
+ & 
+SPPP_AUTHFLAG_NOCALLOUT
+) != 0) {
+
+2395 i(
+debug
+)
+
+2396 
+	`addlog
+(" [don't insist onuth "
+
+2398 
+
+->
+l
+.
+ts
+ &~(1 << 
+LCP_OPT_AUTH_PROTO
+);
+
+2401 i(
+debug
+)
+
+2402 
+	`addlog
+("[access denied]\n");
+
+2403 
+l
+.
+	`Clo
+(
+
+);
+
+2407 i(
+debug
+)
+
+2408 
+	`addlog
+("\n");
+
+2409 
+dr
+:
+
+2410 
+	`
+(
+buf
+, 
+M_TEMP
+);
+
+2412 
+	}
+}
+
+2419 
+	$_l_RCN_k
+(
+
+ *
+
+, 
+l_hd
+ *
+h
+, 
+n
+)
+
+2421 
+STDDCL
+;
+
+2422 
+u_ch
+ *
+buf
+, *
+p
+;
+
+2423 
+ut32_t
+ 
+magic
+;
+
+2425 
+n
+ -= 4;
+
+2426 
+buf
+ = 
+	`mloc
+ (
+n
+, 
+M_TEMP
+, 
+M_NOWAIT
+);
+
+2427 i(!
+buf
+)
+
+2430 i(
+debug
+)
+
+2431 
+	`log
+(
+LOG_DEBUG
+, "%s:cpak opts:",
+
+2432 
+i
+->
+if_xme
+);
+
+2434 
+p
+ = (*)(
+h
+ + 1);
+
+2435 ; 
+n
+ > 1 && 
+p
+[1];en -=[1], +=[1]) {
+
+2437 i(
+p
+[1] > 
+n
+) {
+
+2442 
+	`addlog
+("%s:eceived malicious LCP option, "
+
+2443 "drpg.\n", 
+i
+->
+if_xme
+);
+
+2444 
+dr
+;
+
+2446 i(
+debug
+)
+
+2447 
+	`addlog
+(" %s", 
+	`_l_t_me
+(*
+p
+));
+
+2448 *
+p
+) {
+
+2449 
+LCP_OPT_MAGIC
+:
+
+2451 i((
+
+->
+l
+.
+ts
+ & (1 << 
+LCP_OPT_MAGIC
+)) &&
+
+2452 
+n
+ >6 && 
+p
+[1] == 6) {
+
+2453 
+magic
+ = (
+ut32_t
+)
+p
+[2] << 24 |
+
+2454 (
+ut32_t
+)
+p
+[3] << 16 |[4] << 8 |[5];
+
+2460 i(
+magic
+ =~
+
+->
+l
+.magic) {
+
+2461 i(
+debug
+)
+
+2462 
+	`addlog
+(" magic glitch");
+
+2463 
+
+->
+l
+.
+magic
+ = 
+	`g_32
+();
+
+2465 
+
+->
+l
+.
+magic
+ = magic;
+
+2466 i(
+debug
+)
+
+2467 
+	`addlog
+(" %d", 
+magic
+);
+
+2471 
+LCP_OPT_MRU
+:
+
+2477 i(
+n
+ >4 && 
+p
+[1] == 4) {
+
+2478 
+u_t
+ 
+mru
+ = 
+p
+[2] * 256 +[3];
+
+2479 i(
+debug
+)
+
+2480 
+	`addlog
+(" %d", 
+mru
+);
+
+2481 i(
+mru
+ < 
+PPP_MINMRU
+ || mru > 
+
+->
+_if
+.
+if_mtu
+)
+
+2482 
+mru
+ = 
+
+->
+_if
+.
+if_mtu
+;
+
+2483 
+
+->
+l
+.
+mru
+ = mru;
+
+2484 
+
+->
+l
+.
+ts
+ |(1 << 
+LCP_OPT_MRU
+);
+
+2487 
+LCP_OPT_AUTH_PROTO
+:
+
+2492 i(
+debug
+)
+
+2493 
+	`addlog
+("[access denied]\n");
+
+2494 
+l
+.
+	`Clo
+(
+
+);
+
+2498 i(
+debug
+)
+
+2499 
+	`addlog
+("\n");
+
+2500 
+dr
+:
+
+2501 
+	`
+(
+buf
+, 
+M_TEMP
+);
+
+2503 
+	}
+}
+
+2506 
+	$_l_u
+(
+
+ *
+
+)
+
+2508 
+STDDCL
+;
+
+2509 
+i
+;
+
+2510 
+ut32_t
+ 
+mask
+;
+
+2513 i(! (
+i
+->
+if_ags
+ & 
+IFF_UP
+) &&
+
+2514 (
+i
+->
+if_ags
+ & 
+IFF_RUNNING
+)) {
+
+2516 
+	`if_up
+(
+i
+);
+
+2519 
+i
+ = 0; i < 
+IDX_COUNT
+; i++)
+
+2520 i((
+s
+[
+i
+])->
+ags
+ & 
+CP_QUAL
+)
+
+2521 (
+s
+[
+i
+])->
+	`On
+(
+
+);
+
+2523 i((
+
+->
+l
+.
+ts
+ & (1 << 
+LCP_OPT_AUTH_PROTO
+)) != 0 ||
+
+2524 (
+
+->
+_ags
+ & 
+PP_NEEDAUTH
+) != 0)
+
+2525 
+
+->
+_pha
+ = 
+SPPP_PHASE_AUTHENTICATE
+;
+
+2527 
+
+->
+_pha
+ = 
+SPPP_PHASE_NETWORK
+;
+
+2529 i(
+debug
+)
+
+2531 
+	`log
+(
+LOG_INFO
+, "%s:ha %s\n", 
+i
+->
+if_xme
+,
+
+2532 
+	`_pha_me
+(
+
+->
+_pha
+));
+
+2542 
+i
+ = 0; i < 
+IDX_COUNT
+; i++)
+
+2543 i((
+s
+[
+i
+])->
+ags
+ & 
+CP_AUTH
+)
+
+2544 (
+s
+[
+i
+])->
+	`On
+(
+
+);
+
+2546 i(
+
+->
+_pha
+ =
+SPPP_PHASE_NETWORK
+) {
+
+2548 
+i
+ = 0; i < 
+IDX_COUNT
+; i++)
+
+2549 i((
+s
+[
+i
+])->
+ags
+ & 
+CP_NCP
+)
+
+2550 (
+s
+[
+i
+])->
+	`On
+(
+
+);
+
+2554 
+i
+ = 0, 
+mask
+ = 1; i < 
+IDX_COUNT
+; i++, mask <<= 1)
+
+2555 i((
+
+->
+l
+.
+os
+ & 
+mask
+&& ((
+s
+[
+i
+])->
+ags
+ & 
+CP_LCP
+) == 0)
+
+2556 (
+s
+[
+i
+])->
+	`Up
+(
+
+);
+
+2559 i(
+
+->
+_chg
+)
+
+2560 
+
+->
+	`_chg
+(, ()->
+_pha
+);
+
+2562 i(
+
+->
+_pha
+ =
+SPPP_PHASE_NETWORK
+)
+
+2564 
+	`_l_check_d_o
+(
+
+);
+
+2565 
+	}
+}
+
+2568 
+	$_l_d
+(
+
+ *
+
+)
+
+2570 
+STDDCL
+;
+
+2571 
+i
+;
+
+2572 
+ut32_t
+ 
+mask
+;
+
+2574 
+
+->
+_pha
+ = 
+SPPP_PHASE_TERMINATE
+;
+
+2576 i(
+debug
+)
+
+2578 
+	`log
+(
+LOG_INFO
+, "%s:ha %s\n", 
+i
+->
+if_xme
+,
+
+2579 
+	`_pha_me
+(
+
+->
+_pha
+));
+
+2588 
+i
+ = 0, 
+mask
+ = 1; i < 
+IDX_COUNT
+; i++, mask <<= 1)
+
+2589 i((
+
+->
+l
+.
+os
+ & 
+mask
+&& ((
+s
+[
+i
+])->
+ags
+ & 
+CP_LCP
+) == 0) {
+
+2590 (
+s
+[
+i
+])->
+	`Down
+(
+
+);
+
+2591 (
+s
+[
+i
+])->
+	`Clo
+(
+
+);
+
+2593 
+	}
+}
+
+2596 
+	$_l_s
+(
+
+ *
+
+)
+
+2598 
+STDDCL
+;
+
+2600 i(
+
+->
+_max_auth_
+ !0 && sp->
+_auth_us
+ >= sp->pp_max_auth_fail) {
+
+2601 
+	`tf
+("%s:uthentication failed %dimes,otetryinggain\n",
+
+2602 
+
+->
+_if
+.
+if_xme
+, sp->
+_auth_us
+);
+
+2603 
+	`if_down
+(&
+
+->
+_if
+);
+
+2607 
+
+->
+_pha
+ = 
+SPPP_PHASE_ESTABLISH
+;
+
+2609 i(
+debug
+)
+
+2611 
+	`log
+(
+LOG_INFO
+, "%s:ha %s\n", 
+i
+->
+if_xme
+,
+
+2612 
+	`_pha_me
+(
+
+->
+_pha
+));
+
+2616 i(
+
+->
+_s
+)
+
+2617 (
+
+->
+_s
+)(sp);
+
+2618 
+	}
+}
+
+2621 
+	$_l_f
+(
+
+ *
+
+)
+
+2623 
+STDDCL
+;
+
+2625 
+
+->
+_pha
+ = 
+SPPP_PHASE_DEAD
+;
+
+2627 i(
+debug
+)
+
+2629 
+	`log
+(
+LOG_INFO
+, "%s:ha %s\n", 
+i
+->
+if_xme
+,
+
+2630 
+	`_pha_me
+(
+
+->
+_pha
+));
+
+2634 i(
+
+->
+_f
+)
+
+2635 (
+
+->
+_f
+)(sp);
+
+2636 
+	}
+}
+
+2639 
+	$_l_s
+(
+
+ *
+
+)
+
+2641 
+t
+[6 + 4 + 5 ];
+
+2642 
+i
+ = 0;
+
+2643 
+u_sht
+ 
+autho
+;
+
+2645 i(
+
+->
+l
+.
+ts
+ & (1 << 
+LCP_OPT_MAGIC
+)) {
+
+2646 i(! 
+
+->
+l
+.
+magic
+)
+
+2647 
+
+->
+l
+.
+magic
+ = 
+	`g_32
+();
+
+2648 
+t
+[
+i
+++] = 
+LCP_OPT_MAGIC
+;
+
+2649 
+t
+[
+i
+++] = 6;
+
+2650 
+t
+[
+i
+++] = 
+
+->
+l
+.
+magic
+ >> 24;
+
+2651 
+t
+[
+i
+++] = 
+
+->
+l
+.
+magic
+ >> 16;
+
+2652 
+t
+[
+i
+++] = 
+
+->
+l
+.
+magic
+ >> 8;
+
+2653 
+t
+[
+i
+++] = 
+
+->
+l
+.
+magic
+;
+
+2656 i(
+
+->
+l
+.
+ts
+ & (1 << 
+LCP_OPT_MRU
+)) {
+
+2657 
+t
+[
+i
+++] = 
+LCP_OPT_MRU
+;
+
+2658 
+t
+[
+i
+++] = 4;
+
+2659 
+t
+[
+i
+++] = 
+
+->
+l
+.
+mru
+ >> 8;
+
+2660 
+t
+[
+i
+++] = 
+
+->
+l
+.
+mru
+;
+
+2663 i(
+
+->
+l
+.
+ts
+ & (1 << 
+LCP_OPT_AUTH_PROTO
+)) {
+
+2664 
+autho
+ = 
+
+->
+hiuth
+.
+o
+;
+
+2665 
+t
+[
+i
+++] = 
+LCP_OPT_AUTH_PROTO
+;
+
+2666 
+t
+[
+i
+++] = 
+autho
+ =
+PPP_CHAP
+? 5: 4;
+
+2667 
+t
+[
+i
+++] = 
+autho
+ >> 8;
+
+2668 
+t
+[
+i
+++] = 
+autho
+;
+
+2669 i(
+autho
+ =
+PPP_CHAP
+)
+
+2670 
+t
+[
+i
+++] = 
+CHAP_MD5
+;
+
+2673 
+
+->
+cfid
+[
+IDX_LCP
+] = ++->
+_q
+[IDX_LCP];
+
+2674 
+	`__nd
+(
+
+, 
+PPP_LCP
+, 
+CONF_REQ
+, sp->
+cfid
+[
+IDX_LCP
+], 
+i
+, &
+t
+);
+
+2675 
+	}
+}
+
+2681 
+	$_n_check
+(
+
+ *
+
+)
+
+2683 
+i
+, 
+mask
+;
+
+2685 
+i
+ = 0, 
+mask
+ = 1; i < 
+IDX_COUNT
+; i++, mask <<= 1)
+
+2686 i((
+
+->
+l
+.
+os
+ & 
+mask
+&& (
+s
+[
+i
+])->
+ags
+ & 
+CP_NCP
+)
+
+2689 
+	}
+}
+
+2696 
+	$_l_check_d_o
+(
+
+ *
+
+)
+
+2699 i(
+
+->
+_pha
+ < 
+SPPP_PHASE_NETWORK
+)
+
+2703 i(
+	`_n_check
+(
+
+))
+
+2706 
+l
+.
+	`Clo
+(
+
+);
+
+2707 
+	}
+}
+
+2719 
+	$__
+(
+
+ *
+
+)
+
+2721 
+
+->
+
+.
+ts
+ = 0;
+
+2722 
+
+->
+
+.
+ags
+ = 0;
+
+2723 
+
+->
+e
+[
+IDX_IPCP
+] = 
+STATE_INITIAL
+;
+
+2724 
+
+->
+_cou
+[
+IDX_IPCP
+] = 0;
+
+2725 
+
+->
+_q
+[
+IDX_IPCP
+] = 0;
+
+2726 
+
+->
+_rq
+[
+IDX_IPCP
+] = 0;
+
+2727 
+	`out_
+(&
+
+->
+ch
+[
+IDX_IPCP
+], 0);
+
+2728 
+	}
+}
+
+2731 
+	$__up
+(
+
+ *
+
+)
+
+2733 
+	`_up_evt
+(&
+
+, 
+
+);
+
+2734 
+	}
+}
+
+2737 
+	$__down
+(
+
+ *
+
+)
+
+2739 
+	`_down_evt
+(&
+
+, 
+
+);
+
+2740 
+	}
+}
+
+2743 
+	$__
+(
+
+ *
+
+)
+
+2745 
+STDDCL
+;
+
+2746 
+ut32_t
+ 
+myaddr
+, 
+hiddr
+;
+
+2748 
+
+->
+
+.
+ags
+ &~(
+IPCP_HISADDR_SEEN
+|
+IPCP_MYADDR_SEEN
+|
+IPCP_MYADDR_DYN
+|
+IPCP_HISADDR_DYN
+);
+
+2749 
+
+->
+
+.
+q_myaddr
+ = 0;
+
+2750 
+
+->
+
+.
+q_hiddr
+ = 0;
+
+2751 
+	`memt
+(&
+
+->
+dns_addrs
+, 0,  sp->dns_addrs);
+
+2753 #ifde
+INET
+
+
+2754 
+	`_g__addrs
+(
+
+, &
+myaddr
+, &
+hiddr
+, 0);
+
+2756 
+myaddr
+ = 
+hiddr
+ = 0;
+
+2764 i(
+hiddr
+ == 0) {
+
+2766 i(
+debug
+)
+
+2767 
+	`log
+(
+LOG_DEBUG
+, "%s: ipcp_open():o IP interface\n",
+
+2768 
+i
+->
+if_xme
+);
+
+2772 i(
+myaddr
+ == 0) {
+
+2777 
+
+->
+
+.
+ags
+ |
+IPCP_MYADDR_DYN
+;
+
+2778 
+
+->
+
+.
+ts
+ |(1 << 
+IPCP_OPT_ADDRESS
+);
+
+2780 i(
+hiddr
+ == 1) {
+
+2785 
+
+->
+
+.
+ags
+ |
+IPCP_HISADDR_DYN
+;
+
+2787 
+	`__evt
+(&
+
+, 
+
+);
+
+2788 
+	}
+}
+
+2791 
+	$__o
+(
+
+ *
+
+)
+
+2793 
+STDDCL
+;
+
+2795 
+	`_o_evt
+(&
+
+, 
+
+);
+
+2796 #ifde
+INET
+
+
+2797 i(
+
+->
+
+.
+ags
+ & (
+IPCP_MYADDR_DYN
+|
+IPCP_HISADDR_DYN
+))
+
+2801 
+	`_r__addrs
+(
+
+);
+
+2804 i(
+
+->
+_ved_mtu
+ > 0) {
+
+2805 
+i
+->
+if_mtu
+ = 
+
+->
+_ved_mtu
+;
+
+2806 
+
+->
+_ved_mtu
+ = 0;
+
+2807 i(
+debug
+)
+
+2808 
+	`log
+(
+LOG_DEBUG
+,
+
+2809 "%s:eg MTU%" 
+PRIu64
+ " bytes\n",
+
+2810 
+i
+->
+if_xme
+, i->
+if_mtu
+);
+
+2812 
+	}
+}
+
+2815 
+	$__TO
+(*
+cook
+)
+
+2817 
+	`_to_evt
+(&
+
+, (
+
+ *)
+cook
+);
+
+2818 
+	}
+}
+
+2827 
+	$__RCR
+(
+
+ *
+
+, 
+l_hd
+ *
+h
+, 
+n
+)
+
+2829 
+u_ch
+ *
+buf
+, *
+r
+, *
+p
+;
+
+2830 
+i
+ *
+i
+ = &
+
+->
+_if
+;
+
+2831 
+
+, 
+ign
+, 
+debug
+ = 
+i
+->
+if_ags
+ & 
+IFF_DEBUG
+;
+
+2832 
+ut32_t
+ 
+hiddr
+, 
+desedaddr
+;
+
+2834 
+n
+ -= 4;
+
+2835 
+ign
+ = 
+n
+;
+
+2840 
+buf
+ = 
+r
+ = 
+	`mloc
+ ((
+n
+ < 6? 6:), 
+M_TEMP
+, 
+M_NOWAIT
+);
+
+2841 i(! 
+buf
+)
+
+2845 i(
+debug
+)
+
+2846 
+	`log
+(
+LOG_DEBUG
+, "%s: ipcparse opts:",
+
+2847 
+i
+->
+if_xme
+);
+
+2848 
+p
+ = (*)(
+h
+ + 1);
+
+2849 
+
+=0; 
+n
+>1 && 
+p
+[1];en-=p[1],+=p[1]) {
+
+2851 i(
+p
+[1] > 
+n
+) {
+
+2853 
+	`addlog
+("%s: malicious IPCP optioneceived, dropping\n",
+
+2854 
+i
+->
+if_xme
+);
+
+2855 
+dr
+;
+
+2857 i(
+debug
+)
+
+2858 
+	`addlog
+(" %s", 
+	`__t_me
+(*
+p
+));
+
+2859 *
+p
+) {
+
+2860 #ifde
+ny
+
+
+2861 
+IPCP_OPT_COMPRESSION
+:
+
+2862 i(
+n
+ >6 && 
+p
+[1] >= 6) {
+
+2866 i(
+debug
+)
+
+2867 
+	`addlog
+(" [invalid]");
+
+2870 
+IPCP_OPT_ADDRESS
+:
+
+2871 i(
+n
+ >6 && 
+p
+[1] == 6) {
+
+2875 i(
+debug
+)
+
+2876 
+	`addlog
+(" [invalid]");
+
+2880 i(
+debug
+)
+
+2881 
+	`addlog
+(" [rej]");
+
+2885 
+	`bcy
+ (
+p
+, 
+r
+,[1]);
+
+2886 
+r
+ +
+p
+[1];
+
+2887 
+
+ +
+p
+[1];
+
+2889 i(
+
+) {
+
+2890 i(
+debug
+)
+
+2891 
+	`addlog
+(" send conf-rej\n");
+
+2892 
+	`__nd
+(
+
+, 
+PPP_IPCP
+, 
+CONF_REJ
+, 
+h
+->
+idt
+, 
+
+, 
+buf
+);
+
+2893 
+d
+;
+
+2894 } i(
+debug
+)
+
+2895 
+	`addlog
+("\n");
+
+2898 i(
+
+->
+
+.
+ags
+ & 
+IPCP_HISADDR_SEEN
+)
+
+2899 
+hiddr
+ = 
+
+->
+
+.
+q_hiddr
+;
+
+2901 #ifde
+INET
+
+
+2902 
+	`_g__addrs
+(
+
+, 0, &
+hiddr
+, 0);
+
+2904 
+hiddr
+ = 0;
+
+2906 i(
+debug
+)
+
+2907 
+	`log
+(
+LOG_DEBUG
+, "%s: ipcparse opt values: ",
+
+2908 
+i
+->
+if_xme
+);
+
+2909 
+p
+ = (*)(
+h
+ + 1);
+
+2910 
+n
+ = 
+ign
+;
+
+2911 
+
+=0; 
+n
+>1 && 
+p
+[1];en-=p[1],+=p[1]) {
+
+2912 i(
+debug
+)
+
+2913 
+	`addlog
+(" %s", 
+	`__t_me
+(*
+p
+));
+
+2914 *
+p
+) {
+
+2915 #ifde
+ny
+
+
+2916 
+IPCP_OPT_COMPRESSION
+:
+
+2919 
+IPCP_OPT_ADDRESS
+:
+
+2920 
+desedaddr
+ = 
+p
+[2] << 24 |[3] << 16 |
+
+2921 
+p
+[4] << 8 |[5];
+
+2922 i(
+desedaddr
+ =
+hiddr
+ ||
+
+2923 ((
+
+->
+
+.
+ags
+ & 
+IPCP_HISADDR_DYN
+&& 
+desedaddr
+ != 0)) {
+
+2929 i(
+debug
+)
+
+2930 
+	`addlog
+(" %s [ack]",
+
+2931 
+	`_dd_quad
+(
+hiddr
+));
+
+2933 
+
+->
+
+.
+ags
+ |
+IPCP_HISADDR_SEEN
+;
+
+2934 
+
+->
+
+.
+q_hiddr
+ = 
+desedaddr
+;
+
+2935 
+hiddr
+ = 
+desedaddr
+;
+
+2945 i(
+debug
+) {
+
+2946 i(
+desedaddr
+ == 0)
+
+2947 
+	`addlog
+(" [addrequested]");
+
+2949 
+	`addlog
+(" %s [notgreed]",
+
+2950 
+	`_dd_quad
+(
+desedaddr
+));
+
+2953 
+p
+[2] = 
+hiddr
+ >> 24;
+
+2954 
+p
+[3] = 
+hiddr
+ >> 16;
+
+2955 
+p
+[4] = 
+hiddr
+ >> 8;
+
+2956 
+p
+[5] = 
+hiddr
+;
+
+2960 
+	`bcy
+ (
+p
+, 
+r
+,[1]);
+
+2961 
+r
+ +
+p
+[1];
+
+2962 
+
+ +
+p
+[1];
+
+2975 i(
+
+ =0 && !(
+
+->
+
+.
+ags
+ & 
+IPCP_HISADDR_SEEN
+)) {
+
+2976 
+buf
+[0] = 
+IPCP_OPT_ADDRESS
+;
+
+2977 
+buf
+[1] = 6;
+
+2978 
+buf
+[2] = 
+hiddr
+ >> 24;
+
+2979 
+buf
+[3] = 
+hiddr
+ >> 16;
+
+2980 
+buf
+[4] = 
+hiddr
+ >> 8;
+
+2981 
+buf
+[5] = 
+hiddr
+;
+
+2982 
+
+ = 6;
+
+2983 i(
+debug
+)
+
+2984 
+	`addlog
+(" stilleed hisaddr");
+
+2987 i(
+
+) {
+
+2988 i(
+debug
+)
+
+2989 
+	`addlog
+(" send conf-nak\n");
+
+2990 
+	`__nd
+(
+
+, 
+PPP_IPCP
+, 
+CONF_NAK
+, 
+h
+->
+idt
+, 
+
+, 
+buf
+);
+
+2992 i(
+debug
+)
+
+2993 
+	`addlog
+(" send conf-ack\n");
+
+2994 
+	`__nd
+(
+
+, 
+PPP_IPCP
+, 
+CONF_ACK
+, 
+h
+->
+idt
+, 
+ign
+, h + 1);
+
+2997 
+d
+:
+
+2998 
+	`
+(
+buf
+, 
+M_TEMP
+);
+
+2999  (
+
+ == 0);
+
+3001 
+dr
+:
+
+3002 
+	`
+(
+buf
+, 
+M_TEMP
+);
+
+3004 
+	}
+}
+
+3011 
+	$__RCN_j
+(
+
+ *
+
+, 
+l_hd
+ *
+h
+, 
+n
+)
+
+3013 
+u_ch
+ *
+buf
+, *
+p
+;
+
+3014 
+i
+ *
+i
+ = &
+
+->
+_if
+;
+
+3015 
+debug
+ = 
+i
+->
+if_ags
+ & 
+IFF_DEBUG
+;
+
+3017 
+n
+ -= 4;
+
+3018 
+buf
+ = 
+	`mloc
+ (
+n
+, 
+M_TEMP
+, 
+M_NOWAIT
+);
+
+3019 i(!
+buf
+)
+
+3022 i(
+debug
+)
+
+3023 
+	`log
+(
+LOG_DEBUG
+, "%s: ipcpej opts:",
+
+3024 
+i
+->
+if_xme
+);
+
+3026 
+p
+ = (*)(
+h
+ + 1);
+
+3027 ; 
+n
+ > 1 && 
+p
+[1];en -=[1], +=[1]) {
+
+3029 i(
+p
+[1] > 
+n
+) {
+
+3031 
+	`addlog
+("%s: malicious IPCP optioneceived, dropping\n",
+
+3032 
+i
+->
+if_xme
+);
+
+3033 
+dr
+;
+
+3035 i(
+debug
+)
+
+3036 
+	`addlog
+(" %s", 
+	`__t_me
+(*
+p
+));
+
+3037 *
+p
+) {
+
+3038 
+IPCP_OPT_ADDRESS
+:
+
+3043 
+
+->
+
+.
+ts
+ &~(1 << 
+IPCP_OPT_ADDRESS
+);
+
+3045 #ifde
+ny
+
+
+3046 
+IPCP_OPT_COMPRESS
+:
+
+3047 
+
+->
+
+.
+ts
+ &~(1 << 
+IPCP_OPT_COMPRESS
+);
+
+3052 i(
+debug
+)
+
+3053 
+	`addlog
+("\n");
+
+3054 
+dr
+:
+
+3055 
+	`
+(
+buf
+, 
+M_TEMP
+);
+
+3057 
+	}
+}
+
+3064 
+	$__RCN_k
+(
+
+ *
+
+, 
+l_hd
+ *
+h
+, 
+n
+)
+
+3066 
+u_ch
+ *
+p
+;
+
+3067 
+i
+ *
+i
+ = &
+
+->
+_if
+;
+
+3068 
+debug
+ = 
+i
+->
+if_ags
+ & 
+IFF_DEBUG
+;
+
+3069 
+ut32_t
+ 
+wddr
+;
+
+3071 
+n
+ -= 4;
+
+3073 i(
+debug
+)
+
+3074 
+	`log
+(
+LOG_DEBUG
+, "%s: ipcpak opts:",
+
+3075 
+i
+->
+if_xme
+);
+
+3077 
+p
+ = (*)(
+h
+ + 1);
+
+3078 ; 
+n
+ > 1 && 
+p
+[1];en -=[1], +=[1]) {
+
+3080 i(
+p
+[1] > 
+n
+) {
+
+3082 
+	`addlog
+("%s: malicious IPCP optioneceived, dropping\n",
+
+3083 
+i
+->
+if_xme
+);
+
+3086 i(
+debug
+)
+
+3087 
+	`addlog
+(" %s", 
+	`__t_me
+(*
+p
+));
+
+3088 *
+p
+) {
+
+3089 
+IPCP_OPT_ADDRESS
+:
+
+3095 i(
+n
+ >6 && 
+p
+[1] == 6) {
+
+3096 
+wddr
+ = 
+p
+[2] << 24 |[3] << 16 |
+
+3097 
+p
+[4] << 8 |[5];
+
+3098 
+
+->
+
+.
+ts
+ |(1 << 
+IPCP_OPT_ADDRESS
+);
+
+3099 i(
+debug
+)
+
+3100 
+	`addlog
+(" [wantaddr %s]",
+
+3101 
+	`_dd_quad
+(
+wddr
+));
+
+3108 i(
+
+->
+
+.
+ags
+ & 
+IPCP_MYADDR_DYN
+) {
+
+3109 i(
+debug
+)
+
+3110 
+	`addlog
+(" [agree]");
+
+3111 
+
+->
+
+.
+ags
+ |
+IPCP_MYADDR_SEEN
+;
+
+3112 
+
+->
+
+.
+q_myaddr
+ = 
+wddr
+;
+
+3117 
+IPCP_OPT_PRIMDNS
+:
+
+3118 i(
+n
+ >6 && 
+p
+[1] == 6) {
+
+3119 
+
+->
+dns_addrs
+[0] = 
+p
+[2] << 24 |[3] << 16 |
+
+3120 
+p
+[4] << 8 |[5];
+
+3124 
+IPCP_OPT_SECDNS
+:
+
+3125 i(
+n
+ >6 && 
+p
+[1] == 6) {
+
+3126 
+
+->
+dns_addrs
+[1] = 
+p
+[2] << 24 |[3] << 16 |
+
+3127 
+p
+[4] << 8 |[5];
+
+3130 #ifde
+ny
+
+
+3131 
+IPCP_OPT_COMPRESS
+:
+
+3139 i(
+debug
+)
+
+3140 
+	`addlog
+("\n");
+
+3141 
+	}
+}
+
+3144 
+	$__u
+(
+
+ *
+
+)
+
+3146 #ifde
+INET
+
+
+3148 
+STDDCL
+;
+
+3149 
+ut32_t
+ 
+myaddr
+, 
+hiddr
+;
+
+3151 
+	`_g__addrs
+(
+
+, &
+myaddr
+, &
+hiddr
+, 0);
+
+3152 i((
+
+->
+
+.
+ags
+ & 
+IPCP_MYADDR_DYN
+&& (->.ag& 
+IPCP_MYADDR_SEEN
+))
+
+3153 
+myaddr
+ = 
+
+->
+
+.
+q_myaddr
+;
+
+3154 i((
+
+->
+
+.
+ags
+ & 
+IPCP_HISADDR_DYN
+&& (->.ag& 
+IPCP_HISADDR_SEEN
+))
+
+3155 
+hiddr
+ = 
+
+->
+
+.
+q_hiddr
+;
+
+3156 
+	`_t__addrs
+(
+
+, 
+myaddr
+, 
+hiddr
+);
+
+3158 i(
+i
+->
+if_mtu
+ > 
+
+->
+l
+.
+the_mru
+) {
+
+3159 
+
+->
+_ved_mtu
+ = 
+i
+->
+if_mtu
+;
+
+3160 
+i
+->
+if_mtu
+ = 
+
+->
+l
+.
+the_mru
+;
+
+3161 i(
+debug
+)
+
+3162 
+	`log
+(
+LOG_DEBUG
+,
+
+3163 "%s: stg MTU%" 
+PRIu64
+ " bytes\n",
+
+3164 
+i
+->
+if_xme
+, i->
+if_mtu
+);
+
+3167 i(
+
+->
+_c
+)
+
+3168 
+
+->
+	`_c
+(sp);
+
+3170 
+	}
+}
+
+3173 
+	$__d
+(
+
+ *
+
+)
+
+3175 
+	}
+}
+
+3178 
+	$__s
+(
+
+ *
+
+)
+
+3181 
+
+->
+l
+.
+os
+ |(1 << 
+IDX_IPCP
+);
+
+3182 
+	}
+}
+
+3185 
+	$__f
+(
+
+ *
+
+)
+
+3188 
+
+->
+l
+.
+os
+ &~(1 << 
+IDX_IPCP
+);
+
+3189 
+	}
+}
+
+3192 
+	$__s
+(
+
+ *
+
+)
+
+3194 
+t
+[6 + 6 + 12 ];
+
+3195 #ifde
+INET
+
+
+3196 
+ut32_t
+ 
+ouddr
+;
+
+3198 
+i
+ = 0;
+
+3200 #ifde
+ny
+
+
+3201 i(
+
+->
+
+.
+ts
+ & (1 << 
+IPCP_OPT_COMPRESSION
+)) {
+
+3202 
+t
+[
+i
+++] = 
+IPCP_OPT_COMPRESSION
+;
+
+3203 
+t
+[
+i
+++] = 6;
+
+3204 
+t
+[
+i
+++] = 0;
+
+3205 
+t
+[
+i
+++] = 0x2d;
+
+3206 
+t
+[
+i
+++] = 
+max__id
+;
+
+3207 
+t
+[
+i
+++] = 
+comp__id
+;
+
+3211 #ifde
+INET
+
+
+3212 i(
+
+->
+
+.
+ts
+ & (1 << 
+IPCP_OPT_ADDRESS
+)) {
+
+3213 i(
+
+->
+
+.
+ags
+ & 
+IPCP_MYADDR_SEEN
+)
+
+3214 
+ouddr
+ = 
+
+->
+
+.
+q_myaddr
+;
+
+3216 
+	`_g__addrs
+(
+
+, &
+ouddr
+, 0, 0);
+
+3217 
+t
+[
+i
+++] = 
+IPCP_OPT_ADDRESS
+;
+
+3218 
+t
+[
+i
+++] = 6;
+
+3219 
+t
+[
+i
+++] = 
+ouddr
+ >> 24;
+
+3220 
+t
+[
+i
+++] = 
+ouddr
+ >> 16;
+
+3221 
+t
+[
+i
+++] = 
+ouddr
+ >> 8;
+
+3222 
+t
+[
+i
+++] = 
+ouddr
+;
+
+3226 i(
+
+->
+quy_dns
+ & 1) {
+
+3227 
+t
+[
+i
+++] = 
+IPCP_OPT_PRIMDNS
+;
+
+3228 
+t
+[
+i
+++] = 6;
+
+3229 
+t
+[
+i
+++] = 
+
+->
+dns_addrs
+[0] >> 24;
+
+3230 
+t
+[
+i
+++] = 
+
+->
+dns_addrs
+[0] >> 16;
+
+3231 
+t
+[
+i
+++] = 
+
+->
+dns_addrs
+[0] >> 8;
+
+3232 
+t
+[
+i
+++] = 
+
+->
+dns_addrs
+[0];
+
+3234 i(
+
+->
+quy_dns
+ & 2) {
+
+3235 
+t
+[
+i
+++] = 
+IPCP_OPT_SECDNS
+;
+
+3236 
+t
+[
+i
+++] = 6;
+
+3237 
+t
+[
+i
+++] = 
+
+->
+dns_addrs
+[1] >> 24;
+
+3238 
+t
+[
+i
+++] = 
+
+->
+dns_addrs
+[1] >> 16;
+
+3239 
+t
+[
+i
+++] = 
+
+->
+dns_addrs
+[1] >> 8;
+
+3240 
+t
+[
+i
+++] = 
+
+->
+dns_addrs
+[1];
+
+3243 
+
+->
+cfid
+[
+IDX_IPCP
+] = ++->
+_q
+[IDX_IPCP];
+
+3244 
+	`__nd
+(
+
+, 
+PPP_IPCP
+, 
+CONF_REQ
+, sp->
+cfid
+[
+IDX_IPCP
+], 
+i
+, &
+t
+);
+
+3245 
+	}
+}
+
+3256 #ifde
+INET6
+
+
+3258 
+	$_v6_
+(
+
+ *
+
+)
+
+3260 
+
+->
+v6
+.
+ts
+ = 0;
+
+3261 
+
+->
+v6
+.
+ags
+ = 0;
+
+3262 
+
+->
+e
+[
+IDX_IPV6CP
+] = 
+STATE_INITIAL
+;
+
+3263 
+
+->
+_cou
+[
+IDX_IPV6CP
+] = 0;
+
+3264 
+
+->
+_q
+[
+IDX_IPV6CP
+] = 0;
+
+3265 
+
+->
+_rq
+[
+IDX_IPV6CP
+] = 0;
+
+3266 
+	`out_
+(&
+
+->
+ch
+[
+IDX_IPV6CP
+], 0);
+
+3267 
+	}
+}
+
+3270 
+	$_v6_up
+(
+
+ *
+
+)
+
+3272 
+	`_up_evt
+(&
+v6
+, 
+
+);
+
+3273 
+	}
+}
+
+3276 
+	$_v6_down
+(
+
+ *
+
+)
+
+3278 
+	`_down_evt
+(&
+v6
+, 
+
+);
+
+3279 
+	}
+}
+
+3282 
+	$_v6_
+(
+
+ *
+
+)
+
+3284 
+STDDCL
+;
+
+3285 
+6_addr
+ 
+myaddr
+, 
+hiddr
+;
+
+3287 #ifde
+IPV6CP_MYIFID_DYN
+
+
+3288 
+
+->
+v6
+.
+ags
+ &~(
+IPV6CP_MYIFID_SEEN
+|
+IPV6CP_MYIFID_DYN
+);
+
+3290 
+
+->
+v6
+.
+ags
+ &~
+IPV6CP_MYIFID_SEEN
+;
+
+3293 
+	`_g_6_addrs
+(
+
+, &
+myaddr
+, &
+hiddr
+, 0);
+
+3300 i(
+	`IN6_IS_ADDR_UNSPECIFIED
+(&
+myaddr
+)) {
+
+3302 i(
+debug
+)
+
+3303 
+	`log
+(
+LOG_DEBUG
+, "%s: ipv6cp_open():o IPv6 interface\n",
+
+3304 
+i
+->
+if_xme
+);
+
+3308 
+
+->
+v6
+.
+ags
+ |
+IPV6CP_MYIFID_SEEN
+;
+
+3309 
+
+->
+v6
+.
+ts
+ |(1 << 
+IPV6CP_OPT_IFID
+);
+
+3310 
+	`__evt
+(&
+v6
+, 
+
+);
+
+3311 
+	}
+}
+
+3314 
+	$_v6_o
+(
+
+ *
+
+)
+
+3316 
+	`_o_evt
+(&
+v6
+, 
+
+);
+
+3317 
+	}
+}
+
+3320 
+	$_v6_TO
+(*
+cook
+)
+
+3322 
+	`_to_evt
+(&
+v6
+, (
+
+ *)
+cook
+);
+
+3323 
+	}
+}
+
+3332 
+	$_v6_RCR
+(
+
+ *
+
+, 
+l_hd
+ *
+h
+, 
+n
+)
+
+3334 
+u_ch
+ *
+buf
+, *
+r
+, *
+p
+;
+
+3335 
+i
+ *
+i
+ = &
+
+->
+_if
+;
+
+3336 
+
+, 
+ign
+, 
+debug
+ = 
+i
+->
+if_ags
+ & 
+IFF_DEBUG
+;
+
+3337 
+6_addr
+ 
+myaddr
+, 
+desedaddr
+, 
+suggeaddr
+;
+
+3338 
+ifidcou
+;
+
+3339 
+ty
+;
+
+3340 
+clisi
+, 
+nohiddr
+;
+
+3342 
+n
+ -= 4;
+
+3343 
+ign
+ = 
+n
+;
+
+3348 
+buf
+ = 
+r
+ = 
+	`mloc
+ ((
+n
+ < 6? 6:), 
+M_TEMP
+, 
+M_NOWAIT
+);
+
+3349 i(! 
+buf
+)
+
+3353 i(
+debug
+)
+
+3354 
+	`log
+(
+LOG_DEBUG
+, "%s: ipv6cparse opts:",
+
+3355 
+i
+->
+if_xme
+);
+
+3356 
+p
+ = (*)(
+h
+ + 1);
+
+3357 
+ifidcou
+ = 0;
+
+3358 
+
+=0; 
+n
+>1 && 
+p
+[1];en-=p[1],+=p[1]) {
+
+3360 i(
+p
+[1] > 
+n
+) {
+
+3362 
+	`addlog
+("%s:eceived malicious IPCPv6 option, "
+
+3363 "drpg\n", 
+i
+->
+if_xme
+);
+
+3364 
+dr
+;
+
+3366 i(
+debug
+)
+
+3367 
+	`addlog
+(" %s", 
+	`_v6_t_me
+(*
+p
+));
+
+3368 *
+p
+) {
+
+3369 
+IPV6CP_OPT_IFID
+:
+
+3370 i(
+n
+ >10 && 
+p
+[1] =10 && 
+ifidcou
+ == 0) {
+
+3372 
+ifidcou
+++;
+
+3375 i(
+debug
+)
+
+3376 
+	`addlog
+(" [invalid]");
+
+3378 #ifde
+ny
+
+
+3379 
+IPV6CP_OPT_COMPRESSION
+:
+
+3380 i(
+n
+ >4 && 
+p
+[1] >= 4) {
+
+3384 i(
+debug
+)
+
+3385 
+	`addlog
+(" [invalid]");
+
+3390 i(
+debug
+)
+
+3391 
+	`addlog
+(" [rej]");
+
+3395 
+	`bcy
+ (
+p
+, 
+r
+,[1]);
+
+3396 
+r
+ +
+p
+[1];
+
+3397 
+
+ +
+p
+[1];
+
+3399 i(
+
+) {
+
+3400 i(
+debug
+)
+
+3401 
+	`addlog
+(" send conf-rej\n");
+
+3402 
+	`__nd
+(
+
+, 
+PPP_IPV6CP
+, 
+CONF_REJ
+, 
+h
+->
+idt
+, 
+
+, 
+buf
+);
+
+3403 
+d
+;
+
+3404 } i(
+debug
+)
+
+3405 
+	`addlog
+("\n");
+
+3408 
+	`_g_6_addrs
+(
+
+, &
+myaddr
+, 0, 0);
+
+3409 i(
+debug
+)
+
+3410 
+	`log
+(
+LOG_DEBUG
+, "%s: ipv6cparse opt values: ",
+
+3411 
+i
+->
+if_xme
+);
+
+3412 
+p
+ = (*)(
+h
+ + 1);
+
+3413 
+n
+ = 
+ign
+;
+
+3414 
+ty
+ = 
+CONF_ACK
+;
+
+3415 
+
+=0; 
+n
+>1 && 
+p
+[1];en-=p[1],+=p[1]) {
+
+3416 i(
+debug
+)
+
+3417 
+	`addlog
+(" %s", 
+	`_v6_t_me
+(*
+p
+));
+
+3418 *
+p
+) {
+
+3419 #ifde
+ny
+
+
+3420 
+IPV6CP_OPT_COMPRESSION
+:
+
+3423 
+IPV6CP_OPT_IFID
+:
+
+3424 
+	`memt
+(&
+desedaddr
+, 0, (desiredaddr));
+
+3425 
+	`memy
+(&
+desedaddr
+.
+s6_addr
+[8], &
+p
+[2], 8);
+
+3426 
+clisi
+ = (
+	`memcmp
+(&
+desedaddr
+.
+s6_addr
+[8],
+
+3427 &
+myaddr
+.
+s6_addr
+[8], 8) == 0);
+
+3428 
+nohiddr
+ = 
+	`IN6_IS_ADDR_UNSPECIFIED
+(&
+desedaddr
+);
+
+3430 
+desedaddr
+.
+s6_addr16
+[0] = 
+	`hts
+(0xfe80);
+
+3431 ()
+	`6_tsce
+(&
+desedaddr
+, &
+
+->
+_if
+, 
+NULL
+);
+
+3433 i(!
+clisi
+ && !
+nohiddr
+) {
+
+3435 
+ty
+ = 
+CONF_ACK
+;
+
+3437 i(
+debug
+) {
+
+3438 
+	`addlog
+(" %s [%s]",
+
+3439 
+	`6_rtf
+(&
+desedaddr
+),
+
+3440 
+	`__ty_me
+(
+ty
+));
+
+3445 
+	`memt
+(&
+suggeaddr
+, 0, (suggestaddr));
+
+3446 i(
+clisi
+ && 
+nohiddr
+) {
+
+3448 
+ty
+ = 
+CONF_REJ
+;
+
+3449 
+	`memt
+(&
+p
+[2], 0, 8);
+
+3456 
+ty
+ = 
+CONF_NAK
+;
+
+3457 
+	`_sugge_6_addr
+(
+
+, &
+suggeaddr
+);
+
+3458 
+	`memy
+(&
+p
+[2], &
+suggeaddr
+.
+s6_addr
+[8], 8);
+
+3460 i(
+debug
+)
+
+3461 
+	`addlog
+(" %[%s]", 
+	`6_rtf
+(&
+desedaddr
+),
+
+3462 
+	`__ty_me
+(
+ty
+));
+
+3466 
+	`bcy
+ (
+p
+, 
+r
+,[1]);
+
+3467 
+r
+ +
+p
+[1];
+
+3468 
+
+ +
+p
+[1];
+
+3471 i(
+
+ =0 && 
+ty
+ =
+CONF_ACK
+) {
+
+3472 i(
+debug
+)
+
+3473 
+	`addlog
+(" sd %s\n", 
+	`__ty_me
+(
+ty
+));
+
+3474 
+	`__nd
+(
+
+, 
+PPP_IPV6CP
+, 
+ty
+, 
+h
+->
+idt
+, 
+ign
+, h + 1);
+
+3476 #ifde
+ndef
+
+
+3477 i(
+ty
+ =
+CONF_ACK
+)
+
+3478 
+	`nic
+("IPv6CP RCR: CONF_ACK withon-zerolen");
+
+3481 i(
+debug
+) {
+
+3482 
+	`addlog
+(" send %s suggest %s\n",
+
+3483 
+	`__ty_me
+(
+ty
+), 
+	`6_rtf
+(&
+suggeaddr
+));
+
+3485 
+	`__nd
+(
+
+, 
+PPP_IPV6CP
+, 
+ty
+, 
+h
+->
+idt
+, 
+
+, 
+buf
+);
+
+3488 
+d
+:
+
+3489 
+	`
+(
+buf
+, 
+M_TEMP
+);
+
+3490  (
+
+ == 0);
+
+3492 
+dr
+:
+
+3493 
+	`
+(
+buf
+, 
+M_TEMP
+);
+
+3495 
+	}
+}
+
+3502 
+	$_v6_RCN_j
+(
+
+ *
+
+, 
+l_hd
+ *
+h
+, 
+n
+)
+
+3504 
+u_ch
+ *
+buf
+, *
+p
+;
+
+3505 
+i
+ *
+i
+ = &
+
+->
+_if
+;
+
+3506 
+debug
+ = 
+i
+->
+if_ags
+ & 
+IFF_DEBUG
+;
+
+3508 
+n
+ -= 4;
+
+3509 
+buf
+ = 
+	`mloc
+ (
+n
+, 
+M_TEMP
+, 
+M_NOWAIT
+);
+
+3510 i(!
+buf
+)
+
+3513 i(
+debug
+)
+
+3514 
+	`log
+(
+LOG_DEBUG
+, "%s: ipv6cpej opts:",
+
+3515 
+i
+->
+if_xme
+);
+
+3517 
+p
+ = (*)(
+h
+ + 1);
+
+3518 ; 
+n
+ > 1 && 
+p
+[1];en -=[1], +=[1]) {
+
+3519 i(
+p
+[1] > 
+n
+) {
+
+3521 
+	`addlog
+("%s:eceived malicious IPCPv6 option, "
+
+3522 "drpg\n", 
+i
+->
+if_xme
+);
+
+3523 
+dr
+;
+
+3525 i(
+debug
+)
+
+3526 
+	`addlog
+(" %s", 
+	`_v6_t_me
+(*
+p
+));
+
+3527 *
+p
+) {
+
+3528 
+IPV6CP_OPT_IFID
+:
+
+3533 
+
+->
+v6
+.
+ts
+ &~(1 << 
+IPV6CP_OPT_IFID
+);
+
+3535 #ifde
+ny
+
+
+3536 
+IPV6CP_OPT_COMPRESS
+:
+
+3537 
+
+->
+v6
+.
+ts
+ &~(1 << 
+IPV6CP_OPT_COMPRESS
+);
+
+3542 i(
+debug
+)
+
+3543 
+	`addlog
+("\n");
+
+3544 
+dr
+:
+
+3545 
+	`
+(
+buf
+, 
+M_TEMP
+);
+
+3547 
+	}
+}
+
+3554 
+	$_v6_RCN_k
+(
+
+ *
+
+, 
+l_hd
+ *
+h
+, 
+n
+)
+
+3556 
+u_ch
+ *
+buf
+, *
+p
+;
+
+3557 
+i
+ *
+i
+ = &
+
+->
+_if
+;
+
+3558 
+debug
+ = 
+i
+->
+if_ags
+ & 
+IFF_DEBUG
+;
+
+3559 
+6_addr
+ 
+suggeaddr
+;
+
+3561 
+n
+ -= 4;
+
+3562 
+buf
+ = 
+	`mloc
+ (
+n
+, 
+M_TEMP
+, 
+M_NOWAIT
+);
+
+3563 i(!
+buf
+)
+
+3566 i(
+debug
+)
+
+3567 
+	`log
+(
+LOG_DEBUG
+, "%s: ipv6cpak opts:",
+
+3568 
+i
+->
+if_xme
+);
+
+3570 
+p
+ = (*)(
+h
+ + 1);
+
+3571 ; 
+n
+ > 1 && 
+p
+[1];en -=[1], +=[1]) {
+
+3572 i(
+p
+[1] > 
+n
+) {
+
+3574 
+	`addlog
+("%s:eceived malicious IPCPv6 option, "
+
+3575 "drpg\n", 
+i
+->
+if_xme
+);
+
+3576 
+dr
+;
+
+3578 i(
+debug
+)
+
+3579 
+	`addlog
+(" %s", 
+	`_v6_t_me
+(*
+p
+));
+
+3580 *
+p
+) {
+
+3581 
+IPV6CP_OPT_IFID
+:
+
+3587 i(
+n
+ < 10 || 
+p
+[1] != 10)
+
+3589 
+	`memt
+(&
+suggeaddr
+, 0, (suggestaddr));
+
+3590 
+suggeaddr
+.
+s6_addr16
+[0] = 
+	`hts
+(0xfe80);
+
+3591 ()
+	`6_tsce
+(&
+suggeaddr
+, &
+
+->
+_if
+, 
+NULL
+);
+
+3592 
+	`memy
+(&
+suggeaddr
+.
+s6_addr
+[8], &
+p
+[2], 8);
+
+3594 
+
+->
+v6
+.
+ts
+ |(1 << 
+IPV6CP_OPT_IFID
+);
+
+3595 i(
+debug
+)
+
+3596 
+	`addlog
+(" [suggestaddr %s]",
+
+3597 
+	`6_rtf
+(&
+suggeaddr
+));
+
+3598 #ifde
+IPV6CP_MYIFID_DYN
+
+
+3603 i(
+
+->
+v6
+.
+ags
+ & 
+IPV6CP_MYIFID_DYN
+) {
+
+3604 
+6_addr
+ 
+sugge
+;
+
+3611 
+	`_sugge_6_addr
+(&
+sugge
+);
+
+3612 i(
+	`IN6_ARE_ADDR_EQUAL
+(&
+suggeaddr
+,
+
+3613 
+sugge
+)) {
+
+3614 i(
+debug
+)
+
+3615 
+	`addlog
+(" [random]");
+
+3616 
+	`_g_6_addr
+(
+
+, &
+suggeaddr
+);
+
+3618 
+	`_t_6_addr
+(
+
+, &
+suggeaddr
+, 0);
+
+3619 i(
+debug
+)
+
+3620 
+	`addlog
+(" [agree]");
+
+3621 
+
+->
+v6
+.
+ags
+ |
+IPV6CP_MYIFID_SEEN
+;
+
+3637 #ifde
+ny
+
+
+3638 
+IPV6CP_OPT_COMPRESS
+:
+
+3646 i(
+debug
+)
+
+3647 
+	`addlog
+("\n");
+
+3648 
+dr
+:
+
+3649 
+	`
+(
+buf
+, 
+M_TEMP
+);
+
+3651 
+	}
+}
+
+3654 
+	$_v6_u
+(
+
+ *
+
+)
+
+3657 i(
+
+->
+_c
+)
+
+3658 
+
+->
+	`_c
+(sp);
+
+3659 
+	}
+}
+
+3662 
+	$_v6_d
+(
+
+ *
+
+)
+
+3664 
+	}
+}
+
+3667 
+	$_v6_s
+(
+
+ *
+
+)
+
+3670 
+
+->
+l
+.
+os
+ |(1 << 
+IDX_IPV6CP
+);
+
+3671 
+	}
+}
+
+3674 
+	$_v6_f
+(
+
+ *
+
+)
+
+3677 
+
+->
+l
+.
+os
+ &~(1 << 
+IDX_IPV6CP
+);
+
+3678 
+	}
+}
+
+3681 
+	$_v6_s
+(
+
+ *
+
+)
+
+3683 
+t
+[10 + 4 ];
+
+3684 
+6_addr
+ 
+ouddr
+;
+
+3685 
+i
+ = 0;
+
+3687 i(
+
+->
+v6
+.
+ts
+ & (1 << 
+IPV6CP_OPT_IFID
+)) {
+
+3688 
+	`_g_6_addrs
+(
+
+, &
+ouddr
+, 0, 0);
+
+3689 
+t
+[
+i
+++] = 
+IPV6CP_OPT_IFID
+;
+
+3690 
+t
+[
+i
+++] = 10;
+
+3691 
+	`memy
+(&
+t
+[
+i
+], &
+ouddr
+.
+s6_addr
+[8], 8);
+
+3692 
+i
+ += 8;
+
+3695 #ifde
+ny
+
+
+3696 i(
+
+->
+v6
+.
+ts
+ & (1 << 
+IPV6CP_OPT_COMPRESSION
+)) {
+
+3697 
+t
+[
+i
+++] = 
+IPV6CP_OPT_COMPRESSION
+;
+
+3698 
+t
+[
+i
+++] = 4;
+
+3699 
+t
+[
+i
+++] = 0;
+
+3700 
+t
+[
+i
+++] = 0;
+
+3705 
+
+->
+cfid
+[
+IDX_IPV6CP
+] = ++->
+_q
+[IDX_IPV6CP];
+
+3706 
+	`__nd
+(
+
+, 
+PPP_IPV6CP
+, 
+CONF_REQ
+, sp->
+cfid
+[
+IDX_IPV6CP
+], 
+i
+, &
+t
+);
+
+3707 
+	}
+}
+
+3710 
+	$_v6_
+(
+
+ *
+
+)
+
+3712 
+	}
+}
+
+3715 
+	$_v6_up
+(
+
+ *
+
+)
+
+3717 
+	}
+}
+
+3720 
+	$_v6_down
+(
+
+ *
+
+)
+
+3722 
+	}
+}
+
+3725 
+	$_v6_
+(
+
+ *
+
+)
+
+3727 
+	}
+}
+
+3730 
+	$_v6_o
+(
+
+ *
+
+)
+
+3732 
+	}
+}
+
+3735 
+	$_v6_TO
+(*
+
+)
+
+3737 
+	}
+}
+
+3740 
+	$_v6_RCR
+(
+
+ *
+
+, 
+l_hd
+ *
+h
+,
+
+3741 
+n
+)
+
+3744 
+	}
+}
+
+3747 
+	$_v6_RCN_j
+(
+
+ *
+
+, 
+l_hd
+ *
+h
+,
+
+3748 
+n
+)
+
+3750 
+	}
+}
+
+3753 
+	$_v6_RCN_k
+(
+
+ *
+
+, 
+l_hd
+ *
+h
+,
+
+3754 
+n
+)
+
+3756 
+	}
+}
+
+3759 
+	$_v6_u
+(
+
+ *
+
+)
+
+3761 
+	}
+}
+
+3764 
+	$_v6_d
+(
+
+ *
+
+)
+
+3766 
+	}
+}
+
+3769 
+	$_v6_s
+(
+
+ *
+
+)
+
+3771 
+	}
+}
+
+3774 
+	$_v6_f
+(
+
+ *
+
+)
+
+3776 
+	}
+}
+
+3779 
+	$_v6_s
+(
+
+ *
+
+)
+
+3781 
+	}
+}
+
+3874 
+	$_ch_put
+(
+
+ *
+
+, 
+mbuf
+ *
+m
+)
+
+3876 
+STDDCL
+;
+
+3877 
+l_hd
+ *
+h
+;
+
+3878 
+n
+, 
+x
+;
+
+3879 
+u_ch
+ *
+vue
+, *
+me
+, 
+dige
+[(
+
+->
+myauth
+.
+chnge
+)], 
+dsize
+;
+
+3880 
+vue_n
+, 
+me_n
+;
+
+3881 
+MD5_CTX
+ 
+x
+;
+
+3883 
+n
+ = 
+m
+->
+m_pkthdr
+.len;
+
+3884 i(
+n
+ < 4) {
+
+3885 i(
+debug
+)
+
+3886 
+	`log
+(
+LOG_DEBUG
+,
+
+3888 
+i
+->
+if_xme
+, 
+n
+);
+
+3891 
+h
+ = 
+	`mtod
+(
+m
+, 
+l_hd
+ *);
+
+3892 i(
+n
+ > 
+	`ohs
+(
+h
+->len))
+
+3893 
+n
+ = 
+	`ohs
+(
+h
+->len);
+
+3895 
+h
+->
+ty
+) {
+
+3897 
+CHAP_CHALLENGE
+:
+
+3898 i(
+
+->
+myauth
+.
+
+ =
+NULL
+ || sp->myauth.
+me
+ == NULL) {
+
+3900 
+
+->
+_auth_us
+++;
+
+3901 
+	`tf
+("%s: chap input without myamend my secret being set\n",
+
+3902 
+i
+->
+if_xme
+);
+
+3905 
+vue
+ = 1 + (
+u_ch
+ *)(
+h
+ + 1);
+
+3906 
+vue_n
+ = 
+vue
+[-1];
+
+3907 
+me
+ = 
+vue
+ + 
+vue_n
+;
+
+3908 
+me_n
+ = 
+n
+ - 
+vue_n
+ - 5;
+
+3909 i(
+me_n
+ < 0) {
+
+3910 i(
+debug
+) {
+
+3911 
+	`log
+(
+LOG_DEBUG
+,
+
+3914 
+i
+->
+if_xme
+,
+
+3915 
+	`_auth_ty_me
+(
+PPP_CHAP
+, 
+h
+->
+ty
+),
+
+3916 
+h
+->
+idt
+, 
+	`ohs
+(h->
+n
+));
+
+3917 i(
+n
+ > 4)
+
+3918 
+	`_t_bys
+((
+u_ch
+ *)(
+h
+ + 1),
+
+3919 
+n
+ - 4);
+
+3920 
+	`addlog
+(">\n");
+
+3925 i(
+debug
+) {
+
+3926 
+	`log
+(
+LOG_DEBUG
+,
+
+3928 
+i
+->
+if_xme
+,
+
+3929 
+	`_auth_ty_me
+(
+PPP_CHAP
+, 
+h
+->
+ty
+), h->
+idt
+,
+
+3930 
+	`ohs
+(
+h
+->
+n
+));
+
+3931 
+	`_t_rg
+((*
+me
+, 
+me_n
+);
+
+3932 
+	`addlog
+(" vue-size=%d vue=", 
+vue_n
+);
+
+3933 
+	`_t_bys
+(
+vue
+, 
+vue_n
+);
+
+3934 
+	`addlog
+(">\n");
+
+3938 
+	`MD5In
+(&
+x
+);
+
+3939 
+	`MD5Upde
+(&
+x
+, &
+h
+->
+idt
+, 1);
+
+3940 
+	`MD5Upde
+(&
+x
+, 
+
+->
+myauth
+.
+
+, sp->myauth.
+_n
+);
+
+3941 
+	`MD5Upde
+(&
+x
+, 
+vue
+, 
+vue_n
+);
+
+3942 
+	`MD5F
+(
+dige
+, &
+x
+);
+
+3943 
+dsize
+ =  
+dige
+;
+
+3945 
+	`_auth_nd
+(&
+ch
+, 
+
+, 
+CHAP_RESPONSE
+, 
+h
+->
+idt
+,
+
+3946  
+dsize
+, (const *)&dsize,
+
+3947  
+dige
+, digest,
+
+3948 
+
+->
+myauth
+.
+me_n
+,
+
+3949 
+
+->
+myauth
+.
+me
+,
+
+3953 
+CHAP_SUCCESS
+:
+
+3954 i(
+debug
+) {
+
+3955 
+	`log
+(
+LOG_DEBUG
+, "%s: chap success",
+
+3956 
+i
+->
+if_xme
+);
+
+3957 i(
+n
+ > 4) {
+
+3958 
+	`addlog
+(": ");
+
+3959 
+	`_t_rg
+((*)(
+h
+ + 1), 
+n
+ - 4);
+
+3961 
+	`addlog
+("\n");
+
+3963 
+x
+ = 
+	`
+();
+
+3964 
+
+->
+_auth_us
+ = 0;
+
+3965 
+
+->
+_ags
+ &~
+PP_NEEDAUTH
+;
+
+3966 i(
+
+->
+myauth
+.
+o
+ =
+PPP_CHAP
+ &&
+
+3967 (
+
+->
+l
+.
+ts
+ & (1 << 
+LCP_OPT_AUTH_PROTO
+)) &&
+
+3968 (
+
+->
+l
+.
+os
+ & (1 << 
+IDX_CHAP
+)) == 0) {
+
+3974 
+	`lx
+(
+x
+);
+
+3977 
+	`lx
+(
+x
+);
+
+3978 
+	`_pha_twk
+(
+
+);
+
+3981 
+CHAP_FAILURE
+:
+
+3982 
+x
+ = 
+	`
+();
+
+3983 
+
+->
+_auth_us
+++;
+
+3984 
+	`lx
+(
+x
+);
+
+3985 i(
+debug
+) {
+
+3986 
+	`log
+(
+LOG_INFO
+, "%s: chap failure",
+
+3987 
+i
+->
+if_xme
+);
+
+3988 i(
+n
+ > 4) {
+
+3989 
+	`addlog
+(": ");
+
+3990 
+	`_t_rg
+((*)(
+h
+ + 1), 
+n
+ - 4);
+
+3992 
+	`addlog
+("\n");
+
+3994 
+	`log
+(
+LOG_INFO
+, "%s: chap failure\n",
+
+3995 
+i
+->
+if_xme
+);
+
+4000 
+CHAP_RESPONSE
+:
+
+4001 i(
+
+->
+hiuth
+.
+
+ =
+NULL
+) {
+
+4003 
+	`tf
+("%s: chap input without his secret being set\n",
+
+4004 
+i
+->
+if_xme
+);
+
+4007 
+vue
+ = 1 + (
+u_ch
+ *)(
+h
+ + 1);
+
+4008 
+vue_n
+ = 
+vue
+[-1];
+
+4009 
+me
+ = 
+vue
+ + 
+vue_n
+;
+
+4010 
+me_n
+ = 
+n
+ - 
+vue_n
+ - 5;
+
+4011 i(
+me_n
+ < 0) {
+
+4012 i(
+debug
+) {
+
+4013 
+	`log
+(
+LOG_DEBUG
+,
+
+4016 
+i
+->
+if_xme
+,
+
+4017 
+	`_auth_ty_me
+(
+PPP_CHAP
+, 
+h
+->
+ty
+),
+
+4018 
+h
+->
+idt
+, 
+	`ohs
+(h->
+n
+));
+
+4019 i(
+n
+ > 4)
+
+4020 
+	`_t_bys
+((
+u_ch
+ *)(
+h
+ + 1),
+
+4021 
+n
+ - 4);
+
+4022 
+	`addlog
+(">\n");
+
+4026 i(
+h
+->
+idt
+ !
+
+->
+cfid
+[
+IDX_CHAP
+]) {
+
+4027 i(
+debug
+)
+
+4028 
+	`log
+(
+LOG_DEBUG
+,
+
+4031 
+i
+->
+if_xme
+,
+
+4032 
+h
+->
+idt
+, 
+
+->
+cfid
+[
+IDX_CHAP
+]);
+
+4035 i(
+
+->
+hiuth
+.
+me
+ !
+NULL
+ &&
+
+4036 (
+me_n
+ !
+
+->
+hiuth
+.name_len
+
+4037 || 
+	`memcmp
+(
+me
+, 
+
+->
+hiuth
+.me, 
+me_n
+) != 0)) {
+
+4038 
+	`log
+(
+LOG_INFO
+, "%s: chapesponse, hisame ",
+
+4039 
+i
+->
+if_xme
+);
+
+4040 
+	`_t_rg
+(
+me
+, 
+me_n
+);
+
+4041 
+	`addlog
+(" !=xpected ");
+
+4042 
+	`_t_rg
+(
+
+->
+hiuth
+.
+me
+,
+
+4043 
+
+->
+hiuth
+.
+me_n
+);
+
+4044 
+	`addlog
+("\n");
+
+4045 
+ch_u
+;
+
+4047 i(
+debug
+) {
+
+4048 
+	`log
+(
+LOG_DEBUG
+, "%s: chap input(%s) "
+
+4050 
+i
+->
+if_xme
+,
+
+4051 
+	`_e_me
+(
+
+->
+e
+[
+IDX_CHAP
+]),
+
+4052 
+	`_auth_ty_me
+(
+PPP_CHAP
+, 
+h
+->
+ty
+),
+
+4053 
+h
+->
+idt
+, 
+	`ohs
+(h->
+n
+));
+
+4054 
+	`_t_rg
+((*)
+me
+, 
+me_n
+);
+
+4055 
+	`addlog
+(" vue-size=%d vue=", 
+vue_n
+);
+
+4056 
+	`_t_bys
+(
+vue
+, 
+vue_n
+);
+
+4057 
+	`addlog
+(">\n");
+
+4059 i(
+vue_n
+ !(
+
+->
+myauth
+.
+chnge
+)) {
+
+4060 i(
+debug
+)
+
+4061 
+	`log
+(
+LOG_DEBUG
+,
+
+4064 
+i
+->
+if_xme
+, 
+vue_n
+,
+
+4065 ((
+
+->
+myauth
+.
+chnge
+));
+
+4066 
+ch_u
+;
+
+4069 
+	`MD5In
+(&
+x
+);
+
+4070 
+	`MD5Upde
+(&
+x
+, &
+h
+->
+idt
+, 1);
+
+4071 
+	`MD5Upde
+(&
+x
+, 
+
+->
+hiuth
+.
+
+, sp->hiuth.
+_n
+);
+
+4072 
+	`MD5Upde
+(&
+x
+, 
+
+->
+myauth
+.
+chnge
+, (sp->myauth.challenge));
+
+4073 
+	`MD5F
+(
+dige
+, &
+x
+);
+
+4075 
+	#FAILMSG
+ "Faed..."
+
+	)
+
+4076 
+	#SUCCMSG
+ "Wcome!"
+
+	)
+
+4078 i(
+vue_n
+ ! 
+dige
+ ||
+
+4079 
+	`memcmp
+(
+dige
+, 
+vue
+, 
+vue_n
+) != 0) {
+
+4080 
+ch_u
+:
+
+4082 
+x
+ = 
+	`
+();
+
+4083 
+
+->
+_auth_us
+++;
+
+4084 
+	`lx
+(
+x
+);
+
+4085 
+	`_auth_nd
+(&
+ch
+, 
+
+, 
+CHAP_FAILURE
+, 
+h
+->
+idt
+,
+
+4086 (
+FAILMSG
+- 1, (c 
+u_ch
+ *)FAILMSG,
+
+4088 
+ch
+.
+	`d
+(
+
+);
+
+4091 
+
+->
+_auth_us
+ = 0;
+
+4093 i(
+
+->
+e
+[
+IDX_CHAP
+] =
+STATE_REQ_SENT
+ ||
+
+4094 
+
+->
+e
+[
+IDX_CHAP
+] =
+STATE_OPENED
+)
+
+4095 
+	`_auth_nd
+(&
+ch
+, 
+
+, 
+CHAP_SUCCESS
+, 
+h
+->
+idt
+,
+
+4096 (
+SUCCMSG
+- 1, (c 
+u_ch
+ *)SUCCMSG,
+
+4098 i(
+
+->
+e
+[
+IDX_CHAP
+] =
+STATE_REQ_SENT
+) {
+
+4099 
+	`__chge_e
+(&
+ch
+, 
+
+, 
+STATE_OPENED
+);
+
+4100 
+ch
+.
+	`u
+(
+
+);
+
+4106 i(
+debug
+) {
+
+4107 
+	`log
+(
+LOG_DEBUG
+, "%s: chap unknown input(%s) "
+
+4109 
+i
+->
+if_xme
+,
+
+4110 
+	`_e_me
+(
+
+->
+e
+[
+IDX_CHAP
+]),
+
+4111 
+h
+->
+ty
+, h->
+idt
+, 
+	`ohs
+(h->
+n
+));
+
+4112 i(
+n
+ > 4)
+
+4113 
+	`_t_bys
+((
+u_ch
+ *)(
+h
+ + 1), 
+n
+ - 4);
+
+4114 
+	`addlog
+(">\n");
+
+4119 
+	}
+}
+
+4122 
+	$_ch_
+(
+
+ *
+
+)
+
+4125 
+
+->
+e
+[
+IDX_CHAP
+] = 
+STATE_CLOSED
+;
+
+4126 
+
+->
+_cou
+[
+IDX_CHAP
+] = 0;
+
+4127 
+
+->
+_q
+[
+IDX_CHAP
+] = 0;
+
+4128 
+
+->
+_rq
+[
+IDX_CHAP
+] = 0;
+
+4129 
+	`out_
+(&
+
+->
+ch
+[
+IDX_CHAP
+], 0);
+
+4130 
+	}
+}
+
+4133 
+	$_ch_
+(
+
+ *
+
+)
+
+4135 i(
+
+->
+myauth
+.
+o
+ =
+PPP_CHAP
+ &&
+
+4136 (
+
+->
+l
+.
+ts
+ & (1 << 
+LCP_OPT_AUTH_PROTO
+)) != 0) {
+
+4138 
+ch
+.
+	`s
+(
+
+);
+
+4139 
+
+->
+r_cou
+[
+IDX_CHAP
+] = sp->
+l
+.
+max_cfigu
+;
+
+4140 
+	`__chge_e
+(&
+ch
+, 
+
+, 
+STATE_REQ_SENT
+);
+
+4143 
+	}
+}
+
+4146 
+	$_ch_o
+(
+
+ *
+
+)
+
+4148 i(
+
+->
+e
+[
+IDX_CHAP
+] !
+STATE_CLOSED
+)
+
+4149 
+	`__chge_e
+(&
+ch
+, 
+
+, 
+STATE_CLOSED
+);
+
+4150 
+	}
+}
+
+4153 
+	$_ch_TO
+(*
+cook
+)
+
+4155 
+
+ *
+
+ = ( *)
+cook
+;
+
+4156 
+STDDCL
+;
+
+4157 
+s
+;
+
+4159 
+s
+ = 
+	`
+();
+
+4160 i(
+debug
+)
+
+4161 
+	`log
+(
+LOG_DEBUG
+, "%s: chap TO(%s)st_counter = %d\n",
+
+4162 
+i
+->
+if_xme
+,
+
+4163 
+	`_e_me
+(
+
+->
+e
+[
+IDX_CHAP
+]),
+
+4164 
+
+->
+r_cou
+[
+IDX_CHAP
+]);
+
+4166 i(--
+
+->
+r_cou
+[
+IDX_CHAP
+] < 0)
+
+4168 
+
+->
+e
+[
+IDX_CHAP
+]) {
+
+4169 
+STATE_REQ_SENT
+:
+
+4170 
+ch
+.
+	`d
+(
+
+);
+
+4171 
+	`__chge_e
+(&
+ch
+, 
+
+, 
+STATE_CLOSED
+);
+
+4176 
+
+->
+e
+[
+IDX_CHAP
+]) {
+
+4177 
+STATE_OPENED
+:
+
+4179 
+
+->
+r_cou
+[
+IDX_CHAP
+] = sp->
+l
+.
+max_cfigu
+;
+
+4181 
+STATE_REQ_SENT
+:
+
+4182 
+ch
+.
+	`s
+(
+
+);
+
+4184 
+	`__chge_e
+(&
+ch
+, 
+
+, 
+STATE_REQ_SENT
+);
+
+4188 
+	`lx
+(
+s
+);
+
+4189 
+	}
+}
+
+4192 
+	$_ch_u
+(
+
+ *
+
+)
+
+4194 
+STDDCL
+;
+
+4195 
+i
+, 
+x
+;
+
+4197 
+i
+ = 0;
+
+4198 
+
+->
+r_cou
+[
+IDX_CHAP
+] = sp->
+l
+.
+max_cfigu
+;
+
+4206 i((
+
+->
+hiuth
+.
+ags
+ & 
+SPPP_AUTHFLAG_NORECHALLENGE
+) == 0) {
+
+4211 
+i
+ = 300 + (()(
+	`g_32
+() & 0xff00) >> 7);
+
+4213 
+	`out_t
+(&
+
+->
+ch
+[
+IDX_CHAP
+], 
+i
+ * 
+hz
+, 
+ch
+.
+TO
+, sp);
+
+4216 i(
+debug
+) {
+
+4217 
+	`log
+(
+LOG_DEBUG
+,
+
+4219 
+i
+->
+if_xme
+,
+
+4220 
+
+->
+_pha
+ =
+SPPP_PHASE_NETWORK
+? "reconfirmed": "tlu");
+
+4221 i((
+
+->
+hiuth
+.
+ags
+ & 
+SPPP_AUTHFLAG_NORECHALLENGE
+) == 0)
+
+4222 
+	`addlog
+("x-chng %d secds\n", 
+i
+);
+
+4224 
+	`addlog
+("re-challenging supressed\n");
+
+4227 
+x
+ = 
+	`
+();
+
+4228 
+
+->
+_auth_us
+ = 0;
+
+4230 
+
+->
+l
+.
+os
+ |(1 << 
+IDX_CHAP
+);
+
+4232 i(
+
+->
+_ags
+ & 
+PP_NEEDAUTH
+) {
+
+4238 
+	`lx
+(
+x
+);
+
+4241 
+	`lx
+(
+x
+);
+
+4247 i(
+
+->
+_pha
+ !
+SPPP_PHASE_NETWORK
+)
+
+4248 
+	`_pha_twk
+(
+
+);
+
+4249 
+	}
+}
+
+4252 
+	$_ch_d
+(
+
+ *
+
+)
+
+4254 
+STDDCL
+;
+
+4256 i(
+debug
+)
+
+4257 
+	`log
+(
+LOG_DEBUG
+, "%s: chld\n", 
+i
+->
+if_xme
+);
+
+4258 
+	`out_
+(&
+
+->
+ch
+[
+IDX_CHAP
+]);
+
+4259 
+
+->
+l
+.
+os
+ &~(1 << 
+IDX_CHAP
+);
+
+4261 
+l
+.
+	`Clo
+(
+
+);
+
+4262 
+	}
+}
+
+4265 
+	$_ch_s
+(
+
+ *
+
+)
+
+4267 
+ut32_t
+ *
+ch
+;
+
+4268 
+u_ch
+ 
+
+ = 4 * (
+ut32_t
+);
+
+4270 i(
+
+->
+myauth
+.
+me
+ =
+NULL
+) {
+
+4272 
+	`tf
+("%s: chap starting without myame being set\n",
+
+4273 
+
+->
+_if
+.
+if_xme
+);
+
+4278 
+ch
+ = (
+ut32_t
+ *)
+
+->
+myauth
+.
+chnge
+;
+
+4279 
+	`g_rg
+(
+kn_g
+, 
+ch
+, 
+
+, 0);
+
+4281 
+
+->
+cfid
+[
+IDX_CHAP
+] = ++->
+_q
+[IDX_CHAP];
+
+4283 
+	`_auth_nd
+(&
+ch
+, 
+
+, 
+CHAP_CHALLENGE
+, sp->
+cfid
+[
+IDX_CHAP
+],
+
+4284  
+
+, (const *)&clen,
+
+4285 (
+
+->
+myauth
+.
+chnge
+), sp->myauth.challenge,
+
+4286 
+
+->
+myauth
+.
+me_n
+,
+
+4287 
+
+->
+myauth
+.
+me
+,
+
+4289 
+	}
+}
+
+4308 
+	$_p_put
+(
+
+ *
+
+, 
+mbuf
+ *
+m
+)
+
+4310 
+STDDCL
+;
+
+4311 
+l_hd
+ *
+h
+;
+
+4312 
+n
+, 
+x
+;
+
+4313 
+u_ch
+ 
+mn
+;
+
+4314 *
+me
+, *
+
+;
+
+4315 
+me_n
+, 
+_n
+;
+
+4321 
+_n
+ = -1;
+
+4323 
+n
+ = 
+m
+->
+m_pkthdr
+.len;
+
+4324 i(
+n
+ < 5) {
+
+4325 i(
+debug
+)
+
+4326 
+	`log
+(
+LOG_DEBUG
+,
+
+4328 
+i
+->
+if_xme
+, 
+n
+);
+
+4331 
+h
+ = 
+	`mtod
+(
+m
+, 
+l_hd
+ *);
+
+4332 i(
+n
+ > 
+	`ohs
+(
+h
+->len))
+
+4333 
+n
+ = 
+	`ohs
+(
+h
+->len);
+
+4334 
+h
+->
+ty
+) {
+
+4336 
+PAP_REQ
+:
+
+4337 i(
+
+->
+hiuth
+.
+me
+ =
+NULL
+ || sp->hiuth.
+
+ == NULL) {
+
+4339 
+	`tf
+("%s:apequest without hisamend his secret being set\n",
+
+4340 
+i
+->
+if_xme
+);
+
+4343 
+me
+ = 1 + (
+u_ch
+ *)(
+h
+ + 1);
+
+4344 
+me_n
+ = 
+me
+[-1];
+
+4345 
+
+ = 
+me
+ + 
+me_n
+ + 1;
+
+4346 i(
+me_n
+ > 
+n
+ - 6 ||
+
+4347 (
+_n
+ = 
+
+[-1]> 
+n
+ - 6 - 
+me_n
+) {
+
+4348 i(
+debug
+) {
+
+4349 
+	`log
+(
+LOG_DEBUG
+, "%s:ap corrupted input "
+
+4351 
+i
+->
+if_xme
+,
+
+4352 
+	`_auth_ty_me
+(
+PPP_PAP
+, 
+h
+->
+ty
+),
+
+4353 
+h
+->
+idt
+, 
+	`ohs
+(h->
+n
+));
+
+4354 i(
+n
+ > 4)
+
+4355 
+	`_t_bys
+((
+u_ch
+ *)(
+h
+ + 1),
+
+4356 
+n
+ - 4);
+
+4357 
+	`addlog
+(">\n");
+
+4361 i(
+debug
+) {
+
+4362 
+	`log
+(
+LOG_DEBUG
+, "%s:ap input(%s) "
+
+4364 
+i
+->
+if_xme
+,
+
+4365 
+	`_e_me
+(
+
+->
+e
+[
+IDX_PAP
+]),
+
+4366 
+	`_auth_ty_me
+(
+PPP_PAP
+, 
+h
+->
+ty
+),
+
+4367 
+h
+->
+idt
+, 
+	`ohs
+(h->
+n
+));
+
+4368 
+	`_t_rg
+((*)
+me
+, 
+me_n
+);
+
+4369 
+	`addlog
+(" secret=");
+
+4370 
+	`_t_rg
+((*)
+
+, 
+_n
+);
+
+4371 
+	`addlog
+(">\n");
+
+4373 i(
+me_n
+ !
+
+->
+hiuth
+.name_len ||
+
+4374 
+_n
+ !
+
+->
+hiuth
+.secret_len ||
+
+4375 
+	`memcmp
+(
+me
+, 
+
+->
+hiuth
+.me, 
+me_n
+) != 0 ||
+
+4376 
+	`memcmp
+(
+
+, 
+
+->
+hiuth
+., 
+_n
+) != 0) {
+
+4378 
+
+->
+_auth_us
+++;
+
+4379 
+mn
+ = (
+FAILMSG
+) - 1;
+
+4380 
+	`_auth_nd
+(&
+p
+, 
+
+, 
+PAP_NAK
+, 
+h
+->
+idt
+,
+
+4381  
+mn
+, (const *)&mlen,
+
+4382 (
+FAILMSG
+- 1, (c 
+u_ch
+ *)FAILMSG,
+
+4384 
+p
+.
+	`d
+(
+
+);
+
+4388 i(
+
+->
+e
+[
+IDX_PAP
+] =
+STATE_REQ_SENT
+ ||
+
+4389 
+
+->
+e
+[
+IDX_PAP
+] =
+STATE_OPENED
+) {
+
+4390 
+mn
+ = (
+SUCCMSG
+) - 1;
+
+4391 
+	`_auth_nd
+(&
+p
+, 
+
+, 
+PAP_ACK
+, 
+h
+->
+idt
+,
+
+4392  
+mn
+, (const *)&mlen,
+
+4393 (
+SUCCMSG
+- 1, (c 
+u_ch
+ *)SUCCMSG,
+
+4396 i(
+
+->
+e
+[
+IDX_PAP
+] =
+STATE_REQ_SENT
+) {
+
+4397 
+	`__chge_e
+(&
+p
+, 
+
+, 
+STATE_OPENED
+);
+
+4398 
+p
+.
+	`u
+(
+
+);
+
+4403 
+PAP_ACK
+:
+
+4404 
+	`out_
+(&
+
+->
+p_my_to_ch
+);
+
+4405 i(
+debug
+) {
+
+4406 
+	`log
+(
+LOG_DEBUG
+, "%s:ap success",
+
+4407 
+i
+->
+if_xme
+);
+
+4408 
+me
+ = 1 + (
+u_ch
+ *)(
+h
+ + 1);
+
+4409 
+me_n
+ = 
+me
+[-1];
+
+4410 i(
+n
+ > 5 && 
+me_n
+ <en+4) {
+
+4411 
+	`addlog
+(": ");
+
+4412 
+	`_t_rg
+(
+me
+, 
+me_n
+);
+
+4414 
+	`addlog
+("\n");
+
+4416 
+x
+ = 
+	`
+();
+
+4417 
+
+->
+_auth_us
+ = 0;
+
+4418 
+
+->
+_ags
+ &~
+PP_NEEDAUTH
+;
+
+4419 i(
+
+->
+myauth
+.
+o
+ =
+PPP_PAP
+ &&
+
+4420 (
+
+->
+l
+.
+ts
+ & (1 << 
+LCP_OPT_AUTH_PROTO
+)) &&
+
+4421 (
+
+->
+l
+.
+os
+ & (1 << 
+IDX_PAP
+)) == 0) {
+
+4427 
+	`lx
+(
+x
+);
+
+4430 
+	`lx
+(
+x
+);
+
+4431 
+	`_pha_twk
+(
+
+);
+
+4434 
+PAP_NAK
+:
+
+4435 
+	`out_
+(&
+
+->
+p_my_to_ch
+);
+
+4436 
+
+->
+_auth_us
+++;
+
+4437 i(
+debug
+) {
+
+4438 
+	`log
+(
+LOG_INFO
+, "%s:ap failure",
+
+4439 
+i
+->
+if_xme
+);
+
+4440 
+me
+ = 1 + (
+u_ch
+ *)(
+h
+ + 1);
+
+4441 
+me_n
+ = 
+me
+[-1];
+
+4442 i(
+n
+ > 5 && 
+me_n
+ <en+4) {
+
+4443 
+	`addlog
+(": ");
+
+4444 
+	`_t_rg
+(
+me
+, 
+me_n
+);
+
+4446 
+	`addlog
+("\n");
+
+4448 
+	`log
+(
+LOG_INFO
+, "%s:ap failure\n",
+
+4449 
+i
+->
+if_xme
+);
+
+4455 i(
+debug
+) {
+
+4456 
+	`log
+(
+LOG_DEBUG
+, "%s:ap corrupted input "
+
+4458 
+i
+->
+if_xme
+,
+
+4459 
+h
+->
+ty
+, h->
+idt
+, 
+	`ohs
+(h->
+n
+));
+
+4460 i(
+n
+ > 4)
+
+4461 
+	`_t_bys
+((
+u_ch
+ *)(
+h
+ + 1), 
+n
+ - 4);
+
+4462 
+	`addlog
+(">\n");
+
+4467 
+	}
+}
+
+4470 
+	$_p_
+(
+
+ *
+
+)
+
+4473 
+
+->
+e
+[
+IDX_PAP
+] = 
+STATE_CLOSED
+;
+
+4474 
+
+->
+_cou
+[
+IDX_PAP
+] = 0;
+
+4475 
+
+->
+_q
+[
+IDX_PAP
+] = 0;
+
+4476 
+
+->
+_rq
+[
+IDX_PAP
+] = 0;
+
+4477 
+	`out_
+(&
+
+->
+ch
+[
+IDX_PAP
+], 0);
+
+4478 
+	`out_
+(&
+
+->
+p_my_to_ch
+, 0);
+
+4479 
+	}
+}
+
+4482 
+	$_p_
+(
+
+ *
+
+)
+
+4484 i(
+
+->
+hiuth
+.
+o
+ =
+PPP_PAP
+ &&
+
+4485 (
+
+->
+l
+.
+ts
+ & (1 << 
+LCP_OPT_AUTH_PROTO
+)) != 0) {
+
+4487 
+
+->
+r_cou
+[
+IDX_PAP
+] = sp->
+l
+.
+max_cfigu
+;
+
+4488 
+	`__chge_e
+(&
+p
+, 
+
+, 
+STATE_REQ_SENT
+);
+
+4490 i(
+
+->
+myauth
+.
+o
+ =
+PPP_PAP
+) {
+
+4492 
+p
+.
+	`s
+(
+
+);
+
+4493 
+	`out_t
+(&
+
+->
+p_my_to_ch
+, sp->
+l
+.
+timeout
+,
+
+4494 
+_p_my_TO
+, 
+
+);
+
+4496 
+	}
+}
+
+4499 
+	$_p_o
+(
+
+ *
+
+)
+
+4501 i(
+
+->
+e
+[
+IDX_PAP
+] !
+STATE_CLOSED
+)
+
+4502 
+	`__chge_e
+(&
+p
+, 
+
+, 
+STATE_CLOSED
+);
+
+4503 
+	}
+}
+
+4510 
+	$_p_TO
+(*
+cook
+)
+
+4512 
+
+ *
+
+ = ( *)
+cook
+;
+
+4513 
+STDDCL
+;
+
+4514 
+s
+;
+
+4516 
+s
+ = 
+	`
+();
+
+4517 i(
+debug
+)
+
+4518 
+	`log
+(
+LOG_DEBUG
+, "%s:ap TO(%s)st_counter = %d\n",
+
+4519 
+i
+->
+if_xme
+,
+
+4520 
+	`_e_me
+(
+
+->
+e
+[
+IDX_PAP
+]),
+
+4521 
+
+->
+r_cou
+[
+IDX_PAP
+]);
+
+4523 i(--
+
+->
+r_cou
+[
+IDX_PAP
+] < 0)
+
+4525 
+
+->
+e
+[
+IDX_PAP
+]) {
+
+4526 
+STATE_REQ_SENT
+:
+
+4527 
+p
+.
+	`d
+(
+
+);
+
+4528 
+	`__chge_e
+(&
+p
+, 
+
+, 
+STATE_CLOSED
+);
+
+4533 
+
+->
+e
+[
+IDX_PAP
+]) {
+
+4534 
+STATE_REQ_SENT
+:
+
+4536 
+	`__chge_e
+(&
+p
+, 
+
+, 
+STATE_REQ_SENT
+);
+
+4540 
+	`lx
+(
+s
+);
+
+4541 
+	}
+}
+
+4549 
+	$_p_my_TO
+(*
+cook
+)
+
+4551 
+
+ *
+
+ = ( *)
+cook
+;
+
+4552 
+STDDCL
+;
+
+4554 i(
+debug
+)
+
+4555 
+	`log
+(
+LOG_DEBUG
+, "%s:apeer TO\n",
+
+4556 
+i
+->
+if_xme
+);
+
+4558 
+p
+.
+	`s
+(
+
+);
+
+4559 
+	}
+}
+
+4562 
+	$_p_u
+(
+
+ *
+
+)
+
+4564 
+STDDCL
+;
+
+4565 
+x
+;
+
+4567 
+
+->
+r_cou
+[
+IDX_PAP
+] = sp->
+l
+.
+max_cfigu
+;
+
+4569 i(
+debug
+)
+
+4570 
+	`log
+(
+LOG_DEBUG
+, "%s: %slu\n",
+
+4571 
+i
+->
+if_xme
+, 
+p
+.
+me
+);
+
+4573 
+x
+ = 
+	`
+();
+
+4574 
+
+->
+_auth_us
+ = 0;
+
+4576 
+
+->
+l
+.
+os
+ |(1 << 
+IDX_PAP
+);
+
+4578 i(
+
+->
+_ags
+ & 
+PP_NEEDAUTH
+) {
+
+4584 
+	`lx
+(
+x
+);
+
+4587 
+	`lx
+(
+x
+);
+
+4588 
+	`_pha_twk
+(
+
+);
+
+4589 
+	}
+}
+
+4592 
+	$_p_d
+(
+
+ *
+
+)
+
+4594 
+STDDCL
+;
+
+4596 i(
+debug
+)
+
+4597 
+	`log
+(
+LOG_DEBUG
+, "%s:ld\n", 
+i
+->
+if_xme
+);
+
+4598 
+	`out_
+(&
+
+->
+ch
+[
+IDX_PAP
+]);
+
+4599 
+	`out_
+(&
+
+->
+p_my_to_ch
+);
+
+4600 
+
+->
+l
+.
+os
+ &~(1 << 
+IDX_PAP
+);
+
+4602 
+l
+.
+	`Clo
+(
+
+);
+
+4603 
+	}
+}
+
+4606 
+	$_p_s
+(
+
+ *
+
+)
+
+4608 
+u_ch
+ 
+idn
+, 
+pwdn
+;
+
+4610 i(
+
+->
+myauth
+.
+
+ =
+NULL
+ || sp->myauth.
+me
+ == NULL) {
+
+4612 
+	`tf
+("%s:ap starting without myamend secret being set\n",
+
+4613 
+
+->
+_if
+.
+if_xme
+);
+
+4617 
+
+->
+cfid
+[
+IDX_PAP
+] = ++->
+_q
+[IDX_PAP];
+
+4618 
+pwdn
+ = 
+
+->
+myauth
+.
+_n
+;
+
+4619 
+idn
+ = 
+
+->
+myauth
+.
+me_n
+;
+
+4621 
+	`_auth_nd
+(&
+p
+, 
+
+, 
+PAP_REQ
+, sp->
+cfid
+[
+IDX_PAP
+],
+
+4622  
+idn
+, (const *)&idlen,
+
+4623 
+idn
+, 
+
+->
+myauth
+.
+me
+,
+
+4624  
+pwdn
+, (const *)&pwdlen,
+
+4625 
+pwdn
+, 
+
+->
+myauth
+.
+
+,
+
+4627 
+	}
+}
+
+4645 
+	$_auth_nd
+(c 
+
+ *, 
+
+ *
+
+,
+
+4646 
+ty
+, 
+id
+,
+
+4649 
+STDDCL
+;
+
+4650 
+l_hd
+ *
+lh
+;
+
+4651 
+mbuf
+ *
+m
+;
+
+4652 
+u_ch
+ *
+p
+;
+
+4653 
+n
+;
+
+4654 
+size_t
+ 
+pkthd
+;
+
+4655 
+mn
+;
+
+4656 c *
+msg
+;
+
+4657 
+va_li
+ 
+
+;
+
+4659 
+	`MGETHDR
+(
+m
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+4660 i(! 
+m
+)
+
+4662 
+m
+->
+m_pkthdr
+.
+rcvif
+ = 0;
+
+4664 i(
+
+->
+_ags
+ & 
+PP_NOFRAMING
+) {
+
+4665 *
+	`mtod
+(
+m
+, 
+ut16_t
+ *
+	`hts
+(
+
+->
+o
+);
+
+4666 
+pkthd
+ = 2;
+
+4667 
+lh
+ = (
+l_hd
+ *)(
+	`mtod
+(
+m
+, 
+ut8_t
+ *)+2);
+
+4669 
+p_hd
+ *
+h
+;
+
+4670 
+h
+ = 
+	`mtod
+(
+m
+, 
+p_hd
+ *);
+
+4671 
+h
+->
+addss
+ = 
+PPP_ALLSTATIONS
+;
+
+4672 
+h
+->
+c
+ = 
+PPP_UI
+;
+
+4673 
+h
+->
+oc
+ = 
+	`hts
+(
+
+->
+o
+);
+
+4674 
+pkthd
+ = 
+PPP_HEADER_LEN
+;
+
+4676 
+lh
+ = (
+l_hd
+ *)(
+h
+ + 1);
+
+4679 
+lh
+->
+ty
+ =ype;
+
+4680 
+lh
+->
+idt
+ = 
+id
+;
+
+4681 
+p
+ = (
+u_ch
+ *)(
+lh
+ + 1);
+
+4683 
+	`va_t
+(
+
+, 
+id
+);
+
+4684 
+n
+ = 0;
+
+4686 (
+mn
+ = ()
+	`va_g
+(
+
+, 
+size_t
+)) != 0) {
+
+4687 
+msg
+ = 
+	`va_g
+(
+
+, const *);
+
+4688 
+n
+ +
+mn
+;
+
+4689 i(
+n
+ > 
+MHLEN
+ - 
+pkthd
+ - 
+LCP_HEADER_LEN
+) {
+
+4690 
+	`va_d
+(
+
+);
+
+4691 
+	`m_m
+(
+m
+);
+
+4695 
+	`memy
+(
+p
+, 
+msg
+, 
+mn
+);
+
+4696 
+p
+ +
+mn
+;
+
+4698 
+	`va_d
+(
+
+);
+
+4700 
+m
+->
+m_pkthdr
+.
+n
+ = m->
+m_n
+ = 
+pkthd
+ + 
+LCP_HEADER_LEN
+ +en;
+
+4701 
+lh
+->
+n
+ = 
+	`hts
+(
+LCP_HEADER_LEN
+ +en);
+
+4703 i(
+debug
+) {
+
+4704 
+	`log
+(
+LOG_DEBUG
+, "%s: %s output <%s id=0x%xen=%d",
+
+4705 
+i
+->
+if_xme
+, 
+
+->
+me
+,
+
+4706 
+	`_auth_ty_me
+(
+
+->
+o
+, 
+lh
+->
+ty
+),
+
+4707 
+lh
+->
+idt
+, 
+	`ohs
+h->
+n
+));
+
+4708 i(
+n
+)
+
+4709 
+	`_t_bys
+((
+u_ch
+ *)(
+lh
+ + 1), 
+n
+);
+
+4710 
+	`addlog
+(">\n");
+
+4712 i(
+	`IF_QFULL
+(&
+
+->
+_q
+)) {
+
+4713 
+	`IF_DROP
+(&
+
+->
+_q
+);
+
+4714 
+	`IF_DROP
+(&
+i
+->
+if_d
+);
+
+4715 
+	`m_m
+(
+m
+);
+
+4716 ++
+i
+->
+if_s
+;
+
+4719 
+	`IF_ENQUEUE
+(&
+
+->
+_q
+, 
+m
+);
+
+4720 i(! (
+i
+->
+if_ags
+ & 
+IFF_OACTIVE
+))
+
+4721 (*
+i
+->
+if_t
+)(ifp);
+
+4722 
+i
+->
+if_obys
+ +
+m
+->
+m_pkthdr
+.
+n
+ + 3;
+
+4723 
+	}
+}
+
+4729 
+	$_klive
+(*
+dummy
+)
+
+4731 
+
+ *
+
+;
+
+4732 
+s
+;
+
+4733 
+time_t
+ 
+now
+;
+
+4735 
+s
+ = 
+	`
+();
+
+4736 
+now
+ = 
+time_uime
+;
+
+4737 
+
+=
+q
+; sp; sp=->
+_xt
+) {
+
+4738 
+i
+ *
+i
+ = &
+
+->
+_if
+;
+
+4741 i((
+
+->
+_id_timeout
+ !0&& (
+i
+->
+if_ags
+ & 
+IFF_RUNNING
+)
+
+4742 && (
+
+->
+_pha
+ =
+SPPP_PHASE_NETWORK
+)) {
+
+4744 i((
+now
+-
+
+->
+__aivy
+>->
+_id_timeout
+) {
+
+4745 i(
+i
+->
+if_ags
+ & 
+IFF_DEBUG
+)
+
+4746 
+	`tf
+("%s:octivity for %lu seconds\n",
+
+4747 
+
+->
+_if
+.
+if_xme
+,
+
+4748 ()(
+now
+-
+
+->
+__aivy
+));
+
+4749 
+l
+.
+	`Clo
+(
+
+);
+
+4755 i(! (
+
+->
+_ags
+ & 
+PP_KEEPALIVE
+) ||
+
+4756 ! (
+i
+->
+if_ags
+ & 
+IFF_RUNNING
+))
+
+4760 i(! (
+
+->
+_ags
+ & 
+PP_CISCO
+) &&
+
+4761 
+
+->
+_pha
+ < 
+SPPP_PHASE_AUTHENTICATE
+)
+
+4765 i((
+now
+ - 
+
+->
+__ive
+< sp->
+_max_neive
+) {
+
+4766 
+
+->
+_ivet
+ = 0;
+
+4770 i(
+
+->
+_ivet
+ >->
+_maxive
+) {
+
+4772 
+	`if_down
+ (
+i
+);
+
+4773 
+	`IF_PURGE
+(&
+
+->
+_q
+);
+
+4774 i(! (
+
+->
+_ags
+ & 
+PP_CISCO
+)) {
+
+4775 
+	`tf
+("%s: LCP keepaliveimed out, goingoestarthe connection\n",
+
+4776 
+i
+->
+if_xme
+);
+
+4777 
+
+->
+_ivet
+ = 0;
+
+4780 
+l
+.
+	`Clo
+(
+
+);
+
+4783 
+	`__chge_e
+(&
+l
+, 
+
+, 
+STATE_STOPPED
+);
+
+4787 i(
+
+->
+_f
+)
+
+4788 
+
+->
+	`_f
+(sp);
+
+4792 i(
+
+->
+_ivet
+ < sp->
+_maxive
+)
+
+4793 ++
+
+->
+_ivet
+;
+
+4794 i(
+
+->
+_ags
+ & 
+PP_CISCO
+)
+
+4795 
+	`_cisco_nd
+(
+
+, 
+CISCO_KEEPALIVE_REQ
+,
+
+4796 ++
+
+->
+_q
+[
+IDX_LCP
+], sp->
+_rq
+[IDX_LCP]);
+
+4797 i(
+
+->
+_pha
+ >
+SPPP_PHASE_AUTHENTICATE
+) {
+
+4798 
+t32_t
+ 
+nmagic
+ = 
+	`htl
+(
+
+->
+l
+.
+magic
+);
+
+4799 
+
+->
+l
+.
+echoid
+ = ++->
+_q
+[
+IDX_LCP
+];
+
+4800 
+	`__nd
+(
+
+, 
+PPP_LCP
+, 
+ECHO_REQ
+,
+
+4801 
+
+->
+l
+.
+echoid
+, 4, &
+nmagic
+);
+
+4804 
+	`lx
+(
+s
+);
+
+4805 
+	`out_t
+(&
+klive_ch
+, 
+hz
+ * 
+LCP_KEEPALIVE_INTERVAL
+, 
+_klive
+, 
+NULL
+);
+
+4806 
+	}
+}
+
+4808 #ifde
+INET
+
+
+4813 
+	$_g__addrs
+(
+
+ *
+
+, 
+ut32_t
+ *
+c
+, ut32_*
+d
+, ut32_*
+cmask
+)
+
+4815 
+i
+ *
+i
+ = &
+
+->
+_if
+;
+
+4816 
+iddr
+ *
+i
+;
+
+4817 
+sockaddr_
+ *
+si
+, *
+sm
+;
+
+4818 
+ut32_t
+ 
+sc
+, 
+dd
+;
+
+4820 
+sm
+ = 
+NULL
+;
+
+4821 
+sc
+ = 
+dd
+ = 0;
+
+4826 
+si
+ = 0;
+
+4827 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+) {
+
+4828 i(
+i
+->
+i_addr
+->
+_my
+ =
+AF_INET
+) {
+
+4829 
+si
+ = (
+sockaddr_
+ *)
+i
+->
+i_addr
+;
+
+4830 
+sm
+ = (
+sockaddr_
+ *)
+i
+->
+i_tmask
+;
+
+4831 i(
+si
+)
+
+4835 i(
+i
+) {
+
+4836 i(
+si
+ && si->
+s_addr
+.
+s_addr
+) {
+
+4837 
+sc
+ = 
+si
+->
+s_addr
+.
+s_addr
+;
+
+4838 i(
+cmask
+)
+
+4839 *
+cmask
+ = 
+	`ohl
+(
+sm
+->
+s_addr
+.
+s_addr
+);
+
+4842 
+si
+ = (
+sockaddr_
+ *)
+i
+->
+i_daddr
+;
+
+4843 i(
+si
+ && si->
+s_addr
+.
+s_addr
+)
+
+4844 
+dd
+ = 
+si
+->
+s_addr
+.
+s_addr
+;
+
+4847 i(
+d
+*d = 
+	`ohl
+(
+dd
+);
+
+4848 i(
+c
+*
+	`ohl
+(
+sc
+);
+
+4849 
+	}
+}
+
+4856 
+	$_t__addrs
+(
+
+ *
+
+, 
+ut32_t
+ 
+myaddr
+, ut32_
+hiddr
+)
+
+4858 
+STDDCL
+;
+
+4859 
+iddr
+ *
+i
+;
+
+4860 
+sockaddr_
+ *
+si
+, *
+de
+;
+
+4867 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+) {
+
+4868 i(
+i
+->
+i_addr
+->
+_my
+ =
+AF_INET
+) {
+
+4869 
+si
+ = (
+sockaddr_
+ *)
+i
+->
+i_addr
+;
+
+4870 
+de
+ = (
+sockaddr_
+ *)
+i
+->
+i_daddr
+;
+
+4871 
+found
+;
+
+4876 
+found
+:
+
+4878 
+r
+, 
+hoIsNew
+;
+
+4879 
+sockaddr_
+ 
+w_s
+ = *
+si
+;
+
+4880 
+sockaddr_
+ 
+w_d
+ = *
+de
+;
+
+4887 
+	`_ifsub
+(
+i
+, 
+	`ito
+(
+i
+));
+
+4889 
+hoIsNew
+ = 0;
+
+4890 i(
+myaddr
+ != 0) {
+
+4891 i(
+w_s
+.
+s_addr
+.
+s_addr
+ !
+	`htl
+(
+myaddr
+)) {
+
+4892 
+w_s
+.
+s_addr
+.
+s_addr
+ = 
+	`htl
+(
+myaddr
+);
+
+4893 
+hoIsNew
+ = 1;
+
+4896 i(
+hiddr
+ != 0) {
+
+4897 
+w_d
+.
+s_addr
+.
+s_addr
+ = 
+	`htl
+(
+hiddr
+);
+
+4898 i(
+w_d
+.
+s_addr
+.
+s_addr
+ !
+de
+->sin_addr.s_addr) {
+
+4899 
+
+->
+
+.
+ved_hiddr
+ = 
+de
+->
+s_addr
+.
+s_addr
+;
+
+4900 *
+de
+ = 
+w_d
+;
+
+4903 
+r
+ = 
+	`_if
+(
+i
+, 
+	`ito
+(
+i
+), &
+w_s
+, 0, 
+hoIsNew
+);
+
+4904 i(
+debug
+ && 
+r
+)
+
+4906 
+	`log
+(
+LOG_DEBUG
+, "%s: sppp_set_ip_addrs: in_ifinit "
+
+4907 " faed,=%d\n", 
+i
+->
+if_xme
+, 
+r
+);
+
+4909 i(!
+r
+) {
+
+4910 ()
+	`pf_run_hooks
+(
+if_pf
+,
+
+4911 (
+mbuf
+ **)
+SIOCAIFADDR
+, 
+i
+, 
+PFIL_IFADDR
+);
+
+4914 
+	}
+}
+
+4920 
+	$_r__addrs
+(
+
+ *
+
+)
+
+4922 
+i
+ *
+i
+ = &
+
+->
+_if
+;
+
+4923 
+iddr
+ *
+i
+;
+
+4924 
+sockaddr_
+ *
+si
+, *
+de
+;
+
+4926 
+ut32_t
+ 
+me
+;
+
+4927 i(
+
+->
+
+.
+ags
+ & 
+IPCP_HISADDR_DYN
+)
+
+4928 
+me
+ = 
+
+->
+
+.
+ved_hiddr
+;
+
+4930 
+	`_g__addrs
+(
+
+, 0, &
+me
+, 0);
+
+4937 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+) {
+
+4938 i(
+i
+->
+i_addr
+->
+_my
+ =
+AF_INET
+) {
+
+4939 
+si
+ = (
+sockaddr_
+ *)
+i
+->
+i_addr
+;
+
+4940 
+de
+ = (
+sockaddr_
+ *)
+i
+->
+i_daddr
+;
+
+4941 
+found
+;
+
+4946 
+found
+:
+
+4948 
+sockaddr_
+ 
+w_s
+ = *
+si
+;
+
+4950 
+	`_ifsub
+(
+i
+, 
+	`ito
+(
+i
+));
+
+4951 i(
+
+->
+
+.
+ags
+ & 
+IPCP_MYADDR_DYN
+)
+
+4952 
+w_s
+.
+s_addr
+.
+s_addr
+ = 0;
+
+4953 i(
+
+->
+
+.
+ags
+ & 
+IPCP_HISADDR_DYN
+)
+
+4955 
+de
+->
+s_addr
+.
+s_addr
+ = 
+
+->
+
+.
+ved_hiddr
+;
+
+4956 
+	`_if
+(
+i
+, 
+	`ito
+(
+i
+), &
+w_s
+, 0, 0);
+
+4957 ()
+	`pf_run_hooks
+(
+if_pf
+,
+
+4958 (
+mbuf
+ **)
+SIOCDIFADDR
+, 
+i
+, 
+PFIL_IFADDR
+);
+
+4960 
+	}
+}
+
+4963 #ifde
+INET6
+
+
+4968 
+	$_g_6_addrs
+(
+
+ *
+
+, 
+6_addr
+ *
+c
+, 6_add*
+d
+,
+
+4969 
+6_addr
+ *
+cmask
+)
+
+4971 
+i
+ *
+i
+ = &
+
+->
+_if
+;
+
+4972 
+iddr
+ *
+i
+;
+
+4973 
+sockaddr_6
+ *
+si
+, *
+sm
+;
+
+4974 
+6_addr
+ 
+sc
+, 
+dd
+;
+
+4976 
+sm
+ = 
+NULL
+;
+
+4977 
+	`memt
+(&
+sc
+, 0, (ssrc));
+
+4978 
+	`memt
+(&
+dd
+, 0, (ddst));
+
+4983 
+si
+ = 0;
+
+4984 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+)
+
+4985 i(
+i
+->
+i_addr
+->
+_my
+ =
+AF_INET6
+) {
+
+4986 
+si
+ = (
+sockaddr_6
+ *)
+i
+->
+i_addr
+;
+
+4987 
+sm
+ = (
+sockaddr_6
+ *)
+i
+->
+i_tmask
+;
+
+4988 i(
+si
+ && 
+	`IN6_IS_ADDR_LINKLOCAL
+(&si->
+s6_addr
+))
+
+4991 i(
+i
+) {
+
+4992 i(
+si
+ && !
+	`IN6_IS_ADDR_UNSPECIFIED
+(&si->
+s6_addr
+)) {
+
+4993 
+	`memy
+(&
+sc
+, &
+si
+->
+s6_addr
+, (ssrc));
+
+4994 i(
+cmask
+) {
+
+4995 
+	`memy
+(
+cmask
+, &
+sm
+->
+s6_addr
+,
+
+4996 (*
+cmask
+));
+
+5000 
+si
+ = (
+sockaddr_6
+ *)
+i
+->
+i_daddr
+;
+
+5001 i(
+si
+ && !
+	`IN6_IS_ADDR_UNSPECIFIED
+(&si->
+s6_addr
+))
+
+5002 
+	`memy
+(&
+dd
+, &
+si
+->
+s6_addr
+, (ddst));
+
+5005 i(
+d
+)
+
+5006 
+	`memy
+(
+d
+, &
+dd
+, (*dst));
+
+5007 i(
+c
+)
+
+5008 
+	`memy
+(
+c
+, &
+sc
+, (*src));
+
+5009 
+	}
+}
+
+5011 #ifde
+IPV6CP_MYIFID_DYN
+
+
+5016 
+	$_g_6_addr
+(
+
+ *
+
+, 
+6_addr
+ *
+addr
+)
+
+5019 
+	}
+}
+
+5025 
+	$_t_6_addr
+(
+
+ *
+
+, c 
+6_addr
+ *
+c
+)
+
+5027 
+STDDCL
+;
+
+5028 
+iddr
+ *
+i
+;
+
+5029 
+sockaddr_6
+ *
+s6
+;
+
+5036 
+s6
+ = 
+NULL
+;
+
+5037 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+)
+
+5039 i(
+i
+->
+i_addr
+->
+_my
+ =
+AF_INET6
+)
+
+5041 
+s6
+ = (
+sockaddr_6
+ *)
+i
+->
+i_addr
+;
+
+5042 i(
+s6
+ && 
+	`IN6_IS_ADDR_LINKLOCAL
+(&s6->
+s6_addr
+))
+
+5047 i(
+i
+ && 
+s6
+)
+
+5049 
+r
+;
+
+5050 
+sockaddr_6
+ 
+w_s6
+ = *
+s6
+;
+
+5052 
+	`memy
+(&
+w_s6
+.
+s6_addr
+, 
+c
+, (new_sin6.sin6_addr));
+
+5053 
+r
+ = 
+	`6_if
+(
+i
+, 
+	`ito6
+(
+i
+), &
+w_s6
+, 1);
+
+5054 i(
+debug
+ && 
+r
+)
+
+5056 
+	`log
+(
+LOG_DEBUG
+, "%s: sppp_set_ip6_addr: in6_ifinit "
+
+5057 " faed,=%d\n", 
+i
+->
+if_xme
+, 
+r
+);
+
+5059 i(!
+r
+) {
+
+5060 ()
+	`pf_run_hooks
+(
+if_pf
+,
+
+5061 (
+mbuf
+ **)
+SIOCAIFADDR_IN6
+, 
+i
+, 
+PFIL_IFADDR
+);
+
+5064 
+	}
+}
+
+5071 
+	$_sugge_6_addr
+(
+
+ *
+
+, 
+6_addr
+ *
+sugge
+)
+
+5073 
+6_addr
+ 
+myaddr
+;
+
+5074 
+timev
+ 
+tv
+;
+
+5076 
+	`_g_6_addrs
+(
+
+, &
+myaddr
+, 0, 0);
+
+5078 
+myaddr
+.
+s6_addr
+[8] &= ~0x02;
+
+5079 
+	`miime
+(&
+tv
+);
+
+5080 i((
+tv
+.
+tv_uc
+ & 0xff=0 && (tv.
+tv_c
+ & 0xff) == 0) {
+
+5081 
+myaddr
+.
+s6_addr
+[14] ^= 0xff;
+
+5082 
+myaddr
+.
+s6_addr
+[15] ^= 0xff;
+
+5084 
+myaddr
+.
+s6_addr
+[14] ^(
+tv
+.
+tv_uc
+ & 0xff);
+
+5085 
+myaddr
+.
+s6_addr
+[15] ^(
+tv
+.
+tv_c
+ & 0xff);
+
+5087 i(
+sugge
+)
+
+5088 
+	`memy
+(
+sugge
+, &
+myaddr
+, (myaddr));
+
+5089 
+	}
+}
+
+5097 
+	$_ms
+(
+
+ *
+
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+5099 
+cmd
+) {
+
+5100 
+SPPPGETAUTHCFG
+:
+
+5102 
+authcfg
+ *
+cfg
+ = (authcfg *)
+da
+;
+
+5103 
+r
+;
+
+5104 
+size_t
+ 
+n
+;
+
+5106 
+cfg
+->
+myauthags
+ = 
+
+->
+myauth
+.
+ags
+;
+
+5107 
+cfg
+->
+hiuthags
+ = 
+
+->
+hiuth
+.
+ags
+;
+
+5108 
+	`y
+(
+cfg
+->
+iame
+, 
+
+->
+_if
+.
+if_xme
+, 
+IFNAMSIZ
+);
+
+5109 
+cfg
+->
+hiuth
+ = 0;
+
+5110 i(
+
+->
+hiuth
+.
+o
+)
+
+5111 
+cfg
+->
+hiuth
+ = (
+
+->hiuth.
+o
+ =
+PPP_PAP
+? 
+SPPP_AUTHPROTO_PAP
+ : 
+SPPP_AUTHPROTO_CHAP
+;
+
+5112 
+cfg
+->
+myauth
+ = 0;
+
+5113 i(
+
+->
+myauth
+.
+o
+)
+
+5114 
+cfg
+->
+myauth
+ = (
+
+->myauth.
+o
+ =
+PPP_PAP
+? 
+SPPP_AUTHPROTO_PAP
+ : 
+SPPP_AUTHPROTO_CHAP
+;
+
+5115 i(
+cfg
+->
+myme_ngth
+ == 0) {
+
+5116 i(
+
+->
+myauth
+.
+me
+ !
+NULL
+)
+
+5117 
+cfg
+->
+myme_ngth
+ = 
+
+->
+myauth
+.
+me_n
+ + 1;
+
+5119 i(
+
+->
+myauth
+.
+me
+ =
+NULL
+) {
+
+5120 
+cfg
+->
+myme_ngth
+ = 0;
+
+5122 
+n
+ = 
+
+->
+myauth
+.
+me_n
+ + 1;
+
+5123 i(
+cfg
+->
+myme_ngth
+ < 
+n
+)
+
+5124  (
+ENAMETOOLONG
+);
+
+5125 
+r
+ = 
+	`cyout
+(
+
+->
+myauth
+.
+me
+, 
+cfg
+->
+myme
+, 
+n
+);
+
+5126 i(
+r
+) rror;
+
+5129 i(
+cfg
+->
+hiame_ngth
+ == 0) {
+
+5130 i(
+
+->
+hiuth
+.
+me
+ !
+NULL
+)
+
+5131 
+cfg
+->
+hiame_ngth
+ = 
+
+->
+hiuth
+.
+me_n
+ + 1;
+
+5133 i(
+
+->
+hiuth
+.
+me
+ =
+NULL
+) {
+
+5134 
+cfg
+->
+hiame_ngth
+ = 0;
+
+5136 
+n
+ = 
+
+->
+hiuth
+.
+me_n
+ + 1;
+
+5137 i(
+cfg
+->
+hiame_ngth
+ < 
+n
+)
+
+5138  (
+ENAMETOOLONG
+);
+
+5139 
+r
+ = 
+	`cyout
+(
+
+->
+hiuth
+.
+me
+, 
+cfg
+->
+hiame
+, 
+n
+);
+
+5140 i(
+r
+) rror;
+
+5145 
+SPPPSETAUTHCFG
+:
+
+5147 
+authcfg
+ *
+cfg
+ = (authcfg *)
+da
+;
+
+5148 
+r
+;
+
+5150 i(
+
+->
+myauth
+.
+me
+) {
+
+5151 
+	`
+(
+
+->
+myauth
+.
+me
+, 
+M_DEVBUF
+);
+
+5152 
+
+->
+myauth
+.
+me
+ = 
+NULL
+;
+
+5154 i(
+
+->
+myauth
+.
+
+) {
+
+5155 
+	`
+(
+
+->
+myauth
+.
+
+, 
+M_DEVBUF
+);
+
+5156 
+
+->
+myauth
+.
+
+ = 
+NULL
+;
+
+5158 i(
+
+->
+hiuth
+.
+me
+) {
+
+5159 
+	`
+(
+
+->
+hiuth
+.
+me
+, 
+M_DEVBUF
+);
+
+5160 
+
+->
+hiuth
+.
+me
+ = 
+NULL
+;
+
+5162 i(
+
+->
+hiuth
+.
+
+) {
+
+5163 
+	`
+(
+
+->
+hiuth
+.
+
+, 
+M_DEVBUF
+);
+
+5164 
+
+->
+hiuth
+.
+
+ = 
+NULL
+;
+
+5167 i(
+cfg
+->
+hiame
+ !
+NULL
+ && cfg->
+hiame_ngth
+ > 0) {
+
+5168 i(
+cfg
+->
+hiame_ngth
+ >
+MCLBYTES
+)
+
+5169  (
+ENAMETOOLONG
+);
+
+5170 
+
+->
+hiuth
+.
+me
+ = 
+	`mloc
+(
+cfg
+->
+hiame_ngth
+, 
+M_DEVBUF
+, 
+M_WAITOK
+);
+
+5171 
+r
+ = 
+	`cy
+(
+cfg
+->
+hiame
+, 
+
+->
+hiuth
+.
+me
+, cfg->
+hiame_ngth
+);
+
+5172 i(
+r
+) {
+
+5173 
+	`
+(
+
+->
+hiuth
+.
+me
+, 
+M_DEVBUF
+);
+
+5174 
+
+->
+hiuth
+.
+me
+ = 
+NULL
+;
+
+5175  
+r
+;
+
+5177 
+
+->
+hiuth
+.
+me_n
+ = 
+cfg
+->
+hiame_ngth
+ - 1;
+
+5178 
+
+->
+hiuth
+.
+me
+[->hiuth.
+me_n
+] = 0;
+
+5180 i(
+cfg
+->
+his
+ !
+NULL
+ && cfg->
+his_ngth
+ > 0) {
+
+5181 i(
+cfg
+->
+his_ngth
+ >
+MCLBYTES
+)
+
+5182  (
+ENAMETOOLONG
+);
+
+5183 
+
+->
+hiuth
+.
+
+ = 
+	`mloc
+(
+cfg
+->
+his_ngth
+, 
+M_DEVBUF
+, 
+M_WAITOK
+);
+
+5184 
+r
+ = 
+	`cy
+(
+cfg
+->
+his
+, 
+
+->
+hiuth
+.
+
+, cfg->
+his_ngth
+);
+
+5185 i(
+r
+) {
+
+5186 
+	`
+(
+
+->
+hiuth
+.
+
+, 
+M_DEVBUF
+);
+
+5187 
+
+->
+hiuth
+.
+
+ = 
+NULL
+;
+
+5188  
+r
+;
+
+5190 
+
+->
+hiuth
+.
+_n
+ = 
+cfg
+->
+his_ngth
+ - 1;
+
+5191 
+
+->
+hiuth
+.
+
+[->hiuth.
+_n
+] = 0;
+
+5193 i(
+cfg
+->
+myme
+ !
+NULL
+ && cfg->
+myme_ngth
+ > 0) {
+
+5194 i(
+cfg
+->
+myme_ngth
+ >
+MCLBYTES
+)
+
+5195  (
+ENAMETOOLONG
+);
+
+5196 
+
+->
+myauth
+.
+me
+ = 
+	`mloc
+(
+cfg
+->
+myme_ngth
+, 
+M_DEVBUF
+, 
+M_WAITOK
+);
+
+5197 
+r
+ = 
+	`cy
+(
+cfg
+->
+myme
+, 
+
+->
+myauth
+.
+me
+, cfg->
+myme_ngth
+);
+
+5198 i(
+r
+) {
+
+5199 
+	`
+(
+
+->
+myauth
+.
+me
+, 
+M_DEVBUF
+);
+
+5200 
+
+->
+myauth
+.
+me
+ = 
+NULL
+;
+
+5201  
+r
+;
+
+5203 
+
+->
+myauth
+.
+me_n
+ = 
+cfg
+->
+myme_ngth
+ - 1;
+
+5204 
+
+->
+myauth
+.
+me
+[->myauth.
+me_n
+] = 0;
+
+5206 i(
+cfg
+->
+my
+ !
+NULL
+ && cfg->
+my_ngth
+ > 0) {
+
+5207 i(
+cfg
+->
+my_ngth
+ >
+MCLBYTES
+)
+
+5208  (
+ENAMETOOLONG
+);
+
+5209 
+
+->
+myauth
+.
+
+ = 
+	`mloc
+(
+cfg
+->
+my_ngth
+, 
+M_DEVBUF
+, 
+M_WAITOK
+);
+
+5210 
+r
+ = 
+	`cy
+(
+cfg
+->
+my
+, 
+
+->
+myauth
+.
+
+, cfg->
+my_ngth
+);
+
+5211 i(
+r
+) {
+
+5212 
+	`
+(
+
+->
+myauth
+.
+
+, 
+M_DEVBUF
+);
+
+5213 
+
+->
+myauth
+.
+
+ = 
+NULL
+;
+
+5214  
+r
+;
+
+5216 
+
+->
+myauth
+.
+_n
+ = 
+cfg
+->
+my_ngth
+ - 1;
+
+5217 
+
+->
+myauth
+.
+
+[->myauth.
+_n
+] = 0;
+
+5219 
+
+->
+myauth
+.
+ags
+ = 
+cfg
+->
+myauthags
+;
+
+5220 i(
+cfg
+->
+myauth
+)
+
+5221 
+
+->
+myauth
+.
+o
+ = (
+cfg
+->myauth =
+SPPP_AUTHPROTO_PAP
+? 
+PPP_PAP
+ : 
+PPP_CHAP
+;
+
+5222 
+
+->
+hiuth
+.
+ags
+ = 
+cfg
+->
+hiuthags
+;
+
+5223 i(
+cfg
+->
+hiuth
+)
+
+5224 
+
+->
+hiuth
+.
+o
+ = (
+cfg
+->hiuth =
+SPPP_AUTHPROTO_PAP
+? 
+PPP_PAP
+ : 
+PPP_CHAP
+;
+
+5225 
+
+->
+_auth_us
+ = 0;
+
+5226 i(
+
+->
+hiuth
+.
+o
+ != 0)
+
+5227 
+
+->
+l
+.
+ts
+ |(1 << 
+LCP_OPT_AUTH_PROTO
+);
+
+5229 
+
+->
+l
+.
+ts
+ &~(1 << 
+LCP_OPT_AUTH_PROTO
+);
+
+5232 
+SPPPGETLCPCFG
+:
+
+5234 
+lcfg
+ *
+lp
+ = (lcfg *)
+da
+;
+
+5235 
+lp
+->
+l_timeout
+ = 
+
+->
+l
+.
+timeout
+;
+
+5238 
+SPPPSETLCPCFG
+:
+
+5240 
+lcfg
+ *
+lp
+ = (lcfg *)
+da
+;
+
+5241 
+
+->
+l
+.
+timeout
+ = 
+lp
+->
+l_timeout
+;
+
+5244 
+SPPPGETSTATUS
+:
+
+5246 
+us
+ *
+us
+ = (u*)
+da
+;
+
+5247 
+us
+->
+pha
+ = 
+
+->
+_pha
+;
+
+5250 
+SPPPGETSTATUSNCP
+:
+
+5252 
+u
+ *
+us
+ = (u *)
+da
+;
+
+5253 
+us
+->
+pha
+ = 
+
+->
+_pha
+;
+
+5254 
+us
+->
+nup
+ = 
+	`_n_check
+(
+
+);
+
+5257 
+SPPPGETIDLETO
+:
+
+5259 
+idtimeout
+ *
+to
+ = (idtimeou*)
+da
+;
+
+5260 
+to
+->
+id_cds
+ = 
+
+->
+_id_timeout
+;
+
+5263 
+SPPPSETIDLETO
+:
+
+5265 
+idtimeout
+ *
+to
+ = (idtimeou*)
+da
+;
+
+5266 
+
+->
+_id_timeout
+ = 
+to
+->
+id_cds
+;
+
+5269 
+SPPPSETAUTHFAILURE
+:
+
+5271 
+authugs
+ *
+afgs
+ = (authug*)
+da
+;
+
+5272 
+
+->
+_max_auth_
+ = 
+afgs
+->
+max_us
+;
+
+5273 
+
+->
+_auth_us
+ = 0;
+
+5276 
+SPPPGETAUTHFAILURES
+:
+
+5278 
+authus
+ *
+s
+ = (authu*)
+da
+;
+
+5279 
+s
+->
+auth_us
+ = 
+
+->
+_auth_us
+;
+
+5280 
+s
+->
+max_us
+ = 
+
+->
+_max_auth_
+;
+
+5283 
+SPPPSETDNSOPTS
+:
+
+5285 
+dnsgs
+ *
+q
+ = (dnsg*)
+da
+;
+
+5286 
+
+->
+quy_dns
+ = 
+q
+->query_dns & 3;
+
+5289 
+SPPPGETDNSOPTS
+:
+
+5291 
+dnsgs
+ *
+q
+ = (dnsg*)
+da
+;
+
+5292 
+q
+->
+quy_dns
+ = 
+
+->query_dns;
+
+5295 
+SPPPGETDNSADDRS
+:
+
+5297 
+dnddrs
+ *
+addrs
+ = (dnddr*)
+da
+;
+
+5298 
+	`memy
+(&
+addrs
+->
+dns
+, &
+
+->
+dns_addrs
+, ddrs->dns);
+
+5301 
+SPPPGETKEEPALIVE
+:
+
+5303 
+klivegs
+ *
+gs
+ =
+
+5304 (
+klivegs
+*)
+da
+;
+
+5305 
+gs
+->
+maxive
+ = 
+
+->
+_maxive
+;
+
+5306 
+gs
+->
+max_neive
+ = 
+
+->
+_max_neive
+;
+
+5309 
+SPPPSETKEEPALIVE
+:
+
+5311 
+klivegs
+ *
+gs
+ =
+
+5312 (
+klivegs
+*)
+da
+;
+
+5313 
+
+->
+_maxive
+ = 
+gs
+->
+maxive
+;
+
+5314 
+
+->
+_max_neive
+ = 
+gs
+->
+max_neive
+;
+
+5317 #i
+	`defed
+(
+COMPAT_50
+|| defed(
+MODULAR
+)
+
+5318 
+__SPPPGETIDLETO50
+:
+
+5320 
+idtimeout50
+ *
+to
+ = (idtimeout50 *)
+da
+;
+
+5321 
+to
+->
+id_cds
+ = (
+ut32_t
+)
+
+->
+_id_timeout
+;
+
+5324 
+__SPPPSETIDLETO50
+:
+
+5326 
+idtimeout50
+ *
+to
+ = (idtimeout50 *)
+da
+;
+
+5327 
+
+->
+_id_timeout
+ = (
+time_t
+)
+to
+->
+id_cds
+;
+
+5330 
+__SPPPGETKEEPALIVE50
+:
+
+5332 
+klivegs50
+ *
+gs
+ =
+
+5333 (
+klivegs50
+*)
+da
+;
+
+5334 
+gs
+->
+maxive
+ = 
+
+->
+_maxive
+;
+
+5335 
+gs
+->
+max_neive
+ = (
+ut32_t
+)
+
+->
+_max_neive
+;
+
+5338 
+__SPPPSETKEEPALIVE50
+:
+
+5340 
+klivegs50
+ *
+gs
+ =
+
+5341 (
+klivegs50
+*)
+da
+;
+
+5342 
+
+->
+_maxive
+ = 
+gs
+->
+maxive
+;
+
+5343 
+
+->
+_max_neive
+ = (
+time_t
+)
+gs
+->
+max_neive
+;
+
+5348  (
+EINVAL
+);
+
+5352 
+	}
+}
+
+5355 
+	$_pha_twk
+(
+
+ *
+
+)
+
+5357 
+STDDCL
+;
+
+5358 
+i
+;
+
+5359 
+ut32_t
+ 
+mask
+;
+
+5361 
+
+->
+_pha
+ = 
+SPPP_PHASE_NETWORK
+;
+
+5363 i(
+debug
+)
+
+5365 
+	`log
+(
+LOG_INFO
+, "%s:ha %s\n", 
+i
+->
+if_xme
+,
+
+5366 
+	`_pha_me
+(
+
+->
+_pha
+));
+
+5370 
+i
+ = 0; i < 
+IDX_COUNT
+; i++)
+
+5371 i((
+s
+[
+i
+])->
+ags
+ & 
+CP_NCP
+)
+
+5372 (
+s
+[
+i
+])->
+	`On
+(
+
+);
+
+5375 
+i
+ = 0, 
+mask
+ = 1; i < 
+IDX_COUNT
+; i++, mask <<= 1)
+
+5376 i((
+
+->
+l
+.
+os
+ & 
+mask
+&& ((
+s
+[
+i
+])->
+ags
+ & 
+CP_NCP
+))
+
+5377 (
+s
+[
+i
+])->
+	`Up
+(
+
+);
+
+5380 
+	`_l_check_d_o
+(
+
+);
+
+5381 
+	}
+}
+
+5385 
+	$__ty_me
+(
+u_ch
+ 
+ty
+)
+
+5387 
+buf
+[12];
+
+5388 
+ty
+) {
+
+5389 
+CONF_REQ
+:  "conf-req";
+
+5390 
+CONF_ACK
+:  "conf-ack";
+
+5391 
+CONF_NAK
+:  "conf-nak";
+
+5392 
+CONF_REJ
+:  "conf-rej";
+
+5393 
+TERM_REQ
+:  "term-req";
+
+5394 
+TERM_ACK
+:  "term-ack";
+
+5395 
+CODE_REJ
+:  "code-rej";
+
+5396 
+PROTO_REJ
+:  "proto-rej";
+
+5397 
+ECHO_REQ
+:  "echo-req";
+
+5398 
+ECHO_REPLY
+:  "echo-reply";
+
+5399 
+DISC_REQ
+:  "discard-req";
+
+5401 
+	`tf
+(
+buf
+, (buf), "0x%x", 
+ty
+);
+
+5402  
+buf
+;
+
+5403 
+	}
+}
+
+5406 
+	$_auth_ty_me
+(
+u_sht
+ 
+o
+, 
+u_ch
+ 
+ty
+)
+
+5408 
+buf
+[12];
+
+5409 
+o
+) {
+
+5410 
+PPP_CHAP
+:
+
+5411 
+ty
+) {
+
+5412 
+CHAP_CHALLENGE
+:  "challenge";
+
+5413 
+CHAP_RESPONSE
+:  "response";
+
+5414 
+CHAP_SUCCESS
+:  "success";
+
+5415 
+CHAP_FAILURE
+:  "failure";
+
+5417 
+PPP_PAP
+:
+
+5418 
+ty
+) {
+
+5419 
+PAP_REQ
+:  "req";
+
+5420 
+PAP_ACK
+:  "ack";
+
+5421 
+PAP_NAK
+:  "nak";
+
+5424 
+	`tf
+(
+buf
+, (buf), "0x%x", 
+ty
+);
+
+5425  
+buf
+;
+
+5426 
+	}
+}
+
+5429 
+	$_l_t_me
+(
+u_ch
+ 
+t
+)
+
+5431 
+buf
+[12];
+
+5432 
+t
+) {
+
+5433 
+LCP_OPT_MRU
+:  "mru";
+
+5434 
+LCP_OPT_ASYNC_MAP
+:  "async-map";
+
+5435 
+LCP_OPT_AUTH_PROTO
+:  "auth-proto";
+
+5436 
+LCP_OPT_QUAL_PROTO
+:  "qual-proto";
+
+5437 
+LCP_OPT_MAGIC
+:  "magic";
+
+5438 
+LCP_OPT_PROTO_COMP
+:  "proto-comp";
+
+5439 
+LCP_OPT_ADDR_COMP
+:  "addr-comp";
+
+5441 
+	`tf
+(
+buf
+, (buf), "0x%x", 
+t
+);
+
+5442  
+buf
+;
+
+5443 
+	}
+}
+
+5446 
+	$__t_me
+(
+u_ch
+ 
+t
+)
+
+5448 
+buf
+[12];
+
+5449 
+t
+) {
+
+5450 
+IPCP_OPT_ADDRESSES
+:  "addresses";
+
+5451 
+IPCP_OPT_COMPRESSION
+:  "compression";
+
+5452 
+IPCP_OPT_ADDRESS
+:  "address";
+
+5454 
+	`tf
+(
+buf
+, (buf), "0x%x", 
+t
+);
+
+5455  
+buf
+;
+
+5456 
+	}
+}
+
+5458 #ifde
+INET6
+
+
+5460 
+	$_v6_t_me
+(
+u_ch
+ 
+t
+)
+
+5462 
+buf
+[12];
+
+5463 
+t
+) {
+
+5464 
+IPV6CP_OPT_IFID
+:  "ifid";
+
+5465 
+IPV6CP_OPT_COMPRESSION
+:  "compression";
+
+5467 
+	`tf
+(
+buf
+, (buf), "0x%x", 
+t
+);
+
+5468  
+buf
+;
+
+5469 
+	}
+}
+
+5473 
+	$_e_me
+(
+e
+)
+
+5475 
+e
+) {
+
+5476 
+STATE_INITIAL
+:  "initial";
+
+5477 
+STATE_STARTING
+:  "starting";
+
+5478 
+STATE_CLOSED
+:  "closed";
+
+5479 
+STATE_STOPPED
+:  "stopped";
+
+5480 
+STATE_CLOSING
+:  "closing";
+
+5481 
+STATE_STOPPING
+:  "stopping";
+
+5482 
+STATE_REQ_SENT
+:  "req-sent";
+
+5483 
+STATE_ACK_RCVD
+:  "ack-rcvd";
+
+5484 
+STATE_ACK_SENT
+:  "ack-sent";
+
+5485 
+STATE_OPENED
+:  "opened";
+
+5488 
+	}
+}
+
+5491 
+	$_pha_me
+(
+pha
+)
+
+5493 
+pha
+) {
+
+5494 
+SPPP_PHASE_DEAD
+:  "dead";
+
+5495 
+SPPP_PHASE_ESTABLISH
+:  "establish";
+
+5496 
+SPPP_PHASE_TERMINATE
+:  "terminate";
+
+5497 
+SPPP_PHASE_AUTHENTICATE
+:  "authenticate";
+
+5498 
+SPPP_PHASE_NETWORK
+:  "network";
+
+5501 
+	}
+}
+
+5504 
+	$_o_me
+(
+u_sht
+ 
+o
+)
+
+5506 
+buf
+[12];
+
+5507 
+o
+) {
+
+5508 
+PPP_LCP
+:  "lcp";
+
+5509 
+PPP_IPCP
+:  "ipcp";
+
+5510 
+PPP_PAP
+:  "pap";
+
+5511 
+PPP_CHAP
+:  "chap";
+
+5512 
+PPP_IPV6CP
+:  "ipv6cp";
+
+5514 
+	`tf
+(
+buf
+, (buf), "0x%x", ()
+o
+);
+
+5515  
+buf
+;
+
+5516 
+	}
+}
+
+5519 
+	$_t_bys
+(c 
+u_ch
+ *
+p
+, 
+u_sht
+ 
+n
+)
+
+5521 
+	`addlog
+(" %02x", *
+p
+++);
+
+5522 --
+n
+ > 0)
+
+5523 
+	`addlog
+("-%02x", *
+p
+++);
+
+5524 
+	}
+}
+
+5527 
+	$_t_rg
+(c *
+p
+, 
+u_sht
+ 
+n
+)
+
+5529 
+u_ch
+ 
+c
+;
+
+5531 
+n
+-- > 0) {
+
+5532 
+c
+ = *
+p
+++;
+
+5536 i(
+c
+ < ' ' || c > '~')
+
+5537 
+	`addlog
+("\\x%x", 
+c
+);
+
+5539 
+	`addlog
+("%c", 
+c
+);
+
+5541 
+	}
+}
+
+5544 
+	$_dd_quad
+(
+ut32_t
+ 
+addr
+)
+
+5546 
+s
+[16];
+
+5547 
+	`tf
+(
+s
+, (s), "%d.%d.%d.%d",
+
+5548 ()((
+addr
+ >> 24) & 0xff),
+
+5549 ()((
+addr
+ >> 16) & 0xff),
+
+5550 ()((
+addr
+ >> 8) & 0xff),
+
+5551 ()(
+addr
+ & 0xff));
+
+5552  
+s
+;
+
+5553 
+	}
+}
+
+5557 
+	$_nu
+(
+
+ *
+unud
+)
+
+5560 
+	}
+}
+
+	@if_spppvar.h
+
+3 #ide
+_NET_IF_SPPPVAR_H_
+
+
+4 
+	#_NET_IF_SPPPVAR_H_
+
+
+	)
+
+29 
+	#IDX_LCP
+ 0
+
+	)
+
+31 
+	s
+ {
+
+32 
+u_lg
+ 
+	mts
+;
+
+33 
+u_lg
+ 
+	mmagic
+;
+
+34 
+u_lg
+ 
+	mmru
+;
+
+35 
+u_lg
+ 
+	mthe_mru
+;
+
+36 
+u_lg
+ 
+	mos
+;
+
+37 
+u_ch
+ 
+	mechoid
+;
+
+39 
+	mtimeout
+;
+
+40 
+	mmax_rme
+;
+
+41 
+	mmax_cfigu
+;
+
+42 
+	mmax_u
+;
+
+45 
+	#IDX_IPCP
+ 1
+
+	)
+
+46 
+	#IDX_IPV6CP
+ 2
+
+	)
+
+48 
+	ss
+ {
+
+49 
+u_lg
+ 
+	mts
+;
+
+50 
+u_t
+ 
+	mags
+;
+
+51 
+	#IPCP_HISADDR_SEEN
+ 1
+
+	)
+
+52 
+	#IPCP_MYADDR_SEEN
+ 2
+
+	)
+
+53 
+	#IPCP_MYADDR_DYN
+ 4
+
+	)
+
+54 
+	#IPCP_HISADDR_DYN
+ 8
+
+	)
+
+55 #ifde
+ndef
+
+
+56 
+	#IPV6CP_MYIFID_DYN
+ 2
+
+	)
+
+58 
+	#IPV6CP_MYIFID_SEEN
+ 4
+
+	)
+
+59 
+ut32_t
+ 
+	mved_hiddr
+;
+
+60 
+ut32_t
+ 
+	mq_hiddr
+;
+
+61 
+ut32_t
+ 
+	mq_myaddr
+;
+
+64 
+	suth
+ {
+
+65 
+u_sht
+ 
+	mo
+;
+
+66 
+u_sht
+ 
+	mags
+;
+
+67 *
+	mme
+;
+
+68 *
+	m
+;
+
+69 
+u_ch
+ 
+	mme_n
+;
+
+70 
+u_ch
+ 
+	m_n
+;
+
+71 
+	mchnge
+[16];
+
+74 
+	#IDX_PAP
+ 3
+
+	)
+
+75 
+	#IDX_CHAP
+ 4
+
+	)
+
+77 
+	#IDX_COUNT
+ (
+IDX_CHAP
+ + 1
+
+	)
+
+79 
+	s
+ {
+
+81 
+i
+ 
+	m_if
+;
+
+82 
+ifqueue
+ 
+	m_q
+;
+
+83 
+ifqueue
+ 
+	m_q
+;
+
+84 
+
+ *
+	m_xt
+;
+
+85 
+u_t
+ 
+	m_ags
+;
+
+86 
+u_t
+ 
+	m_amebys
+;
+
+87 
+u_t
+ 
+	m_ivet
+;
+
+88 
+u_t
+ 
+	m_lot
+;
+
+89 
+u_t
+ 
+	m_maxive
+;
+
+90 
+u_lg
+ 
+	m_q
+[
+IDX_COUNT
+];
+
+91 
+u_lg
+ 
+	m_rq
+[
+IDX_COUNT
+];
+
+92 
+ut64_t
+ 
+	m_ved_mtu
+;
+
+93 
+time_t
+ 
+	m__ive
+;
+
+94 
+time_t
+ 
+	m_max_neive
+;
+
+97 
+time_t
+ 
+	m__aivy
+;
+
+98 
+time_t
+ 
+	m_id_timeout
+;
+
+100 
+	m_auth_us
+;
+
+101 
+	m_max_auth_
+;
+
+102 
+	m_pha
+;
+
+103 
+	mquy_dns
+;
+
+104 
+ut32_t
+ 
+	mdns_addrs
+[2];
+
+105 
+	me
+[
+IDX_COUNT
+];
+
+106 
+u_ch
+ 
+	mcfid
+[
+IDX_COUNT
+];
+
+107 
+	mr_cou
+[
+IDX_COUNT
+];
+
+108 
+	m_cou
+[
+IDX_COUNT
+];
+
+109 #i
+defed
+(
+__NBSD__
+)
+
+110 
+out
+ 
+	mch
+[
+IDX_COUNT
+];
+
+111 
+out
+ 
+	mp_my_to_ch
+;
+
+113 #i
+defed
+(
+__FeBSD__
+) && __FreeBSD__ >= 3
+
+114 
+out_hd
+ 
+	mch
+[
+IDX_COUNT
+];
+
+115 
+out_hd
+ 
+	mp_my_to_ch
+;
+
+117 
+
+ 
+	ml
+;
+
+118 
+s
+ 
+	m
+;
+
+119 
+s
+ 
+	mv6
+;
+
+120 
+uth
+ 
+	mmyauth
+;
+
+121 
+uth
+ 
+	mhiuth
+;
+
+130 (*
+	m_up
+)(
+	m
+ *);
+
+131 (*
+	m_down
+)(
+	m
+ *);
+
+138 (*
+	m_s
+)(
+	m
+ *);
+
+139 (*
+	m_f
+)(
+	m
+ *);
+
+147 (*
+	m_c
+)(
+	m
+ *);
+
+148 (*
+	m_chg
+)(
+	m
+ *, );
+
+151 
+	#PP_KEEPALIVE
+ 0x01
+
+	)
+
+152 
+	#PP_CISCO
+ 0x02
+
+	)
+
+154 
+	#PP_CALLIN
+ 0x08
+
+	)
+
+155 
+	#PP_NEEDAUTH
+ 0x10
+
+	)
+
+156 
+	#PP_NOFRAMING
+ 0x20
+
+	)
+
+161 
+	#PP_MTU
+ 1500
+
+	)
+
+162 
+	#PP_MAX_MRU
+ 2048
+
+	)
+
+164 #ifde
+_KERNEL
+
+
+165 
+_ch
+ (
+i
+ *);
+
+166 
+_dach
+ (
+i
+ *);
+
+167 
+_put
+ (
+i
+ *, 
+mbuf
+ *);
+
+168 
+_iol
+(
+i
+ *, 
+u_lg
+, *);
+
+169 
+mbuf
+ *
+_dequeue
+ (
+i
+ *);
+
+170 
+_imy
+ (
+i
+ *);
+
+171 
+_ush
+ (
+i
+ *);
+
+	@if_srt.c
+
+4 
+	~<sys/cdefs.h
+>
+
+5 
+__KERNEL_RCSID
+(0, "$NetBSD: if_srt.c,v 1.19 2014/07/25 08:10:40 dholland Exp $");
+
+7 
+	~"t_.h
+"
+
+9 #i!
+defed
+(
+INET
+&& !defed(
+INET6
+)
+
+13 #ide
+SRT_MAXUNIT
+
+
+14 
+	#SRT_MAXUNIT
+ 255
+
+	)
+
+18 
+	~<sys/tys.h
+>
+
+19 
+	~<sys/sour.h
+>
+
+22 
+	~<t/.h
+>
+
+23 
+	~<sys/m.h
+>
+
+24 
+	~<t/_sym.h
+>
+
+26 
+	~<sys/cf.h
+>
+
+27 
+	~<sys/mbuf.h
+>
+
+28 
+	~<sys/o.h
+>
+
+29 
+	~<sys/f.h
+>
+
+30 
+	~<sys/m.h
+>
+
+31 
+	~<sys/iol.h
+>
+
+32 
+	~<t/.h
+>
+
+33 
+	~<t/6.h
+>
+
+34 
+	~<t/if_tys.h
+>
+
+36 
+	~"if_t.h
+"
+
+41 
+	st_soc
+ {
+
+42 
+i
+ 
+	mtf
+;
+
+43 
+	mun
+;
+
+44 
+	mt
+;
+
+45 
+t_
+ **
+	ms
+;
+
+46 
+	mags
+;
+
+47 
+	#SSF_UCHG
+ (
+SSF_MTULOCK
+
+
+	)
+
+48 
+	mkags
+;
+
+49 
+	#SKF_CDEVOPEN
+ 0x00000001
+
+	)
+
+52 
+ach
+();
+
+54 
+t_soc
+ *
+	gsocv
+[
+SRT_MAXUNIT
++1];
+
+55 
+	gglob_ags
+;
+
+59 
+	gv4_masks
+[33] = {
+
+72 
+	$upde_mtu
+(
+t_soc
+ *
+sc
+)
+
+74 
+mtu
+;
+
+75 
+i
+;
+
+76 
+t_
+ *
+r
+;
+
+78 i(
+sc
+->
+ags
+ & 
+SSF_MTULOCK
+)
+
+80 
+mtu
+ = 65535;
+
+81 
+i
+=
+sc
+->
+t
+-1;i>=0;i--) {
+
+82 
+r
+ = 
+sc
+->
+s
+[
+i
+];
+
+83 i(
+r
+->
+u
+.
+di
+->
+if_mtu
+ < 
+mtu
+)
+
+84 
+mtu
+ = 
+r
+->
+u
+.
+di
+->
+if_mtu
+;
+
+86 
+sc
+->
+tf
+.
+if_mtu
+ = 
+mtu
+;
+
+87 
+	}
+}
+
+89 
+t_
+ *
+
+90 
+	$fd_
+(
+t_soc
+ *
+sc
+, 
+af
+, ...)
+
+92 
+i
+;
+
+93 
+t_
+ *
+r
+;
+
+94 
+_addr
+ 
+
+;
+
+95 
+6_addr
+ 
+6
+;
+
+96 
+va_li
+ 
+
+;
+
+98 
+
+.
+s_addr
+ = 0; 
+6
+.
+s6_addr
+[0] = 0;
+
+99 
+	`va_t
+(
+
+,
+af
+);
+
+100 
+af
+) {
+
+101 
+AF_INET
+:
+
+102 
+
+ = 
+	`va_g
+(
+
+,
+_addr
+);
+
+104 
+AF_INET6
+:
+
+105 
+6
+ = 
+	`va_g
+(
+
+,
+6_addr
+);
+
+108 
+	`nic
+("if_srt find_rt: impossibleddress family");
+
+111 
+	`va_d
+(
+
+);
+
+112 
+i
+=0; i < 
+sc
+->
+t
+; i++) {
+
+113 
+r
+ = 
+sc
+->
+s
+[
+i
+];
+
+114 i(
+r
+->
+af
+ !=f)
+
+116 
+af
+) {
+
+117 
+AF_INET
+:
+
+118 i((
+
+.
+s_addr
+ & 
+	`htl
+(
+v4_masks
+[
+r
+->
+cmask
+])) ==
+
+119 
+r
+->
+cmch
+.
+v4
+.
+s_addr
+)
+
+120  
+r
+;
+
+122 
+AF_INET6
+:
+
+123 i((
+r
+->
+cmask
+ >= 8) &&
+
+124 
+	`memcmp
+(&
+6
+,&
+r
+->
+cmch
+.
+v6
+,r->
+cmask
+ / 8) != 0)
+
+126 i((
+r
+->
+cmask
+ % 8) &&
+
+127 ((
+6
+.
+s6_addr
+[
+r
+->
+cmask
+ / 8] ^
+
+128 
+r
+->
+cmch
+.
+v6
+.
+s6_addr
+[r->
+cmask
+ / 8]) &
+
+129 0xf& (0xff00 >> (
+r
+->
+cmask
+ % 8))))
+
+131  
+r
+;
+
+133 
+	`nic
+("if_srt find_rt: impossibleddress family 2");
+
+138 
+	}
+}
+
+143 
+	$t_if_iol
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+145 
+iddr
+ *
+i
+;
+
+146 
+s
+;
+
+147 
+r
+;
+
+149 
+r
+ = 0;
+
+150 
+s
+ = 
+	`
+();
+
+151 
+cmd
+) {
+
+152 
+SIOCINITIFADDR
+:
+
+153 
+i
+ = (*
+da
+;
+
+154 
+i
+->
+i_addr
+->
+_my
+) {
+
+155 #ifde
+INET
+
+
+156 
+AF_INET
+:
+
+159 #ifde
+INET6
+
+
+160 
+AF_INET6
+:
+
+164 
+r
+ = 
+EAFNOSUPPORT
+;
+
+169 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)=
+ENETRESET
+)
+
+170 
+r
+ = 0;
+
+173 
+	`lx
+(
+s
+);
+
+174  
+r
+;
+
+175 
+	}
+}
+
+178 
+	$t_if_ouut
+(
+
+179 
+i
+ *
+i
+,
+
+180 
+mbuf
+ *
+m
+,
+
+181 c 
+sockaddr
+ *
+to
+,
+
+182 
+y
+ *
+p
+)
+
+184 
+t_soc
+ *
+sc
+;
+
+185 
+t_
+ *
+r
+;
+
+187 
+sc
+ = 
+i
+->
+if_soc
+;
+
+188 i(! (
+i
+->
+if_ags
+ & 
+IFF_UP
+)) {
+
+189 
+	`m_m
+(
+m
+);
+
+190  
+ENETDOWN
+;
+
+192 
+to
+->
+_my
+) {
+
+193 #ifde
+INET
+
+
+194 
+AF_INET
+: {
+
+195 
+
+ *ip;
+
+196 
+
+ = 
+	`mtod
+(
+m
+,ip *);
+
+197 
+r
+ = 
+	`fd_
+(
+sc
+,
+AF_INET
+,
+
+->
+_c
+);
+
+201 #ifde
+INET6
+
+
+202 
+AF_INET6
+: {
+
+203 
+6_hdr
+ *
+
+;
+
+204 
+
+ = 
+	`mtod
+(
+m
+,
+6_hdr
+ *);
+
+205 
+r
+ = 
+	`fd_
+(
+sc
+,
+AF_INET6
+,
+
+->
+6_c
+);
+
+210 
+	`IF_DROP
+(&
+i
+->
+if_d
+);
+
+211 
+	`m_m
+(
+m
+);
+
+212  
+EAFNOSUPPORT
+;
+
+216 
+i
+->
+if_acks
+ ++;
+
+217 i(! 
+r
+) {
+
+218 
+i
+->
+if_s
+ ++;
+
+219 
+	`m_m
+(
+m
+);
+
+222 i(! (
+m
+->
+m_ags
+ & 
+M_PKTHDR
+)) {
+
+223 
+	`tf
+("srt_if_outputo PKTHDR\n");
+
+224 
+	`m_m
+(
+m
+);
+
+227 
+i
+->
+if_obys
+ +
+m
+->
+m_pkthdr
+.
+n
+;
+
+228 i(! (
+r
+->
+u
+.
+di
+->
+if_ags
+ & 
+IFF_UP
+)) {
+
+229 
+	`m_m
+(
+m
+);
+
+233  (*
+r
+->
+u
+.
+di
+->
+if_ouut
+)->u.di,
+m
+,&r->
+d
+.
+
+,0);
+
+234 
+	}
+}
+
+237 
+	$t_e_
+(
+if_e
+ *
+
+, 
+un
+)
+
+239 
+t_soc
+ *
+sc
+;
+
+241 i(
+un
+ < 0 || un > 
+SRT_MAXUNIT
+)
+
+242  
+ENXIO
+;
+
+243 i(
+socv
+[
+un
+])
+
+244  
+EBUSY
+;
+
+245 
+sc
+ = 
+	`mloc
+((
+t_soc
+), 
+M_DEVBUF
+, 
+M_WAITOK
+|
+M_ZERO
+);
+
+246 
+sc
+->
+un
+ = unit;
+
+247 
+sc
+->
+t
+ = 0;
+
+248 
+sc
+->
+s
+ = 0;
+
+249 
+sc
+->
+ags
+ = 0;
+
+250 
+sc
+->
+kags
+ = 0;
+
+251 
+	`if_me
+(&
+sc
+->
+tf
+,
+
+->
+ifc_me
+,
+un
+);
+
+252 
+sc
+->
+tf
+.
+if_soc
+ = sc;
+
+253 
+sc
+->
+tf
+.
+if_mtu
+ = 65535;
+
+254 
+sc
+->
+tf
+.
+if_ags
+ = 
+IFF_POINTOPOINT
+;
+
+255 
+sc
+->
+tf
+.
+if_ty
+ = 
+IFT_OTHER
+;
+
+256 
+sc
+->
+tf
+.
+if_iol
+ = &
+t_if_iol
+;
+
+257 
+sc
+->
+tf
+.
+if_ouut
+ = &
+t_if_ouut
+;
+
+258 
+sc
+->
+tf
+.
+if_d
+ = 
+DLT_RAW
+;
+
+259 
+	`if_ch
+(&
+sc
+->
+tf
+);
+
+260 
+	`if_loc_dl
+(&
+sc
+->
+tf
+);
+
+261 #ifde
+BPFILTER_NOW_AVAILABLE
+
+
+262 
+	`bpf_ch
+(&
+sc
+->
+tf
+, 0, 0);
+
+264 
+socv
+[
+un
+] = 
+sc
+;
+
+266 
+	}
+}
+
+269 
+	$t_e_deroy
+(
+i
+ *
+i
+)
+
+271 
+t_soc
+ *
+sc
+;
+
+273 
+sc
+ = 
+i
+->
+if_soc
+;
+
+274 i((
+i
+->
+if_ags
+ & 
+IFF_UP
+|| (
+sc
+->
+kags
+ & 
+SKF_CDEVOPEN
+))
+
+275  
+EBUSY
+;
+
+276 #ifde
+BPFILTER_NOW_AVAILABLE
+
+
+277 
+	`bpf_dach
+(
+i
+);
+
+279 
+	`if_dach
+(
+i
+);
+
+280 i(
+sc
+->
+un
+ < 0 || sc->un > 
+SRT_MAXUNIT
+) {
+
+281 
+	`nic
+("t_e_deroy: impossib un %d\n",
+sc
+->
+un
+);
+
+283 i(
+socv
+[
+sc
+->
+un
+] != sc) {
+
+284 
+	`nic
+("srt_clone_destroy: bad backpointer ([%d]=%pot %p)\n",
+
+285 
+sc
+->
+un
+,(*)
+socv
+[sc->unit],(*)sc);
+
+287 
+socv
+[
+sc
+->
+un
+] = 0;
+
+288 
+	`
+(
+sc
+,
+M_DEVBUF
+);
+
+290 
+	}
+}
+
+292 
+if_e
+ 
+	gt_e
+ =
+
+293 
+IF_CLONE_INITIALIZER
+("t",&
+t_e_
+,&
+t_e_deroy
+);
+
+296 
+	$ach
+()
+
+298 
+i
+;
+
+300 
+i
+=
+SRT_MAXUNIT
+;i>=0;i--)
+
+301 
+socv
+[
+i
+] = 0;
+
+302 
+glob_ags
+ = 0;
+
+303 
+	`if_e_ch
+(&
+t_e
+);
+
+304 
+	}
+}
+
+309 
+	$t_
+(
+dev_t
+ 
+dev
+, 
+ag
+, 
+mode
+, 
+lwp
+ *
+l
+)
+
+311 
+un
+;
+
+312 
+t_soc
+ *
+sc
+;
+
+314 
+un
+ = 
+	`m
+(
+dev
+);
+
+315 i(
+un
+ < 0 || un > 
+SRT_MAXUNIT
+)
+
+316  
+ENXIO
+;
+
+317 
+sc
+ = 
+socv
+[
+un
+];
+
+318 i(! 
+sc
+)
+
+319  
+ENXIO
+;
+
+320 
+sc
+->
+kags
+ |
+SKF_CDEVOPEN
+;
+
+322 
+	}
+}
+
+325 
+	$t_o
+(
+dev_t
+ 
+dev
+, 
+ag
+, 
+mode
+, 
+lwp
+ *
+l
+)
+
+327 
+un
+;
+
+328 
+t_soc
+ *
+sc
+;
+
+330 
+un
+ = 
+	`m
+(
+dev
+);
+
+331 i(
+un
+ < 0 || un > 
+SRT_MAXUNIT
+)
+
+332  
+ENXIO
+;
+
+333 
+sc
+ = 
+socv
+[
+un
+];
+
+334 i(! 
+sc
+)
+
+335  
+ENXIO
+;
+
+336 
+sc
+->
+kags
+ &~
+SKF_CDEVOPEN
+;
+
+338 
+	}
+}
+
+341 
+	$t_iol
+(
+dev_t
+ 
+dev
+, 
+u_lg
+ 
+cmd
+, *
+da
+, 
+ag
+, 
+lwp
+ *
+l
+)
+
+343 
+f
+, 
+i
+, 
+n
+, 
+o
+;
+
+344 
+t_soc
+ *
+sc
+;
+
+345 
+t_
+ *
+dr
+;
+
+346 
+t_
+ *
+s
+;
+
+347 
+i
+ *
+i
+;
+
+348 
+nbuf
+[
+IFNAMSIZ
+];
+
+350 
+sc
+ = 
+socv
+[
+	`m
+(
+dev
+)];
+
+351 i(! 
+sc
+)
+
+352 
+	`nic
+("srt_ioctl: softc disappeared");
+
+353 
+cmd
+) {
+
+354 
+SRT_GETNRT
+:
+
+355 i(! (
+ag
+ & 
+FREAD
+))
+
+356  
+EBADF
+;
+
+357 *(*)
+da
+ = 
+sc
+->
+t
+;
+
+359 
+SRT_GETRT
+:
+
+360 i(! (
+ag
+ & 
+FREAD
+))
+
+361  
+EBADF
+;
+
+362 
+dr
+ = (
+t_
+ *
+da
+;
+
+363 i(
+dr
+->
+x
+ >
+sc
+->
+t
+)
+
+364  
+EDOM
+;
+
+365 
+s
+ = 
+sc
+->
+s
+[
+dr
+->
+x
+];
+
+366 
+dr
+->
+af
+ = 
+s
+->af;
+
+367 
+dr
+->
+cmch
+ = 
+s
+->srcmatch;
+
+368 
+dr
+->
+cmask
+ = 
+s
+->srcmask;
+
+369 
+	`y
+(&
+dr
+->
+u
+.
+di
+[0],&
+s
+->u.
+di
+->
+if_xme
+[0],
+IFNAMSIZ
+);
+
+370 
+	`memy
+(&
+dr
+->
+d
+,&
+s
+->d,s->d.
+
+.
+_n
+);
+
+372 
+SRT_SETRT
+:
+
+373 i(! (
+ag
+ & 
+FWRITE
+))
+
+374  
+EBADF
+;
+
+375 
+dr
+ = (
+t_
+ *
+da
+;
+
+376 i(
+dr
+->
+x
+ > 
+sc
+->
+t
+)
+
+377  
+EDOM
+;
+
+378 
+	`y
+(&
+nbuf
+[0],&
+dr
+->
+u
+.
+di
+[0],
+IFNAMSIZ
+);
+
+379 
+nbuf
+[
+IFNAMSIZ
+-1] = '\0';
+
+380 i(
+dr
+->
+d
+.
+
+.
+_my
+ !dr->
+af
+)
+
+381  
+EIO
+;
+
+382 
+dr
+->
+af
+) {
+
+383 #ifde
+INET
+
+
+384 
+AF_INET
+:
+
+385 i(
+dr
+->
+d
+.
+
+.
+_n
+ !(dr->d.
+s
+))
+
+386  
+EIO
+;
+
+387 i(
+dr
+->
+cmask
+ > 32)
+
+388  
+EIO
+;
+
+391 #ifde
+INET6
+
+
+392 
+AF_INET6
+:
+
+393 i(
+dr
+->
+d
+.
+
+.
+_n
+ !(dr->d.
+s6
+))
+
+394  
+EIO
+;
+
+395 i(
+dr
+->
+cmask
+ > 128)
+
+396  
+EIO
+;
+
+400  
+EAFNOSUPPORT
+;
+
+402 
+i
+ = 
+	`ifun
+(&
+nbuf
+[0]);
+
+403 i(
+i
+ == 0)
+
+404  
+ENXIO
+;
+
+405 i(
+dr
+->
+x
+ =
+sc
+->
+t
+) {
+
+406 
+t_
+ **
+tmp
+;
+
+407 
+tmp
+ = 
+	`mloc
+((
+sc
+->
+t
++1)*(*tmp), 
+M_DEVBUF
+,
+
+408 
+M_WAITOK
+);
+
+409 i(
+tmp
+ == 0)
+
+410  
+ENOBUFS
+;
+
+411 
+tmp
+[
+sc
+->
+t
+] = 0;
+
+412 i(
+sc
+->
+t
+ > 0) {
+
+413 
+	`memy
+(
+tmp
+, 
+sc
+->
+s
+, sc->
+t
+*(*tmp));
+
+414 
+	`
+(
+sc
+->
+s
+, 
+M_DEVBUF
+);
+
+416 
+sc
+->
+s
+ = 
+tmp
+;
+
+417 
+sc
+->
+t
+ ++;
+
+419 
+s
+ = 
+sc
+->
+s
+[
+dr
+->
+x
+];
+
+420 i(
+s
+ == 0) {
+
+421 
+s
+ = 
+	`mloc
+((
+t_
+),
+M_DEVBUF
+,
+M_WAITOK
+);
+
+422 i(
+s
+ == 0)
+
+423  
+ENOBUFS
+;
+
+424 
+s
+->
+x
+ = 
+dr
+->inx;
+
+425 
+s
+->
+af
+ = 
+AF_UNSPEC
+;
+
+426 
+sc
+->
+s
+[
+dr
+->
+x
+] = 
+s
+;
+
+428 
+s
+->
+af
+ = 
+dr
+->af;
+
+429 
+s
+->
+cmch
+ = 
+dr
+->srcmatch;
+
+430 
+s
+->
+cmask
+ = 
+dr
+->srcmask;
+
+431 
+s
+->
+u
+.
+di
+ = 
+i
+;
+
+432 
+	`memy
+(&
+s
+->
+d
+,&
+dr
+->d,dr->d.
+
+.
+_n
+);
+
+433 
+	`upde_mtu
+(
+sc
+);
+
+435 
+SRT_DELRT
+:
+
+436 i(! (
+ag
+ & 
+FWRITE
+))
+
+437  
+EBADF
+;
+
+438 
+i
+ = *(*)
+da
+;
+
+439 i(
+i
+ >
+sc
+->
+t
+)
+
+440  
+EDOM
+;
+
+441 
+s
+ = 
+sc
+->
+s
+[
+i
+];
+
+442 
+sc
+->
+s
+[
+i
+] = 0;
+
+443 
+	`
+(
+s
+, 
+M_DEVBUF
+);
+
+444 
+sc
+->
+t
+--;
+
+445 i(
+i
+ < 
+sc
+->
+t
+) {
+
+446 
+	`memy
+(
+sc
+->
+s
++
+i
+, sc->rts+i+1,
+
+447 (
+sc
+->
+t
+-
+i
+)*(*sc->
+s
+));
+
+449 i(
+sc
+->
+t
+ == 0) {
+
+450 
+	`
+(
+sc
+->
+s
+, 
+M_DEVBUF
+);
+
+451 
+sc
+->
+s
+ = 0;
+
+452 
+sc
+->
+tf
+.
+if_ags
+ &~
+IFF_UP
+;
+
+454 
+	`upde_mtu
+(
+sc
+);
+
+456 
+SRT_SFLAGS
+:
+
+457 i(! (
+ag
+ & 
+FWRITE
+))
+
+458  
+EBADF
+;
+
+459 
+f
+ = *(*)
+da
+ & 
+SSF_UCHG
+;
+
+460 
+glob_ags
+ = (glob_ag& ~
+SSF_UCHG
+| (
+f
+ & 
+SSF_GLOBAL
+);
+
+461 
+sc
+->
+ags
+ = (sc->ag& ~
+SSF_UCHG
+| (
+f
+ & ~
+SSF_GLOBAL
+);
+
+463 
+SRT_GFLAGS
+:
+
+464 i(! (
+ag
+ & 
+FREAD
+))
+
+465  
+EBADF
+;
+
+466 *(*)
+da
+ = 
+sc
+->
+ags
+ | 
+glob_ags
+;
+
+468 
+SRT_SGFLAGS
+:
+
+469 i((
+ag
+ & (
+FWRITE
+|
+FREAD
+)) != (FWRITE|FREAD))
+
+470  
+EBADF
+;
+
+471 
+o
+ = 
+sc
+->
+ags
+ | 
+glob_ags
+;
+
+472 
+n
+ = *(*)
+da
+ & 
+SSF_UCHG
+;
+
+473 
+glob_ags
+ = (glob_ag& ~
+SSF_UCHG
+| (
+n
+ & 
+SSF_GLOBAL
+);
+
+474 
+sc
+->
+ags
+ = (sc->ag& ~
+SSF_UCHG
+| (
+n
+ & ~
+SSF_GLOBAL
+);
+
+475 *(*)
+da
+ = 
+o
+;
+
+477 
+SRT_DEBUG
+:
+
+481  
+ENOTTY
+;
+
+482 
+	}
+}
+
+484 c 
+cdevsw
+ 
+	gt_cdevsw
+ = {
+
+485 .
+d_
+ = 
+t_
+,
+
+486 .
+	gd_o
+ = 
+t_o
+,
+
+487 .
+	gd_ad
+ = 
+nuad
+,
+
+488 .
+	gd_wre
+ = 
+nuwre
+,
+
+489 .
+	gd_iol
+ = 
+t_iol
+,
+
+490 .
+	gd_
+ = 
+nu
+,
+
+491 .
+	gd_y
+ = 
+nty
+,
+
+492 .
+	gd_pl
+ = 
+nupl
+,
+
+493 .
+	gd_mm
+ = 
+nomm
+,
+
+494 .
+	gd_kqfr
+ = 
+nukqfr
+,
+
+495 .
+	gd_disrd
+ = 
+nodisrd
+,
+
+496 .
+	gd_ag
+ = 
+D_OTHER
+
+
+	@if_srt.h
+
+1 #ide
+_IF_SRT_H_1b91f8f1_
+
+
+2 
+	#_IF_SRT_H_1b91f8f1_
+
+
+	)
+
+8 
+	~<t/if.h
+>
+
+9 
+	~<t/.h
+>
+
+11 
+	st_
+ {
+
+12 
+	mx
+;
+
+13 
+	maf
+;
+
+15 
+_addr
+ 
+	mv4
+;
+
+16 
+6_addr
+ 
+	mv6
+;
+
+17 } 
+	mcmch
+;
+
+18 
+	mcmask
+;
+
+20 
+i
+ *
+	mdi
+;
+
+21 
+	mdi
+[
+IFNAMSIZ
+];
+
+22 } 
+	mu
+;
+
+24 
+sockaddr_
+ 
+	ms
+;
+
+25 
+sockaddr_6
+ 
+	ms6
+;
+
+26 
+sockaddr
+ 
+	m
+;
+
+27 } 
+	md
+;
+
+31 
+	#SRT_GETNRT
+ 
+	`_IOR
+('e',0,)
+
+	)
+
+34 
+	#SRT_GETRT
+ 
+	`_IOWR
+('e',1,
+t_
+)
+
+	)
+
+37 
+	#SRT_SETRT
+ 
+	`_IOW
+('e',2,
+t_
+)
+
+	)
+
+40 
+	#SRT_DELRT
+ 
+	`_IOW
+('e',3,)
+
+	)
+
+43 
+	#SRT_SFLAGS
+ 
+	`_IOW
+('e',4,)
+
+	)
+
+46 
+	#SRT_GFLAGS
+ 
+	`_IOR
+('e',5,)
+
+	)
+
+49 
+	#SRT_SGFLAGS
+ 
+	`_IOWR
+('e',6,)
+
+	)
+
+52 
+	#SRT_DEBUG
+ 
+	`_IOW
+('e',7,*)
+
+	)
+
+55 
+	#SSF_MTULOCK
+ 0x00000001
+
+	)
+
+57 
+	#SSF_GLOBAL
+ (0)
+
+	)
+
+	@if_stf.c
+
+77 
+	~<sys/cdefs.h
+>
+
+78 
+__KERNEL_RCSID
+(0, "$NetBSD: if_stf.c,v 1.80 2014/06/12 16:43:09 christos Exp $");
+
+80 
+	~"t_.h
+"
+
+81 #ide
+INET6
+
+
+85 
+	~<sys/m.h
+>
+
+86 
+	~<sys/sym.h
+>
+
+87 
+	~<sys/sock.h
+>
+
+88 
+	~<sys/sockio.h
+>
+
+89 
+	~<sys/mbuf.h
+>
+
+90 
+	~<sys/o.h
+>
+
+91 
+	~<sys/iol.h
+>
+
+92 
+	~<sys/oc.h
+>
+
+93 
+	~<sys/osw.h
+>
+
+94 
+	~<sys/queue.h
+>
+
+95 
+	~<sys/syog.h
+>
+
+97 
+	~<sys/u.h
+>
+
+99 
+	~<t/if.h
+>
+
+100 
+	~<t/rou.h
+>
+
+101 
+	~<t/ti.h
+>
+
+102 
+	~<t/if_tys.h
+>
+
+103 
+	~<t/if_f.h
+>
+
+105 
+	~<t/.h
+>
+
+106 
+	~<t/_sym.h
+>
+
+107 
+	~<t/.h
+>
+
+108 
+	~<t/_v.h
+>
+
+109 
+	~<t/_v.h
+>
+
+111 
+	~<t/6.h
+>
+
+112 
+	~<t6/6_v.h
+>
+
+113 
+	~<t6/6_gif.h
+>
+
+114 
+	~<t6/6_v.h
+>
+
+115 
+	~<t/_e.h
+>
+
+117 
+	~<t/_p.h
+>
+
+119 
+	~<t/t_osd.h
+>
+
+121 
+	~"f.h
+"
+
+122 
+	~"gif.h
+"
+
+124 
+	~<t/bpf.h
+>
+
+126 #i
+NGIF
+ > 0
+
+127 
+	~<t/if_gif.h
+>
+
+130 
+	#IN6_IS_ADDR_6TO4
+(
+x
+(
+	`ohs
+((x)->
+s6_addr16
+[0]=0x2002)
+
+	)
+
+131 
+	#GET_V4
+(
+x
+((c 
+_addr
+ *)(&(x)->
+s6_addr16
+[1]))
+
+	)
+
+133 
+	sf_soc
+ {
+
+134 
+i
+ 
+	msc_if
+;
+
+135 
+rou
+ 
+	msc_ro
+;
+
+136 c 
+ab
+ *
+	mp_cook
+;
+
+137 
+LIST_ENTRY
+(
+f_soc
+
+	msc_li
+;
+
+140 
+	$LIST_HEAD
+(, 
+f_soc
+
+f_soc_li
+;
+
+142 
+	`f_e_
+(
+if_e
+ *, );
+
+143 
+	`f_e_deroy
+(
+i
+ *);
+
+145 
+if_e
+ 
+f_
+ =
+
+146 
+	`IF_CLONE_INITIALIZER
+("f", 
+f_e_
+, 
+f_e_deroy
+);
+
+148 #i
+NGIF
+ > 0
+
+149 
+_gif_l
+;
+
+151 
+_gif_l
+ = 40;
+
+154 
+doma
+ 
+doma
+;
+
+156 c 
+osw
+ 
+_f_osw
+ =
+
+158 .
+_ty
+ = 
+SOCK_RAW
+,
+
+159 .
+_doma
+ = &
+doma
+,
+
+160 .
+_oc
+ = 
+IPPROTO_IPV6
+,
+
+161 .
+_ags
+ = 
+PR_ATOMIC
+|
+PR_ADDR
+,
+
+162 .
+_put
+ = 
+_f_put
+,
+
+163 .
+_ouut
+ = 
+r_ouut
+,
+
+164 .
+_lput
+ = 
+NULL
+,
+
+165 .
+_louut
+ = 
+r_louut
+,
+
+166 .
+_uqs
+ = &
+r_uqs
+,
+
+167 
+	}
+};
+
+169 
+ach
+();
+
+171 
+f_pcheck
+(
+mbuf
+ *, , , *);
+
+172 
+6_iddr
+ *
+f_gci6
+(
+i
+ *);
+
+173 
+f_ouut
+(
+i
+ *, 
+mbuf
+ *, c 
+sockaddr
+ *,
+
+174 
+y
+ *);
+
+175 
+ifc1918addr
+(c 
+_addr
+ *);
+
+176 
+f_checkaddr4
+(
+f_soc
+ *, c 
+_addr
+ *,
+
+177 
+i
+ *);
+
+178 
+f_checkaddr6
+(
+f_soc
+ *, c 
+6_addr
+ *,
+
+179 
+i
+ *);
+
+180 
+f_que
+(, 
+y
+ *, c 
+_addrfo
+ *);
+
+181 
+f_iol
+(
+i
+ *, 
+u_lg
+, *);
+
+185 
+	$ach
+(
+cou
+)
+
+188 
+	`LIST_INIT
+(&
+f_soc_li
+);
+
+189 
+	`if_e_ch
+(&
+f_
+);
+
+190 
+	}
+}
+
+193 
+	$f_e_
+(
+if_e
+ *
+ifc
+, 
+un
+)
+
+195 
+f_soc
+ *
+sc
+;
+
+197 i(
+	`LIST_FIRST
+(&
+f_soc_li
+!
+NULL
+) {
+
+199  (
+EEXIST
+);
+
+202 
+sc
+ = 
+	`mloc
+((
+f_soc
+), 
+M_DEVBUF
+, 
+M_WAIT
+|
+M_ZERO
+);
+
+204 
+	`if_me
+(&
+sc
+->
+sc_if
+, 
+ifc
+->
+ifc_me
+, 
+un
+);
+
+206 
+sc
+->
+p_cook
+ = 
+	`p_ch_func
+(
+AF_INET
+, 
+IPPROTO_IPV6
+,
+
+207 
+f_pcheck
+, &
+_f_osw
+, 
+sc
+);
+
+208 i(
+sc
+->
+p_cook
+ =
+NULL
+) {
+
+209 
+	`tf
+("%s: ubchnp\n", 
+	`if_me
+(&
+sc
+->
+sc_if
+));
+
+210 
+	`
+(
+sc
+, 
+M_DEVBUF
+);
+
+211  (
+EIO
+);
+
+214 
+sc
+->
+sc_if
+.
+if_mtu
+ = 
+STF_MTU
+;
+
+215 
+sc
+->
+sc_if
+.
+if_ags
+ = 0;
+
+216 
+sc
+->
+sc_if
+.
+if_iol
+ = 
+f_iol
+;
+
+217 
+sc
+->
+sc_if
+.
+if_ouut
+ = 
+f_ouut
+;
+
+218 
+sc
+->
+sc_if
+.
+if_ty
+ = 
+IFT_STF
+;
+
+219 
+sc
+->
+sc_if
+.
+if_d
+ = 
+DLT_NULL
+;
+
+220 
+	`if_ch
+(&
+sc
+->
+sc_if
+);
+
+221 
+	`if_loc_dl
+(&
+sc
+->
+sc_if
+);
+
+222 
+	`bpf_ch
+(&
+sc
+->
+sc_if
+, 
+DLT_NULL
+, (
+u_t
+));
+
+223 
+	`LIST_INSERT_HEAD
+(&
+f_soc_li
+, 
+sc
+, 
+sc_li
+);
+
+225 
+	}
+}
+
+228 
+	$f_e_deroy
+(
+i
+ *
+i
+)
+
+230 
+f_soc
+ *
+sc
+ = (*
+i
+;
+
+232 
+	`LIST_REMOVE
+(
+sc
+, 
+sc_li
+);
+
+233 
+	`p_dach
+(
+sc
+->
+p_cook
+);
+
+234 
+	`bpf_dach
+(
+i
+);
+
+235 
+	`if_dach
+(
+i
+);
+
+236 
+	`che_
+(&
+sc
+->
+sc_ro
+);
+
+237 
+	`
+(
+sc
+, 
+M_DEVBUF
+);
+
+240 
+	}
+}
+
+243 
+	$f_pcheck
+(
+mbuf
+ *
+m
+, 
+off
+, 
+o
+, *
+g
+)
+
+245 
+
+ ip;
+
+246 
+6_iddr
+ *
+6
+;
+
+247 
+f_soc
+ *
+sc
+;
+
+248 
+_addr
+ 
+a
+, 
+b
+;
+
+250 
+sc
+ = (
+f_soc
+ *)
+g
+;
+
+251 i(
+sc
+ =
+NULL
+)
+
+254 i((
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_UP
+) == 0)
+
+258 i((
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_LINK0
+) != 0)
+
+261 i(
+o
+ !
+IPPROTO_IPV6
+)
+
+264 
+	`m_cyda
+(
+m
+, 0, (
+
+), (*)&ip);
+
+266 i(
+
+.
+_v
+ != 4)
+
+269 
+6
+ = 
+	`f_gci6
+(&
+sc
+->
+sc_if
+);
+
+270 i(
+6
+ =
+NULL
+)
+
+278 i(
+	`memcmp
+(
+	`GET_V4
+(&
+6
+->
+_addr
+.
+s6_addr
+), &
+
+.
+_d
+,
+
+279 (
+
+.
+_d
+)) != 0)
+
+288 
+	`memt
+(&
+a
+, 0, (a));
+
+289 
+a
+.
+s_addr
+ = 
+	`GET_V4
+(&
+6
+->
+_addr
+.
+s6_addr
+)->s_addr;
+
+290 
+a
+.
+s_addr
+ &
+	`GET_V4
+(&
+6
+->
+_efixmask
+.
+s6_addr
+)->s_addr;
+
+291 
+b
+ = 
+
+.
+_c
+;
+
+292 
+b
+.
+s_addr
+ &
+	`GET_V4
+(&
+6
+->
+_efixmask
+.
+s6_addr
+)->s_addr;
+
+293 i(
+a
+.
+s_addr
+ !
+b
+.s_addr)
+
+298 
+	}
+}
+
+300 
+6_iddr
+ *
+
+301 
+	$f_gci6
+(
+i
+ *
+i
+)
+
+303 
+iddr
+ *
+i
+;
+
+304 
+_iddr
+ *
+4
+;
+
+305 
+sockaddr_6
+ *
+s6
+;
+
+306 
+_addr
+ 
+
+;
+
+308 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+)
+
+310 i(
+i
+->
+i_addr
+ =
+NULL
+)
+
+312 i(
+i
+->
+i_addr
+->
+_my
+ !
+AF_INET6
+)
+
+314 
+s6
+ = (
+sockaddr_6
+ *)
+i
+->
+i_addr
+;
+
+315 i(!
+	`IN6_IS_ADDR_6TO4
+(&
+s6
+->
+s6_addr
+))
+
+318 
+	`memy
+(&
+
+, 
+	`GET_V4
+(&
+s6
+->
+s6_addr
+), (in));
+
+319 
+	`INADDR_TO_IA
+(
+
+, 
+4
+);
+
+320 i(
+4
+ =
+NULL
+)
+
+323  (
+6_iddr
+ *)
+i
+;
+
+326  
+NULL
+;
+
+327 
+	}
+}
+
+330 
+	$f_ouut
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+, c 
+sockaddr
+ *
+d
+,
+
+331 
+y
+ *
+0
+)
+
+333 
+y
+ *
+
+;
+
+334 
+f_soc
+ *
+sc
+;
+
+335 c 
+sockaddr_6
+ *
+d6
+;
+
+336 c 
+_addr
+ *
+4
+;
+
+337 
+ut8_t
+ 
+tos
+;
+
+338 
+
+ *ip;
+
+339 
+6_hdr
+ *
+6
+;
+
+340 
+6_iddr
+ *
+6
+;
+
+342 
+sockaddr
+ 
+d
+;
+
+343 
+sockaddr_
+ 
+d4
+;
+
+344 } 
+u
+;
+
+346 
+sc
+ = (
+f_soc
+*)
+i
+;
+
+347 
+d6
+ = (c 
+sockaddr_6
+ *)
+d
+;
+
+350 i((
+i
+->
+if_ags
+ & 
+IFF_UP
+) == 0) {
+
+351 
+	`m_m
+(
+m
+);
+
+352  
+ENETDOWN
+;
+
+360 
+6
+ = 
+	`f_gci6
+(
+i
+);
+
+361 i(
+6
+ =
+NULL
+) {
+
+362 
+	`m_m
+(
+m
+);
+
+363 
+i
+->
+if_s
+++;
+
+364  
+ENETDOWN
+;
+
+367 i(
+m
+->
+m_n
+ < (*
+6
+)) {
+
+368 
+m
+ = 
+	`m_puup
+(m, (*
+6
+));
+
+369 i(
+m
+ =
+NULL
+) {
+
+370 
+i
+->
+if_s
+++;
+
+371  
+ENOBUFS
+;
+
+374 
+6
+ = 
+	`mtod
+(
+m
+, 
+6_hdr
+ *);
+
+375 
+tos
+ = (
+	`ohl
+(
+6
+->
+6_ow
+) >> 20) & 0xff;
+
+381 i(
+	`IN6_IS_ADDR_6TO4
+(&
+6
+->
+6_d
+))
+
+382 
+4
+ = 
+	`GET_V4
+(&
+6
+->
+6_d
+);
+
+383 i(
+	`IN6_IS_ADDR_6TO4
+(&
+d6
+->
+s6_addr
+))
+
+384 
+4
+ = 
+	`GET_V4
+(&
+d6
+->
+s6_addr
+);
+
+386 
+	`m_m
+(
+m
+);
+
+387 
+i
+->
+if_s
+++;
+
+388  
+ENETUNREACH
+;
+
+391 
+	`bpf_mp_af
+(
+i
+, 
+AF_INET6
+, 
+m
+);
+
+393 
+	`M_PREPEND
+(
+m
+, (
+
+), 
+M_DONTWAIT
+);
+
+394 i(
+m
+ && m->
+m_n
+ < (
+
+))
+
+395 
+m
+ = 
+	`m_puup
+(m, (
+
+));
+
+396 i(
+m
+ =
+NULL
+) {
+
+397 
+i
+->
+if_s
+++;
+
+398  
+ENOBUFS
+;
+
+400 
+
+ = 
+	`mtod
+(
+m
+, ip *);
+
+402 
+	`memt
+(
+
+, 0, (*ip));
+
+404 
+	`bcy
+(
+	`GET_V4
+(&((
+sockaddr_6
+ *)&
+6
+->
+_addr
+)->
+s6_addr
+),
+
+405 &
+
+->
+_c
+, (ip->ip_src));
+
+406 
+	`memy
+(&
+
+->
+_d
+, 
+4
+, (ip->ip_dst));
+
+407 
+
+->
+_p
+ = 
+IPPROTO_IPV6
+;
+
+408 
+
+->
+_l
+ = 
+_gif_l
+;
+
+409 
+
+->
+_n
+ = 
+	`hts
+(
+m
+->
+m_pkthdr
+.
+n
+);
+
+410 i(
+i
+->
+if_ags
+ & 
+IFF_LINK1
+)
+
+411 
+	`_e_gss
+(
+ECN_ALLOWED
+, &
+
+->
+_tos
+, &
+tos
+);
+
+413 
+	`_e_gss
+(
+ECN_NOCARE
+, &
+
+->
+_tos
+, &
+tos
+);
+
+415 
+	`sockaddr__
+(&
+u
+.
+d4
+, &
+
+->
+_d
+, 0);
+
+416 i((
+
+ = 
+	`che_lookup
+(&
+sc
+->
+sc_ro
+, &
+u
+.
+d
+)=
+NULL
+) {
+
+417 
+	`m_m
+(
+m
+);
+
+418 
+i
+->
+if_s
+++;
+
+419  
+ENETUNREACH
+;
+
+423 i(
+
+->
+_i
+ =
+i
+) {
+
+424 
+	`che_
+(&
+sc
+->
+sc_ro
+);
+
+425 
+	`m_m
+(
+m
+);
+
+426 
+i
+->
+if_s
+++;
+
+427  
+ENETUNREACH
+;
+
+430 
+i
+->
+if_acks
+++;
+
+431 
+i
+->
+if_obys
+ +
+m
+->
+m_pkthdr
+.
+n
+ - (
+
+);
+
+432  
+	`_ouut
+(
+m
+, 
+NULL
+, &
+sc
+->
+sc_ro
+, 0, NULL, NULL);
+
+433 
+	}
+}
+
+436 
+	$ifc1918addr
+(c 
+_addr
+ *
+
+)
+
+442 i((
+	`ohl
+(
+
+->
+s_addr
+) & 0xff000000) >> 24 == 10 ||
+
+443 (
+	`ohl
+(
+
+->
+s_addr
+) & 0xfff00000) >> 16 == 172 * 256 + 16 ||
+
+444 (
+	`ohl
+(
+
+->
+s_addr
+) & 0xffff0000) >> 16 == 192 * 256 + 168)
+
+448 
+	}
+}
+
+451 
+	$f_checkaddr4
+(
+f_soc
+ *
+sc
+, c 
+_addr
+ *
+
+,
+
+452 
+i
+ *
+i
+ )
+
+454 
+_iddr
+ *
+4
+;
+
+460 i(
+	`IN_MULTICAST
+(
+
+->
+s_addr
+))
+
+462 (
+	`ohl
+(
+
+->
+s_addr
+) & 0xff000000) >> 24) {
+
+471 i(
+	`ifc1918addr
+(
+
+))
+
+478 i(((
+	`ohl
+(
+
+->
+s_addr
+) & 0xff000000) >> 24) == 169 &&
+
+479 ((
+	`ohl
+(
+
+->
+s_addr
+) & 0x00ff0000) >> 16) == 254)
+
+485 
+	`TAILQ_FOREACH
+(
+4
+, &
+_iddrhd
+, 
+_li
+)
+
+487 i((
+4
+->
+_i
+.
+i_i
+->
+if_ags
+ & 
+IFF_BROADCAST
+) == 0)
+
+489 i(
+
+->
+s_addr
+ =
+4
+->
+_brdaddr
+.
+s_addr
+.s_addr)
+
+496 i(
+sc
+ && (sc->
+sc_if
+.
+if_ags
+ & 
+IFF_LINK2
+=0 && 
+i
+) {
+
+497 
+sockaddr_
+ 
+s
+;
+
+498 
+y
+ *
+
+;
+
+500 
+	`memt
+(&
+s
+, 0, (sin));
+
+501 
+s
+.
+s_my
+ = 
+AF_INET
+;
+
+502 
+s
+.
+s_n
+ = (
+sockaddr_
+);
+
+503 
+s
+.
+s_addr
+ = *
+
+;
+
+504 
+
+ = 
+	`loc1
+((
+sockaddr
+ *)&
+s
+, 0);
+
+505 i(!
+
+ ||t->
+_i
+ !
+i
+) {
+
+507 
+	`log
+(
+LOG_WARNING
+, "%s:acket from 0x%x dropped "
+
+508 "dutgsfr\n", 
+	`if_me
+(&
+sc
+->
+sc_if
+),
+
+509 (
+ut32_t
+)
+	`ohl
+(
+s
+.
+s_addr
+.
+s_addr
+));
+
+511 i(
+
+)
+
+512 
+	`
+(
+
+);
+
+515 
+	`
+(
+
+);
+
+519 
+	}
+}
+
+522 
+	$f_checkaddr6
+(
+f_soc
+ *
+sc
+, c 
+6_addr
+ *
+6
+,
+
+523 
+i
+ *
+i
+ )
+
+529 i(
+	`IN6_IS_ADDR_6TO4
+(
+6
+))
+
+530  
+	`f_checkaddr4
+(
+sc
+, 
+	`GET_V4
+(
+6
+), 
+i
+);
+
+538 i(
+	`IN6_IS_ADDR_V4COMPAT
+(
+6
+|| 
+	`IN6_IS_ADDR_V4MAPPED
+(in6))
+
+545 i(
+	`IN6_IS_ADDR_LINKLOCAL
+(
+6
+|| 
+	`IN6_IS_ADDR_SITELOCAL
+(in6))
+
+552 i(
+	`IN6_IS_ADDR_MC_NODELOCAL
+(
+6
+|| 
+	`IN6_IS_ADDR_MC_LINKLOCAL
+(in6))
+
+556 
+	}
+}
+
+559 
+	$_f_put
+(
+mbuf
+ *
+m
+, ...)
+
+561 
+s
+, 
+off
+, 
+o
+;
+
+562 
+f_soc
+ *
+sc
+;
+
+563 
+
+ *ip;
+
+564 
+6_hdr
+ *
+6
+;
+
+565 
+ut8_t
+ 
+os
+, 
+os
+;
+
+566 
+i
+ *
+i
+;
+
+567 
+size_t
+ 
+pk
+;
+
+568 
+va_li
+ 
+
+;
+
+570 
+	`va_t
+(
+
+, 
+m
+);
+
+571 
+off
+ = 
+	`va_g
+(
+
+, );
+
+572 
+o
+ = 
+	`va_g
+(
+
+, );
+
+573 
+	`va_d
+(
+
+);
+
+575 i(
+o
+ !
+IPPROTO_IPV6
+) {
+
+576 
+	`m_m
+(
+m
+);
+
+580 
+
+ = 
+	`mtod
+(
+m
+, ip *);
+
+582 
+sc
+ = (
+f_soc
+ *)
+	`p_gg
+(
+m
+);
+
+584 i(
+sc
+ =
+NULL
+ || (sc->
+sc_if
+.
+if_ags
+ & 
+IFF_UP
+) == 0) {
+
+585 
+	`m_m
+(
+m
+);
+
+589 
+i
+ = &
+sc
+->
+sc_if
+;
+
+595 i(
+	`f_checkaddr4
+(
+sc
+, &
+
+->
+_d
+, 
+NULL
+) < 0 ||
+
+596 
+	`f_checkaddr4
+(
+sc
+, &
+
+->
+_c
+, 
+m
+->
+m_pkthdr
+.
+rcvif
+) < 0) {
+
+597 
+	`m_m
+(
+m
+);
+
+601 
+os
+ = 
+
+->
+_tos
+;
+
+602 
+	`m_adj
+(
+m
+, 
+off
+);
+
+604 i(
+m
+->
+m_n
+ < (*
+6
+)) {
+
+605 
+m
+ = 
+	`m_puup
+(m, (*
+6
+));
+
+606 i(!
+m
+)
+
+609 
+6
+ = 
+	`mtod
+(
+m
+, 
+6_hdr
+ *);
+
+615 i(
+	`f_checkaddr6
+(
+sc
+, &
+6
+->
+6_d
+, 
+NULL
+) < 0 ||
+
+616 
+	`f_checkaddr6
+(
+sc
+, &
+6
+->
+6_c
+, 
+m
+->
+m_pkthdr
+.
+rcvif
+) < 0) {
+
+617 
+	`m_m
+(
+m
+);
+
+621 
+os
+ = (
+	`ohl
+(
+6
+->
+6_ow
+) >> 20) & 0xff;
+
+622 i((
+i
+->
+if_ags
+ & 
+IFF_LINK1
+) != 0)
+
+623 
+	`_e_egss
+(
+ECN_ALLOWED
+, &
+os
+, &
+os
+);
+
+625 
+	`_e_egss
+(
+ECN_NOCARE
+, &
+os
+, &
+os
+);
+
+626 
+6
+->
+6_ow
+ &~
+	`htl
+(0xff << 20);
+
+627 
+6
+->
+6_ow
+ |
+	`htl
+((
+ut32_t
+)
+os
+ << 20);
+
+629 
+pk
+ = 
+m
+->
+m_pkthdr
+.
+n
+;
+
+630 
+m
+->
+m_pkthdr
+.
+rcvif
+ = 
+i
+;
+
+632 
+	`bpf_mp_af
+(
+i
+, 
+AF_INET6
+, 
+m
+);
+
+641 
+s
+ = 
+	`
+();
+
+642 i(
+	`__edi_ue
+(
+	`pktq_queue
+(
+6_pktq
+, 
+m
+, 0))) {
+
+643 
+i
+->
+if_acks
+++;
+
+644 
+i
+->
+if_ibys
+ +
+pk
+;
+
+646 
+	`m_m
+(
+m
+);
+
+648 
+	`lx
+(
+s
+);
+
+649 
+	}
+}
+
+653 
+	$f_que
+(
+cmd
+, 
+y
+ *
+
+,
+
+654 c 
+_addrfo
+ *
+fo
+)
+
+656 i(
+
+ !
+NULL
+) {
+
+657 
+f_soc
+ *
+sc
+;
+
+659 
+sc
+ = 
+	`LIST_FIRST
+(&
+f_soc_li
+);
+
+660 
+
+->
+_rmx
+.
+rmx_mtu
+ = (
+sc
+ !
+NULL
+? sc->
+sc_if
+.
+if_mtu
+ : 
+STF_MTU
+;
+
+662 
+	}
+}
+
+665 
+	$f_iol
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+667 
+iddr
+ *
+i
+;
+
+668 
+ieq
+ *
+i
+ = 
+da
+;
+
+669 
+sockaddr_6
+ *
+s6
+;
+
+670 
+r
+;
+
+672 
+r
+ = 0;
+
+673 
+cmd
+) {
+
+674 
+SIOCINITIFADDR
+:
+
+675 
+i
+ = (
+iddr
+ *)
+da
+;
+
+676 i(
+i
+ =
+NULL
+ || i->
+i_addr
+->
+_my
+ !
+AF_INET6
+) {
+
+677 
+r
+ = 
+EAFNOSUPPORT
+;
+
+680 
+s6
+ = (
+sockaddr_6
+ *)
+i
+->
+i_addr
+;
+
+681 i(
+	`IN6_IS_ADDR_6TO4
+(&
+s6
+->
+s6_addr
+) &&
+
+682 !
+	`ifc1918addr
+(
+	`GET_V4
+(&
+s6
+->
+s6_addr
+))) {
+
+683 
+i
+->
+i_que
+ = 
+f_que
+;
+
+684 
+i
+->
+if_ags
+ |
+IFF_UP
+;
+
+686 
+r
+ = 
+EINVAL
+;
+
+689 
+SIOCADDMULTI
+:
+
+690 
+SIOCDELMULTI
+:
+
+691 i(
+i
+ !
+NULL
+ &&
+
+692 
+	`ieq_gaddr
+(
+cmd
+, 
+i
+)->
+_my
+ =
+AF_INET6
+)
+
+695 
+r
+ = 
+EAFNOSUPPORT
+;
+
+698 
+SIOCSIFMTU
+:
+
+699 i(
+i
+->
+i_mtu
+ < 
+STF_MTU_MIN
+ || i->i_mtu > 
+STF_MTU_MAX
+)
+
+700  
+EINVAL
+;
+
+701 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)=
+ENETRESET
+)
+
+702 
+r
+ = 0;
+
+706 
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+);
+
+710  
+r
+;
+
+711 
+	}
+}
+
+	@if_stf.h
+
+33 #ide
+_NET_IF_STF_H_
+
+
+34 
+	#_NET_IF_STF_H_
+
+
+	)
+
+36 
+	#STF_MTU
+ (1280
+
+	)
+
+37 
+	#STF_MTU_MIN
+ (1280
+
+	)
+
+38 
+	#STF_MTU_MAX
+ (8192
+
+	)
+
+40 
+_f_put
+(
+mbuf
+ *, ...);
+
+	@if_strip.c
+
+89 
+	~<sys/cdefs.h
+>
+
+90 
+__KERNEL_RCSID
+(0, "$NetBSD: if_strip.c,v 1.97 2014/06/05 23:48:16mind Exp $");
+
+92 
+	~"t_.h
+"
+
+94 
+	~<sys/m.h
+>
+
+95 
+	~<sys/oc.h
+>
+
+96 
+	~<sys/mbuf.h
+>
+
+97 
+	~<sys/buf.h
+>
+
+98 
+	~<sys/dk.h
+>
+
+99 
+	~<sys/sock.h
+>
+
+100 
+	~<sys/iol.h
+>
+
+101 
+	~<sys/fe.h
+>
+
+102 
+	~<sys/cf.h
+>
+
+103 
+	~<sys/y.h
+>
+
+104 
+	~<sys/kl.h
+>
+
+105 #i
+__NBSD__
+
+
+106 
+	~<sys/sym.h
+>
+
+107 
+	~<sys/out.h
+>
+
+108 
+	~<sys/kauth.h
+>
+
+110 
+	~<sys/syog.h
+>
+
+111 
+	~<sys/u.h
+>
+
+112 
+	~<sys/.h
+>
+
+113 
+	~<sys/sockv.h
+>
+
+115 
+	~<t/if.h
+>
+
+116 
+	~<t/if_dl.h
+>
+
+117 
+	~<t/if_tys.h
+>
+
+118 
+	~<t/ti.h
+>
+
+119 
+	~<t/rou.h
+>
+
+121 #ifde
+INET
+
+
+122 
+	~<t/.h
+>
+
+123 
+	~<t/_sym.h
+>
+
+124 
+	~<t/_v.h
+>
+
+125 
+	~<t/.h
+>
+
+128 
+	~<t/comess.h
+>
+
+129 
+	~<t/if_rv.h
+>
+
+130 
+	~<t/.h
+>
+
+132 #ifde
+__NBSD__
+
+
+133 
+u_ch
+ 
+	tych_t
+;
+
+135 
+	tych_t
+;
+
+138 
+	~<sys/time.h
+>
+
+139 
+	~<t/bpf.h
+>
+
+181 
+	#BUFOFFSET
+ (128+(
+i
+ **)+
+SLIP_HDRLEN
+)
+
+	)
+
+182 
+	#SLMAX
+ (
+MCLBYTES
+ - 
+BUFOFFSET
+)
+
+	)
+
+183 
+	#SLBUFSIZE
+ (
+SLMAX
+ + 
+BUFOFFSET
+)
+
+	)
+
+184 
+	#SLMTU
+ 1100
+
+	)
+
+186 
+	#STRIP_MTU_ONWIRE
+ (
+SLMTU
+ + 20 + 
+STRIP_HDRLEN
+
+
+	)
+
+189 
+	#SLIP_HIWAT
+ 
+	`roundup
+(50, 
+TTROUND
+)
+
+	)
+
+192 
+	#CCOUNT
+(
+q
+((q)->
+c_cc
+)
+
+	)
+
+195 #ide
+__NBSD__
+
+
+196 
+	#CLISTRESERVE
+ 1024
+
+	)
+
+206 
+	#ABT_ESC
+ '\033'
+
+	)
+
+207 
+	#ABT_IDLE
+ 1
+
+	)
+
+208 
+	#ABT_COUNT
+ 3
+
+	)
+
+209 
+	#ABT_WINDOW
+ (
+ABT_COUNT
+*2+2
+
+	)
+
+211 
+r_e_
+(
+if_e
+ *, );
+
+212 
+r_e_deroy
+(
+i
+ *);
+
+214 
+	$LIST_HEAD
+(, 
+r_soc
+
+r_soc_li
+;
+
+216 
+if_e
+ 
+r_
+ =
+
+217 
+	`IF_CLONE_INITIALIZER
+("r", 
+r_e_
+, 
+r_e_deroy
+);
+
+219 
+	#STRIP_FRAME_END
+ 0x0D
+
+	)
+
+221 
+	`r
+(*);
+
+223 
+	`r
+(
+r_soc
+ *);
+
+224 
+mbuf
+ *
+	`r_btom
+(
+r_soc
+ *, );
+
+233 
+	#STRIP_ENCAP_SIZE
+(
+X
+((36+ (X)*65/64 + 2)
+
+	)
+
+234 
+	#STRIP_HDRLEN
+ 15
+
+	)
+
+235 
+	#STRIP_MAC_ADDR_LEN
+ 9
+
+	)
+
+241 
+	#STARMODE_ADDR_LEN
+ 11
+
+	)
+
+242 
+	s_hd
+ {
+
+243 
+u_ch
+ 
+mode_addr
+[
+STARMODE_ADDR_LEN
+];
+
+244 
+u_ch
+ 
+mode_ty
+[4];
+
+253 
+u_ch
+* 
+	`UnStuffDa
+(u_ch *
+c
+, u_ch *
+d
+, u_char
+
+254 *
+de
+, 
+u_lg
+ 
+de_ngth
+);
+
+256 
+u_ch
+* 
+	`StuffDa
+(u_ch *
+c
+, 
+u_lg
+ 
+ngth
+, u_ch *
+de
+,
+
+257 
+u_ch
+ **
+code_r_r
+);
+
+259 
+	`RecvE
+(c *
+msg
+, 
+r_soc
+ *
+sc
+);
+
+260 
+	`RecvE_Mesge
+(
+r_soc
+ *
+r_fo
+,
+
+261 
+u_ch
+ *
+ndme
+, c u_ch *
+msg
+);
+
+262 
+	`r_adio
+(
+r_soc
+ *
+sc
+, 
+y
+ *
+
+);
+
+263 
+	`r_obadio
+(
+r_soc
+ *
+sc
+, 
+y
+ *
+
+);
+
+264 
+	`r_wchdog
+(
+i
+ *
+i
+);
+
+265 
+	`r_ndbody
+(
+r_soc
+ *
+sc
+, 
+mbuf
+ *
+m
+);
+
+266 
+	`r_wck
+(
+r_soc
+ *
+sc
+, 
+u_ch
+ *
+r
+, u_ch *
+d
+);
+
+267 
+	`r_nd
+(
+r_soc
+ *
+sc
+, 
+mbuf
+ *
+m0
+);
+
+269 
+	`r_timeout
+(*
+x
+);
+
+271 #ifde
+DEBUG
+
+
+272 
+	#DPRINTF
+(
+x
+
+tf
+ 
+	)
+x
+
+274 
+	#DPRINTF
+(
+x
+)
+
+	)
+
+292 
+	#STRIP_WATCHDOG_INTERVAL
+ 5
+
+	)
+
+295 
+	#ST_PROBE_INTERVAL
+ 10
+
+	)
+
+298 
+	#ST_PROBERESPONSE_INTERVAL
+ 2
+
+	)
+
+301 
+	#STRIP_RESET_INTERVAL
+ 5
+
+	)
+
+308 
+	#CLEAR_RESET_TIMER
+(
+sc
+) \
+
+310 (
+sc
+)->
+sc_e
+ = 
+ST_ALIVE
+; \
+
+311 (
+sc
+)->
+sc_imo
+ = 
+time_cd
+ + 
+ST_PROBE_INTERVAL
+; \
+
+312 
+	}
+}  0)
+
+	)
+
+318 
+	#FORCE_RESET
+(
+sc
+) \
+
+320 (
+sc
+)->
+sc_imo
+ = 
+time_cd
+ - 1; \
+
+321 (
+sc
+)->
+sc_e
+ = 
+ST_DEAD
+; \
+
+323 }  0)
+
+	)
+
+325 
+	#RADIO_PROBE_TIMEOUT
+(
+sc
+) \
+
+326 ((
+sc
+)-> 
+sc_imo
+ > 
+time_cd
+)
+
+	)
+
+328 
+ro
+(
+y
+ *, );
+
+329 
+rput
+(, 
+y
+ *);
+
+330 
+riol
+(
+i
+ *, 
+u_lg
+, *);
+
+331 
+r
+(
+dev_t
+, 
+y
+ *);
+
+332 
+rouut
+(
+i
+ *,
+
+333 
+mbuf
+ *, c 
+sockaddr
+ *, 
+y
+ *);
+
+334 
+rt
+(
+y
+ *);
+
+335 
+rtiol
+(
+y
+ *, 
+u_lg
+, *, , 
+lwp
+ *);
+
+337 
+lesw
+ 
+	gr_disc
+ = {
+
+338 .
+l_me
+ = "strip",
+
+339 .
+	gl_
+ = 
+r
+,
+
+340 .
+	gl_o
+ = 
+ro
+,
+
+341 .
+	gl_ad
+ = 
+yrio
+,
+
+342 .
+	gl_wre
+ = 
+yrio
+,
+
+343 .
+	gl_iol
+ = 
+rtiol
+,
+
+344 .
+	gl_rt
+ = 
+rput
+,
+
+345 .
+	gl_t
+ = 
+rt
+,
+
+346 .
+	gl_modem
+ = 
+numodem
+,
+
+347 .
+	gl_pl
+ = 
+yl
+
+
+351 
+	$rch
+()
+
+353 i(
+	`yldisc_ch
+(&
+r_disc
+) != 0)
+
+354 
+	`nic
+("stripattach");
+
+355 
+	`LIST_INIT
+(&
+r_soc_li
+);
+
+356 
+	`if_e_ch
+(&
+r_
+);
+
+357 
+	}
+}
+
+360 
+	$r_e_
+(
+if_e
+ *
+ifc
+, 
+un
+)
+
+362 
+r_soc
+ *
+sc
+;
+
+364 
+sc
+ = 
+	`mloc
+((*sc), 
+M_DEVBUF
+, 
+M_WAIT
+|
+M_ZERO
+);
+
+365 
+sc
+->
+sc_un
+ = 
+un
+;
+
+366 
+	`if_me
+(&
+sc
+->
+sc_if
+, 
+ifc
+->
+ifc_me
+, 
+un
+);
+
+367 
+	`out_
+(&
+sc
+->
+sc_timo_ch
+, 0);
+
+368 
+sc
+->
+sc_if
+.
+if_soc
+ = sc;
+
+369 
+sc
+->
+sc_if
+.
+if_mtu
+ = 
+SLMTU
+;
+
+370 
+sc
+->
+sc_if
+.
+if_ags
+ = 0;
+
+371 
+sc
+->
+sc_if
+.
+if_ty
+ = 
+IFT_OTHER
+;
+
+373 
+sc
+->
+sc_if
+.
+if_ags
+ |
+SC_AUTOCOMP
+ ;
+
+375 
+sc
+->
+sc_if
+.
+if_ty
+ = 
+IFT_SLIP
+;
+
+376 
+sc
+->
+sc_if
+.
+if_iol
+ = 
+riol
+;
+
+377 
+sc
+->
+sc_if
+.
+if_ouut
+ = 
+rouut
+;
+
+378 
+sc
+->
+sc_if
+.
+if_d
+ = 
+DLT_SLIP
+;
+
+379 
+sc
+->
+sc_q
+.
+ifq_maxn
+ = 32;
+
+380 
+	`IFQ_SET_READY
+(&
+sc
+->
+sc_if
+.
+if_d
+);
+
+382 
+sc
+->
+sc_if
+.
+if_wchdog
+ = 
+r_wchdog
+;
+
+383 
+	`if_ch
+(&
+sc
+->
+sc_if
+);
+
+384 
+	`if_loc_dl
+(&
+sc
+->
+sc_if
+);
+
+385 
+	`bpf_ch
+(&
+sc
+->
+sc_if
+, 
+DLT_SLIP
+, 
+SLIP_HDRLEN
+);
+
+386 
+	`LIST_INSERT_HEAD
+(&
+r_soc_li
+, 
+sc
+, 
+sc_ii
+);
+
+388 
+	}
+}
+
+391 
+	$r_e_deroy
+(
+i
+ *
+i
+)
+
+393 
+r_soc
+ *
+sc
+ = (r_so*)
+i
+->
+if_soc
+;
+
+395 i(
+sc
+->
+sc_yp
+ !
+NULL
+)
+
+396  
+EBUSY
+;
+
+398 
+	`LIST_REMOVE
+(
+sc
+, 
+sc_ii
+);
+
+400 
+	`bpf_dach
+(
+i
+);
+
+401 
+	`if_dach
+(
+i
+);
+
+403 
+	`
+(
+sc
+, 
+M_DEVBUF
+);
+
+405 
+	}
+}
+
+408 
+	$r
+(
+r_soc
+ *
+sc
+)
+
+410 
+u_ch
+ *
+p
+;
+
+412 i(
+sc
+->
+sc_mbuf
+ =
+NULL
+) {
+
+413 
+sc
+->
+sc_mbuf
+ = 
+	`m_g
+(
+M_WAIT
+, 
+MT_DATA
+);
+
+414 
+	`m_g
+(
+sc
+->
+sc_mbuf
+, 
+M_WAIT
+);
+
+416 
+sc
+->
+sc_
+ = (
+u_ch
+ *sc->
+sc_mbuf
+->
+m_ext
+.
+ext_buf
+ +
+
+417 
+sc
+->
+sc_mbuf
+->
+m_ext
+.
+ext_size
+;
+
+418 
+sc
+->
+sc_mp
+ = sc->
+sc_pktt
+ = (
+u_ch
+ *sc->
+sc_mbuf
+->
+m_ext
+.
+ext_buf
+ +
+
+419 
+BUFOFFSET
+;
+
+422 i(
+sc
+->
+sc_rxbuf
+ =
+NULL
+) {
+
+423 
+p
+ = (
+u_ch
+ *)
+	`mloc
+(
+MCLBYTES
+, 
+M_DEVBUF
+, 
+M_WAITOK
+);
+
+424 i(
+p
+)
+
+425 
+sc
+->
+sc_rxbuf
+ = 
+p
+ + 
+SLBUFSIZE
+ - 
+SLMAX
+;
+
+427 
+	`tf
+("%s: can'tllocate input buffer\n",
+
+428 
+sc
+->
+sc_if
+.
+if_xme
+);
+
+429 
+sc
+->
+sc_if
+.
+if_ags
+ &~
+IFF_UP
+;
+
+435 i(
+sc
+->
+sc_txbuf
+ =
+NULL
+) {
+
+436 
+p
+ = (
+u_ch
+ *)
+	`mloc
+(
+MCLBYTES
+, 
+M_DEVBUF
+, 
+M_WAITOK
+);
+
+437 i(
+p
+)
+
+438 
+sc
+->
+sc_txbuf
+ = (
+u_ch
+ *)
+p
+ + 
+SLBUFSIZE
+ - 
+SLMAX
+;
+
+440 
+	`tf
+("%s: can'tllocate buffer\n",
+
+441 
+sc
+->
+sc_if
+.
+if_xme
+);
+
+443 
+sc
+->
+sc_if
+.
+if_ags
+ &~
+IFF_UP
+;
+
+448 #ifde
+INET
+
+
+449 
+	`_comess_
+(&
+sc
+->
+sc_comp
+);
+
+453 
+sc
+->
+sc_e
+ = 
+ST_DEAD
+;
+
+454 
+sc
+->
+sc_imo
+ = 
+time_cd
+;
+
+457 
+	}
+}
+
+465 
+	$r
+(
+dev_t
+ 
+dev
+, 
+y
+ *
+
+)
+
+467 
+lwp
+ *
+l
+ = 
+cuwp
+;
+
+468 
+r_soc
+ *
+sc
+;
+
+469 
+r
+;
+
+471 
+r
+ = 
+	`kauth_authize_twk
+(
+l
+->
+l_ed
+,
+
+472 
+KAUTH_NETWORK_INTERFACE_STRIP
+,
+
+473 
+KAUTH_REQ_NETWORK_INTERFACE_STRIP_ADD
+, 
+NULL
+, NULL, NULL);
+
+474 i(
+r
+)
+
+475  (
+r
+);
+
+477 i(
+
+->
+t_lesw
+ =&
+r_disc
+)
+
+480 
+	`LIST_FOREACH
+(
+sc
+, &
+r_soc_li
+, 
+sc_ii
+) {
+
+481 i(
+sc
+->
+sc_yp
+ =
+NULL
+) {
+
+482 
+sc
+->
+sc_si
+ = 
+	`sot_eablish
+(
+SOFTINT_NET
+,
+
+483 
+r
+, 
+sc
+);
+
+484 i(
+	`r
+(
+sc
+) == 0) {
+
+485 
+	`sot_diablish
+(
+sc
+->
+sc_si
+);
+
+486  (
+ENOBUFS
+);
+
+488 
+	`mux__r
+(&
+y_lock
+);
+
+489 
+
+->
+t_sc
+ = (*)
+sc
+;
+
+490 
+sc
+->
+sc_yp
+ = 
+
+;
+
+491 
+sc
+->
+sc_if
+.
+if_baud
+ = 
+
+->
+t_od
+;
+
+492 
+	`yush
+(
+
+, 
+FREAD
+ | 
+FWRITE
+);
+
+501 i(
+
+->
+t_outq
+.
+c_
+ < 
+STRIP_MTU_ONWIRE
+) {
+
+502 
+sc
+->
+sc_dbufsize
+ = 
+
+->
+t_outq
+.
+c_
+;
+
+503 
+sc
+->
+sc_dbufqu
+ = 
+
+->
+t_outq
+.
+c_cq
+ != 0;
+
+505 
+	`mux__ex
+(&
+y_lock
+);
+
+506 
+	`
+(&
+
+->
+t_outq
+);
+
+507 
+r
+ = 
+	`loc
+(&
+
+->
+t_outq
+, 3*
+SLMTU
+, 0);
+
+508 i(
+r
+) {
+
+509 
+	`sot_diablish
+(
+sc
+->
+sc_si
+);
+
+515  (
+ENOMEM
+);
+
+517 
+	`mux__r
+(&
+y_lock
+);
+
+519 
+sc
+->
+sc_dbufsize
+ = sc->
+sc_dbufqu
+ = 0;
+
+520 
+	`r_adio
+(
+sc
+, 
+
+);
+
+521 
+	`mux__ex
+(&
+y_lock
+);
+
+527 
+sc
+->
+sc_if
+.
+if_tim
+ = 
+STRIP_WATCHDOG_INTERVAL
+;
+
+532  (
+ENXIO
+);
+
+533 
+	}
+}
+
+540 
+	$ro
+(
+y
+ *
+
+, 
+ag
+)
+
+542 
+r_soc
+ *
+sc
+;
+
+543 
+s
+;
+
+545 
+	`ywush
+(
+
+);
+
+546 
+sc
+ = 
+
+->
+t_sc
+;
+
+548 i(
+sc
+ !
+NULL
+) {
+
+549 
+	`sot_diablish
+(
+sc
+->
+sc_si
+);
+
+550 
+s
+ = 
+	`
+();
+
+555 
+sc
+->
+sc_if
+.
+if_tim
+ = 0;
+
+556 
+	`if_down
+(&
+sc
+->
+sc_if
+);
+
+557 
+	`IF_PURGE
+(&
+sc
+->
+sc_q
+);
+
+558 
+	`lx
+(
+s
+);
+
+560 
+s
+ = 
+	`ty
+();
+
+561 
+	`yldisc_a
+(
+
+->
+t_lesw
+);
+
+562 
+
+->
+t_lesw
+ = 
+	`yldisc_deu
+();
+
+563 
+
+->
+t_e
+ = 0;
+
+565 
+sc
+->
+sc_yp
+ = 
+NULL
+;
+
+566 
+
+->
+t_sc
+ = 
+NULL
+;
+
+568 
+	`m_m
+(
+sc
+->
+sc_mbuf
+);
+
+569 
+sc
+->
+sc_mbuf
+ = 
+NULL
+;
+
+570 
+sc
+->
+sc_
+ = sc->
+sc_mp
+ = sc->
+sc_pktt
+ = 
+NULL
+;
+
+571 
+	`IF_PURGE
+(&
+sc
+->
+sc_q
+);
+
+574 
+	`
+((*)(
+sc
+->
+sc_rxbuf
+ - 
+SLBUFSIZE
+ + 
+SLMAX
+), 
+M_DEVBUF
+);
+
+575 
+sc
+->
+sc_rxbuf
+ = 
+NULL
+;
+
+578 
+	`
+((*)(
+sc
+->
+sc_txbuf
+ - 
+SLBUFSIZE
+ + 
+SLMAX
+), 
+M_DEVBUF
+);
+
+579 
+sc
+->
+sc_txbuf
+ = 
+NULL
+;
+
+581 i(
+sc
+->
+sc_ags
+ & 
+SC_TIMEOUT
+) {
+
+582 
+	`out_
+(&
+sc
+->
+sc_timo_ch
+);
+
+583 
+sc
+->
+sc_ags
+ &~
+SC_TIMEOUT
+;
+
+590 i(
+sc
+->
+sc_dbufsize
+ != 0) {
+
+591 
+	`
+(&
+
+->
+t_outq
+);
+
+592 
+	`loc
+(&
+
+->
+t_outq
+, 
+sc
+->
+sc_dbufsize
+,
+
+593 
+sc
+->
+sc_dbufqu
+);
+
+595 
+	`lx
+(
+s
+);
+
+599 
+	}
+}
+
+607 
+	$rtiol
+(
+y
+ *
+
+, 
+u_lg
+ 
+cmd
+, *
+da
+, 
+ag
+,
+
+608 
+lwp
+ *
+l
+)
+
+610 
+r_soc
+ *
+sc
+ = (r_so*)
+
+->
+t_sc
+;
+
+612 
+cmd
+) {
+
+613 
+SLIOCGUNIT
+:
+
+614 *(*)
+da
+ = 
+sc
+->
+sc_un
+;
+
+618  (
+EPASSTHROUGH
+);
+
+621 
+	}
+}
+
+628 
+	$r_ndbody
+(
+r_soc
+ *
+sc
+, 
+mbuf
+ *
+m
+)
+
+630 
+y
+ *
+
+ = 
+sc
+->
+sc_yp
+;
+
+631 
+u_ch
+ *
+dp
+ = 
+sc
+->
+sc_txbuf
+;
+
+632 
+mbuf
+ *
+m2
+;
+
+633 
+n
+;
+
+634 
+u_ch
+ *
+le_r
+ = 
+NULL
+;
+
+636 
+m
+) {
+
+637 i(
+m
+->
+m_n
+ != 0) {
+
+645 
+dp
+ = 
+	`StuffDa
+(
+	`mtod
+(
+m
+, 
+u_ch
+ *), m->
+m_n
+, dp,
+
+646 &
+le_r
+);
+
+648 
+	`MFREE
+(
+m
+, 
+m2
+);
+
+649 
+m
+ = 
+m2
+;
+
+655 
+n
+ = 
+dp
+ - 
+sc
+->
+sc_txbuf
+;
+
+656 i(
+	`b_to_q
+((
+ych_t
+ *)
+sc
+->
+sc_txbuf
+, 
+n
+, &
+
+->
+t_outq
+)) {
+
+657 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_DEBUG
+)
+
+658 
+	`addlog
+("%s:ty output overflow\n",
+
+659 
+sc
+->
+sc_if
+.
+if_xme
+);
+
+662 
+sc
+->
+sc_if
+.
+if_obys
+ +
+n
+;
+
+663 
+	}
+}
+
+669 
+	$r_nd
+(
+r_soc
+ *
+sc
+, 
+mbuf
+ *
+m0
+)
+
+671 
+y
+ *
+
+ = 
+sc
+->
+sc_yp
+;
+
+672 
+_hd
+ *
+hdr
+;
+
+677 
+hdr
+ = 
+	`mtod
+(
+m0
+, 
+_hd
+ *);
+
+678 i(
+	`b_to_q
+((
+ych_t
+ *)
+hdr
+, 
+STRIP_HDRLEN
+, &
+
+->
+t_outq
+)) {
+
+679 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_DEBUG
+)
+
+680 
+	`addlog
+("%s: outq overflow writing header\n",
+
+681 
+sc
+->
+sc_if
+.
+if_xme
+);
+
+682 
+	`m_m
+(
+m0
+);
+
+686 
+	`m_adj
+(
+m0
+, (
+_hd
+));
+
+689 
+	`r_ndbody
+(
+sc
+, 
+m0
+);
+
+691 i(
+	`putc
+(
+STRIP_FRAME_END
+, &
+
+->
+t_outq
+)) {
+
+699 (
+	`uutc
+(&
+
+->
+t_outq
+);
+
+700 (
+	`putc
+(
+STRIP_FRAME_END
+, &
+
+->
+t_outq
+);
+
+701 
+sc
+->
+sc_if
+.
+if_clisis
+++;
+
+703 ++
+sc
+->
+sc_if
+.
+if_obys
+;
+
+704 
+sc
+->
+sc_if
+.
+if_acks
+++;
+
+711 i(
+time_cd
+ >
+sc
+->
+sc_imo
+ && sc->
+sc_e
+ =
+ST_ALIVE
+)
+
+712 
+	`r_obadio
+(
+sc
+, 
+
+);
+
+713 
+	}
+}
+
+722 
+	$rouut
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+, c 
+sockaddr
+ *
+d
+,
+
+723 
+y
+ *
+
+)
+
+725 
+r_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+726 
+
+ *ip;
+
+727 
+_hd
+ *
+shp
+;
+
+728 c 
+u_ch
+ *
+dld
+;
+
+729 
+ifqueue
+ *
+ifq
+;
+
+730 
+s
+, 
+r
+;
+
+731 
+u_ch
+ 
+dl_addrbuf
+[
+STARMODE_ADDR_LEN
++1];
+
+732 
+	`ALTQ_DECL
+(
+tq_pkr
+ 
+pkr
+;)
+
+737 i(
+sc
+->
+sc_yp
+ =
+NULL
+) {
+
+738 
+	`m_m
+(
+m
+);
+
+739  (
+ENETDOWN
+);
+
+741 i((
+sc
+->
+sc_yp
+->
+t_e
+ & 
+TS_CARR_ON
+) == 0 &&
+
+742 (
+sc
+->
+sc_yp
+->
+t_cag
+ & 
+CLOCAL
+) == 0) {
+
+743 
+	`m_m
+(
+m
+);
+
+744  (
+EHOSTUNREACH
+);
+
+747 #ifde
+DEBUG
+
+
+748 i(
+
+) {
+
+749 
+	`tf
+("stripout,t: dstf%d gwf%d",
+
+750 
+	`_gkey
+(
+
+)->
+_my
+,t->
+_geway
+->sa_family);
+
+751 i(
+	`_gkey
+(
+
+)->
+_my
+ =
+AF_INET
+)
+
+752 
+	`tf
+(" dst %x",
+
+753 
+	`tocs
+(
+	`_gkey
+(
+
+))->
+s_addr
+.
+s_addr
+);
+
+754 
+	`tf
+("\n");
+
+757 
+d
+->
+_my
+) {
+
+758 
+AF_INET
+:
+
+759 i(
+
+ !
+NULL
+ &&t->
+_gwrou
+ != NULL)
+
+760 
+
+ =t->
+_gwrou
+;
+
+763 i(
+
+ =
+NULL
+ ||t->
+_geway
+->
+_my
+ !
+AF_LINK
+
+
+764 || 
+	`tocsdl
+(
+
+->
+_geway
+)->
+sdl_
+ !
+i
+->
+if_add
+) {
+
+765 
+	`DPRINTF
+(("strip: couldotrp starmodeddr %x\n",
+
+766 
+	`tocs
+(
+d
+)->
+s_addr
+.
+s_addr
+));
+
+767 
+	`m_m
+(
+m
+);
+
+768  (
+EHOSTUNREACH
+);
+
+770 
+dld
+ = 
+	`CLLADDR
+(
+	`tocsdl
+(
+
+->
+_geway
+));
+
+773 
+AF_LINK
+:
+
+774 
+dld
+ = 
+	`CLLADDR
+(
+	`tocsdl
+(
+d
+));
+
+782 
+	`tf
+("%s:%d sud\n", 
+sc
+->
+sc_if
+.
+if_xme
+,
+
+783 
+d
+->
+_my
+);
+
+784 
+	`m_m
+(
+m
+);
+
+785 
+sc
+->
+sc_if
+.
+if_nro
+++;
+
+786  (
+EAFNOSUPPORT
+);
+
+789 
+
+ = 
+	`mtod
+(
+m
+, ip *);
+
+790 #ifde
+INET
+
+
+791 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+SC_NOICMP
+ && 
+
+->
+_p
+ =
+IPPROTO_ICMP
+) {
+
+792 
+	`m_m
+(
+m
+);
+
+793  (
+ENETRESET
+);
+
+795 i((
+
+->
+_tos
+ & 
+IPTOS_LOWDELAY
+) != 0
+
+796 #ifde
+ALTQ
+
+
+797 && 
+	`ALTQ_IS_ENABLED
+(&
+i
+->
+if_d
+) == 0
+
+800 
+ifq
+ = &
+sc
+->
+sc_q
+;
+
+803 
+ifq
+ = 
+NULL
+;
+
+809 
+	`M_PREPEND
+(
+m
+, (
+_hd
+), 
+M_DONTWAIT
+);
+
+810 i(
+m
+ == 0) {
+
+811 
+	`DPRINTF
+(("strip: couldotrepend starmode header\n"));
+
+812  (
+ENOBUFS
+);
+
+818 
+dl_addrbuf
+[0] = '*';
+
+820 
+dl_addrbuf
+[1] = ((
+dld
+[0] >> 4) & 0x0f) + '0';
+
+821 
+dl_addrbuf
+[2] = ((
+dld
+[0] ) & 0x0f) + '0';
+
+823 
+dl_addrbuf
+[3] = ((
+dld
+[1] >> 4) & 0x0f) + '0';
+
+824 
+dl_addrbuf
+[4] = ((
+dld
+[1] ) & 0x0f) + '0';
+
+826 
+dl_addrbuf
+[5] = '-';
+
+828 
+dl_addrbuf
+[6] = ((
+dld
+[2] >> 4) & 0x0f) + '0';
+
+829 
+dl_addrbuf
+[7] = ((
+dld
+[2] ) & 0x0f) + '0';
+
+831 
+dl_addrbuf
+[8] = ((
+dld
+[3] >> 4) & 0x0f) + '0';
+
+832 
+dl_addrbuf
+[9] = ((
+dld
+[3] ) & 0x0f) + '0';
+
+834 
+dl_addrbuf
+[10] = '*';
+
+835 
+dl_addrbuf
+[11] = 0;
+
+836 
+dld
+ = 
+dl_addrbuf
+;
+
+838 
+shp
+ = 
+	`mtod
+(
+m
+, 
+_hd
+ *);
+
+839 
+	`memy
+(&
+shp
+->
+mode_ty
+, "SIP0", (shp->starmode_type));
+
+841 
+	`memy
+(
+shp
+->
+mode_addr
+, 
+dld
+, (shp->starmode_addr));
+
+843 
+s
+ = 
+	`ty
+();
+
+844 i(
+sc
+->
+sc_oqn
+ && sc->
+sc_yp
+->
+t_outq
+.
+c_cc
+ == sc->sc_oqlen) {
+
+845 
+btime
+ 
+bt
+;
+
+848 
+	`gbuime
+(&
+bt
+);
+
+849 
+	`btime_sub
+(&
+bt
+, &
+sc
+->
+sc_ck
+);
+
+850 i(
+bt
+.
+c
+ > 0) {
+
+851 
+	`DPRINTF
+(("stripoutput: stalled,esetting\n"));
+
+852 
+sc
+->
+sc_imeout
+++;
+
+853 
+	`rt
+(
+sc
+->
+sc_yp
+);
+
+856 
+	`lx
+(
+s
+);
+
+858 
+s
+ = 
+	`
+();
+
+859 i((
+r
+ = 
+	`ifq_queue2
+(
+i
+, 
+ifq
+, 
+m
+ 
+ALTQ_COMMA
+
+
+860 
+	`ALTQ_DECL
+(&
+pkr
+))) != 0) {
+
+861 
+	`lx
+(
+s
+);
+
+862  
+r
+;
+
+864 
+	`gbuime
+(&
+sc
+->
+sc_ck
+);
+
+865 
+	`lx
+(
+s
+);
+
+867 
+s
+ = 
+	`ty
+();
+
+868 
+	`rt
+(
+sc
+->
+sc_yp
+);
+
+869 
+	`lx
+(
+s
+);
+
+872 
+	}
+}
+
+882 
+	$rt
+(
+y
+ *
+
+)
+
+884 
+r_soc
+ *
+sc
+ = 
+
+->
+t_sc
+;
+
+891 i(
+
+->
+t_outq
+.
+c_cc
+ != 0) {
+
+892 (*
+
+->
+t_roc
+)(tp);
+
+893 i(
+
+->
+t_outq
+.
+c_cc
+ > 
+SLIP_HIWAT
+)
+
+900 i(
+sc
+ =
+NULL
+)
+
+902 
+	`sot_schedu
+(
+sc
+->
+sc_si
+);
+
+904 
+	}
+}
+
+909 
+mbuf
+ *
+
+910 
+	$r_btom
+(
+r_soc
+ *
+sc
+, 
+n
+)
+
+912 
+mbuf
+ *
+m
+;
+
+917 
+m
+ = 
+sc
+->
+sc_mbuf
+;
+
+918 
+	`MGETHDR
+(
+sc
+->
+sc_mbuf
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+919 i(
+sc
+->
+sc_mbuf
+ =
+NULL
+) {
+
+920 
+sc
+->
+sc_mbuf
+ = 
+m
+;
+
+921  (
+NULL
+);
+
+923 
+	`MCLGET
+(
+sc
+->
+sc_mbuf
+, 
+M_DONTWAIT
+);
+
+924 i((
+sc
+->
+sc_mbuf
+->
+m_ags
+ & 
+M_EXT
+) == 0) {
+
+925 
+	`m_m
+(
+sc
+->
+sc_mbuf
+);
+
+926 
+sc
+->
+sc_mbuf
+ = 
+m
+;
+
+927  (
+NULL
+);
+
+929 
+sc
+->
+sc_
+ = (
+u_ch
+ *sc->
+sc_mbuf
+->
+m_ext
+.
+ext_buf
+ +
+
+930 
+sc
+->
+sc_mbuf
+->
+m_ext
+.
+ext_size
+;
+
+932 
+m
+->
+m_da
+ = 
+sc
+->
+sc_pktt
+;
+
+934 
+m
+->
+m_pkthdr
+.
+n
+ = m->
+m_n
+ =en;
+
+935 
+m
+->
+m_pkthdr
+.
+rcvif
+ = &
+sc
+->
+sc_if
+;
+
+936  (
+m
+);
+
+937 
+	}
+}
+
+948 
+	$rput
+(
+c
+, 
+y
+ *
+
+)
+
+950 
+r_soc
+ *
+sc
+;
+
+951 
+mbuf
+ *
+m
+;
+
+952 
+n
+;
+
+954 
+tk_n
+++;
+
+955 
+sc
+ = (
+r_soc
+ *)
+
+->
+t_sc
+;
+
+956 i(
+sc
+ =
+NULL
+)
+
+958 i(
+c
+ & 
+TTY_ERRORMASK
+ || ((
+
+->
+t_e
+ & 
+TS_CARR_ON
+) == 0 &&
+
+959 (
+
+->
+t_cag
+ & 
+CLOCAL
+) == 0)) {
+
+960 
+sc
+->
+sc_ags
+ |
+SC_ERROR
+;
+
+961 
+	`DPRINTF
+(("r: iut, %x\n", 
+c
+));
+
+964 
+c
+ &
+TTY_CHARMASK
+;
+
+966 ++
+sc
+->
+sc_if
+.
+if_ibys
+;
+
+971 
+c
+) {
+
+980 i(
+sc
+->
+sc_mp
+ - sc->
+sc_pktt
+ == 0)
+
+986 i(
+sc
+->
+sc_mp
+ < sc->
+sc_
+) {
+
+987 *
+sc
+->
+sc_mp
+++ = 
+c
+;
+
+989 
+sc
+->
+sc_ags
+ |
+SC_ERROR
+;
+
+990 
+r
+;
+
+994 
+STRIP_FRAME_END
+:
+
+1004 
+n
+ = 
+sc
+->
+sc_mp
+ - sc->
+sc_pktt
+;
+
+1006 #ifde
+XDEBUG
+
+
+1007 i(
+n
+ < 15 || 
+sc
+->
+sc_ags
+ & 
+SC_ERROR
+)
+
+1008 
+	`tf
+("stripinput:nd ofkt,en %d,rr %d\n",
+
+1009 
+n
+, 
+sc
+->
+sc_ags
+ & 
+SC_ERROR
+);
+
+1011 if(
+sc
+->
+sc_ags
+ & 
+SC_ERROR
+) {
+
+1012 
+sc
+->
+sc_ags
+ &~
+SC_ERROR
+;
+
+1013 
+	`addlog
+("%s: scrror flag set.erminatingacket\n",
+
+1014 
+sc
+->
+sc_if
+.
+if_xme
+);
+
+1015 
+wck
+;
+
+1023 
+n
+ = 
+	`r_wck
+(
+sc
+, sc->
+sc_pktt
+, sc->
+sc_mp
+);
+
+1024 i(
+n
+ <= 1)
+
+1026 
+wck
+;
+
+1028 
+m
+ = 
+	`r_btom
+(
+sc
+, 
+n
+);
+
+1029 i(
+m
+ =
+NULL
+)
+
+1030 
+r
+;
+
+1032 
+	`IF_ENQUEUE
+(&
+sc
+->
+sc_q
+, 
+m
+);
+
+1033 
+	`sot_schedu
+(
+sc
+->
+sc_si
+);
+
+1034 
+wck
+;
+
+1036 
+r
+:
+
+1037 
+sc
+->
+sc_if
+.
+if_s
+++;
+
+1039 
+wck
+:
+
+1040 
+sc
+->
+sc_mp
+ = sc->
+sc_pktt
+ = (
+u_ch
+ *sc->
+sc_mbuf
+->
+m_ext
+.
+ext_buf
+ +
+
+1041 
+BUFOFFSET
+;
+
+1044 
+	}
+}
+
+1047 
+	$r
+(*
+g
+)
+
+1049 
+r_soc
+ *
+sc
+ = 
+g
+;
+
+1050 
+y
+ *
+
+ = 
+sc
+->
+sc_yp
+;
+
+1051 
+mbuf
+ *
+m
+;
+
+1052 
+s
+, 
+n
+;
+
+1053 
+u_ch
+ *
+pktt
+;
+
+1054 #ifde
+INET
+
+
+1055 
+u_ch
+ 
+c
+;
+
+1057 
+u_ch
+ 
+chdr
+[
+CHDR_LEN
+];
+
+1059 
+	`KASSERT
+(
+
+ !
+NULL
+);
+
+1064 
+	`mux_r
+(
+sot_lock
+);
+
+1066 #ifde
+INET
+
+
+1067 
+
+ *ip;
+
+1069 
+mbuf
+ *
+bpf_m
+;
+
+1078 
+s
+ = 
+	`ty
+();
+
+1079 i(
+
+->
+t_outq
+.
+c_
+ -p->t_outq.
+c_cc
+ <
+
+1080 
+STRIP_MTU_ONWIRE
+ + 4) {
+
+1081 
+	`lx
+(
+s
+);
+
+1084 
+	`lx
+(
+s
+);
+
+1089 
+s
+ = 
+	`
+();
+
+1090 
+	`IF_DEQUEUE
+(&
+sc
+->
+sc_q
+, 
+m
+);
+
+1091 i(
+m
+)
+
+1092 
+sc
+->
+sc_if
+.
+if_oms
+++;
+
+1094 
+	`IFQ_DEQUEUE
+(&
+sc
+->
+sc_if
+.
+if_d
+, 
+m
+);
+
+1095 
+	`lx
+(
+s
+);
+
+1097 i(
+m
+ =
+NULL
+)
+
+1107 i(
+sc
+->
+sc_if
+.
+if_bpf
+) {
+
+1117 
+bpf_m
+ = 
+	`m_dup
+(
+m
+, 0, 
+M_COPYALL
+, 
+M_DONTWAIT
+);
+
+1119 
+bpf_m
+ = 
+NULL
+;
+
+1120 #ifde
+INET
+
+
+1121 i((
+
+ = 
+	`mtod
+(
+m
+,  *))->
+_p
+ =
+IPPROTO_TCP
+) {
+
+1122 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+SC_COMPRESS
+)
+
+1123 *
+	`mtod
+(
+m
+, 
+u_ch
+ *) |=
+
+1124 
+	`_comess_t
+(
+m
+, 
+
+,
+
+1125 &
+sc
+->
+sc_comp
+, 1);
+
+1128 i(
+bpf_m
+ !
+NULL
+)
+
+1129 
+	`bpf_mp__out
+(&
+sc
+->
+sc_if
+, 
+	`mtod
+(
+m
+, 
+u_ch
+ *), 
+bpf_m
+);
+
+1130 
+	`gbuime
+(&
+sc
+->
+sc_ck
+);
+
+1132 
+s
+ = 
+	`ty
+();
+
+1133 
+	`r_nd
+(
+sc
+, 
+m
+);
+
+1139 i(
+
+->
+t_outq
+.
+c_cc
+ != 0)
+
+1140 (*
+
+->
+t_roc
+)(tp);
+
+1141 
+	`lx
+(
+s
+);
+
+1148 
+s
+ = 
+	`ty
+();
+
+1149 
+	`IF_DEQUEUE
+(&
+sc
+->
+sc_q
+, 
+m
+);
+
+1150 
+	`lx
+(
+s
+);
+
+1151 i(
+m
+ =
+NULL
+)
+
+1153 
+pktt
+ = 
+	`mtod
+(
+m
+, 
+u_ch
+ *);
+
+1154 
+n
+ = 
+m
+->
+m_pkthdr
+.len;
+
+1155 i(
+sc
+->
+sc_if
+.
+if_bpf
+) {
+
+1164 
+	`memy
+(
+chdr
+, 
+pktt
+, 
+CHDR_LEN
+);
+
+1166 #ifde
+INET
+
+
+1167 i((
+c
+ = (*
+pktt
+ & 0xf0)!(
+IPVERSION
+ << 4)) {
+
+1168 i(
+c
+ & 0x80)
+
+1169 
+c
+ = 
+TYPE_COMPRESSED_TCP
+;
+
+1170 i(
+c
+ =
+TYPE_UNCOMPRESSED_TCP
+)
+
+1171 *
+pktt
+ &= 0x4f;
+
+1181 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+SC_COMPRESS
+) {
+
+1182 
+n
+ = 
+	`_uncomess_t
+(&
+pktt
+,en,
+
+1183 (
+u_t
+)
+c
+, &
+sc
+->
+sc_comp
+);
+
+1184 i(
+n
+ <= 0) {
+
+1185 
+	`m_m
+(
+m
+);
+
+1188 } i((
+sc
+->
+sc_if
+.
+if_ags
+ & 
+SC_AUTOCOMP
+) &&
+
+1189 
+c
+ =
+TYPE_UNCOMPRESSED_TCP
+ && 
+n
+ >= 40) {
+
+1190 
+n
+ = 
+	`_uncomess_t
+(&
+pktt
+,en,
+
+1191 (
+u_t
+)
+c
+, &
+sc
+->
+sc_comp
+);
+
+1192 i(
+n
+ <= 0) {
+
+1193 
+	`m_m
+(
+m
+);
+
+1196 
+sc
+->
+sc_if
+.
+if_ags
+ |
+SC_COMPRESS
+;
+
+1198 
+	`m_m
+(
+m
+);
+
+1203 
+m
+->
+m_da
+ = (*
+pktt
+;
+
+1204 
+m
+->
+m_pkthdr
+.
+n
+ = m->
+m_n
+ =en;
+
+1205 i(
+sc
+->
+sc_if
+.
+if_bpf
+) {
+
+1206 
+	`bpf_mp__
+(&
+sc
+->
+sc_if
+, 
+chdr
+, &
+m
+);
+
+1207 i(
+m
+ =
+NULL
+)
+
+1215 i(
+m
+->
+m_pkthdr
+.
+n
+ < 
+MHLEN
+) {
+
+1216 
+mbuf
+ *
+n
+;
+
+1217 
+pk
+;
+
+1219 
+	`MGETHDR
+(
+n
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+1220 
+pk
+ = 
+m
+->
+m_pkthdr
+.
+n
+;
+
+1221 
+	`M_MOVE_PKTHDR
+(
+n
+, 
+m
+);
+
+1222 
+	`memy
+(
+	`mtod
+(
+n
+, *), mtod(
+m
+, *), 
+pk
+);
+
+1223 
+n
+->
+m_n
+ = 
+m
+->m_len;
+
+1224 
+	`m_m
+(
+m
+);
+
+1225 
+m
+ = 
+n
+;
+
+1228 
+sc
+->
+sc_if
+.
+if_acks
+++;
+
+1229 
+	`gbuime
+(&
+sc
+->
+sc_ck
+);
+
+1231 #ifde
+INET
+
+
+1232 
+s
+ = 
+	`
+();
+
+1233 i(
+	`__edi_l
+(!
+	`pktq_queue
+(
+_pktq
+, 
+m
+, 0))) {
+
+1234 
+sc
+->
+sc_if
+.
+if_s
+++;
+
+1235 
+sc
+->
+sc_if
+.
+if_iqdrs
+++;
+
+1236 
+	`m_m
+(
+m
+);
+
+1238 
+	`lx
+(
+s
+);
+
+1241 
+	`mux_ex
+(
+sot_lock
+);
+
+1242 
+	}
+}
+
+1248 
+	$riol
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+1250 
+iddr
+ *
+i
+ = (idd*)
+da
+;
+
+1251 
+ieq
+ *
+i
+;
+
+1252 
+s
+, 
+r
+ = 0;
+
+1254 
+s
+ = 
+	`
+();
+
+1256 
+cmd
+) {
+
+1258 
+SIOCINITIFADDR
+:
+
+1259 i(
+i
+->
+i_addr
+->
+_my
+ =
+AF_INET
+)
+
+1260 
+i
+->
+if_ags
+ |
+IFF_UP
+;
+
+1262 
+r
+ = 
+EAFNOSUPPORT
+;
+
+1265 
+SIOCSIFDSTADDR
+:
+
+1266 i(
+i
+->
+i_addr
+->
+_my
+ !
+AF_INET
+)
+
+1267 
+r
+ = 
+EAFNOSUPPORT
+;
+
+1270 
+SIOCADDMULTI
+:
+
+1271 
+SIOCDELMULTI
+:
+
+1272 
+i
+ = (
+ieq
+ *)
+da
+;
+
+1273 i(
+i
+ == 0) {
+
+1274 
+r
+ = 
+EAFNOSUPPORT
+;
+
+1277 
+	`ieq_gaddr
+(
+cmd
+, 
+i
+)->
+_my
+) {
+
+1279 #ifde
+INET
+
+
+1280 
+AF_INET
+:
+
+1285 
+r
+ = 
+EAFNOSUPPORT
+;
+
+1291 
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+);
+
+1293 
+	`lx
+(
+s
+);
+
+1294  (
+r
+);
+
+1295 
+	}
+}
+
+1307 
+	$r_adio
+(
+r_soc
+ *
+sc
+, 
+y
+ *
+
+)
+
+1310 
+ych_t
+ 
+InSg
+[] =
+
+1313 
+ych_t
+ 
+InSg
+[] =
+
+1316 
+i
+;
+
+1322 i((
+i
+ = 
+	`b_to_q
+(
+InSg
+, (InSg- 1, &
+
+->
+t_outq
+))) {
+
+1323 
+	`tf
+("adio: %d chdidn'f iy queue\n", 
+i
+);
+
+1326 
+sc
+->
+sc_if
+.
+if_obys
+ +(
+InSg
+) - 1;
+
+1333 
+sc
+->
+sc_e
+ = 
+ST_DEAD
+;
+
+1334 
+	`gbuime
+(&
+sc
+->
+sc_ck
+);
+
+1335 
+sc
+->
+sc_imo
+ = 
+time_cd
+ + 
+STRIP_RESET_INTERVAL
+;
+
+1340 (*
+sc
+->
+sc_yp
+->
+t_roc
+)(
+
+);
+
+1341 
+	}
+}
+
+1355 
+	$r_obadio
+(
+r_soc
+ *
+sc
+, 
+y
+ *
+
+)
+
+1358 
+ovow
+;
+
+1359 c *
+r_ober
+ = "**";
+
+1361 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_DEBUG
+)
+
+1362 
+	`addlog
+("%s:emgobdio\n", 
+sc
+->
+sc_if
+.
+if_xme
+);
+
+1364 
+ovow
+ = 
+	`b_to_q
+((c 
+ych_t
+ *)
+r_ober
+, 2, &
+
+->
+t_outq
+);
+
+1365 i(
+ovow
+ == 0) {
+
+1366 i(
+sc
+->
+sc_if
+.
+if_ags
+ & 
+IFF_DEBUG
+)
+
+1367 
+	`addlog
+("%s:: sentrobeoadio\n",
+
+1368 
+sc
+->
+sc_if
+.
+if_xme
+);
+
+1370 
+sc
+->
+sc_e
+ = 
+ST_PROBE_SENT
+;
+
+1371 
+sc
+->
+sc_imo
+ = 
+time_cd
+ + 
+ST_PROBERESPONSE_INTERVAL
+;
+
+1373 
+	`addlog
+("%s: incompleterobe,ty queue %d bytes overfull\n",
+
+1374 
+sc
+->
+sc_if
+.
+if_xme
+, 
+ovow
+);
+
+1376 
+	}
+}
+
+1379 #ifde
+DEBUG
+
+
+1380 c *
+	gr_ames
+[] = {
+
+1393 
+	$r_timeout
+(*
+x
+)
+
+1395 
+r_soc
+ *
+sc
+ = (r_so*
+x
+;
+
+1396 
+y
+ *
+
+ = 
+sc
+->
+sc_yp
+;
+
+1397 
+s
+;
+
+1399 
+s
+ = 
+	`ty
+();
+
+1400 
+sc
+->
+sc_ags
+ &~
+SC_TIMEOUT
+;
+
+1401 
+	`rt
+(
+
+);
+
+1402 
+	`lx
+(
+s
+);
+
+1403 
+	}
+}
+
+1428 
+	$r_wchdog
+(
+i
+ *
+i
+)
+
+1430 
+r_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+1431 
+y
+ *
+
+ = 
+sc
+->
+sc_yp
+;
+
+1436 i(
+
+ =
+NULL
+)
+
+1439 #ifde
+DEBUG
+
+
+1440 i(
+i
+->
+if_ags
+ & 
+IFF_DEBUG
+)
+
+1441 
+	`addlog
+("\n%s: in watchdog, state %simeout %lld\n",
+
+1442 
+i
+->
+if_xme
+,
+
+1443 ((
+sc
+->
+sc_e
+ < 3) ?
+
+1444 
+r_ames
+[
+sc
+->
+sc_e
+] : "<<illegal state>>",
+
+1445 ()(
+sc
+->
+sc_imo
+ - 
+time_cd
+));
+
+1451 i((
+i
+->
+if_ags
+ & 
+IFF_UP
+=0 || 
+sc
+->
+sc_imo
+ > 
+time_cd
+) {
+
+1452 
+de
+;
+
+1459 
+sc
+->
+sc_e
+) {
+
+1460 
+ST_ALIVE
+:
+
+1465 
+	`r_obadio
+(
+sc
+, sc->
+sc_yp
+);
+
+1466 (*
+
+->
+t_roc
+)(tp);
+
+1469 
+ST_PROBE_SENT
+:
+
+1473 
+	`addlog
+("%s:onswerorobe,esettingadio\n",
+
+1474 
+i
+->
+if_xme
+);
+
+1475 
+	`r_adio
+(
+sc
+, sc->
+sc_yp
+);
+
+1476 
+i
+->
+if_s
+++;
+
+1479 
+ST_DEAD
+:
+
+1485 
+	`addlog
+("%s:adioeset butotesponding, Tryinggain\n",
+
+1486 
+i
+->
+if_xme
+);
+
+1487 
+	`r_adio
+(
+sc
+, sc->
+sc_yp
+);
+
+1488 
+i
+->
+if_s
+++;
+
+1493 
+	`addlog
+("%s: %s %d,esetting\n",
+
+1494 
+sc
+->
+sc_if
+.
+if_xme
+,
+
+1496 
+sc
+->
+sc_e
+);
+
+1497 
+	`r_adio
+(
+sc
+, sc->
+sc_yp
+);
+
+1498 
+sc
+->
+sc_e
+ = 
+ST_DEAD
+;
+
+1502 
+de
+:
+
+1503 
+i
+->
+if_tim
+ = 
+STRIP_WATCHDOG_INTERVAL
+;
+
+1505 
+	}
+}
+
+1521 
+	$r_wck
+(
+r_soc
+ *
+sc
+, 
+u_ch
+ *
+r
+, u_ch *
+d
+)
+
+1523 
+n
+ = 
+r
+ - 
+d
+;
+
+1524 
+u_ch
+ *
+me
+, *
+me_d
+;
+
+1525 
+u_t
+ 
+ckn
+;
+
+1528 i(
+n
+ == 0)  0;
+
+1531 i(
+n
+ >2 && 
+r
+[0] == 'O' &&tr[1] == 'K') {
+
+1532 
+	`tf
+("%s: Radio is back in AT command mode: willeset\n",
+
+1533 
+sc
+->
+sc_if
+.
+if_xme
+);
+
+1534 
+	`FORCE_RESET
+(
+sc
+);
+
+1539 i(*
+r
+ != '*') {
+
+1541 i(
+r
+[0] == 'E' &&tr[1] == 'R' &&tr[2] == 'R' &&tr[3] == '_')
+
+1542 
+	`RecvE_Mesge
+(
+sc
+, 
+NULL
+, 
+r
++4);
+
+1545 
+	`RecvE
+("N*", 
+sc
+);
+
+1546 
+	`addlog
+(" = %d)\n", 
+n
+);
+
+1552 
+r
+++;
+
+1555 
+me
+ = 
+r
+;
+
+1556 
+r
+ < 
+d
+ && *ptr != '*')
+
+1557 
+r
+++;
+
+1560 i(
+r
+ =
+d
+) {
+
+1561 
+	`RecvE
+("Ncd *", 
+sc
+);
+
+1564 
+me_d
+ = 
+r
+++;
+
+1567 i(
+r
+[0] != 'S' ||tr[1] != 'I' ||tr[2] != 'P' ||tr[3] != '0') {
+
+1568 i(
+r
+[0] == 'E' &&tr[1] == 'R' &&tr[2] == 'R' &&
+
+1569 
+r
+[3] == '_') {
+
+1570 *
+me_d
+ = 0;
+
+1571 
+	`RecvE_Mesge
+(
+sc
+, 
+me
+, 
+r
++4);
+
+1573 
+	`RecvE
+("NSRIP key", 
+sc
+);
+
+1576 
+r
+ += 4;
+
+1579 
+r
+ = 
+	`UnStuffDa
+, 
+d
+, 
+sc
+->
+sc_rxbuf
+, 4);
+
+1580 i(
+r
+ == 0) {
+
+1581 
+	`RecvE
+("Ruack (hdr)", 
+sc
+);
+
+1590 
+ckn
+ = ((
+ut16_t
+)
+sc
+->
+sc_rxbuf
+[2] << 8) | sc->sc_rxbuf[3];
+
+1592 #ifde
+DIAGNOSTIC
+
+
+1594 
+	`tf
+("Packet %02x.%02x.%02x.%02x\n",
+
+1595 
+sc
+->
+sc_rxbuf
+[0], sc->sc_rxbuf[1],
+
+1596 
+sc
+->
+sc_rxbuf
+[2], sc->sc_rxbuf[3]);
+
+1597 
+	`tf
+("G %d byack\n", 
+ckn
+);
+
+1602 
+r
+ = 
+	`UnStuffDa
+, 
+d
+, 
+sc
+->
+sc_rxbuf
++4, 
+ckn
+-4);
+
+1603 i(
+r
+ == 0) {
+
+1604 
+	`RecvE
+("Shck", 
+sc
+);
+
+1609 
+	`memy
+(
+sc
+->
+sc_pktt
+, sc->
+sc_rxbuf
+, 
+ckn
+ );
+
+1610  (
+ckn
+);
+
+1611 
+	}
+}
+
+1624 
+	mStuff_Diff
+ = 0x00,
+
+1625 
+	mStuff_DiffZo
+ = 0x40,
+
+1626 
+	mStuff_Same
+ = 0x80,
+
+1627 
+	mStuff_Zo
+ = 0xC0,
+
+1628 
+	mStuff_NoCode
+ = 0xFF,
+
+1630 
+	mStuff_CodeMask
+ = 0xC0,
+
+1631 
+	mStuff_CouMask
+ = 0x3F,
+
+1632 
+	mStuff_MaxCou
+ = 0x3F,
+
+1633 
+	mStuff_Magic
+ = 0x0D
+
+1634 } 
+	tStuffgCode
+;
+
+1652 
+	#StuffDa_FishBlock
+(
+X
+) \
+
+1653 (*
+code_r
+ = (
+X
+^ 
+Stuff_Magic
+, 
+code
+ = 
+Stuff_NoCode
+)
+
+	)
+
+1655 
+u_ch
+*
+
+1656 
+	$StuffDa
+(
+u_ch
+ *
+c
+, 
+u_lg
+ 
+ngth
+, u_ch *
+de
+, u_ch **
+code_r_r
+)
+
+1658 
+u_ch
+ *
+d
+ = 
+c
+ + 
+ngth
+;
+
+1659 
+u_ch
+ *
+code_r
+ = *
+code_r_r
+;
+
+1660 
+u_ch
+ 
+code
+ = 
+Stuff_NoCode
+, 
+cou
+ = 0;
+
+1662 i(!
+ngth
+ (
+de
+);
+
+1664 i(
+code_r
+) {
+
+1665 
+code
+ = (*
+code_r
+ ^ 
+Stuff_Magic
+& 
+Stuff_CodeMask
+;
+
+1666 
+cou
+ = (*
+code_r
+ ^ 
+Stuff_Magic
+& 
+Stuff_CouMask
+;
+
+1669 
+c
+ < 
+d
+) {
+
+1670 
+code
+) {
+
+1674 
+Stuff_NoCode
+:
+
+1675 
+code_r
+ = 
+de
+++;
+
+1676 
+cou
+ = 0;
+
+1678 i(*
+c
+ == 0) {
+
+1679 
+code
+ = 
+Stuff_Zo
+;
+
+1680 
+c
+++;
+
+1682 
+code
+ = 
+Stuff_Same
+;
+
+1683 *
+de
+++ = *
+c
+++ ^ 
+Stuff_Magic
+;
+
+1692 
+Stuff_Zo
+:
+
+1695 i(*
+c
+ == 0) {
+
+1696 
+cou
+++;
+
+1697 
+c
+++;
+
+1699 
+	`StuffDa_FishBlock
+(
+Stuff_Zo
+ + 
+cou
+);
+
+1705 
+Stuff_Same
+:
+
+1707 i((*
+c
+ ^ 
+Stuff_Magic
+=
+code_r
+[1]) {
+
+1708 
+cou
+++;
+
+1709 
+c
+++;
+
+1714 i(
+cou
+) {
+
+1715 
+	`StuffDa_FishBlock
+(
+Stuff_Same
+ + 
+cou
+);
+
+1719 
+code
+ = 
+Stuff_Diff
+;
+
+1721 
+Stuff_Diff
+:
+
+1723 i(*
+c
+ == 0)
+
+1724 
+	`StuffDa_FishBlock
+(
+Stuff_DiffZo
+ + 
+cou
+);
+
+1726 i((*
+c
+ ^ 
+Stuff_Magic
+=
+de
+[-1] && dest[-1] == dest[-2])
+
+1728 
+code
+ +
+cou
+-2;
+
+1729 i(
+code
+ =
+Stuff_Diff
+)
+
+1730 
+code
+ = 
+Stuff_Same
+;
+
+1731 
+	`StuffDa_FishBlock
+(
+code
+);
+
+1732 
+code_r
+ = 
+de
+-2;
+
+1734 
+cou
+ = 2;
+
+1735 
+code
+ = 
+Stuff_Same
+;
+
+1739 *
+de
+++ = *
+c
+ ^ 
+Stuff_Magic
+;
+
+1740 
+cou
+++;
+
+1742 
+c
+++;
+
+1746 i(
+cou
+ =
+Stuff_MaxCou
+)
+
+1747 
+	`StuffDa_FishBlock
+(
+code
+ + 
+cou
+);
+
+1749 i(
+code
+ =
+Stuff_NoCode
+)
+
+1750 *
+code_r_r
+ = 
+NULL
+;
+
+1752 *
+code_r_r
+ = 
+code_r
+;
+
+1753 
+	`StuffDa_FishBlock
+(
+code
+ + 
+cou
+);
+
+1756  (
+de
+);
+
+1757 
+	}
+}
+
+1783 
+u_ch
+*
+
+1784 
+	$UnStuffDa
+(
+u_ch
+ *
+c
+, u_ch *
+d
+, u_ch *
+d
+, 
+u_lg
+ 
+d_ngth
+)
+
+1786 
+u_ch
+ *
+d_d
+ = 
+d
+ + 
+d_ngth
+;
+
+1789 i(!
+c
+ || !
+d
+ || !
+d
+ || !
+d_ngth
+)
+
+1790  (
+NULL
+);
+
+1792 
+c
+ < 
+d
+ && 
+d
+ < 
+d_d
+)
+
+1794 
+cou
+ = (*
+c
+ ^ 
+Stuff_Magic
+& 
+Stuff_CouMask
+;
+
+1795 (*
+c
+ ^ 
+Stuff_Magic
+& 
+Stuff_CodeMask
+)
+
+1797 
+Stuff_Diff
+:
+
+1798 i(
+c
++1+
+cou
+ >
+d
+)
+
+1799  (
+NULL
+);
+
+1802 *
+d
+++ = *++
+c
+ ^ 
+Stuff_Magic
+;
+
+1804 --
+cou
+ >0 && 
+d
+ < 
+d_d
+);
+
+1805 i(
+cou
+ < 0)
+
+1806 
+c
+ += 1;
+
+1808 i(
+cou
+ == 0)
+
+1809 *
+c
+ = 
+Stuff_Same
+ ^ 
+Stuff_Magic
+;
+
+1811 *
+c
+ = (
+Stuff_Diff
+ + 
+cou
+^ 
+Stuff_Magic
+;
+
+1813 
+Stuff_DiffZo
+:
+
+1814 i(
+c
++1+
+cou
+ >
+d
+)
+
+1815  (
+NULL
+);
+
+1818 *
+d
+++ = *++
+c
+ ^ 
+Stuff_Magic
+;
+
+1820 --
+cou
+ >0 && 
+d
+ < 
+d_d
+);
+
+1821 i(
+cou
+ < 0)
+
+1822 *
+c
+ = 
+Stuff_Zo
+ ^ 
+Stuff_Magic
+;
+
+1824 *
+c
+ = (
+Stuff_DiffZo
+ + 
+cou
+^ 
+Stuff_Magic
+;
+
+1826 
+Stuff_Same
+:
+
+1827 i(
+c
++1 >
+d
+)
+
+1828  (
+NULL
+);
+
+1831 *
+d
+++ = 
+c
+[1] ^ 
+Stuff_Magic
+;
+
+1833 --
+cou
+ >0 && 
+d
+ < 
+d_d
+);
+
+1834 i(
+cou
+ < 0)
+
+1835 
+c
+ += 2;
+
+1837 *
+c
+ = (
+Stuff_Same
+ + 
+cou
+^ 
+Stuff_Magic
+;
+
+1839 
+Stuff_Zo
+:
+
+1842 *
+d
+++ = 0;
+
+1844 --
+cou
+ >0 && 
+d
+ < 
+d_d
+);
+
+1845 i(
+cou
+ < 0)
+
+1846 
+c
+ += 1;
+
+1848 *
+c
+ = (
+Stuff_Zo
+ + 
+cou
+^ 
+Stuff_Magic
+;
+
+1853 i(
+d
+ < 
+d_d
+)
+
+1854  (
+NULL
+);
+
+1856  (
+c
+);
+
+1857 
+	}
+}
+
+1866 
+	$RecvE
+(c *
+msg
+, 
+r_soc
+ *
+sc
+)
+
+1868 
+	#MAX_RecE
+ 80
+
+	)
+
+1869 
+u_ch
+ *
+r
+ = 
+sc
+->
+sc_pktt
+;
+
+1870 
+u_ch
+ *
+d
+ = 
+sc
+->
+sc_mp
+;
+
+1871 
+u_ch
+ 
+pkt_xt
+[
+MAX_RecE
+], *
+p
+ =kt_text;
+
+1872 *
+p
+++ = '\"';
+
+1873 
+r
+ < 
+d
+ && 
+p
+ < &
+pkt_xt
+[
+MAX_RecE
+-4]) {
+
+1874 i(*
+r
+ == '\\') {
+
+1875 *
+p
+++ = '\\';
+
+1876 *
+p
+++ = '\\';
+
+1877 } i(*
+r
+ >= 32 && *ptr <= 126)
+
+1878 *
+p
+++ = *
+r
+;
+
+1880 
+	`tf
+(
+p
+, (
+pkt_xt
+) - (p -kt_text),
+
+1881 "\\%02x", *
+r
+);
+
+1882 
+p
+ += 3;
+
+1884 
+r
+++;
+
+1887 i(
+r
+ =
+d
+*
+p
+++ = '\"';
+
+1888 *
+p
+++ = 0;
+
+1889 
+	`addlog
+("%s: %13: %s\n", 
+sc
+->
+sc_if
+.
+if_xme
+, 
+msg
+, 
+pkt_xt
+);
+
+1891 
+sc
+->
+sc_if
+.
+if_s
+++;
+
+1892 
+	}
+}
+
+1899 
+	$RecvE_Mesge
+(
+r_soc
+ *
+r_fo
+, 
+u_ch
+ *
+ndme
+,
+
+1900 c 
+u_ch
+ *
+msg
+)
+
+1902 c 
+ERR_001
+[] = "001";
+
+1903 c 
+ERR_002
+[] = "002";
+
+1904 c 
+ERR_003
+[] = "003";
+
+1905 c 
+ERR_004
+[] = "004";
+
+1906 c 
+ERR_005
+[] = "005";
+
+1907 c 
+ERR_006
+[] = "006";
+
+1908 c 
+ERR_007
+[] = "007";
+
+1909 c 
+ERR_008
+[] = "008";
+
+1910 c 
+ERR_009
+[] = "009";
+
+1912 * 
+if_me
+;
+
+1914 
+if_me
+ = 
+r_fo
+->
+sc_if
+.
+if_xme
+;
+
+1916 i(!
+	`cmp
+(
+msg
+, 
+ERR_001
+, (ERR_001)-1))
+
+1918 
+	`RecvE
+("dir mesge:", 
+r_fo
+);
+
+1919 
+	`addlog
+("%s: Radio %s isot in StarMode\n",
+
+1920 
+if_me
+, 
+ndme
+);
+
+1922 i(!
+	`cmp
+(
+msg
+, 
+ERR_002
+, (ERR_002)-1))
+
+1924 
+	`RecvE
+("dir mesge:", 
+r_fo
+);
+
+1925 #ifde
+ny
+
+
+1926 
+hd
+;
+
+1927 
+u_ch
+ 
+wme
+[64];
+
+1928 
+	`ssnf
+(
+msg
+, "ERR_002 Rem hd &%dm%s", &
+hd
+, 
+wme
+);
+
+1929 
+	`addlog
+("%s: Radioame %s is handle %d\n",
+
+1930 
+if_me
+, 
+wme
+, 
+hd
+);
+
+1933 i(!
+	`cmp
+(
+msg
+, 
+ERR_003
+, (ERR_003)-1))
+
+1935 
+	`RecvE
+("dir mesge:", 
+r_fo
+);
+
+1936 
+	`addlog
+("%s: Deiadimiunknown\n", 
+if_me
+);
+
+1938 i(!
+	`cmp
+(
+msg
+, 
+ERR_004
+, (ERR_004)-1)) {
+
+1943 i(
+r_fo
+->
+sc_if
+.
+if_ags
+ & 
+IFF_DEBUG
+)
+
+1944 
+	`addlog
+("%s:adidedobe\n", 
+if_me
+);
+
+1945 i(
+r_fo
+->
+sc_e
+ =
+ST_DEAD
+) {
+
+1947 
+	`addlog
+("%s: Radiback imode\n", 
+if_me
+);
+
+1949 
+	`CLEAR_RESET_TIMER
+(
+r_fo
+);
+
+1951 i(!
+	`cmp
+(
+msg
+, 
+ERR_005
+, (ERR_005)-1))
+
+1952 
+	`RecvE
+("dir mesge:", 
+r_fo
+);
+
+1953 i(!
+	`cmp
+(
+msg
+, 
+ERR_006
+, (ERR_006)-1))
+
+1954 
+	`RecvE
+("dir mesge:", 
+r_fo
+);
+
+1955 i(!
+	`cmp
+(
+msg
+, 
+ERR_007
+, (ERR_007)-1))
+
+1961 
+	`RecvE
+("dir mesge:", 
+r_fo
+);
+
+1962 
+	`tf
+("%s: Error! Packet sizeoo big foradio.",
+
+1963 
+if_me
+);
+
+1964 
+	`FORCE_RESET
+(
+r_fo
+);
+
+1966 i(!
+	`cmp
+(
+msg
+, 
+ERR_008
+, (ERR_008)-1))
+
+1968 
+	`RecvE
+("dir mesge:", 
+r_fo
+);
+
+1969 
+	`tf
+("%s: Radioame contains illegal character\n",
+
+1970 
+if_me
+);
+
+1972 i(!
+	`cmp
+(
+msg
+, 
+ERR_009
+, (ERR_009)-1))
+
+1973 
+	`RecvE
+("dir mesge:", 
+r_fo
+);
+
+1975 
+	`addlog
+("edr ]%3s[\n", 
+msg
+);
+
+1976 
+	`RecvE
+("udadir mesge:", 
+r_fo
+);
+
+1978 
+	}
+}
+
+	@if_stripvar.h
+
+3 #ide
+_NET_IF_STRIPVAR_H_
+
+
+4 
+	#_NET_IF_STRIPVAR_H_
+
+
+	)
+
+9 
+	sr_soc
+ {
+
+10 
+i
+ 
+	msc_if
+;
+
+11 
+	msc_un
+;
+
+12 
+ifqueue
+ 
+	msc_q
+;
+
+13 
+ifqueue
+ 
+	msc_q
+;
+
+14 
+y
+ *
+	msc_yp
+;
+
+15 
+out
+ 
+	msc_timo_ch
+;
+
+16 
+u_ch
+ *
+	msc_mp
+;
+
+17 
+u_ch
+ *
+	msc_
+;
+
+18 
+u_ch
+ *
+	msc_pktt
+;
+
+19 
+mbuf
+ *
+	msc_mbuf
+;
+
+20 
+u_ch
+ *
+	msc_rxbuf
+;
+
+21 
+u_ch
+ *
+	msc_txbuf
+;
+
+22 
+u_t
+ 
+	msc_ags
+;
+
+23 
+	msc_oqn
+;
+
+24 
+	msc_imeout
+;
+
+25 *
+	msc_si
+;
+
+26 #ifde
+__NBSD__
+
+
+27 
+	msc_dbufsize
+;
+
+28 
+	msc_dbufqu
+;
+
+30 #ifde
+INET
+
+
+31 
+comess
+ 
+	msc_comp
+;
+
+34 
+	msc_e
+;
+
+35 
+	#ST_ALIVE
+ 0x0
+
+	)
+
+36 
+	#ST_PROBE_SENT
+ 0x1
+
+	)
+
+37 
+	#ST_DEAD
+ 0x2
+
+	)
+
+39 
+	msc_imo
+;
+
+41 
+btime
+ 
+	msc_ck
+;
+
+42 
+LIST_ENTRY
+(
+r_soc
+
+	msc_ii
+;
+
+47 
+	#SC_ERROR
+ 0x0001
+
+	)
+
+49 
+	#SC_TIMEOUT
+ 0x00000400
+
+	)
+
+52 
+	#SC_COMPRESS
+ 
+IFF_LINK0
+
+
+	)
+
+53 
+	#SC_NOICMP
+ 
+IFF_LINK1
+
+
+	)
+
+54 
+	#SC_AUTOCOMP
+ 
+IFF_LINK2
+
+
+	)
+
+56 #ifde
+_KERNEL
+
+
+57 
+rch
+();
+
+	@if_tap.c
+
+35 
+	~<sys/cdefs.h
+>
+
+36 
+__KERNEL_RCSID
+(0, "$NetBSD: if_tap.c,v 1.81 2014/12/17 09:41:30 ozaki-r Exp $");
+
+38 #i
+defed
+(
+_KERNEL_OPT
+)
+
+40 
+	~"t_modur.h
+"
+
+41 
+	~"t_comt_tbsd.h
+"
+
+44 
+	~<sys/m.h
+>
+
+45 
+	~<sys/sym.h
+>
+
+46 
+	~<sys/kl.h
+>
+
+47 
+	~<sys/mloc.h
+>
+
+48 
+	~<sys/cf.h
+>
+
+49 
+	~<sys/g.h
+>
+
+50 
+	~<sys/devi.h
+>
+
+51 
+	~<sys/fe.h
+>
+
+52 
+	~<sys/fedesc.h
+>
+
+53 
+	~<sys/pl.h
+>
+
+54 
+	~<sys/oc.h
+>
+
+55 
+	~<sys/.h
+>
+
+56 
+	~<sys/sockio.h
+>
+
+57 #i
+defed
+(
+COMPAT_40
+|| defed(
+MODULAR
+)
+
+58 
+	~<sys/sysl.h
+>
+
+60 
+	~<sys/kauth.h
+>
+
+61 
+	~<sys/mux.h
+>
+
+62 
+	~<sys/.h
+>
+
+63 
+	~<sys/.h
+>
+
+65 
+	~<t/if.h
+>
+
+66 
+	~<t/if_dl.h
+>
+
+67 
+	~<t/if_h.h
+>
+
+68 
+	~<t/if_med.h
+>
+
+69 
+	~<t/if_p.h
+>
+
+70 
+	~<t/bpf.h
+>
+
+72 
+	~<comt/sys/sockio.h
+>
+
+74 #i
+defed
+(
+COMPAT_40
+|| defed(
+MODULAR
+)
+
+89 
+	gp_node
+;
+
+90 
+p_sysl_hdr
+(
+SYSCTLFN_PROTO
+);
+
+91 
+SYSCTL_SETUP_PROTO
+(
+sysl_p_tup
+);
+
+101 
+	sp_soc
+ {
+
+102 
+devi_t
+ 
+	msc_dev
+;
+
+103 
+ifmed
+ 
+	msc_im
+;
+
+104 
+hcom
+ 
+	msc_ec
+;
+
+105 
+	msc_ags
+;
+
+106 
+	#TAP_INUSE
+ 0x00000001
+
+	)
+
+107 
+	#TAP_ASYNCIO
+ 0x00000002
+
+	)
+
+108 
+	#TAP_NBIO
+ 0x00000004
+
+	)
+
+109 
+	#TAP_GOING
+ 0x00000008
+
+	)
+
+110 
+lfo
+ 
+	msc_rl
+;
+
+111 
+pid_t
+ 
+	msc_pgid
+;
+
+112 
+kmux_t
+ 
+	msc_rdlock
+;
+
+113 
+kmux_t
+ 
+	msc_kqlock
+;
+
+114 *
+	msc_sih
+;
+
+115 
+timeec
+ 
+	msc_ime
+;
+
+116 
+timeec
+ 
+	msc_mtime
+;
+
+117 
+timeec
+ 
+	msc_btime
+;
+
+122 
+ach
+();
+
+124 
+p_mch
+(
+devi_t
+, 
+cfda_t
+, *);
+
+125 
+p_ch
+(
+devi_t
+, device_t, *);
+
+126 
+p_dach
+(
+devi_t
+, );
+
+128 
+CFATTACH_DECL_NEW
+(
+p
+, (
+p_soc
+),
+
+129 
+p_mch
+, 
+p_ch
+, 
+p_dach
+, 
+NULL
+);
+
+130 
+cfdriv
+ 
+p_cd
+;
+
+133 
+p_dev_o
+(
+p_soc
+ *);
+
+134 
+p_dev_ad
+(, 
+uio
+ *, );
+
+135 
+p_dev_wre
+(, 
+uio
+ *, );
+
+136 
+p_dev_iol
+(, 
+u_lg
+, *, 
+lwp
+ *);
+
+137 
+p_dev_pl
+(, , 
+lwp
+ *);
+
+138 
+p_dev_kqfr
+(, 
+kne
+ *);
+
+141 
+p_fs_o
+(
+fe_t
+ *);
+
+142 
+p_fs_ad
+(
+fe_t
+ *, 
+off_t
+ *, 
+uio
+ *,
+
+143 
+kauth_ed_t
+, );
+
+144 
+p_fs_wre
+(
+fe_t
+ *, 
+off_t
+ *, 
+uio
+ *,
+
+145 
+kauth_ed_t
+, );
+
+146 
+p_fs_iol
+(
+fe_t
+ *, 
+u_lg
+, *);
+
+147 
+p_fs_pl
+(
+fe_t
+ *, );
+
+148 
+p_fs_
+(
+fe_t
+ *, 
+
+ *);
+
+149 
+p_fs_kqfr
+(
+fe_t
+ *, 
+kne
+ *);
+
+151 c 
+fes
+ 
+	gp_fes
+ = {
+
+152 .
+fo_ad
+ = 
+p_fs_ad
+,
+
+153 .
+	gfo_wre
+ = 
+p_fs_wre
+,
+
+154 .
+	gfo_iol
+ = 
+p_fs_iol
+,
+
+155 .
+	gfo_f
+ = 
+u_f
+,
+
+156 .
+	gfo_pl
+ = 
+p_fs_pl
+,
+
+157 .
+	gfo_
+ = 
+p_fs_
+,
+
+158 .
+	gfo_o
+ = 
+p_fs_o
+,
+
+159 .
+	gfo_kqfr
+ = 
+p_fs_kqfr
+,
+
+160 .
+	gfo_t
+ = 
+u_t
+,
+
+164 
+p_dev_
+(
+lwp
+ *);
+
+167 
+p_cdev_
+(
+dev_t
+, , , 
+lwp
+ *);
+
+168 
+p_cdev_o
+(
+dev_t
+, , , 
+lwp
+ *);
+
+169 
+p_cdev_ad
+(
+dev_t
+, 
+uio
+ *, );
+
+170 
+p_cdev_wre
+(
+dev_t
+, 
+uio
+ *, );
+
+171 
+p_cdev_iol
+(
+dev_t
+, 
+u_lg
+, *, , 
+lwp
+ *);
+
+172 
+p_cdev_pl
+(
+dev_t
+, , 
+lwp
+ *);
+
+173 
+p_cdev_kqfr
+(
+dev_t
+, 
+kne
+ *);
+
+175 c 
+cdevsw
+ 
+	gp_cdevsw
+ = {
+
+176 .
+d_
+ = 
+p_cdev_
+,
+
+177 .
+	gd_o
+ = 
+p_cdev_o
+,
+
+178 .
+	gd_ad
+ = 
+p_cdev_ad
+,
+
+179 .
+	gd_wre
+ = 
+p_cdev_wre
+,
+
+180 .
+	gd_iol
+ = 
+p_cdev_iol
+,
+
+181 .
+	gd_
+ = 
+no
+,
+
+182 .
+	gd_y
+ = 
+nty
+,
+
+183 .
+	gd_pl
+ = 
+p_cdev_pl
+,
+
+184 .
+	gd_mm
+ = 
+nomm
+,
+
+185 .
+	gd_kqfr
+ = 
+p_cdev_kqfr
+,
+
+186 .
+	gd_disrd
+ = 
+nodisrd
+,
+
+187 .
+	gd_ag
+ = 
+D_OTHER
+
+
+190 
+	#TAP_CLONER
+ 0xffff
+
+	)
+
+193 
+p_kqdach
+(
+kne
+ *);
+
+194 
+p_kqad
+(
+kne
+ *, );
+
+200 
+p_medchge
+(
+i
+ *);
+
+201 
+p_medus
+(
+i
+ *, 
+ifmedq
+ *);
+
+209 
+p_t
+(
+i
+ *);
+
+210 
+p_
+(
+i
+ *, );
+
+211 
+p_
+(
+i
+ *);
+
+212 
+p_iol
+(
+i
+ *, 
+u_lg
+, *);
+
+215 #i
+defed
+(
+COMPAT_40
+|| defed(
+MODULAR
+)
+
+216 
+p_liddr
+(
+i
+ *, 
+u_lg
+, 
+ileq
+ *);
+
+218 
+p_so
+(*);
+
+226 
+p_e_
+(
+if_e
+ *, );
+
+227 
+p_e_deroy
+(
+i
+ *);
+
+229 
+if_e
+ 
+	gp_s
+ = 
+IF_CLONE_INITIALIZER
+("tap",
+
+230 
+p_e_
+,
+
+231 
+p_e_deroy
+);
+
+234 
+p_soc
+ * 
+p_e_t
+();
+
+235 
+p_e_deroy
+(
+devi_t
+);
+
+238 
+	$ach
+(
+n
+)
+
+240 
+r
+;
+
+242 
+r
+ = 
+	`cfig_cach_ch
+(
+p_cd
+.
+cd_me
+, &
+p_
+);
+
+243 i(
+r
+) {
+
+244 
+	`rt_r
+("%s: unableoegister cfattach\n",
+
+245 
+p_cd
+.
+cd_me
+);
+
+246 ()
+	`cfig_cfdriv_dach
+(&
+p_cd
+);
+
+250 
+	`if_e_ch
+(&
+p_s
+);
+
+251 
+	}
+}
+
+255 
+	$p_mch
+(
+devi_t
+ 
+
+, 
+cfda_t
+ 
+cfda
+, *
+g
+)
+
+259 
+	}
+}
+
+262 
+	$p_ch
+(
+devi_t
+ 
+
+, devi_
+lf
+, *
+aux
+)
+
+264 
+p_soc
+ *
+sc
+ = 
+	`devi_ive
+(
+lf
+);
+
+265 
+i
+ *
+i
+;
+
+266 #i
+	`defed
+(
+COMPAT_40
+|| defed(
+MODULAR
+)
+
+267 c 
+sysode
+ *
+node
+;
+
+268 
+r
+;
+
+270 
+ut8_t
+ 
+addr
+[
+ETHER_ADDR_LEN
+] =
+
+272 
+addrr
+[3 * 
+ETHER_ADDR_LEN
+];
+
+274 
+sc
+->
+sc_dev
+ = 
+lf
+;
+
+275 
+sc
+->
+sc_sih
+ = 
+NULL
+;
+
+276 
+	`gnime
+(&
+sc
+->
+sc_btime
+);
+
+277 
+sc
+->
+sc_ime
+ = sc->
+sc_mtime
+ = sc->
+sc_btime
+;
+
+278 
+sc
+->
+sc_ags
+ = 0;
+
+279 
+	`l
+(&
+sc
+->
+sc_rl
+);
+
+295 
+	`mux_
+(&
+sc
+->
+sc_rdlock
+, 
+MUTEX_DEFAULT
+, 
+IPL_NONE
+);
+
+296 
+	`mux_
+(&
+sc
+->
+sc_kqlock
+, 
+MUTEX_DEFAULT
+, 
+IPL_VM
+);
+
+298 i(!
+	`pmf_devi_gi
+(
+lf
+, 
+NULL
+, NULL))
+
+299 
+	`rt_r_dev
+(
+lf
+, "couldn'tstablishower handler\n");
+
+306 
+	`g_
+(&
+addr
+[3], 3);
+
+308 
+	`rt_vbo_dev
+(
+lf
+, "Ethernetddress %s\n",
+
+309 
+	`h_tf
+(
+addrr
+, ddrr), 
+addr
+));
+
+318 
+	`ifmed_
+(&
+sc
+->
+sc_im
+, 0, 
+p_medchge
+, 
+p_medus
+);
+
+319 
+	`ifmed_add
+(&
+sc
+->
+sc_im
+, 
+IFM_ETHER
+|
+IFM_1000_T
+, 0, 
+NULL
+);
+
+320 
+	`ifmed_add
+(&
+sc
+->
+sc_im
+, 
+IFM_ETHER
+|
+IFM_1000_T
+|
+IFM_FDX
+, 0, 
+NULL
+);
+
+321 
+	`ifmed_add
+(&
+sc
+->
+sc_im
+, 
+IFM_ETHER
+|
+IFM_100_TX
+, 0, 
+NULL
+);
+
+322 
+	`ifmed_add
+(&
+sc
+->
+sc_im
+, 
+IFM_ETHER
+|
+IFM_100_TX
+|
+IFM_FDX
+, 0, 
+NULL
+);
+
+323 
+	`ifmed_add
+(&
+sc
+->
+sc_im
+, 
+IFM_ETHER
+|
+IFM_10_T
+, 0, 
+NULL
+);
+
+324 
+	`ifmed_add
+(&
+sc
+->
+sc_im
+, 
+IFM_ETHER
+|
+IFM_10_T
+|
+IFM_FDX
+, 0, 
+NULL
+);
+
+325 
+	`ifmed_add
+(&
+sc
+->
+sc_im
+, 
+IFM_ETHER
+|
+IFM_AUTO
+, 0, 
+NULL
+);
+
+326 
+	`ifmed_t
+(&
+sc
+->
+sc_im
+, 
+IFM_ETHER
+|
+IFM_AUTO
+);
+
+332 
+i
+ = &
+sc
+->
+sc_ec
+.
+ec_if
+;
+
+333 
+	`ry
+(
+i
+->
+if_xme
+, 
+	`devi_xme
+(
+lf
+));
+
+334 
+i
+->
+if_soc
+ = 
+sc
+;
+
+335 
+i
+->
+if_ags
+ = 
+IFF_BROADCAST
+ | 
+IFF_SIMPLEX
+ | 
+IFF_MULTICAST
+;
+
+336 
+i
+->
+if_iol
+ = 
+p_iol
+;
+
+337 
+i
+->
+if_t
+ = 
+p_t
+;
+
+338 
+i
+->
+if_
+ = 
+p_
+;
+
+339 
+i
+->
+if_
+ = 
+p_
+;
+
+340 
+	`IFQ_SET_READY
+(&
+i
+->
+if_d
+);
+
+342 
+sc
+->
+sc_ec
+.
+ec_bs
+ = 
+ETHERCAP_VLAN_MTU
+ | 
+ETHERCAP_JUMBO_MTU
+;
+
+345 
+	`if_lize
+(
+i
+);
+
+346 
+	`h_iach
+(
+i
+, 
+addr
+);
+
+347 
+	`if_gi
+(
+i
+);
+
+349 #i
+	`defed
+(
+COMPAT_40
+|| defed(
+MODULAR
+)
+
+364 i((
+r
+ = 
+	`sysl_v
+(
+NULL
+, 0, NULL,
+
+365 &
+node
+, 
+CTLFLAG_READWRITE
+,
+
+366 
+CTLTYPE_STRING
+, 
+	`devi_xme
+(
+lf
+), 
+NULL
+,
+
+367 
+p_sysl_hdr
+, 0, (*)
+sc
+, 18,
+
+368 
+CTL_NET
+, 
+AF_LINK
+, 
+p_node
+, 
+	`devi_un
+(
+sc
+->
+sc_dev
+),
+
+369 
+CTL_EOL
+)) != 0)
+
+370 
+	`rt_r_dev
+(
+lf
+, "sysctl_createveturned %d, ignoring\n",
+
+371 
+r
+);
+
+373 
+	}
+}
+
+380 
+	$p_dach
+(
+devi_t
+ 
+lf
+, 
+ags
+)
+
+382 
+p_soc
+ *
+sc
+ = 
+	`devi_ive
+(
+lf
+);
+
+383 
+i
+ *
+i
+ = &
+sc
+->
+sc_ec
+.
+ec_if
+;
+
+384 #i
+	`defed
+(
+COMPAT_40
+|| defed(
+MODULAR
+)
+
+385 
+r
+;
+
+387 
+s
+;
+
+389 
+sc
+->
+sc_ags
+ |
+TAP_GOING
+;
+
+390 
+s
+ = 
+	`
+();
+
+391 
+	`p_
+(
+i
+, 1);
+
+392 
+	`if_down
+(
+i
+);
+
+393 
+	`lx
+(
+s
+);
+
+395 i(
+sc
+->
+sc_sih
+ !
+NULL
+) {
+
+396 
+	`sot_diablish
+(
+sc
+->
+sc_sih
+);
+
+397 
+sc
+->
+sc_sih
+ = 
+NULL
+;
+
+400 #i
+	`defed
+(
+COMPAT_40
+|| defed(
+MODULAR
+)
+
+406 i((
+r
+ = 
+	`sysl_deroyv
+(
+NULL
+, 
+CTL_NET
+, 
+AF_LINK
+, 
+p_node
+,
+
+407 
+	`devi_un
+(
+sc
+->
+sc_dev
+), 
+CTL_EOL
+)) != 0)
+
+408 
+	`rt_r_dev
+(
+lf
+,
+
+409 "sysl_deroyvued %d, igng\n", 
+r
+);
+
+411 
+	`h_ifdach
+(
+i
+);
+
+412 
+	`if_dach
+(
+i
+);
+
+413 
+	`ifmed_de_
+(&
+sc
+->
+sc_im
+, 
+IFM_INST_ANY
+);
+
+414 
+	`lderoy
+(&
+sc
+->
+sc_rl
+);
+
+415 
+	`mux_deroy
+(&
+sc
+->
+sc_rdlock
+);
+
+416 
+	`mux_deroy
+(&
+sc
+->
+sc_kqlock
+);
+
+418 
+	`pmf_devi_degi
+(
+lf
+);
+
+421 
+	}
+}
+
+429 
+	$p_medchge
+(
+i
+ *
+i
+)
+
+432 
+	}
+}
+
+438 
+	$p_medus
+(
+i
+ *
+i
+, 
+ifmedq
+ *
+imr
+)
+
+440 
+p_soc
+ *
+sc
+ = (p_so*)
+i
+->
+if_soc
+;
+
+441 
+imr
+->
+ifm_aive
+ = 
+sc
+->
+sc_im
+.
+ifm_cur
+->
+ifm_med
+;
+
+442 
+	}
+}
+
+472 
+	$p_t
+(
+i
+ *
+i
+)
+
+474 
+p_soc
+ *
+sc
+ = (p_so*)
+i
+->
+if_soc
+;
+
+475 
+mbuf
+ *
+m0
+;
+
+477 i((
+sc
+->
+sc_ags
+ & 
+TAP_INUSE
+) == 0) {
+
+480 
+	`IFQ_DEQUEUE
+(&
+i
+->
+if_d
+, 
+m0
+);
+
+481 i(
+m0
+ =
+NULL
+)
+
+484 
+i
+->
+if_acks
+++;
+
+485 
+	`bpf_mp
+(
+i
+, 
+m0
+);
+
+487 
+	`m_m
+(
+m0
+);
+
+489 } i(!
+	`IFQ_IS_EMPTY
+(&
+i
+->
+if_d
+)) {
+
+490 
+i
+->
+if_ags
+ |
+IFF_OACTIVE
+;
+
+491 
+	`wakeup
+(
+sc
+);
+
+492 
+	`ify
+(&
+sc
+->
+sc_rl
+, 0, 1);
+
+493 i(
+sc
+->
+sc_ags
+ & 
+TAP_ASYNCIO
+)
+
+494 
+	`sot_schedu
+(
+sc
+->
+sc_sih
+);
+
+496 
+	}
+}
+
+499 
+	$p_so
+(*
+cook
+)
+
+501 
+p_soc
+ *
+sc
+;
+
+502 
+i
+ *
+i
+;
+
+503 
+a
+, 
+b
+;
+
+505 
+sc
+ = 
+cook
+;
+
+507 i(
+sc
+->
+sc_ags
+ & 
+TAP_ASYNCIO
+) {
+
+508 
+i
+ = &
+sc
+->
+sc_ec
+.
+ec_if
+;
+
+509 i(
+i
+->
+if_ags
+ & 
+IFF_RUNNING
+) {
+
+510 
+a
+ = 
+POLL_IN
+;
+
+511 
+b
+ = 
+POLLIN
+|
+POLLRDNORM
+;
+
+513 
+a
+ = 
+POLL_HUP
+;
+
+514 
+b
+ = 0;
+
+516 
+	`fownsigl
+(
+sc
+->
+sc_pgid
+, 
+SIGIO
+, 
+a
+, 
+b
+, 
+NULL
+);
+
+518 
+	}
+}
+
+530 
+	$p_iol
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+532 
+p_soc
+ *
+sc
+ = (p_so*)
+i
+->
+if_soc
+;
+
+533 
+ieq
+ *
+i
+ = (ieq *)
+da
+;
+
+534 
+s
+, 
+r
+;
+
+536 
+s
+ = 
+	`
+();
+
+538 
+cmd
+) {
+
+539 #ifde
+OSIOCSIFMEDIA
+
+
+540 
+OSIOCSIFMEDIA
+:
+
+542 
+SIOCSIFMEDIA
+:
+
+543 
+SIOCGIFMEDIA
+:
+
+544 
+r
+ = 
+	`ifmed_iol
+(
+i
+, 
+i
+, &
+sc
+->
+sc_im
+, 
+cmd
+);
+
+546 #i
+	`defed
+(
+COMPAT_40
+|| defed(
+MODULAR
+)
+
+547 
+SIOCSIFPHYADDR
+:
+
+548 
+r
+ = 
+	`p_liddr
+(
+i
+, 
+cmd
+, (
+ileq
+ *)
+da
+);
+
+552 
+r
+ = 
+	`h_iol
+(
+i
+, 
+cmd
+, 
+da
+);
+
+553 i(
+r
+ =
+ENETRESET
+)
+
+554 
+r
+ = 0;
+
+558 
+	`lx
+(
+s
+);
+
+560  (
+r
+);
+
+561 
+	}
+}
+
+563 #i
+defed
+(
+COMPAT_40
+|| defed(
+MODULAR
+)
+
+569 
+	$p_liddr
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, 
+ileq
+ *
+ia
+)
+
+571 c 
+sockaddr
+ *
+
+ = &
+ia
+->
+ia_addr
+;
+
+573 i(
+
+->
+_my
+ !
+AF_LINK
+)
+
+574  (
+EINVAL
+);
+
+576 
+	`if_t_dl
+(
+i
+, 
+
+->
+_da
+, 
+ETHER_ADDR_LEN
+, 
+l
+);
+
+579 
+	}
+}
+
+588 
+	$p_
+(
+i
+ *
+i
+)
+
+590 
+	`rt_r
+("\n\n\n\n\nap_init \n\n\n\n\n");
+
+591 
+i
+->
+if_ags
+ |
+IFF_RUNNING
+;
+
+593 
+	`p_t
+(
+i
+);
+
+596 
+	}
+}
+
+607 
+	$p_
+(
+i
+ *
+i
+, 
+dib
+)
+
+609 
+p_soc
+ *
+sc
+ = (p_so*)
+i
+->
+if_soc
+;
+
+611 
+i
+->
+if_ags
+ &~
+IFF_RUNNING
+;
+
+612 
+	`wakeup
+(
+sc
+);
+
+613 
+	`ify
+(&
+sc
+->
+sc_rl
+, 0, 1);
+
+614 i(
+sc
+->
+sc_ags
+ & 
+TAP_ASYNCIO
+)
+
+615 
+	`sot_schedu
+(
+sc
+->
+sc_sih
+);
+
+616 
+	}
+}
+
+626 
+	$p_e_
+(
+if_e
+ *
+ifc
+, 
+un
+)
+
+628 i(
+	`p_e_t
+(
+un
+=
+NULL
+) {
+
+629 
+	`rt_r
+("%s%d: unableottachn instance\n",
+
+630 
+p_cd
+.
+cd_me
+, 
+un
+);
+
+631  (
+ENXIO
+);
+
+635 
+	}
+}
+
+644 
+p_soc
+ *
+
+645 
+	$p_e_t
+(
+un
+)
+
+647 
+cfda
+ *
+cf
+;
+
+649 
+cf
+ = 
+	`mloc
+((*cf), 
+M_DEVBUF
+, 
+M_WAITOK
+);
+
+650 
+cf
+->
+cf_me
+ = 
+p_cd
+.
+cd_me
+;
+
+651 
+cf
+->
+cf_me
+ = 
+p_
+.
+_me
+;
+
+652 i(
+un
+ == -1) {
+
+654 
+cf
+->
+cf_un
+ = 0;
+
+655 
+cf
+->
+cf_fe
+ = 
+FSTATE_STAR
+;
+
+657 
+cf
+->
+cf_un
+ = 
+un
+;
+
+658 
+cf
+->
+cf_fe
+ = 
+FSTATE_NOTFOUND
+;
+
+661  
+	`devi_ive
+(
+	`cfig_ch_pudo
+(
+cf
+));
+
+662 
+	}
+}
+
+670 
+	$p_e_deroy
+(
+i
+ *
+i
+)
+
+672 
+p_soc
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+674  
+	`p_e_deroy
+(
+sc
+->
+sc_dev
+);
+
+675 
+	}
+}
+
+678 
+	$p_e_deroy
+(
+devi_t
+ 
+dev
+)
+
+680 
+cfda_t
+ 
+cf
+ = 
+	`devi_cfda
+(
+dev
+);
+
+681 
+r
+;
+
+683 i((
+r
+ = 
+	`cfig_dach
+(
+dev
+, 0)) != 0)
+
+684 
+	`rt_r_dev
+(
+dev
+, "unableo detach instance\n");
+
+685 
+	`
+(
+cf
+, 
+M_DEVBUF
+);
+
+687  (
+r
+);
+
+688 
+	}
+}
+
+713 
+	$p_cdev_
+(
+dev_t
+ 
+dev
+, 
+ags
+, 
+fmt
+, 
+lwp
+ *
+l
+)
+
+715 
+p_soc
+ *
+sc
+;
+
+717 i(
+	`m
+(
+dev
+=
+TAP_CLONER
+)
+
+718  
+	`p_dev_
+(
+l
+);
+
+720 
+sc
+ = 
+	`devi_lookup_ive
+(&
+p_cd
+, 
+	`m
+(
+dev
+));
+
+721 i(
+sc
+ =
+NULL
+)
+
+722  (
+ENXIO
+);
+
+725 i(
+sc
+->
+sc_ags
+ & 
+TAP_INUSE
+)
+
+726  (
+EBUSY
+);
+
+727 
+sc
+->
+sc_ags
+ |
+TAP_INUSE
+;
+
+729 
+	}
+}
+
+754 
+	$p_dev_
+(
+lwp
+ *
+l
+)
+
+756 
+p_soc
+ *
+sc
+;
+
+757 
+fe_t
+ *
+
+;
+
+758 
+r
+, 
+fd
+;
+
+760 i((
+r
+ = 
+	`fd_locfe
+(&
+
+, &
+fd
+)) != 0)
+
+761  (
+r
+);
+
+763 i((
+sc
+ = 
+	`p_e_t
+(-1)=
+NULL
+) {
+
+764 
+	`fd_abt
+(
+curoc
+, 
+
+, 
+fd
+);
+
+765  (
+ENXIO
+);
+
+768 
+sc
+->
+sc_ags
+ |
+TAP_INUSE
+;
+
+770  
+	`fd_e
+(
+
+, 
+fd
+, 
+FREAD
+|
+FWRITE
+, &
+p_fes
+,
+
+771 (*)(
+_t
+)
+	`devi_un
+(
+sc
+->
+sc_dev
+));
+
+772 
+	}
+}
+
+785 
+	$p_cdev_o
+(
+dev_t
+ 
+dev
+, 
+ags
+, 
+fmt
+,
+
+786 
+lwp
+ *
+l
+)
+
+788 
+p_soc
+ *
+sc
+ =
+
+789 
+	`devi_lookup_ive
+(&
+p_cd
+, 
+	`m
+(
+dev
+));
+
+791 i(
+sc
+ =
+NULL
+)
+
+792  (
+ENXIO
+);
+
+794  
+	`p_dev_o
+(
+sc
+);
+
+795 
+	}
+}
+
+804 
+	$p_fs_o
+(
+fe_t
+ *
+
+)
+
+806 
+un
+ = 
+
+->
+f_devun
+;
+
+807 
+p_soc
+ *
+sc
+;
+
+808 
+r
+;
+
+810 
+sc
+ = 
+	`devi_lookup_ive
+(&
+p_cd
+, 
+un
+);
+
+811 i(
+sc
+ =
+NULL
+)
+
+812  (
+ENXIO
+);
+
+816 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+817 i((
+r
+ = 
+	`p_dev_o
+(
+sc
+)) != 0) {
+
+818 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+819  (
+r
+);
+
+824 i((
+sc
+->
+sc_ags
+ & 
+TAP_GOING
+) != 0) {
+
+825 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+829 
+r
+ = 
+	`p_e_deroy
+(
+sc
+->
+sc_dev
+);
+
+830 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+831  
+r
+;
+
+832 
+	}
+}
+
+835 
+	$p_dev_o
+(
+p_soc
+ *
+sc
+)
+
+837 
+i
+ *
+i
+;
+
+838 
+s
+;
+
+840 
+s
+ = 
+	`
+();
+
+842 
+i
+ = &
+sc
+->
+sc_ec
+.
+ec_if
+;
+
+843 
+i
+->
+if_ags
+ &~
+IFF_OACTIVE
+;
+
+846 i(!(
+	`IFQ_IS_EMPTY
+(&
+i
+->
+if_d
+))) {
+
+847 
+mbuf
+ *
+m
+;
+
+850 
+	`IFQ_DEQUEUE
+(&
+i
+->
+if_d
+, 
+m
+);
+
+851 i(
+m
+ =
+NULL
+)
+
+854 
+i
+->
+if_acks
+++;
+
+855 
+	`bpf_mp
+(
+i
+, 
+m
+);
+
+856 
+	`m_m
+(
+m
+);
+
+859 
+	`lx
+(
+s
+);
+
+861 i(
+sc
+->
+sc_sih
+ !
+NULL
+) {
+
+862 
+	`sot_diablish
+(
+sc
+->
+sc_sih
+);
+
+863 
+sc
+->
+sc_sih
+ = 
+NULL
+;
+
+865 
+sc
+->
+sc_ags
+ &~(
+TAP_INUSE
+ | 
+TAP_ASYNCIO
+);
+
+868 
+	}
+}
+
+871 
+	$p_cdev_ad
+(
+dev_t
+ 
+dev
+, 
+uio
+ *uio, 
+ags
+)
+
+873  
+	`p_dev_ad
+(
+	`m
+(
+dev
+), 
+uio
+, 
+ags
+);
+
+874 
+	}
+}
+
+877 
+	$p_fs_ad
+(
+fe_t
+ *
+
+, 
+off_t
+ *
+of
+, 
+uio
+ *uio,
+
+878 
+kauth_ed_t
+ 
+ed
+, 
+ags
+)
+
+880 
+r
+;
+
+882 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+883 
+r
+ = 
+	`p_dev_ad
+(
+
+->
+f_devun
+, 
+uio
+, 
+ags
+);
+
+884 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+885  
+r
+;
+
+886 
+	}
+}
+
+889 
+	$p_dev_ad
+(
+un
+, 
+uio
+ *uio, 
+ags
+)
+
+891 
+p_soc
+ *
+sc
+ = 
+	`devi_lookup_ive
+(&
+p_cd
+, 
+un
+);
+
+892 
+i
+ *
+i
+;
+
+893 
+mbuf
+ *
+m
+, *
+n
+;
+
+894 
+r
+ = 0, 
+s
+;
+
+896 i(
+sc
+ =
+NULL
+)
+
+897  (
+ENXIO
+);
+
+899 
+	`gnime
+(&
+sc
+->
+sc_ime
+);
+
+901 
+i
+ = &
+sc
+->
+sc_ec
+.
+ec_if
+;
+
+902 i((
+i
+->
+if_ags
+ & 
+IFF_UP
+) == 0)
+
+903  (
+EHOSTDOWN
+);
+
+908 i((
+sc
+->
+sc_ags
+ & 
+TAP_NBIO
+) != 0) {
+
+909 i(!
+	`mux_yr
+(&
+sc
+->
+sc_rdlock
+))
+
+910  (
+EWOULDBLOCK
+);
+
+912 
+	`mux_r
+(&
+sc
+->
+sc_rdlock
+);
+
+915 
+s
+ = 
+	`
+();
+
+916 i(
+	`IFQ_IS_EMPTY
+(&
+i
+->
+if_d
+)) {
+
+917 
+i
+->
+if_ags
+ &~
+IFF_OACTIVE
+;
+
+922 
+	`mux_ex
+(&
+sc
+->
+sc_rdlock
+);
+
+923 i(
+sc
+->
+sc_ags
+ & 
+TAP_NBIO
+)
+
+924 
+r
+ = 
+EWOULDBLOCK
+;
+
+926 
+r
+ = 
+	`tp
+(
+sc
+, 
+PSOCK
+|
+PCATCH
+, "tap", 0);
+
+927 
+	`lx
+(
+s
+);
+
+929 i(
+r
+ != 0)
+
+930  (
+r
+);
+
+932 i((
+i
+->
+if_ags
+ & 
+IFF_UP
+) == 0)
+
+933  (
+EHOSTDOWN
+);
+
+934 i((
+sc
+->
+sc_ags
+ & 
+TAP_NBIO
+)) {
+
+935 i(!
+	`mux_yr
+(&
+sc
+->
+sc_rdlock
+))
+
+936  (
+EWOULDBLOCK
+);
+
+938 
+	`mux_r
+(&
+sc
+->
+sc_rdlock
+);
+
+940 
+s
+ = 
+	`
+();
+
+943 
+	`IFQ_DEQUEUE
+(&
+i
+->
+if_d
+, 
+m
+);
+
+944 
+i
+->
+if_ags
+ &~
+IFF_OACTIVE
+;
+
+945 
+	`lx
+(
+s
+);
+
+946 i(
+m
+ =
+NULL
+) {
+
+947 
+r
+ = 0;
+
+948 
+out
+;
+
+951 
+i
+->
+if_acks
+++;
+
+952 
+	`bpf_mp
+(
+i
+, 
+m
+);
+
+958 
+r
+ = 
+	`uiomove
+(
+	`mtod
+(
+m
+, *),
+
+959 
+	`m
+(
+m
+->
+m_n
+, 
+uio
+->
+uio_sid
+), uio);
+
+960 
+	`MFREE
+(
+m
+, 
+n
+);
+
+961 
+m
+ = 
+n
+;
+
+962 } 
+m
+ !
+NULL
+ && 
+uio
+->
+uio_sid
+ > 0 && 
+r
+ == 0);
+
+964 i(
+m
+ !
+NULL
+)
+
+965 
+	`m_m
+(
+m
+);
+
+967 
+out
+:
+
+968 
+	`mux_ex
+(&
+sc
+->
+sc_rdlock
+);
+
+969  (
+r
+);
+
+970 
+	}
+}
+
+973 
+	$p_fs_
+(
+fe_t
+ *
+
+, 
+
+ *
+
+)
+
+975 
+r
+ = 0;
+
+976 
+p_soc
+ *
+sc
+;
+
+977 
+un
+ = 
+
+->
+f_devun
+;
+
+979 ()
+	`memt
+(
+
+, 0, (*st));
+
+981 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+982 
+sc
+ = 
+	`devi_lookup_ive
+(&
+p_cd
+, 
+un
+);
+
+983 i(
+sc
+ =
+NULL
+) {
+
+984 
+r
+ = 
+ENXIO
+;
+
+985 
+out
+;
+
+988 
+
+->
+_dev
+ = 
+	`makedev
+(
+	`cdevsw_lookup_maj
+(&
+p_cdevsw
+), 
+un
+);
+
+989 
+
+->
+_imeec
+ = 
+sc
+->
+sc_ime
+;
+
+990 
+
+->
+_mtimeec
+ = 
+sc
+->
+sc_mtime
+;
+
+991 
+
+->
+_imeec
+ = st->
+_bthtimeec
+ = 
+sc
+->
+sc_btime
+;
+
+992 
+
+->
+_uid
+ = 
+	`kauth_ed_geuid
+(
+
+->
+f_ed
+);
+
+993 
+
+->
+_gid
+ = 
+	`kauth_ed_gegid
+(
+
+->
+f_ed
+);
+
+994 
+out
+:
+
+995 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+996  
+r
+;
+
+997 
+	}
+}
+
+1000 
+	$p_cdev_wre
+(
+dev_t
+ 
+dev
+, 
+uio
+ *uio, 
+ags
+)
+
+1002  
+	`p_dev_wre
+(
+	`m
+(
+dev
+), 
+uio
+, 
+ags
+);
+
+1003 
+	}
+}
+
+1006 
+	$p_fs_wre
+(
+fe_t
+ *
+
+, 
+off_t
+ *
+of
+, 
+uio
+ *uio,
+
+1007 
+kauth_ed_t
+ 
+ed
+, 
+ags
+)
+
+1009 
+r
+;
+
+1011 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+1012 
+r
+ = 
+	`p_dev_wre
+(
+
+->
+f_devun
+, 
+uio
+, 
+ags
+);
+
+1013 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+1014  
+r
+;
+
+1015 
+	}
+}
+
+1018 
+	$p_dev_wre
+(
+un
+, 
+uio
+ *uio, 
+ags
+)
+
+1020 
+p_soc
+ *
+sc
+ =
+
+1021 
+	`devi_lookup_ive
+(&
+p_cd
+, 
+un
+);
+
+1022 
+i
+ *
+i
+;
+
+1023 
+mbuf
+ *
+m
+, **
+mp
+;
+
+1024 
+r
+ = 0;
+
+1025 
+s
+;
+
+1027 i(
+sc
+ =
+NULL
+)
+
+1028  (
+ENXIO
+);
+
+1030 
+	`gnime
+(&
+sc
+->
+sc_mtime
+);
+
+1031 
+i
+ = &
+sc
+->
+sc_ec
+.
+ec_if
+;
+
+1034 
+	`MGETHDR
+(
+m
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+1035 i(
+m
+ =
+NULL
+) {
+
+1036 
+i
+->
+if_s
+++;
+
+1037  (
+ENOBUFS
+);
+
+1039 
+m
+->
+m_pkthdr
+.
+n
+ = 
+uio
+->
+uio_sid
+;
+
+1041 
+mp
+ = &
+m
+;
+
+1042 
+r
+ =0 && 
+uio
+->
+uio_sid
+ > 0) {
+
+1043 i(*
+mp
+ !
+m
+) {
+
+1044 
+	`MGET
+(*
+mp
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+1045 i(*
+mp
+ =
+NULL
+) {
+
+1046 
+r
+ = 
+ENOBUFS
+;
+
+1050 (*
+mp
+)->
+m_n
+ = 
+	`m
+(
+MHLEN
+, 
+uio
+->
+uio_sid
+);
+
+1051 
+r
+ = 
+	`uiomove
+(
+	`mtod
+(*
+mp
+, *), (*mp)->
+m_n
+, 
+uio
+);
+
+1052 
+mp
+ = &(*mp)->
+m_xt
+;
+
+1054 i(
+r
+) {
+
+1055 
+i
+->
+if_s
+++;
+
+1056 
+	`m_m
+(
+m
+);
+
+1057  (
+r
+);
+
+1060 
+i
+->
+if_acks
+++;
+
+1061 
+m
+->
+m_pkthdr
+.
+rcvif
+ = 
+i
+;
+
+1063 
+	`bpf_mp
+(
+i
+, 
+m
+);
+
+1064 
+s
+ = 
+	`
+();
+
+1065 (*
+i
+->
+if_put
+)(i, 
+m
+);
+
+1066 
+	`lx
+(
+s
+);
+
+1069 
+	}
+}
+
+1072 
+	$p_cdev_iol
+(
+dev_t
+ 
+dev
+, 
+u_lg
+ 
+cmd
+, *
+da
+, 
+ags
+,
+
+1073 
+lwp
+ *
+l
+)
+
+1075  
+	`p_dev_iol
+(
+	`m
+(
+dev
+), 
+cmd
+, 
+da
+, 
+l
+);
+
+1076 
+	}
+}
+
+1079 
+	$p_fs_iol
+(
+fe_t
+ *
+
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+1081  
+	`p_dev_iol
+(
+
+->
+f_devun
+, 
+cmd
+, 
+da
+, 
+cuwp
+);
+
+1082 
+	}
+}
+
+1085 
+	$p_dev_iol
+(
+un
+, 
+u_lg
+ 
+cmd
+, *
+da
+, 
+lwp
+ *
+l
+)
+
+1087 
+p_soc
+ *
+sc
+ = 
+	`devi_lookup_ive
+(&
+p_cd
+, 
+un
+);
+
+1089 i(
+sc
+ =
+NULL
+)
+
+1090  
+ENXIO
+;
+
+1092 
+cmd
+) {
+
+1093 
+FIONREAD
+:
+
+1095 
+i
+ *
+i
+ = &
+sc
+->
+sc_ec
+.
+ec_if
+;
+
+1096 
+mbuf
+ *
+m
+;
+
+1097 
+s
+;
+
+1099 
+s
+ = 
+	`
+();
+
+1100 
+	`IFQ_POLL
+(&
+i
+->
+if_d
+, 
+m
+);
+
+1102 i(
+m
+ =
+NULL
+)
+
+1103 *(*)
+da
+ = 0;
+
+1105 *(*)
+da
+ = 
+m
+->
+m_pkthdr
+.
+n
+;
+
+1106 
+	`lx
+(
+s
+);
+
+1109 
+TIOCSPGRP
+:
+
+1110 
+FIOSETOWN
+:
+
+1111  
+	`ftown
+(&
+sc
+->
+sc_pgid
+, 
+cmd
+, 
+da
+);
+
+1112 
+TIOCGPGRP
+:
+
+1113 
+FIOGETOWN
+:
+
+1114  
+	`fgown
+(
+sc
+->
+sc_pgid
+, 
+cmd
+, 
+da
+);
+
+1115 
+FIOASYNC
+:
+
+1116 i(*(*)
+da
+) {
+
+1117 i(
+sc
+->
+sc_sih
+ =
+NULL
+) {
+
+1118 
+sc
+->
+sc_sih
+ = 
+	`sot_eablish
+(
+SOFTINT_CLOCK
+,
+
+1119 
+p_so
+, 
+sc
+);
+
+1120 i(
+sc
+->
+sc_sih
+ =
+NULL
+)
+
+1121  
+EBUSY
+;
+
+1123 
+sc
+->
+sc_ags
+ |
+TAP_ASYNCIO
+;
+
+1125 
+sc
+->
+sc_ags
+ &~
+TAP_ASYNCIO
+;
+
+1126 i(
+sc
+->
+sc_sih
+ !
+NULL
+) {
+
+1127 
+	`sot_diablish
+(
+sc
+->
+sc_sih
+);
+
+1128 
+sc
+->
+sc_sih
+ = 
+NULL
+;
+
+1132 
+FIONBIO
+:
+
+1133 i(*(*)
+da
+)
+
+1134 
+sc
+->
+sc_ags
+ |
+TAP_NBIO
+;
+
+1136 
+sc
+->
+sc_ags
+ &~
+TAP_NBIO
+;
+
+1138 #ifde
+OTAPGIFNAME
+
+
+1139 
+OTAPGIFNAME
+:
+
+1141 
+TAPGIFNAME
+:
+
+1143 
+ieq
+ *
+i
+ = (ieq *)
+da
+;
+
+1144 
+i
+ *
+i
+ = &
+sc
+->
+sc_ec
+.
+ec_if
+;
+
+1146 
+	`y
+(
+i
+->
+i_me
+, 
+i
+->
+if_xme
+, 
+IFNAMSIZ
+);
+
+1150  
+ENOTTY
+;
+
+1152 
+	}
+}
+
+1155 
+	$p_cdev_pl
+(
+dev_t
+ 
+dev
+, 
+evts
+, 
+lwp
+ *
+l
+)
+
+1157  
+	`p_dev_pl
+(
+	`m
+(
+dev
+), 
+evts
+, 
+l
+);
+
+1158 
+	}
+}
+
+1161 
+	$p_fs_pl
+(
+fe_t
+ *
+
+, 
+evts
+)
+
+1163  
+	`p_dev_pl
+(
+
+->
+f_devun
+, 
+evts
+, 
+cuwp
+);
+
+1164 
+	}
+}
+
+1167 
+	$p_dev_pl
+(
+un
+, 
+evts
+, 
+lwp
+ *
+l
+)
+
+1169 
+p_soc
+ *
+sc
+ =
+
+1170 
+	`devi_lookup_ive
+(&
+p_cd
+, 
+un
+);
+
+1171 
+vts
+ = 0;
+
+1173 i(
+sc
+ =
+NULL
+)
+
+1174  
+POLLERR
+;
+
+1176 i(
+evts
+ & (
+POLLIN
+|
+POLLRDNORM
+)) {
+
+1177 
+i
+ *
+i
+ = &
+sc
+->
+sc_ec
+.
+ec_if
+;
+
+1178 
+mbuf
+ *
+m
+;
+
+1179 
+s
+;
+
+1181 
+s
+ = 
+	`
+();
+
+1182 
+	`IFQ_POLL
+(&
+i
+->
+if_d
+, 
+m
+);
+
+1184 i(
+m
+ !
+NULL
+)
+
+1185 
+vts
+ |
+evts
+ & (
+POLLIN
+|
+POLLRDNORM
+);
+
+1187 
+	`mux__r
+(&
+sc
+->
+sc_kqlock
+);
+
+1188 
+	`ecd
+(
+l
+, &
+sc
+->
+sc_rl
+);
+
+1189 
+	`mux__ex
+(&
+sc
+->
+sc_kqlock
+);
+
+1191 
+	`lx
+(
+s
+);
+
+1193 
+vts
+ |
+evts
+ & (
+POLLOUT
+|
+POLLWRNORM
+);
+
+1195  (
+vts
+);
+
+1196 
+	}
+}
+
+1198 
+frs
+ 
+	gp_ad_frs
+ = { 1, 
+NULL
+, 
+p_kqdach
+,
+
+1199 
+p_kqad
+ };
+
+1200 
+frs
+ 
+	gp_rue_frs
+ = { 1, 
+NULL
+, 
+p_kqdach
+,
+
+1201 
+ft_rue
+ };
+
+1204 
+	$p_cdev_kqfr
+(
+dev_t
+ 
+dev
+, 
+kne
+ *
+kn
+)
+
+1206  
+	`p_dev_kqfr
+(
+	`m
+(
+dev
+), 
+kn
+);
+
+1207 
+	}
+}
+
+1210 
+	$p_fs_kqfr
+(
+fe_t
+ *
+
+, 
+kne
+ *
+kn
+)
+
+1212  
+	`p_dev_kqfr
+(
+
+->
+f_devun
+, 
+kn
+);
+
+1213 
+	}
+}
+
+1216 
+	$p_dev_kqfr
+(
+un
+, 
+kne
+ *
+kn
+)
+
+1218 
+p_soc
+ *
+sc
+ =
+
+1219 
+	`devi_lookup_ive
+(&
+p_cd
+, 
+un
+);
+
+1221 i(
+sc
+ =
+NULL
+)
+
+1222  (
+ENXIO
+);
+
+1224 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+1225 
+kn
+->
+kn_fr
+) {
+
+1226 
+EVFILT_READ
+:
+
+1227 
+kn
+->
+kn_f
+ = &
+p_ad_frs
+;
+
+1229 
+EVFILT_WRITE
+:
+
+1230 
+kn
+->
+kn_f
+ = &
+p_rue_frs
+;
+
+1233 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+1234  (
+EINVAL
+);
+
+1237 
+kn
+->
+kn_hook
+ = 
+sc
+;
+
+1238 
+	`mux__r
+(&
+sc
+->
+sc_kqlock
+);
+
+1239 
+	`SLIST_INSERT_HEAD
+(&
+sc
+->
+sc_rl
+.
+l_kli
+, 
+kn
+, 
+kn_ext
+);
+
+1240 
+	`mux__ex
+(&
+sc
+->
+sc_kqlock
+);
+
+1241 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+1243 
+	}
+}
+
+1246 
+	$p_kqdach
+(
+kne
+ *
+kn
+)
+
+1248 
+p_soc
+ *
+sc
+ = (p_so*)
+kn
+->
+kn_hook
+;
+
+1250 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+1251 
+	`mux__r
+(&
+sc
+->
+sc_kqlock
+);
+
+1252 
+	`SLIST_REMOVE
+(&
+sc
+->
+sc_rl
+.
+l_kli
+, 
+kn
+, 
+kne
+, 
+kn_ext
+);
+
+1253 
+	`mux__ex
+(&
+sc
+->
+sc_kqlock
+);
+
+1254 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+1255 
+	}
+}
+
+1258 
+	$p_kqad
+(
+kne
+ *
+kn
+, 
+ht
+)
+
+1260 
+p_soc
+ *
+sc
+ = (p_so*)
+kn
+->
+kn_hook
+;
+
+1261 
+i
+ *
+i
+ = &
+sc
+->
+sc_ec
+.
+ec_if
+;
+
+1262 
+mbuf
+ *
+m
+;
+
+1263 
+s
+, 
+rv
+;
+
+1265 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+1266 
+s
+ = 
+	`
+();
+
+1267 
+	`IFQ_POLL
+(&
+i
+->
+if_d
+, 
+m
+);
+
+1269 i(
+m
+ =
+NULL
+)
+
+1270 
+kn
+->
+kn_da
+ = 0;
+
+1272 
+kn
+->
+kn_da
+ = 
+m
+->
+m_pkthdr
+.
+n
+;
+
+1273 
+	`lx
+(
+s
+);
+
+1274 
+rv
+ = (
+kn
+->
+kn_da
+ != 0 ? 1 : 0);
+
+1275 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+1276  
+rv
+;
+
+1277 
+	}
+}
+
+1279 #i
+defed
+(
+COMPAT_40
+|| defed(
+MODULAR
+)
+
+1308 
+SYSCTL_SETUP
+(
+sysl_p_tup
+, "sysctlet.link.tap subtree setup")
+
+1310 c 
+sysode
+ *
+	gnode
+;
+
+1311 
+	gr
+ = 0;
+
+1313 i((
+	gr
+ = 
+sysl_v
+(
+og
+, 0, 
+NULL
+, NULL,
+
+1314 
+CTLFLAG_PERMANENT
+,
+
+1315 
+CTLTYPE_NODE
+, "lk", 
+NULL
+,
+
+1316 
+NULL
+, 0, NULL, 0,
+
+1317 
+CTL_NET
+, 
+AF_LINK
+, 
+CTL_EOL
+)) != 0)
+
+1333 i((
+	gr
+ = 
+sysl_v
+(
+og
+, 0, 
+NULL
+, &
+node
+,
+
+1334 
+CTLFLAG_PERMANENT
+,
+
+1335 
+CTLTYPE_NODE
+, "p", 
+NULL
+,
+
+1336 
+NULL
+, 0, NULL, 0,
+
+1337 
+CTL_NET
+, 
+AF_LINK
+, 
+CTL_CREATE
+, 
+CTL_EOL
+)) != 0)
+
+1339 
+	gp_node
+ = 
+node
+->
+sysl_num
+;
+
+1374 
+	$p_sysl_hdr
+(
+SYSCTLFN_ARGS
+)
+
+1376 
+sysode
+ 
+node
+;
+
+1377 
+p_soc
+ *
+sc
+;
+
+1378 
+i
+ *
+i
+;
+
+1379 
+r
+;
+
+1380 
+size_t
+ 
+n
+;
+
+1381 
+addr
+[3 * 
+ETHER_ADDR_LEN
+];
+
+1382 
+ut8_t
+ 
+addr
+[
+ETHER_ADDR_LEN
+];
+
+1384 
+node
+ = *
+ode
+;
+
+1385 
+sc
+ = 
+node
+.
+sysl_da
+;
+
+1386 
+i
+ = &
+sc
+->
+sc_ec
+.
+ec_if
+;
+
+1387 ()
+	`h_tf
+(
+addr
+, ddr), 
+	`CLLADDR
+(
+i
+->
+if_dl
+));
+
+1388 
+node
+.
+sysl_da
+ = 
+addr
+;
+
+1389 
+r
+ = 
+	`sysl_lookup
+(
+	`SYSCTLFN_CALL
+(&
+node
+));
+
+1390 i(
+r
+ || 
+wp
+ =
+NULL
+)
+
+1391  (
+r
+);
+
+1393 
+n
+ = 
+	`
+(
+addr
+);
+
+1394 i(
+n
+ < 11 ||en > 17)
+
+1395  (
+EINVAL
+);
+
+1398 i(
+	`h__r
+(
+addr
+, ddr), 
+addr
+) != 0)
+
+1399  (
+EINVAL
+);
+
+1400 
+	`if_t_dl
+(
+i
+, 
+addr
+, 
+ETHER_ADDR_LEN
+, 
+l
+);
+
+1401  (
+r
+);
+
+1402 
+	}
+}
+
+	@if_tap.h
+
+29 #ide
+_NET_IF_TAP_H_
+
+
+30 
+	#_NET_IF_TAP_H_
+
+
+	)
+
+33 
+	#TAPGIFNAME
+ 
+	`_IOR
+('e', 0, 
+ieq
+)
+
+	)
+
+	@if_token.h
+
+34 #ide
+_NET_IF_TOKEN_H_
+
+
+35 
+	#_NET_IF_TOKEN_H_
+
+
+	)
+
+37 
+	#ISO88025_ADDR_LEN
+ 6
+
+	)
+
+40 
+	stok_hd
+ {
+
+41 
+ut8_t
+ 
+	mtok_ac
+;
+
+42 
+ut8_t
+ 
+	mtok_fc
+;
+
+43 
+ut8_t
+ 
+	mtok_dho
+[
+ISO88025_ADDR_LEN
+];
+
+44 
+ut8_t
+ 
+	mtok_sho
+[
+ISO88025_ADDR_LEN
+];
+
+45 } 
+	g__cked
+;
+
+47 
+	#TOKEN_MAX_BRIDGE
+ 8
+
+	)
+
+50 
+	stok_rif
+ {
+
+51 
+ut16_t
+ 
+	m_rcf
+;
+
+52 
+ut16_t
+ 
+	m_rdf
+[
+TOKEN_MAX_BRIDGE
+];
+
+53 } 
+	g__cked
+;
+
+56 
+	#TOKEN_AC
+ 0x10
+
+	)
+
+57 
+	#TOKEN_FC
+ 0x40
+
+	)
+
+59 
+	#TOKEN_RI_PRESENT
+ 0x80
+
+	)
+
+60 
+	#TOKEN_RCF_LEN_MASK
+ 0x1f00
+
+	)
+
+61 
+	#TOKEN_RCF_BROADCAST_MASK
+ 0xe000
+
+	)
+
+62 
+	#TOKEN_RCF_BROADCAST_ALL
+ 0x8000
+
+	)
+
+63 
+	#TOKEN_RCF_BROADCAST_SINGLE
+ 0xc000
+
+	)
+
+72 
+	#TOKEN_RCF_FRAME0
+ 0x0000
+
+	)
+
+73 
+	#TOKEN_RCF_FRAME1
+ 0x0010
+
+	)
+
+74 
+	#TOKEN_RCF_FRAME2
+ 0x0020
+
+	)
+
+75 
+	#TOKEN_RCF_FRAME3
+ 0x0030
+
+	)
+
+76 
+	#TOKEN_RCF_FRAME4
+ 0x0040
+
+	)
+
+77 
+	#TOKEN_RCF_FRAME5
+ 0x0050
+
+	)
+
+78 
+	#TOKEN_RCF_FRAME6
+ 0x0060
+
+	)
+
+79 
+	#TOKEN_RCF_FRAME7
+ 0x0070
+
+	)
+
+80 
+	#TOKEN_RCF_FRAME_MASK
+ 0x0070
+
+	)
+
+82 
+	#TOKEN_RCF_DIRECTION
+ 0x0080
+
+	)
+
+87 
+	#IPMTU_4MBIT_MAX
+ 4464
+
+	)
+
+88 
+	#IPMTU_16MBIT_MAX
+ 8188
+
+	)
+
+95 
+	#ISO88025_MTU
+ 2002
+
+	)
+
+101 
+	#TOKEN_RIF
+(
+x
+((
+tok_rif
+ *((x+ 1))
+
+	)
+
+108 
+	#M_TRHSTART
+(
+m
+) \
+
+109 (
+	`ALIGN
+(((
+m
+)->
+m_ags
+ & 
+M_EXT
+ ? (m)->
+m_ext
+.
+ext_buf
+ : &(m)->
+m_pktd
+[0]) \
+
+110 +  (
+tok_hd
+)- (tok_hd))
+
+	)
+
+112 #i
+defed
+(
+_KERNEL
+)
+
+116 
+	#tokbrdaddr
+ 
+hbrdaddr
+
+
+	)
+
+117 
+	#tok_mui_m
+ 
+h_mui_m
+
+
+	)
+
+118 
+	#tok_mui_max
+ 
+h_mui_max
+
+
+	)
+
+119 
+	#tok_rtf
+ 
+h_rtf
+
+
+	)
+
+121 
+tok_iach
+(
+i
+ *, *);
+
+122 
+tok_ifdach
+(
+i
+ *);
+
+	@if_tokensubr.c
+
+94 
+	~<sys/cdefs.h
+>
+
+95 
+__KERNEL_RCSID
+(0, "$NetBSD: if_tokensubr.c,v 1.67 2015/05/20 09:17:18 ozaki-r Exp $");
+
+97 
+	~"t_.h
+"
+
+98 
+	~"t_k.h
+"
+
+99 
+	~"t_geway.h
+"
+
+102 
+	~<sys/m.h
+>
+
+103 
+	~<sys/sym.h
+>
+
+104 
+	~<sys/kl.h
+>
+
+105 
+	~<sys/mloc.h
+>
+
+106 
+	~<sys/mbuf.h
+>
+
+107 
+	~<sys/osw.h
+>
+
+108 
+	~<sys/sock.h
+>
+
+109 
+	~<sys/iol.h
+>
+
+110 
+	~<sys/o.h
+>
+
+111 
+	~<sys/syog.h
+>
+
+113 
+	~<sys/u.h
+>
+
+115 
+	~<t/if.h
+>
+
+116 
+	~<t/ti.h
+>
+
+117 
+	~<t/rou.h
+>
+
+118 
+	~<t/if_c.h
+>
+
+119 
+	~<t/if_dl.h
+>
+
+120 
+	~<t/if_tys.h
+>
+
+122 
+	~<t/bpf.h
+>
+
+124 
+	~<t/if_h.h
+>
+
+125 
+	~<t/if_tok.h
+>
+
+127 #ifde
+INET
+
+
+128 
+	~<t/.h
+>
+
+129 
+	~<t/_v.h
+>
+
+130 
+	~<t/if_p.h
+>
+
+133 
+	~".h
+"
+
+134 #i
+NCARP
+ > 0
+
+135 
+	~<t/_.h
+>
+
+138 #ifde
+DECNET
+
+
+139 
+	~<tdt/dn.h
+>
+
+142 
+	#ndr
+(
+e
+{ 
+r
+ = (e); 
+bad
+;}
+
+	)
+
+144 #i
+defed
+(
+__bsdi__
+|| defed(
+__NBSD__
+)
+
+145 
+	#RTALLOC1
+(
+a
+, 
+b
+
+	`loc1
+, b)
+
+	)
+
+146 
+	#ARPRESOLVE
+(
+a
+, 
+b
+, 
+c
+, 
+d
+, 
+e
+, 
+f
+
+	`esve
+, b, c, d,)
+
+	)
+
+147 
+	#TYPEHTONS
+(
+t
+)
+
+	)
+
+148 #i
+defed
+(
+__FeBSD__
+)
+
+149 
+	#RTALLOC1
+(
+a
+, 
+b
+
+	`loc1
+, b, 0UL)
+
+	)
+
+150 
+	#ARPRESOLVE
+(
+a
+, 
+b
+, 
+c
+, 
+d
+, 
+e
+, 
+f
+
+	`esve
+, b, c, d,, f)
+
+	)
+
+151 
+	#TYPEHTONS
+(
+t
+(
+	`hts
+))
+
+	)
+
+154 
+	#RCF_ALLROUTES
+ (2 << 8| 
+TOKEN_RCF_FRAME2
+ | 
+TOKEN_RCF_BROADCAST_ALL
+
+
+	)
+
+155 
+	#RCF_SINGLEROUTE
+ (2 << 8| 
+TOKEN_RCF_FRAME2
+ | 
+TOKEN_RCF_BROADCAST_SINGLE
+
+
+	)
+
+157 
+tok_ouut
+(
+i
+ *, 
+mbuf
+ *,
+
+158 c 
+sockaddr
+ *, 
+y
+ *);
+
+159 
+tok_put
+(
+i
+ *, 
+mbuf
+ *);
+
+168 
+	$tok_ouut
+(
+i
+ *
+i0
+, 
+mbuf
+ *
+m0
+, c 
+sockaddr
+ *
+d
+,
+
+169 
+y
+ *
+0
+)
+
+171 
+ut16_t
+ 
+y
+;
+
+172 
+r
+ = 0;
+
+173 
+u_ch
+ 
+ed
+[
+ISO88025_ADDR_LEN
+];
+
+174 
+mbuf
+ *
+m
+ = 
+m0
+;
+
+175 
+y
+ *
+
+;
+
+176 
+mbuf
+ *
+mcy
+ = 
+NULL
+;
+
+177 
+tok_hd
+ *
+h
+;
+
+178 #ifde
+INET
+
+
+179 
+phdr
+ *
+ah
+ = (phd*)
+i0
+;
+
+181 
+tok_rif
+ *
+rif
+ = 
+NULL
+;
+
+182 
+tok_rif
+ 
+brif
+;
+
+183 
+i
+ *
+i
+ = 
+i0
+;
+
+184 
+size_t
+ 
+ri
+ = 0;
+
+185 
+	`ALTQ_DECL
+(
+tq_pkr
+ 
+pkr
+;)
+
+187 #i
+NCARP
+ > 0
+
+188 i(
+i
+->
+if_ty
+ =
+IFT_CARP
+) {
+
+189 
+iddr
+ *
+i
+;
+
+192 i(
+d
+ !
+NULL
+ && 
+i0
+->
+if_lk_e
+ =
+LINK_STATE_UP
+ &&
+
+193 (
+i
+ = 
+	`i_ifwhaddr
+(
+d
+)!
+NULL
+ &&
+
+194 
+i
+->
+i_i
+ =
+i0
+)
+
+195  (
+	`loouut
+(
+i0
+, 
+m
+, 
+d
+, 
+0
+));
+
+197 
+i
+ = i->
+if_dev
+;
+
+198 
+ah
+ = (
+phdr
+ *)
+i
+;
+
+200 i((
+i0
+->
+if_ags
+ & (
+IFF_UP
+|
+IFF_RUNNING
+)) !=
+
+201 (
+IFF_UP
+|
+IFF_RUNNING
+))
+
+202 
+	`ndr
+(
+ENETDOWN
+);
+
+206 i((
+i
+->
+if_ags
+ & (
+IFF_UP
+|
+IFF_RUNNING
+)) != (IFF_UP|IFF_RUNNING))
+
+207 
+	`ndr
+(
+ENETDOWN
+);
+
+208 i((
+
+ = 
+0
+)) {
+
+209 i((
+
+->
+_ags
+ & 
+RTF_UP
+) == 0) {
+
+210 i((
+0
+ = 
+
+ = 
+	`RTALLOC1
+(
+d
+, 1)))
+
+211 
+
+->
+_ft
+--;
+
+213 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+215 i(
+
+->
+_ags
+ & 
+RTF_GATEWAY
+) {
+
+216 i(
+
+->
+_gwrou
+ == 0)
+
+217 
+lookup
+;
+
+218 i(((
+
+ =t->
+_gwrou
+)->
+_ags
+ & 
+RTF_UP
+) == 0) {
+
+219 
+	`
+(
+
+);
+0
+;
+
+220 
+lookup
+: 
+
+->
+_gwrou
+ = 
+	`RTALLOC1
+t->
+_geway
+, 1);
+
+221 i((
+
+ =t->
+_gwrou
+) == 0)
+
+222 
+	`ndr
+(
+EHOSTUNREACH
+);
+
+225 i(
+
+->
+_ags
+ & 
+RTF_REJECT
+)
+
+226 i(
+
+->
+_rmx
+.
+rmx_expe
+ == 0 ||
+
+227 
+time_cd
+ < 
+
+->
+_rmx
+.
+rmx_expe
+)
+
+228 
+	`ndr
+(
+
+ =
+0
+ ? 
+EHOSTDOWN
+ : 
+EHOSTUNREACH
+);
+
+235 
+	`IFQ_CLASSIFY
+(&
+i
+->
+if_d
+, 
+m
+, 
+d
+->
+_my
+, &
+pkr
+);
+
+237 
+d
+->
+_my
+) {
+
+239 #ifde
+INET
+
+
+240 
+AF_INET
+:
+
+241 i(
+m
+->
+m_ags
+ & 
+M_BCAST
+) {
+
+242 i(
+i
+->
+if_ags
+ & 
+IFF_LINK0
+) {
+
+243 i(
+i
+->
+if_ags
+ & 
+IFF_LINK1
+)
+
+244 
+brif
+.
+_rcf
+ = 
+	`hts
+(
+RCF_ALLROUTES
+);
+
+246 
+brif
+.
+_rcf
+ = 
+	`hts
+(
+RCF_SINGLEROUTE
+);
+
+247 
+rif
+ = &
+brif
+;
+
+248 
+ri
+ = (
+rif
+->
+_rcf
+);
+
+250 
+	`memy
+(
+ed
+, 
+tokbrdaddr
+, (edst));
+
+256 i(!
+	`ARPRESOLVE
+(
+i
+, 
+
+, 
+m
+, 
+d
+, 
+ed
+, 
+0
+))
+
+258 
+rif
+ = 
+	`TOKEN_RIF
+((
+fo_p
+ *
+
+->
+_fo
+);
+
+259 
+ri
+ = (
+	`ohs
+(
+rif
+->
+_rcf
+& 
+TOKEN_RCF_LEN_MASK
+) >> 8;
+
+262 i((
+m
+->
+m_ags
+ & 
+M_BCAST
+&& (
+i
+->
+if_ags
+ & 
+IFF_SIMPLEX
+))
+
+263 
+mcy
+ = 
+	`m_cy
+(
+m
+, 0, ()
+M_COPYALL
+);
+
+264 
+y
+ = 
+	`hts
+(
+ETHERTYPE_IP
+);
+
+266 
+AF_ARP
+:
+
+270 
+ah
+ = 
+	`mtod
+(
+m
+, 
+phdr
+ *);
+
+271 
+ah
+->
+_hrd
+ = 
+	`hts
+(
+ARPHRD_IEEE802
+);
+
+273 
+	`ohs
+(
+ah
+->
+_
+)) {
+
+274 
+ARPOP_REVREQUEST
+:
+
+275 
+ARPOP_REVREPLY
+:
+
+276 
+y
+ = 
+	`hts
+(
+ETHERTYPE_REVARP
+);
+
+279 
+ARPOP_REQUEST
+:
+
+280 
+ARPOP_REPLY
+:
+
+282 
+y
+ = 
+	`hts
+(
+ETHERTYPE_ARP
+);
+
+285 i(
+m
+->
+m_ags
+ & 
+M_BCAST
+) {
+
+286 i(
+i
+->
+if_ags
+ & 
+IFF_LINK0
+) {
+
+287 i(
+i
+->
+if_ags
+ & 
+IFF_LINK1
+)
+
+288 
+brif
+.
+_rcf
+ = 
+	`hts
+(
+RCF_ALLROUTES
+);
+
+290 
+brif
+.
+_rcf
+ = 
+	`hts
+(
+RCF_SINGLEROUTE
+);
+
+291 
+rif
+ = &
+brif
+;
+
+292 
+ri
+ = (
+rif
+->
+_rcf
+);
+
+294 
+	`memy
+(
+ed
+, 
+tokbrdaddr
+, (edst));
+
+297 *
+tha
+ = 
+	`_tha
+(
+ah
+);
+
+298 i(
+tha
+ =
+NULL
+)
+
+300 
+	`memy
+(
+ed
+, 
+tha
+, (edst));
+
+301 
+h
+ = (
+tok_hd
+ *)
+	`M_TRHSTART
+(
+m
+);
+
+302 
+h
+->
+tok_ac
+ = 
+TOKEN_AC
+;
+
+303 
+h
+->
+tok_fc
+ = 
+TOKEN_FC
+;
+
+304 i(
+h
+->
+tok_sho
+[0] & 
+TOKEN_RI_PRESENT
+) {
+
+305 
+tok_rif
+ *
+rif
+;
+
+307 
+rif
+ = 
+	`TOKEN_RIF
+(
+h
+);
+
+308 
+ri
+ = (
+	`ohs
+(
+rif
+->
+_rcf
+& 
+TOKEN_RCF_LEN_MASK
+) >> 8;
+
+310 
+	`memy
+((*)
+h
+->
+tok_dho
+, (*)
+ed
+,
+
+311  (
+ed
+));
+
+312 
+	`memy
+((*)
+h
+->
+tok_sho
+, 
+	`CLLADDR
+(
+i
+->
+if_dl
+),
+
+313 (
+h
+->
+tok_sho
+));
+
+314 i(
+ri
+ != 0)
+
+315 
+h
+->
+tok_sho
+[0] |
+TOKEN_RI_PRESENT
+;
+
+319 
+m
+->
+m_n
+ +((*
+h
++ 
+ri
+ + 
+LLC_SNAPFRAMELEN
+);
+
+320 
+m
+->
+m_da
+ -((*
+h
++ 
+ri
+ + 
+LLC_SNAPFRAMELEN
+);
+
+321 
+m
+->
+m_pkthdr
+.
+n
+ +((*
+h
++ 
+ri
+ + 
+LLC_SNAPFRAMELEN
+);
+
+322 
+nd
+;
+
+327 
+AF_UNSPEC
+:
+
+329 c 
+h_hd
+ *
+eh
+;
+
+330 
+eh
+ = (c 
+h_hd
+ *)
+d
+->
+_da
+;
+
+331 
+	`memy
+(
+ed
+, 
+eh
+->
+h_dho
+, (edst));
+
+332 i(*
+ed
+ & 1)
+
+333 
+m
+->
+m_ags
+ |(
+M_BCAST
+|
+M_MCAST
+);
+
+334 
+y
+ = 
+	`TYPEHTONS
+(
+eh
+->
+h_ty
+);
+
+335 i(
+m
+->
+m_ags
+ & 
+M_BCAST
+) {
+
+336 i(
+i
+->
+if_ags
+ & 
+IFF_LINK0
+) {
+
+337 i(
+i
+->
+if_ags
+ & 
+IFF_LINK1
+)
+
+338 
+brif
+.
+_rcf
+ = 
+	`hts
+(
+RCF_ALLROUTES
+);
+
+340 
+brif
+.
+_rcf
+ = 
+	`hts
+(
+RCF_SINGLEROUTE
+);
+
+341 
+rif
+ = &
+brif
+;
+
+342 
+ri
+ = (
+brif
+.
+_rcf
+);
+
+349 
+	`tf
+("%s: c'hdf%d\n", 
+i
+->
+if_xme
+,
+
+350 
+d
+->
+_my
+);
+
+351 
+	`ndr
+(
+EAFNOSUPPORT
+);
+
+355 i(
+mcy
+)
+
+356 (
+	`loouut
+(
+i
+, 
+mcy
+, 
+d
+, 
+
+);
+
+357 i(
+y
+ != 0) {
+
+358 
+c
+ *
+l
+;
+
+359 
+	`M_PREPEND
+(
+m
+, 
+LLC_SNAPFRAMELEN
+, 
+M_DONTWAIT
+);
+
+360 i(
+m
+ == 0)
+
+361 
+	`ndr
+(
+ENOBUFS
+);
+
+362 
+l
+ = 
+	`mtod
+(
+m
+, 
+c
+ *);
+
+363 
+l
+->
+c_c
+ = 
+LLC_UI
+;
+
+364 
+l
+->
+c_dp
+ =->
+c_sp
+ = 
+LLC_SNAP_LSAP
+;
+
+365 
+l
+->
+c_
+.
+g_code
+[0] =->llc_snap.org_code[1] =
+
+366 
+l
+->
+c_
+.
+g_code
+[2] = 0;
+
+367 
+	`memy
+((*&
+l
+->
+c_
+.
+h_ty
+, (*&
+y
+,
+
+368 (
+ut16_t
+));
+
+376 
+	`M_PREPEND
+(
+m
+, (
+ri
+ +  (*
+h
+)), 
+M_DONTWAIT
+);
+
+377 i(
+m
+ == 0)
+
+378 
+	`ndr
+(
+ENOBUFS
+);
+
+379 
+h
+ = 
+	`mtod
+(
+m
+, 
+tok_hd
+ *);
+
+380 
+h
+->
+tok_ac
+ = 
+TOKEN_AC
+;
+
+381 
+h
+->
+tok_fc
+ = 
+TOKEN_FC
+;
+
+382 
+	`memy
+((*)
+h
+->
+tok_dho
+, (*)
+ed
+,  (edst));
+
+383 
+	`memy
+((*)
+h
+->
+tok_sho
+, 
+	`CLLADDR
+(
+i
+->
+if_dl
+),
+
+384 (
+h
+->
+tok_sho
+));
+
+386 i(
+ri
+ != 0) {
+
+387 
+tok_rif
+ *
+rif
+;
+
+389 
+h
+->
+tok_sho
+[0] |
+TOKEN_RI_PRESENT
+;
+
+390 
+rif
+ = 
+	`TOKEN_RIF
+(
+h
+);
+
+391 
+	`memy
+(
+rif
+, 
+rif
+, 
+ri
+);
+
+393 #ifde
+INET
+
+
+394 
+nd
+:
+
+397 #i
+NCARP
+ > 0
+
+398 i(
+i0
+ !
+i
+ && i0->
+if_ty
+ =
+IFT_CARP
+) {
+
+399 
+	`memy
+((*)
+h
+->
+tok_sho
+, 
+	`CLLADDR
+(
+i0
+->
+if_dl
+),
+
+400 (
+h
+->
+tok_sho
+));
+
+404  
+	`ifq_queue
+(
+i
+, 
+m
+ 
+ALTQ_COMMA
+ 
+	`ALTQ_DECL
+(&
+pkr
+));
+
+405 
+bad
+:
+
+406 i(
+m
+)
+
+407 
+	`m_m
+(
+m
+);
+
+408  (
+r
+);
+
+409 
+	}
+}
+
+417 
+	$tok_put
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+)
+
+419 
+pktqueue_t
+ *
+pktq
+ = 
+NULL
+;
+
+420 
+ifqueue
+ *
+q
+ = 
+NULL
+;
+
+421 
+c
+ *
+l
+;
+
+422 
+tok_hd
+ *
+h
+;
+
+423 
+s
+, 
+n_hdr_n
+;
+
+424 
+i
+ = 0;
+
+426 i((
+i
+->
+if_ags
+ & 
+IFF_UP
+) == 0) {
+
+427 
+	`m_m
+(
+m
+);
+
+431 
+h
+ = 
+	`mtod
+(
+m
+, 
+tok_hd
+ *);
+
+433 
+i
+->
+if_ibys
+ +
+m
+->
+m_pkthdr
+.
+n
+;
+
+434 i(
+	`memcmp
+(
+tokbrdaddr
+, 
+h
+->
+tok_dho
+,
+
+435 (
+tokbrdaddr
+)) == 0)
+
+436 
+m
+->
+m_ags
+ |
+M_BCAST
+;
+
+437 i(
+h
+->
+tok_dho
+[0] & 1)
+
+438 
+m
+->
+m_ags
+ |
+M_MCAST
+;
+
+439 i(
+m
+->
+m_ags
+ & (
+M_BCAST
+|
+M_MCAST
+))
+
+440 
+i
+->
+if_ims
+++;
+
+443 
+n_hdr_n
+ = (
+tok_hd
+);
+
+444 i(
+h
+->
+tok_sho
+[0] & 
+TOKEN_RI_PRESENT
+) {
+
+445 
+tok_rif
+ *
+rif
+;
+
+447 
+rif
+ = 
+	`TOKEN_RIF
+(
+h
+);
+
+448 
+n_hdr_n
+ +(
+	`ohs
+(
+rif
+->
+_rcf
+& 
+TOKEN_RCF_LEN_MASK
+) >> 8;
+
+451 
+l
+ = (
+c
+ *)(
+	`mtod
+(
+m
+, 
+ut8_t
+ *+ 
+n_hdr_n
+);
+
+453 
+l
+->
+c_dp
+) {
+
+454 #i
+	`defed
+(
+INET
+|| defed(
+DECNET
+)
+
+455 
+LLC_SNAP_LSAP
+:
+
+457 
+ut16_t
+ 
+y
+;
+
+458 i(
+l
+->
+c_c
+ !
+LLC_UI
+ ||->
+c_sp
+ !
+LLC_SNAP_LSAP
+)
+
+459 
+dryway
+;
+
+460 i(
+l
+->
+c_
+.
+g_code
+[0] != 0 ||
+
+461 
+l
+->
+c_
+.
+g_code
+[1] != 0 ||
+
+462 
+l
+->
+c_
+.
+g_code
+[2] != 0)
+
+463 
+dryway
+;
+
+464 
+y
+ = 
+	`ohs
+(
+l
+->
+c_
+.
+h_ty
+);
+
+465 
+	`m_adj
+(
+m
+, 
+n_hdr_n
+ + 
+LLC_SNAPFRAMELEN
+);
+
+466 #i
+NCARP
+ > 0
+
+467 i(
+i
+->
+if_
+ && i->
+if_ty
+ !
+IFT_CARP
+ &&
+
+468 (
+	`_put
+(
+m
+, (
+ut8_t
+ *)&
+h
+->
+tok_sho
+,
+
+469 (
+ut8_t
+ *)&
+h
+->
+tok_dho
+, 
+l
+->
+c_
+.
+h_ty
+) == 0))
+
+473 
+y
+) {
+
+474 #ifde
+INET
+
+
+475 
+ETHERTYPE_IP
+:
+
+476 
+pktq
+ = 
+_pktq
+;
+
+479 
+ETHERTYPE_ARP
+:
+
+480 
+i
+ = 
+NETISR_ARP
+;
+
+481 
+q
+ = &
+pq
+;
+
+484 #ifde
+DECNET
+
+
+485 
+ETHERTYPE_DECNET
+:
+
+486 
+i
+ = 
+NETISR_DECNET
+;
+
+487 
+q
+ = &
+deq
+;
+
+494 
+i
+->
+if_nro
+++;
+
+495 
+dryway
+;
+
+503 
+i
+->
+if_nro
+++;
+
+504 #i
+	`defed
+(
+INET
+|| defed(
+DECNET
+)
+
+505 
+dryway
+:
+
+507 
+	`m_m
+(
+m
+);
+
+511 i(
+	`__edi_ue
+(
+pktq
+)) {
+
+512 i(
+	`__edi_l
+(!
+	`pktq_queue
+(
+pktq
+, 
+m
+, 0))) {
+
+513 
+	`m_m
+(
+m
+);
+
+518 
+s
+ = 
+	`
+();
+
+519 i(
+	`IF_QFULL
+(
+q
+)) {
+
+520 
+	`IF_DROP
+(
+q
+);
+
+521 
+	`m_m
+(
+m
+);
+
+523 
+	`IF_ENQUEUE
+(
+q
+, 
+m
+);
+
+524 
+	`schedti
+(
+i
+);
+
+526 
+	`lx
+(
+s
+);
+
+527 
+	}
+}
+
+533 
+	$tok_iach
+(
+i
+ *
+i
+, *
+a
+)
+
+536 
+i
+->
+if_ty
+ = 
+IFT_ISO88025
+;
+
+537 
+i
+->
+if_hd
+ = 14;
+
+538 
+i
+->
+if_d
+ = 
+DLT_IEEE802
+;
+
+539 
+i
+->
+if_mtu
+ = 
+ISO88025_MTU
+;
+
+540 
+i
+->
+if_ouut
+ = 
+tok_ouut
+;
+
+541 
+i
+->
+if_put
+ = 
+tok_put
+;
+
+542 
+i
+->
+if_brdaddr
+ = 
+tokbrdaddr
+;
+
+543 #ifde
+IFF_NOTRAILERS
+
+
+544 
+i
+->
+if_ags
+ |
+IFF_NOTRAILERS
+;
+
+547 
+	`if_t_dl
+(
+i
+, 
+a
+, 
+ISO88025_ADDR_LEN
+, 
+ue
+);
+
+549 
+	`bpf_ch
+(
+i
+, 
+DLT_IEEE802
+, (
+tok_hd
+));
+
+550 
+	}
+}
+
+553 
+	$tok_ifdach
+(
+i
+ *
+i
+)
+
+556 
+	`bpf_dach
+(
+i
+);
+
+557 
+	}
+}
+
+	@if_tun.c
+
+17 
+	~<sys/cdefs.h
+>
+
+18 
+__KERNEL_RCSID
+(0, "$NetBSD: if_tun.c,v 1.121 2015/04/20 10:19:54oy Exp $");
+
+20 
+	~"t_.h
+"
+
+22 
+	~<sys/m.h
+>
+
+23 
+	~<sys/oc.h
+>
+
+24 
+	~<sys/sym.h
+>
+
+25 
+	~<sys/mbuf.h
+>
+
+26 
+	~<sys/buf.h
+>
+
+27 
+	~<sys/osw.h
+>
+
+28 
+	~<sys/sock.h
+>
+
+29 
+	~<sys/iol.h
+>
+
+30 
+	~<sys/o.h
+>
+
+31 
+	~<sys/syog.h
+>
+
+32 
+	~<sys/.h
+>
+
+33 
+	~<sys/pl.h
+>
+
+34 
+	~<sys/fe.h
+>
+
+35 
+	~<sys/siglv.h
+>
+
+36 
+	~<sys/cf.h
+>
+
+37 
+	~<sys/kauth.h
+>
+
+38 
+	~<sys/mux.h
+>
+
+39 
+	~<sys/u.h
+>
+
+41 
+	~<t/if.h
+>
+
+42 
+	~<t/if_tys.h
+>
+
+43 
+	~<t/ti.h
+>
+
+44 
+	~<t/rou.h
+>
+
+47 #ifde
+INET
+
+
+48 
+	~<t/.h
+>
+
+49 
+	~<t/_sym.h
+>
+
+50 
+	~<t/_v.h
+>
+
+51 
+	~<t/.h
+>
+
+52 
+	~<t/if_p.h
+>
+
+56 
+	~<sys/time.h
+>
+
+57 
+	~<t/bpf.h
+>
+
+59 
+	~<t/if_tun.h
+>
+
+61 
+	#TUNDEBUG
+ i(
+tundebug
+
+tf
+
+
+	)
+
+62 
+	gtundebug
+ = 0;
+
+64 
+ifqmaxn
+;
+
+65 
+tuach
+();
+
+67 
+	$LIST_HEAD
+(, 
+tun_soc
+
+tun_soc_li
+;
+
+68 
+	$LIST_HEAD
+(, 
+tun_soc
+
+tunz_soc_li
+;
+
+69 
+kmux_t
+ 
+tun_soc_lock
+;
+
+71 
+	`tun_iol
+(
+i
+ *, 
+u_lg
+, *);
+
+72 
+	`tun_ouut
+(
+i
+ *, 
+mbuf
+ *,
+
+73 c 
+sockaddr
+ *, 
+y
+ *
+
+);
+
+74 
+	`tun_e_
+(
+if_e
+ *, );
+
+75 
+	`tun_e_deroy
+(
+i
+ *);
+
+77 
+if_e
+ 
+tun_
+ =
+
+78 
+	`IF_CLONE_INITIALIZER
+("tun", 
+tun_e_
+, 
+tun_e_deroy
+);
+
+80 
+	`tuach0
+(
+tun_soc
+ *);
+
+81 
+	`tun
+(
+tun_soc
+ *);
+
+82 
+	`tun_i_so
+(*);
+
+83 
+	`tun_o_so
+(*);
+
+84 #ifde
+ALTQ
+
+
+85 
+	`tunt
+(
+i
+ *);
+
+87 
+tun_soc
+ *
+	`tun_fd_un
+(
+dev_t
+);
+
+88 
+tun_soc
+ *
+	`tun_fd_zun
+();
+
+90 
+	`dev_ty_
+(
+tun
+);
+
+91 
+	`dev_ty_o
+(
+tuno
+);
+
+92 
+	`dev_ty_ad
+(
+tud
+);
+
+93 
+	`dev_ty_wre
+(
+tunwre
+);
+
+94 
+	`dev_ty_iol
+(
+tuniol
+);
+
+95 
+	`dev_ty_pl
+(
+tul
+);
+
+96 
+	`dev_ty_kqfr
+(
+tunkqfr
+);
+
+98 c 
+cdevsw
+ 
+tun_cdevsw
+ = {
+
+99 .
+d_
+ = 
+tun
+,
+
+100 .
+d_o
+ = 
+tuno
+,
+
+101 .
+d_ad
+ = 
+tud
+,
+
+102 .
+d_wre
+ = 
+tunwre
+,
+
+103 .
+d_iol
+ = 
+tuniol
+,
+
+104 .
+d_
+ = 
+no
+,
+
+105 .
+d_y
+ = 
+nty
+,
+
+106 .
+d_pl
+ = 
+tul
+,
+
+107 .
+d_mm
+ = 
+nomm
+,
+
+108 .
+d_kqfr
+ = 
+tunkqfr
+,
+
+109 .
+d_disrd
+ = 
+nodisrd
+,
+
+110 .
+d_ag
+ = 
+D_OTHER
+
+
+111 
+	}
+};
+
+114 
+	$tuach
+(
+unud
+)
+
+117 
+	`mux_
+(&
+tun_soc_lock
+, 
+MUTEX_DEFAULT
+, 
+IPL_NET
+);
+
+118 
+	`LIST_INIT
+(&
+tun_soc_li
+);
+
+119 
+	`LIST_INIT
+(&
+tunz_soc_li
+);
+
+120 
+	`if_e_ch
+(&
+tun_
+);
+
+121 
+	}
+}
+
+127 
+tun_soc
+ *
+
+128 
+	$tun_fd_un
+(
+dev_t
+ 
+dev
+)
+
+130 
+tun_soc
+ *
+
+;
+
+131 
+un
+ = 
+	`m
+(
+dev
+);
+
+133 
+	`mux_r
+(&
+tun_soc_lock
+);
+
+134 
+	`LIST_FOREACH
+(
+
+, &
+tun_soc_li
+, 
+tun_li
+)
+
+135 i(
+un
+ =
+
+->
+tun_un
+)
+
+137 i(
+
+)
+
+138 
+	`mux_r
+(&
+
+->
+tun_lock
+);
+
+139 
+	`mux_ex
+(&
+tun_soc_lock
+);
+
+141  (
+
+);
+
+142 
+	}
+}
+
+148 
+tun_soc
+ *
+
+149 
+	$tun_fd_zun
+(
+un
+)
+
+151 
+tun_soc
+ *
+
+;
+
+153 
+	`mux_r
+(&
+tun_soc_lock
+);
+
+154 
+	`LIST_FOREACH
+(
+
+, &
+tunz_soc_li
+, 
+tun_li
+)
+
+155 i(
+un
+ =
+
+->
+tun_un
+)
+
+157 i(
+
+)
+
+158 
+	`LIST_REMOVE
+(
+
+, 
+tun_li
+);
+
+159 
+	`mux_ex
+(&
+tun_soc_lock
+);
+
+160 #ifde
+DIAGNOSTIC
+
+
+161 i(
+
+ !
+NULL
+ && (->
+tun_ags
+ & (
+TUN_INITED
+|
+TUN_OPEN
+)) != TUN_OPEN)
+
+162 
+	`tf
+("tun%d: incsiags: %x\n", 
+un
+, 
+
+->
+tun_ags
+);
+
+165  (
+
+);
+
+166 
+	}
+}
+
+169 
+	$tun_e_
+(
+if_e
+ *
+ifc
+, 
+un
+)
+
+171 
+tun_soc
+ *
+
+;
+
+173 i((
+
+ = 
+	`tun_fd_zun
+(
+un
+)=
+NULL
+) {
+
+175 
+
+ = 
+	`mloc
+((*), 
+M_DEVBUF
+, 
+M_WAITOK
+|
+M_ZERO
+);
+
+177 
+
+->
+tun_un
+ = 
+un
+;
+
+178 
+	`mux_
+(&
+
+->
+tun_lock
+, 
+MUTEX_DEFAULT
+, 
+IPL_NET
+);
+
+179 
+	`l
+(&
+
+->
+tun_rl
+);
+
+180 
+	`l
+(&
+
+->
+tun_wl
+);
+
+183 ()
+	`memt
+(&
+
+->
+tun_if
+, 0, (
+i
+));
+
+186 
+	`if_me
+(&
+
+->
+tun_if
+, 
+ifc
+->
+ifc_me
+, 
+un
+);
+
+187 
+	`tuach0
+(
+
+);
+
+188 
+
+->
+tun_ags
+ |
+TUN_INITED
+;
+
+189 
+
+->
+tun_osih
+ = 
+	`sot_eablish
+(
+SOFTINT_CLOCK
+, 
+tun_o_so
+,p);
+
+190 
+
+->
+tun_isih
+ = 
+	`sot_eablish
+(
+SOFTINT_CLOCK
+, 
+tun_i_so
+,p);
+
+192 
+	`mux_r
+(&
+tun_soc_lock
+);
+
+193 
+	`LIST_INSERT_HEAD
+(&
+tun_soc_li
+, 
+
+, 
+tun_li
+);
+
+194 
+	`mux_ex
+(&
+tun_soc_lock
+);
+
+197 
+	}
+}
+
+200 
+	$tuach0
+(
+tun_soc
+ *
+
+)
+
+202 
+i
+ *
+i
+;
+
+204 
+i
+ = &
+
+->
+tun_if
+;
+
+205 
+i
+->
+if_soc
+ = 
+
+;
+
+206 
+i
+->
+if_mtu
+ = 
+TUNMTU
+;
+
+207 
+i
+->
+if_iol
+ = 
+tun_iol
+;
+
+208 
+i
+->
+if_ouut
+ = 
+tun_ouut
+;
+
+209 #ifde
+ALTQ
+
+
+210 
+i
+->
+if_t
+ = 
+tunt
+;
+
+212 
+i
+->
+if_ags
+ = 
+IFF_POINTOPOINT
+;
+
+213 
+i
+->
+if_ty
+ = 
+IFT_TUNNEL
+;
+
+214 
+i
+->
+if_d
+.
+ifq_maxn
+ = 
+ifqmaxn
+;
+
+215 
+i
+->
+if_clisis
+ = 0;
+
+216 
+i
+->
+if_s
+ = 0;
+
+217 
+i
+->
+if_s
+ = 0;
+
+218 
+i
+->
+if_acks
+ = 0;
+
+219 
+i
+->
+if_acks
+ = 0;
+
+220 
+i
+->
+if_ibys
+ = 0;
+
+221 
+i
+->
+if_obys
+ = 0;
+
+222 
+i
+->
+if_d
+ = 
+DLT_NULL
+;
+
+223 
+	`IFQ_SET_READY
+(&
+i
+->
+if_d
+);
+
+224 
+	`if_ch
+(
+i
+);
+
+225 
+	`if_loc_dl
+(
+i
+);
+
+226 
+	`bpf_ch
+(
+i
+, 
+DLT_NULL
+, (
+ut32_t
+));
+
+227 
+	}
+}
+
+230 
+	$tun_e_deroy
+(
+i
+ *
+i
+)
+
+232 
+tun_soc
+ *
+
+ = (*)
+i
+;
+
+233 
+zomb
+ = 0;
+
+235 
+	`IF_PURGE
+(&
+i
+->
+if_d
+);
+
+236 
+i
+->
+if_ags
+ &~
+IFF_RUNNING
+;
+
+238 
+	`mux_r
+(&
+tun_soc_lock
+);
+
+239 
+	`mux_r
+(&
+
+->
+tun_lock
+);
+
+240 
+	`LIST_REMOVE
+(
+
+, 
+tun_li
+);
+
+241 i(
+
+->
+tun_ags
+ & 
+TUN_OPEN
+) {
+
+243 
+zomb
+ = 1;
+
+244 
+
+->
+tun_ags
+ &~
+TUN_INITED
+;
+
+245 
+	`LIST_INSERT_HEAD
+(&
+tunz_soc_li
+, 
+
+, 
+tun_li
+);
+
+247 
+	`mux_ex
+(&
+tun_soc_lock
+);
+
+249 i(
+
+->
+tun_ags
+ & 
+TUN_RWAIT
+) {
+
+250 
+
+->
+tun_ags
+ &~
+TUN_RWAIT
+;
+
+251 
+	`wakeup
+((*)
+
+);
+
+253 
+	`ify
+(&
+
+->
+tun_rl
+, 0, 0);
+
+255 
+	`mux_ex
+(&
+
+->
+tun_lock
+);
+
+257 i(
+
+->
+tun_ags
+ & 
+TUN_ASYNC
+ &&p->
+tun_pgid
+)
+
+258 
+	`fownsigl
+(
+
+->
+tun_pgid
+, 
+SIGIO
+, 
+POLL_HUP
+, 0, 
+NULL
+);
+
+260 
+	`bpf_dach
+(
+i
+);
+
+261 
+	`if_dach
+(
+i
+);
+
+263 i(!
+zomb
+) {
+
+264 
+	`lderoy
+(&
+
+->
+tun_rl
+);
+
+265 
+	`lderoy
+(&
+
+->
+tun_wl
+);
+
+266 
+	`sot_diablish
+(
+
+->
+tun_osih
+);
+
+267 
+	`sot_diablish
+(
+
+->
+tun_isih
+);
+
+268 
+	`mux_deroy
+(&
+
+->
+tun_lock
+);
+
+269 
+	`
+(
+
+, 
+M_DEVBUF
+);
+
+273 
+	}
+}
+
+280 
+	$tun
+(
+dev_t
+ 
+dev
+, 
+ag
+, 
+mode
+, 
+lwp
+ *
+l
+)
+
+282 
+i
+ *
+i
+;
+
+283 
+tun_soc
+ *
+
+;
+
+284 
+r
+;
+
+286 
+r
+ = 
+	`kauth_authize_twk
+(
+l
+->
+l_ed
+, 
+KAUTH_NETWORK_INTERFACE_TUN
+,
+
+287 
+KAUTH_REQ_NETWORK_INTERFACE_TUN_ADD
+, 
+NULL
+, NULL, NULL);
+
+288 i(
+r
+)
+
+289  (
+r
+);
+
+291 
+
+ = 
+	`tun_fd_un
+(
+dev
+);
+
+293 i(
+
+ =
+NULL
+) {
+
+294 ()
+	`tun_e_
+(&
+tun_
+, 
+	`m
+(
+dev
+));
+
+295 
+
+ = 
+	`tun_fd_un
+(
+dev
+);
+
+296 i(
+
+ =
+NULL
+) {
+
+297 
+r
+ = 
+ENXIO
+;
+
+298 
+out_nock
+;
+
+302 i(
+
+->
+tun_ags
+ & 
+TUN_OPEN
+) {
+
+303 
+r
+ = 
+EBUSY
+;
+
+304 
+out
+;
+
+307 
+i
+ = &
+
+->
+tun_if
+;
+
+308 
+
+->
+tun_ags
+ |
+TUN_OPEN
+;
+
+309 
+	`TUNDEBUG
+("%s: on\n", 
+i
+->
+if_xme
+);
+
+310 
+out
+:
+
+311 
+	`mux_ex
+(&
+
+->
+tun_lock
+);
+
+312 
+out_nock
+:
+
+313  (
+r
+);
+
+314 
+	}
+}
+
+321 
+	$tuno
+(
+dev_t
+ 
+dev
+, 
+ag
+, 
+mode
+,
+
+322 
+lwp
+ *
+l
+)
+
+324 
+tun_soc
+ *
+
+;
+
+325 
+i
+ *
+i
+;
+
+327 i((
+
+ = 
+	`tun_fd_zun
+(
+	`m
+(
+dev
+))!
+NULL
+) {
+
+329 
+	`lderoy
+(&
+
+->
+tun_rl
+);
+
+330 
+	`lderoy
+(&
+
+->
+tun_wl
+);
+
+331 
+	`sot_diablish
+(
+
+->
+tun_osih
+);
+
+332 
+	`sot_diablish
+(
+
+->
+tun_isih
+);
+
+333 
+	`mux_deroy
+(&
+
+->
+tun_lock
+);
+
+334 
+	`
+(
+
+, 
+M_DEVBUF
+);
+
+335 
+out_nock
+;
+
+338 i((
+
+ = 
+	`tun_fd_un
+(
+dev
+)=
+NULL
+)
+
+339 
+out_nock
+;
+
+341 
+i
+ = &
+
+->
+tun_if
+;
+
+343 
+
+->
+tun_ags
+ &~
+TUN_OPEN
+;
+
+345 
+
+->
+tun_pgid
+ = 0;
+
+346 
+	`ify
+(&
+
+->
+tun_rl
+, 0, 0);
+
+348 
+	`TUNDEBUG
+ ("%s: clod\n", 
+i
+->
+if_xme
+);
+
+349 
+	`mux_ex
+(&
+
+->
+tun_lock
+);
+
+354 
+	`IFQ_PURGE
+(&
+i
+->
+if_d
+);
+
+356 i(
+i
+->
+if_ags
+ & 
+IFF_UP
+) {
+
+357 
+	`if_down
+(
+i
+);
+
+358 i(
+i
+->
+if_ags
+ & 
+IFF_RUNNING
+) {
+
+360 
+iddr
+ *
+i
+;
+
+361 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+) {
+
+362 #i
+	`defed
+(
+INET
+|| defed(
+INET6
+)
+
+363 i(
+i
+->
+i_addr
+->
+_my
+ =
+AF_INET
+ ||
+
+364 
+i
+->
+i_addr
+->
+_my
+ =
+AF_INET6
+) {
+
+365 
+	`
+(
+i
+, ()
+RTM_DELETE
+,
+
+366 
+
+->
+tun_ags
+ & 
+TUN_DSTADDR
+
+
+367 ? 
+RTF_HOST
+
+
+374 
+out_nock
+:
+
+376 
+	}
+}
+
+382 
+	$tun
+(
+tun_soc
+ *
+
+)
+
+384 
+i
+ *
+i
+ = &
+
+->
+tun_if
+;
+
+385 
+iddr
+ *
+i
+;
+
+387 
+	`TUNDEBUG
+("%s:un\n", 
+i
+->
+if_xme
+);
+
+389 
+	`mux_r
+(&
+
+->
+tun_lock
+);
+
+390 
+i
+->
+if_ags
+ |
+IFF_UP
+ | 
+IFF_RUNNING
+;
+
+392 
+
+->
+tun_ags
+ &~(
+TUN_IASET
+|
+TUN_DSTADDR
+);
+
+393 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+) {
+
+394 #ifde
+INET
+
+
+395 i(
+i
+->
+i_addr
+->
+_my
+ =
+AF_INET
+) {
+
+396 
+sockaddr_
+ *
+s
+;
+
+398 
+s
+ = 
+	`tos
+(
+i
+->
+i_addr
+);
+
+399 i(
+s
+ && s->
+s_addr
+.
+s_addr
+)
+
+400 
+
+->
+tun_ags
+ |
+TUN_IASET
+;
+
+402 i(
+i
+->
+if_ags
+ & 
+IFF_POINTOPOINT
+) {
+
+403 
+s
+ = 
+	`tos
+(
+i
+->
+i_daddr
+);
+
+404 i(
+s
+ && s->
+s_addr
+.
+s_addr
+)
+
+405 
+
+->
+tun_ags
+ |
+TUN_DSTADDR
+;
+
+409 #ifde
+INET6
+
+
+410 i(
+i
+->
+i_addr
+->
+_my
+ =
+AF_INET6
+) {
+
+411 
+sockaddr_6
+ *
+s
+;
+
+413 
+s
+ = (
+sockaddr_6
+ *)
+i
+->
+i_addr
+;
+
+414 i(!
+	`IN6_IS_ADDR_UNSPECIFIED
+(&
+s
+->
+s6_addr
+))
+
+415 
+
+->
+tun_ags
+ |
+TUN_IASET
+;
+
+417 i(
+i
+->
+if_ags
+ & 
+IFF_POINTOPOINT
+) {
+
+418 
+s
+ = (
+sockaddr_6
+ *)
+i
+->
+i_daddr
+;
+
+419 i(
+s
+ &&
+
+420 !
+	`IN6_IS_ADDR_UNSPECIFIED
+(&
+s
+->
+s6_addr
+))
+
+421 
+
+->
+tun_ags
+ |
+TUN_DSTADDR
+;
+
+423 
+
+->
+tun_ags
+ &~
+TUN_DSTADDR
+;
+
+427 
+	`mux_ex
+(&
+
+->
+tun_lock
+);
+
+428 
+	}
+}
+
+434 
+	$tun_iol
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+436 
+r
+ = 0, 
+s
+;
+
+437 
+tun_soc
+ *
+
+ = (tun_so*)(
+i
+->
+if_soc
+);
+
+438 
+ieq
+ *
+i
+ = (ieq *)
+da
+;
+
+439 
+iddr
+ *
+i
+ = (idd*)
+da
+;
+
+441 
+s
+ = 
+	`
+();
+
+443 
+cmd
+) {
+
+444 
+SIOCINITIFADDR
+:
+
+445 
+	`tun
+(
+
+);
+
+446 
+i
+->
+i_que
+ = 
+p2p_que
+;
+
+447 
+	`TUNDEBUG
+("%s:ddst\n", 
+i
+->
+if_xme
+);
+
+449 
+SIOCSIFBRDADDR
+:
+
+450 
+	`TUNDEBUG
+("%s: brdddst\n", 
+i
+->
+if_xme
+);
+
+452 
+SIOCSIFMTU
+:
+
+453 i(
+i
+->
+i_mtu
+ > 
+TUNMTU
+ || ifr->ifr_mtu < 576) {
+
+454 
+r
+ = 
+EINVAL
+;
+
+457 
+	`TUNDEBUG
+("%s: i mtu s\n", 
+i
+->
+if_xme
+);
+
+458 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)=
+ENETRESET
+)
+
+459 
+r
+ = 0;
+
+461 
+SIOCADDMULTI
+:
+
+462 
+SIOCDELMULTI
+:
+
+463 i(
+i
+ =
+NULL
+) {
+
+464 
+r
+ = 
+EAFNOSUPPORT
+;
+
+467 
+	`ieq_gaddr
+(
+cmd
+, 
+i
+)->
+_my
+) {
+
+468 #ifde
+INET
+
+
+469 
+AF_INET
+:
+
+472 #ifde
+INET6
+
+
+473 
+AF_INET6
+:
+
+477 
+r
+ = 
+EAFNOSUPPORT
+;
+
+482 
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+);
+
+485 
+	`lx
+(
+s
+);
+
+486  (
+r
+);
+
+487 
+	}
+}
+
+493 
+	$tun_ouut
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m0
+, c 
+sockaddr
+ *
+d
+,
+
+494 
+y
+ *
+
+)
+
+496 
+tun_soc
+ *
+
+ = 
+i
+->
+if_soc
+;
+
+497 
+s
+;
+
+498 
+r
+;
+
+499 #i
+	`defed
+(
+INET
+|| defed(
+INET6
+)
+
+500 
+mn
+;
+
+501 
+ut32_t
+ *
+af
+;
+
+503 
+	`ALTQ_DECL
+(
+tq_pkr
+ 
+pkr
+;)
+
+505 
+s
+ = 
+	`
+();
+
+506 
+	`mux_r
+(&
+
+->
+tun_lock
+);
+
+507 
+	`TUNDEBUG
+ ("%s:un_ouut\n", 
+i
+->
+if_xme
+);
+
+509 i((
+
+->
+tun_ags
+ & 
+TUN_READY
+) != TUN_READY) {
+
+510 
+	`TUNDEBUG
+ ("%s:dy 0%o\n", 
+i
+->
+if_xme
+,
+
+511 
+
+->
+tun_ags
+);
+
+512 
+r
+ = 
+EHOSTDOWN
+;
+
+513 
+out
+;
+
+520 
+	`IFQ_CLASSIFY
+(&
+i
+->
+if_d
+, 
+m0
+, 
+d
+->
+_my
+, &
+pkr
+);
+
+522 
+	`bpf_mp_af
+(
+i
+, 
+d
+->
+_my
+, 
+m0
+);
+
+524 
+d
+->
+_my
+) {
+
+525 #ifde
+INET6
+
+
+526 
+AF_INET6
+:
+
+528 #ifde
+INET
+
+
+529 
+AF_INET
+:
+
+531 #i
+	`defed
+(
+INET
+|| defed(
+INET6
+)
+
+532 i(
+
+->
+tun_ags
+ & 
+TUN_PREPADDR
+) {
+
+534 
+	`M_PREPEND
+(
+m0
+, 
+d
+->
+_n
+, 
+M_DONTWAIT
+);
+
+535 i(
+m0
+ =
+NULL
+) {
+
+536 
+	`IF_DROP
+(&
+i
+->
+if_d
+);
+
+537 
+r
+ = 
+ENOBUFS
+;
+
+538 
+out
+;
+
+540 
+	`bcy
+(
+d
+, 
+	`mtod
+(
+m0
+, *), d->
+_n
+);
+
+543 i(
+
+->
+tun_ags
+ & 
+TUN_IFHEAD
+) {
+
+545 
+	`M_PREPEND
+(
+m0
+, (*
+af
+), 
+M_DONTWAIT
+);
+
+546 i(
+m0
+ =
+NULL
+) {
+
+547 
+	`IF_DROP
+(&
+i
+->
+if_d
+);
+
+548 
+r
+ = 
+ENOBUFS
+;
+
+549 
+out
+;
+
+551 
+af
+ = 
+	`mtod
+(
+m0
+,
+ut32_t
+ *);
+
+552 *
+af
+ = 
+	`htl
+(
+d
+->
+_my
+);
+
+554 #ifde
+INET
+
+
+555 i(
+d
+->
+_my
+ !
+AF_INET
+)
+
+558 
+r
+ = 
+EAFNOSUPPORT
+;
+
+559 
+out
+;
+
+563 
+AF_UNSPEC
+:
+
+564 
+	`IFQ_ENQUEUE
+(&
+i
+->
+if_d
+, 
+m0
+, &
+pkr
+, 
+r
+);
+
+565 i(
+r
+) {
+
+566 
+i
+->
+if_clisis
+++;
+
+567 
+r
+ = 
+EAFNOSUPPORT
+;
+
+568 
+m0
+ = 
+NULL
+;
+
+569 
+out
+;
+
+571 
+mn
+ = 
+m0
+->
+m_pkthdr
+.
+n
+;
+
+572 
+i
+->
+if_acks
+++;
+
+573 
+i
+->
+if_obys
+ +
+mn
+;
+
+577 
+r
+ = 
+EAFNOSUPPORT
+;
+
+578 
+out
+;
+
+581 i(
+
+->
+tun_ags
+ & 
+TUN_RWAIT
+) {
+
+582 
+
+->
+tun_ags
+ &~
+TUN_RWAIT
+;
+
+583 
+	`wakeup
+((*)
+
+);
+
+585 i(
+
+->
+tun_ags
+ & 
+TUN_ASYNC
+ &&p->
+tun_pgid
+)
+
+586 
+	`sot_schedu
+(
+
+->
+tun_isih
+);
+
+588 
+	`ify
+(&
+
+->
+tun_rl
+, 0, 0);
+
+589 
+out
+:
+
+590 
+	`mux_ex
+(&
+
+->
+tun_lock
+);
+
+591 
+	`lx
+(
+s
+);
+
+593 i(
+r
+ && 
+m0
+) {
+
+594 
+	`m_m
+(
+m0
+);
+
+597 
+	}
+}
+
+600 
+	$tun_i_so
+(*
+cook
+)
+
+602 
+tun_soc
+ *
+
+ = 
+cook
+;
+
+604 i(
+
+->
+tun_ags
+ & 
+TUN_ASYNC
+ &&p->
+tun_pgid
+)
+
+605 
+	`fownsigl
+(
+
+->
+tun_pgid
+, 
+SIGIO
+, 
+POLL_IN
+, 
+POLLIN
+|
+POLLRDNORM
+,
+
+606 
+NULL
+);
+
+607 
+	}
+}
+
+610 
+	$tun_o_so
+(*
+cook
+)
+
+612 
+tun_soc
+ *
+
+ = 
+cook
+;
+
+614 i(
+
+->
+tun_ags
+ & 
+TUN_ASYNC
+ &&p->
+tun_pgid
+)
+
+615 
+	`fownsigl
+(
+
+->
+tun_pgid
+, 
+SIGIO
+, 
+POLL_OUT
+, 
+POLLOUT
+|
+POLLWRNORM
+,
+
+616 
+NULL
+);
+
+617 
+	}
+}
+
+623 
+	$tuniol
+(
+dev_t
+ 
+dev
+, 
+u_lg
+ 
+cmd
+, *
+da
+, 
+ag
+, 
+lwp
+ *
+l
+)
+
+625 
+tun_soc
+ *
+
+;
+
+626 
+s
+, 
+r
+ = 0;
+
+628 
+s
+ = 
+	`
+();
+
+629 
+
+ = 
+	`tun_fd_un
+(
+dev
+);
+
+632 i(
+
+ =
+NULL
+) {
+
+633 
+r
+ = 
+ENXIO
+;
+
+634 
+out_nock
+;
+
+637 
+cmd
+) {
+
+638 
+TUNSDEBUG
+:
+
+639 
+tundebug
+ = *(*)
+da
+;
+
+642 
+TUNGDEBUG
+:
+
+643 *(*)
+da
+ = 
+tundebug
+;
+
+646 
+TUNSIFMODE
+:
+
+647 *(*)
+da
+ & (
+IFF_POINTOPOINT
+|
+IFF_BROADCAST
+)) {
+
+648 
+IFF_POINTOPOINT
+:
+
+649 
+IFF_BROADCAST
+:
+
+650 i(
+
+->
+tun_if
+.
+if_ags
+ & 
+IFF_UP
+) {
+
+651 
+r
+ = 
+EBUSY
+;
+
+652 
+out
+;
+
+654 
+
+->
+tun_if
+.
+if_ags
+ &=
+
+655 ~(
+IFF_BROADCAST
+|
+IFF_POINTOPOINT
+|
+IFF_MULTICAST
+);
+
+656 
+
+->
+tun_if
+.
+if_ags
+ |*(*)
+da
+;
+
+659 
+r
+ = 
+EINVAL
+;
+
+660 
+out
+;
+
+664 
+TUNSLMODE
+:
+
+665 i(*(*)
+da
+) {
+
+666 
+
+->
+tun_ags
+ |
+TUN_PREPADDR
+;
+
+667 
+
+->
+tun_ags
+ &~
+TUN_IFHEAD
+;
+
+669 
+
+->
+tun_ags
+ &~
+TUN_PREPADDR
+;
+
+672 
+TUNSIFHEAD
+:
+
+673 i(*(*)
+da
+) {
+
+674 
+
+->
+tun_ags
+ |
+TUN_IFHEAD
+;
+
+675 
+
+->
+tun_ags
+ &~
+TUN_PREPADDR
+;
+
+677 
+
+->
+tun_ags
+ &~
+TUN_IFHEAD
+;
+
+680 
+TUNGIFHEAD
+:
+
+681 *(*)
+da
+ = (
+
+->
+tun_ags
+ & 
+TUN_IFHEAD
+);
+
+684 
+FIONBIO
+:
+
+685 i(*(*)
+da
+)
+
+686 
+
+->
+tun_ags
+ |
+TUN_NBIO
+;
+
+688 
+
+->
+tun_ags
+ &~
+TUN_NBIO
+;
+
+691 
+FIOASYNC
+:
+
+692 i(*(*)
+da
+)
+
+693 
+
+->
+tun_ags
+ |
+TUN_ASYNC
+;
+
+695 
+
+->
+tun_ags
+ &~
+TUN_ASYNC
+;
+
+698 
+FIONREAD
+:
+
+699 i(
+
+->
+tun_if
+.
+if_d
+.
+ifq_hd
+)
+
+700 *(*)
+da
+ = 
+
+->
+tun_if
+.
+if_d
+.
+ifq_hd
+->
+m_pkthdr
+.
+n
+;
+
+702 *(*)
+da
+ = 0;
+
+705 
+TIOCSPGRP
+:
+
+706 
+FIOSETOWN
+:
+
+707 
+r
+ = 
+	`ftown
+(&
+
+->
+tun_pgid
+, 
+cmd
+, 
+da
+);
+
+710 
+TIOCGPGRP
+:
+
+711 
+FIOGETOWN
+:
+
+712 
+r
+ = 
+	`fgown
+(
+
+->
+tun_pgid
+, 
+cmd
+, 
+da
+);
+
+716 
+r
+ = 
+ENOTTY
+;
+
+719 
+out
+:
+
+720 
+	`mux_ex
+(&
+
+->
+tun_lock
+);
+
+721 
+out_nock
+:
+
+722 
+	`lx
+(
+s
+);
+
+723  (
+r
+);
+
+724 
+	}
+}
+
+731 
+	$tud
+(
+dev_t
+ 
+dev
+, 
+uio
+ *uio, 
+ioag
+)
+
+733 
+tun_soc
+ *
+
+;
+
+734 
+i
+ *
+i
+;
+
+735 
+mbuf
+ *
+m
+, *
+m0
+;
+
+736 
+r
+ = 0, 
+n
+, 
+s
+, 
+dex
+;
+
+738 
+s
+ = 
+	`
+();
+
+739 
+
+ = 
+	`tun_fd_un
+(
+dev
+);
+
+742 i(
+
+ =
+NULL
+) {
+
+743 
+r
+ = 
+ENXIO
+;
+
+744 
+out_nock
+;
+
+747 
+dex
+ = 
+
+->
+tun_if
+.
+if_dex
+;
+
+748 
+i
+ = &
+
+->
+tun_if
+;
+
+750 
+	`TUNDEBUG
+ ("%s:d\n", 
+i
+->
+if_xme
+);
+
+751 i((
+
+->
+tun_ags
+ & 
+TUN_READY
+) != TUN_READY) {
+
+752 
+	`TUNDEBUG
+ ("%s:dy 0%o\n", 
+i
+->
+if_xme
+, 
+
+->
+tun_ags
+);
+
+753 
+r
+ = 
+EHOSTDOWN
+;
+
+754 
+out
+;
+
+757 
+
+->
+tun_ags
+ &~
+TUN_RWAIT
+;
+
+760 
+	`IFQ_DEQUEUE
+(&
+i
+->
+if_d
+, 
+m0
+);
+
+761 i(
+m0
+ == 0) {
+
+762 i(
+
+->
+tun_ags
+ & 
+TUN_NBIO
+) {
+
+763 
+r
+ = 
+EWOULDBLOCK
+;
+
+764 
+out
+;
+
+766 
+
+->
+tun_ags
+ |
+TUN_RWAIT
+;
+
+767 i(
+	`mtp
+((*)
+
+, 
+PZERO
+|
+PCATCH
+|
+PNORELOCK
+,
+
+768 "tud", 0, &
+
+->
+tun_lock
+) != 0) {
+
+769 
+r
+ = 
+EINTR
+;
+
+770 
+out_nock
+;
+
+778 
+
+ = 
+	`tun_fd_un
+(
+dev
+);
+
+779 i(
+
+ =
+NULL
+) {
+
+780 
+r
+ = 
+ENXIO
+;
+
+781 
+out_nock
+;
+
+783 i(
+
+->
+tun_if
+.
+if_dex
+ !
+dex
+) {
+
+784 
+r
+ = 
+ENXIO
+;
+
+785 
+out
+;
+
+789 } 
+m0
+ == 0);
+
+791 
+	`mux_ex
+(&
+
+->
+tun_lock
+);
+
+792 
+	`lx
+(
+s
+);
+
+795 
+m0
+ && 
+uio
+->
+uio_sid
+ > 0 && 
+r
+ == 0) {
+
+796 
+n
+ = 
+	`m
+(
+uio
+->
+uio_sid
+, 
+m0
+->
+m_n
+);
+
+797 i(
+n
+ != 0)
+
+798 
+r
+ = 
+	`uiomove
+(
+	`mtod
+(
+m0
+, *), 
+n
+, 
+uio
+);
+
+799 
+	`MFREE
+(
+m0
+, 
+m
+);
+
+800 
+m0
+ = 
+m
+;
+
+803 i(
+m0
+) {
+
+804 
+	`TUNDEBUG
+("Dropping mbuf\n");
+
+805 
+	`m_m
+(
+m0
+);
+
+807 i(
+r
+)
+
+808 
+i
+->
+if_s
+++;
+
+810  (
+r
+);
+
+812 
+out
+:
+
+813 
+	`mux_ex
+(&
+
+->
+tun_lock
+);
+
+814 
+out_nock
+:
+
+815 
+	`lx
+(
+s
+);
+
+816  (
+r
+);
+
+817 
+	}
+}
+
+823 
+	$tunwre
+(
+dev_t
+ 
+dev
+, 
+uio
+ *uio, 
+ioag
+)
+
+825 
+tun_soc
+ *
+
+;
+
+826 
+i
+ *
+i
+;
+
+827 
+mbuf
+ *
+t
+, **
+mp
+, *
+m
+;
+
+828 
+pktqueue_t
+ *
+pktq
+;
+
+829 
+sockaddr
+ 
+d
+;
+
+830 
+r
+ = 0, 
+s
+, 
+
+, 
+mn
+;
+
+831 
+ut32_t
+ 
+my
+;
+
+833 
+s
+ = 
+	`
+();
+
+834 
+
+ = 
+	`tun_fd_un
+(
+dev
+);
+
+837 i(
+
+ =
+NULL
+) {
+
+838 
+r
+ = 
+ENXIO
+;
+
+839 
+out_nock
+;
+
+843 
+	`mux_ex
+(&
+
+->
+tun_lock
+);
+
+844 
+	`lx
+(
+s
+);
+
+846 
+i
+ = &
+
+->
+tun_if
+;
+
+848 
+	`TUNDEBUG
+("%s:unwre\n", 
+i
+->
+if_xme
+);
+
+850 i(
+
+->
+tun_ags
+ & 
+TUN_PREPADDR
+) {
+
+851 i(
+uio
+->
+uio_sid
+ < (
+d
+)) {
+
+852 
+r
+ = 
+EIO
+;
+
+853 
+out0
+;
+
+855 
+r
+ = 
+	`uiomove
+((*)&
+d
+, (d), 
+uio
+);
+
+856 i(
+d
+.
+_n
+ > (dst)) {
+
+858 
+disrd
+;
+
+859 
+n
+ = 
+d
+.
+_n
+ - (dst);
+
+860 
+n
+--)
+
+861 i((
+r
+ = 
+	`uiomove
+(&
+disrd
+, 1, 
+uio
+)) != 0) {
+
+862 
+out0
+;
+
+865 } i(
+
+->
+tun_ags
+ & 
+TUN_IFHEAD
+) {
+
+866 i(
+uio
+->
+uio_sid
+ < (
+my
+)){
+
+867 
+r
+ = 
+EIO
+;
+
+868 
+out0
+;
+
+870 
+r
+ = 
+	`uiomove
+((*)&
+my
+, (my), 
+uio
+);
+
+871 
+d
+.
+_my
+ = 
+	`ohl
+(
+my
+);
+
+873 #ifde
+INET
+
+
+874 
+d
+.
+_my
+ = 
+AF_INET
+;
+
+878 i(
+uio
+->
+uio_sid
+ > 
+TUNMTU
+) {
+
+879 
+	`TUNDEBUG
+("%s:=%lu!\n", 
+i
+->
+if_xme
+,
+
+880 ()
+uio
+->
+uio_sid
+);
+
+881 
+r
+ = 
+EIO
+;
+
+882 
+out0
+;
+
+885 
+d
+.
+_my
+) {
+
+886 #ifde
+INET
+
+
+887 
+AF_INET
+:
+
+888 
+pktq
+ = 
+_pktq
+;
+
+891 #ifde
+INET6
+
+
+892 
+AF_INET6
+:
+
+893 
+pktq
+ = 
+6_pktq
+;
+
+897 
+r
+ = 
+EAFNOSUPPORT
+;
+
+898 
+out0
+;
+
+901 
+
+ = 
+uio
+->
+uio_sid
+;
+
+904 
+	`MGETHDR
+(
+m
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+905 i(
+m
+ =
+NULL
+) {
+
+906 
+r
+ = 
+ENOBUFS
+;
+
+907 
+out0
+;
+
+909 
+mn
+ = 
+MHLEN
+;
+
+911 
+t
+ = 
+NULL
+;
+
+912 
+mp
+ = &
+t
+;
+
+913 
+r
+ =0 && 
+uio
+->
+uio_sid
+ > 0) {
+
+914 
+m
+->
+m_n
+ = 
+	`m
+(
+mn
+, 
+uio
+->
+uio_sid
+);
+
+915 
+r
+ = 
+	`uiomove
+(
+	`mtod
+(
+m
+, *), m->
+m_n
+, 
+uio
+);
+
+916 *
+mp
+ = 
+m
+;
+
+917 
+mp
+ = &
+m
+->
+m_xt
+;
+
+918 i(
+r
+ =0 && 
+uio
+->
+uio_sid
+ > 0) {
+
+919 
+	`MGET
+(
+m
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+920 i(
+m
+ =
+NULL
+) {
+
+921 
+r
+ = 
+ENOBUFS
+;
+
+924 
+mn
+ = 
+MLEN
+;
+
+927 i(
+r
+) {
+
+928 i(
+t
+ !
+NULL
+)
+
+929 
+	`m_m
+ (
+t
+);
+
+930 
+i
+->
+if_s
+++;
+
+931 
+out0
+;
+
+934 
+t
+->
+m_pkthdr
+.
+n
+ = 
+
+;
+
+935 
+t
+->
+m_pkthdr
+.
+rcvif
+ = 
+i
+;
+
+937 
+	`bpf_mp_af
+(
+i
+, 
+d
+.
+_my
+, 
+t
+);
+
+939 
+s
+ = 
+	`
+();
+
+940 
+	`mux_r
+(&
+
+->
+tun_lock
+);
+
+941 i((
+
+->
+tun_ags
+ & 
+TUN_INITED
+) == 0) {
+
+943 
+r
+ = 
+ENXIO
+;
+
+944 
+out
+;
+
+946 i(
+	`__edi_l
+(!
+	`pktq_queue
+(
+pktq
+, 
+t
+, 0))) {
+
+947 
+i
+->
+if_clisis
+++;
+
+948 
+	`mux_ex
+(&
+
+->
+tun_lock
+);
+
+949 
+r
+ = 
+ENOBUFS
+;
+
+950 
+	`m_m
+(
+t
+);
+
+951 
+out_nock
+;
+
+953 
+i
+->
+if_acks
+++;
+
+954 
+i
+->
+if_ibys
+ +
+
+;
+
+955 
+out
+:
+
+956 
+	`mux_ex
+(&
+
+->
+tun_lock
+);
+
+957 
+out_nock
+:
+
+958 
+	`lx
+(
+s
+);
+
+959 
+out0
+:
+
+960  (
+r
+);
+
+961 
+	}
+}
+
+963 #ifde
+ALTQ
+
+
+973 
+	$tunt
+(
+i
+ *
+i
+)
+
+975 
+tun_soc
+ *
+
+ = 
+i
+->
+if_soc
+;
+
+977 i(!
+	`ALTQ_IS_ENABLED
+(&
+i
+->
+if_d
+&& !
+	`TBR_IS_ENABLED
+(&ifp->if_snd))
+
+980 
+	`mux_r
+(&
+
+->
+tun_lock
+);
+
+981 i(!
+	`IF_IS_EMPTY
+(&
+i
+->
+if_d
+)) {
+
+982 i(
+
+->
+tun_ags
+ & 
+TUN_RWAIT
+) {
+
+983 
+
+->
+tun_ags
+ &~
+TUN_RWAIT
+;
+
+984 
+	`wakeup
+((*)
+
+);
+
+986 i(
+
+->
+tun_ags
+ & 
+TUN_ASYNC
+ &&p->
+tun_pgid
+)
+
+987 
+	`sot_schedu
+(
+
+->
+tun_osih
+);
+
+989 
+	`ify
+(&
+
+->
+tun_rl
+, 0, 0);
+
+991 
+	`mux_ex
+(&
+
+->
+tun_lock
+);
+
+992 
+	}
+}
+
+1000 
+	$tul
+(
+dev_t
+ 
+dev
+, 
+evts
+, 
+lwp
+ *
+l
+)
+
+1002 
+tun_soc
+ *
+
+;
+
+1003 
+i
+ *
+i
+;
+
+1004 
+s
+, 
+vts
+ = 0;
+
+1006 
+s
+ = 
+	`
+();
+
+1007 
+
+ = 
+	`tun_fd_un
+(
+dev
+);
+
+1010 i(
+
+ =
+NULL
+)
+
+1011 
+out_nock
+;
+
+1013 
+i
+ = &
+
+->
+tun_if
+;
+
+1015 
+	`TUNDEBUG
+("%s:ul\n", 
+i
+->
+if_xme
+);
+
+1017 i(
+evts
+ & (
+POLLIN
+ | 
+POLLRDNORM
+)) {
+
+1018 i(!
+	`IFQ_IS_EMPTY
+(&
+i
+->
+if_d
+)) {
+
+1019 
+	`TUNDEBUG
+("%s:uq=%d\n", 
+i
+->
+if_xme
+,
+
+1020 
+i
+->
+if_d
+.
+ifq_n
+);
+
+1021 
+vts
+ |
+evts
+ & (
+POLLIN
+ | 
+POLLRDNORM
+);
+
+1023 
+	`TUNDEBUG
+("%s:uwag\n", 
+i
+->
+if_xme
+);
+
+1024 
+	`ecd
+(
+l
+, &
+
+->
+tun_rl
+);
+
+1028 i(
+evts
+ & (
+POLLOUT
+ | 
+POLLWRNORM
+))
+
+1029 
+vts
+ |
+evts
+ & (
+POLLOUT
+ | 
+POLLWRNORM
+);
+
+1031 
+	`mux_ex
+(&
+
+->
+tun_lock
+);
+
+1032 
+out_nock
+:
+
+1033 
+	`lx
+(
+s
+);
+
+1034  (
+vts
+);
+
+1035 
+	}
+}
+
+1038 
+	$ft_tudach
+(
+kne
+ *
+kn
+)
+
+1040 
+tun_soc
+ *
+
+ = 
+kn
+->
+kn_hook
+;
+
+1041 
+s
+;
+
+1043 
+s
+ = 
+	`
+();
+
+1044 
+	`SLIST_REMOVE
+(&
+
+->
+tun_rl
+.
+l_kli
+, 
+kn
+, 
+kne
+, 
+kn_ext
+);
+
+1045 
+	`lx
+(
+s
+);
+
+1046 
+	}
+}
+
+1049 
+	$ft_tud
+(
+kne
+ *
+kn
+, 
+ht
+)
+
+1051 
+tun_soc
+ *
+
+ = 
+kn
+->
+kn_hook
+;
+
+1052 
+i
+ *
+i
+ = &
+
+->
+tun_if
+;
+
+1053 
+mbuf
+ *
+m
+;
+
+1054 
+s
+;
+
+1056 
+s
+ = 
+	`
+();
+
+1057 
+	`IF_POLL
+(&
+i
+->
+if_d
+, 
+m
+);
+
+1058 i(
+m
+ =
+NULL
+) {
+
+1059 
+	`lx
+(
+s
+);
+
+1063 
+kn
+->
+kn_da
+ = 0; 
+m
+ !
+NULL
+; m = m->
+m_xt
+)
+
+1064 
+kn
+->
+kn_da
+ +
+m
+->
+m_n
+;
+
+1066 
+	`lx
+(
+s
+);
+
+1068 
+	}
+}
+
+1070 c 
+frs
+ 
+	gtud_fts
+ =
+
+1071 { 1, 
+NULL
+, 
+ft_tudach
+, 
+ft_tud
+ };
+
+1073 c 
+frs
+ 
+	gtun_rue_fts
+ =
+
+1074 { 1, 
+NULL
+, 
+ft_tudach
+, 
+ft_rue
+ };
+
+1077 
+	$tunkqfr
+(
+dev_t
+ 
+dev
+, 
+kne
+ *
+kn
+)
+
+1079 
+tun_soc
+ *
+
+;
+
+1080 
+kli
+ *klist;
+
+1081 
+rv
+ = 0, 
+s
+;
+
+1083 
+s
+ = 
+	`
+();
+
+1084 
+
+ = 
+	`tun_fd_un
+(
+dev
+);
+
+1085 i(
+
+ =
+NULL
+)
+
+1086 
+out_nock
+;
+
+1088 
+kn
+->
+kn_fr
+) {
+
+1089 
+EVFILT_READ
+:
+
+1090 
+kli
+ = &
+
+->
+tun_rl
+.
+l_kli
+;
+
+1091 
+kn
+->
+kn_f
+ = &
+tud_fts
+;
+
+1094 
+EVFILT_WRITE
+:
+
+1095 
+kli
+ = &
+
+->
+tun_rl
+.
+l_kli
+;
+
+1096 
+kn
+->
+kn_f
+ = &
+tun_rue_fts
+;
+
+1100 
+rv
+ = 
+EINVAL
+;
+
+1101 
+out
+;
+
+1104 
+kn
+->
+kn_hook
+ = 
+
+;
+
+1106 
+	`SLIST_INSERT_HEAD
+(
+kli
+, 
+kn
+, 
+kn_ext
+);
+
+1108 
+out
+:
+
+1109 
+	`mux_ex
+(&
+
+->
+tun_lock
+);
+
+1110 
+out_nock
+:
+
+1111 
+	`lx
+(
+s
+);
+
+1112  (
+rv
+);
+
+1113 
+	}
+}
+
+	@if_tun.h
+
+19 #ide
+_NET_IF_TUN_H_
+
+
+20 
+	#_NET_IF_TUN_H_
+
+
+	)
+
+22 #ifde
+_KERNEL
+
+
+23 
+	stun_soc
+ {
+
+24 
+i
+ 
+	mtun_if
+;
+
+26 
+u_sht
+ 
+	mtun_ags
+;
+
+27 
+	#TUN_OPEN
+ 0x0001
+
+	)
+
+28 
+	#TUN_INITED
+ 0x0002
+
+	)
+
+29 
+	#TUN_RCOLL
+ 0x0004
+
+	)
+
+30 
+	#TUN_IASET
+ 0x0008
+
+	)
+
+31 
+	#TUN_DSTADDR
+ 0x0010
+
+	)
+
+32 
+	#TUN_RWAIT
+ 0x0040
+
+	)
+
+33 
+	#TUN_ASYNC
+ 0x0080
+
+	)
+
+34 
+	#TUN_NBIO
+ 0x0100
+
+	)
+
+35 
+	#TUN_PREPADDR
+ 0x0200
+
+	)
+
+36 
+	#TUN_IFHEAD
+ 0x0400
+
+	)
+
+38 
+	#TUN_READY
+ (
+TUN_OPEN
+ | 
+TUN_INITED
+ | 
+TUN_IASET
+)
+
+	)
+
+40 
+pid_t
+ 
+	mtun_pgid
+;
+
+41 
+lfo
+ 
+	mtun_rl
+;
+
+42 
+lfo
+ 
+	mtun_wl
+;
+
+43 
+	mtun_un
+;
+
+44 
+kmux_t
+ 
+	mtun_lock
+;
+
+45 
+LIST_ENTRY
+(
+tun_soc
+
+	mtun_li
+;
+
+46 *
+	mtun_osih
+;
+
+47 *
+	mtun_isih
+;
+
+52 
+	#TUNMTU
+ 1500
+
+	)
+
+55 
+	#TUNSDEBUG
+ 
+	`_IOW
+('t', 90, )
+
+	)
+
+56 
+	#TUNGDEBUG
+ 
+	`_IOR
+('t', 89, )
+
+	)
+
+57 
+	#TUNSIFMODE
+ 
+	`_IOW
+('t', 88, )
+
+	)
+
+58 
+	#TUNSLMODE
+ 
+	`_IOW
+('t', 87, )
+
+	)
+
+59 
+	#TUNSIFHEAD
+ 
+	`_IOW
+('t', 66, )
+
+	)
+
+60 
+	#TUNGIFHEAD
+ 
+	`_IOR
+('t', 65, )
+
+	)
+
+	@if_types.h
+
+34 #ide
+_NET_IF_TYPES_H_
+
+
+35 
+	#_NET_IF_TYPES_H_
+
+
+	)
+
+45 
+	#IFT_OTHER
+ 0x1
+
+	)
+
+46 
+	#IFT_1822
+ 0x2
+
+	)
+
+47 
+	#IFT_HDH1822
+ 0x3
+
+	)
+
+48 
+	#IFT_X25DDN
+ 0x4
+
+	)
+
+49 
+	#IFT_X25
+ 0x5
+
+	)
+
+50 
+	#IFT_ETHER
+ 0x6
+
+	)
+
+51 
+	#IFT_ISO88023
+ 0x7
+
+	)
+
+52 
+	#IFT_ISO88024
+ 0x8
+
+	)
+
+53 
+	#IFT_ISO88025
+ 0x9
+
+	)
+
+54 
+	#IFT_ISO88026
+ 0x
+
+	)
+
+55 
+	#IFT_STARLAN
+ 0xb
+
+	)
+
+56 
+	#IFT_P10
+ 0x
+
+	)
+
+57 
+	#IFT_P80
+ 0xd
+
+	)
+
+58 
+	#IFT_HY
+ 0x
+
+	)
+
+59 
+	#IFT_FDDI
+ 0xf
+
+	)
+
+60 
+	#IFT_LAPB
+ 0x10
+
+	)
+
+61 
+	#IFT_SDLC
+ 0x11
+
+	)
+
+62 
+	#IFT_T1
+ 0x12
+
+	)
+
+63 
+	#IFT_CEPT
+ 0x13
+
+	)
+
+64 
+	#IFT_ISDNBASIC
+ 0x14
+
+	)
+
+65 
+	#IFT_ISDNPRIMARY
+ 0x15
+
+	)
+
+66 
+	#IFT_PTPSERIAL
+ 0x16
+
+	)
+
+67 
+	#IFT_PPP
+ 0x17
+
+	)
+
+68 
+	#IFT_LOOP
+ 0x18
+
+	)
+
+69 
+	#IFT_EON
+ 0x19
+
+	)
+
+70 
+	#IFT_XETHER
+ 0x1
+
+	)
+
+71 
+	#IFT_NSIP
+ 0x1b
+
+	)
+
+72 
+	#IFT_SLIP
+ 0x1
+
+	)
+
+73 
+	#IFT_ULTRA
+ 0x1d
+
+	)
+
+74 
+	#IFT_DS3
+ 0x1
+
+	)
+
+75 
+	#IFT_SIP
+ 0x1
+
+	)
+
+76 
+	#IFT_FRELAY
+ 0x20
+
+	)
+
+77 
+	#IFT_RS232
+ 0x21
+
+	)
+
+78 
+	#IFT_PARA
+ 0x22
+
+	)
+
+79 
+	#IFT_ARCNET
+ 0x23
+
+	)
+
+80 
+	#IFT_ARCNETPLUS
+ 0x24
+
+	)
+
+81 
+	#IFT_ATM
+ 0x25
+
+	)
+
+82 
+	#IFT_MIOX25
+ 0x26
+
+	)
+
+83 
+	#IFT_SONET
+ 0x27
+
+	)
+
+84 
+	#IFT_X25PLE
+ 0x28
+
+	)
+
+85 
+	#IFT_ISO88022LLC
+ 0x29
+
+	)
+
+86 
+	#IFT_LOCALTALK
+ 0x2a
+
+	)
+
+87 
+	#IFT_SMDSDXI
+ 0x2b
+
+	)
+
+88 
+	#IFT_FRELAYDCE
+ 0x2
+
+	)
+
+89 
+	#IFT_V35
+ 0x2d
+
+	)
+
+90 
+	#IFT_HSSI
+ 0x2e
+
+	)
+
+91 
+	#IFT_HIPPI
+ 0x2f
+
+	)
+
+92 
+	#IFT_MODEM
+ 0x30
+
+	)
+
+93 
+	#IFT_AAL5
+ 0x31
+
+	)
+
+94 
+	#IFT_SONETPATH
+ 0x32
+
+	)
+
+95 
+	#IFT_SONETVT
+ 0x33
+
+	)
+
+96 
+	#IFT_SMDSICIP
+ 0x34
+
+	)
+
+97 
+	#IFT_PROPVIRTUAL
+ 0x35
+
+	)
+
+98 
+	#IFT_PROPMUX
+ 0x36
+
+	)
+
+99 
+	#IFT_IEEE80212
+ 0x37
+
+	)
+
+100 
+	#IFT_FIBRECHANNEL
+ 0x38
+
+	)
+
+101 
+	#IFT_HIPPIINTERFACE
+ 0x39
+
+	)
+
+102 
+	#IFT_FRAMERELAYINTERCONNECT
+ 0x3
+
+	)
+
+103 
+	#IFT_AFLANE8023
+ 0x3b
+
+	)
+
+104 
+	#IFT_AFLANE8025
+ 0x3
+
+	)
+
+105 
+	#IFT_CCTEMUL
+ 0x3d
+
+	)
+
+106 
+	#IFT_FASTETHER
+ 0x3
+
+	)
+
+107 
+	#IFT_ISDN
+ 0x3
+
+	)
+
+108 
+	#IFT_V11
+ 0x40
+
+	)
+
+109 
+	#IFT_V36
+ 0x41
+
+	)
+
+110 
+	#IFT_G703AT64K
+ 0x42
+
+	)
+
+111 
+	#IFT_G703AT2MB
+ 0x43
+
+	)
+
+112 
+	#IFT_QLLC
+ 0x44
+
+	)
+
+113 
+	#IFT_FASTETHERFX
+ 0x45
+
+	)
+
+114 
+	#IFT_CHANNEL
+ 0x46
+
+	)
+
+115 
+	#IFT_IEEE80211
+ 0x47
+
+	)
+
+116 
+	#IFT_IBM370PARCHAN
+ 0x48
+
+	)
+
+117 
+	#IFT_ESCON
+ 0x49
+
+	)
+
+118 
+	#IFT_DLSW
+ 0x4
+
+	)
+
+119 
+	#IFT_ISDNS
+ 0x4b
+
+	)
+
+120 
+	#IFT_ISDNU
+ 0x4
+
+	)
+
+121 
+	#IFT_LAPD
+ 0x4d
+
+	)
+
+122 
+	#IFT_IPSWITCH
+ 0x4
+
+	)
+
+123 
+	#IFT_RSRB
+ 0x4
+
+	)
+
+124 
+	#IFT_ATMLOGICAL
+ 0x50
+
+	)
+
+125 
+	#IFT_DS0
+ 0x51
+
+	)
+
+126 
+	#IFT_DS0BUNDLE
+ 0x52
+
+	)
+
+127 
+	#IFT_BSC
+ 0x53
+
+	)
+
+128 
+	#IFT_ASYNC
+ 0x54
+
+	)
+
+129 
+	#IFT_CNR
+ 0x55
+
+	)
+
+130 
+	#IFT_ISO88025DTR
+ 0x56
+
+	)
+
+131 
+	#IFT_EPLRS
+ 0x57
+
+	)
+
+132 
+	#IFT_ARAP
+ 0x58
+
+	)
+
+133 
+	#IFT_PROPCNLS
+ 0x59
+
+	)
+
+134 
+	#IFT_HOSTPAD
+ 0x5
+
+	)
+
+135 
+	#IFT_TERMPAD
+ 0x5b
+
+	)
+
+136 
+	#IFT_FRAMERELAYMPI
+ 0x5
+
+	)
+
+137 
+	#IFT_X213
+ 0x5d
+
+	)
+
+138 
+	#IFT_ADSL
+ 0x5
+
+	)
+
+139 
+	#IFT_RADSL
+ 0x5
+
+	)
+
+140 
+	#IFT_SDSL
+ 0x60
+
+	)
+
+141 
+	#IFT_VDSL
+ 0x61
+
+	)
+
+142 
+	#IFT_ISO88025CRFPINT
+ 0x62
+
+	)
+
+143 
+	#IFT_MYRINET
+ 0x63
+
+	)
+
+144 
+	#IFT_VOICEEM
+ 0x64
+
+	)
+
+145 
+	#IFT_VOICEFXO
+ 0x65
+
+	)
+
+146 
+	#IFT_VOICEFXS
+ 0x66
+
+	)
+
+147 
+	#IFT_VOICEENCAP
+ 0x67
+
+	)
+
+148 
+	#IFT_VOICEOVERIP
+ 0x68
+
+	)
+
+149 
+	#IFT_ATMDXI
+ 0x69
+
+	)
+
+150 
+	#IFT_ATMFUNI
+ 0x6
+
+	)
+
+151 
+	#IFT_ATMIMA
+ 0x6b
+
+	)
+
+152 
+	#IFT_PPPMULTILINKBUNDLE
+ 0x6
+
+	)
+
+153 
+	#IFT_IPOVERCDLC
+ 0x6d
+
+	)
+
+154 
+	#IFT_IPOVERCLAW
+ 0x6
+
+	)
+
+155 
+	#IFT_STACKTOSTACK
+ 0x6
+
+	)
+
+156 
+	#IFT_VIRTUALIPADDRESS
+ 0x70
+
+	)
+
+157 
+	#IFT_MPC
+ 0x71
+
+	)
+
+158 
+	#IFT_IPOVERATM
+ 0x72
+
+	)
+
+159 
+	#IFT_ISO88025FIBER
+ 0x73
+
+	)
+
+160 
+	#IFT_TDLC
+ 0x74
+
+	)
+
+161 
+	#IFT_GIGABITETHERNET
+ 0x75
+
+	)
+
+162 
+	#IFT_HDLC
+ 0x76
+
+	)
+
+163 
+	#IFT_LAPF
+ 0x77
+
+	)
+
+164 
+	#IFT_V37
+ 0x78
+
+	)
+
+165 
+	#IFT_X25MLP
+ 0x79
+
+	)
+
+166 
+	#IFT_X25HUNTGROUP
+ 0x7
+
+	)
+
+167 
+	#IFT_TRANSPHDLC
+ 0x7b
+
+	)
+
+168 
+	#IFT_INTERLEAVE
+ 0x7
+
+	)
+
+169 
+	#IFT_FAST
+ 0x7d
+
+	)
+
+170 
+	#IFT_IP
+ 0x7
+
+	)
+
+171 
+	#IFT_DOCSCABLEMACLAYER
+ 0x7
+
+	)
+
+172 
+	#IFT_DOCSCABLEDOWNSTREAM
+ 0x80
+
+	)
+
+173 
+	#IFT_DOCSCABLEUPSTREAM
+ 0x81
+
+	)
+
+174 
+	#IFT_A12MPPSWITCH
+ 0x82
+
+	)
+
+175 
+	#IFT_TUNNEL
+ 0x83
+
+	)
+
+176 
+	#IFT_COFFEE
+ 0x84
+
+	)
+
+177 
+	#IFT_CES
+ 0x85
+
+	)
+
+178 
+	#IFT_ATMSUBINTERFACE
+ 0x86
+
+	)
+
+179 
+	#IFT_L2VLAN
+ 0x87
+
+	)
+
+180 
+	#IFT_L3IPVLAN
+ 0x88
+
+	)
+
+181 
+	#IFT_L3IPXVLAN
+ 0x89
+
+	)
+
+182 
+	#IFT_DIGITALPOWERLINE
+ 0x8
+
+	)
+
+183 
+	#IFT_MEDIAMAILOVERIP
+ 0x8b
+
+	)
+
+184 
+	#IFT_DTM
+ 0x8
+
+	)
+
+185 
+	#IFT_DCN
+ 0x8d
+
+	)
+
+186 
+	#IFT_IPFORWARD
+ 0x8
+
+	)
+
+187 
+	#IFT_MSDSL
+ 0x8
+
+	)
+
+188 
+	#IFT_IEEE1394
+ 0x90
+
+	)
+
+189 
+	#IFT_IFGSN
+ 0x91
+
+	)
+
+190 
+	#IFT_DVBRCCMACLAYER
+ 0x92
+
+	)
+
+191 
+	#IFT_DVBRCCDOWNSTREAM
+ 0x93
+
+	)
+
+192 
+	#IFT_DVBRCCUPSTREAM
+ 0x94
+
+	)
+
+193 
+	#IFT_ATMVIRTUAL
+ 0x95
+
+	)
+
+194 
+	#IFT_MPLSTUNNEL
+ 0x96
+
+	)
+
+195 
+	#IFT_SRP
+ 0x97
+
+	)
+
+196 
+	#IFT_VOICEOVERATM
+ 0x98
+
+	)
+
+197 
+	#IFT_VOICEOVERFRAMERELAY
+ 0x99
+
+	)
+
+198 
+	#IFT_IDSL
+ 0x9
+
+	)
+
+199 
+	#IFT_COMPOSITELINK
+ 0x9b
+
+	)
+
+200 
+	#IFT_SS7SIGLINK
+ 0x9
+
+	)
+
+201 
+	#IFT_PROPWIRELESSP2P
+ 0x9d
+
+	)
+
+202 
+	#IFT_FRFORWARD
+ 0x9
+
+	)
+
+203 
+	#IFT_RFC1483
+ 0x9
+
+	)
+
+204 
+	#IFT_USB
+ 0xa0
+
+	)
+
+205 
+	#IFT_IEEE8023ADLAG
+ 0xa1
+
+	)
+
+206 
+	#IFT_BGPPOLICYACCOUNTING
+ 0xa2
+
+	)
+
+207 
+	#IFT_FRF16MFRBUNDLE
+ 0xa3
+
+	)
+
+208 
+	#IFT_H323GATEKEEPER
+ 0xa4
+
+	)
+
+209 
+	#IFT_H323PROXY
+ 0xa5
+
+	)
+
+210 
+	#IFT_MPLS
+ 0xa6
+
+	)
+
+211 
+	#IFT_MFSIGLINK
+ 0xa7
+
+	)
+
+212 
+	#IFT_HDSL2
+ 0xa8
+
+	)
+
+213 
+	#IFT_SHDSL
+ 0xa9
+
+	)
+
+214 
+	#IFT_DS1FDL
+ 0x
+
+	)
+
+215 
+	#IFT_POS
+ 0xab
+
+	)
+
+216 
+	#IFT_DVBASILN
+ 0xa
+
+	)
+
+217 
+	#IFT_DVBASIOUT
+ 0xad
+
+	)
+
+218 
+	#IFT_PLC
+ 0x
+
+	)
+
+219 
+	#IFT_NFAS
+ 0xa
+
+	)
+
+220 
+	#IFT_TR008
+ 0xb0
+
+	)
+
+221 
+	#IFT_GR303RDT
+ 0xb1
+
+	)
+
+222 
+	#IFT_GR303IDT
+ 0xb2
+
+	)
+
+223 
+	#IFT_ISUP
+ 0xb3
+
+	)
+
+224 
+	#IFT_PROPDOCSWIRELESSMACLAYER
+ 0xb4
+
+	)
+
+225 
+	#IFT_PROPDOCSWIRELESSDOWNSTREAM
+ 0xb5
+
+	)
+
+226 
+	#IFT_PROPDOCSWIRELESSUPSTREAM
+ 0xb6
+
+	)
+
+227 
+	#IFT_HIPERLAN2
+ 0xb7
+
+	)
+
+228 
+	#IFT_PROPBWAP2MP
+ 0xb8
+
+	)
+
+229 
+	#IFT_SONETOVERHEADCHANNEL
+ 0xb9
+
+	)
+
+230 
+	#IFT_DIGITALWRAPPEROVERHEADCHANNEL
+ 0xb
+
+	)
+
+231 
+	#IFT_AAL2
+ 0xbb
+
+	)
+
+232 
+	#IFT_RADIOMAC
+ 0xb
+
+	)
+
+233 
+	#IFT_ATMRADIO
+ 0xbd
+
+	)
+
+234 
+	#IFT_IMT
+ 0xb
+
+	)
+
+235 
+	#IFT_MVL
+ 0xb
+
+	)
+
+236 
+	#IFT_REACHDSL
+ 0xc0
+
+	)
+
+237 
+	#IFT_FRDLCIENDPT
+ 0xc1
+
+	)
+
+238 
+	#IFT_ATMVCIENDPT
+ 0xc2
+
+	)
+
+239 
+	#IFT_OPTICALCHANNEL
+ 0xc3
+
+	)
+
+240 
+	#IFT_OPTICALTRANSPORT
+ 0xc4
+
+	)
+
+241 
+	#IFT_PROPATM
+ 0xc5
+
+	)
+
+242 
+	#IFT_VOICEOVERCABLE
+ 0xc6
+
+	)
+
+243 
+	#IFT_INFINIBAND
+ 0xc7
+
+	)
+
+244 
+	#IFT_TELINK
+ 0xc8
+
+	)
+
+245 
+	#IFT_Q2931
+ 0xc9
+
+	)
+
+246 
+	#IFT_VIRTUALTG
+ 0x
+
+	)
+
+247 
+	#IFT_SIPTG
+ 0xcb
+
+	)
+
+248 
+	#IFT_SIPSIG
+ 0xc
+
+	)
+
+249 
+	#IFT_DOCSCABLEUPSTREAMCHANNEL
+ 0xcd
+
+	)
+
+250 
+	#IFT_ECONET
+ 0x
+
+	)
+
+251 
+	#IFT_PON155
+ 0xc
+
+	)
+
+252 
+	#IFT_PON622
+ 0xd0
+
+	)
+
+253 
+	#IFT_BRIDGE
+ 0xd1
+
+	)
+
+254 
+	#IFT_LINEGROUP
+ 0xd2
+
+	)
+
+255 
+	#IFT_VOICEEMFGD
+ 0xd3
+
+	)
+
+256 
+	#IFT_VOICEFGDEANA
+ 0xd4
+
+	)
+
+257 
+	#IFT_VOICEDID
+ 0xd5
+
+	)
+
+258 
+	#IFT_STF
+ 0xd7
+
+	)
+
+261 
+	#IFT_GIF
+ 0xf0
+
+	)
+
+262 
+	#IFT_PVC
+ 0xf1
+
+	)
+
+263 
+	#IFT_FAITH
+ 0xf2
+
+	)
+
+264 
+	#IFT_PFLOG
+ 0xf5
+
+	)
+
+265 
+	#IFT_PFSYNC
+ 0xf6
+
+	)
+
+266 
+	#IFT_CARP
+ 0xf8
+
+	)
+
+	@if_vlan.c
+
+80 
+	~<sys/cdefs.h
+>
+
+81 
+__KERNEL_RCSID
+(0, "$NetBSD: if_vlan.c,v 1.81 2015/04/18 18:32:16 ozaki-r Exp $");
+
+83 #ifde
+_KERNEL_OPT
+
+
+84 
+	~"t_.h
+"
+
+85 
+	~"t_t_mp.h
+"
+
+88 
+	~<sys/m.h
+>
+
+89 
+	~<sys/kl.h
+>
+
+90 
+	~<sys/mbuf.h
+>
+
+91 
+	~<sys/queue.h
+>
+
+92 
+	~<sys/sock.h
+>
+
+93 
+	~<sys/sockio.h
+>
+
+94 
+	~<sys/sym.h
+>
+
+95 
+	~<sys/oc.h
+>
+
+96 
+	~<sys/kauth.h
+>
+
+97 
+	~<sys/mux.h
+>
+
+99 
+	~<t/bpf.h
+>
+
+100 
+	~<t/if.h
+>
+
+101 
+	~<t/if_dl.h
+>
+
+102 
+	~<t/if_tys.h
+>
+
+103 
+	~<t/if_h.h
+>
+
+104 
+	~<t/if_vnv.h
+>
+
+106 #ifde
+INET
+
+
+107 
+	~<t/.h
+>
+
+108 
+	~<t/if_p.h
+>
+
+110 #ifde
+INET6
+
+
+111 
+	~<t6/6_iach.h
+>
+
+114 
+	svn_mc_y
+ {
+
+115 
+LIST_ENTRY
+(
+vn_mc_y
+
+	mmc_s
+;
+
+122 
+h_mui
+ *
+	mmcu_m
+;
+
+123 } 
+	mmc_u
+;
+
+124 
+sockaddr_age
+ 
+	mmc_addr
+;
+
+127 
+	#mc_m
+ 
+mc_u
+.
+mcu_m
+
+
+	)
+
+129 
+	sifvn
+ {
+
+131 
+hcom
+ 
+	mifvu_ec
+;
+
+132 } 
+	mifv_u
+;
+
+133 
+i
+ *
+	mifv_p
+;
+
+134 
+	sifv_lkmib
+ {
+
+135 c 
+vn_muisw
+ *
+	mifvm_msw
+;
+
+136 
+	mifvm_
+;
+
+137 
+	mifvm_mtufudge
+;
+
+138 
+	mifvm_mtu
+;
+
+139 
+ut16_t
+ 
+	mifvm_o
+;
+
+140 
+ut16_t
+ 
+	mifvm_g
+;
+
+141 } 
+	mifv_mib
+;
+
+142 
+LIST_HEAD
+(
+__vn_mchd
+, 
+vn_mc_y
+
+	mifv_mc_lihd
+;
+
+143 
+LIST_ENTRY
+(
+ifvn
+
+	mifv_li
+;
+
+144 
+	mifv_ags
+;
+
+147 
+	#IFVF_PROMISC
+ 0x01
+
+	)
+
+149 
+	#ifv_ec
+ 
+ifv_u
+.
+ifvu_ec
+
+
+	)
+
+151 
+	#ifv_if
+ 
+ifv_ec
+.
+ec_if
+
+
+	)
+
+153 
+	#ifv_msw
+ 
+ifv_mib
+.
+ifvm_msw
+
+
+	)
+
+154 
+	#ifv_
+ 
+ifv_mib
+.
+ifvm_
+
+
+	)
+
+155 
+	#ifv_mtufudge
+ 
+ifv_mib
+.
+ifvm_mtufudge
+
+
+	)
+
+156 
+	#ifv_mtu
+ 
+ifv_mib
+.
+ifvm_mtu
+
+
+	)
+
+157 
+	#ifv_g
+ 
+ifv_mib
+.
+ifvm_g
+
+
+	)
+
+159 
+	svn_muisw
+ {
+
+160 (*
+	mvmsw_addmui
+)(
+	mifvn
+ *, 
+	mieq
+ *);
+
+161 (*
+	mvmsw_dmui
+)(
+	mifvn
+ *, 
+	mieq
+ *);
+
+162 (*
+	mvmsw_purgemui
+)(
+	mifvn
+ *);
+
+165 
+vn_h_addmui
+(
+ifvn
+ *, 
+ieq
+ *);
+
+166 
+vn_h_dmui
+(
+ifvn
+ *, 
+ieq
+ *);
+
+167 
+vn_h_purgemui
+(
+ifvn
+ *);
+
+169 c 
+vn_muisw
+ 
+	gvn_h_muisw
+ = {
+
+170 
+vn_h_addmui
+,
+
+171 
+vn_h_dmui
+,
+
+172 
+vn_h_purgemui
+,
+
+175 
+vn_e_
+(
+if_e
+ *, );
+
+176 
+vn_e_deroy
+(
+i
+ *);
+
+177 
+vn_cfig
+(
+ifvn
+ *, 
+i
+ *);
+
+178 
+vn_iol
+(
+i
+ *, 
+u_lg
+, *);
+
+179 
+vn_t
+(
+i
+ *);
+
+180 
+vn_uncfig
+(
+i
+ *);
+
+182 
+vach
+();
+
+185 
+	$LIST_HEAD
+(, 
+ifvn
+
+ifv_li
+;
+
+187 
+kmux_t
+ 
+ifv_mtx
+ 
+__che_igd
+;
+
+189 
+if_e
+ 
+vn_
+ =
+
+190 
+	`IF_CLONE_INITIALIZER
+("vn", 
+vn_e_
+, 
+vn_e_deroy
+);
+
+193 
+vn_zo_d_buff
+[
+ETHER_MIN_LEN
+];
+
+196 
+	$vach
+(
+n
+)
+
+199 
+	`LIST_INIT
+(&
+ifv_li
+);
+
+200 
+	`mux_
+(&
+ifv_mtx
+, 
+MUTEX_DEFAULT
+, 
+IPL_NONE
+);
+
+201 
+	`if_e_ch
+(&
+vn_
+);
+
+202 
+	}
+}
+
+205 
+	$vn_t_lkme
+(
+i
+ *
+i
+)
+
+215 
+i
+->
+if_ty
+ = 
+IFT_L2VLAN
+;
+
+216 
+i
+->
+if_add
+ = 0;
+
+217 
+i
+->
+if_d
+ = 
+DLT_NULL
+;
+
+218 
+	`if_loc_dl
+(
+i
+);
+
+219 
+	}
+}
+
+222 
+	$vn_e_
+(
+if_e
+ *
+ifc
+, 
+un
+)
+
+224 
+ifvn
+ *
+ifv
+;
+
+225 
+i
+ *
+i
+;
+
+226 
+s
+;
+
+228 
+ifv
+ = 
+	`mloc
+((
+ifvn
+), 
+M_DEVBUF
+, 
+M_WAITOK
+|
+M_ZERO
+);
+
+229 
+i
+ = &
+ifv
+->
+ifv_if
+;
+
+230 
+	`LIST_INIT
+(&
+ifv
+->
+ifv_mc_lihd
+);
+
+232 
+s
+ = 
+	`
+();
+
+233 
+	`LIST_INSERT_HEAD
+(&
+ifv_li
+, 
+ifv
+, ifv_list);
+
+234 
+	`lx
+(
+s
+);
+
+236 
+	`if_me
+(
+i
+, 
+ifc
+->
+ifc_me
+, 
+un
+);
+
+237 
+i
+->
+if_soc
+ = 
+ifv
+;
+
+238 
+i
+->
+if_ags
+ = 
+IFF_BROADCAST
+ | 
+IFF_SIMPLEX
+ | 
+IFF_MULTICAST
+;
+
+239 
+i
+->
+if_t
+ = 
+vn_t
+;
+
+240 
+i
+->
+if_iol
+ = 
+vn_iol
+;
+
+241 
+	`IFQ_SET_READY
+(&
+i
+->
+if_d
+);
+
+243 
+	`if_ch
+(
+i
+);
+
+244 
+	`vn_t_lkme
+(
+i
+);
+
+247 
+	}
+}
+
+250 
+	$vn_e_deroy
+(
+i
+ *
+i
+)
+
+252 
+ifvn
+ *
+ifv
+ = 
+i
+->
+if_soc
+;
+
+253 
+s
+;
+
+255 
+s
+ = 
+	`
+();
+
+256 
+	`LIST_REMOVE
+(
+ifv
+, 
+ifv_li
+);
+
+257 
+	`vn_uncfig
+(
+i
+);
+
+258 
+	`if_dach
+(
+i
+);
+
+259 
+	`lx
+(
+s
+);
+
+261 
+	`
+(
+ifv
+, 
+M_DEVBUF
+);
+
+264 
+	}
+}
+
+270 
+	$vn_cfig
+(
+ifvn
+ *
+ifv
+, 
+i
+ *
+p
+)
+
+272 
+i
+ *
+i
+ = &
+ifv
+->
+ifv_if
+;
+
+273 
+r
+;
+
+275 i(
+ifv
+->
+ifv_p
+ !
+NULL
+)
+
+276  (
+EBUSY
+);
+
+278 
+p
+->
+if_ty
+) {
+
+279 
+IFT_ETHER
+:
+
+281 
+hcom
+ *
+ec
+ = (*
+p
+;
+
+283 
+ifv
+->
+ifv_msw
+ = &
+vn_h_muisw
+;
+
+284 
+ifv
+->
+ifv_
+ = 
+ETHER_VLAN_ENCAP_LEN
+;
+
+285 
+ifv
+->
+ifv_mtu
+ = 
+ETHERMIN
+;
+
+292 i(
+ec
+->
+ec_nvns
+++ == 0 &&
+
+293 (
+ec
+->
+ec_bs
+ & 
+ETHERCAP_VLAN_MTU
+) != 0) {
+
+297 
+ec
+->
+ec_b
+ |
+ETHERCAP_VLAN_MTU
+;
+
+298 i(
+p
+->
+if_ags
+ & 
+IFF_UP
+) {
+
+299 
+r
+ = 
+	`if_ags_t
+(
+p
+,->
+if_ags
+);
+
+300 i(
+r
+) {
+
+301 i(
+ec
+->
+ec_nvns
+-- == 1)
+
+302 
+ec
+->
+ec_b
+ &=
+
+303 ~
+ETHERCAP_VLAN_MTU
+;
+
+304  (
+r
+);
+
+307 
+ifv
+->
+ifv_mtufudge
+ = 0;
+
+308 } i((
+ec
+->
+ec_bs
+ & 
+ETHERCAP_VLAN_MTU
+) == 0) {
+
+316 
+ifv
+->
+ifv_mtufudge
+ = ifv->
+ifv_
+;
+
+325 i(
+ec
+->
+ec_bs
+ & 
+ETHERCAP_VLAN_HWTAGGING
+) {
+
+326 
+ec
+->
+ec_b
+ |
+ETHERCAP_VLAN_HWTAGGING
+;
+
+327 
+i
+->
+if_bs
+ = 
+p
+->if_capabilities &
+
+328 (
+IFCAP_TSOv4
+ | 
+IFCAP_TSOv6
+ |
+
+329 
+IFCAP_CSUM_IPv4_Tx
+|
+IFCAP_CSUM_IPv4_Rx
+|
+
+330 
+IFCAP_CSUM_TCPv4_Tx
+|
+IFCAP_CSUM_TCPv4_Rx
+|
+
+331 
+IFCAP_CSUM_UDPv4_Tx
+|
+IFCAP_CSUM_UDPv4_Rx
+|
+
+332 
+IFCAP_CSUM_TCPv6_Tx
+|
+IFCAP_CSUM_TCPv6_Rx
+|
+
+333 
+IFCAP_CSUM_UDPv6_Tx
+|
+IFCAP_CSUM_UDPv6_Rx
+);
+
+338 
+	`h_iach
+(
+i
+, 
+	`CLLADDR
+(
+p
+->
+if_dl
+));
+
+339 
+i
+->
+if_hd
+ = (
+h_vn_hd
+);
+
+344  (
+EPROTONOSUPPORT
+);
+
+347 
+ifv
+->
+ifv_p
+ = 
+p
+;
+
+348 
+ifv
+->
+ifv_if
+.
+if_mtu
+ = 
+p
+->if_mtu - ifv->
+ifv_mtufudge
+;
+
+349 
+ifv
+->
+ifv_if
+.
+if_ags
+ = 
+p
+->if_flags &
+
+350 (
+IFF_UP
+ | 
+IFF_BROADCAST
+ | 
+IFF_SIMPLEX
+ | 
+IFF_MULTICAST
+);
+
+356 
+ifv
+->
+ifv_if
+.
+if_ty
+ = 
+p
+->if_type;
+
+359 
+	}
+}
+
+365 
+	$vn_uncfig
+(
+i
+ *
+i
+)
+
+367 
+ifvn
+ *
+ifv
+ = 
+i
+->
+if_soc
+;
+
+368 
+i
+ *
+p
+;
+
+370 
+	`mux_r
+(&
+ifv_mtx
+);
+
+371 
+p
+ = 
+ifv
+->
+ifv_p
+;
+
+373 i(
+p
+ =
+NULL
+) {
+
+374 
+	`mux_ex
+(&
+ifv_mtx
+);
+
+383 (*
+ifv
+->
+ifv_msw
+->
+vmsw_purgemui
+)(ifv);
+
+386 
+p
+->
+if_ty
+) {
+
+387 
+IFT_ETHER
+:
+
+389 
+hcom
+ *
+ec
+ = (*
+p
+;
+
+391 i(
+ec
+->
+ec_nvns
+-- == 1) {
+
+395 
+ec
+->
+ec_b
+ &~
+ETHERCAP_VLAN_MTU
+;
+
+396 i(
+p
+->
+if_ags
+ & 
+IFF_UP
+)
+
+397 ()
+	`if_ags_t
+(
+p
+,->
+if_ags
+);
+
+400 
+	`h_ifdach
+(
+i
+);
+
+402 
+i
+->
+if_iol
+ = 
+vn_iol
+;
+
+403 
+	`vn_t_lkme
+(
+i
+);
+
+407 #ifde
+DIAGNOSTIC
+
+
+409 
+	`nic
+("vlan_unconfig: impossible");
+
+413 
+ifv
+->
+ifv_p
+ = 
+NULL
+;
+
+414 
+ifv
+->
+ifv_if
+.
+if_mtu
+ = 0;
+
+415 
+ifv
+->
+ifv_ags
+ = 0;
+
+417 #ifde
+INET6
+
+
+419 
+	`6_ifdach
+(
+i
+);
+
+421 i((
+i
+->
+if_ags
+ & 
+IFF_PROMISC
+) != 0)
+
+422 
+	`iromisc
+(
+i
+, 0);
+
+423 
+	`if_down
+(
+i
+);
+
+424 
+i
+->
+if_ags
+ &~(
+IFF_UP
+|
+IFF_RUNNING
+);
+
+425 
+i
+->
+if_bs
+ = 0;
+
+427 
+	`mux_ex
+(&
+ifv_mtx
+);
+
+428 
+	}
+}
+
+435 
+	$vn_ifdach
+(
+i
+ *
+p
+)
+
+437 
+ifvn
+ *
+ifv
+;
+
+438 
+s
+;
+
+440 
+s
+ = 
+	`
+();
+
+442 
+ifv
+ = 
+	`LIST_FIRST
+(&
+ifv_li
+); ifv !
+NULL
+;
+
+443 
+ifv
+ = 
+	`LIST_NEXT
+(ifv, 
+ifv_li
+)) {
+
+444 i(
+ifv
+->
+ifv_p
+ =
+p
+)
+
+445 
+	`vn_uncfig
+(&
+ifv
+->
+ifv_if
+);
+
+448 
+	`lx
+(
+s
+);
+
+449 
+	}
+}
+
+452 
+	$vn_t_omisc
+(
+i
+ *
+i
+)
+
+454 
+ifvn
+ *
+ifv
+ = 
+i
+->
+if_soc
+;
+
+455 
+r
+ = 0;
+
+457 i((
+i
+->
+if_ags
+ & 
+IFF_PROMISC
+) != 0) {
+
+458 i((
+ifv
+->
+ifv_ags
+ & 
+IFVF_PROMISC
+) == 0) {
+
+459 
+r
+ = 
+	`iromisc
+(
+ifv
+->
+ifv_p
+, 1);
+
+460 i(
+r
+ == 0)
+
+461 
+ifv
+->
+ifv_ags
+ |
+IFVF_PROMISC
+;
+
+464 i((
+ifv
+->
+ifv_ags
+ & 
+IFVF_PROMISC
+) != 0) {
+
+465 
+r
+ = 
+	`iromisc
+(
+ifv
+->
+ifv_p
+, 0);
+
+466 i(
+r
+ == 0)
+
+467 
+ifv
+->
+ifv_ags
+ &~
+IFVF_PROMISC
+;
+
+471  (
+r
+);
+
+472 
+	}
+}
+
+475 
+	$vn_iol
+(
+i
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+477 
+lwp
+ *
+l
+ = 
+cuwp
+;
+
+478 
+ifvn
+ *
+ifv
+ = 
+i
+->
+if_soc
+;
+
+479 
+iddr
+ *
+i
+ = (idd*
+da
+;
+
+480 
+ieq
+ *
+i
+ = (ieq *
+da
+;
+
+481 
+i
+ *
+
+;
+
+482 
+ifeq
+ *
+if
+;
+
+483 
+veq
+ 
+v
+;
+
+484 
+s
+, 
+r
+ = 0;
+
+486 
+s
+ = 
+	`
+();
+
+488 
+cmd
+) {
+
+489 
+SIOCSIFMTU
+:
+
+490 i(
+ifv
+->
+ifv_p
+ =
+NULL
+)
+
+491 
+r
+ = 
+EINVAL
+;
+
+493 
+i
+->
+i_mtu
+ > (
+ifv
+->
+ifv_p
+->
+if_mtu
+ - ifv->
+ifv_mtufudge
+) ||
+
+494 
+i
+->
+i_mtu
+ < (
+ifv
+->
+ifv_mtu
+ - ifv->
+ifv_mtufudge
+))
+
+495 
+r
+ = 
+EINVAL
+;
+
+496 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)=
+ENETRESET
+)
+
+497 
+r
+ = 0;
+
+500 
+SIOCSETVLAN
+:
+
+501 i((
+r
+ = 
+	`kauth_authize_twk
+(
+l
+->
+l_ed
+,
+
+502 
+KAUTH_NETWORK_INTERFACE
+,
+
+503 
+KAUTH_REQ_NETWORK_INTERFACE_SETPRIV
+, 
+i
+, (*)
+cmd
+,
+
+504 
+NULL
+)) != 0)
+
+506 i((
+r
+ = 
+	`cy
+(
+i
+->
+i_da
+, &
+v
+, (vlr))) != 0)
+
+508 i(
+v
+.
+v_
+[0] == '\0') {
+
+509 i(
+ifv
+->
+ifv_p
+ !
+NULL
+ &&
+
+510 (
+i
+->
+if_ags
+ & 
+IFF_PROMISC
+) != 0)
+
+511 
+r
+ = 
+	`iromisc
+(
+ifv
+->
+ifv_p
+, 0);
+
+512 
+	`vn_uncfig
+(
+i
+);
+
+515 i(
+v
+.
+v_g
+ !
+	`EVL_VLANOFTAG
+(vlr.vlr_tag)) {
+
+516 
+r
+ = 
+EINVAL
+;
+
+519 i((
+
+ = 
+	`ifun
+(
+v
+.
+v_
+)) == 0) {
+
+520 
+r
+ = 
+ENOENT
+;
+
+523 i((
+r
+ = 
+	`vn_cfig
+(
+ifv
+, 
+
+)) != 0)
+
+525 
+ifv
+->
+ifv_g
+ = 
+v
+.
+v_g
+;
+
+526 
+i
+->
+if_ags
+ |
+IFF_RUNNING
+;
+
+529 
+	`vn_t_omisc
+(
+i
+);
+
+532 
+SIOCGETVLAN
+:
+
+533 
+	`memt
+(&
+v
+, 0, (vlr));
+
+534 i(
+ifv
+->
+ifv_p
+ !
+NULL
+) {
+
+535 
+	`tf
+(
+v
+.
+v_
+, (vlr.vlr_parent), "%s",
+
+536 
+ifv
+->
+ifv_p
+->
+if_xme
+);
+
+537 
+v
+.
+v_g
+ = 
+ifv
+->
+ifv_g
+;
+
+539 
+r
+ = 
+	`cyout
+(&
+v
+, 
+i
+->
+i_da
+, (vlr));
+
+542 
+SIOCSIFFLAGS
+:
+
+543 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)) != 0)
+
+549 i(
+ifv
+->
+ifv_p
+ !
+NULL
+)
+
+550 
+r
+ = 
+	`vn_t_omisc
+(
+i
+);
+
+553 
+SIOCADDMULTI
+:
+
+554 
+r
+ = (
+ifv
+->
+ifv_p
+ !
+NULL
+) ?
+
+555 (*
+ifv
+->
+ifv_msw
+->
+vmsw_addmui
+)(ifv, 
+i
+: 
+EINVAL
+;
+
+558 
+SIOCDELMULTI
+:
+
+559 
+r
+ = (
+ifv
+->
+ifv_p
+ !
+NULL
+) ?
+
+560 (*
+ifv
+->
+ifv_msw
+->
+vmsw_dmui
+)(ifv, 
+i
+: 
+EINVAL
+;
+
+563 
+SIOCSIFCAP
+:
+
+564 
+if
+ = 
+da
+;
+
+566 i((
+ifv
+->
+ifv_p
+->
+if_b
+ & 
+if
+->
+if_b
+) !=
+
+567 
+if
+->
+if_b
+) {
+
+568 
+r
+ = 
+EINVAL
+;
+
+571 i((
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+)=
+ENETRESET
+)
+
+572 
+r
+ = 0;
+
+574 
+SIOCINITIFADDR
+:
+
+575 i(
+ifv
+->
+ifv_p
+ =
+NULL
+) {
+
+576 
+r
+ = 
+EINVAL
+;
+
+580 
+i
+->
+if_ags
+ |
+IFF_UP
+;
+
+581 #ifde
+INET
+
+
+582 i(
+i
+->
+i_addr
+->
+_my
+ =
+AF_INET
+)
+
+583 
+	`p_if
+(
+i
+, 
+i
+);
+
+588 
+r
+ = 
+	`h_iol
+(
+i
+, 
+cmd
+, 
+da
+);
+
+591 
+	`lx
+(
+s
+);
+
+593  (
+r
+);
+
+594 
+	}
+}
+
+597 
+	$vn_h_addmui
+(
+ifvn
+ *
+ifv
+, 
+ieq
+ *
+i
+)
+
+599 c 
+sockaddr
+ *
+
+ = 
+	`ieq_gaddr
+(
+SIOCADDMULTI
+, 
+i
+);
+
+600 
+vn_mc_y
+ *
+mc
+;
+
+601 
+ut8_t
+ 
+addo
+[
+ETHER_ADDR_LEN
+], 
+addrhi
+[ETHER_ADDR_LEN];
+
+602 
+r
+;
+
+604 i(
+
+->
+_n
+ > (
+sockaddr_age
+))
+
+605  (
+EINVAL
+);
+
+607 
+r
+ = 
+	`h_addmui
+(
+
+, &
+ifv
+->
+ifv_ec
+);
+
+608 i(
+r
+ !
+ENETRESET
+)
+
+609  (
+r
+);
+
+616 
+mc
+ = 
+	`mloc
+((
+vn_mc_y
+), 
+M_DEVBUF
+, 
+M_NOWAIT
+);
+
+617 i(
+mc
+ =
+NULL
+) {
+
+618 
+r
+ = 
+ENOMEM
+;
+
+619 
+loc_ed
+;
+
+626 ()
+	`h_muddr
+(
+
+, 
+addo
+, 
+addrhi
+);
+
+627 
+	`ETHER_LOOKUP_MULTI
+(
+addo
+, 
+addrhi
+, &
+ifv
+->
+ifv_ec
+, 
+mc
+->
+mc_m
+);
+
+628 
+	`memy
+(&
+mc
+->
+mc_addr
+, 
+
+, sa->
+_n
+);
+
+629 
+	`LIST_INSERT_HEAD
+(&
+ifv
+->
+ifv_mc_lihd
+, 
+mc
+, 
+mc_s
+);
+
+631 
+r
+ = 
+	`if_m_
+(
+ifv
+->
+ifv_p
+, 
+SIOCADDMULTI
+, 
+
+);
+
+632 i(
+r
+ != 0)
+
+633 
+iol_ed
+;
+
+634  (
+r
+);
+
+636 
+iol_ed
+:
+
+637 
+	`LIST_REMOVE
+(
+mc
+, 
+mc_s
+);
+
+638 
+	`
+(
+mc
+, 
+M_DEVBUF
+);
+
+639 
+loc_ed
+:
+
+640 ()
+	`h_dmui
+(
+
+, &
+ifv
+->
+ifv_ec
+);
+
+641  (
+r
+);
+
+642 
+	}
+}
+
+645 
+	$vn_h_dmui
+(
+ifvn
+ *
+ifv
+, 
+ieq
+ *
+i
+)
+
+647 c 
+sockaddr
+ *
+
+ = 
+	`ieq_gaddr
+(
+SIOCDELMULTI
+, 
+i
+);
+
+648 
+h_mui
+ *
+m
+;
+
+649 
+vn_mc_y
+ *
+mc
+;
+
+650 
+ut8_t
+ 
+addo
+[
+ETHER_ADDR_LEN
+], 
+addrhi
+[ETHER_ADDR_LEN];
+
+651 
+r
+;
+
+657 i((
+r
+ = 
+	`h_muddr
+(
+
+, 
+addo
+, 
+addrhi
+)) != 0)
+
+658  (
+r
+);
+
+659 
+	`ETHER_LOOKUP_MULTI
+(
+addo
+, 
+addrhi
+, &
+ifv
+->
+ifv_ec
+, 
+m
+);
+
+661 
+r
+ = 
+	`h_dmui
+(
+
+, &
+ifv
+->
+ifv_ec
+);
+
+662 i(
+r
+ !
+ENETRESET
+)
+
+663  (
+r
+);
+
+666 
+r
+ = 
+	`if_m_
+(
+ifv
+->
+ifv_p
+, 
+SIOCDELMULTI
+, 
+
+);
+
+667 i(
+r
+ == 0) {
+
+669 
+mc
+ = 
+	`LIST_FIRST
+(&
+ifv
+->
+ifv_mc_lihd
+); m!
+NULL
+;
+
+670 
+mc
+ = 
+	`LIST_NEXT
+(mc, 
+mc_s
+)) {
+
+671 i(
+mc
+->
+mc_m
+ =
+m
+) {
+
+672 
+	`LIST_REMOVE
+(
+mc
+, 
+mc_s
+);
+
+673 
+	`
+(
+mc
+, 
+M_DEVBUF
+);
+
+677 
+	`KASSERT
+(
+mc
+ !
+NULL
+);
+
+679 ()
+	`h_addmui
+(
+
+, &
+ifv
+->
+ifv_ec
+);
+
+680  (
+r
+);
+
+681 
+	}
+}
+
+688 
+	$vn_h_purgemui
+(
+ifvn
+ *
+ifv
+)
+
+690 
+i
+ *
+i
+ = 
+ifv
+->
+ifv_p
+;
+
+691 
+vn_mc_y
+ *
+mc
+;
+
+693 (
+mc
+ = 
+	`LIST_FIRST
+(&
+ifv
+->
+ifv_mc_lihd
+)!
+NULL
+) {
+
+694 ()
+	`if_m_
+(
+i
+, 
+SIOCDELMULTI
+,
+
+695 (c 
+sockaddr
+ *)&
+mc
+->
+mc_addr
+);
+
+696 
+	`LIST_REMOVE
+(
+mc
+, 
+mc_s
+);
+
+697 
+	`
+(
+mc
+, 
+M_DEVBUF
+);
+
+699 
+	}
+}
+
+702 
+	$vn_t
+(
+i
+ *
+i
+)
+
+704 
+ifvn
+ *
+ifv
+ = 
+i
+->
+if_soc
+;
+
+705 
+i
+ *
+p
+ = 
+ifv
+->
+ifv_p
+;
+
+706 
+hcom
+ *
+ec
+ = (*
+ifv
+->
+ifv_p
+;
+
+707 
+mbuf
+ *
+m
+;
+
+708 
+r
+;
+
+709 
+	`ALTQ_DECL
+(
+tq_pkr
+ 
+pkr
+;)
+
+711 #ide
+NET_MPSAFE
+
+
+712 
+	`KASSERT
+(
+	`KERNEL_LOCKED_P
+());
+
+715 
+i
+->
+if_ags
+ |
+IFF_OACTIVE
+;
+
+718 
+	`IFQ_DEQUEUE
+(&
+i
+->
+if_d
+, 
+m
+);
+
+719 i(
+m
+ =
+NULL
+)
+
+722 #ifde
+ALTQ
+
+
+729 i(
+	`ALTQ_IS_ENABLED
+(&
+p
+->
+if_d
+)) {
+
+730 
+p
+->
+if_ty
+) {
+
+731 
+IFT_ETHER
+:
+
+732 
+	`tq_hassify
+(&
+p
+->
+if_d
+, 
+m
+, &
+pkr
+);
+
+734 #ifde
+DIAGNOSTIC
+
+
+736 
+	`nic
+("vlan_start: impossible (altq)");
+
+742 
+	`bpf_mp
+(
+i
+, 
+m
+);
+
+747 i(
+ec
+->
+ec_bs
+ & 
+ETHERCAP_VLAN_HWTAGGING
+) {
+
+748 
+m_g
+ *
+mg
+;
+
+750 
+mg
+ = 
+	`m_g_g
+(
+PACKET_TAG_VLAN
+, (
+u_t
+),
+
+751 
+M_NOWAIT
+);
+
+752 i(
+mg
+ =
+NULL
+) {
+
+753 
+i
+->
+if_s
+++;
+
+754 
+	`m_m
+(
+m
+);
+
+757 *(
+u_t
+ *)(
+mg
+ + 1
+ifv
+->
+ifv_g
+;
+
+758 
+	`m_g_d
+(
+m
+, 
+mg
+);
+
+763 
+	`M_PREPEND
+(
+m
+, 
+ifv
+->
+ifv_
+, 
+M_DONTWAIT
+);
+
+764 i(
+m
+ =
+NULL
+) {
+
+765 
+	`tf
+("%s: unableorependncap header",
+
+766 
+ifv
+->
+ifv_p
+->
+if_xme
+);
+
+767 
+i
+->
+if_s
+++;
+
+771 
+p
+->
+if_ty
+) {
+
+772 
+IFT_ETHER
+:
+
+774 
+h_vn_hd
+ *
+evl
+;
+
+776 i(
+m
+->
+m_n
+ < (
+h_vn_hd
+))
+
+777 
+m
+ = 
+	`m_puup
+(m,
+
+778 (
+h_vn_hd
+));
+
+779 i(
+m
+ =
+NULL
+) {
+
+780 
+	`tf
+("%s: unableoullupncap "
+
+781 "hd", 
+ifv
+->
+ifv_p
+->
+if_xme
+);
+
+782 
+i
+->
+if_s
+++;
+
+790 
+	`memmove
+(
+	`mtod
+(
+m
+, *),
+
+791 
+	`mtod
+(
+m
+, *+ 
+ifv
+->
+ifv_
+,
+
+792 (
+h_hd
+));
+
+793 
+evl
+ = 
+	`mtod
+(
+m
+, 
+h_vn_hd
+ *);
+
+794 
+evl
+->
+evl_o
+ =vl->
+evl_p_o
+;
+
+795 
+evl
+->
+evl_p_o
+ = 
+	`hts
+(
+ETHERTYPE_VLAN
+);
+
+796 
+evl
+->
+evl_g
+ = 
+	`hts
+(
+ifv
+->
+ifv_g
+);
+
+808 i(
+m
+->
+m_pkthdr
+.
+n
+ <
+
+809 (
+ETHER_MIN_LEN
+ - 
+ETHER_CRC_LEN
+ +
+
+810 
+ETHER_VLAN_ENCAP_LEN
+)) {
+
+811 
+	`m_cyback
+(
+m
+, m->
+m_pkthdr
+.
+n
+,
+
+812 (
+ETHER_MIN_LEN
+ - 
+ETHER_CRC_LEN
+ +
+
+813 
+ETHER_VLAN_ENCAP_LEN
+) -
+
+814 
+m
+->
+m_pkthdr
+.
+n
+,
+
+815 
+vn_zo_d_buff
+);
+
+820 #ifde
+DIAGNOSTIC
+
+
+822 
+	`nic
+("vlan_start: impossible");
+
+831 
+	`IFQ_ENQUEUE
+(&
+p
+->
+if_d
+, 
+m
+, &
+pkr
+, 
+r
+);
+
+832 i(
+r
+) {
+
+834 
+i
+->
+if_s
+++;
+
+838 
+i
+->
+if_acks
+++;
+
+840 
+p
+->
+if_obys
+ +
+m
+->
+m_pkthdr
+.
+n
+;
+
+841 i(
+m
+->
+m_ags
+ & 
+M_MCAST
+)
+
+842 
+p
+->
+if_oms
+++;
+
+843 i((
+p
+->
+if_ags
+ & (
+IFF_RUNNING
+|
+IFF_OACTIVE
+)) == IFF_RUNNING)
+
+844 (*
+p
+->
+if_t
+)(p);
+
+847 
+i
+->
+if_ags
+ &~
+IFF_OACTIVE
+;
+
+848 
+	}
+}
+
+856 
+	$vn_put
+(
+i
+ *
+i
+, 
+mbuf
+ *
+m
+)
+
+858 
+ifvn
+ *
+ifv
+;
+
+859 
+u_t
+ 
+g
+;
+
+860 
+m_g
+ *
+mg
+;
+
+862 
+mg
+ = 
+	`m_g_fd
+(
+m
+, 
+PACKET_TAG_VLAN
+, 
+NULL
+);
+
+863 i(
+mg
+ !
+NULL
+) {
+
+865 
+g
+ = 
+	`EVL_VLANOFTAG
+(*(
+u_t
+ *)(
+mg
+ + 1));
+
+866 
+	`m_g_de
+(
+m
+, 
+mg
+);
+
+868 
+i
+->
+if_ty
+) {
+
+869 
+IFT_ETHER
+:
+
+871 
+h_vn_hd
+ *
+evl
+;
+
+873 i(
+m
+->
+m_n
+ < (
+h_vn_hd
+) &&
+
+874 (
+m
+ = 
+	`m_puup
+(m,
+
+875 (
+h_vn_hd
+))=
+NULL
+) {
+
+876 
+	`tf
+("%s:o memory for VLAN header, "
+
+877 "drpgack.\n", 
+i
+->
+if_xme
+);
+
+880 
+evl
+ = 
+	`mtod
+(
+m
+, 
+h_vn_hd
+ *);
+
+881 
+	`KASSERT
+(
+	`ohs
+(
+evl
+->
+evl_p_o
+=
+ETHERTYPE_VLAN
+);
+
+883 
+g
+ = 
+	`EVL_VLANOFTAG
+(
+	`ohs
+(
+evl
+->
+evl_g
+));
+
+890 
+evl
+->
+evl_p_o
+ =vl->
+evl_o
+;
+
+895 
+g
+ = (
+u_t
+) -1;
+
+896 #ifde
+DIAGNOSTIC
+
+
+897 
+	`nic
+("vlan_input: impossible");
+
+902 
+ifv
+ = 
+	`LIST_FIRST
+(&
+ifv_li
+); ifv !
+NULL
+;
+
+903 
+ifv
+ = 
+	`LIST_NEXT
+(ifv, 
+ifv_li
+))
+
+904 i(
+i
+ =
+ifv
+->
+ifv_p
+ && 
+g
+ =ifv->
+ifv_g
+)
+
+907 i(
+ifv
+ =
+NULL
+ ||
+
+908 (
+ifv
+->
+ifv_if
+.
+if_ags
+ & (
+IFF_UP
+|
+IFF_RUNNING
+)) !=
+
+909 (
+IFF_UP
+|
+IFF_RUNNING
+)) {
+
+910 
+	`m_m
+(
+m
+);
+
+911 
+i
+->
+if_nro
+++;
+
+919 i(
+mg
+ =
+NULL
+) {
+
+920 
+	`memmove
+(
+	`mtod
+(
+m
+, *+ 
+ifv
+->
+ifv_
+,
+
+921 
+	`mtod
+(
+m
+, *), (
+h_hd
+));
+
+922 
+	`m_adj
+(
+m
+, 
+ifv
+->
+ifv_
+);
+
+925 
+m
+->
+m_pkthdr
+.
+rcvif
+ = &
+ifv
+->
+ifv_if
+;
+
+926 
+ifv
+->
+ifv_if
+.
+if_acks
+++;
+
+928 
+	`bpf_mp
+(&
+ifv
+->
+ifv_if
+, 
+m
+);
+
+930 
+m
+->
+m_ags
+ &~
+M_PROMISC
+;
+
+931 
+ifv
+->
+ifv_if
+.
+	`if_put
+(&ifv->ifv_if, 
+m
+);
+
+932 
+	}
+}
+
+	@if_vlanvar.h
+
+63 #ide
+_NET_IF_VLANVAR_H_
+
+
+64 
+	#_NET_IF_VLANVAR_H_
+
+
+	)
+
+66 
+	sh_vn_hd
+ {
+
+67 
+ut8_t
+ 
+	mevl_dho
+[
+ETHER_ADDR_LEN
+];
+
+68 
+ut8_t
+ 
+	mevl_sho
+[
+ETHER_ADDR_LEN
+];
+
+69 
+ut16_t
+ 
+	mevl_p_o
+;
+
+70 
+ut16_t
+ 
+	mevl_g
+;
+
+71 
+ut16_t
+ 
+	mevl_o
+;
+
+72 } 
+	g__cked
+;
+
+74 
+	#EVL_VLANOFTAG
+(
+g
+(ag& 4095)
+
+	)
+
+75 
+	#EVL_PRIOFTAG
+(
+g
+((ag>> 13& 7)
+
+	)
+
+78 
+	sveq
+ {
+
+79 
+	mv_
+[
+IFNAMSIZ
+];
+
+80 
+u_sht
+ 
+	mv_g
+;
+
+83 
+	#SIOCSETVLAN
+ 
+SIOCSIFGENERIC
+
+
+	)
+
+84 
+	#SIOCGETVLAN
+ 
+SIOCGIFGENERIC
+
+
+	)
+
+86 #ifde
+_KERNEL
+
+
+87 
+vn_put
+(
+i
+ *, 
+mbuf
+ *);
+
+88 
+vn_ifdach
+(
+i
+ *);
+
+	@link_proto.c
+
+34 
+	~<sys/cdefs.h
+>
+
+35 
+__KERNEL_RCSID
+(0, "$NetBSD:ink_proto.c,v 1.28 2015/05/02 17:18:03tr Exp $");
+
+37 
+	~<sys/m.h
+>
+
+38 
+	~<sys/sock.h
+>
+
+39 
+	~<sys/osw.h
+>
+
+40 
+	~<sys/doma.h
+>
+
+41 
+	~<sys/mbuf.h
+>
+
+42 
+	~<sys/un.h
+>
+
+43 
+	~<sys/sockv.h
+>
+
+45 
+	~<t/if.h
+>
+
+46 
+	~<t/if_dl.h
+>
+
+47 
+	~<t/w_cb.h
+>
+
+48 
+	~<t/rou.h
+>
+
+50 
+sockaddr_dl_cmp
+(c 
+sockaddr
+ *, const sockaddr *);
+
+51 
+lk_ch
+(
+sock
+ *, );
+
+52 
+lk_dach
+(
+sock
+ *);
+
+53 
+lk_ac
+(
+sock
+ *, 
+sockaddr
+ *);
+
+54 
+lk_bd
+(
+sock
+ *, 
+sockaddr
+ *, 
+lwp
+ *);
+
+55 
+lk_li
+(
+sock
+ *, 
+lwp
+ *);
+
+56 
+lk_c
+(
+sock
+ *, 
+sockaddr
+ *, 
+lwp
+ *);
+
+57 
+lk_c2
+(
+sock
+ *, socket *);
+
+58 
+lk_disc
+(
+sock
+ *);
+
+59 
+lk_shutdown
+(
+sock
+ *);
+
+60 
+lk_abt
+(
+sock
+ *);
+
+61 
+lk_iol
+(
+sock
+ *, 
+u_lg
+, *, 
+i
+ *);
+
+62 
+lk_
+(
+sock
+ *, 
+
+ *);
+
+63 
+lk_addr
+(
+sock
+ *, 
+sockaddr
+ *);
+
+64 
+lk_sockaddr
+(
+sock
+ *, 
+sockaddr
+ *);
+
+65 
+lk_rcvd
+(
+sock
+ *, , 
+lwp
+ *);
+
+66 
+lk_cvoob
+(
+sock
+ *, 
+mbuf
+ *, );
+
+67 
+lk_nd
+(
+sock
+ *, 
+mbuf
+ *, 
+sockaddr
+ *,
+
+68 
+mbuf
+ *, 
+lwp
+ *);
+
+69 
+lk_ndoob
+(
+sock
+ *, 
+mbuf
+ *, mbuf *);
+
+70 
+lk_purgeif
+(
+sock
+ *, 
+i
+ *);
+
+71 
+lk_
+();
+
+77 
+DOMAIN_DEFINE
+(
+lkdoma
+);
+
+79 c 
+_uqs
+ 
+	glk_uqs
+ = {
+
+80 .
+_ch
+ = 
+lk_ch
+,
+
+81 .
+	g_dach
+ = 
+lk_dach
+,
+
+82 .
+	g_ac
+ = 
+lk_ac
+,
+
+83 .
+	g_bd
+ = 
+lk_bd
+,
+
+84 .
+	g_li
+ = 
+lk_li
+,
+
+85 .
+	g_c
+ = 
+lk_c
+,
+
+86 .
+	g_c2
+ = 
+lk_c2
+,
+
+87 .
+	g_disc
+ = 
+lk_disc
+,
+
+88 .
+	g_shutdown
+ = 
+lk_shutdown
+,
+
+89 .
+	g_abt
+ = 
+lk_abt
+,
+
+90 .
+	g_iol
+ = 
+lk_iol
+,
+
+91 .
+	g_
+ = 
+lk_
+,
+
+92 .
+	g_addr
+ = 
+lk_addr
+,
+
+93 .
+	g_sockaddr
+ = 
+lk_sockaddr
+,
+
+94 .
+	g_rcvd
+ = 
+lk_rcvd
+,
+
+95 .
+	g_cvoob
+ = 
+lk_cvoob
+,
+
+96 .
+	g_nd
+ = 
+lk_nd
+,
+
+97 .
+	g_ndoob
+ = 
+lk_ndoob
+,
+
+98 .
+	g_purgeif
+ = 
+lk_purgeif
+,
+
+101 c 
+osw
+ 
+	glksw
+[] = {
+
+102 { .
+_ty
+ = 
+SOCK_DGRAM
+,
+
+103 .
+	g_doma
+ = &
+lkdoma
+,
+
+104 .
+	g_oc
+ = 0,
+
+105 .
+	g_ags
+ = 
+PR_ATOMIC
+|
+PR_ADDR
+|
+PR_PURGEIF
+,
+
+106 .
+	g_put
+ = 
+NULL
+,
+
+107 .
+	g_lput
+ = 
+NULL
+,
+
+108 .
+	g_louut
+ = 
+NULL
+,
+
+109 .
+	g_uqs
+ = &
+lk_uqs
+,
+
+110 .
+	g_
+ = 
+lk_
+,
+
+114 
+doma
+ 
+	glkdoma
+ = {
+
+115 .
+dom_my
+ = 
+AF_LINK
+,
+
+116 .
+	gdom_me
+ = "link",
+
+117 .
+	gdom_exize
+ = 
+NULL
+,
+
+118 .
+	gdom_dio
+ = 
+NULL
+,
+
+119 .
+	gdom_osw
+ = 
+lksw
+,
+
+120 .
+	gdom_oswNPROTOSW
+ = &
+lksw
+[
+__ycou
+(linksw)],
+
+121 .
+	gdom_sockaddr_cmp
+ = 
+sockaddr_dl_cmp
+
+
+125 
+	$lk_
+()
+
+128 
+	}
+}
+
+131 
+	$lk_c
+(
+sock
+ *
+so
+, 
+cmd
+, *
+da
+,
+
+132 
+i
+ *
+i
+)
+
+134 
+r
+, 
+s
+;
+
+135 
+bo
+ 
+iive
+, 
+mkaive
+;
+
+136 
+if_ddeq
+ *
+ir
+;
+
+138 
+sockaddr
+ 
+
+;
+
+139 
+sockaddr_dl
+ 
+sdl
+;
+
+140 
+sockaddr_age
+ 
+ss
+;
+
+141 } 
+u
+;
+
+142 
+iddr
+ *
+i
+;
+
+143 c 
+sockaddr_dl
+ *
+asdl
+, *
+nsdl
+;
+
+145 
+cmd
+) {
+
+146 
+SIOCALIFADDR
+:
+
+147 
+SIOCDLIFADDR
+:
+
+148 
+SIOCGLIFADDR
+:
+
+149 
+ir
+ = 
+da
+;
+
+151 i(
+ir
+->
+addr
+.
+ss_my
+ !
+AF_LINK
+)
+
+152  
+EINVAL
+;
+
+154 
+asdl
+ = 
+	`tocsdl
+(
+	`soc
+(&
+ir
+->
+addr
+));
+
+156 i(
+asdl
+->
+sdl_
+ !
+i
+->
+if_add
+)
+
+157  
+EINVAL
+;
+
+159 i(
+	`sockaddr_dl_
+(&
+u
+.
+sdl
+, (u.
+ss
+), 
+i
+->
+if_dex
+,
+
+160 
+i
+->
+if_ty
+, i->
+if_xme
+, 
+	`
+(ifp->if_xname),
+
+161 
+	`CLLADDR
+(
+asdl
+),sdl->
+sdl_
+=
+NULL
+)
+
+162  
+EINVAL
+;
+
+164 i((
+ir
+->
+ags
+ & 
+IFLR_PREFIX
+) == 0)
+
+166 i(
+ir
+->
+efixn
+ !
+NBBY
+ * 
+i
+->
+if_add
+)
+
+167  
+EINVAL
+;
+
+169 
+r
+ = 0;
+
+171 
+s
+ = 
+	`
+();
+
+173 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+) {
+
+174 i(
+	`sockaddr_cmp
+(&
+u
+.
+
+, 
+i
+->
+i_addr
+) == 0)
+
+178 
+cmd
+) {
+
+179 
+SIOCGLIFADDR
+:
+
+180 i((
+ir
+->
+ags
+ & 
+IFLR_PREFIX
+) == 0) {
+
+181 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+) {
+
+182 i(
+i
+->
+i_addr
+->
+_my
+ =
+AF_LINK
+)
+
+186 i(
+i
+ =
+NULL
+) {
+
+187 
+r
+ = 
+EADDRNOTAVAIL
+;
+
+191 i(
+i
+ =
+i
+->
+if_dl
+)
+
+192 
+ir
+->
+ags
+ = 
+IFLR_ACTIVE
+;
+
+194 
+ir
+->
+ags
+ = 0;
+
+196 i(
+i
+ =
+i
+->
+if_hwdl
+)
+
+197 
+ir
+->
+ags
+ |
+IFLR_FACTORY
+;
+
+199 
+	`sockaddr_cy
+(
+	`so
+(&
+ir
+->
+addr
+), (iflr->addr),
+
+200 
+i
+->
+i_addr
+);
+
+203 
+SIOCDLIFADDR
+:
+
+204 i(
+i
+ =
+NULL
+)
+
+205 
+r
+ = 
+EADDRNOTAVAIL
+;
+
+206 i(
+i
+ =
+i
+->
+if_dl
+ || i =i->
+if_hwdl
+)
+
+207 
+r
+ = 
+EBUSY
+;
+
+210 
+	`_waddrmsg
+(
+RTM_DELETE
+, 
+i
+, 0, 
+NULL
+);
+
+211 
+	`i_move
+(
+i
+, 
+i
+);
+
+214 
+SIOCALIFADDR
+:
+
+215 i(
+i
+ !
+NULL
+)
+
+217 i((
+i
+ = 
+	`if_dl_
+(
+i
+, &
+nsdl
+)=
+NULL
+) {
+
+218 
+r
+ = 
+ENOMEM
+;
+
+221 
+	`sockaddr_cy
+(
+i
+->
+i_addr
+,
+
+222 
+i
+->
+i_addr
+->
+_n
+, &
+u
+.
+
+);
+
+223 
+	`i_
+(
+i
+, 
+i
+);
+
+224 
+	`_waddrmsg
+(
+RTM_ADD
+, 
+i
+, 0, 
+NULL
+);
+
+227 
+mkaive
+ = (
+ir
+->
+ags
+ & 
+IFLR_ACTIVE
+) != 0;
+
+228 
+iive
+ = (
+i
+ =
+i
+->
+if_dl
+);
+
+230 i(!
+iive
+ && 
+mkaive
+) {
+
+231 
+	`if_aive_dl
+(
+i
+, 
+i
+, 
+nsdl
+);
+
+232 
+	`_waddrmsg
+(
+RTM_CHANGE
+, 
+i
+, 0, 
+NULL
+);
+
+233 
+r
+ = 
+ENETRESET
+;
+
+237 
+	`lx
+(
+s
+);
+
+238 i(
+r
+ !
+ENETRESET
+)
+
+239  
+r
+;
+
+240 i((
+i
+->
+if_ags
+ & 
+IFF_RUNNING
+) != 0 &&
+
+241 
+i
+->
+if_
+ !
+NULL
+)
+
+242  (*
+i
+->
+if_
+)(ifp);
+
+246  
+ENOTTY
+;
+
+248 
+	}
+}
+
+251 
+	$lk_ch
+(
+sock
+ *
+so
+, 
+o
+)
+
+253 
+	`soock
+(
+so
+);
+
+254 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+256 
+	}
+}
+
+259 
+	$lk_dach
+(
+sock
+ *
+so
+)
+
+261 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+262 
+	`so
+(
+so
+);
+
+263 
+	}
+}
+
+266 
+	$lk_ac
+(
+sock
+ *
+so
+, 
+sockaddr
+ *
+m
+)
+
+268 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+270  
+EOPNOTSUPP
+;
+
+271 
+	}
+}
+
+274 
+	$lk_bd
+(
+sock
+ *
+so
+, 
+sockaddr
+ *
+m
+, 
+lwp
+ *
+l
+)
+
+276 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+278  
+EOPNOTSUPP
+;
+
+279 
+	}
+}
+
+282 
+	$lk_li
+(
+sock
+ *
+so
+, 
+lwp
+ *
+l
+)
+
+284 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+286  
+EOPNOTSUPP
+;
+
+287 
+	}
+}
+
+290 
+	$lk_c
+(
+sock
+ *
+so
+, 
+sockaddr
+ *
+m
+, 
+lwp
+ *
+l
+)
+
+292 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+294  
+EOPNOTSUPP
+;
+
+295 
+	}
+}
+
+298 
+	$lk_c2
+(
+sock
+ *
+so
+, sock *
+so2
+)
+
+300 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+302  
+EOPNOTSUPP
+;
+
+303 
+	}
+}
+
+306 
+	$lk_disc
+(
+sock
+ *
+so
+)
+
+308 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+310  
+EOPNOTSUPP
+;
+
+311 
+	}
+}
+
+314 
+	$lk_shutdown
+(
+sock
+ *
+so
+)
+
+316 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+318  
+EOPNOTSUPP
+;
+
+319 
+	}
+}
+
+322 
+	$lk_abt
+(
+sock
+ *
+so
+)
+
+324 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+326  
+EOPNOTSUPP
+;
+
+327 
+	}
+}
+
+330 
+	$lk_iol
+(
+sock
+ *
+so
+, 
+u_lg
+ 
+cmd
+, *
+m
+, 
+i
+ *
+i
+)
+
+332  
+	`lk_c
+(
+so
+, 
+cmd
+, 
+m
+, 
+i
+);
+
+333 
+	}
+}
+
+336 
+	$lk_
+(
+sock
+ *
+so
+, 
+
+ *
+ub
+)
+
+338 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+340  
+EOPNOTSUPP
+;
+
+341 
+	}
+}
+
+344 
+	$lk_addr
+(
+sock
+ *
+so
+, 
+sockaddr
+ *
+m
+)
+
+346 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+348  
+EOPNOTSUPP
+;
+
+349 
+	}
+}
+
+352 
+	$lk_sockaddr
+(
+sock
+ *
+so
+, 
+sockaddr
+ *
+m
+)
+
+354 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+356  
+EOPNOTSUPP
+;
+
+357 
+	}
+}
+
+360 
+	$lk_rcvd
+(
+sock
+ *
+so
+, 
+ags
+, 
+lwp
+ *
+l
+)
+
+362 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+364  
+EOPNOTSUPP
+;
+
+365 
+	}
+}
+
+368 
+	$lk_cvoob
+(
+sock
+ *
+so
+, 
+mbuf
+ *
+m
+, 
+ags
+)
+
+370 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+372  
+EOPNOTSUPP
+;
+
+373 
+	}
+}
+
+376 
+	$lk_nd
+(
+sock
+ *
+so
+, 
+mbuf
+ *
+m
+, 
+sockaddr
+ *
+m
+,
+
+377 
+mbuf
+ *
+c
+, 
+lwp
+ *
+l
+)
+
+379 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+381  
+EOPNOTSUPP
+;
+
+382 
+	}
+}
+
+385 
+	$lk_ndoob
+(
+sock
+ *
+so
+, 
+mbuf
+ *
+m
+, mbu*
+c
+)
+
+387 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+389  
+EOPNOTSUPP
+;
+
+390 
+	}
+}
+
+393 
+	$lk_purgeif
+(
+sock
+ *
+so
+, 
+i
+ *
+i
+)
+
+396  
+EOPNOTSUPP
+;
+
+397 
+	}
+}
+
+402 
+le
+ 
+
+403 
+	$submemcmp
+(c *
+l
+, c *
+r
+,
+
+404 c 
+ut_8_t
+ 
+
+, c ut_8_
+
+,
+
+405 c 
+ut_8_t
+ 
+fldt
+, c ut_8_
+fldd
+)
+
+407 
+ut_8_t
+ 
+cmnd
+, 
+mn
+;
+
+408 c 
+ut8_t
+ *
+lb
+ = 
+l
+, *
+rb
+ = 
+r
+;
+
+409 
+rc
+;
+
+411 
+mn
+ = 
+	`MIN
+(
+
+, 
+
+);
+
+416 i(
+fldt
+ >
+mn
+)
+
+417  
+
+ - 
+
+;
+
+420 i(
+fldt
+ > 
+fldd
+)
+
+423 
+cmnd
+ = 
+	`MIN
+(
+fldd
+, 
+mn
+);
+
+425 
+rc
+ = 
+	`memcmp
+(&
+lb
+[
+fldt
+], &
+rb
+[fldt], 
+cmnd
+ - fieldstart);
+
+427 i(
+rc
+ != 0)
+
+428  
+rc
+;
+
+432 i(
+mn
+ < 
+fldd
+)
+
+433  
+
+ - 
+
+;
+
+436 
+	}
+}
+
+438 
+ut8_t
+
+
+439 
+	$sockaddr_dl_msu
+(
+ut8_t
+ 
+m
+, ut8_
+add
+)
+
+441  
+	`offtof
+(
+sockaddr_dl
+, 
+sdl_da
+[
+m
+ + 
+add
+]);
+
+442 
+	}
+}
+
+444 
+sockaddr
+ *
+
+445 
+	$sockaddr_dl_loc
+(
+ut16_t
+ 
+ifdex
+, 
+ut8_t
+ 
+ty
+,
+
+446 c *
+me
+, 
+ut8_t
+ 
+m
+, c *
+addr
+, ut8_
+add
+,
+
+447 
+ags
+)
+
+449 
+sockaddr
+ *
+
+;
+
+450 
+sockn_t
+ 
+n
+;
+
+452 
+n
+ = 
+	`sockaddr_dl_msu
+(
+m
+, 
+add
+);
+
+453 
+
+ = 
+	`sockaddr_loc
+(
+AF_LINK
+, 
+n
+, 
+ags
+);
+
+455 i(
+
+ =
+NULL
+)
+
+456  
+NULL
+;
+
+458 i(
+	`sockaddr_dl_
+(
+	`tosdl
+(
+
+), 
+n
+, 
+ifdex
+, 
+ty
+, 
+me
+, 
+m
+,
+
+459 
+addr
+, 
+add
+=
+NULL
+) {
+
+460 
+	`sockaddr_
+(
+
+);
+
+461  
+NULL
+;
+
+464  
+
+;
+
+465 
+	}
+}
+
+467 
+sockaddr_dl
+ *
+
+468 
+	$sockaddr_dl_
+(
+sockaddr_dl
+ *
+sdl
+, 
+sockn_t
+ 
+sockn
+, 
+ut16_t
+ 
+ifdex
+,
+
+469 
+ut8_t
+ 
+ty
+, c *
+me
+, ut8_
+m
+, c *
+addr
+,
+
+470 
+ut8_t
+ 
+add
+)
+
+472 
+sockn_t
+ 
+n
+;
+
+474 
+sdl
+->
+sdl_my
+ = 
+AF_LINK
+;
+
+475 
+sdl
+->
+sdl_
+ = 0;
+
+476 
+n
+ = 
+	`sockaddr_dl_msu
+(
+m
+, 
+add
+);
+
+477 i(
+n
+ > 
+sockn
+) {
+
+478 
+sdl
+->
+sdl_n
+ = 
+sockn
+;
+
+479 #ifde
+DIAGNOSTIC
+
+
+480 
+	`tf
+("%s:olg: %u > %u\n", 
+__func__
+, (
+u_t
+)
+n
+,
+
+481 (
+u_t
+)
+sockn
+);
+
+483  
+NULL
+;
+
+485 
+sdl
+->
+sdl_n
+ = 
+n
+;
+
+486 
+sdl
+->
+sdl_dex
+ = 
+ifdex
+;
+
+487 
+sdl
+->
+sdl_ty
+ = 
+ty
+;
+
+488 
+	`memt
+(&
+sdl
+->
+sdl_da
+[0], 0, 
+m
+ + 
+add
+);
+
+489 i(
+me
+ !
+NULL
+) {
+
+490 
+	`memy
+(&
+sdl
+->
+sdl_da
+[0], 
+me
+, 
+m
+);
+
+491 
+sdl
+->
+sdl_
+ = 
+m
+;
+
+493 
+sdl
+->
+sdl_
+ = 0;
+
+494 i(
+addr
+ !
+NULL
+) {
+
+495 
+	`memy
+(&
+sdl
+->
+sdl_da
+[sdl->
+sdl_
+], 
+addr
+, 
+add
+);
+
+496 
+sdl
+->
+sdl_
+ = 
+add
+;
+
+498 
+sdl
+->
+sdl_
+ = 0;
+
+499  
+sdl
+;
+
+500 
+	}
+}
+
+503 
+	$sockaddr_dl_cmp
+(c 
+sockaddr
+ *
+1
+, c sockadd*
+2
+)
+
+505 
+rc
+;
+
+506 c 
+ut_8_t
+ 
+dexofs
+ = 
+	`offtof
+(
+sockaddr_dl
+, 
+sdl_dex
+);
+
+507 c 
+ut_8_t
+ 
+ofs
+ = 
+	`offtof
+(
+sockaddr_dl
+, 
+sdl_
+);
+
+508 
+ut_8_t
+ 
+daofs
+ = 
+	`offtof
+(
+sockaddr_dl
+, 
+sdl_da
+[0]);
+
+509 c 
+sockaddr_dl
+ *
+sdl1
+, *
+sdl2
+;
+
+511 
+sdl1
+ = 
+	`tocsdl
+(
+1
+);
+
+512 
+sdl2
+ = 
+	`tocsdl
+(
+2
+);
+
+514 
+rc
+ = 
+	`submemcmp
+(
+sdl1
+, 
+sdl2
+, sdl1->
+sdl_n
+, sdl2->sdl_len,
+
+515 
+dexofs
+, 
+ofs
+);
+
+517 i(
+rc
+ != 0)
+
+518  
+rc
+;
+
+520 
+rc
+ = 
+	`submemcmp
+(
+sdl1
+, 
+sdl2
+, sdl1->
+sdl_n
+, sdl2->sdl_len,
+
+521 
+daofs
+, daof+ 
+	`MIN
+(
+sdl1
+->
+sdl_
+, 
+sdl2
+->sdl_nlen));
+
+523 i(
+rc
+ != 0)
+
+524  
+rc
+;
+
+526 i(
+sdl1
+->
+sdl_
+ !
+sdl2
+->sdl_nlen)
+
+527  
+sdl1
+->
+sdl_
+ - 
+sdl2
+->sdl_nlen;
+
+529 
+daofs
+ +
+sdl1
+->
+sdl_
+;
+
+531 
+rc
+ = 
+	`submemcmp
+(
+sdl1
+, 
+sdl2
+, sdl1->
+sdl_n
+, sdl2->sdl_len,
+
+532 
+daofs
+, daof+ 
+	`MIN
+(
+sdl1
+->
+sdl_
+, 
+sdl2
+->sdl_alen));
+
+534 i(
+rc
+ != 0)
+
+535  
+rc
+;
+
+537 i(
+sdl1
+->
+sdl_
+ !
+sdl2
+->sdl_alen)
+
+538  
+sdl1
+->
+sdl_
+ - 
+sdl2
+->sdl_alen;
+
+540 
+daofs
+ +
+sdl1
+->
+sdl_
+;
+
+542 
+rc
+ = 
+	`submemcmp
+(
+sdl1
+, 
+sdl2
+, sdl1->
+sdl_n
+, sdl2->sdl_len,
+
+543 
+daofs
+, daof+ 
+	`MIN
+(
+sdl1
+->
+sdl_
+, 
+sdl2
+->sdl_slen));
+
+545 i(
+sdl1
+->
+sdl_
+ !
+sdl2
+->sdl_slen)
+
+546  
+sdl1
+->
+sdl_
+ - 
+sdl2
+->sdl_slen;
+
+548  
+sdl1
+->
+sdl_n
+ - 
+sdl2
+->sdl_len;
+
+549 
+	}
+}
+
+551 
+sockaddr_dl
+ *
+
+552 
+	$sockaddr_dl_ddr
+(
+sockaddr_dl
+ *
+sdl
+, 
+sockn_t
+ 
+sockn
+,
+
+553 c *
+addr
+, 
+ut8_t
+ 
+add
+)
+
+555 
+sockn_t
+ 
+n
+;
+
+557 
+n
+ = 
+	`sockaddr_dl_msu
+(
+sdl
+->
+sdl_
+, 
+add
+);
+
+558 i(
+n
+ > 
+sockn
+) {
+
+559 #ifde
+DIAGNOSTIC
+
+
+560 
+	`tf
+("%s:olg: %u > %u\n", 
+__func__
+, (
+u_t
+)
+n
+,
+
+561 (
+u_t
+)
+sockn
+);
+
+563  
+NULL
+;
+
+565 
+	`memy
+(&
+sdl
+->
+sdl_da
+[sdl->
+sdl_
+], 
+addr
+, 
+add
+);
+
+566 
+sdl
+->
+sdl_
+ = 
+add
+;
+
+567 
+sdl
+->
+sdl_n
+ = 
+n
+;
+
+568  
+sdl
+;
+
+569 
+	}
+}
+
+	@net_osdep.h
+
+300 #ide
+_NET_NET_OSDEP_H_
+
+
+301 
+	#_NET_NET_OSDEP_H_
+
+
+	)
+
+302 #ifde
+_KERNEL
+
+
+304 
+	#if_me
+(
+i
+((i)->
+if_xme
+)
+
+	)
+
+306 #i
+defed
+(
+__NBSD__
+&& 
+__NBSD_Vsi__
+ >= 104000000
+
+307 
+	#ovbcy
+(
+c
+, 
+d
+, 
+n
+
+	`memmove
+((d), (c), (n))
+
+	)
+
+	@net_stats.c
+
+32 
+	~<sys/cdefs.h
+>
+
+33 
+__KERNEL_RCSID
+(0, "$NetBSD:et_stats.c,v 1.4 2008/05/04 07:22:14horpej Exp $");
+
+35 
+	~<sys/tys.h
+>
+
+36 
+	~<sys/sym.h
+>
+
+37 
+	~<sys/sysl.h
+>
+
+38 
+	~<sys/kmem.h
+>
+
+40 
+	~<t/t_s.h
+>
+
+43 
+ut64_t
+ *
+	mx_cous
+;
+
+44 
+u_t
+ 
+	mx_ncous
+;
+
+45 } 
+	tt_sysl_cxt
+;
+
+52 
+	$t_cvt_to_ur_cb
+(*
+v1
+, *
+v2
+, 
+u_fo
+ *
+ci
+)
+
+54 c 
+ut64_t
+ *
+lol_cous
+ = 
+v1
+;
+
+55 
+t_sysl_cxt
+ *
+x
+ = 
+v2
+;
+
+56 
+u_t
+ 
+i
+;
+
+58 
+i
+ = 0; i < 
+x
+->
+x_ncous
+; i++)
+
+59 
+x
+->
+x_cous
+[
+i
+] +
+lol_cous
+[i];
+
+60 
+	}
+}
+
+69 
+	$t_sysl
+(
+ru_t
+ *
+
+, 
+u_t
+ 
+ncous
+, 
+SYSCTLFN_ARGS
+)
+
+71 
+t_sysl_cxt
+ 
+x
+;
+
+72 
+sysode
+ 
+node
+;
+
+73 
+ut64_t
+ *
+cous
+;
+
+74 
+size_t
+ 
+cousize
+;
+
+75 
+rv
+;
+
+77 
+cousize
+ = (
+ut64_t
+* 
+ncous
+;
+
+79 
+cous
+ = 
+	`kmem_zloc
+(
+cousize
+, 
+KM_SLEEP
+);
+
+80 i(
+cous
+ =
+NULL
+)
+
+81  (
+ENOMEM
+);
+
+83 
+x
+.
+x_cous
+ = 
+cous
+;
+
+84 
+x
+.
+x_ncous
+ = 
+ncous
+;
+
+86 
+	`ru_fch
+(
+
+, 
+t_cvt_to_ur_cb
+, &
+x
+);
+
+88 
+node
+ = *
+ode
+;
+
+89 
+node
+.
+sysl_da
+ = 
+cous
+;
+
+90 
+node
+.
+sysl_size
+ = 
+cousize
+;
+
+91 
+rv
+ = 
+	`sysl_lookup
+(
+	`SYSCTLFN_CALL
+(&
+node
+));
+
+93 
+	`kmem_
+(
+cous
+, 
+cousize
+);
+
+95  (
+rv
+);
+
+96 
+	}
+}
+
+	@net_stats.h
+
+32 #ide
+_NET_NET_STATS_H_
+
+
+33 
+	#_NET_NET_STATS_H_
+
+
+	)
+
+35 #ifde
+_KERNEL
+
+
+36 
+	~<sys/ru.h
+>
+
+38 
+	#_NET_STAT_GETREF
+(
+
+((
+ut64_t
+ *)
+	`ru_gf
+(()))
+
+	)
+
+39 
+	#_NET_STAT_PUTREF
+(
+
+
+	`ru_puef
+(())
+
+	)
+
+41 
+	#_NET_STATINC
+(
+
+, 
+x
+) \
+
+43 
+ut64_t
+ *
+__
+ = 
+	`_NET_STAT_GETREF
+(
+
+); \
+
+44 
+__
+[
+x
+]++; \
+
+45 
+	`_NET_STAT_PUTREF
+(
+
+); \
+
+46 }  0)
+
+	)
+
+48 
+	#_NET_STATDEC
+(
+
+, 
+x
+) \
+
+50 
+ut64_t
+ *
+__
+ = 
+	`_NET_STAT_GETREF
+(
+
+); \
+
+51 
+__
+[
+x
+]--; \
+
+52 
+	`_NET_STAT_PUTREF
+(
+
+); \
+
+53 }  0)
+
+	)
+
+55 
+	#_NET_STATADD
+(
+
+, 
+x
+, 
+v
+) \
+
+57 
+ut64_t
+ *
+__
+ = 
+	`_NET_STAT_GETREF
+(
+
+); \
+
+58 
+__
+[
+x
+] +(
+v
+); \
+
+59 
+	`_NET_STAT_PUTREF
+(
+
+); \
+
+60 }  0)
+
+	)
+
+62 
+	#_NET_STATSUB
+(
+
+, 
+x
+, 
+v
+) \
+
+64 
+ut64_t
+ *
+__
+ = 
+	`_NET_STAT_GETREF
+(
+
+); \
+
+65 
+__
+[
+x
+] -(
+v
+); \
+
+66 
+	`_NET_STAT_PUTREF
+(
+
+); \
+
+67 }  0)
+
+	)
+
+69 
+__BEGIN_DECLS
+
+
+70 
+	glwp
+;
+
+71 
+	gsysode
+;
+
+73 
+t_sysl
+(
+ru_t
+ *, 
+u_t
+,
+
+74 c *, 
+u_t
+, *,
+
+75 
+size_t
+ *, const *, size_t,
+
+76 c *, 
+lwp
+ *, c 
+sysode
+ *);
+
+78 
+	#NETSTAT_SYSCTL
+(
+
+, 
+nrs
+) \
+
+79 
+	`t_sysl
+((
+
+), (
+nrs
+), 
+me
+, 
+m
+, 
+dp
+, 
+d
+, \
+
+80 
+wp
+, 
+wn
+, 
+ame
+, 
+l
+, 
+ode
+)
+
+	)
+
+81 
+	g__END_DECLS
+
+
+	@netisr.h
+
+34 #ide
+_NET_NETISR_H_
+
+
+35 
+	#_NET_NETISR_H_
+
+
+	)
+
+49 #i
+defed
+(
+_KERNEL
+)
+
+51 #i
+defed
+(
+_KERNEL_OPT
+)
+
+52 
+	~"t_.h
+"
+
+53 
+	~"t_k.h
+"
+
+54 
+	~"t_ms.h
+"
+
+55 
+	~"t_tm.h
+"
+
+56 
+	~"p.h
+"
+
+59 #i!
+defed
+(
+_LOCORE
+)
+
+62 
+	~<sys/sock.h
+>
+
+68 
+	~<t/if.h
+>
+
+70 #ifde
+INET
+
+
+71 
+	~<t/.h
+>
+
+72 
+	~<t/_v.h
+>
+
+73 #i
+NARP
+ > 0
+
+74 
+	~<t/if_p.h
+>
+
+77 #ifde
+INET6
+
+
+78 #ide
+INET
+
+
+79 
+	~<t/.h
+>
+
+81 
+	~<t/6.h
+>
+
+82 
+	~<t6/6_v.h
+>
+
+84 #ifde
+MPLS
+
+
+85 
+	~<tms/ms_v.h
+>
+
+87 #ifde
+NATM
+
+
+88 
+	~<m/tm.h
+>
+
+90 #ifde
+NETATALK
+
+
+91 
+	~<lk/_ex.h
+>
+
+104 
+	#NETISR_IP
+ 2
+
+	)
+
+105 
+	#NETISR_CCITT
+ 10
+
+	)
+
+106 
+	#NETISR_ATALK
+ 16
+
+	)
+
+107 
+	#NETISR_IPX
+ 23
+
+	)
+
+108 
+	#NETISR_IPV6
+ 24
+
+	)
+
+109 
+	#NETISR_ISDN
+ 26
+
+	)
+
+110 
+	#NETISR_NATM
+ 27
+
+	)
+
+111 
+	#NETISR_ARP
+ 28
+
+	)
+
+112 
+	#NETISR_MPLS
+ 33
+
+	)
+
+113 
+	#NETISR_MAX
+ 
+AF_MAX
+
+
+	)
+
+115 #i!
+defed
+(
+_LOCORE
+&& defed(
+_KERNEL
+)
+
+117 
+schedti
+();
+
+	@netisr_dispatch.h
+
+3 #ide
+_NET_NETISR_DISPATCH_H_
+
+
+4 
+	#_NET_NETISR_DISPATCH_H_
+
+
+	)
+
+21 #ide
+_NET_NETISR_H_
+
+
+22 #r <
+t
+/
+ti
+.
+h
+> 
+mu
+ 
+be
+ 
+uded
+ 
+befe
+ <t/
+ti_dich
+.h>
+
+30 #ifde
+INET
+
+
+31 #i
+NARP
+ > 0
+
+32 
+DONETISR
+(
+NETISR_ARP
+,
+p
+);
+
+35 #ifde
+NETATALK
+
+
+36 
+DONETISR
+(
+NETISR_ATALK
+,
+
+);
+
+38 #ifde
+MPLS
+
+
+39 
+DONETISR
+(
+NETISR_MPLS
+,
+ms
+);
+
+41 #ifde
+NATM
+
+
+42 
+DONETISR
+(
+NETISR_NATM
+,
+tm
+);
+
+	@npf/if_npflog.c
+
+36 
+	~<sys/cdefs.h
+>
+
+37 
+__KERNEL_RCSID
+(0, "$NetBSD: if_npflog.c,v 1.3 2013/03/13 13:15:47 christos Exp $");
+
+39 
+	~<sys/tys.h
+>
+
+40 
+	~<sys/modu.h
+>
+
+42 
+	~<sys/cf.h
+>
+
+43 
+	~<sys/kmem.h
+>
+
+44 
+	~<sys/mbuf.h
+>
+
+45 
+	~<sys/mux.h
+>
+
+46 
+	~<sys/queue.h
+>
+
+47 
+	~<sys/sockio.h
+>
+
+49 
+	~<t/if.h
+>
+
+50 
+	~<t/if_tys.h
+>
+
+51 
+	~<t/bpf.h
+>
+
+53 
+MODULE
+(
+MODULE_CLASS_DRIVER
+, 
+if_og
+, 
+NULL
+);
+
+55 
+	sog_soc
+ {
+
+56 
+LIST_ENTRY
+(
+og_soc
+
+	msc_y
+;
+
+57 
+kmux_t
+ 
+	msc_lock
+;
+
+58 
+i_t
+ 
+	msc_if
+;
+
+59 
+	msc_un
+;
+
+60 } 
+	tog_soc_t
+;
+
+62 
+og_e_
+(
+if_e
+ *, );
+
+63 
+og_e_deroy
+(
+i_t
+ *);
+
+65 
+	$LIST_HEAD
+(, 
+og_soc
+
+og_if_li
+ 
+__che_igd
+;
+
+66 
+if_e
+ 
+og_
+ =
+
+67 
+	`IF_CLONE_INITIALIZER
+("og", 
+og_e_
+, 
+og_e_deroy
+);
+
+70 
+	$ogch
+(
+nuns
+)
+
+73 
+	`LIST_INIT
+(&
+og_if_li
+);
+
+74 
+	`if_e_ch
+(&
+og_
+);
+
+75 
+	}
+}
+
+78 
+	$ogdach
+()
+
+80 
+og_soc_t
+ *
+sc
+;
+
+82 (
+sc
+ = 
+	`LIST_FIRST
+(&
+og_if_li
+)!
+NULL
+) {
+
+83 
+	`og_e_deroy
+(&
+sc
+->
+sc_if
+);
+
+85 
+	`if_e_dach
+(&
+og_
+);
+
+86 
+	}
+}
+
+89 
+	$og_iol
+(
+i_t
+ *
+i
+, 
+u_lg
+ 
+cmd
+, *
+da
+)
+
+91 
+og_soc_t
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+92 
+r
+ = 0;
+
+94 
+	`mux_r
+(&
+sc
+->
+sc_lock
+);
+
+95 
+cmd
+) {
+
+96 
+SIOCINITIFADDR
+:
+
+97 
+i
+->
+if_ags
+ |(
+IFF_UP
+ | 
+IFF_RUNNING
+);
+
+100 
+r
+ = 
+	`ifiol_comm
+(
+i
+, 
+cmd
+, 
+da
+);
+
+103 
+	`mux_ex
+(&
+sc
+->
+sc_lock
+);
+
+104  
+r
+;
+
+105 
+	}
+}
+
+108 
+	$og_e_
+(
+if_e
+ *
+ifc
+, 
+un
+)
+
+110 
+og_soc_t
+ *
+sc
+;
+
+111 
+i_t
+ *
+i
+;
+
+113 
+sc
+ = 
+	`kmem_zloc
+((
+og_soc_t
+), 
+KM_SLEEP
+);
+
+114 
+	`mux_
+(&
+sc
+->
+sc_lock
+, 
+MUTEX_DEFAULT
+, 
+IPL_SOFTNET
+);
+
+116 
+i
+ = &
+sc
+->
+sc_if
+;
+
+117 
+i
+->
+if_soc
+ = 
+sc
+;
+
+119 
+	`if_me
+(
+i
+, "og", 
+un
+);
+
+120 
+i
+->
+if_ty
+ = 
+IFT_OTHER
+;
+
+121 
+i
+->
+if_d
+ = 
+DLT_NULL
+;
+
+122 
+i
+->
+if_iol
+ = 
+og_iol
+;
+
+124 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+125 
+	`if_ch
+(
+i
+);
+
+126 
+	`if_loc_dl
+(
+i
+);
+
+127 
+	`bpf_ch
+(
+i
+, 
+DLT_NULL
+, 0);
+
+128 
+	`LIST_INSERT_HEAD
+(&
+og_if_li
+, 
+sc
+, 
+sc_y
+);
+
+129 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+132 
+	}
+}
+
+135 
+	$og_e_deroy
+(
+i_t
+ *
+i
+)
+
+137 
+og_soc_t
+ *
+sc
+ = 
+i
+->
+if_soc
+;
+
+139 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+140 
+	`LIST_REMOVE
+(
+sc
+, 
+sc_y
+);
+
+141 
+	`bpf_dach
+(
+i
+);
+
+142 
+	`if_dach
+(
+i
+);
+
+143 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+145 
+	`mux_deroy
+(&
+sc
+->
+sc_lock
+);
+
+146 
+	`kmem_
+(
+sc
+, (
+og_soc_t
+));
+
+148 
+	}
+}
+
+154 
+	$if_og_modcmd
+(
+modcmd_t
+ 
+cmd
+, *
+g
+)
+
+156 
+cmd
+) {
+
+157 
+MODULE_CMD_INIT
+:
+
+158 
+	`ogch
+(1);
+
+161 
+MODULE_CMD_FINI
+:
+
+162 
+	`ogdach
+();
+
+165 
+MODULE_CMD_AUTOUNLOAD
+:
+
+166  
+EBUSY
+;
+
+169  
+ENOTTY
+;
+
+172 
+	}
+}
+
+	@npf/npf.c
+
+36 
+	~<sys/cdefs.h
+>
+
+37 
+__KERNEL_RCSID
+(0, "$NetBSD:pf.c,v 1.22 2014/07/25 08:10:40 dholland Exp $");
+
+39 
+	~<sys/m.h
+>
+
+40 
+	~<sys/tys.h
+>
+
+42 
+	~<sys/omic.h
+>
+
+43 
+	~<sys/cf.h
+>
+
+44 
+	~<sys/kauth.h
+>
+
+45 
+	~<sys/kmem.h
+>
+
+46 
+	~<sys/lwp.h
+>
+
+47 
+	~<sys/modu.h
+>
+
+48 
+	~<sys/ru.h
+>
+
+49 
+	~<sys/rwlock.h
+>
+
+50 
+	~<sys/sockv.h
+>
+
+51 
+	~<sys/sysl.h
+>
+
+52 
+	~<sys/uio.h
+>
+
+54 
+	~"f_im.h
+"
+
+55 
+	~"f_cn.h
+"
+
+60 
+MODULE
+(
+MODULE_CLASS_DRIVER
+, 
+f
+, 
+NULL
+);
+
+62 
+ach
+();
+
+64 
+f_fi
+();
+
+65 
+f_dev_
+(
+dev_t
+, , , 
+lwp_t
+ *);
+
+66 
+f_dev_o
+(
+dev_t
+, , , 
+lwp_t
+ *);
+
+67 
+f_dev_iol
+(
+dev_t
+, 
+u_lg
+, *, , 
+lwp_t
+ *);
+
+68 
+f_dev_pl
+(
+dev_t
+, , 
+lwp_t
+ *);
+
+69 
+f_dev_ad
+(
+dev_t
+, 
+uio
+ *, );
+
+71 
+fl_s
+(*);
+
+73 
+ru_t
+ * 
+f_s_ru
+ 
+	g__ad_moly
+;
+
+74 
+sysog
+ * 
+f_sysl
+ 
+	g__ad_moly
+;
+
+76 c 
+cdevsw
+ 
+	gf_cdevsw
+ = {
+
+77 .
+d_
+ = 
+f_dev_
+,
+
+78 .
+	gd_o
+ = 
+f_dev_o
+,
+
+79 .
+	gd_ad
+ = 
+f_dev_ad
+,
+
+80 .
+	gd_wre
+ = 
+nowre
+,
+
+81 .
+	gd_iol
+ = 
+f_dev_iol
+,
+
+82 .
+	gd_
+ = 
+no
+,
+
+83 .
+	gd_y
+ = 
+nty
+,
+
+84 .
+	gd_pl
+ = 
+f_dev_pl
+,
+
+85 .
+	gd_mm
+ = 
+nomm
+,
+
+86 .
+	gd_kqfr
+ = 
+nokqfr
+,
+
+87 .
+	gd_disrd
+ = 
+nodisrd
+,
+
+88 .
+	gd_ag
+ = 
+D_OTHER
+ | 
+D_MPSAFE
+
+
+92 
+	$f_
+()
+
+94 #ifde
+_MODULE
+
+
+95 
+devmaj_t
+ 
+bmaj
+ = 
+NODEVMAJOR
+, 
+cmaj
+ = NODEVMAJOR;
+
+97 
+r
+ = 0;
+
+99 
+f_s_ru
+ = 
+	`ru_loc
+(
+NPF_STATS_SIZE
+);
+
+100 
+f_sysl
+ = 
+NULL
+;
+
+102 
+	`f_bpf_sys
+();
+
+103 
+	`f_wk_sys
+();
+
+104 
+	`f_bt_sys
+();
+
+105 
+	`f_cn_sys
+();
+
+106 
+	`f_t_sys
+();
+
+107 
+	`f_g_sys
+();
+
+108 
+	`f_ext_sys
+();
+
+111 
+	`f_pf_gi
+(
+ue
+);
+
+112 
+	`f_cfig_
+();
+
+114 #ifde
+_MODULE
+
+
+116 
+r
+ = 
+	`devsw_ch
+("f", 
+NULL
+, &
+bmaj
+, &
+f_cdevsw
+, &
+cmaj
+);
+
+117 i(
+r
+) {
+
+119 ()
+	`f_fi
+();
+
+122  
+r
+;
+
+123 
+	}
+}
+
+126 
+	$f_fi
+()
+
+129 #ifde
+_MODULE
+
+
+130 
+	`devsw_dach
+(
+NULL
+, &
+f_cdevsw
+);
+
+132 
+	`f_pf_uegi
+(
+ue
+);
+
+133 
+	`f_cfig_fi
+();
+
+136 
+	`f_ext_sysfi
+();
+
+137 
+	`f_g_sysfi
+();
+
+138 
+	`f_t_sysfi
+();
+
+139 
+	`f_cn_sysfi
+();
+
+140 
+	`f_bt_sysfi
+();
+
+141 
+	`f_bpf_sysfi
+();
+
+144 
+	`f_wk_sysfi
+();
+
+146 i(
+f_sysl
+) {
+
+147 
+	`sysl_down
+(&
+f_sysl
+);
+
+149 
+	`ru_
+(
+f_s_ru
+, 
+NPF_STATS_SIZE
+);
+
+152 
+	}
+}
+
+158 
+	$f_modcmd
+(
+modcmd_t
+ 
+cmd
+, *
+g
+)
+
+161 
+cmd
+) {
+
+162 
+MODULE_CMD_INIT
+:
+
+163  
+	`f_
+();
+
+164 
+MODULE_CMD_FINI
+:
+
+165  
+	`f_fi
+();
+
+166 
+MODULE_CMD_AUTOUNLOAD
+:
+
+167 i(
+	`f_autoud_p
+()) {
+
+168  
+EBUSY
+;
+
+172  
+ENOTTY
+;
+
+175 
+	}
+}
+
+178 
+	$ach
+(
+nuns
+)
+
+182 
+	}
+}
+
+185 
+	$f_dev_
+(
+dev_t
+ 
+dev
+, 
+ag
+, 
+mode
+, 
+lwp_t
+ *
+l
+)
+
+189 i(
+	`kauth_authize_twk
+(
+l
+->
+l_ed
+, 
+KAUTH_NETWORK_FIREWALL
+,
+
+190 
+KAUTH_REQ_NETWORK_FIREWALL_FW
+, 
+NULL
+, NULL, NULL)) {
+
+191  
+EPERM
+;
+
+194 
+	}
+}
+
+197 
+	$f_dev_o
+(
+dev_t
+ 
+dev
+, 
+ag
+, 
+mode
+, 
+lwp_t
+ *
+l
+)
+
+201 
+	}
+}
+
+204 
+	$f_dev_iol
+(
+dev_t
+ 
+dev
+, 
+u_lg
+ 
+cmd
+, *
+da
+, 
+ag
+, 
+lwp_t
+ *
+l
+)
+
+206 
+r
+;
+
+209 i(
+	`kauth_authize_twk
+(
+l
+->
+l_ed
+, 
+KAUTH_NETWORK_FIREWALL
+,
+
+210 
+KAUTH_REQ_NETWORK_FIREWALL_FW
+, 
+NULL
+, NULL, NULL)) {
+
+211  
+EPERM
+;
+
+214 
+cmd
+) {
+
+215 
+IOC_NPF_TABLE
+:
+
+216 
+r
+ = 
+	`fl_b
+(
+da
+);
+
+218 
+IOC_NPF_RULE
+:
+
+219 
+r
+ = 
+	`fl_ru
+(
+cmd
+, 
+da
+);
+
+221 
+IOC_NPF_STATS
+:
+
+222 
+r
+ = 
+	`fl_s
+(
+da
+);
+
+224 
+IOC_NPF_SAVE
+:
+
+225 
+r
+ = 
+	`fl_ve
+(
+cmd
+, 
+da
+);
+
+227 
+IOC_NPF_SWITCH
+:
+
+228 
+r
+ = 
+	`fl_swch
+(
+da
+);
+
+230 
+IOC_NPF_LOAD
+:
+
+231 
+r
+ = 
+	`fl_ld
+(
+cmd
+, 
+da
+);
+
+233 
+IOC_NPF_VERSION
+:
+
+234 *(*)
+da
+ = 
+NPF_VERSION
+;
+
+235 
+r
+ = 0;
+
+238 
+r
+ = 
+ENOTTY
+;
+
+241  
+r
+;
+
+242 
+	}
+}
+
+245 
+	$f_dev_pl
+(
+dev_t
+ 
+dev
+, 
+evts
+, 
+lwp_t
+ *
+l
+)
+
+248  
+ENOTSUP
+;
+
+249 
+	}
+}
+
+252 
+	$f_dev_ad
+(
+dev_t
+ 
+dev
+, 
+uio
+ *uio, 
+ag
+)
+
+255  
+ENOTSUP
+;
+
+256 
+	}
+}
+
+258 
+bo
+
+
+259 
+	$f_autoud_p
+()
+
+261  !
+	`f_pf_gied_p
+(&& 
+	`f_deu_ss
+();
+
+262 
+	}
+}
+
+269 
+	$f_s_c
+(
+f_s_t
+ 
+
+)
+
+271 
+ut64_t
+ *
+s
+ = 
+	`ru_gf
+(
+f_s_ru
+);
+
+272 
+s
+[
+
+]++;
+
+273 
+	`ru_puef
+(
+f_s_ru
+);
+
+274 
+	}
+}
+
+277 
+	$f_s_dec
+(
+f_s_t
+ 
+
+)
+
+279 
+ut64_t
+ *
+s
+ = 
+	`ru_gf
+(
+f_s_ru
+);
+
+280 
+s
+[
+
+]--;
+
+281 
+	`ru_puef
+(
+f_s_ru
+);
+
+282 
+	}
+}
+
+285 
+	$f_s_c
+(*
+mem
+, *
+g
+, 
+u_fo
+ *
+ci
+)
+
+287 
+ut64_t
+ *
+ru_s
+ = 
+mem
+, *
+fu_s
+ = 
+g
+;
+
+288 
+i
+;
+
+290 
+i
+ = 0; i < 
+NPF_STATS_COUNT
+; i++) {
+
+291 
+fu_s
+[
+i
+] +
+ru_s
+[i];
+
+293 
+	}
+}
+
+299 
+	$fl_s
+(*
+da
+)
+
+301 
+ut64_t
+ *
+fu
+, *
+ur
+ = *(ut64_**)
+da
+;
+
+302 
+r
+;
+
+304 
+fu
+ = 
+	`kmem_zloc
+(
+NPF_STATS_SIZE
+, 
+KM_SLEEP
+);
+
+305 
+	`ru_fch
+(
+f_s_ru
+, 
+f_s_c
+, 
+fu
+);
+
+306 
+r
+ = 
+	`cyout
+(
+fu
+, 
+ur
+, 
+NPF_STATS_SIZE
+);
+
+307 
+	`kmem_
+(
+fu
+, 
+NPF_STATS_SIZE
+);
+
+308  
+r
+;
+
+309 
+	}
+}
+
+	@npf/npf.h
+
+36 #ide
+_NPF_NET_H_
+
+
+37 
+	#_NPF_NET_H_
+
+
+	)
+
+39 
+	~<sys/m.h
+>
+
+40 
+	~<sys/tys.h
+>
+
+42 
+	~<sys/iol.h
+>
+
+43 
+	~</lib.h
+>
+
+45 
+	~<t/_sym.h
+>
+
+46 
+	~<t/.h
+>
+
+48 
+	#NPF_VERSION
+ 17
+
+	)
+
+55 
+6_addr
+ 
+	tf_addr_t
+;
+
+56 
+ut8_t
+ 
+	tf_tmask_t
+;
+
+58 
+	#NPF_MAX_NETMASK
+ (128)
+
+	)
+
+59 
+	#NPF_NO_NETMASK
+ ((
+f_tmask_t
+)~0)
+
+	)
+
+62 #i
+defed
+(
+NPF_BPFCOP
+)
+
+63 
+	#NPF_COP_L3
+ 0
+
+	)
+
+64 
+	#NPF_COP_TABLE
+ 1
+
+	)
+
+66 
+	#BPF_MW_IPVER
+ 0
+
+	)
+
+67 
+	#BPF_MW_L4OFF
+ 1
+
+	)
+
+68 
+	#BPF_MW_L4PROTO
+ 2
+
+	)
+
+71 
+	#NPF_BPF_NWORDS
+ 3
+
+	)
+
+73 #i
+defed
+(
+_KERNEL
+)
+
+75 
+	#NPF_DECISION_BLOCK
+ 0
+
+	)
+
+76 
+	#NPF_DECISION_PASS
+ 1
+
+	)
+
+78 
+	#NPF_EXT_MODULE
+(
+me
+, 
+q
+) \
+
+79 
+	`MODULE
+(
+MODULE_CLASS_MISC
+, 
+me
+, ((
+q
+- 1? ("f,"eq: "f")
+
+	)
+
+81 
+	~<t/if.h
+>
+
+82 
+	~<t/.h
+>
+
+83 
+	~<t/6.h
+>
+
+84 
+	~<t/t.h
+>
+
+85 
+	~<t/udp.h
+>
+
+86 
+	~<t/_icmp.h
+>
+
+87 
+	~<t/icmp6.h
+>
+
+93 
+	#NBUF_DATAREF_RESET
+ 0x01
+
+	)
+
+96 
+mbuf
+ * 
+	mnb_mbuf0
+;
+
+97 
+mbuf
+ * 
+	mnb_mbuf
+;
+
+98 * 
+	mnb_
+;
+
+99 c 
+i_t
+ * 
+	mnb_i
+;
+
+100 
+	mnb_ifid
+;
+
+101 
+	mnb_ags
+;
+
+102 } 
+	tnbuf_t
+;
+
+104 
+nbuf_
+(
+nbuf_t
+ *, 
+mbuf
+ *, c 
+i_t
+ *);
+
+105 
+nbuf_t
+(
+nbuf_t
+ *);
+
+106 
+mbuf
+ * 
+nbuf_hd_mbuf
+(
+nbuf_t
+ *);
+
+108 
+bo
+ 
+nbuf_ag_p
+(c 
+nbuf_t
+ *, );
+
+109 
+nbuf_unt_ag
+(
+nbuf_t
+ *, );
+
+111 * 
+nbuf_d
+(
+nbuf_t
+ *);
+
+112 
+size_t
+ 
+nbuf_offt
+(c 
+nbuf_t
+ *);
+
+113 * 
+nbuf_adv
+(
+nbuf_t
+ *, 
+size_t
+, size_t);
+
+115 * 
+nbuf_su_ctig
+(
+nbuf_t
+ *, 
+size_t
+);
+
+116 * 
+nbuf_su_wrab
+(
+nbuf_t
+ *, 
+size_t
+);
+
+118 
+bo
+ 
+nbuf_cksum_brr
+(
+nbuf_t
+ *, );
+
+119 
+nbuf_add_g
+(
+nbuf_t
+ *, 
+ut32_t
+, uint32_t);
+
+120 
+nbuf_fd_g
+(
+nbuf_t
+ *, 
+ut32_t
+, **);
+
+126 
+	#NPC_IP4
+ 0x01
+
+	)
+
+127 
+	#NPC_IP6
+ 0x02
+
+	)
+
+128 
+	#NPC_IPFRAG
+ 0x04
+
+	)
+
+129 
+	#NPC_LAYER4
+ 0x08
+
+	)
+
+131 
+	#NPC_TCP
+ 0x10
+
+	)
+
+132 
+	#NPC_UDP
+ 0x20
+
+	)
+
+133 
+	#NPC_ICMP
+ 0x40
+
+	)
+
+134 
+	#NPC_ICMP_ID
+ 0x80
+
+	)
+
+136 
+	#NPC_ALG_EXEC
+ 0x100
+
+	)
+
+138 
+	#NPC_IP46
+ (
+NPC_IP4
+|
+NPC_IP6
+)
+
+	)
+
+142 
+ut32_t
+ 
+	mc_fo
+;
+
+143 
+nbuf_t
+ * 
+	mc_nbuf
+;
+
+149 
+f_addr_t
+ * 
+	mc_s
+[2];
+
+150 
+ut8_t
+ 
+	mc_
+;
+
+153 
+ut8_t
+ 
+	mc_hn
+;
+
+154 
+ut16_t
+ 
+	mc_o
+;
+
+158 
+
+ * 
+	mv4
+;
+
+159 
+6_hdr
+ * 
+	mv6
+;
+
+160 } 
+	mc_
+;
+
+164 
+thdr
+ * 
+	mt
+;
+
+165 
+udphdr
+ * 
+	mudp
+;
+
+166 
+icmp
+ * 
+	micmp
+;
+
+167 
+icmp6_hdr
+ * 
+	micmp6
+;
+
+168 * 
+	mhdr
+;
+
+169 } 
+	mc_l4
+;
+
+170 } 
+	tf_che_t
+;
+
+172 
+le
+ 
+bo
+
+
+173 
+	$f_isched
+(c 
+f_che_t
+ *
+c
+, c 
+f
+)
+
+175 
+	`KASSERT
+(
+c
+->
+c_nbuf
+ !
+NULL
+);
+
+176  
+	`__edi_ue
+((
+c
+->
+c_fo
+ & 
+f
+) != 0);
+
+177 
+	}
+}
+
+179 
+	#NPF_SRC
+ 0
+
+	)
+
+180 
+	#NPF_DST
+ 1
+
+	)
+
+186 
+	gf_roc
+;
+
+187 
+f_roc
+ 
+	tf_roc_t
+;
+
+189 
+f_roc_assign
+(
+f_roc_t
+ *, *);
+
+192 
+	mvsi
+;
+
+193 * 
+	mx
+;
+
+194 (*
+	m
+)(
+	mf_roc_t
+ *, 
+	m_diiy_t
+);
+
+195 (*
+	mdt
+)(
+	mf_roc_t
+ *, *);
+
+196 
+bo
+ (*
+oc
+)(
+	mf_che_t
+ *, *, *);
+
+197 } 
+	tf_ext_s_t
+;
+
+199 * 
+f_ext_gi
+(c *, c 
+f_ext_s_t
+ *);
+
+200 
+f_ext_uegi
+(*);
+
+206 
+bo
+ 
+f_autoud_p
+();
+
+211 
+	#NPF_RULE_PASS
+ 0x00000001
+
+	)
+
+212 
+	#NPF_RULE_GROUP
+ 0x00000002
+
+	)
+
+213 
+	#NPF_RULE_FINAL
+ 0x00000004
+
+	)
+
+214 
+	#NPF_RULE_STATEFUL
+ 0x00000008
+
+	)
+
+215 
+	#NPF_RULE_RETRST
+ 0x00000010
+
+	)
+
+216 
+	#NPF_RULE_RETICMP
+ 0x00000020
+
+	)
+
+217 
+	#NPF_RULE_DYNAMIC
+ 0x00000040
+
+	)
+
+218 
+	#NPF_RULE_MULTIENDS
+ 0x00000080
+
+	)
+
+220 
+	#NPF_DYNAMIC_GROUP
+ (
+NPF_RULE_GROUP
+ | 
+NPF_RULE_DYNAMIC
+)
+
+	)
+
+222 
+	#NPF_RULE_IN
+ 0x10000000
+
+	)
+
+223 
+	#NPF_RULE_OUT
+ 0x20000000
+
+	)
+
+224 
+	#NPF_RULE_DIMASK
+ (
+NPF_RULE_IN
+ | 
+NPF_RULE_OUT
+)
+
+	)
+
+225 
+	#NPF_RULE_FORW
+ 0x40000000
+
+	)
+
+228 
+	#NPF_RULE_PRIVMASK
+ 0x0f000000
+
+	)
+
+230 
+	#NPF_RULE_MAXNAMELEN
+ 64
+
+	)
+
+231 
+	#NPF_RULE_MAXKEYLEN
+ 32
+
+	)
+
+234 
+	#NPF_PRI_FIRST
+ (-2)
+
+	)
+
+235 
+	#NPF_PRI_LAST
+ (-1)
+
+	)
+
+238 
+	#NPF_CODE_NC
+ 1
+
+	)
+
+239 
+	#NPF_CODE_BPF
+ 2
+
+	)
+
+242 
+	#NPF_NATIN
+ 1
+
+	)
+
+243 
+	#NPF_NATOUT
+ 2
+
+	)
+
+245 
+	#NPF_NAT_PORTS
+ 0x01
+
+	)
+
+246 
+	#NPF_NAT_PORTMAP
+ 0x02
+
+	)
+
+247 
+	#NPF_NAT_STATIC
+ 0x04
+
+	)
+
+249 
+	#NPF_ALGO_NPT66
+ 1
+
+	)
+
+252 
+	#NPF_TABLE_HASH
+ 1
+
+	)
+
+253 
+	#NPF_TABLE_TREE
+ 2
+
+	)
+
+254 
+	#NPF_TABLE_CDB
+ 3
+
+	)
+
+256 
+	#NPF_TABLE_MAXNAMELEN
+ 32
+
+	)
+
+259 
+	#NPF_LAYER_2
+ 2
+
+	)
+
+260 
+	#NPF_LAYER_3
+ 3
+
+	)
+
+263 
+	#PACKET_TAG_NPF
+ 10
+
+	)
+
+269 
+	#NPF_CMD_RULE_ADD
+ 1
+
+	)
+
+270 
+	#NPF_CMD_RULE_INSERT
+ 2
+
+	)
+
+271 
+	#NPF_CMD_RULE_REMOVE
+ 3
+
+	)
+
+272 
+	#NPF_CMD_RULE_REMKEY
+ 4
+
+	)
+
+273 
+	#NPF_CMD_RULE_LIST
+ 5
+
+	)
+
+274 
+	#NPF_CMD_RULE_FLUSH
+ 6
+
+	)
+
+280 
+	#NPF_CMD_TABLE_LOOKUP
+ 1
+
+	)
+
+281 
+	#NPF_CMD_TABLE_ADD
+ 2
+
+	)
+
+282 
+	#NPF_CMD_TABLE_REMOVE
+ 3
+
+	)
+
+283 
+	#NPF_CMD_TABLE_LIST
+ 4
+
+	)
+
+284 
+	#NPF_CMD_TABLE_FLUSH
+ 5
+
+	)
+
+286 
+	sf_iol_t
+ {
+
+287 
+	m
+;
+
+288 
+f_addr_t
+ 
+	maddr
+;
+
+289 
+f_tmask_t
+ 
+	mmask
+;
+
+290 } 
+	tf_iol_t_t
+;
+
+292 
+	sf_iol_buf
+ {
+
+293 * 
+	mbuf
+;
+
+294 
+size_t
+ 
+	mn
+;
+
+295 } 
+	tf_iol_buf_t
+;
+
+297 
+	sf_iol_b
+ {
+
+298 
+	mn_cmd
+;
+
+299 c * 
+	mn_me
+;
+
+301 
+f_iol_t_t
+ 
+	mt
+;
+
+302 
+f_iol_buf_t
+ 
+	mbuf
+;
+
+303 } 
+	mn_da
+;
+
+304 } 
+	tf_iol_b_t
+;
+
+310 
+	#IOC_NPF_VERSION
+ 
+	`_IOR
+('N', 100, )
+
+	)
+
+311 
+	#IOC_NPF_SWITCH
+ 
+	`_IOW
+('N', 101, )
+
+	)
+
+312 
+	#IOC_NPF_LOAD
+ 
+	`_IOWR
+('N', 102, 
+if
+)
+
+	)
+
+313 
+	#IOC_NPF_TABLE
+ 
+	`_IOW
+('N', 103, 
+f_iol_b
+)
+
+	)
+
+314 
+	#IOC_NPF_STATS
+ 
+	`_IOW
+('N', 104, *)
+
+	)
+
+315 
+	#IOC_NPF_SAVE
+ 
+	`_IOR
+('N', 105, 
+if
+)
+
+	)
+
+316 
+	#IOC_NPF_RULE
+ 
+	`_IOWR
+('N', 107, 
+if
+)
+
+	)
+
+324 
+	mNPF_STAT_PASS_DEFAULT
+,
+
+325 
+	mNPF_STAT_PASS_RULESET
+,
+
+326 
+	mNPF_STAT_PASS_CONN
+,
+
+328 
+	mNPF_STAT_BLOCK_DEFAULT
+,
+
+329 
+	mNPF_STAT_BLOCK_RULESET
+,
+
+331 
+	mNPF_STAT_CONN_CREATE
+,
+
+332 
+	mNPF_STAT_CONN_DESTROY
+,
+
+333 
+	mNPF_STAT_NAT_CREATE
+,
+
+334 
+	mNPF_STAT_NAT_DESTROY
+,
+
+336 
+	mNPF_STAT_INVALID_STATE
+,
+
+337 
+	mNPF_STAT_INVALID_STATE_TCP1
+,
+
+338 
+	mNPF_STAT_INVALID_STATE_TCP2
+,
+
+339 
+	mNPF_STAT_INVALID_STATE_TCP3
+,
+
+341 
+	mNPF_STAT_RACE_CONN
+,
+
+342 
+	mNPF_STAT_RACE_NAT
+,
+
+344 
+	mNPF_STAT_FRAGMENTS
+,
+
+345 
+	mNPF_STAT_REASSEMBLY
+,
+
+346 
+	mNPF_STAT_REASSFAIL
+,
+
+348 
+	mNPF_STAT_ERROR
+,
+
+350 
+	mNPF_STAT_NBUF_NONCONTIG
+,
+
+351 
+	mNPF_STAT_NBUF_CONTIG_FAIL
+,
+
+353 
+	mNPF_STATS_COUNT
+
+
+354 } 
+	tf_s_t
+;
+
+356 
+	#NPF_STATS_SIZE
+ ((
+ut64_t
+* 
+NPF_STATS_COUNT
+)
+
+	)
+
+	@npf/npf_alg.c
+
+36 
+	~<sys/cdefs.h
+>
+
+37 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_alg.c,v 1.15 2014/08/11 23:48:01mind Exp $");
+
+39 
+	~<sys/m.h
+>
+
+40 
+	~<sys/tys.h
+>
+
+42 
+	~<sys/kmem.h
+>
+
+43 
+	~<sys/prlize.h
+>
+
+44 
+	~<sys/mux.h
+>
+
+45 
+	~<t/pf.h
+>
+
+46 
+	~<sys/modu.h
+>
+
+48 
+	~"f_im.h
+"
+
+56 
+	sf_g
+ {
+
+57 c * 
+	m_me
+;
+
+58 
+u_t
+ 
+	m_
+;
+
+62 
+prlize_t
+ 
+g_psz
+ 
+	g__che_igd
+;
+
+63 
+f_g_t
+ 
+	gg_li
+[
+NPF_MAX_ALGS
+] 
+	g__ad_moly
+;
+
+64 
+u_t
+ 
+g_cou
+ 
+	g__ad_moly
+;
+
+67 
+_funcs_t
+ 
+	gg_funcs
+[
+NPF_MAX_ALGS
+] 
+	g__ad_moly
+;
+
+69 c 
+	gg_efix
+[] = "npf_alg_";
+
+70 
+	#NPF_EXT_PREFLEN
+ ((
+g_efix
+- 1)
+
+	)
+
+73 
+	$f_g_sys
+()
+
+75 
+g_psz
+ = 
+	`prlize_
+();
+
+76 
+	`memt
+(
+g_li
+, 0, (alg_list));
+
+77 
+	`memt
+(
+g_funcs
+, 0, (alg_funcs));
+
+78 
+g_cou
+ = 0;
+
+79 
+	}
+}
+
+82 
+	$f_g_sysfi
+()
+
+84 
+	`prlize_deroy
+(
+g_psz
+);
+
+85 
+	}
+}
+
+87 
+f_g_t
+ *
+
+88 
+	$f_g_lookup
+(c *
+me
+)
+
+90 
+	`KASSERT
+(
+	`f_cfig_locked_p
+());
+
+92 
+u_t
+ 
+i
+ = 0; i < 
+g_cou
+; i++) {
+
+93 
+f_g_t
+ *
+g
+ = &
+g_li
+[
+i
+];
+
+94 c *
+ame
+ = 
+g
+->
+_me
+;
+
+96 i(
+ame
+ && 
+	`rcmp
+me, 
+me
+) == 0)
+
+97  
+g
+;
+
+99  
+NULL
+;
+
+100 
+	}
+}
+
+102 
+f_g_t
+ *
+
+103 
+	$f_g_cru
+(c *
+me
+)
+
+105 
+f_g_t
+ *
+g
+;
+
+107 
+	`f_cfig_r
+();
+
+108 i((
+g
+ = 
+	`f_g_lookup
+(
+me
+)=
+NULL
+) {
+
+109 
+modme
+[
+NPF_EXT_PREFLEN
+ + 64];
+
+110 
+	`tf
+(
+modme
+, (modme), "%s%s", 
+g_efix
+, 
+me
+);
+
+111 
+	`f_cfig_ex
+();
+
+113 i(
+	`modu_autd
+(
+modme
+, 
+MODULE_CLASS_MISC
+) != 0) {
+
+114  
+NULL
+;
+
+116 
+	`f_cfig_r
+();
+
+117 
+g
+ = 
+	`f_g_lookup
+(
+me
+);
+
+119 
+	`f_cfig_ex
+();
+
+120  
+g
+;
+
+121 
+	}
+}
+
+126 
+f_g_t
+ *
+
+127 
+	$f_g_gi
+(c *
+me
+, c 
+_funcs_t
+ *
+funcs
+)
+
+129 
+f_g_t
+ *
+g
+;
+
+130 
+u_t
+ 
+i
+;
+
+132 
+	`f_cfig_r
+();
+
+133 i(
+	`f_g_lookup
+(
+me
+!
+NULL
+) {
+
+134 
+	`f_cfig_ex
+();
+
+135  
+NULL
+;
+
+139 
+i
+ = 0; i < 
+NPF_MAX_ALGS
+; i++) {
+
+140 
+g
+ = &
+g_li
+[
+i
+];
+
+141 i(
+g
+->
+_me
+ =
+NULL
+) {
+
+145 i(
+i
+ =
+NPF_MAX_ALGS
+) {
+
+146 
+	`f_cfig_ex
+();
+
+147  
+NULL
+;
+
+151 
+g
+->
+_me
+ = 
+me
+;
+
+152 
+g
+->
+_
+ = 
+i
+;
+
+155 
+g_funcs
+[
+i
+].
+mch
+ = 
+funcs
+->match;
+
+156 
+g_funcs
+[
+i
+].
+e
+ = 
+funcs
+->translate;
+
+157 
+g_funcs
+[
+i
+].
+e
+ = 
+funcs
+->inspect;
+
+159 
+g_cou
+ = 
+	`MAX
+lg_cou, 
+i
+ + 1);
+
+160 
+	`f_cfig_ex
+();
+
+162  
+g
+;
+
+163 
+	}
+}
+
+169 
+	$f_g_uegi
+(
+f_g_t
+ *
+g
+)
+
+171 
+u_t
+ 
+i
+ = 
+g
+->
+_
+;
+
+174 
+	`f_cfig_r
+();
+
+175 
+g_funcs
+[
+i
+].
+mch
+ = 
+NULL
+;
+
+176 
+g_funcs
+[
+i
+].
+e
+ = 
+NULL
+;
+
+177 
+g_funcs
+[
+i
+].
+e
+ = 
+NULL
+;
+
+178 
+	`prlize_rfm
+(
+g_psz
+);
+
+181 
+	`f_rut_g
+(
+	`f_cfig_tt
+(), 
+g
+);
+
+182 
+g
+->
+_me
+ = 
+NULL
+;
+
+183 
+	`f_cfig_ex
+();
+
+186 
+	}
+}
+
+191 
+bo
+
+
+192 
+	$f_g_mch
+(
+f_che_t
+ *
+c
+, 
+f_t_t
+ *
+
+, 
+di
+)
+
+194 
+bo
+ 
+mch
+ = 
+l
+;
+
+195 
+s
+;
+
+197 
+s
+ = 
+	`prlize_ad_r
+();
+
+198 
+u_t
+ 
+i
+ = 0; i < 
+g_cou
+; i++) {
+
+199 c 
+_funcs_t
+ *
+f
+ = &
+g_funcs
+[
+i
+];
+
+201 i(
+f
+->
+mch
+ && f->
+	`mch
+(
+c
+, 
+
+, 
+di
+)) {
+
+202 
+mch
+ = 
+ue
+;
+
+206 
+	`prlize_ad_ex
+(
+s
+);
+
+207  
+mch
+;
+
+208 
+	}
+}
+
+214 
+	$f_g_exec
+(
+f_che_t
+ *
+c
+, 
+f_t_t
+ *
+
+, 
+bo
+ 
+fw
+)
+
+216 
+s
+;
+
+218 
+s
+ = 
+	`prlize_ad_r
+();
+
+219 
+u_t
+ 
+i
+ = 0; i < 
+g_cou
+; i++) {
+
+220 c 
+_funcs_t
+ *
+f
+ = &
+g_funcs
+[
+i
+];
+
+222 i(
+f
+->
+e
+) {
+
+223 
+f
+->
+	`e
+(
+c
+, 
+
+, 
+fw
+);
+
+226 
+	`prlize_ad_ex
+(
+s
+);
+
+227 
+	}
+}
+
+229 
+f_cn_t
+ *
+
+230 
+	$f_g_cn
+(
+f_che_t
+ *
+c
+, 
+di
+)
+
+232 
+f_cn_t
+ *
+c
+ = 
+NULL
+;
+
+233 
+s
+;
+
+235 
+s
+ = 
+	`prlize_ad_r
+();
+
+236 
+u_t
+ 
+i
+ = 0; i < 
+g_cou
+; i++) {
+
+237 c 
+_funcs_t
+ *
+f
+ = &
+g_funcs
+[
+i
+];
+
+239 i(!
+f
+->
+e
+)
+
+241 i((
+c
+ = 
+f
+->
+	`e
+(
+c
+, 
+di
+)!
+NULL
+)
+
+244 
+	`prlize_ad_ex
+(
+s
+);
+
+245  
+c
+;
+
+246 
+	}
+}
+
+248 
+_y_t
+
+
+249 
+	$f_g_expt
+()
+
+251 
+_y_t
+ 
+gli
+ = 
+	`_y_
+();
+
+253 
+	`KASSERT
+(
+	`f_cfig_locked_p
+());
+
+255 
+u_t
+ 
+i
+ = 0; i < 
+g_cou
+; i++) {
+
+256 c 
+f_g_t
+ *
+g
+ = &
+g_li
+[
+i
+];
+
+258 i(
+g
+->
+_me
+ =
+NULL
+) {
+
+261 
+_diiy_t
+ 
+gdi
+ = 
+	`_diiy_
+();
+
+262 
+	`_diiy_t_crg
+(
+gdi
+, "me", 
+g
+->
+_me
+);
+
+263 
+	`_y_add
+(
+gli
+, 
+gdi
+);
+
+264 
+	`_obje_a
+(
+gdi
+);
+
+266  
+gli
+;
+
+267 
+	}
+}
+
+	@npf/npf_alg_icmp.c
+
+36 
+	~<sys/cdefs.h
+>
+
+37 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_alg_icmp.c,v 1.23 2014/07/20 00:37:41mind Exp $");
+
+39 
+	~<sys/m.h
+>
+
+40 
+	~<sys/modu.h
+>
+
+42 
+	~<t/_sym.h
+>
+
+43 
+	~<t/.h
+>
+
+44 
+	~<t/.h
+>
+
+45 
+	~<t/t.h
+>
+
+46 
+	~<t/udp.h
+>
+
+47 
+	~<t/_icmp.h
+>
+
+48 
+	~<t/icmp6.h
+>
+
+49 
+	~<t/pf.h
+>
+
+51 
+	~"f_im.h
+"
+
+52 
+	~"f_cn.h
+"
+
+54 
+MODULE
+(
+MODULE_CLASS_MISC
+, 
+f_g_icmp
+, "npf");
+
+63 
+	#TR_BASE_PORT
+ 33434
+
+	)
+
+64 
+	#TR_PORT_RANGE
+ 33484
+
+	)
+
+65 
+	#TR_MAX_TTL
+ 48
+
+	)
+
+67 
+f_g_t
+ * 
+g_icmp
+ 
+	g__ad_moly
+;
+
+73 
+bo
+
+
+74 
+	$_icmp_mch
+(
+f_che_t
+ *
+c
+, 
+f_t_t
+ *
+
+, 
+di
+)
+
+76 c 
+o
+ = 
+c
+->
+c_o
+;
+
+77 c 
+
+ * = 
+c
+->
+c_
+.
+v4
+;
+
+78 
+_pt_t
+ 
+dpt
+;
+
+80 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_IP46
+));
+
+81 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_LAYER4
+));
+
+84 i(
+
+->
+_l
+ > 
+TR_MAX_TTL
+ || 
+di
+ !
+PFIL_OUT
+) {
+
+85  
+l
+;
+
+88 
+o
+) {
+
+89 
+IPPROTO_TCP
+: {
+
+90 c 
+thdr
+ *
+th
+ = 
+c
+->
+c_l4
+.
+t
+;
+
+91 
+dpt
+ = 
+	`ohs
+(
+th
+->
+th_dpt
+);
+
+94 
+IPPROTO_UDP
+: {
+
+95 c 
+udphdr
+ *
+uh
+ = 
+c
+->
+c_l4
+.
+udp
+;
+
+96 
+dpt
+ = 
+	`ohs
+(
+uh
+->
+uh_dpt
+);
+
+99 
+IPPROTO_ICMP
+:
+
+100 
+IPPROTO_ICMPV6
+:
+
+102 
+dpt
+ = 
+TR_BASE_PORT
+;
+
+105  
+l
+;
+
+109 i(
+dpt
+ < 
+TR_BASE_PORT
+ || dp> 
+TR_PORT_RANGE
+) {
+
+110  
+l
+;
+
+114 
+	`f_t_lg
+(
+
+, 
+g_icmp
+, 0);
+
+115  
+ue
+;
+
+116 
+	}
+}
+
+123 
+bo
+
+
+124 
+	$_icmp4_e
+(c 
+ty
+, 
+f_che_t
+ *
+c
+)
+
+126 
+nbuf_t
+ *
+nbuf
+ = 
+c
+->
+c_nbuf
+;
+
+127 
+u_t
+ 
+offby
+;
+
+130 
+ty
+) {
+
+131 
+ICMP_UNREACH
+:
+
+132 
+ICMP_SOURCEQUENCH
+:
+
+133 
+ICMP_REDIRECT
+:
+
+134 
+ICMP_TIMXCEED
+:
+
+135 
+ICMP_PARAMPROB
+:
+
+136 i(
+c
+ =
+NULL
+) {
+
+137  
+l
+;
+
+140 i(!
+	`nbuf_adv
+(
+nbuf
+, 
+	`offtof
+(
+icmp
+, 
+icmp_
+), 0)) {
+
+141  
+l
+;
+
+143  (
+	`f_che_l
+(
+c
+& 
+NPC_LAYER4
+) != 0;
+
+145 
+ICMP_ECHOREPLY
+:
+
+146 
+ICMP_ECHO
+:
+
+147 
+ICMP_TSTAMP
+:
+
+148 
+ICMP_TSTAMPREPLY
+:
+
+149 
+ICMP_IREQ
+:
+
+150 
+ICMP_IREQREPLY
+:
+
+152 
+offby
+ = 
+	`offtof
+(
+icmp
+, 
+icmp_id
+);
+
+153 i(!
+	`nbuf_adv
+(
+nbuf
+, 
+offby
+, (
+ut16_t
+))) {
+
+154  
+l
+;
+
+156 
+c
+->
+c_fo
+ |
+NPC_ICMP_ID
+;
+
+157  
+ue
+;
+
+161  
+l
+;
+
+162 
+	}
+}
+
+164 
+bo
+
+
+165 
+	$_icmp6_e
+(c 
+ty
+, 
+f_che_t
+ *
+c
+)
+
+167 
+nbuf_t
+ *
+nbuf
+ = 
+c
+->
+c_nbuf
+;
+
+168 
+u_t
+ 
+offby
+;
+
+171 
+ty
+) {
+
+172 
+ICMP6_DST_UNREACH
+:
+
+173 
+ICMP6_PACKET_TOO_BIG
+:
+
+174 
+ICMP6_TIME_EXCEEDED
+:
+
+175 
+ICMP6_PARAM_PROB
+:
+
+176 i(
+c
+ =
+NULL
+) {
+
+177  
+l
+;
+
+180 i(!
+	`nbuf_adv
+(
+nbuf
+, (
+icmp6_hdr
+), 0)) {
+
+181  
+l
+;
+
+183  (
+	`f_che_l
+(
+c
+& 
+NPC_LAYER4
+) != 0;
+
+185 
+ICMP6_ECHO_REQUEST
+:
+
+186 
+ICMP6_ECHO_REPLY
+:
+
+188 
+offby
+ = 
+	`offtof
+(
+icmp6_hdr
+, 
+icmp6_id
+);
+
+189 i(!
+	`nbuf_adv
+(
+nbuf
+, 
+offby
+, (
+ut16_t
+))) {
+
+190  
+l
+;
+
+192 
+c
+->
+c_fo
+ |
+NPC_ICMP_ID
+;
+
+193  
+ue
+;
+
+197  
+l
+;
+
+198 
+	}
+}
+
+205 
+bo
+
+
+206 
+	$_icmp_e
+(
+f_che_t
+ *
+c
+,pf_che_*
+pc
+)
+
+208 
+nbuf_t
+ *
+nbuf
+ = 
+c
+->
+c_nbuf
+;
+
+209 
+bo
+ 
+t
+;
+
+211 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_IP46
+));
+
+212 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_ICMP
+));
+
+215 
+	`nbuf_t
+(
+nbuf
+);
+
+216 i(!
+	`nbuf_adv
+(
+nbuf
+, 
+c
+->
+c_hn
+, 0)) {
+
+217  
+l
+;
+
+219 
+pc
+->
+c_nbuf
+ = 
+nbuf
+;
+
+220 
+pc
+->
+c_fo
+ = 0;
+
+226 i(
+	`f_isched
+(
+c
+, 
+NPC_IP4
+)) {
+
+227 c 
+icmp
+ *
+ic
+ = 
+c
+->
+c_l4
+.icmp;
+
+228 
+t
+ = 
+	`_icmp4_e
+(
+ic
+->
+icmp_ty
+, 
+pc
+);
+
+229 } i(
+	`f_isched
+(
+c
+, 
+NPC_IP6
+)) {
+
+230 c 
+icmp6_hdr
+ *
+ic6
+ = 
+c
+->
+c_l4
+.
+icmp6
+;
+
+231 
+t
+ = 
+	`_icmp6_e
+(
+ic6
+->
+icmp6_ty
+, 
+pc
+);
+
+233 
+t
+ = 
+l
+;
+
+235 i(!
+t
+) {
+
+236  
+l
+;
+
+240 i(
+	`f_isched
+(
+pc
+, 
+NPC_ICMP_ID
+)) {
+
+241 
+c
+->
+c_fo
+ |
+NPC_ICMP_ID
+;
+
+242  
+l
+;
+
+246  
+ue
+;
+
+247 
+	}
+}
+
+249 
+f_cn_t
+ *
+
+250 
+	$_icmp_cn
+(
+f_che_t
+ *
+c
+, 
+di
+)
+
+252 
+f_che_t
+ 
+pc
+;
+
+255 i(!
+	`f_isched
+(
+c
+, 
+NPC_ICMP
+))
+
+256  
+NULL
+;
+
+257 i(!
+	`_icmp_e
+(
+c
+, &
+pc
+))
+
+258  
+NULL
+;
+
+264 
+	ul4
+ {
+
+265 
+thdr
+ 
+th
+;
+
+266 
+udphdr
+ 
+uh
+;
+
+267 } 
+l4
+;
+
+268 
+bo
+ 
+t
+, 
+fw
+;
+
+270 
+	#SWAP
+(
+ty
+, 
+x
+, 
+y
+{y 
+tmp
+ = x; x = y; y =mp; }
+
+	)
+
+271 
+	`SWAP
+(
+f_addr_t
+ *, 
+pc
+.
+c_s
+[
+NPF_SRC
+],c.c_s[
+NPF_DST
+]);
+
+273 
+pc
+.
+c_o
+) {
+
+274 
+IPPROTO_TCP
+:
+
+275 
+l4
+.
+th
+.
+th_t
+ = 
+pc
+.
+c_l4
+.
+t
+->
+th_dpt
+;
+
+276 
+l4
+.
+th
+.
+th_dpt
+ = 
+pc
+.
+c_l4
+.
+t
+->
+th_t
+;
+
+277 
+pc
+.
+c_l4
+.
+t
+ = &
+l4
+.
+th
+;
+
+279 
+IPPROTO_UDP
+:
+
+280 
+l4
+.
+uh
+.
+uh_t
+ = 
+pc
+.
+c_l4
+.
+udp
+->
+uh_dpt
+;
+
+281 
+l4
+.
+uh
+.
+uh_dpt
+ = 
+pc
+.
+c_l4
+.
+udp
+->
+uh_t
+;
+
+282 
+pc
+.
+c_l4
+.
+udp
+ = &
+l4
+.
+uh
+;
+
+284 
+IPPROTO_ICMP
+: {
+
+285 c 
+icmp
+ *
+ic
+ = 
+pc
+.
+c_l4
+.icmp;
+
+286 
+t
+ = 
+	`_icmp4_e
+(
+ic
+->
+icmp_ty
+, &
+pc
+);
+
+287 i(!
+t
+ || !
+	`f_isched
+(&
+pc
+, 
+NPC_ICMP_ID
+))
+
+288  
+l
+;
+
+291 
+IPPROTO_ICMPV6
+: {
+
+292 c 
+icmp6_hdr
+ *
+ic6
+ = 
+pc
+.
+c_l4
+.
+icmp6
+;
+
+293 
+t
+ = 
+	`_icmp6_e
+(
+ic6
+->
+icmp6_ty
+, &
+pc
+);
+
+294 i(!
+t
+ || !
+	`f_isched
+(&
+pc
+, 
+NPC_ICMP_ID
+))
+
+295  
+l
+;
+
+299  
+l
+;
+
+303  
+	`f_cn_lookup
+(&
+pc
+, 
+di
+, &
+fw
+);
+
+304 
+	}
+}
+
+310 
+bo
+
+
+311 
+	$_icmp_t
+(
+f_che_t
+ *
+c
+, 
+f_t_t
+ *
+
+, 
+bo
+ 
+fw
+)
+
+313 c 
+u_t
+ 
+which
+ = 
+NPF_SRC
+;
+
+314 
+f_che_t
+ 
+pc
+;
+
+316 i(
+fw
+ || !
+	`f_isched
+(
+c
+, 
+NPC_ICMP
+))
+
+317  
+l
+;
+
+318 i(!
+	`_icmp_e
+(
+c
+, &
+pc
+))
+
+319  
+l
+;
+
+321 
+	`KASSERT
+(
+	`f_isched
+(&
+pc
+, 
+NPC_IP46
+));
+
+322 
+	`KASSERT
+(
+	`f_isched
+(&
+pc
+, 
+NPC_LAYER4
+));
+
+327 
+icmp
+ *
+ic
+ = 
+c
+->
+c_l4
+.icmp;
+
+328 
+ut16_t
+ 
+cksum
+ = 
+ic
+->
+icmp_cksum
+;
+
+330 
+	`CTASSERT
+(
+	`offtof
+(
+icmp
+, 
+icmp_cksum
+) ==
+
+331 
+	`offtof
+(
+icmp6_hdr
+, 
+icmp6_cksum
+));
+
+338 c 
+o
+ = 
+pc
+.
+c_o
+;
+
+339 
+ut16_t
+ 
+cksum
+ = 0, 
+l4cksum
+ = 0;
+
+340 
+f_addr_t
+ *
+addr
+;
+
+341 
+_pt_t
+ 
+pt
+;
+
+343 
+	`f_t_gig
+(
+
+, &
+addr
+, &
+pt
+);
+
+345 i(
+	`f_isched
+(&
+pc
+, 
+NPC_IP4
+)) {
+
+346 c 
+
+ *
+e
+ = 
+pc
+.
+c_
+.
+v4
+;
+
+347 
+cksum
+ = 
+e
+->
+_sum
+;
+
+349 
+cksum
+ = 
+	`f_addr_cksum
+(cksum, 
+pc
+.
+c_
+,c.
+c_s
+[
+which
+], 
+addr
+);
+
+351 
+o
+) {
+
+352 
+IPPROTO_TCP
+: {
+
+353 c 
+thdr
+ *
+th
+ = 
+pc
+.
+c_l4
+.
+t
+;
+
+354 
+cksum
+ = 
+	`f_fixup16_cksum
+(cksum, 
+th
+->
+th_t
+, 
+pt
+);
+
+355 
+l4cksum
+ = 
+th
+->
+th_sum
+;
+
+358 
+IPPROTO_UDP
+: {
+
+359 c 
+udphdr
+ *
+uh
+ = 
+pc
+.
+c_l4
+.
+udp
+;
+
+360 
+cksum
+ = 
+	`f_fixup16_cksum
+(cksum, 
+uh
+->
+uh_t
+, 
+pt
+);
+
+361 
+l4cksum
+ = 
+uh
+->
+uh_sum
+;
+
+364 
+IPPROTO_ICMP
+:
+
+365 
+IPPROTO_ICMPV6
+:
+
+368  
+l
+;
+
+382 i(
+	`f__rwr
+(&
+pc
+, 
+which
+, 
+addr
+, 
+pt
+)) {
+
+383  
+l
+;
+
+390 i(
+	`f_isched
+(&
+pc
+, 
+NPC_IP4
+)) {
+
+391 c 
+
+ *
+e
+ = 
+pc
+.
+c_
+.
+v4
+;
+
+392 
+cksum
+ = 
+	`f_fixup16_cksum
+(cksum, 
+cksum
+, 
+e
+->
+_sum
+);
+
+394 
+o
+) {
+
+395 
+IPPROTO_TCP
+: {
+
+396 c 
+thdr
+ *
+th
+ = 
+pc
+.
+c_l4
+.
+t
+;
+
+397 
+cksum
+ = 
+	`f_fixup16_cksum
+(cksum, 
+l4cksum
+, 
+th
+->
+th_sum
+);
+
+400 
+IPPROTO_UDP
+:
+
+401 i(
+l4cksum
+) {
+
+402 c 
+udphdr
+ *
+uh
+ = 
+pc
+.
+c_l4
+.
+udp
+;
+
+403 
+cksum
+ = 
+	`f_fixup16_cksum
+(cksum, 
+l4cksum
+, 
+uh
+->
+uh_sum
+);
+
+407 
+ic
+->
+icmp_cksum
+ = 
+cksum
+;
+
+408  
+ue
+;
+
+409 
+	}
+}
+
+417 
+	$f_g_icmp_
+()
+
+419 c 
+_funcs_t
+ 
+icmp
+ = {
+
+420 .
+mch
+ = 
+_icmp_mch
+,
+
+421 .
+e
+ = 
+_icmp_t
+,
+
+422 .
+e
+ = 
+_icmp_cn
+,
+
+424 
+g_icmp
+ = 
+	`f_g_gi
+("icmp", &
+icmp
+);
+
+425  
+g_icmp
+ ? 0 : 
+ENOMEM
+;
+
+426 
+	}
+}
+
+429 
+	$f_g_icmp_fi
+()
+
+431 
+	`KASSERT
+(
+g_icmp
+ !
+NULL
+);
+
+432  
+	`f_g_uegi
+(
+g_icmp
+);
+
+433 
+	}
+}
+
+436 
+	$f_g_icmp_modcmd
+(
+modcmd_t
+ 
+cmd
+, *
+g
+)
+
+438 
+cmd
+) {
+
+439 
+MODULE_CMD_INIT
+:
+
+440  
+	`f_g_icmp_
+();
+
+441 
+MODULE_CMD_FINI
+:
+
+442  
+	`f_g_icmp_fi
+();
+
+443 
+MODULE_CMD_AUTOUNLOAD
+:
+
+444  
+EBUSY
+;
+
+446  
+ENOTTY
+;
+
+449 
+	}
+}
+
+	@npf/npf_bpf.c
+
+36 
+	~<sys/cdefs.h
+>
+
+37 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_bpf.c,v 1.11 2014/07/20 00:37:41mind Exp $");
+
+39 
+	~<sys/tys.h
+>
+
+40 
+	~<sys/m.h
+>
+
+42 
+	~<sys/bs.h
+>
+
+43 
+	~<sys/mbuf.h
+>
+
+44 
+	~<t/bpf.h
+>
+
+46 
+	#NPF_BPFCOP
+
+
+	)
+
+47 
+	~"f_im.h
+"
+
+53 
+bpf_x_t
+ *
+f_bpfx
+ 
+	g__ad_moly
+;
+
+55 
+ut32_t
+ 
+f_c_l3
+(c 
+bpf_x_t
+ *, 
+bpf_gs_t
+ *, uint32_t);
+
+56 
+ut32_t
+ 
+f_c_b
+(c 
+bpf_x_t
+ *, 
+bpf_gs_t
+ *, uint32_t);
+
+58 c 
+bpf_cfunc_t
+ 
+	gf_bpfc
+[] = {
+
+59 [
+NPF_COP_L3
+] = 
+f_c_l3
+,
+
+60 [
+NPF_COP_TABLE
+] = 
+f_c_b
+,
+
+63 
+	#BPF_MW_ALLMASK
+ \
+
+64 ((1U << 
+BPF_MW_IPVER
+| (1U << 
+BPF_MW_L4OFF
+| (1U << 
+BPF_MW_L4PROTO
+))
+
+	)
+
+67 
+	$f_bpf_sys
+()
+
+69 
+f_bpfx
+ = 
+	`bpf_
+();
+
+70 
+	`bpf_t_c
+(
+f_bpfx
+, 
+f_bpfc
+, 
+	`__ycou
+(npf_bpfcop));
+
+71 
+	`bpf_t_extmem
+(
+f_bpfx
+, 
+NPF_BPF_NWORDS
+, 
+BPF_MW_ALLMASK
+);
+
+72 
+	}
+}
+
+75 
+	$f_bpf_sysfi
+()
+
+77 
+	`bpf_deroy
+(
+f_bpfx
+);
+
+78 
+	}
+}
+
+81 
+	$f_bpf_e
+(
+f_che_t
+ *
+c
+, 
+bpf_gs_t
+ *
+gs
+, 
+ut32_t
+ *
+M
+)
+
+83 c 
+mbuf
+ *mbu
+	`nbuf_hd_mbuf
+(
+c
+->
+c_nbuf
+);
+
+84 c 
+size_t
+ 
+pk
+ = 
+	`m_ngth
+(
+mbuf
+);
+
+87 
+gs
+->
+pkt
+ = (c 
+ut8_t
+ *)
+mbuf
+;
+
+88 
+gs
+->
+w
+ = 
+pk
+;
+
+89 
+gs
+->
+bu
+ = 0;
+
+90 
+gs
+->
+mem
+ = 
+M
+;
+
+91 
+gs
+->
+g
+ = 
+c
+;
+
+101 c 
+u_t
+ 
+
+ = 
+c
+->
+c_
+;
+
+102 c 
+ut32_t
+ 
+v
+ = (
+
+ & 4) | ((alen >> 4) * 6);
+
+110 
+M
+[
+BPF_MW_IPVER
+] = 
+v
+;
+
+111 
+M
+[
+BPF_MW_L4OFF
+] = 
+c
+->
+c_hn
+;
+
+112 
+M
+[
+BPF_MW_L4PROTO
+] = 
+c
+->
+c_o
+;
+
+113 
+	}
+}
+
+116 
+	$f_bpf_fr
+(
+bpf_gs_t
+ *
+gs
+, c *
+code
+, 
+bpfj_func_t
+ 
+jcode
+)
+
+119 i(
+	`__edi_ue
+(
+jcode
+)) {
+
+120  
+	`jcode
+(
+f_bpfx
+, 
+gs
+);
+
+124  
+	`bpf_fr_ext
+(
+f_bpfx
+, 
+code
+, 
+gs
+);
+
+125 
+	}
+}
+
+128 
+	$f_bpf_compe
+(*
+code
+, 
+size_t
+ 
+size
+)
+
+130  
+	`bpf_j_ge
+(
+f_bpfx
+, 
+code
+, 
+size
+);
+
+131 
+	}
+}
+
+133 
+bo
+
+
+134 
+	$f_bpf_vide
+(c *
+code
+, 
+size_t
+ 
+n
+)
+
+136 c 
+size_t
+ 
+icou
+ = 
+n
+ / (
+bpf_
+);
+
+137  
+	`bpf_vide_ext
+(
+f_bpfx
+, 
+code
+, 
+icou
+) != 0;
+
+138 
+	}
+}
+
+143 
+ut32_t
+
+
+144 
+	$f_c_l3
+(c 
+bpf_x_t
+ *
+bc
+, 
+bpf_gs_t
+ *
+gs
+, 
+ut32_t
+ 
+A
+)
+
+146 c 
+f_che_t
+ * c 
+c
+ = (cpf_che_*)
+gs
+->
+g
+;
+
+147 c 
+ut32_t
+ 
+v
+ = (
+c
+->
+c_
+ & 4) | ((npc->npc_alen >> 4) * 6);
+
+148 
+ut32_t
+ * c 
+M
+ = 
+gs
+->
+mem
+;
+
+150 
+M
+[
+BPF_MW_IPVER
+] = 
+v
+;
+
+151 
+M
+[
+BPF_MW_L4OFF
+] = 
+c
+->
+c_hn
+;
+
+152 
+M
+[
+BPF_MW_L4PROTO
+] = 
+c
+->
+c_o
+;
+
+153  
+v
+;
+
+154 
+	}
+}
+
+156 
+	#SRC_FLAG_BIT
+ (1U << 31)
+
+	)
+
+163 
+ut32_t
+
+
+164 
+	$f_c_b
+(c 
+bpf_x_t
+ *
+bc
+, 
+bpf_gs_t
+ *
+gs
+, 
+ut32_t
+ 
+A
+)
+
+166 c 
+f_che_t
+ * c 
+c
+ = (cpf_che_*)
+gs
+->
+g
+;
+
+167 
+f_bt_t
+ *
+tblt
+ = 
+	`f_cfig_bt
+();
+
+168 c 
+ut32_t
+ 
+tid
+ = 
+A
+ & (
+SRC_FLAG_BIT
+ - 1);
+
+169 c 
+f_addr_t
+ *
+addr
+;
+
+170 
+f_b_t
+ *
+t
+;
+
+172 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_IP46
+));
+
+174 i((
+t
+ = 
+	`f_bt_gbyid
+(
+tblt
+, 
+tid
+)=
+NULL
+) {
+
+177 
+addr
+ = 
+c
+->
+c_s
+[(
+A
+ & 
+SRC_FLAG_BIT
+? 
+NPF_SRC
+ : 
+NPF_DST
+];
+
+178  
+	`f_b_lookup
+(
+t
+, 
+c
+->
+c_
+, 
+addr
+) == 0;
+
+179 
+	}
+}
+
+	@npf/npf_conf.c
+
+50 
+	~<sys/cdefs.h
+>
+
+51 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_conf.c,v 1.9 2014/11/30 01:37:53mind Exp $");
+
+53 
+	~<sys/m.h
+>
+
+54 
+	~<sys/tys.h
+>
+
+56 
+	~<sys/omic.h
+>
+
+57 
+	~<sys/kmem.h
+>
+
+58 
+	~<sys/prlize.h
+>
+
+59 
+	~<sys/mux.h
+>
+
+61 
+	~"f_im.h
+"
+
+62 
+	~"f_cn.h
+"
+
+65 
+f_rut_t
+ * 
+	mn_rus
+;
+
+66 
+f_bt_t
+ * 
+	mn_bs
+;
+
+67 
+f_rut_t
+ * 
+	mn_t_rus
+;
+
+68 
+f_roct_t
+ * 
+	mn_rocs
+;
+
+69 
+bo
+ 
+	mn_deu_ss
+;
+
+70 } 
+	tf_cfig_t
+;
+
+72 
+f_cfig_t
+ * 
+f_cfig
+ 
+	g__che_igd
+;
+
+73 
+kmux_t
+ 
+f_cfig_lock
+ 
+	g__che_igd
+;
+
+74 
+prlize_t
+ 
+f_cfig_psz
+ 
+	g__che_igd
+;
+
+77 
+	$f_cfig_
+()
+
+79 
+f_rut_t
+ *
+t
+, *
+nt
+;
+
+80 
+f_roct_t
+ *
+t
+;
+
+81 
+f_bt_t
+ *
+tt
+;
+
+83 
+	`mux_
+(&
+f_cfig_lock
+, 
+MUTEX_DEFAULT
+, 
+IPL_SOFTNET
+);
+
+84 
+f_cfig_psz
+ = 
+	`prlize_
+();
+
+87 
+tt
+ = 
+	`f_bt_
+(0);
+
+88 
+t
+ = 
+	`f_roct_
+();
+
+89 
+t
+ = 
+	`f_rut_
+(0);
+
+90 
+nt
+ = 
+	`f_rut_
+(0);
+
+91 
+	`f_cfig_ld
+(
+t
+, 
+tt
+, 
+nt
+, 
+t
+, 
+NULL
+, 
+ue
+);
+
+92 
+	`KASSERT
+(
+f_cfig
+ !
+NULL
+);
+
+93 
+	}
+}
+
+96 
+	$f_cfig_deroy
+(
+f_cfig_t
+ *
+nc
+)
+
+98 
+	`f_rut_deroy
+(
+nc
+->
+n_rus
+);
+
+99 
+	`f_rut_deroy
+(
+nc
+->
+n_t_rus
+);
+
+100 
+	`f_roct_deroy
+(
+nc
+->
+n_rocs
+);
+
+101 
+	`f_bt_deroy
+(
+nc
+->
+n_bs
+);
+
+102 
+	`kmem_
+(
+nc
+, (
+f_cfig_t
+));
+
+103 
+	}
+}
+
+106 
+	$f_cfig_fi
+()
+
+108 
+f_cndb_t
+ *
+cd
+ = 
+	`f_cndb_
+();
+
+111 
+	`mux_r
+(&
+f_cfig_lock
+);
+
+112 
+	`f_cn_ackg
+(
+l
+);
+
+113 
+	`prlize_rfm
+(
+f_cfig_psz
+);
+
+114 
+	`f_cn_ld
+(
+cd
+, 
+l
+);
+
+115 
+	`f_ifm_ush
+();
+
+116 
+	`mux_ex
+(&
+f_cfig_lock
+);
+
+118 
+	`f_cfig_deroy
+(
+f_cfig
+);
+
+119 
+	`prlize_deroy
+(
+f_cfig_psz
+);
+
+120 
+	`mux_deroy
+(&
+f_cfig_lock
+);
+
+121 
+	}
+}
+
+128 
+	$f_cfig_ld
+(
+f_rut_t
+ *
+rt
+, 
+f_bt_t
+ *
+tt
+,
+
+129 
+f_rut_t
+ *
+nt
+, 
+f_roct_t
+ *
+t
+,
+
+130 
+f_cndb_t
+ *
+cns
+, 
+bo
+ 
+ush
+)
+
+132 c 
+bo
+ 
+ld
+ = 
+cns
+ !
+NULL
+;
+
+133 
+f_cfig_t
+ *
+nc
+, *
+c
+;
+
+135 
+nc
+ = 
+	`kmem_zloc
+((
+f_cfig_t
+), 
+KM_SLEEP
+);
+
+136 
+nc
+->
+n_rus
+ = 
+rt
+;
+
+137 
+nc
+->
+n_bs
+ = 
+tt
+;
+
+138 
+nc
+->
+n_t_rus
+ = 
+nt
+;
+
+139 
+nc
+->
+n_rocs
+ = 
+t
+;
+
+140 
+nc
+->
+n_deu_ss
+ = 
+ush
+;
+
+147 
+	`mux_r
+(&
+f_cfig_lock
+);
+
+148 i((
+c
+ = 
+f_cfig
+!
+NULL
+) {
+
+149 
+	`f_rut_ld
+(
+rt
+, 
+c
+->
+n_rus
+, 
+ld
+);
+
+150 
+	`f_bt_ld
+(
+tt
+, 
+c
+->
+n_bs
+);
+
+151 
+	`f_rut_ld
+(
+nt
+, 
+c
+->
+n_t_rus
+, 
+ld
+);
+
+157 
+	`memb_sync
+();
+
+158 
+f_cfig
+ = 
+nc
+;
+
+159 i(
+c
+ =
+NULL
+) {
+
+161 
+	`f_ifm_ush
+();
+
+162 
+	`f_cn_ld
+(
+cns
+, !
+ush
+);
+
+163 
+	`mux_ex
+(&
+f_cfig_lock
+);
+
+171 i(
+ush
+ || 
+cns
+) {
+
+172 
+	`f_cn_ackg
+(
+l
+);
+
+176 
+	`prlize_rfm
+(
+f_cfig_psz
+);
+
+177 i(
+ush
+) {
+
+178 
+	`f_ifm_ush
+();
+
+185 
+	`f_cn_ld
+(
+cns
+, !
+ush
+);
+
+186 
+	`mux_ex
+(&
+f_cfig_lock
+);
+
+189 
+	`f_cfig_deroy
+(
+c
+);
+
+190 
+	}
+}
+
+197 
+	$f_cfig_r
+()
+
+199 
+	`mux_r
+(&
+f_cfig_lock
+);
+
+200 
+	}
+}
+
+203 
+	$f_cfig_ex
+()
+
+205 
+	`mux_ex
+(&
+f_cfig_lock
+);
+
+206 
+	}
+}
+
+208 
+bo
+
+
+209 
+	$f_cfig_locked_p
+()
+
+211  
+	`mux_owd
+(&
+f_cfig_lock
+);
+
+212 
+	}
+}
+
+215 
+	$f_cfig_sync
+()
+
+217 
+	`KASSERT
+(
+	`f_cfig_locked_p
+());
+
+218 
+	`prlize_rfm
+(
+f_cfig_psz
+);
+
+219 
+	}
+}
+
+226 
+	$f_cfig_ad_r
+()
+
+228  
+	`prlize_ad_r
+();
+
+229 
+	}
+}
+
+232 
+	$f_cfig_ad_ex
+(
+s
+)
+
+234 
+	`prlize_ad_ex
+(
+s
+);
+
+235 
+	}
+}
+
+241 
+f_rut_t
+ *
+
+242 
+	$f_cfig_rut
+()
+
+244  
+f_cfig
+->
+n_rus
+;
+
+245 
+	}
+}
+
+247 
+f_rut_t
+ *
+
+248 
+	$f_cfig_tt
+()
+
+250  
+f_cfig
+->
+n_t_rus
+;
+
+251 
+	}
+}
+
+253 
+f_bt_t
+ *
+
+254 
+	$f_cfig_bt
+()
+
+256  
+f_cfig
+->
+n_bs
+;
+
+257 
+	}
+}
+
+259 
+f_roct_t
+ *
+
+260 
+	$f_cfig_rocs
+()
+
+262  
+f_cfig
+->
+n_rocs
+;
+
+263 
+	}
+}
+
+265 
+bo
+
+
+266 
+	$f_deu_ss
+()
+
+268  
+f_cfig
+->
+n_deu_ss
+;
+
+269 
+	}
+}
+
+	@npf/npf_conn.c
+
+101 
+	~<sys/cdefs.h
+>
+
+102 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_conn.c,v 1.16 2015/02/05 22:04:03mind Exp $");
+
+104 
+	~<sys/m.h
+>
+
+105 
+	~<sys/tys.h
+>
+
+107 
+	~<t/.h
+>
+
+108 
+	~<t/t.h
+>
+
+110 
+	~<sys/omic.h
+>
+
+111 
+	~<sys/cdv.h
+>
+
+112 
+	~<sys/kmem.h
+>
+
+113 
+	~<sys/kthad.h
+>
+
+114 
+	~<sys/mux.h
+>
+
+115 
+	~<t/pf.h
+>
+
+116 
+	~<sys/po.h
+>
+
+117 
+	~<sys/queue.h
+>
+
+118 
+	~<sys/sym.h
+>
+
+120 
+	#__NPF_CONN_PRIVATE
+
+
+	)
+
+121 
+	~"f_cn.h
+"
+
+122 
+	~"f_im.h
+"
+
+127 
+CTASSERT
+(
+PFIL_ALL
+ == (0x001 | 0x002));
+
+128 
+	#CONN_ACTIVE
+ 0x004
+
+	)
+
+129 
+	#CONN_PASS
+ 0x008
+
+	)
+
+130 
+	#CONN_EXPIRE
+ 0x010
+
+	)
+
+131 
+	#CONN_REMOVED
+ 0x020
+
+	)
+
+136 um { 
+	mCONN_TRACKING_OFF
+, 
+	mCONN_TRACKING_ON
+ };
+
+137 v
+cn_ackg
+ 
+	g__che_igd
+;
+
+140 
+f_cndb_t
+ * 
+cn_db
+ 
+	g__ad_moly
+;
+
+141 
+po_che_t
+ 
+cn_che
+ 
+	g__ad_moly
+;
+
+142 
+kmux_t
+ 
+cn_lock
+ 
+	g__che_igd
+;
+
+144 
+f_cn_wk
+();
+
+145 
+f_cn_deroy
+(
+f_cn_t
+ *);
+
+152 
+	$f_cn_sys
+()
+
+154 
+cn_che
+ = 
+	`po_che_
+((
+f_cn_t
+), 
+cohcy_un
+,
+
+155 0, 0, "fc", 
+NULL
+, 
+IPL_NET
+, NULL, NULL, NULL);
+
+156 
+	`mux_
+(&
+cn_lock
+, 
+MUTEX_DEFAULT
+, 
+IPL_NONE
+);
+
+157 
+cn_ackg
+ = 
+CONN_TRACKING_OFF
+;
+
+158 
+cn_db
+ = 
+	`f_cndb_
+();
+
+160 
+	`f_wk_gi
+(
+f_cn_wk
+);
+
+161 
+	}
+}
+
+164 
+	$f_cn_sysfi
+()
+
+167 
+	`KASSERT
+(
+cn_ackg
+ =
+CONN_TRACKING_OFF
+);
+
+168 
+	`f_wk_uegi
+(
+f_cn_wk
+);
+
+170 
+	`f_cndb_deroy
+(
+cn_db
+);
+
+171 
+	`po_che_deroy
+(
+cn_che
+);
+
+172 
+	`mux_deroy
+(&
+cn_lock
+);
+
+173 
+	}
+}
+
+183 
+	$f_cn_ld
+(
+f_cndb_t
+ *
+ndb
+, 
+bo
+ 
+ack
+)
+
+185 
+f_cndb_t
+ *
+odb
+ = 
+NULL
+;
+
+187 
+	`KASSERT
+(
+	`f_cfig_locked_p
+());
+
+193 
+	`mux_r
+(&
+cn_lock
+);
+
+194 i(
+ndb
+) {
+
+195 
+	`KASSERT
+(
+cn_ackg
+ =
+CONN_TRACKING_OFF
+);
+
+196 
+odb
+ = 
+cn_db
+;
+
+197 
+cn_db
+ = 
+ndb
+;
+
+198 
+	`memb_sync
+();
+
+200 i(
+ack
+) {
+
+202 
+cn_ackg
+ = 
+CONN_TRACKING_ON
+;
+
+204 
+	`mux_ex
+(&
+cn_lock
+);
+
+206 i(
+odb
+) {
+
+211 
+	`f_cn_gc
+(
+odb
+, 
+ue
+, 
+l
+);
+
+212 
+	`f_cndb_deroy
+(
+odb
+);
+
+213 
+	`po_che_vide
+(
+cn_che
+);
+
+215 
+	}
+}
+
+221 
+	$f_cn_ackg
+(
+bo
+ 
+ack
+)
+
+223 
+	`KASSERT
+(
+	`f_cfig_locked_p
+());
+
+224 
+cn_ackg
+ = 
+ack
+ ? 
+CONN_TRACKING_ON
+ : 
+CONN_TRACKING_OFF
+;
+
+225 
+	}
+}
+
+227 
+le
+ 
+bo
+
+
+228 
+	$f_cn_ackab_p
+(c 
+f_che_t
+ *
+c
+)
+
+234 i(
+cn_ackg
+ !
+CONN_TRACKING_ON
+) {
+
+235  
+l
+;
+
+237 i(!
+	`f_isched
+(
+c
+, 
+NPC_IP46
+|| !f_ischedpc, 
+NPC_LAYER4
+)) {
+
+238  
+l
+;
+
+240  
+ue
+;
+
+241 
+	}
+}
+
+249 
+	$f_cn_ckey
+(c 
+f_che_t
+ *
+c
+, 
+f_cnkey_t
+ *
+key
+, c 
+bo
+ 
+fw
+)
+
+251 c 
+u_t
+ 
+
+ = 
+c
+->
+c_
+;
+
+252 c 
+thdr
+ *
+th
+;
+
+253 c 
+udphdr
+ *
+uh
+;
+
+254 
+u_t
+ 
+keyn
+, 
+ic
+, 
+id
+;
+
+255 
+ut16_t
+ 
+id
+[2];
+
+257 
+c
+->
+c_o
+) {
+
+258 
+IPPROTO_TCP
+:
+
+259 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_TCP
+));
+
+260 
+th
+ = 
+c
+->
+c_l4
+.
+t
+;
+
+261 
+id
+[
+NPF_SRC
+] = 
+th
+->
+th_t
+;
+
+262 
+id
+[
+NPF_DST
+] = 
+th
+->
+th_dpt
+;
+
+264 
+IPPROTO_UDP
+:
+
+265 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_UDP
+));
+
+266 
+uh
+ = 
+c
+->
+c_l4
+.
+udp
+;
+
+267 
+id
+[
+NPF_SRC
+] = 
+uh
+->
+uh_t
+;
+
+268 
+id
+[
+NPF_DST
+] = 
+uh
+->
+uh_dpt
+;
+
+270 
+IPPROTO_ICMP
+:
+
+271 i(
+	`f_isched
+(
+c
+, 
+NPC_ICMP_ID
+)) {
+
+272 c 
+icmp
+ *
+ic
+ = 
+c
+->
+c_l4
+.icmp;
+
+273 
+id
+[
+NPF_SRC
+] = 
+ic
+->
+icmp_id
+;
+
+274 
+id
+[
+NPF_DST
+] = 
+ic
+->
+icmp_id
+;
+
+278 
+IPPROTO_ICMPV6
+:
+
+279 i(
+	`f_isched
+(
+c
+, 
+NPC_ICMP_ID
+)) {
+
+280 c 
+icmp6_hdr
+ *
+ic6
+ = 
+c
+->
+c_l4
+.
+icmp6
+;
+
+281 
+id
+[
+NPF_SRC
+] = 
+ic6
+->
+icmp6_id
+;
+
+282 
+id
+[
+NPF_DST
+] = 
+ic6
+->
+icmp6_id
+;
+
+291 i(
+	`__edi_ue
+(
+fw
+)) {
+
+292 
+ic
+ = 
+NPF_SRC
+, 
+id
+ = 
+NPF_DST
+;
+
+294 
+ic
+ = 
+NPF_DST
+, 
+id
+ = 
+NPF_SRC
+;
+
+309 
+key
+->
+ck_key
+[0] = ((
+ut32_t
+)
+c
+->
+c_o
+ << 16| (
+
+ & 0xffff);
+
+310 
+key
+->
+ck_key
+[1] = ((
+ut32_t
+)
+id
+[
+ic
+] << 16| id[
+id
+];
+
+312 i(
+	`__edi_ue
+(
+
+ =(
+_addr_t
+))) {
+
+313 
+key
+->
+ck_key
+[2] = 
+c
+->
+c_s
+[
+ic
+]->
+s6_addr32
+[0];
+
+314 
+key
+->
+ck_key
+[3] = 
+c
+->
+c_s
+[
+id
+]->
+s6_addr32
+[0];
+
+315 
+keyn
+ = 4 * (
+ut32_t
+);
+
+317 c 
+u_t
+ 
+nwds
+ = 
+
+ >> 2;
+
+318 
+	`memy
+(&
+key
+->
+ck_key
+[2], 
+c
+->
+c_s
+[
+ic
+], 
+
+);
+
+319 
+	`memy
+(&
+key
+->
+ck_key
+[2 + 
+nwds
+], 
+c
+->
+c_s
+[
+id
+], 
+
+);
+
+320 
+keyn
+ = (2 + (
+nwds
+ * 2)* (
+ut32_t
+);
+
+322  
+keyn
+;
+
+323 
+	}
+}
+
+325 
+__le
+ 
+
+326 
+	$cnkey_t_addr
+(
+f_cnkey_t
+ *
+key
+, c 
+f_addr_t
+ *
+ddr
+, c 
+di
+)
+
+328 c 
+u_t
+ 
+
+ = 
+key
+->
+ck_key
+[0] & 0xffff;
+
+329 
+ut32_t
+ *
+addr
+ = &
+key
+->
+ck_key
+[2 + ((
+
+ >> 2* 
+di
+)];
+
+331 
+	`KASSERT
+(
+
+ > 0);
+
+332 
+	`memy
+(
+addr
+, 
+ddr
+, 
+
+);
+
+333 
+	}
+}
+
+335 
+__le
+ 
+
+336 
+	$cnkey_t_id
+(
+f_cnkey_t
+ *
+key
+, c 
+ut16_t
+ 
+id
+, c 
+di
+)
+
+338 c 
+ut32_t
+ 
+oid
+ = 
+key
+->
+ck_key
+[1];
+
+339 c 
+u_t
+ 
+shi
+ = 16 * !
+di
+;
+
+340 c 
+ut32_t
+ 
+mask
+ = 0xffff0000 >> 
+shi
+;
+
+342 
+key
+->
+ck_key
+[1] = ((
+ut32_t
+)
+id
+ << 
+shi
+| (
+oid
+ & 
+mask
+);
+
+343 
+	}
+}
+
+350 
+f_cn_t
+ *
+
+351 
+	$f_cn_lookup
+(c 
+f_che_t
+ *
+c
+, c 
+di
+, 
+bo
+ *
+fw
+)
+
+353 c 
+nbuf_t
+ *
+nbuf
+ = 
+c
+->
+c_nbuf
+;
+
+354 
+f_cn_t
+ *
+c
+;
+
+355 
+f_cnkey_t
+ 
+key
+;
+
+356 
+u_t
+ 
+ags
+, 
+cifid
+;
+
+357 
+bo
+ 
+ok
+, 
+pfw
+;
+
+360 i(!
+	`f_cn_ckey
+(
+c
+, &
+key
+, 
+ue
+)) {
+
+361  
+NULL
+;
+
+363 
+c
+ = 
+	`f_cndb_lookup
+(
+cn_db
+, &
+key
+, 
+fw
+);
+
+364 i(
+c
+ =
+NULL
+) {
+
+365  
+NULL
+;
+
+367 
+	`KASSERT
+(
+c
+->
+c_o
+ =
+c
+->
+c_o
+);
+
+370 
+ags
+ = 
+c
+->
+c_ags
+;
+
+371 
+ok
+ = (
+ags
+ & (
+CONN_ACTIVE
+ | 
+CONN_EXPIRE
+)) == CONN_ACTIVE;
+
+372 i(
+	`__edi_l
+(!
+ok
+)) {
+
+373 
+	`omic_dec_ut
+(&
+c
+->
+c_ft
+);
+
+374  
+NULL
+;
+
+381 
+cifid
+ = 
+c
+->
+c_ifid
+;
+
+382 i(
+	`__edi_l
+(
+cifid
+ && cifid !
+nbuf
+->
+nb_ifid
+)) {
+
+383 
+	`omic_dec_ut
+(&
+c
+->
+c_ft
+);
+
+384  
+NULL
+;
+
+386 
+pfw
+ = (
+ags
+ & 
+PFIL_ALL
+=
+di
+;
+
+387 i(
+	`__edi_l
+(*
+fw
+ !
+pfw
+)) {
+
+388 
+	`omic_dec_ut
+(&
+c
+->
+c_ft
+);
+
+389  
+NULL
+;
+
+393 
+	`gnouime
+(&
+c
+->
+c_ime
+);
+
+394  
+c
+;
+
+395 
+	}
+}
+
+402 
+f_cn_t
+ *
+
+403 
+	$f_cn_e
+(
+f_che_t
+ *
+c
+, c 
+di
+, *
+r
+)
+
+405 
+nbuf_t
+ *
+nbuf
+ = 
+c
+->
+c_nbuf
+;
+
+406 
+f_cn_t
+ *
+c
+;
+
+407 
+bo
+ 
+fw
+, 
+ok
+;
+
+409 
+	`KASSERT
+(!
+	`nbuf_ag_p
+(
+nbuf
+, 
+NBUF_DATAREF_RESET
+));
+
+410 i(!
+	`f_cn_ackab_p
+(
+c
+)) {
+
+411  
+NULL
+;
+
+415 i((
+c
+ = 
+	`f_g_cn
+(
+c
+, 
+di
+)!
+NULL
+) {
+
+417  
+c
+;
+
+419 i(
+	`nbuf_hd_mbuf
+(
+nbuf
+=
+NULL
+) {
+
+420 *
+r
+ = 
+ENOMEM
+;
+
+421  
+NULL
+;
+
+423 
+	`KASSERT
+(!
+	`nbuf_ag_p
+(
+nbuf
+, 
+NBUF_DATAREF_RESET
+));
+
+426 i((
+c
+ = 
+	`f_cn_lookup
+(
+c
+, 
+di
+, &
+fw
+)=
+NULL
+) {
+
+427  
+NULL
+;
+
+431 
+	`mux_r
+(&
+c
+->
+c_lock
+);
+
+432 
+ok
+ = 
+	`f_e_e
+(
+c
+, &
+c
+->
+c_e
+, 
+fw
+);
+
+433 
+	`mux_ex
+(&
+c
+->
+c_lock
+);
+
+435 i(
+	`__edi_l
+(!
+ok
+)) {
+
+437 
+	`f_cn_a
+(
+c
+);
+
+438 
+	`f_s_c
+(
+NPF_STAT_INVALID_STATE
+);
+
+439 
+c
+ = 
+NULL
+;
+
+441  
+c
+;
+
+442 
+	}
+}
+
+450 
+f_cn_t
+ *
+
+451 
+	$f_cn_eablish
+(
+f_che_t
+ *
+c
+, 
+di
+, 
+bo
+ 
+r_if
+)
+
+453 c 
+nbuf_t
+ *
+nbuf
+ = 
+c
+->
+c_nbuf
+;
+
+454 
+f_cn_t
+ *
+c
+;
+
+455 
+r
+ = 0;
+
+457 
+	`KASSERT
+(!
+	`nbuf_ag_p
+(
+nbuf
+, 
+NBUF_DATAREF_RESET
+));
+
+459 i(!
+	`f_cn_ackab_p
+(
+c
+)) {
+
+460  
+NULL
+;
+
+464 
+c
+ = 
+	`po_che_g
+(
+cn_che
+, 
+PR_NOWAIT
+);
+
+465 i(
+	`__edi_l
+(!
+c
+)) {
+
+466  
+NULL
+;
+
+468 
+	`NPF_PRINTF
+(("NPF: cc%p\n", 
+c
+));
+
+469 
+	`f_s_c
+(
+NPF_STAT_CONN_CREATE
+);
+
+471 
+	`mux_
+(&
+c
+->
+c_lock
+, 
+MUTEX_DEFAULT
+, 
+IPL_SOFTNET
+);
+
+472 
+c
+->
+c_ags
+ = (
+di
+ & 
+PFIL_ALL
+);
+
+473 
+c
+->
+c_ft
+ = 0;
+
+474 
+c
+->
+c_roc
+ = 
+NULL
+;
+
+475 
+c
+->
+c_t
+ = 
+NULL
+;
+
+478 i(!
+	`f_e_
+(
+c
+, &
+c
+->
+c_e
+)) {
+
+479 
+	`f_cn_deroy
+(
+c
+);
+
+480  
+NULL
+;
+
+483 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_IP46
+));
+
+484 
+f_cnkey_t
+ *
+fw
+ = &
+c
+->
+c_fw_y
+;
+
+485 
+f_cnkey_t
+ *
+bk
+ = &
+c
+->
+c_back_y
+;
+
+491 i(!
+	`f_cn_ckey
+(
+c
+, 
+fw
+, 
+ue
+) ||
+
+492 !
+	`f_cn_ckey
+(
+c
+, 
+bk
+, 
+l
+)) {
+
+493 
+	`f_cn_deroy
+(
+c
+);
+
+494  
+NULL
+;
+
+496 
+fw
+->
+ck_backr
+ = 
+bk
+->ck_back
+c
+;
+
+497 
+c
+->
+c_ifid
+ = 
+r_if
+ ? 
+nbuf
+->
+nb_ifid
+ : 0;
+
+498 
+c
+->
+c_o
+ = 
+c
+->
+c_o
+;
+
+504 
+	`gnouime
+(&
+c
+->
+c_ime
+);
+
+505 
+c
+->
+c_ft
+ = 1;
+
+512 
+	`mux_r
+(&
+c
+->
+c_lock
+);
+
+513 i(!
+	`f_cndb_
+(
+cn_db
+, 
+fw
+, 
+c
+)) {
+
+514 
+r
+ = 
+EISCONN
+;
+
+515 
+r
+;
+
+517 i(!
+	`f_cndb_
+(
+cn_db
+, 
+bk
+, 
+c
+)) {
+
+518 
+f_cn_t
+ *
+t
+ 
+__dgud
+;
+
+519 
+t
+ = 
+	`f_cndb_move
+(
+cn_db
+, 
+fw
+);
+
+520 
+	`KASSERT
+(
+t
+ =
+c
+);
+
+521 
+r
+ = 
+EISCONN
+;
+
+522 
+r
+;
+
+524 
+r
+:
+
+530 i(
+r
+) {
+
+531 
+	`omic__ut
+(&
+c
+->
+c_ags
+, 
+CONN_REMOVED
+ | 
+CONN_EXPIRE
+);
+
+532 
+	`omic_dec_ut
+(&
+c
+->
+c_ft
+);
+
+533 
+	`f_s_c
+(
+NPF_STAT_RACE_CONN
+);
+
+535 
+	`NPF_PRINTF
+(("NPF:ablish c%p\n", 
+c
+));
+
+539 
+	`f_cndb_queue
+(
+cn_db
+, 
+c
+);
+
+540 
+	`mux_ex
+(&
+c
+->
+c_lock
+);
+
+542  
+r
+ ? 
+NULL
+ : 
+c
+;
+
+543 
+	}
+}
+
+546 
+	$f_cn_deroy
+(
+f_cn_t
+ *
+c
+)
+
+548 
+	`KASSERT
+(
+c
+->
+c_ft
+ == 0);
+
+550 i(
+c
+->
+c_t
+) {
+
+552 
+	`f_t_deroy
+(
+c
+->
+c_t
+);
+
+554 i(
+c
+->
+c_roc
+) {
+
+556 
+	`f_roc_a
+(
+c
+->
+c_roc
+);
+
+560 
+	`f_e_deroy
+(&
+c
+->
+c_e
+);
+
+561 
+	`mux_deroy
+(&
+c
+->
+c_lock
+);
+
+564 
+	`po_che_put
+(
+cn_che
+, 
+c
+);
+
+565 
+	`f_s_c
+(
+NPF_STAT_CONN_DESTROY
+);
+
+566 
+	`NPF_PRINTF
+(("NPF: c%deroyed\n", 
+c
+));
+
+567 
+	}
+}
+
+576 
+	$f_cn_
+(c 
+f_che_t
+ *
+c
+, 
+f_cn_t
+ *
+c
+,
+
+577 
+f_t_t
+ *
+
+, 
+u_t
+ 
+y
+)
+
+579 c 
+u_t
+ 
+t_ty_dim
+[] = {
+
+580 [
+NPF_NATOUT
+] = 
+NPF_DST
+,
+
+581 [
+NPF_NATIN
+] = 
+NPF_SRC
+,
+
+583 
+f_cnkey_t
+ 
+key
+, *
+bk
+;
+
+584 
+f_cn_t
+ *
+t
+ 
+__dgud
+;
+
+585 
+f_addr_t
+ *
+ddr
+;
+
+586 
+_pt_t
+ 
+t
+;
+
+587 
+u_t
+ 
+tidx
+;
+
+589 
+	`KASSERT
+(
+c
+->
+c_ft
+ > 0);
+
+591 
+	`f_t_gs
+(
+
+, &
+ddr
+, &
+t
+);
+
+592 
+	`KASSERT
+(
+y
+ =
+NPF_NATOUT
+ ||ty =
+NPF_NATIN
+);
+
+593 
+tidx
+ = 
+t_ty_dim
+[
+y
+];
+
+596 i(!
+	`f_cn_ckey
+(
+c
+, &
+key
+, 
+l
+)) {
+
+597  
+EINVAL
+;
+
+601 
+	`mux_r
+(&
+c
+->
+c_lock
+);
+
+602 i(
+	`__edi_l
+(
+c
+->
+c_ags
+ & 
+CONN_EXPIRE
+)) {
+
+604 
+	`mux_ex
+(&
+c
+->
+c_lock
+);
+
+605  
+EINVAL
+;
+
+607 
+	`KASSERT
+((
+c
+->
+c_ags
+ & 
+CONN_REMOVED
+) == 0);
+
+609 i(
+	`__edi_l
+(
+c
+->
+c_t
+ !
+NULL
+)) {
+
+611 
+	`mux_ex
+(&
+c
+->
+c_lock
+);
+
+612 
+	`f_s_c
+(
+NPF_STAT_RACE_NAT
+);
+
+613  
+EISCONN
+;
+
+617 
+t
+ = 
+	`f_cndb_move
+(
+cn_db
+, &
+c
+->
+c_back_y
+);
+
+618 
+	`KASSERT
+(
+t
+ =
+c
+);
+
+621 
+bk
+ = &
+c
+->
+c_back_y
+;
+
+622 
+	`cnkey_t_addr
+(
+bk
+, 
+ddr
+, 
+tidx
+);
+
+623 i(
+t
+) {
+
+624 
+	`cnkey_t_id
+(
+bk
+, 
+t
+, 
+tidx
+);
+
+628 i(!
+	`f_cndb_
+(
+cn_db
+, 
+bk
+, 
+c
+)) {
+
+633 
+t
+ = 
+	`f_cndb_move
+(
+cn_db
+, &
+c
+->
+c_fw_y
+);
+
+634 
+	`KASSERT
+(
+t
+ =
+c
+);
+
+636 
+	`omic__ut
+(&
+c
+->
+c_ags
+, 
+CONN_REMOVED
+ | 
+CONN_EXPIRE
+);
+
+637 
+	`mux_ex
+(&
+c
+->
+c_lock
+);
+
+639 
+	`f_s_c
+(
+NPF_STAT_RACE_NAT
+);
+
+640  
+EISCONN
+;
+
+644 
+c
+->
+c_t
+ = 
+
+;
+
+645 
+	`mux_ex
+(&
+c
+->
+c_lock
+);
+
+647 
+	}
+}
+
+653 
+	$f_cn_expe
+(
+f_cn_t
+ *
+c
+)
+
+656 
+	`omic__ut
+(&
+c
+->
+c_ags
+, 
+CONN_EXPIRE
+);
+
+657 
+	}
+}
+
+662 
+bo
+
+
+663 
+	$f_cn_ss
+(c 
+f_cn_t
+ *
+c
+, 
+f_roc_t
+ **
+
+)
+
+665 
+	`KASSERT
+(
+c
+->
+c_ft
+ > 0);
+
+666 i(
+	`__edi_ue
+(
+c
+->
+c_ags
+ & 
+CONN_PASS
+)) {
+
+667 *
+
+ = 
+c
+->
+c_roc
+;
+
+668  
+ue
+;
+
+670  
+l
+;
+
+671 
+	}
+}
+
+678 
+	$f_cn_ass
+(
+f_cn_t
+ *
+c
+, 
+f_roc_t
+ *
+
+)
+
+680 
+	`KASSERT
+((
+c
+->
+c_ags
+ & 
+CONN_ACTIVE
+) == 0);
+
+681 
+	`KASSERT
+(
+c
+->
+c_ft
+ > 0);
+
+682 
+	`KASSERT
+(
+c
+->
+c_roc
+ =
+NULL
+);
+
+689 
+	`omic__ut
+(&
+c
+->
+c_ags
+, 
+CONN_PASS
+);
+
+690 
+c
+->
+c_roc
+ = 
+
+;
+
+691 
+	}
+}
+
+698 
+	$f_cn_a
+(
+f_cn_t
+ *
+c
+)
+
+700 i((
+c
+->
+c_ags
+ & (
+CONN_ACTIVE
+ | 
+CONN_EXPIRE
+)) == 0) {
+
+702 
+	`omic__ut
+(&
+c
+->
+c_ags
+, 
+CONN_ACTIVE
+);
+
+704 
+	`KASSERT
+(
+c
+->
+c_ft
+ > 0);
+
+705 
+	`omic_dec_ut
+(&
+c
+->
+c_ft
+);
+
+706 
+	}
+}
+
+712 
+f_t_t
+ *
+
+713 
+	$f_cn_gt
+(
+f_cn_t
+ *
+c
+, c 
+di
+, 
+bo
+ *
+fw
+)
+
+715 
+	`KASSERT
+(
+c
+->
+c_ft
+ > 0);
+
+716 *
+fw
+ = (
+c
+->
+c_ags
+ & 
+PFIL_ALL
+=
+di
+;
+
+717  
+c
+->
+c_t
+;
+
+718 
+	}
+}
+
+723 
+le
+ 
+bo
+
+
+724 
+	$f_cn_exped
+(c 
+f_cn_t
+ *
+c
+, c 
+timeec
+ *
+tow
+)
+
+726 c 
+ime
+ = 
+	`f_e_ime
+(&
+c
+->
+c_e
+, c->
+c_o
+);
+
+727 
+timeec
+ 
+tsdiff
+;
+
+729 i(
+	`__edi_l
+(
+c
+->
+c_ags
+ & 
+CONN_EXPIRE
+)) {
+
+731  
+ue
+;
+
+733 
+	`timeecsub
+(
+tow
+, &
+c
+->
+c_ime
+, &
+tsdiff
+);
+
+734  
+tsdiff
+.
+tv_c
+ > 
+ime
+;
+
+735 
+	}
+}
+
+745 
+	$f_cn_gc
+(
+f_cndb_t
+ *
+cd
+, 
+bo
+ 
+ush
+, bo 
+sync
+)
+
+747 
+f_cn_t
+ *
+c
+, *
+ev
+, *
+gi
+ = 
+NULL
+;
+
+748 
+timeec
+ 
+tow
+;
+
+750 
+	`gnouime
+(&
+tow
+);
+
+755 
+ev
+ = 
+NULL
+;
+
+756 
+c
+ = 
+	`f_cndb_gli
+(
+cd
+);
+
+757 
+c
+) {
+
+758 
+f_cn_t
+ *
+xt
+ = 
+c
+->
+c_xt
+;
+
+761 i(!
+	`f_cn_exped
+(
+c
+, &
+tow
+&& !
+ush
+) {
+
+762 
+ev
+ = 
+c
+;
+
+763 
+c
+ = 
+xt
+;
+
+768 
+	`mux_r
+(&
+c
+->
+c_lock
+);
+
+769 i((
+c
+->
+c_ags
+ & 
+CONN_REMOVED
+) == 0) {
+
+770 
+f_cn_t
+ *
+t
+ 
+__dgud
+;
+
+772 
+t
+ = 
+	`f_cndb_move
+(
+cd
+, &
+c
+->
+c_fw_y
+);
+
+773 
+	`KASSERT
+(
+t
+ =
+c
+);
+
+774 
+t
+ = 
+	`f_cndb_move
+(
+cd
+, &
+c
+->
+c_back_y
+);
+
+775 
+	`KASSERT
+(
+t
+ =
+c
+);
+
+779 
+	`omic__ut
+(&
+c
+->
+c_ags
+, 
+CONN_REMOVED
+ | 
+CONN_EXPIRE
+);
+
+780 
+	`mux_ex
+(&
+c
+->
+c_lock
+);
+
+783 
+	`f_cndb_dequeue
+(
+cd
+, 
+c
+, 
+ev
+);
+
+784 
+c
+->
+c_xt
+ = 
+gi
+;
+
+785 
+gi
+ = 
+c
+;
+
+788 
+c
+ = 
+xt
+;
+
+790 
+	`f_cndb_a
+(
+cd
+, 
+ev
+);
+
+796 i(
+sync
+) {
+
+797 
+	`mux_ex
+(&
+cn_lock
+);
+
+798 i(
+gi
+) {
+
+799 
+	`f_cfig_r
+();
+
+800 
+	`f_cfig_sync
+();
+
+801 
+	`f_cfig_ex
+();
+
+809 
+c
+ = 
+gi
+;
+
+810 
+c
+) {
+
+811 
+f_cn_t
+ *
+xt
+ = 
+c
+->
+c_xt
+;
+
+817 i(
+	`__edi_l
+(
+c
+->
+c_ft
+)) {
+
+818 
+	`ku
+("fcgc", 
+l
+, 1, 
+NULL
+);
+
+821 
+	`f_cn_deroy
+(
+c
+);
+
+822 
+c
+ = 
+xt
+;
+
+824 
+	}
+}
+
+830 
+	$f_cn_wk
+()
+
+832 
+	`mux_r
+(&
+cn_lock
+);
+
+834 
+	`f_cn_gc
+(
+cn_db
+, 
+l
+, 
+ue
+);
+
+835 
+	}
+}
+
+842 
+	$f_cndb_expt
+(
+_y_t
+ 
+cli
+)
+
+844 
+f_cn_t
+ *
+c
+, *
+ev
+;
+
+850 
+	`mux_r
+(&
+cn_lock
+);
+
+851 i(
+cn_ackg
+ !
+CONN_TRACKING_ON
+) {
+
+852 
+	`mux_ex
+(&
+cn_lock
+);
+
+855 
+ev
+ = 
+NULL
+;
+
+856 
+c
+ = 
+	`f_cndb_gli
+(
+cn_db
+);
+
+857 
+c
+) {
+
+858 
+f_cn_t
+ *
+xt
+ = 
+c
+->
+c_xt
+;
+
+859 
+_diiy_t
+ 
+cdi
+;
+
+861 i((
+cdi
+ = 
+	`f_cn_expt
+(
+c
+)!
+NULL
+) {
+
+862 
+	`_y_add
+(
+cli
+, 
+cdi
+);
+
+863 
+	`_obje_a
+(
+cdi
+);
+
+865 
+ev
+ = 
+c
+;
+
+866 
+c
+ = 
+xt
+;
+
+868 
+	`f_cndb_a
+(
+cn_db
+, 
+ev
+);
+
+869 
+	`mux_ex
+(&
+cn_lock
+);
+
+871 
+	}
+}
+
+876 
+_diiy_t
+
+
+877 
+	$f_cn_expt
+(c 
+f_cn_t
+ *
+c
+)
+
+879 
+_diiy_t
+ 
+cdi
+;
+
+880 
+_da_t
+ 
+d
+;
+
+882 i((
+c
+->
+c_ags
+ & (
+CONN_ACTIVE
+|
+CONN_EXPIRE
+)) != CONN_ACTIVE) {
+
+883  
+NULL
+;
+
+885 
+cdi
+ = 
+	`_diiy_
+();
+
+886 
+	`_diiy_t_ut32
+(
+cdi
+, "ags", 
+c
+->
+c_ags
+);
+
+887 
+	`_diiy_t_ut32
+(
+cdi
+, "o", 
+c
+->
+c_o
+);
+
+888 i(
+c
+->
+c_ifid
+) {
+
+889 c *
+iame
+ = 
+	`f_ifm_gme
+(
+c
+->
+c_ifid
+);
+
+890 
+	`_diiy_t_crg
+(
+cdi
+, "iame", 
+iame
+);
+
+893 
+d
+ = 
+	`_da__da
+(&
+c
+->
+c_e
+, (
+f_e_t
+));
+
+894 
+	`_diiy_t_d_l
+(
+cdi
+, "e", 
+d
+);
+
+896 c 
+ut32_t
+ *
+fkey
+ = 
+c
+->
+c_fw_y
+.
+ck_key
+;
+
+897 
+d
+ = 
+	`_da__da
+(
+fkey
+, 
+NPF_CONN_MAXKEYLEN
+);
+
+898 
+	`_diiy_t_d_l
+(
+cdi
+, "fw-key", 
+d
+);
+
+900 c 
+ut32_t
+ *
+bkey
+ = 
+c
+->
+c_back_y
+.
+ck_key
+;
+
+901 
+d
+ = 
+	`_da__da
+(
+bkey
+, 
+NPF_CONN_MAXKEYLEN
+);
+
+902 
+	`_diiy_t_d_l
+(
+cdi
+, "back-key", 
+d
+);
+
+904 i(
+c
+->
+c_t
+) {
+
+905 
+	`f_t_expt
+(
+cdi
+, 
+c
+->
+c_t
+);
+
+907  
+cdi
+;
+
+908 
+	}
+}
+
+915 
+	$f_cn_impt
+(
+f_cndb_t
+ *
+cd
+, 
+_diiy_t
+ 
+cdi
+,
+
+916 
+f_rut_t
+ *
+i
+)
+
+918 
+f_cn_t
+ *
+c
+;
+
+919 
+f_cnkey_t
+ *
+fw
+, *
+bk
+;
+
+920 
+_obje_t
+ 
+obj
+;
+
+921 c *
+iame
+;
+
+922 c *
+d
+;
+
+925 
+c
+ = 
+	`po_che_g
+(
+cn_che
+, 
+PR_WAITOK
+);
+
+926 
+	`memt
+(
+c
+, 0, (
+f_cn_t
+));
+
+927 
+	`mux_
+(&
+c
+->
+c_lock
+, 
+MUTEX_DEFAULT
+, 
+IPL_SOFTNET
+);
+
+928 
+	`f_s_c
+(
+NPF_STAT_CONN_CREATE
+);
+
+930 
+	`_diiy_g_ut32
+(
+cdi
+, "o", &
+c
+->
+c_o
+);
+
+931 
+	`_diiy_g_ut32
+(
+cdi
+, "ags", &
+c
+->
+c_ags
+);
+
+932 
+c
+->
+c_ags
+ &
+PFIL_ALL
+ | 
+CONN_ACTIVE
+ | 
+CONN_PASS
+;
+
+933 
+	`gnouime
+(&
+c
+->
+c_ime
+);
+
+935 i(
+	`_diiy_g_crg_nocy
+(
+cdi
+, "iame", &
+iame
+) &&
+
+936 (
+c
+->
+c_ifid
+ = 
+	`f_ifm_gi
+(
+iame
+)) == 0) {
+
+937 
+r
+;
+
+940 
+obj
+ = 
+	`_diiy_g
+(
+cdi
+, "state");
+
+941 i((
+d
+ = 
+	`_da_da_nocy
+(
+obj
+)=
+NULL
+ ||
+
+942 
+	`_da_size
+(
+obj
+!(
+f_e_t
+)) {
+
+943 
+r
+;
+
+945 
+	`memy
+(&
+c
+->
+c_e
+, 
+d
+, (
+f_e_t
+));
+
+948 i((
+obj
+ = 
+	`_diiy_g
+(
+cdi
+, "t")!
+NULL
+ &&
+
+949 (
+c
+->
+c_t
+ = 
+	`f_t_impt
+(
+obj
+, 
+i
+, c)=
+NULL
+) {
+
+950 
+r
+;
+
+956 
+obj
+ = 
+	`_diiy_g
+(
+cdi
+, "forw-key");
+
+957 i((
+d
+ = 
+	`_da_da_nocy
+(
+obj
+)=
+NULL
+ ||
+
+958 
+	`_da_size
+(
+obj
+!
+NPF_CONN_MAXKEYLEN
+) {
+
+959 
+r
+;
+
+961 
+fw
+ = &
+c
+->
+c_fw_y
+;
+
+962 
+	`memy
+(&
+fw
+->
+ck_key
+, 
+d
+, 
+NPF_CONN_MAXKEYLEN
+);
+
+964 
+obj
+ = 
+	`_diiy_g
+(
+cdi
+, "back-key");
+
+965 i((
+d
+ = 
+	`_da_da_nocy
+(
+obj
+)=
+NULL
+ ||
+
+966 
+	`_da_size
+(
+obj
+!
+NPF_CONN_MAXKEYLEN
+) {
+
+967 
+r
+;
+
+969 
+bk
+ = &
+c
+->
+c_back_y
+;
+
+970 
+	`memy
+(&
+bk
+->
+ck_key
+, 
+d
+, 
+NPF_CONN_MAXKEYLEN
+);
+
+972 
+fw
+->
+ck_backr
+ = 
+bk
+->ck_back
+c
+;
+
+975 i(!
+	`f_cndb_
+(
+cd
+, 
+fw
+, 
+c
+)) {
+
+976 
+r
+;
+
+978 i(!
+	`f_cndb_
+(
+cd
+, 
+bk
+, 
+c
+)) {
+
+979 
+	`f_cndb_move
+(
+cd
+, 
+fw
+);
+
+980 
+r
+;
+
+983 
+	`NPF_PRINTF
+(("NPF: impd c%p\n", 
+c
+));
+
+984 
+	`f_cndb_queue
+(
+cd
+, 
+c
+);
+
+986 
+r
+:
+
+987 
+	`f_cn_deroy
+(
+c
+);
+
+988  
+EINVAL
+;
+
+989 
+	}
+}
+
+991 #i
+defed
+(
+DDB
+|| defed(
+_NPF_TESTING
+)
+
+994 
+	$f_cn_t
+(c 
+f_cn_t
+ *
+c
+)
+
+996 c 
+u_t
+ 
+
+ = 
+	`NPF_CONN_GETALEN
+(&
+c
+->
+c_fw_y
+);
+
+997 c 
+ut32_t
+ *
+fkey
+ = 
+c
+->
+c_fw_y
+.
+ck_key
+;
+
+998 c 
+ut32_t
+ *
+bkey
+ = 
+c
+->
+c_back_y
+.
+ck_key
+;
+
+999 c 
+u_t
+ 
+o
+ = 
+c
+->
+c_o
+;
+
+1000 
+timeec
+ 
+tow
+, 
+tsdiff
+;
+
+1001 c *
+c
+, *
+d
+;
+
+1002 
+ime
+;
+
+1004 
+	`gnouime
+(&
+tow
+);
+
+1005 
+	`timeecsub
+(&
+tow
+, &
+c
+->
+c_ime
+, &
+tsdiff
+);
+
+1006 
+ime
+ = 
+	`f_e_ime
+(&
+c
+->
+c_e
+, 
+o
+);
+
+1008 
+	`tf
+("%p:\n\tproto %d flags 0x%xsdiff %dtime %d\n",
+
+1009 
+c
+, 
+o
+, c->
+c_ags
+, ()
+tsdiff
+.
+tv_c
+, 
+ime
+);
+
+1011 
+c
+ = &
+fkey
+[2], 
+d
+ = &fkey[2 + (
+
+ >> 2)];
+
+1012 
+	`tf
+("\tfw %s:%d", 
+	`f_addr_dump
+(
+c
+, 
+
+), 
+	`ohs
+(
+fkey
+[1] >> 16));
+
+1013 
+	`tf
+("-> %s:%d\n", 
+	`f_addr_dump
+(
+d
+, 
+
+), 
+	`ohs
+(
+fkey
+[1] & 0xffff));
+
+1015 
+c
+ = &
+bkey
+[2], 
+d
+ = &bkey[2 + (
+
+ >> 2)];
+
+1016 
+	`tf
+("\tback %s:%d", 
+	`f_addr_dump
+(
+c
+, 
+
+), 
+	`ohs
+(
+bkey
+[1] >> 16));
+
+1017 
+	`tf
+("-> %s:%d\n", 
+	`f_addr_dump
+(
+d
+, 
+
+), 
+	`ohs
+(
+bkey
+[1] & 0xffff));
+
+1019 
+	`f_e_dump
+(&
+c
+->
+c_e
+);
+
+1020 i(
+c
+->
+c_t
+) {
+
+1021 
+	`f_t_dump
+(
+c
+->
+c_t
+);
+
+1023 
+	}
+}
+
+	@npf/npf_conn.h
+
+32 #ide
+_NPF_CONN_H_
+
+
+33 
+	#_NPF_CONN_H_
+
+
+	)
+
+35 #i!
+defed
+(
+_KERNEL
+)
+
+39 
+	~<sys/tys.h
+>
+
+41 
+	~"f_im.h
+"
+
+43 
+f_cnkey
+ 
+	tf_cnkey_t
+;
+
+45 #i
+defed
+(
+__NPF_CONN_PRIVATE
+)
+
+47 
+	~<sys/rb.h
+>
+
+52 
+	#NPF_CONN_NKEYWORDS
+ (2 + (((
+f_addr_t
+* 2>> 2))
+
+	)
+
+53 
+	#NPF_CONN_MAXKEYLEN
+ (
+NPF_CONN_NKEYWORDS
+ * (
+ut32_t
+))
+
+	)
+
+54 
+	#NPF_CONN_GETALEN
+(
+key
+((key)->
+ck_key
+[0] & 0xffff)
+
+	)
+
+55 
+	#NPF_CONN_KEYLEN
+(
+key
+(8 + (2 * 
+	`NPF_CONN_GETALEN
+(key)))
+
+	)
+
+57 
+	sf_cnkey
+ {
+
+59 
+rb_node_t
+ 
+	mck_rbnode
+;
+
+60 
+ut32_t
+ 
+	mck_key
+[
+NPF_CONN_NKEYWORDS
+];
+
+61 
+f_cn_t
+ * 
+	mck_backr
+;
+
+68 
+	sf_cn
+ {
+
+73 
+f_cnkey_t
+ 
+	mc_fw_y
+;
+
+74 
+f_cnkey_t
+ 
+	mc_back_y
+;
+
+75 
+u_t
+ 
+	mc_o
+;
+
+76 
+u_t
+ 
+	mc_ifid
+;
+
+79 
+u_t
+ 
+	mc_ags
+;
+
+80 
+f_cn_t
+ * 
+	mc_xt
+;
+
+83 
+f_roc_t
+ * 
+	mc_roc
+;
+
+84 
+f_t_t
+ * 
+	mc_t
+;
+
+90 
+kmux_t
+ 
+	mc_lock
+;
+
+91 
+f_e_t
+ 
+	mc_e
+;
+
+92 
+u_t
+ 
+	mc_ft
+;
+
+93 
+timeec
+ 
+	mc_ime
+;
+
+101 
+f_cn_sys
+();
+
+102 
+f_cn_sysfi
+();
+
+103 
+f_cn_ackg
+(
+bo
+);
+
+104 
+f_cn_ld
+(
+f_cndb_t
+ *, 
+bo
+);
+
+106 
+f_cn_ckey
+(c 
+f_che_t
+ *, 
+f_cnkey_t
+ *, 
+bo
+);
+
+107 
+f_cn_t
+ * 
+f_cn_lookup
+(c 
+f_che_t
+ *, c , 
+bo
+ *);
+
+108 
+f_cn_t
+ * 
+f_cn_e
+(
+f_che_t
+ *, const , *);
+
+109 
+f_cn_t
+ * 
+f_cn_eablish
+(
+f_che_t
+ *, , 
+bo
+);
+
+110 
+f_cn_a
+(
+f_cn_t
+ *);
+
+111 
+f_cn_expe
+(
+f_cn_t
+ *);
+
+112 
+bo
+ 
+f_cn_ss
+(c 
+f_cn_t
+ *, 
+f_roc_t
+ **);
+
+113 
+f_cn_ass
+(
+f_cn_t
+ *, 
+f_roc_t
+ *);
+
+114 
+f_cn_
+(c 
+f_che_t
+ *, 
+f_cn_t
+ *,
+
+115 
+f_t_t
+ *, 
+u_t
+);
+
+116 
+f_t_t
+ * 
+f_cn_gt
+(
+f_cn_t
+ *, c , 
+bo
+ *);
+
+117 
+f_cn_gc
+(
+f_cndb_t
+ *, 
+bo
+, bool);
+
+118 
+f_cn_impt
+(
+f_cndb_t
+ *, 
+_diiy_t
+,
+
+119 
+f_rut_t
+ *);
+
+120 
+_diiy_t
+ 
+f_cn_expt
+(c 
+f_cn_t
+ *);
+
+121 
+f_cn_t
+(c 
+f_cn_t
+ *);
+
+126 
+f_cndb_t
+ * 
+f_cndb_
+();
+
+127 
+f_cndb_deroy
+(
+f_cndb_t
+ *);
+
+129 
+f_cn_t
+ * 
+f_cndb_lookup
+(
+f_cndb_t
+ *, c 
+f_cnkey_t
+ *,
+
+130 
+bo
+ *);
+
+131 
+bo
+ 
+f_cndb_
+(
+f_cndb_t
+ *, 
+f_cnkey_t
+ *,
+
+132 
+f_cn_t
+ *);
+
+133 
+f_cn_t
+ * 
+f_cndb_move
+(
+f_cndb_t
+ *, c 
+f_cnkey_t
+ *);
+
+135 
+f_cndb_queue
+(
+f_cndb_t
+ *, 
+f_cn_t
+ *);
+
+136 
+f_cndb_dequeue
+(
+f_cndb_t
+ *, 
+f_cn_t
+ *,
+
+137 
+f_cn_t
+ *);
+
+138 
+f_cn_t
+ * 
+f_cndb_gli
+(
+f_cndb_t
+ *);
+
+139 
+f_cndb_a
+(
+f_cndb_t
+ *, 
+f_cn_t
+ *);
+
+140 
+f_cndb_expt
+(
+_y_t
+);
+
+	@npf/npf_conndb.c
+
+36 
+	~<sys/cdefs.h
+>
+
+37 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_conndb.c,v 1.2 2014/07/23 01:25:34mind Exp $");
+
+39 
+	~<sys/m.h
+>
+
+40 
+	~<sys/tys.h
+>
+
+42 
+	~<sys/omic.h
+>
+
+43 
+	~<sys/g.h
+>
+
+44 
+	~<sys/hash.h
+>
+
+45 
+	~<sys/kmem.h
+>
+
+47 
+	#__NPF_CONN_PRIVATE
+
+
+	)
+
+48 
+	~"f_cn.h
+"
+
+49 
+	~"f_im.h
+"
+
+51 
+	#CONNDB_HASH_BUCKETS
+ 1024
+
+	)
+
+52 
+	#CONNDB_HASH_MASK
+ (
+CONNDB_HASH_BUCKETS
+ - 1)
+
+	)
+
+55 
+rb__t
+ 
+	mhb_
+;
+
+56 
+krwlock_t
+ 
+	mhb_lock
+;
+
+57 
+u_t
+ 
+	mhb_cou
+;
+
+58 } 
+	tf_hashbuck_t
+;
+
+60 
+	sf_cndb
+ {
+
+61 
+f_cn_t
+ * 
+	mcd_
+;
+
+62 
+f_cn_t
+ * 
+	mcd_li
+;
+
+63 
+f_cn_t
+ * 
+	mcd_
+;
+
+64 
+ut32_t
+ 
+	mcd_ed
+;
+
+65 
+f_hashbuck_t
+ 
+	mcd_hashtbl
+[];
+
+74 
+	$cndb_rb_cmp_nodes
+(*
+x
+, c *
+n1
+, c *
+n2
+)
+
+76 c 
+f_cnkey_t
+ * c 
+ck1
+ = 
+n1
+;
+
+77 c 
+f_cnkey_t
+ * c 
+ck2
+ = 
+n2
+;
+
+78 c 
+u_t
+ 
+keyn
+ = 
+	`MIN
+(
+	`NPF_CONN_KEYLEN
+(
+ck1
+), NPF_CONN_KEYLEN(
+ck2
+));
+
+80 
+	`KASSERT
+((
+keyn
+ >> 2<
+NPF_CONN_NKEYWORDS
+);
+
+81  
+	`memcmp
+(
+ck1
+->
+ck_key
+, 
+ck2
+->ck_key, 
+keyn
+);
+
+82 
+	}
+}
+
+85 
+	$cndb_rb_cmp_key
+(*
+x
+, c *
+n1
+, c *
+key
+)
+
+87 c 
+f_cnkey_t
+ * c 
+ck1
+ = 
+n1
+;
+
+88 c 
+f_cnkey_t
+ * c 
+ck2
+ = 
+key
+;
+
+89  
+	`cndb_rb_cmp_nodes
+(
+x
+, 
+ck1
+, 
+ck2
+);
+
+90 
+	}
+}
+
+92 c 
+rb__s_t
+ 
+	gcndb_rb_s
+ = {
+
+93 .
+rbto_com_nodes
+ = 
+cndb_rb_cmp_nodes
+,
+
+94 .
+	grbto_com_key
+ = 
+cndb_rb_cmp_key
+,
+
+95 .
+	grbto_node_offt
+ = 
+offtof
+(
+f_cnkey_t
+, 
+ck_rbnode
+),
+
+96 .
+	grbto_cxt
+ = 
+NULL
+
+
+99 
+f_hashbuck_t
+ *
+
+100 
+	$cndb_hash_buck
+(
+f_cndb_t
+ *
+cd
+, c 
+f_cnkey_t
+ *
+key
+)
+
+102 c 
+u_t
+ 
+keyn
+ = 
+	`NPF_CONN_KEYLEN
+(
+key
+);
+
+103 
+ut32_t
+ 
+hash
+ = 
+	`murmurhash2
+(
+key
+->
+ck_key
+, 
+keyn
+, 
+cd
+->
+cd_ed
+);
+
+104  &
+cd
+->
+cd_hashtbl
+[
+hash
+ & 
+CONNDB_HASH_MASK
+];
+
+105 
+	}
+}
+
+107 
+f_cndb_t
+ *
+
+108 
+	$f_cndb_
+()
+
+110 
+size_t
+ 
+n
+ = 
+	`offtof
+(
+f_cndb_t
+, 
+cd_hashtbl
+[
+CONNDB_HASH_BUCKETS
+]);
+
+111 
+f_cndb_t
+ *
+cd
+;
+
+113 
+cd
+ = 
+	`kmem_zloc
+(
+n
+, 
+KM_SLEEP
+);
+
+114 
+u_t
+ 
+i
+ = 0; i < 
+CONNDB_HASH_BUCKETS
+; i++) {
+
+115 
+f_hashbuck_t
+ *
+hb
+ = &
+cd
+->
+cd_hashtbl
+[
+i
+];
+
+117 
+	`rb__
+(&
+hb
+->
+hb_
+, &
+cndb_rb_s
+);
+
+118 
+	`rw_
+(&
+hb
+->
+hb_lock
+);
+
+119 
+hb
+->
+hb_cou
+ = 0;
+
+121 
+cd
+->
+cd_ed
+ = 
+	`g_32
+();
+
+122  
+cd
+;
+
+123 
+	}
+}
+
+126 
+	$f_cndb_deroy
+(
+f_cndb_t
+ *
+cd
+)
+
+128 
+size_t
+ 
+n
+ = 
+	`offtof
+(
+f_cndb_t
+, 
+cd_hashtbl
+[
+CONNDB_HASH_BUCKETS
+]);
+
+130 
+	`KASSERT
+(
+cd
+->
+cd_
+ =
+NULL
+);
+
+131 
+	`KASSERT
+(
+cd
+->
+cd_li
+ =
+NULL
+);
+
+132 
+	`KASSERT
+(
+cd
+->
+cd_
+ =
+NULL
+);
+
+134 
+u_t
+ 
+i
+ = 0; i < 
+CONNDB_HASH_BUCKETS
+; i++) {
+
+135 
+f_hashbuck_t
+ *
+hb
+ = &
+cd
+->
+cd_hashtbl
+[
+i
+];
+
+137 
+	`KASSERT
+(
+hb
+->
+hb_cou
+ == 0);
+
+138 
+	`KASSERT
+(!
+	`rb__e
+(&
+hb
+->
+hb_
+, 
+NULL
+, 
+RB_DIR_LEFT
+));
+
+139 
+	`rw_deroy
+(&
+hb
+->
+hb_lock
+);
+
+141 
+	`kmem_
+(
+cd
+, 
+n
+);
+
+142 
+	}
+}
+
+147 
+f_cn_t
+ *
+
+148 
+	$f_cndb_lookup
+(
+f_cndb_t
+ *
+cd
+, c 
+f_cnkey_t
+ *
+key
+, 
+bo
+ *
+fw
+)
+
+150 
+f_cnkey_t
+ *
+foundkey
+;
+
+151 
+f_hashbuck_t
+ *
+hb
+;
+
+152 
+f_cn_t
+ *
+c
+;
+
+155 
+hb
+ = 
+	`cndb_hash_buck
+(
+cd
+, 
+key
+);
+
+156 i(
+hb
+->
+hb_cou
+ == 0) {
+
+157  
+NULL
+;
+
+161 
+	`rw_r
+(&
+hb
+->
+hb_lock
+, 
+RW_READER
+);
+
+162 
+foundkey
+ = 
+	`rb__fd_node
+(&
+hb
+->
+hb_
+, 
+key
+);
+
+163 i(
+foundkey
+ =
+NULL
+) {
+
+164 
+	`rw_ex
+(&
+hb
+->
+hb_lock
+);
+
+165  
+NULL
+;
+
+167 
+c
+ = 
+foundkey
+->
+ck_backr
+;
+
+168 *
+fw
+ = (
+foundkey
+ =&
+c
+->
+c_fw_y
+);
+
+171 
+	`omic_c_ut
+(&
+c
+->
+c_ft
+);
+
+172 
+	`rw_ex
+(&
+hb
+->
+hb_lock
+);
+
+173  
+c
+;
+
+174 
+	}
+}
+
+179 
+bo
+
+
+180 
+	$f_cndb_
+(
+f_cndb_t
+ *
+cd
+, 
+f_cnkey_t
+ *
+key
+, 
+f_cn_t
+ *
+c
+)
+
+182 
+f_hashbuck_t
+ *
+hb
+ = 
+	`cndb_hash_buck
+(
+cd
+, 
+key
+);
+
+183 
+bo
+ 
+ok
+;
+
+185 
+	`rw_r
+(&
+hb
+->
+hb_lock
+, 
+RW_WRITER
+);
+
+186 
+ok
+ = 
+	`rb___node
+(&
+hb
+->
+hb_
+, 
+key
+) == key;
+
+187 
+hb
+->
+hb_cou
+ +(
+u_t
+)
+ok
+;
+
+188 
+	`rw_ex
+(&
+hb
+->
+hb_lock
+);
+
+189  
+ok
+;
+
+190 
+	}
+}
+
+196 
+f_cn_t
+ *
+
+197 
+	$f_cndb_move
+(
+f_cndb_t
+ *
+cd
+, c 
+f_cnkey_t
+ *
+key
+)
+
+199 
+f_hashbuck_t
+ *
+hb
+ = 
+	`cndb_hash_buck
+(
+cd
+, 
+key
+);
+
+200 
+f_cnkey_t
+ *
+foundkey
+;
+
+201 
+f_cn_t
+ *
+c
+;
+
+203 
+	`rw_r
+(&
+hb
+->
+hb_lock
+, 
+RW_WRITER
+);
+
+204 i((
+foundkey
+ = 
+	`rb__fd_node
+(&
+hb
+->
+hb_
+, 
+key
+)!
+NULL
+) {
+
+205 
+	`rb__move_node
+(&
+hb
+->
+hb_
+, 
+foundkey
+);
+
+206 
+c
+ = 
+foundkey
+->
+ck_backr
+;
+
+207 
+hb
+->
+hb_cou
+--;
+
+209 
+c
+ = 
+NULL
+;
+
+211 
+	`rw_ex
+(&
+hb
+->
+hb_lock
+);
+
+212  
+c
+;
+
+213 
+	}
+}
+
+220 
+	$f_cndb_queue
+(
+f_cndb_t
+ *
+cd
+, 
+f_cn_t
+ *
+c
+)
+
+222 
+f_cn_t
+ *
+hd
+;
+
+225 
+hd
+ = 
+cd
+->
+cd_
+;
+
+226 
+c
+->
+c_xt
+ = 
+hd
+;
+
+227 } 
+	`omic_s_r
+(&
+cd
+->
+cd_
+, 
+hd
+, 
+c
+) != head);
+
+228 
+	}
+}
+
+235 
+	$f_cndb_dequeue
+(
+f_cndb_t
+ *
+cd
+, 
+f_cn_t
+ *
+c
+,pf_cn_*
+ev
+)
+
+237 i(
+ev
+ =
+NULL
+) {
+
+238 
+	`KASSERT
+(
+cd
+->
+cd_li
+ =
+c
+);
+
+239 
+cd
+->
+cd_li
+ = 
+c
+->
+c_xt
+;
+
+241 
+ev
+->
+c_xt
+ = 
+c
+->c_next;
+
+243 
+	}
+}
+
+249 
+f_cn_t
+ *
+
+250 
+	$f_cndb_gli
+(
+f_cndb_t
+ *
+cd
+)
+
+252 
+f_cn_t
+ *
+c
+, *
+ev
+;
+
+254 
+c
+ = 
+	`omic_sw_r
+(&
+cd
+->
+cd_
+, 
+NULL
+);
+
+255 i((
+ev
+ = 
+cd
+->
+cd_
+=
+NULL
+) {
+
+256 
+	`KASSERT
+(
+cd
+->
+cd_li
+ =
+NULL
+);
+
+257 
+cd
+->
+cd_li
+ = 
+c
+;
+
+259 
+	`KASSERT
+(
+ev
+->
+c_xt
+ =
+NULL
+);
+
+260 
+ev
+->
+c_xt
+ = 
+c
+;
+
+262  
+cd
+->
+cd_li
+;
+
+263 
+	}
+}
+
+269 
+	$f_cndb_a
+(
+f_cndb_t
+ *
+cd
+, 
+f_cn_t
+ *
+c
+)
+
+271 
+	`KASSERT
+(
+c
+ || 
+cd
+->
+cd_li
+ =
+NULL
+);
+
+272 
+	`KASSERT
+(!
+c
+ || c->
+c_xt
+ =
+NULL
+);
+
+273 
+cd
+->
+cd_
+ = 
+c
+;
+
+274 
+	}
+}
+
+	@npf/npf_ctl.c
+
+39 
+	~<sys/cdefs.h
+>
+
+40 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_ctl.c,v 1.41 2015/03/20 23:36:28mind Exp $");
+
+42 
+	~<sys/m.h
+>
+
+43 
+	~<sys/cf.h
+>
+
+44 
+	~<sys/kmem.h
+>
+
+45 
+	~<t/bpf.h
+>
+
+47 
+	~</lib.h
+>
+
+49 
+	~"f_im.h
+"
+
+50 
+	~"f_cn.h
+"
+
+52 #i
+defed
+(
+DEBUG
+|| defed(
+DIAGNOSTIC
+)
+
+53 
+	#NPF_ERR_DEBUG
+(
+e
+) \
+
+54 
+	`_diiy_t_crg_nocy
+((
+e
+), "sour-fe", 
+__FILE__
+); \
+
+55 
+	`_diiy_t_ut32
+((
+e
+), "sour-le", 
+__LINE__
+);
+
+	)
+
+57 
+	#NPF_ERR_DEBUG
+(
+e
+)
+
+	)
+
+64 
+	$fl_swch
+(*
+da
+)
+
+66 c 
+bo
+ 
+off
+ = *(*)
+da
+ ? 
+ue
+ : 
+l
+;
+
+67 
+r
+;
+
+69 i(
+off
+) {
+
+71 
+r
+ = 
+	`f_pf_gi
+(
+l
+);
+
+74 
+	`f_pf_uegi
+(
+l
+);
+
+75 
+r
+ = 0;
+
+77  
+r
+;
+
+78 
+	}
+}
+
+80 
+__nole
+
+
+81 
+	$f_mk_b_s
+(
+f_b_t
+ *
+t
+, 
+_y_t
+ 
+s
+)
+
+83 
+_obje__t
+ 
+e
+;
+
+84 
+_diiy_t
+ 
+t
+;
+
+85 
+r
+ = 0;
+
+87 i(
+	`_obje_ty
+(
+s
+!
+PROP_TYPE_ARRAY
+) {
+
+88  
+EINVAL
+;
+
+90 
+e
+ = 
+	`_y_
+(
+s
+);
+
+91 (
+t
+ = 
+	`_obje__xt
+(
+e
+)!
+NULL
+) {
+
+92 c 
+f_addr_t
+ *
+addr
+;
+
+93 
+f_tmask_t
+ 
+mask
+;
+
+94 
+
+;
+
+97 
+_obje_t
+ 
+obj
+ = 
+	`_diiy_g
+(
+t
+, "addr");
+
+98 
+addr
+ = (c 
+f_addr_t
+ *)
+	`_da_da_nocy
+(
+obj
+);
+
+99 
+	`_diiy_g_ut8
+(
+t
+, "mask", &
+mask
+);
+
+100 
+
+ = 
+	`_da_size
+(
+obj
+);
+
+102 
+r
+ = 
+	`f_b_
+(
+t
+, 
+
+, 
+addr
+, 
+mask
+);
+
+103 i(
+r
+)
+
+106 
+	`_obje__a
+(
+e
+);
+
+107  
+r
+;
+
+108 
+	}
+}
+
+110 
+__nole
+
+
+111 
+	$f_mk_bs
+(
+f_bt_t
+ *
+tblt
+, 
+_y_t
+ 
+bs
+,
+
+112 
+_diiy_t
+ 
+rdi
+)
+
+114 
+_obje__t
+ 
+
+;
+
+115 
+_diiy_t
+ 
+tbldi
+;
+
+116 
+r
+ = 0;
+
+119 i(
+	`_obje_ty
+(
+bs
+!
+PROP_TYPE_ARRAY
+) {
+
+120 
+	`NPF_ERR_DEBUG
+(
+rdi
+);
+
+121  
+EINVAL
+;
+
+124 
+
+ = 
+	`_y_
+(
+bs
+);
+
+125 (
+tbldi
+ = 
+	`_obje__xt
+(
+
+)!
+NULL
+) {
+
+126 c *
+me
+;
+
+127 
+f_b_t
+ *
+t
+;
+
+128 
+u_t
+ 
+tid
+;
+
+129 
+ty
+;
+
+132 i(
+	`_obje_ty
+(
+tbldi
+!
+PROP_TYPE_DICTIONARY
+) {
+
+133 
+	`NPF_ERR_DEBUG
+(
+rdi
+);
+
+134 
+r
+ = 
+EINVAL
+;
+
+139 i(!
+	`_diiy_g_crg_nocy
+(
+tbldi
+, "me", &
+me
+)) {
+
+140 
+	`NPF_ERR_DEBUG
+(
+rdi
+);
+
+141 
+r
+ = 
+EINVAL
+;
+
+144 
+	`_diiy_g_ut32
+(
+tbldi
+, "id", &
+tid
+);
+
+145 
+	`_diiy_g_t32
+(
+tbldi
+, "ty", &
+ty
+);
+
+146 
+r
+ = 
+	`f_b_check
+(
+tblt
+, 
+me
+, 
+tid
+, 
+ty
+);
+
+147 i(
+r
+) {
+
+148 
+	`NPF_ERR_DEBUG
+(
+rdi
+);
+
+153 
+_y_t
+ 
+ts
+ = 
+	`_diiy_g
+(
+tbldi
+, "entries");
+
+154 
+_obje_t
+ 
+obj
+ = 
+	`_diiy_g
+(
+tbldi
+, "data");
+
+155 *
+blob
+ = 
+	`_da_da
+(
+obj
+);
+
+156 
+size_t
+ 
+size
+ = 
+	`_da_size
+(
+obj
+);
+
+158 i(
+ty
+ =
+NPF_TABLE_CDB
+ && (
+blob
+ =
+NULL
+ || 
+size
+ == 0)) {
+
+159 
+	`NPF_ERR_DEBUG
+(
+rdi
+);
+
+160 
+r
+ = 
+EINVAL
+;
+
+163 i(
+ty
+ =
+NPF_TABLE_HASH
+) {
+
+164 
+size
+ = 1024;
+
+168 
+t
+ = 
+	`f_b_
+(
+me
+, 
+tid
+, 
+ty
+, 
+blob
+, 
+size
+);
+
+169 i(
+t
+ =
+NULL
+) {
+
+170 
+	`NPF_ERR_DEBUG
+(
+rdi
+);
+
+171 
+r
+ = 
+ENOMEM
+;
+
+174 
+r
+ = 
+	`f_bt_
+(
+tblt
+, 
+t
+);
+
+175 
+	`KASSERT
+(
+r
+ == 0);
+
+177 i(
+ts
+ && (
+r
+ = 
+	`f_mk_b_s
+(
+t
+,nts)) != 0) {
+
+178 
+	`NPF_ERR_DEBUG
+(
+rdi
+);
+
+182 
+	`_obje__a
+(
+
+);
+
+186  
+r
+;
+
+187 
+	}
+}
+
+189 
+f_roc_t
+ *
+
+190 
+	$f_mk_sgroc
+(
+_diiy_t
+ 
+di
+)
+
+192 
+_obje__t
+ 
+
+;
+
+193 
+_diiy_t
+ 
+extdi
+;
+
+194 
+_y_t
+ 
+exi
+;
+
+195 
+f_roc_t
+ *
+
+;
+
+197 
+exi
+ = 
+	`_diiy_g
+(
+di
+, "extcalls");
+
+198 i(
+	`_obje_ty
+(
+exi
+!
+PROP_TYPE_ARRAY
+) {
+
+199  
+NULL
+;
+
+202 
+
+ = 
+	`f_roc_
+(
+di
+);
+
+203 i(
+
+ =
+NULL
+) {
+
+204  
+NULL
+;
+
+207 
+
+ = 
+	`_y_
+(
+exi
+);
+
+208 (
+extdi
+ = 
+	`_obje__xt
+(
+
+)!
+NULL
+) {
+
+209 c *
+me
+;
+
+211 i(!
+	`_diiy_g_crg_nocy
+(
+extdi
+,
+
+212 "me", &
+me
+|| 
+	`f_ext_cru
+ame, 
+
+, 
+extdi
+)) {
+
+213 
+	`f_roc_a
+(
+
+);
+
+214 
+
+ = 
+NULL
+;
+
+218 
+	`_obje__a
+(
+
+);
+
+219  
+
+;
+
+220 
+	}
+}
+
+222 
+__nole
+
+
+223 
+	$f_mk_rocs
+(
+f_roct_t
+ *
+t
+, 
+_y_t
+ 
+rocs
+,
+
+224 
+_diiy_t
+ 
+rdi
+)
+
+226 
+_obje__t
+ 
+
+;
+
+227 
+_diiy_t
+ 
+di
+;
+
+228 
+r
+ = 0;
+
+230 
+
+ = 
+	`_y_
+(
+rocs
+);
+
+231 (
+di
+ = 
+	`_obje__xt
+(
+
+)!
+NULL
+) {
+
+232 
+f_roc_t
+ *
+
+;
+
+234 i((
+
+ = 
+	`f_mk_sgroc
+(
+di
+)=
+NULL
+) {
+
+235 
+	`NPF_ERR_DEBUG
+(
+rdi
+);
+
+236 
+r
+ = 
+EINVAL
+;
+
+239 
+	`f_roct_
+(
+t
+, 
+
+);
+
+241 
+	`_obje__a
+(
+
+);
+
+242  
+r
+;
+
+243 
+	}
+}
+
+245 
+f_g_t
+ *
+
+246 
+	$f_mk_sgg
+(
+_diiy_t
+ 
+di
+)
+
+248 c *
+me
+;
+
+250 i(!
+	`_diiy_g_crg_nocy
+(
+di
+, "me", &
+me
+))
+
+251  
+NULL
+;
+
+252  
+	`f_g_cru
+(
+me
+);
+
+253 
+	}
+}
+
+255 
+__nole
+
+
+256 
+	$f_mk_gs
+(
+_y_t
+ 
+gli
+, 
+_diiy_t
+ 
+rdi
+)
+
+258 
+_obje__t
+ 
+
+;
+
+259 
+_diiy_t
+ 
+di
+;
+
+260 
+r
+ = 0;
+
+262 
+
+ = 
+	`_y_
+(
+gli
+);
+
+263 (
+di
+ = 
+	`_obje__xt
+(
+
+)!
+NULL
+) {
+
+264 i(
+	`f_mk_sgg
+(
+di
+=
+NULL
+) {
+
+265 
+	`NPF_ERR_DEBUG
+(
+rdi
+);
+
+266 
+r
+ = 
+EINVAL
+;
+
+270 
+	`_obje__a
+(
+
+);
+
+271  
+r
+;
+
+272 
+	}
+}
+
+274 
+__nole
+
+
+275 
+	$f_mk_code
+(
+_obje_t
+ 
+obj
+, 
+ty
+, **
+code
+, 
+size_t
+ *
+csize
+,
+
+276 
+_diiy_t
+ 
+rdi
+)
+
+278 c *
+
+;
+
+279 
+size_t
+ 
+
+;
+
+280 *
+bc
+;
+
+282 i(
+ty
+ !
+NPF_CODE_BPF
+) {
+
+283  
+ENOTSUP
+;
+
+285 
+
+ = 
+	`_da_da_nocy
+(
+obj
+);
+
+286 i(
+
+ =
+NULL
+ || (
+
+ = 
+	`_da_size
+(
+obj
+)) == 0) {
+
+287 
+	`NPF_ERR_DEBUG
+(
+rdi
+);
+
+288  
+EINVAL
+;
+
+290 i(!
+	`f_bpf_vide
+(
+
+, 
+
+)) {
+
+291 
+	`NPF_ERR_DEBUG
+(
+rdi
+);
+
+292  
+EINVAL
+;
+
+294 
+bc
+ = 
+	`kmem_loc
+(
+
+, 
+KM_SLEEP
+);
+
+295 
+	`memy
+(
+bc
+, 
+
+, 
+
+);
+
+297 *
+code
+ = 
+bc
+;
+
+298 *
+csize
+ = 
+
+;
+
+300 
+	}
+}
+
+302 
+__nole
+
+
+303 
+	$f_mk_sgru
+(
+_diiy_t
+ 
+di
+, 
+f_roct_t
+ *
+t
+,
+
+304 
+f_ru_t
+ **
+t
+, 
+_diiy_t
+ 
+rdi
+)
+
+306 
+f_ru_t
+ *
+
+;
+
+307 c *
+ame
+;
+
+308 
+_obje_t
+ 
+obj
+;
+
+309 
+p
+, 
+r
+ = 0;
+
+312 i(
+	`_obje_ty
+(
+di
+!
+PROP_TYPE_DICTIONARY
+) {
+
+313 
+	`NPF_ERR_DEBUG
+(
+rdi
+);
+
+314  
+EINVAL
+;
+
+316 i((
+
+ = 
+	`f_ru_loc
+(
+di
+)=
+NULL
+) {
+
+317 
+	`NPF_ERR_DEBUG
+(
+rdi
+);
+
+318  
+EINVAL
+;
+
+322 i(
+	`_diiy_g_crg_nocy
+(
+di
+, "roc", &
+ame
+)) {
+
+323 
+f_roc_t
+ *
+
+;
+
+325 i(
+t
+ =
+NULL
+) {
+
+326 
+r
+ = 
+EINVAL
+;
+
+327 
+r
+;
+
+329 i((
+
+ = 
+	`f_roct_lookup
+(
+t
+, 
+ame
+)=
+NULL
+) {
+
+330 
+	`NPF_ERR_DEBUG
+(
+rdi
+);
+
+331 
+r
+ = 
+EINVAL
+;
+
+332 
+r
+;
+
+334 
+	`f_ru_oc
+(
+
+, 
+
+);
+
+338 i((
+obj
+ = 
+	`_diiy_g
+(
+di
+, "code")!
+NULL
+) {
+
+339 
+ty
+;
+
+340 
+size_t
+ 
+n
+;
+
+341 *
+code
+;
+
+343 
+	`_diiy_g_t32
+(
+di
+, "code-ty", &
+ty
+);
+
+344 
+r
+ = 
+	`f_mk_code
+(
+obj
+, 
+ty
+, &
+code
+, &
+n
+, 
+rdi
+);
+
+345 i(
+r
+) {
+
+346 
+r
+;
+
+348 
+	`f_ru_tcode
+(
+
+, 
+ty
+, 
+code
+, 
+n
+);
+
+351 *
+t
+ = 
+
+;
+
+353 
+r
+:
+
+354 
+	`f_ru_
+(
+
+);
+
+355 
+	`_diiy_g_t32
+(
+di
+, "io", &
+p
+);
+
+356 
+	`_diiy_t_t32
+(
+rdi
+, "id", 
+p
+);
+
+357  
+r
+;
+
+358 
+	}
+}
+
+360 
+__nole
+
+
+361 
+	$f_mk_rus
+(
+f_rut_t
+ *
+t
+, 
+_y_t
+ 
+rus
+, 
+f_roct_t
+ *
+t
+,
+
+362 
+_diiy_t
+ 
+rdi
+)
+
+364 
+_obje__t
+ 
+
+;
+
+365 
+_diiy_t
+ 
+di
+;
+
+366 
+r
+;
+
+368 i(
+	`_obje_ty
+(
+rus
+!
+PROP_TYPE_ARRAY
+) {
+
+369 
+	`NPF_ERR_DEBUG
+(
+rdi
+);
+
+370  
+EINVAL
+;
+
+373 
+r
+ = 0;
+
+374 
+
+ = 
+	`_y_
+(
+rus
+);
+
+375 (
+di
+ = 
+	`_obje__xt
+(
+
+)!
+NULL
+) {
+
+376 
+f_ru_t
+ *
+
+ = 
+NULL
+;
+
+379 
+r
+ = 
+	`f_mk_sgru
+(
+di
+, 
+t
+, &
+
+, 
+rdi
+);
+
+380 i(
+r
+) {
+
+383 
+	`f_rut_
+(
+t
+, 
+
+);
+
+385 
+	`_obje__a
+(
+
+);
+
+389  
+r
+;
+
+390 
+	}
+}
+
+392 
+__nole
+
+
+393 
+	$f_mk_i
+(
+f_rut_t
+ *
+nt
+, 
+_y_t
+ 
+i
+,
+
+394 
+_diiy_t
+ 
+rdi
+)
+
+396 
+_obje__t
+ 
+
+;
+
+397 
+_diiy_t
+ 
+tdi
+;
+
+398 
+r
+;
+
+401 i(
+	`_obje_ty
+(
+i
+!
+PROP_TYPE_ARRAY
+) {
+
+402 
+	`NPF_ERR_DEBUG
+(
+rdi
+);
+
+403  
+EINVAL
+;
+
+406 
+r
+ = 0;
+
+407 
+
+ = 
+	`_y_
+(
+i
+);
+
+408 (
+tdi
+ = 
+	`_obje__xt
+(
+
+)!
+NULL
+) {
+
+409 
+f_ru_t
+ *
+
+ = 
+NULL
+;
+
+410 
+f_icy_t
+ *
+
+;
+
+413 i(
+	`_obje_ty
+(
+tdi
+!
+PROP_TYPE_DICTIONARY
+) {
+
+414 
+	`NPF_ERR_DEBUG
+(
+rdi
+);
+
+415 
+r
+ = 
+EINVAL
+;
+
+423 
+r
+ = 
+	`f_mk_sgru
+(
+tdi
+, 
+NULL
+, &
+
+, 
+rdi
+);
+
+424 i(
+r
+) {
+
+427 
+	`f_rut_
+(
+nt
+, 
+
+);
+
+430 i(
+	`_diiy_g
+(
+tdi
+, "name") &&
+
+431 
+	`_diiy_g
+(
+tdi
+, "subrules")) {
+
+436 
+
+ = 
+	`f_t_wpicy
+(
+tdi
+, 
+nt
+);
+
+437 i(
+
+ =
+NULL
+) {
+
+438 
+	`NPF_ERR_DEBUG
+(
+rdi
+);
+
+439 
+r
+ = 
+ENOMEM
+;
+
+442 
+	`f_ru_
+(
+
+, 
+
+);
+
+444 
+	`_obje__a
+(
+
+);
+
+449  
+r
+;
+
+450 
+	}
+}
+
+455 
+__nole
+
+
+456 
+	$f_mk_ci
+(
+_y_t
+ 
+cli
+, 
+f_rut_t
+ *
+i
+,
+
+457 
+f_cndb_t
+ **
+cndb
+, 
+_diiy_t
+ 
+rdi
+)
+
+459 
+_diiy_t
+ 
+cdi
+;
+
+460 
+_obje__t
+ 
+
+;
+
+461 
+f_cndb_t
+ *
+cd
+;
+
+462 
+r
+ = 0;
+
+465 i(
+	`_obje_ty
+(
+cli
+!
+PROP_TYPE_ARRAY
+) {
+
+466 
+	`NPF_ERR_DEBUG
+(
+rdi
+);
+
+467  
+EINVAL
+;
+
+471 
+cd
+ = 
+	`f_cndb_
+();
+
+472 
+
+ = 
+	`_y_
+(
+cli
+);
+
+473 (
+cdi
+ = 
+	`_obje__xt
+(
+
+)!
+NULL
+) {
+
+475 i(
+	`_obje_ty
+(
+cdi
+!
+PROP_TYPE_DICTIONARY
+) {
+
+476 
+	`NPF_ERR_DEBUG
+(
+rdi
+);
+
+477 
+r
+ = 
+EINVAL
+;
+
+481 
+r
+ = 
+	`f_cn_impt
+(
+cd
+, 
+cdi
+, 
+i
+);
+
+482 i(
+r
+) {
+
+483 
+	`NPF_ERR_DEBUG
+(
+rdi
+);
+
+487 
+	`_obje__a
+(
+
+);
+
+488 i(
+r
+) {
+
+489 
+	`f_cn_gc
+(
+cd
+, 
+ue
+, 
+l
+);
+
+490 
+	`f_cndb_deroy
+(
+cd
+);
+
+492 *
+cndb
+ = 
+cd
+;
+
+494  
+r
+;
+
+495 
+	}
+}
+
+502 
+	$fl_ld
+(
+u_lg
+ 
+cmd
+, *
+da
+)
+
+504 
+if
+ *
+ef
+ = 
+da
+;
+
+505 
+_diiy_t
+ 
+f_di
+, 
+rdi
+;
+
+506 
+_y_t
+ 
+gli
+, 
+i
+, 
+bs
+, 
+rocs
+, 
+rus
+, 
+cli
+;
+
+507 
+f_bt_t
+ *
+tblt
+ = 
+NULL
+;
+
+508 
+f_roct_t
+ *
+t
+ = 
+NULL
+;
+
+509 
+f_rut_t
+ *
+t
+ = 
+NULL
+;
+
+510 
+f_rut_t
+ *
+nt
+ = 
+NULL
+;
+
+511 
+f_cndb_t
+ *
+cndb
+ = 
+NULL
+;
+
+512 
+ut32_t
+ 
+v
+ = 0;
+
+513 
+size_t
+ 
+nems
+;
+
+514 
+bo
+ 
+ush
+;
+
+515 
+r
+;
+
+518 #ide
+_NPF_TESTING
+
+
+519 
+r
+ = 
+	`_diiy_cy_iol
+(
+ef
+, 
+cmd
+, &
+f_di
+);
+
+520 i(
+r
+)
+
+521  
+r
+;
+
+523 
+f_di
+ = (
+_diiy_t
+)
+ef
+;
+
+527 
+rdi
+ = 
+	`_diiy_
+();
+
+528 
+	`_diiy_g_ut32
+(
+f_di
+, "vsi", &
+v
+);
+
+529 i(
+v
+ !
+NPF_VERSION
+) {
+
+530 
+r
+ = 
+EPROGMISMATCH
+;
+
+531 
+
+;
+
+535 
+gli
+ = 
+	`_diiy_g
+(
+f_di
+, "algs");
+
+536 
+r
+ = 
+	`f_mk_gs
+(
+gli
+, 
+rdi
+);
+
+537 i(
+r
+) {
+
+538 
+
+;
+
+542 
+i
+ = 
+	`_diiy_g
+(
+f_di
+, "nat");
+
+543 i((
+nems
+ = 
+	`_y_cou
+(
+i
+)> 
+NPF_MAX_RULES
+) {
+
+544 
+r
+ = 
+E2BIG
+;
+
+545 
+
+;
+
+548 
+nt
+ = 
+	`f_rut_
+(
+nems
+);
+
+549 
+r
+ = 
+	`f_mk_i
+(
+nt
+, 
+i
+, 
+rdi
+);
+
+550 i(
+r
+) {
+
+551 
+
+;
+
+555 
+bs
+ = 
+	`_diiy_g
+(
+f_di
+, "tables");
+
+556 i((
+nems
+ = 
+	`_y_cou
+(
+bs
+)> 
+NPF_MAX_TABLES
+) {
+
+557 
+r
+ = 
+E2BIG
+;
+
+558 
+
+;
+
+560 
+tblt
+ = 
+	`f_bt_
+(
+nems
+);
+
+561 
+r
+ = 
+	`f_mk_bs
+(
+tblt
+, 
+bs
+, 
+rdi
+);
+
+562 i(
+r
+) {
+
+563 
+
+;
+
+567 
+rocs
+ = 
+	`_diiy_g
+(
+f_di
+, "rprocs");
+
+568 i((
+nems
+ = 
+	`_y_cou
+(
+rocs
+)> 
+NPF_MAX_RPROCS
+) {
+
+569 
+r
+ = 
+E2BIG
+;
+
+570 
+
+;
+
+572 
+t
+ = 
+	`f_roct_
+();
+
+573 
+r
+ = 
+	`f_mk_rocs
+(
+t
+, 
+rocs
+, 
+rdi
+);
+
+574 i(
+r
+) {
+
+575 
+
+;
+
+579 
+rus
+ = 
+	`_diiy_g
+(
+f_di
+, "rules");
+
+580 i((
+nems
+ = 
+	`_y_cou
+(
+rus
+)> 
+NPF_MAX_RULES
+) {
+
+581 
+r
+ = 
+E2BIG
+;
+
+582 
+
+;
+
+585 
+t
+ = 
+	`f_rut_
+(
+nems
+);
+
+586 
+r
+ = 
+	`f_mk_rus
+(
+t
+, 
+rus
+, 
+t
+, 
+rdi
+);
+
+587 i(
+r
+) {
+
+588 
+
+;
+
+592 i((
+cli
+ = 
+	`_diiy_g
+(
+f_di
+, "cn-li")!
+NULL
+) {
+
+593 
+r
+ = 
+	`f_mk_ci
+(
+cli
+, 
+nt
+, &
+cndb
+, 
+rdi
+);
+
+594 i(
+r
+) {
+
+595 
+
+;
+
+599 
+ush
+ = 
+l
+;
+
+600 
+	`_diiy_g_bo
+(
+f_di
+, "ush", &
+ush
+);
+
+605 
+	`f_cfig_ld
+(
+t
+, 
+tblt
+, 
+nt
+, 
+t
+, 
+cndb
+, 
+ush
+);
+
+608 
+tblt
+ = 
+NULL
+;
+
+609 
+t
+ = 
+NULL
+;
+
+610 
+t
+ = 
+NULL
+;
+
+611 
+nt
+ = 
+NULL
+;
+
+612 
+
+:
+
+616 
+	`KASSERT
+(
+r
+ =0 || (
+nt
+ || 
+t
+ || 
+t
+ || 
+tblt
+));
+
+617 i(
+nt
+) {
+
+618 
+	`f_rut_deroy
+(
+nt
+);
+
+620 i(
+t
+) {
+
+621 
+	`f_rut_deroy
+(
+t
+);
+
+623 i(
+t
+) {
+
+624 
+	`f_roct_deroy
+(
+t
+);
+
+626 i(
+tblt
+) {
+
+627 
+	`f_bt_deroy
+(
+tblt
+);
+
+629 
+	`_obje_a
+(
+f_di
+);
+
+632 #ide
+_NPF_TESTING
+
+
+633 
+	`_diiy_t_t32
+(
+rdi
+, "o", 
+r
+);
+
+634 
+	`_diiy_cyout_iol
+(
+ef
+, 
+cmd
+, 
+rdi
+);
+
+635 
+	`_obje_a
+(
+rdi
+);
+
+636 
+r
+ = 0;
+
+638  
+r
+;
+
+639 
+	}
+}
+
+647 
+	$fl_ve
+(
+u_lg
+ 
+cmd
+, *
+da
+)
+
+649 
+if
+ *
+ef
+ = 
+da
+;
+
+650 
+_y_t
+ 
+ruli
+, 
+i
+, 
+bs
+, 
+rocs
+, 
+cli
+;
+
+651 
+_diiy_t
+ 
+f_di
+ = 
+NULL
+;
+
+652 
+r
+;
+
+654 
+ruli
+ = 
+	`_y_
+();
+
+655 
+i
+ = 
+	`_y_
+();
+
+656 
+bs
+ = 
+	`_y_
+();
+
+657 
+rocs
+ = 
+	`_y_
+();
+
+658 
+cli
+ = 
+	`_y_
+();
+
+663 
+	`f_cfig_r
+();
+
+664 
+r
+ = 
+	`f_cndb_expt
+(
+cli
+);
+
+665 i(
+r
+) {
+
+666 
+out
+;
+
+668 
+r
+ = 
+	`f_rut_expt
+(
+	`f_cfig_rut
+(), 
+ruli
+);
+
+669 i(
+r
+) {
+
+670 
+out
+;
+
+672 
+r
+ = 
+	`f_rut_expt
+(
+	`f_cfig_tt
+(), 
+i
+);
+
+673 i(
+r
+) {
+
+674 
+out
+;
+
+676 
+r
+ = 
+	`f_bt_expt
+(
+	`f_cfig_bt
+(), 
+bs
+);
+
+677 i(
+r
+) {
+
+678 
+out
+;
+
+680 
+r
+ = 
+	`f_roct_expt
+(
+	`f_cfig_rocs
+(), 
+rocs
+);
+
+681 i(
+r
+) {
+
+682 
+out
+;
+
+684 
+_y_t
+ 
+gli
+ = 
+	`f_g_expt
+();
+
+686 
+f_di
+ = 
+	`_diiy_
+();
+
+687 
+	`_diiy_t_ut32
+(
+f_di
+, "vsi", 
+NPF_VERSION
+);
+
+688 
+	`_diiy_t_d_l
+(
+f_di
+, "gs", 
+gli
+);
+
+689 
+	`_diiy_t_d_l
+(
+f_di
+, "rus", 
+ruli
+);
+
+690 
+	`_diiy_t_d_l
+(
+f_di
+, "t", 
+i
+);
+
+691 
+	`_diiy_t_d_l
+(
+f_di
+, "bs", 
+bs
+);
+
+692 
+	`_diiy_t_d_l
+(
+f_di
+, "rocs", 
+rocs
+);
+
+693 
+	`_diiy_t_d_l
+(
+f_di
+, "cn-li", 
+cli
+);
+
+694 
+	`_diiy_t_bo
+(
+f_di
+, "aive", 
+	`f_pf_gied_p
+());
+
+695 
+r
+ = 
+	`_diiy_cyout_iol
+(
+ef
+, 
+cmd
+, 
+f_di
+);
+
+696 
+out
+:
+
+697 
+	`f_cfig_ex
+();
+
+699 i(!
+f_di
+) {
+
+700 
+	`_obje_a
+(
+ruli
+);
+
+701 
+	`_obje_a
+(
+i
+);
+
+702 
+	`_obje_a
+(
+bs
+);
+
+703 
+	`_obje_a
+(
+rocs
+);
+
+704 
+	`_obje_a
+(
+cli
+);
+
+706 
+	`_obje_a
+(
+f_di
+);
+
+708  
+r
+;
+
+709 
+	}
+}
+
+715 
+	$fl_ru
+(
+u_lg
+ 
+cmd
+, *
+da
+)
+
+717 
+if
+ *
+ef
+ = 
+da
+;
+
+718 
+_diiy_t
+ 
+f_ru
+, 
+tdi
+ = 
+NULL
+;
+
+719 
+f_rut_t
+ *
+t
+;
+
+720 
+f_ru_t
+ *
+
+ = 
+NULL
+;
+
+721 c *
+rut_me
+;
+
+722 
+ut32_t
+ 
+rcmd
+ = 0;
+
+723 
+r
+;
+
+725 
+r
+ = 
+	`_diiy_cy_iol
+(
+ef
+, 
+cmd
+, &
+f_ru
+);
+
+726 i(
+r
+) {
+
+727  
+r
+;
+
+729 
+	`_diiy_g_ut32
+(
+f_ru
+, "commd", &
+rcmd
+);
+
+730 i(!
+	`_diiy_g_crg_nocy
+(
+f_ru
+,
+
+731 "rut-me", &
+rut_me
+)) {
+
+732 
+r
+ = 
+EINVAL
+;
+
+733 
+out
+;
+
+736 i(
+rcmd
+ =
+NPF_CMD_RULE_ADD
+) {
+
+737 
+tdi
+ = 
+	`_diiy_
+();
+
+738 i(
+	`f_mk_sgru
+(
+f_ru
+, 
+NULL
+, &
+
+, 
+tdi
+) != 0) {
+
+739 
+r
+ = 
+EINVAL
+;
+
+740 
+out
+;
+
+744 
+	`f_cfig_r
+();
+
+745 
+t
+ = 
+	`f_cfig_rut
+();
+
+747 
+rcmd
+) {
+
+748 
+NPF_CMD_RULE_ADD
+: {
+
+749 i((
+r
+ = 
+	`f_rut_add
+(
+t
+, 
+rut_me
+, 
+
+)) == 0) {
+
+751 
+ut64_t
+ 
+id
+ = 
+	`f_ru_gid
+(
+
+);
+
+752 
+	`_diiy_t_ut64
+(
+tdi
+, "id", 
+id
+);
+
+753 
+
+ = 
+NULL
+;
+
+757 
+NPF_CMD_RULE_REMOVE
+: {
+
+758 
+ut64_t
+ 
+id
+;
+
+760 i(!
+	`_diiy_g_ut64
+(
+f_ru
+, "id", &
+id
+)) {
+
+761 
+r
+ = 
+EINVAL
+;
+
+764 
+r
+ = 
+	`f_rut_move
+(
+t
+, 
+rut_me
+, 
+id
+);
+
+767 
+NPF_CMD_RULE_REMKEY
+: {
+
+768 
+_obje_t
+ 
+obj
+ = 
+	`_diiy_g
+(
+f_ru
+, "key");
+
+769 c *
+key
+ = 
+	`_da_da_nocy
+(
+obj
+);
+
+770 
+size_t
+ 
+n
+ = 
+	`_da_size
+(
+obj
+);
+
+772 i(
+n
+ =0 || > 
+NPF_RULE_MAXKEYLEN
+) {
+
+773 
+r
+ = 
+EINVAL
+;
+
+776 
+r
+ = 
+	`f_rut_mkey
+(
+t
+, 
+rut_me
+, 
+key
+, 
+n
+);
+
+779 
+NPF_CMD_RULE_LIST
+: {
+
+780 
+tdi
+ = 
+	`f_rut_li
+(
+t
+, 
+rut_me
+);
+
+781 i(!
+tdi
+) {
+
+782 
+r
+ = 
+ESRCH
+;
+
+786 
+NPF_CMD_RULE_FLUSH
+: {
+
+787 
+r
+ = 
+	`f_rut_ush
+(
+t
+, 
+rut_me
+);
+
+791 
+r
+ = 
+EINVAL
+;
+
+796 i(!
+r
+ && 
+rcmd
+ !
+NPF_CMD_RULE_ADD
+ &&cmd !
+NPF_CMD_RULE_LIST
+) {
+
+797 
+	`f_cfig_sync
+();
+
+798 
+	`f_rut_gc
+(
+t
+);
+
+800 
+	`f_cfig_ex
+();
+
+802 i(
+
+) {
+
+803 
+	`KASSERT
+(
+r
+);
+
+804 
+	`f_ru_
+(
+
+);
+
+806 
+out
+:
+
+807 i(
+tdi
+) {
+
+808 
+	`_obje_a
+(
+f_ru
+);
+
+809 
+	`_diiy_cyout_iol
+(
+ef
+, 
+cmd
+, 
+tdi
+);
+
+810 
+	`_obje_a
+(
+tdi
+);
+
+812  
+r
+;
+
+813 
+	}
+}
+
+821 
+	$fl_b
+(*
+da
+)
+
+823 c 
+f_iol_b_t
+ *
+n
+ = 
+da
+;
+
+824 
+ame
+[
+NPF_TABLE_MAXNAMELEN
+];
+
+825 
+f_bt_t
+ *
+ts
+;
+
+826 
+f_b_t
+ *
+t
+;
+
+827 
+s
+, 
+r
+;
+
+829 
+r
+ = 
+	`cyr
+(
+n
+->
+n_me
+, 
+ame
+, me), 
+NULL
+);
+
+830 i(
+r
+) {
+
+831  
+r
+;
+
+834 
+s
+ = 
+	`f_cfig_ad_r
+();
+
+835 
+ts
+ = 
+	`f_cfig_bt
+();
+
+836 i((
+t
+ = 
+	`f_bt_gbyme
+(
+ts
+, 
+ame
+)=
+NULL
+) {
+
+837 
+	`f_cfig_ad_ex
+(
+s
+);
+
+838  
+EINVAL
+;
+
+841 
+n
+->
+n_cmd
+) {
+
+842 
+NPF_CMD_TABLE_LOOKUP
+:
+
+843 
+r
+ = 
+	`f_b_lookup
+(
+t
+, 
+n
+->
+n_da
+.
+t
+.
+
+,
+
+844 &
+n
+->
+n_da
+.
+t
+.
+addr
+);
+
+846 
+NPF_CMD_TABLE_ADD
+:
+
+847 
+r
+ = 
+	`f_b_
+(
+t
+, 
+n
+->
+n_da
+.
+t
+.
+
+,
+
+848 &
+n
+->
+n_da
+.
+t
+.
+addr
+,->n_da.t.
+mask
+);
+
+850 
+NPF_CMD_TABLE_REMOVE
+:
+
+851 
+r
+ = 
+	`f_b_move
+(
+t
+, 
+n
+->
+n_da
+.
+t
+.
+
+,
+
+852 &
+n
+->
+n_da
+.
+t
+.
+addr
+,->n_da.t.
+mask
+);
+
+854 
+NPF_CMD_TABLE_LIST
+:
+
+855 
+r
+ = 
+	`f_b_li
+(
+t
+, 
+n
+->
+n_da
+.
+buf
+.buf,
+
+856 
+n
+->
+n_da
+.
+buf
+.
+n
+);
+
+858 
+NPF_CMD_TABLE_FLUSH
+:
+
+859 
+r
+ = 
+	`f_b_ush
+(
+t
+);
+
+862 
+r
+ = 
+EINVAL
+;
+
+865 
+	`f_cfig_ad_ex
+(
+s
+);
+
+867  
+r
+;
+
+868 
+	}
+}
+
+	@npf/npf_ext_log.c
+
+36 
+	~<sys/cdefs.h
+>
+
+37 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_ext_log.c,v 1.8 2014/07/20 00:37:41mind Exp $");
+
+39 
+	~<sys/tys.h
+>
+
+40 
+	~<sys/modu.h
+>
+
+42 
+	~<sys/cf.h
+>
+
+43 
+	~<sys/kmem.h
+>
+
+44 
+	~<sys/mbuf.h
+>
+
+45 
+	~<sys/mux.h
+>
+
+46 
+	~<sys/queue.h
+>
+
+48 
+	~<t/if.h
+>
+
+49 
+	~<t/if_tys.h
+>
+
+50 
+	~<t/bpf.h
+>
+
+52 
+	~"f_im.h
+"
+
+54 
+NPF_EXT_MODULE
+(
+f_ext_log
+, "");
+
+56 
+	#NPFEXT_LOG_VER
+ 1
+
+	)
+
+58 * 
+	gf_ext_log_id
+;
+
+61 
+	mif_idx
+;
+
+62 } 
+	tf_ext_log_t
+;
+
+65 
+	$f_log_
+(
+f_roc_t
+ *
+
+, 
+_diiy_t
+ 
+ms
+)
+
+67 
+f_ext_log_t
+ *
+ma
+;
+
+69 
+ma
+ = 
+	`kmem_zloc
+((
+f_ext_log_t
+), 
+KM_SLEEP
+);
+
+70 
+	`_diiy_g_ut32
+(
+ms
+, "log-r", &
+ma
+->
+if_idx
+);
+
+71 
+	`f_roc_assign
+(
+
+, 
+ma
+);
+
+73 
+	}
+}
+
+76 
+	$f_log_dt
+(
+f_roc_t
+ *
+
+, *
+ma
+)
+
+78 
+	`kmem_
+(
+ma
+, (
+f_ext_log_t
+));
+
+79 
+	}
+}
+
+81 
+bo
+
+
+82 
+	$f_log
+(
+f_che_t
+ *
+c
+, *
+ma
+, *
+decisi
+)
+
+84 
+mbuf
+ *
+m
+ = 
+	`nbuf_hd_mbuf
+(
+c
+->
+c_nbuf
+);
+
+85 c 
+f_ext_log_t
+ *
+log
+ = 
+ma
+;
+
+86 
+i_t
+ *
+i
+;
+
+87 
+my
+;
+
+90 i(
+	`f_isched
+(
+c
+, 
+NPC_IP4
+)) {
+
+91 
+my
+ = 
+AF_INET
+;
+
+92 } i(
+	`f_isched
+(
+c
+, 
+NPC_IP6
+)) {
+
+93 
+my
+ = 
+AF_INET6
+;
+
+95 
+my
+ = 
+AF_UNSPEC
+;
+
+98 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+101 
+i
+ = 
+	`if_bydex
+(
+log
+->
+if_idx
+);
+
+102 i(
+i
+ =
+NULL
+) {
+
+104 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+105  
+ue
+;
+
+109 
+i
+->
+if_acks
+++;
+
+110 
+i
+->
+if_obys
+ +
+m
+->
+m_pkthdr
+.
+n
+;
+
+111 
+	`bpf_mp_af
+(
+i
+, 
+my
+, 
+m
+);
+
+112 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+114  
+ue
+;
+
+115 
+	}
+}
+
+121 
+	$f_ext_log_modcmd
+(
+modcmd_t
+ 
+cmd
+, *
+g
+)
+
+123 c 
+f_ext_s_t
+ 
+f_log_s
+ = {
+
+124 .
+vsi
+ = 
+NPFEXT_LOG_VER
+,
+
+125 .
+x
+ = 
+NULL
+,
+
+126 .
+
+ = 
+f_log_
+,
+
+127 .
+dt
+ = 
+f_log_dt
+,
+
+128 .
+oc
+ = 
+f_log
+
+
+130 
+r
+;
+
+132 
+cmd
+) {
+
+133 
+MODULE_CMD_INIT
+:
+
+137 
+f_ext_log_id
+ = 
+	`f_ext_gi
+("log", &
+f_log_s
+);
+
+138 i(!
+f_ext_log_id
+) {
+
+139  
+EEXIST
+;
+
+143 
+MODULE_CMD_FINI
+:
+
+144 
+r
+ = 
+	`f_ext_uegi
+(
+f_ext_log_id
+);
+
+145 i(
+r
+) {
+
+146  
+r
+;
+
+150 
+MODULE_CMD_AUTOUNLOAD
+:
+
+152  
+	`f_autoud_p
+(? 0 : 
+EBUSY
+;
+
+155  
+ENOTTY
+;
+
+158 
+	}
+}
+
+	@npf/npf_ext_normalize.c
+
+29 
+	~<sys/cdefs.h
+>
+
+30 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_ext_normalize.c,v 1.3 2014/07/20 00:37:41mind Exp $");
+
+32 
+	~<sys/tys.h
+>
+
+33 
+	~<sys/modu.h
+>
+
+34 
+	~<sys/kmem.h
+>
+
+36 
+	~<t/if.h
+>
+
+37 
+	~<t/_sym.h
+>
+
+38 
+	~<t/.h
+>
+
+39 
+	~<t/_v.h
+>
+
+41 
+	~"f.h
+"
+
+42 
+	~"f_im.h
+"
+
+47 
+NPF_EXT_MODULE
+(
+f_ext_nmize
+, "");
+
+49 
+	#NPFEXT_NORMALIZE_VER
+ 1
+
+	)
+
+51 * 
+	gf_ext_nmize_id
+;
+
+57 
+u_t
+ 
+	mn_ml
+;
+
+58 
+u_t
+ 
+	mn_maxmss
+;
+
+59 
+bo
+ 
+	mn_ndom_id
+;
+
+60 
+bo
+ 
+	mn_no_df
+;
+
+61 } 
+	tf_nmize_t
+;
+
+68 
+	$f_nmize_
+(
+f_roc_t
+ *
+
+, 
+_diiy_t
+ 
+ms
+)
+
+70 
+f_nmize_t
+ *
+
+;
+
+73 
+
+ = 
+	`kmem_zloc
+((
+f_nmize_t
+), 
+KM_SLEEP
+);
+
+76 
+	`_diiy_g_bo
+(
+ms
+, "ndom-id", &
+
+->
+n_ndom_id
+);
+
+77 
+	`_diiy_g_bo
+(
+ms
+, "no-df", &
+
+->
+n_no_df
+);
+
+80 
+	`_diiy_g_ut32
+(
+ms
+, "m-l", &
+
+->
+n_ml
+);
+
+81 
+	`_diiy_g_ut32
+(
+ms
+, "max-mss", &
+
+->
+n_maxmss
+);
+
+84 
+	`f_roc_assign
+(
+
+, 
+
+);
+
+86 
+	}
+}
+
+92 
+	$f_nmize_dt
+(
+f_roc_t
+ *
+
+, *
+ms
+)
+
+95 
+	`kmem_
+(
+ms
+, (
+f_nmize_t
+));
+
+96 
+	}
+}
+
+102 
+le
+ 
+
+103 
+	$f_nmize_4
+(
+f_che_t
+ *
+c
+, 
+f_nmize_t
+ *
+
+)
+
+105 
+
+ * = 
+c
+->
+c_
+.
+v4
+;
+
+106 
+ut16_t
+ 
+cksum
+ = 
+
+->
+_sum
+;
+
+107 
+ut16_t
+ 
+_off
+ = 
+
+->ip_off;
+
+108 
+ut8_t
+ 
+l
+ = 
+
+->
+_l
+;
+
+109 
+u_t
+ 
+ml
+ = 
+
+->
+n_ml
+;
+
+111 
+	`KASSERT
+(
+
+->
+n_ndom_id
+ ||p->
+n_no_df
+ || 
+ml
+);
+
+114 i(
+
+->
+n_ndom_id
+) {
+
+115 
+ut16_t
+ 
+oid
+ = 
+
+->
+_id
+, 
+nid
+;
+
+117 
+nid
+ = 
+	`hts
+(
+	`_ndomid
+(
+_ids
+, 0));
+
+118 
+cksum
+ = 
+	`f_fixup16_cksum
+(cksum, 
+oid
+, 
+nid
+);
+
+119 
+
+->
+_id
+ = 
+nid
+;
+
+123 i(
+
+->
+n_no_df
+ && (
+_off
+ & 
+	`hts
+(
+IP_DF
+)) != 0) {
+
+124 
+ut16_t
+ 
+n_off
+ = 
+_off
+ & ~
+	`hts
+(
+IP_DF
+);
+
+126 
+cksum
+ = 
+	`f_fixup16_cksum
+(cksum, 
+_off
+, 
+n_off
+);
+
+127 
+
+->
+_off
+ = 
+n_off
+;
+
+131 i(
+ml
+ && 
+l
+ < minttl) {
+
+132 
+cksum
+ = 
+	`f_fixup16_cksum
+(cksum, 
+l
+, 
+ml
+);
+
+133 
+
+->
+_l
+ = 
+ml
+;
+
+137 
+
+->
+_sum
+ = 
+cksum
+;
+
+138 
+	}
+}
+
+143 
+bo
+
+
+144 
+	$f_nmize
+(
+f_che_t
+ *
+c
+, *
+ms
+, *
+decisi
+)
+
+146 
+f_nmize_t
+ *
+
+ = 
+ms
+;
+
+147 
+thdr
+ *
+th
+ = 
+c
+->
+c_l4
+.
+t
+;
+
+148 
+ut16_t
+ 
+cksum
+, 
+mss
+, 
+maxmss
+ = 
+
+->
+n_maxmss
+;
+
+149 
+ws
+;
+
+152 i(*
+decisi
+ =
+NPF_DECISION_BLOCK
+) {
+
+153  
+ue
+;
+
+157 i(
+	`f_isched
+(
+c
+, 
+NPC_IP4
+&& (
+
+->
+n_ndom_id
+ ||p->
+n_ml
+)) {
+
+158 
+	`f_nmize_4
+(
+c
+, 
+
+);
+
+165 i(
+maxmss
+ =0 || !
+	`f_isched
+(
+c
+, 
+NPC_TCP
+) ||
+
+166 (
+th
+->
+th_ags
+ & 
+TH_SYN
+) == 0) {
+
+168  
+ue
+;
+
+170 
+mss
+ = 0;
+
+171 i(!
+	`f_tch_tts
+(
+c
+, &
+mss
+, &
+ws
+)) {
+
+172  
+ue
+;
+
+174 i(
+	`ohs
+(
+mss
+<
+maxmss
+) {
+
+176  
+ue
+;
+
+178 
+maxmss
+ = 
+	`hts
+(maxmss);
+
+181 i(
+	`f_tch_tts
+(
+c
+, &
+maxmss
+, &
+ws
+)) {
+
+182 
+cksum
+ = 
+	`f_fixup16_cksum
+(
+th
+->
+th_sum
+, 
+mss
+, 
+maxmss
+);
+
+183 
+th
+->
+th_sum
+ = 
+cksum
+;
+
+186  
+ue
+;
+
+187 
+	}
+}
+
+190 
+	$f_ext_nmize_modcmd
+(
+modcmd_t
+ 
+cmd
+, *
+g
+)
+
+192 c 
+f_ext_s_t
+ 
+f_nmize_s
+ = {
+
+193 .
+vsi
+ = 
+NPFEXT_NORMALIZE_VER
+,
+
+194 .
+x
+ = 
+NULL
+,
+
+195 .
+
+ = 
+f_nmize_
+,
+
+196 .
+dt
+ = 
+f_nmize_dt
+,
+
+197 .
+oc
+ = 
+f_nmize
+
+
+200 
+cmd
+) {
+
+201 
+MODULE_CMD_INIT
+:
+
+206 
+f_ext_nmize_id
+ =
+
+207 
+	`f_ext_gi
+("nmize", &
+f_nmize_s
+);
+
+208  
+f_ext_nmize_id
+ ? 0 : 
+EEXIST
+;
+
+210 
+MODULE_CMD_FINI
+:
+
+212  
+	`f_ext_uegi
+(
+f_ext_nmize_id
+);
+
+214 
+MODULE_CMD_AUTOUNLOAD
+:
+
+215  
+	`f_autoud_p
+(? 0 : 
+EBUSY
+;
+
+218  
+ENOTTY
+;
+
+221 
+	}
+}
+
+	@npf/npf_ext_rndblock.c
+
+34 
+	~<sys/cdefs.h
+>
+
+35 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_ext_rndblock.c,v 1.5 2014/07/20 00:37:41mind Exp $");
+
+37 
+	~<sys/tys.h
+>
+
+38 
+	~<sys/g.h
+>
+
+39 
+	~<sys/omic.h
+>
+
+40 
+	~<sys/modu.h
+>
+
+41 
+	~<sys/kmem.h
+>
+
+43 
+	~"f.h
+"
+
+48 
+NPF_EXT_MODULE
+(
+f_ext_dblock
+, "");
+
+50 
+	#NPFEXT_RNDBLOCK_VER
+ 1
+
+	)
+
+52 * 
+	gf_ext_dblock_id
+;
+
+54 
+	#PERCENTAGE_BASE
+ 10000
+
+	)
+
+60 
+	mmod
+;
+
+61 
+	mcou
+;
+
+62 
+	mrage
+;
+
+63 } 
+	tf_ext_dblock_t
+;
+
+70 
+	$f_ext_dblock_
+(
+f_roc_t
+ *
+
+, 
+_diiy_t
+ 
+ms
+)
+
+72 
+f_ext_dblock_t
+ *
+ma
+;
+
+78 
+ma
+ = 
+	`kmem_zloc
+((
+f_ext_dblock_t
+), 
+KM_SLEEP
+);
+
+79 
+	`_diiy_g_ut32
+(
+ms
+, "mod", &
+ma
+->
+mod
+);
+
+80 
+	`_diiy_g_ut32
+(
+ms
+, "rage", &
+ma
+->
+rage
+);
+
+81 
+	`f_roc_assign
+(
+
+, 
+ma
+);
+
+84 
+	}
+}
+
+90 
+	$f_ext_dblock_dt
+(
+f_roc_t
+ *
+
+, *
+ma
+)
+
+93 
+	`kmem_
+(
+ma
+, (
+f_ext_dblock_t
+));
+
+94 
+	}
+}
+
+99 
+bo
+
+
+100 
+	$f_ext_dblock
+(
+f_che_t
+ *
+c
+, *
+ma
+, *
+decisi
+)
+
+102 
+f_ext_dblock_t
+ *
+dblock
+ = 
+ma
+;
+
+103 
+c
+;
+
+106 i(*
+decisi
+ =
+NPF_DECISION_BLOCK
+) {
+
+107  
+ue
+;
+
+118 
+c
+ = 
+	`omic_c_ulg_nv
+(&
+dblock
+->
+cou
+);
+
+120 i(
+dblock
+->
+mod
+) {
+
+121 i((
+c
+ % 
+dblock
+->
+mod
+) == 0) {
+
+122 *
+decisi
+ = 
+NPF_DECISION_BLOCK
+;
+
+126 i(
+dblock
+->
+rage
+) {
+
+127 
+ut32_t
+ 
+w
+ = 
+	`g_32
+(% 
+PERCENTAGE_BASE
+;
+
+128 i(
+w
+ <
+dblock
+->
+rage
+) {
+
+129 *
+decisi
+ = 
+NPF_DECISION_BLOCK
+;
+
+133  
+ue
+;
+
+134 
+	}
+}
+
+140 
+	$f_ext_dblock_modcmd
+(
+modcmd_t
+ 
+cmd
+, *
+g
+)
+
+142 c 
+f_ext_s_t
+ 
+f_dblock_s
+ = {
+
+143 .
+vsi
+ = 
+NPFEXT_RNDBLOCK_VER
+,
+
+144 .
+x
+ = 
+NULL
+,
+
+145 .
+
+ = 
+f_ext_dblock_
+,
+
+146 .
+dt
+ = 
+f_ext_dblock_dt
+,
+
+147 .
+oc
+ = 
+f_ext_dblock
+
+
+150 
+cmd
+) {
+
+151 
+MODULE_CMD_INIT
+:
+
+157 
+f_ext_dblock_id
+ = 
+	`f_ext_gi
+("rndblock",
+
+158 &
+f_dblock_s
+);
+
+159  
+f_ext_dblock_id
+ ? 0 : 
+EEXIST
+;
+
+161 
+MODULE_CMD_FINI
+:
+
+166  
+	`f_ext_uegi
+(
+f_ext_dblock_id
+);
+
+168 
+MODULE_CMD_AUTOUNLOAD
+:
+
+170  
+	`f_autoud_p
+(? 0 : 
+EBUSY
+;
+
+173  
+ENOTTY
+;
+
+176 
+	}
+}
+
+	@npf/npf_handler.c
+
+38 
+	~<sys/cdefs.h
+>
+
+39 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_handler.c,v 1.33 2014/07/23 01:25:34mind Exp $");
+
+41 
+	~<sys/tys.h
+>
+
+42 
+	~<sys/m.h
+>
+
+44 
+	~<sys/mbuf.h
+>
+
+45 
+	~<sys/mux.h
+>
+
+46 
+	~<t/if.h
+>
+
+47 
+	~<t/pf.h
+>
+
+48 
+	~<sys/sockv.h
+>
+
+50 
+	~<t/_sym.h
+>
+
+51 
+	~<t/.h
+>
+
+52 
+	~<t/_v.h
+>
+
+53 
+	~<t/6.h
+>
+
+54 
+	~<t6/6_v.h
+>
+
+56 
+	~"f_im.h
+"
+
+57 
+	~"f_cn.h
+"
+
+59 
+bo
+ 
+	gpf_gied
+ = 
+l
+;
+
+60 
+pf_hd_t
+ * 
+	gf_ph_if
+ = 
+NULL
+;
+
+61 
+pf_hd_t
+ * 
+	gf_ph_
+ = 
+NULL
+;
+
+62 
+pf_hd_t
+ * 
+	gf_ph_6
+ = 
+NULL
+;
+
+64 #ide
+INET6
+
+
+65 
+	#6_ass_ck
+(
+x
+, 
+y
+
+ENOTSUP
+
+
+	)
+
+72 
+	$f_ifhook
+(*
+g
+, 
+mbuf
+ **
+mp
+, 
+i_t
+ *
+i
+, 
+di
+)
+
+74 
+u_lg
+ 
+cmd
+ = (u_lg)
+mp
+;
+
+76 i(
+di
+ =
+PFIL_IFNET
+) {
+
+77 
+cmd
+) {
+
+78 
+PFIL_IFNET_ATTACH
+:
+
+79 
+	`f_ifm_ch
+(
+i
+);
+
+81 
+PFIL_IFNET_DETACH
+:
+
+82 
+	`f_ifm_dach
+(
+i
+);
+
+87 
+	}
+}
+
+90 
+	$f_asmbly
+(
+f_che_t
+ *
+c
+, 
+mbuf
+ **
+mp
+)
+
+92 
+nbuf_t
+ *
+nbuf
+ = 
+c
+->
+c_nbuf
+;
+
+93 
+r
+ = 
+EINVAL
+;
+
+96 *
+mp
+ = 
+	`nbuf_hd_mbuf
+(
+nbuf
+);
+
+97 
+	`nbuf_t
+(
+nbuf
+);
+
+99 i(
+	`f_isched
+(
+c
+, 
+NPC_IP4
+)) {
+
+100 
+
+ * = 
+	`nbuf_d
+(
+nbuf
+);
+
+101 
+r
+ = 
+	`_ass_ck
+(
+mp
+, 
+
+);
+
+102 } i(
+	`f_isched
+(
+c
+, 
+NPC_IP6
+)) {
+
+107 
+r
+ = 
+	`6_ass_ck
+(
+mp
+, 
+c
+->
+c_hn
+);
+
+108 i(
+r
+ && *
+mp
+ =
+NULL
+) {
+
+109 
+	`memt
+(
+nbuf
+, 0, (
+nbuf_t
+));
+
+112 i(
+r
+) {
+
+113 
+	`f_s_c
+(
+NPF_STAT_REASSFAIL
+);
+
+114  
+r
+;
+
+116 i(*
+mp
+ =
+NULL
+) {
+
+118 
+	`f_s_c
+(
+NPF_STAT_FRAGMENTS
+);
+
+126 
+	`nbuf_
+(
+nbuf
+, *
+mp
+,buf->
+nb_i
+);
+
+127 
+c
+->
+c_fo
+ = 0;
+
+129 i(
+	`f_che_l
+(
+c
+& 
+NPC_IPFRAG
+) {
+
+130  
+EINVAL
+;
+
+132 
+	`f_s_c
+(
+NPF_STAT_REASSEMBLY
+);
+
+134 
+	}
+}
+
+142 
+	$f_ck_hdr
+(*
+g
+, 
+mbuf
+ **
+mp
+, 
+i_t
+ *
+i
+, 
+di
+)
+
+144 
+nbuf_t
+ 
+nbuf
+;
+
+145 
+f_che_t
+ 
+c
+;
+
+146 
+f_cn_t
+ *
+c
+;
+
+147 
+f_ru_t
+ *
+
+;
+
+148 
+f_roc_t
+ *
+
+;
+
+149 
+r
+, 
+t
+;
+
+150 
+decisi
+;
+
+156 
+	`KASSERT
+(
+i
+ !
+NULL
+);
+
+157 
+	`nbuf_
+(&
+nbuf
+, *
+mp
+, 
+i
+);
+
+158 
+c
+.
+c_nbuf
+ = &
+nbuf
+;
+
+159 
+c
+.
+c_fo
+ = 0;
+
+161 
+decisi
+ = 
+NPF_DECISION_BLOCK
+;
+
+162 
+r
+ = 0;
+
+163 
+t
+ = 0;
+
+164 
+
+ = 
+NULL
+;
+
+167 i(
+	`__edi_l
+(
+	`f_che_l
+(&
+c
+& 
+NPC_IPFRAG
+)) {
+
+171 
+r
+ = 
+	`f_asmbly
+(&
+c
+, 
+mp
+);
+
+172 i(
+r
+) {
+
+173 
+c
+ = 
+NULL
+;
+
+174 
+out
+;
+
+176 i(*
+mp
+ =
+NULL
+) {
+
+183 
+c
+ = 
+	`f_cn_e
+(&
+c
+, 
+di
+, &
+r
+);
+
+186 i(
+c
+ && 
+	`f_cn_ss
+(c, &
+
+)) {
+
+187 
+	`f_s_c
+(
+NPF_STAT_PASS_CONN
+);
+
+188 
+	`KASSERT
+(
+r
+ == 0);
+
+189 
+ss
+;
+
+191 i(
+	`__edi_l
+(
+r
+)) {
+
+192 i(
+r
+ =
+ENETUNREACH
+)
+
+193 
+block
+;
+
+194 
+out
+;
+
+198 
+ock
+ = 
+	`f_cfig_ad_r
+();
+
+199 
+f_rut_t
+ *
+t
+ = 
+	`f_cfig_rut
+();
+
+201 
+
+ = 
+	`f_rut_e
+(&
+c
+, 
+t
+, 
+di
+, 
+NPF_LAYER_3
+);
+
+202 i(
+	`__edi_l
+(
+
+ =
+NULL
+)) {
+
+203 c 
+bo
+ 
+ss
+ = 
+	`f_deu_ss
+();
+
+204 
+	`f_cfig_ad_ex
+(
+ock
+);
+
+206 i(
+ss
+) {
+
+207 
+	`f_s_c
+(
+NPF_STAT_PASS_DEFAULT
+);
+
+208 
+ss
+;
+
+210 
+	`f_s_c
+(
+NPF_STAT_BLOCK_DEFAULT
+);
+
+211 
+block
+;
+
+218 
+	`KASSERT
+(
+
+ =
+NULL
+);
+
+219 
+
+ = 
+	`f_ru_groc
+(
+
+);
+
+222 
+r
+ = 
+	`f_ru_cude
+(
+
+, &
+t
+);
+
+223 
+	`f_cfig_ad_ex
+(
+ock
+);
+
+225 i(
+r
+) {
+
+226 
+	`f_s_c
+(
+NPF_STAT_BLOCK_RULESET
+);
+
+227 
+block
+;
+
+229 
+	`f_s_c
+(
+NPF_STAT_PASS_RULESET
+);
+
+235 i((
+t
+ & 
+NPF_RULE_STATEFUL
+!0 && !
+c
+) {
+
+236 
+c
+ = 
+	`f_cn_eablish
+(&
+c
+, 
+di
+,
+
+237 (
+t
+ & 
+NPF_RULE_MULTIENDS
+) == 0);
+
+238 i(
+c
+) {
+
+244 
+	`f_cn_ass
+(
+c
+, 
+
+);
+
+247 
+ss
+:
+
+248 
+decisi
+ = 
+NPF_DECISION_PASS
+;
+
+249 
+	`KASSERT
+(
+r
+ == 0);
+
+253 
+r
+ = 
+	`f_do_t
+(&
+c
+, 
+c
+, 
+di
+);
+
+254 
+block
+:
+
+259 i(
+
+ && !
+	`f_roc_run
+(&
+c
+,p, &
+decisi
+)) {
+
+260 i(
+c
+) {
+
+261 
+	`f_cn_a
+(
+c
+);
+
+263 
+	`f_roc_a
+(
+
+);
+
+264 *
+mp
+ = 
+NULL
+;
+
+267 
+out
+:
+
+272 i(
+c
+) {
+
+273 
+	`f_cn_a
+(
+c
+);
+
+274 } i(
+
+) {
+
+275 
+	`f_roc_a
+(
+
+);
+
+279 i((*
+mp
+ = 
+	`nbuf_hd_mbuf
+(&
+nbuf
+)=
+NULL
+) {
+
+280  
+r
+ ? : 
+ENOMEM
+;
+
+284 i(
+decisi
+ =
+NPF_DECISION_PASS
+ && !
+r
+) {
+
+289 (*
+mp
+)->
+m_ags
+ &~
+M_CANFASTFWD
+;
+
+298 i(
+t
+ && 
+	`f_tu_block
+(&
+c
+,etfl)) {
+
+299 *
+mp
+ = 
+NULL
+;
+
+302 i(!
+r
+) {
+
+303 
+r
+ = 
+ENETUNREACH
+;
+
+306 i(*
+mp
+) {
+
+307 
+	`m_m
+(*
+mp
+);
+
+308 *
+mp
+ = 
+NULL
+;
+
+310  
+r
+;
+
+311 
+	}
+}
+
+317 
+	$f_pf_gi
+(
+bo
+ 
+
+)
+
+319 
+r
+ = 0;
+
+321 
+	`mux_r
+(
+sot_lock
+);
+
+322 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+325 i(!
+f_ph_if
+) {
+
+326 
+f_ph_if
+ = 
+	`pf_hd_g
+(
+PFIL_TYPE_IFNET
+, 0);
+
+327 i(!
+f_ph_if
+) {
+
+328 
+r
+ = 
+ENOENT
+;
+
+329 
+out
+;
+
+331 
+r
+ = 
+	`pf_add_hook
+(
+f_ifhook
+, 
+NULL
+,
+
+332 
+PFIL_IFADDR
+ | 
+PFIL_IFNET
+, 
+f_ph_if
+);
+
+333 
+	`KASSERT
+(
+r
+ == 0);
+
+335 i(
+
+) {
+
+336 
+out
+;
+
+340 i(
+pf_gied
+) {
+
+341 
+r
+ = 
+EEXIST
+;
+
+342 
+out
+;
+
+346 
+f_ph_
+ = 
+	`pf_hd_g
+(
+PFIL_TYPE_AF
+, (*)
+AF_INET
+);
+
+347 
+f_ph_6
+ = 
+	`pf_hd_g
+(
+PFIL_TYPE_AF
+, (*)
+AF_INET6
+);
+
+348 i(!
+f_ph_
+ && !
+f_ph_6
+) {
+
+349 
+r
+ = 
+ENOENT
+;
+
+350 
+out
+;
+
+354 i(
+f_ph_
+) {
+
+355 
+r
+ = 
+	`pf_add_hook
+(
+f_ck_hdr
+, 
+NULL
+,
+
+356 
+PFIL_ALL
+, 
+f_ph_
+);
+
+357 
+	`KASSERT
+(
+r
+ == 0);
+
+359 i(
+f_ph_6
+) {
+
+360 
+r
+ = 
+	`pf_add_hook
+(
+f_ck_hdr
+, 
+NULL
+,
+
+361 
+PFIL_ALL
+, 
+f_ph_6
+);
+
+362 
+	`KASSERT
+(
+r
+ == 0);
+
+364 
+pf_gied
+ = 
+ue
+;
+
+365 
+out
+:
+
+366 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+367 
+	`mux_ex
+(
+sot_lock
+);
+
+369  
+r
+;
+
+370 
+	}
+}
+
+376 
+	$f_pf_uegi
+(
+bo
+ 
+fi
+)
+
+378 
+	`mux_r
+(
+sot_lock
+);
+
+379 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+381 i(
+fi
+ && 
+f_ph_if
+) {
+
+382 ()
+	`pf_move_hook
+(
+f_ifhook
+, 
+NULL
+,
+
+383 
+PFIL_IFADDR
+ | 
+PFIL_IFNET
+, 
+f_ph_if
+);
+
+385 i(
+f_ph_
+) {
+
+386 ()
+	`pf_move_hook
+(
+f_ck_hdr
+, 
+NULL
+,
+
+387 
+PFIL_ALL
+, 
+f_ph_
+);
+
+389 i(
+f_ph_6
+) {
+
+390 ()
+	`pf_move_hook
+(
+f_ck_hdr
+, 
+NULL
+,
+
+391 
+PFIL_ALL
+, 
+f_ph_6
+);
+
+393 
+pf_gied
+ = 
+l
+;
+
+395 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+396 
+	`mux_ex
+(
+sot_lock
+);
+
+397 
+	}
+}
+
+399 
+bo
+
+
+400 
+	$f_pf_gied_p
+()
+
+402  
+pf_gied
+;
+
+403 
+	}
+}
+
+	@npf/npf_if.c
+
+44 
+	~<sys/cdefs.h
+>
+
+45 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_if.c,v 1.4 2014/08/10 19:09:43mind Exp $");
+
+47 #ifde
+_KERNEL_OPT
+
+
+48 
+	~"pf.h
+"
+
+49 #i
+NPF
+ > 0
+
+54 
+	~<sys/m.h
+>
+
+55 
+	~<sys/tys.h
+>
+
+56 
+	~<sys/kmem.h
+>
+
+58 
+	~<t/if.h
+>
+
+60 
+	~"f_im.h
+"
+
+62 
+	#INACTIVE_ID
+ ((
+u_t
+)-1)
+
+	)
+
+65 
+	mn_iame
+[
+IFNAMSIZ
+];
+
+66 } 
+	tf_ifm_t
+;
+
+68 
+f_ifm_t
+ 
+	gf_ifm
+[
+NPF_MAX_IFMAP
+] 
+	g__ad_moly
+;
+
+69 
+u_t
+ 
+f_ifm_t
+ 
+	g__ad_moly
+;
+
+77 
+u_t
+
+
+78 
+	$f_ifm_w
+()
+
+80 
+	`KASSERT
+(
+	`f_cfig_locked_p
+());
+
+82 
+u_t
+ 
+i
+ = 0; i < 
+f_ifm_t
+; i++)
+
+83 i(
+f_ifm
+[
+i
+].
+n_iame
+[0] == '\0')
+
+84  
+i
+ + 1;
+
+86 i(
+f_ifm_t
+ =
+NPF_MAX_IFMAP
+) {
+
+87 
+	`tf
+("npf_ifmap_new: out of slots; bump NPF_MAX_IFMAP\n");
+
+88  
+INACTIVE_ID
+;
+
+90  ++
+f_ifm_t
+;
+
+91 
+	}
+}
+
+93 
+u_t
+
+
+94 
+	$f_ifm_lookup
+(c *
+iame
+)
+
+96 
+	`KASSERT
+(
+	`f_cfig_locked_p
+());
+
+98 
+u_t
+ 
+i
+ = 0; i < 
+f_ifm_t
+; i++) {
+
+99 
+f_ifm_t
+ *
+nim
+ = &
+f_ifm
+[
+i
+];
+
+101 i(
+nim
+->
+n_iame
+[0] && 
+	`rcmp
+im->n_iame, 
+iame
+) == 0)
+
+102  
+i
+ + 1;
+
+104  
+INACTIVE_ID
+;
+
+105 
+	}
+}
+
+107 
+u_t
+
+
+108 
+	$f_ifm_gi
+(c *
+iame
+)
+
+110 
+f_ifm_t
+ *
+nim
+;
+
+111 
+i_t
+ *
+i
+;
+
+112 
+u_t
+ 
+i
+;
+
+114 
+	`f_cfig_r
+();
+
+115 i((
+i
+ = 
+	`f_ifm_lookup
+(
+iame
+)!
+INACTIVE_ID
+) {
+
+116 
+out
+;
+
+118 i((
+i
+ = 
+	`f_ifm_w
+()=
+INACTIVE_ID
+) {
+
+119 
+i
+ = 
+INACTIVE_ID
+;
+
+120 
+out
+;
+
+122 
+nim
+ = &
+f_ifm
+[
+i
+ - 1];
+
+123 
+	`y
+(
+nim
+->
+n_iame
+, 
+iame
+, 
+IFNAMSIZ
+);
+
+125 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+126 i((
+i
+ = 
+	`ifun
+(
+iame
+)!
+NULL
+) {
+
+127 
+i
+->
+if_pf_kif
+ = (*)(
+u_t
+)
+i
+;
+
+129 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+130 
+out
+:
+
+131 
+	`f_cfig_ex
+();
+
+132  
+i
+;
+
+133 
+	}
+}
+
+136 
+	$f_ifm_ush
+()
+
+138 
+i_t
+ *
+i
+;
+
+140 
+	`KASSERT
+(
+	`f_cfig_locked_p
+());
+
+142 
+u_t
+ 
+i
+ = 0; i < 
+f_ifm_t
+; i++) {
+
+143 
+f_ifm
+[
+i
+].
+n_iame
+[0] = '\0';
+
+145 
+f_ifm_t
+ = 0;
+
+147 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+148 
+	`IFNET_FOREACH
+(
+i
+) {
+
+149 
+i
+->
+if_pf_kif
+ = (*)(
+u_t
+)
+INACTIVE_ID
+;
+
+151 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+152 
+	}
+}
+
+154 
+u_t
+
+
+155 
+	$f_ifm_gid
+(c 
+i_t
+ *
+i
+)
+
+157 c 
+u_t
+ 
+i
+ = (
+u_t
+)
+i
+->
+if_pf_kif
+;
+
+159 
+	`KASSERT
+(
+i
+ =
+INACTIVE_ID
+ || (> 0 && i <
+f_ifm_t
+));
+
+160  
+i
+;
+
+161 
+	}
+}
+
+164 
+	$f_ifm_gme
+(c 
+u_t
+ 
+id
+)
+
+166 c *
+iame
+;
+
+168 
+	`KASSERT
+(
+	`f_cfig_locked_p
+());
+
+169 
+	`KASSERT
+(
+id
+ > 0 && id <
+f_ifm_t
+);
+
+171 
+iame
+ = 
+f_ifm
+[
+id
+ - 1].
+n_iame
+;
+
+172 
+	`KASSERT
+(
+iame
+[0] != '\0');
+
+173  
+iame
+;
+
+174 
+	}
+}
+
+177 
+	$f_ifm_ch
+(
+i_t
+ *
+i
+)
+
+179 
+	`f_cfig_r
+();
+
+180 
+i
+->
+if_pf_kif
+ = (*)(
+u_t
+)
+	`f_ifm_lookup
+(i->
+if_xme
+);
+
+181 
+	`f_cfig_ex
+();
+
+182 
+	}
+}
+
+185 
+	$f_ifm_dach
+(
+i_t
+ *
+i
+)
+
+187 
+	`f_cfig_r
+();
+
+188 
+i
+->
+if_pf_kif
+ = (*)(
+u_t
+)
+INACTIVE_ID
+;
+
+189 
+	`f_cfig_ex
+();
+
+190 
+	}
+}
+
+	@npf/npf_impl.h
+
+37 #ide
+_NPF_IMPL_H_
+
+
+38 
+	#_NPF_IMPL_H_
+
+
+	)
+
+40 #i!
+defed
+(
+_KERNEL
+)
+
+44 #ifde
+_KERNEL_OPT
+
+
+46 
+	~"t_.h
+"
+
+47 
+	~"t_6.h
+"
+
+50 
+	~<sys/tys.h
+>
+
+51 
+	~<sys/queue.h
+>
+
+52 
+	~<sys/e.h
+>
+
+54 
+	~<t/bpf.h
+>
+
+55 
+	~<t/bpfj.h
+>
+
+56 
+	~<t/if.h
+>
+
+58 
+	~"f.h
+"
+
+60 #ifde
+_NPF_DEBUG
+
+
+61 
+	#NPF_PRINTF
+(
+x
+
+tf
+ 
+	)
+x
+
+63 
+	#NPF_PRINTF
+(
+x
+)
+
+	)
+
+70 
+	gf_rut
+;
+
+71 
+	gf_ru
+;
+
+72 
+	gf_roct
+;
+
+73 
+	gf_t
+;
+
+74 
+	gf_cn
+;
+
+76 
+f_rut
+ 
+	tf_rut_t
+;
+
+77 
+f_ru
+ 
+	tf_ru_t
+;
+
+78 
+f_t
+ 
+	tf_t_t
+;
+
+79 
+f_roct
+ 
+	tf_roct_t
+;
+
+80 
+f_g
+ 
+	tf_g_t
+;
+
+81 
+f_icy
+ 
+	tf_icy_t
+;
+
+82 
+f_cn
+ 
+	tf_cn_t
+;
+
+84 
+	gf_cndb
+;
+
+85 
+	gf_b
+;
+
+86 
+	gf_bt
+;
+
+88 
+f_cndb
+ 
+	tf_cndb_t
+;
+
+89 
+f_b
+ 
+	tf_b_t
+;
+
+90 
+f_bt
+ 
+	tf_bt_t
+;
+
+96 (*
+	tf_wkfunc_t
+)();
+
+102 
+	#NPF_MAX_RULES
+ (1024 * 1024)
+
+	)
+
+103 
+	#NPF_MAX_ALGS
+ 4
+
+	)
+
+104 
+	#NPF_MAX_TABLES
+ 128
+
+	)
+
+105 
+	#NPF_MAX_RPROCS
+ 128
+
+	)
+
+106 
+	#NPF_MAX_IFMAP
+ 64
+
+	)
+
+112 
+	#NPF_FLOW_FORW
+ 0
+
+	)
+
+113 
+	#NPF_FLOW_BACK
+ 1
+
+	)
+
+116 
+ut32_t
+ 
+n_d
+;
+
+117 
+ut32_t
+ 
+n_maxd
+;
+
+118 
+ut32_t
+ 
+n_maxw
+;
+
+119 
+n_ws
+;
+
+120 } 
+	tf_te_t
+;
+
+123 
+u_t
+ 
+n_e
+;
+
+124 
+f_te_t
+ 
+n_t
+[2];
+
+125 } 
+	tf_e_t
+;
+
+132 
+	`bo
+ (*
+mch
+)(
+f_che_t
+ *, 
+f_t_t
+ *, );
+
+133 
+	`bo
+ (*
+e
+)(
+f_che_t
+ *, 
+f_t_t
+ *, 
+bo
+);
+
+134 
+f_cn_t
+ * (*
+e
+)(
+f_che_t
+ *, );
+
+135 } 
+	t_funcs_t
+;
+
+142 
+	`f_cfig_
+();
+
+143 
+	`f_cfig_fi
+();
+
+145 
+	`f_cfig_r
+();
+
+146 
+	`f_cfig_ex
+();
+
+147 
+	`f_cfig_sync
+();
+
+148 
+bo
+ 
+	`f_cfig_locked_p
+();
+
+149 
+	`f_cfig_ad_r
+();
+
+150 
+	`f_cfig_ad_ex
+();
+
+152 
+	`f_cfig_ld
+(
+f_rut_t
+ *, 
+f_bt_t
+ *,
+
+153 
+f_rut_t
+ *, 
+f_roct_t
+ *, 
+f_cndb_t
+ *, 
+bo
+);
+
+154 
+f_rut_t
+ * 
+	`f_cfig_rut
+();
+
+155 
+f_rut_t
+ * 
+	`f_cfig_tt
+();
+
+156 
+f_bt_t
+ *
+	`f_cfig_bt
+();
+
+157 
+f_roct_t
+ *
+	`f_cfig_rocs
+();
+
+158 
+bo
+ 
+	`f_deu_ss
+();
+
+160 
+	`f_wk_sys
+();
+
+161 
+	`f_wk_sysfi
+();
+
+162 
+	`f_wk_sigl
+();
+
+163 
+	`f_wk_gi
+(
+f_wkfunc_t
+);
+
+164 
+	`f_wk_uegi
+(
+f_wkfunc_t
+);
+
+166 
+	`ogch
+();
+
+167 
+	`ogdach
+();
+
+168 
+	`fl_swch
+(*);
+
+169 
+	`fl_ld
+(
+u_lg
+, *);
+
+170 
+	`fl_ve
+(
+u_lg
+, *);
+
+171 
+	`fl_ld
+(
+u_lg
+, *);
+
+172 
+	`fl_ru
+(
+u_lg
+, *);
+
+173 
+	`fl_b
+(*);
+
+175 
+	`f_s_c
+(
+f_s_t
+);
+
+176 
+	`f_s_dec
+(
+f_s_t
+);
+
+178 
+u_t
+ 
+	`f_ifm_gi
+(const *);
+
+179 
+	`f_ifm_ush
+();
+
+180 
+	`f_ifm_ch
+(
+i_t
+ *);
+
+181 
+	`f_ifm_dach
+(
+i_t
+ *);
+
+182 
+u_t
+ 
+	`f_ifm_gid
+(c 
+i_t
+ *);
+
+183 c * 
+	`f_ifm_gme
+(c 
+u_t
+);
+
+186 
+	`f_pf_gi
+(
+bo
+);
+
+187 
+	`f_pf_uegi
+(
+bo
+);
+
+188 
+bo
+ 
+	`f_pf_gied_p
+();
+
+189 
+	`f_ck_hdr
+(*, 
+mbuf
+ **, 
+i_t
+ *, );
+
+192 
+	`f_che_l
+(
+f_che_t
+ *);
+
+193 
+	`f_che
+(
+f_che_t
+ *);
+
+195 
+bo
+ 
+	`f_rwr
+(c 
+f_che_t
+ *, 
+u_t
+, c 
+f_addr_t
+ *);
+
+196 
+bo
+ 
+	`f_rwt
+(c 
+f_che_t
+ *, 
+u_t
+, c 
+_pt_t
+);
+
+197 
+bo
+ 
+	`f_rwrcksum
+(c 
+f_che_t
+ *, 
+u_t
+,
+
+198 c 
+f_addr_t
+ *, c 
+_pt_t
+);
+
+199 
+	`f__rwr
+(c 
+f_che_t
+ *, 
+u_t
+, c 
+f_addr_t
+ *,
+
+200 c 
+_addr_t
+);
+
+201 
+	`f_t66_rwr
+(c 
+f_che_t
+ *, 
+u_t
+, c 
+f_addr_t
+ *,
+
+202 
+f_tmask_t
+, 
+ut16_t
+);
+
+204 
+ut16_t
+ 
+	`f_fixup16_cksum
+(uint16_t, uint16_t, uint16_t);
+
+205 
+ut16_t
+ 
+	`f_fixup32_cksum
+(ut16_t, 
+ut32_t
+, uint32_t);
+
+206 
+ut16_t
+ 
+	`f_addr_cksum
+(ut16_t, , c 
+f_addr_t
+ *,
+
+207 c 
+f_addr_t
+ *);
+
+208 
+ut32_t
+ 
+	`f_addr_mix
+(c , c 
+f_addr_t
+ *, constpf_addr_t *);
+
+209 
+	`f_addr_cmp
+(c 
+f_addr_t
+ *, c 
+f_tmask_t
+,
+
+210 c 
+f_addr_t
+ *, c 
+f_tmask_t
+, const );
+
+211 
+	`f_addr_mask
+(c 
+f_addr_t
+ *, c 
+f_tmask_t
+,
+
+212 c , 
+f_addr_t
+ *);
+
+214 
+	`f_tw
+(c 
+f_che_t
+ *, 
+t_q
+ *,cp_seq *,
+
+215 
+ut32_t
+ *);
+
+216 
+bo
+ 
+	`f_tch_tts
+(
+f_che_t
+ *, 
+ut16_t
+ *, *);
+
+217 
+bo
+ 
+	`f_tu_block
+(
+f_che_t
+ *, const );
+
+220 
+	`f_bpf_sys
+();
+
+221 
+	`f_bpf_sysfi
+();
+
+222 
+	`f_bpf_e
+(
+f_che_t
+ *, 
+bpf_gs_t
+ *, 
+ut32_t
+ *);
+
+223 
+	`f_bpf_fr
+(
+bpf_gs_t
+ *, c *, 
+bpfj_func_t
+);
+
+224 * 
+	`f_bpf_compe
+(*, 
+size_t
+);
+
+225 
+bo
+ 
+	`f_bpf_vide
+(c *, 
+size_t
+);
+
+228 
+	`f_bt_sys
+();
+
+229 
+	`f_bt_sysfi
+();
+
+231 c 
+__s_t
+ 
+f_b_e_s
+;
+
+233 
+f_bt_t
+ *
+	`f_bt_
+(
+u_t
+);
+
+234 
+	`f_bt_deroy
+(
+f_bt_t
+ *);
+
+235 
+	`f_bt_
+(
+f_bt_t
+ *, 
+f_b_t
+ *);
+
+236 
+f_b_t
+ * 
+	`f_bt_gbyme
+(
+f_bt_t
+ *, const *);
+
+237 
+f_b_t
+ * 
+	`f_bt_gbyid
+(
+f_bt_t
+ *, 
+u_t
+);
+
+238 
+	`f_bt_ld
+(
+f_bt_t
+ *,pf_tableset_t *);
+
+239 
+	`f_bt_expt
+(c 
+f_bt_t
+ *, 
+_y_t
+);
+
+241 
+f_b_t
+ * 
+	`f_b_
+(c *, 
+u_t
+, , *, 
+size_t
+);
+
+242 
+	`f_b_deroy
+(
+f_b_t
+ *);
+
+244 
+	`f_b_check
+(
+f_bt_t
+ *, c *, 
+u_t
+, );
+
+245 
+	`f_b_
+(
+f_b_t
+ *, const ,
+
+246 c 
+f_addr_t
+ *, c 
+f_tmask_t
+);
+
+247 
+	`f_b_move
+(
+f_b_t
+ *, const ,
+
+248 c 
+f_addr_t
+ *, c 
+f_tmask_t
+);
+
+249 
+	`f_b_lookup
+(
+f_b_t
+ *, c , c 
+f_addr_t
+ *);
+
+250 
+	`f_b_li
+(
+f_b_t
+ *, *, 
+size_t
+);
+
+251 
+	`f_b_ush
+(
+f_b_t
+ *);
+
+254 
+f_rut_t
+ * 
+	`f_rut_
+(
+size_t
+);
+
+255 
+	`f_rut_deroy
+(
+f_rut_t
+ *);
+
+256 
+	`f_rut_
+(
+f_rut_t
+ *, 
+f_ru_t
+ *);
+
+257 
+	`f_rut_ld
+(
+f_rut_t
+ *,pf_rut_*, 
+bo
+);
+
+258 
+f_ru_t
+ * 
+	`f_rut_shm
+(
+f_rut_t
+ *, 
+f_icy_t
+ *);
+
+259 
+f_icy_t
+ *
+	`f_rut_fdt
+(
+f_rut_t
+ *, 
+ut64_t
+);
+
+260 
+	`f_rut_g
+(
+f_rut_t
+ *, 
+f_g_t
+ *);
+
+261 
+	`f_rut_expt
+(c 
+f_rut_t
+ *, 
+_y_t
+);
+
+263 
+	`f_rut_add
+(
+f_rut_t
+ *, c *, 
+f_ru_t
+ *);
+
+264 
+	`f_rut_move
+(
+f_rut_t
+ *, c *, 
+ut64_t
+);
+
+265 
+	`f_rut_mkey
+(
+f_rut_t
+ *, const *,
+
+266 c *, 
+size_t
+);
+
+267 
+_diiy_t
+ 
+	`f_rut_li
+(
+f_rut_t
+ *, const *);
+
+268 
+	`f_rut_ush
+(
+f_rut_t
+ *, const *);
+
+269 
+	`f_rut_gc
+(
+f_rut_t
+ *);
+
+271 
+f_ru_t
+ * 
+	`f_rut_e
+(
+f_che_t
+ *, c 
+f_rut_t
+ *,
+
+273 
+	`f_ru_cude
+(c 
+f_ru_t
+ *, *);
+
+276 
+f_ru_t
+ * 
+	`f_ru_loc
+(
+_diiy_t
+);
+
+277 
+	`f_ru_tcode
+(
+f_ru_t
+ *, , *, 
+size_t
+);
+
+278 
+	`f_ru_oc
+(
+f_ru_t
+ *, 
+f_roc_t
+ *);
+
+279 
+	`f_ru_
+(
+f_ru_t
+ *);
+
+280 
+ut64_t
+ 
+	`f_ru_gid
+(c 
+f_ru_t
+ *);
+
+281 
+f_icy_t
+ *
+	`f_ru_gt
+(c 
+f_ru_t
+ *);
+
+282 
+	`f_ru_
+(
+f_ru_t
+ *, 
+f_icy_t
+ *);
+
+283 
+f_roc_t
+ * 
+	`f_ru_groc
+(c 
+f_ru_t
+ *);
+
+285 
+	`f_ext_sys
+();
+
+286 
+	`f_ext_sysfi
+();
+
+287 
+	`f_ext_cru
+(const *,
+
+288 
+f_roc_t
+ *, 
+_diiy_t
+);
+
+290 
+f_roct_t
+ *
+	`f_roct_
+();
+
+291 
+	`f_roct_deroy
+(
+f_roct_t
+ *);
+
+292 
+f_roc_t
+ * 
+	`f_roct_lookup
+(
+f_roct_t
+ *, const *);
+
+293 
+	`f_roct_
+(
+f_roct_t
+ *, 
+f_roc_t
+ *);
+
+294 
+	`f_roct_expt
+(c 
+f_roct_t
+ *, 
+_y_t
+);
+
+296 
+f_roc_t
+ * 
+	`f_roc_
+(
+_diiy_t
+);
+
+297 
+	`f_roc_acque
+(
+f_roc_t
+ *);
+
+298 
+	`f_roc_a
+(
+f_roc_t
+ *);
+
+299 
+bo
+ 
+	`f_roc_run
+(
+f_che_t
+ *, 
+f_roc_t
+ *, *);
+
+302 
+bo
+ 
+	`f_e_
+(
+f_che_t
+ *, 
+f_e_t
+ *);
+
+303 
+bo
+ 
+	`f_e_e
+(
+f_che_t
+ *, 
+f_e_t
+ *, const bool);
+
+304 
+	`f_e_ime
+(c 
+f_e_t
+ *, const );
+
+305 
+	`f_e_deroy
+(
+f_e_t
+ *);
+
+307 
+bo
+ 
+	`f_e_t
+(
+f_che_t
+ *, 
+f_e_t
+ *, );
+
+308 
+	`f_e_t_timeout
+(c 
+f_e_t
+ *);
+
+311 
+	`f_t_sys
+();
+
+312 
+	`f_t_sysfi
+();
+
+313 
+f_icy_t
+ *
+	`f_t_wpicy
+(
+_diiy_t
+, 
+f_rut_t
+ *);
+
+314 
+	`f_t_picyexpt
+(c 
+f_icy_t
+ *, 
+_diiy_t
+);
+
+315 
+	`f_t_picy
+(
+f_icy_t
+ *);
+
+316 
+bo
+ 
+	`f_t_cmicy
+(
+f_icy_t
+ *,pf_natpolicy_t *);
+
+317 
+bo
+ 
+	`f_t_shm
+(
+f_icy_t
+ *,pf_natpolicy_t *);
+
+318 
+	`f_t_tid
+(
+f_icy_t
+ *, 
+ut64_t
+);
+
+319 
+ut64_t
+ 
+	`f_t_gid
+(c 
+f_icy_t
+ *);
+
+320 
+	`f_t_g
+(
+f_icy_t
+ *, 
+f_g_t
+ *);
+
+322 
+	`f_do_t
+(
+f_che_t
+ *, 
+f_cn_t
+ *, const );
+
+323 
+	`f_t_deroy
+(
+f_t_t
+ *);
+
+324 
+	`f_t_gig
+(
+f_t_t
+ *, 
+f_addr_t
+ **, 
+_pt_t
+ *);
+
+325 
+	`f_t_gs
+(
+f_t_t
+ *, 
+f_addr_t
+ **, 
+_pt_t
+ *);
+
+326 
+	`f_t_lg
+(
+f_t_t
+ *, 
+f_g_t
+ *, 
+u_t
+);
+
+328 
+	`f_t_expt
+(
+_diiy_t
+, 
+f_t_t
+ *);
+
+329 
+f_t_t
+ * 
+	`f_t_impt
+(
+_diiy_t
+, 
+f_rut_t
+ *,
+
+330 
+f_cn_t
+ *);
+
+333 
+	`f_g_sys
+();
+
+334 
+	`f_g_sysfi
+();
+
+335 
+f_g_t
+ * 
+	`f_g_gi
+(c *, c 
+_funcs_t
+ *);
+
+336 
+	`f_g_uegi
+(
+f_g_t
+ *);
+
+337 
+f_g_t
+ * 
+	`f_g_cru
+(const *);
+
+338 
+bo
+ 
+	`f_g_mch
+(
+f_che_t
+ *, 
+f_t_t
+ *, );
+
+339 
+	`f_g_exec
+(
+f_che_t
+ *, 
+f_t_t
+ *, 
+bo
+);
+
+340 
+f_cn_t
+ * 
+	`f_g_cn
+(
+f_che_t
+ *, );
+
+341 
+_y_t
+ 
+	`f_g_expt
+();
+
+344 c * 
+	`f_addr_dump
+(c 
+f_addr_t
+ *, );
+
+345 
+	`f_e_dump
+(c 
+f_e_t
+ *);
+
+346 
+	`f_t_dump
+(c 
+f_t_t
+ *);
+
+347 
+	`f_rut_dump
+(const *);
+
+348 
+	`f_e_tm
+((*)(
+f_e_t
+ *, 
+bo
+));
+
+	@npf/npf_inet.c
+
+41 
+	~<sys/cdefs.h
+>
+
+42 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_inet.c,v 1.32 2014/07/20 00:37:41mind Exp $");
+
+44 
+	~<sys/m.h
+>
+
+45 
+	~<sys/tys.h
+>
+
+47 
+	~<t/pf.h
+>
+
+48 
+	~<t/if.h
+>
+
+49 
+	~<t/htys.h
+>
+
+50 
+	~<t/if_h.h
+>
+
+52 
+	~<t/_sym.h
+>
+
+53 
+	~<t/.h
+>
+
+54 
+	~<t/.h
+>
+
+55 
+	~<t/6.h
+>
+
+56 
+	~<t/t.h
+>
+
+57 
+	~<t/udp.h
+>
+
+58 
+	~<t/_icmp.h
+>
+
+60 
+	~"f_im.h
+"
+
+66 
+ut16_t
+
+
+67 
+	$f_fixup16_cksum
+(
+ut16_t
+ 
+cksum
+, ut16_
+odum
+, ut16_
+ndum
+)
+
+69 
+ut32_t
+ 
+sum
+;
+
+77 
+sum
+ = ~
+cksum
+ & 0xffff;
+
+78 
+sum
+ +(~
+odum
+ & 0xffff+ 
+ndum
+;
+
+79 
+sum
+ = (sum >> 16) + (sum & 0xffff);
+
+80 
+sum
+ += (sum >> 16);
+
+82  ~
+sum
+ & 0xffff;
+
+83 
+	}
+}
+
+85 
+ut16_t
+
+
+86 
+	$f_fixup32_cksum
+(
+ut16_t
+ 
+cksum
+, 
+ut32_t
+ 
+odum
+, ut32_
+ndum
+)
+
+88 
+ut32_t
+ 
+sum
+;
+
+94 
+sum
+ = ~
+cksum
+ & 0xffff;
+
+95 
+sum
+ +(~
+odum
+ & 0xffff+ (
+ndum
+ & 0xffff);
+
+97 
+sum
+ +(~
+odum
+ >> 16+ (
+ndum
+ >> 16);
+
+98 
+sum
+ = (sum >> 16) + (sum & 0xffff);
+
+99 
+sum
+ += (sum >> 16);
+
+100  ~
+sum
+ & 0xffff;
+
+101 
+	}
+}
+
+106 
+ut16_t
+
+
+107 
+	$f_addr_cksum
+(
+ut16_t
+ 
+cksum
+, 
+sz
+, c 
+f_addr_t
+ *
+ddr
+,
+
+108 c 
+f_addr_t
+ *
+ddr
+)
+
+110 c 
+ut32_t
+ *
+o32
+ = (c ut32_*)
+ddr
+;
+
+111 c 
+ut32_t
+ *
+n32
+ = (c ut32_*)
+ddr
+;
+
+113 
+	`KASSERT
+(
+sz
+ % (
+ut32_t
+) == 0);
+
+115 
+cksum
+ = 
+	`f_fixup32_cksum
+(cksum, *
+o32
+++, *
+n32
+++);
+
+116 
+sz
+ -(
+ut32_t
+);
+
+117 } 
+sz
+);
+
+119  
+cksum
+;
+
+120 
+	}
+}
+
+126 
+ut32_t
+
+
+127 
+	$f_addr_mix
+(c 
+sz
+, c 
+f_addr_t
+ *
+a1
+, cpf_addr_*
+a2
+)
+
+129 
+ut32_t
+ 
+mix
+ = 0;
+
+131 
+	`KASSERT
+(
+sz
+ > 0 && 
+a1
+ !
+NULL
+ && 
+a2
+ != NULL);
+
+133 
+i
+ = 0; i < (
+sz
+ >> 2); i++) {
+
+134 
+mix
+ ^
+a1
+->
+s6_addr32
+[
+i
+];
+
+135 
+mix
+ ^
+a2
+->
+s6_addr32
+[
+i
+];
+
+137  
+mix
+;
+
+138 
+	}
+}
+
+144 
+	$f_addr_mask
+(c 
+f_addr_t
+ *
+addr
+, c 
+f_tmask_t
+ 
+mask
+,
+
+145 c 
+
+, 
+f_addr_t
+ *
+out
+)
+
+147 c 
+nwds
+ = 
+
+ >> 2;
+
+148 
+ut_8_t
+ 
+ngth
+ = 
+mask
+;
+
+151 
+	`KASSERT
+(
+ngth
+ <
+NPF_MAX_NETMASK
+);
+
+153 
+i
+ = 0; i < 
+nwds
+; i++) {
+
+154 
+ut32_t
+ 
+wdmask
+;
+
+156 i(
+ngth
+ >= 32) {
+
+157 
+wdmask
+ = 
+	`htl
+(0xffffffff);
+
+158 
+ngth
+ -= 32;
+
+159 } i(
+ngth
+) {
+
+160 
+wdmask
+ = 
+	`htl
+(0xfffffff<< (32 - 
+ngth
+));
+
+161 
+ngth
+ = 0;
+
+163 
+wdmask
+ = 0;
+
+165 
+out
+->
+s6_addr32
+[
+i
+] = 
+addr
+->s6_addr32[i] & 
+wdmask
+;
+
+167 
+	}
+}
+
+176 
+	$f_addr_cmp
+(c 
+f_addr_t
+ *
+addr1
+, c 
+f_tmask_t
+ 
+mask1
+,
+
+177 c 
+f_addr_t
+ *
+addr2
+, c 
+f_tmask_t
+ 
+mask2
+, c 
+
+)
+
+179 
+f_addr_t
+ 
+addr1
+, 
+addr2
+;
+
+181 i(
+mask1
+ !
+NPF_NO_NETMASK
+) {
+
+182 
+	`f_addr_mask
+(
+addr1
+, 
+mask1
+, 
+
+, &
+addr1
+);
+
+183 
+addr1
+ = &
+addr1
+;
+
+185 i(
+mask2
+ !
+NPF_NO_NETMASK
+) {
+
+186 
+	`f_addr_mask
+(
+addr2
+, 
+mask2
+, 
+
+, &
+addr2
+);
+
+187 
+addr2
+ = &
+addr2
+;
+
+189  
+	`memcmp
+(
+addr1
+, 
+addr2
+, 
+
+);
+
+190 
+	}
+}
+
+198 
+	$f_tw
+(c 
+f_che_t
+ *
+c
+, 
+t_q
+ *
+q
+,_q *
+ack
+, 
+ut32_t
+ *
+w
+)
+
+200 c 
+thdr
+ *
+th
+ = 
+c
+->
+c_l4
+.
+t
+;
+
+201 
+u_t
+ 
+thn
+;
+
+203 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_TCP
+));
+
+205 *
+q
+ = 
+	`ohl
+(
+th
+->
+th_q
+);
+
+206 *
+ack
+ = 
+	`ohl
+(
+th
+->
+th_ack
+);
+
+207 *
+w
+ = (
+ut32_t
+)
+	`ohs
+(
+th
+->
+th_w
+);
+
+208 
+thn
+ = 
+th
+->
+th_off
+ << 2;
+
+210 i(
+	`f_isched
+(
+c
+, 
+NPC_IP4
+)) {
+
+211 c 
+
+ * = 
+c
+->
+c_
+.
+v4
+;
+
+212  
+	`ohs
+(
+
+->
+_n
+- 
+c
+->
+c_hn
+ - 
+thn
+;
+
+213 } i(
+	`f_isched
+(
+c
+, 
+NPC_IP6
+)) {
+
+214 c 
+6_hdr
+ *
+6
+ = 
+c
+->
+c_
+.
+v6
+;
+
+215  
+	`ohs
+(
+6
+->
+6_
+- 
+thn
+;
+
+218 
+	}
+}
+
+223 
+bo
+
+
+224 
+	$f_tch_tts
+(
+f_che_t
+ *
+c
+, 
+ut16_t
+ *
+mss
+, *
+ws
+)
+
+226 
+nbuf_t
+ *
+nbuf
+ = 
+c
+->
+c_nbuf
+;
+
+227 c 
+thdr
+ *
+th
+ = 
+c
+->
+c_l4
+.
+t
+;
+
+228 
+tts_n
+, 
+
+;
+
+229 *
+
+;
+
+230 
+ut8_t
+ 
+v
+;
+
+231 
+bo
+ 
+ok
+;
+
+233 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_IP46
+));
+
+234 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_TCP
+));
+
+237 
+tts_n
+ = (
+th
+->
+th_off
+ << 2- (
+thdr
+);
+
+238 i(
+tts_n
+ <= 0) {
+
+240  
+l
+;
+
+242 
+	`KASSERT
+(
+tts_n
+ <
+MAX_TCPOPTLEN
+);
+
+245 
+
+ = 
+c
+->
+c_hn
+ + (
+thdr
+);
+
+246 
+	`nbuf_t
+(
+nbuf
+);
+
+247 
+xt
+:
+
+248 i((
+
+ = 
+	`nbuf_adv
+(
+nbuf
+, 
+
+, 1)=
+NULL
+) {
+
+249 
+ok
+ = 
+l
+;
+
+250 
+de
+;
+
+252 
+v
+ = *(
+ut8_t
+ *)
+
+;
+
+254 
+v
+) {
+
+255 
+TCPOPT_EOL
+:
+
+257 
+ok
+ = 
+ue
+;
+
+258 
+de
+;
+
+259 
+TCPOPT_NOP
+:
+
+260 
+tts_n
+--;
+
+261 
+
+ = 1;
+
+263 
+TCPOPT_MAXSEG
+:
+
+264 i((
+
+ = 
+	`nbuf_adv
+(
+nbuf
+, 2, 2)=
+NULL
+) {
+
+265 
+ok
+ = 
+l
+;
+
+266 
+de
+;
+
+268 i(
+mss
+) {
+
+269 i(*
+mss
+) {
+
+270 
+	`memy
+(
+
+, 
+mss
+, (
+ut16_t
+));
+
+272 
+	`memy
+(
+mss
+, 
+
+, (
+ut16_t
+));
+
+275 
+tts_n
+ -
+TCPOLEN_MAXSEG
+;
+
+276 
+
+ = 2;
+
+278 
+TCPOPT_WINDOW
+:
+
+280 i((
+
+ = 
+	`nbuf_adv
+(
+nbuf
+, 2, 1)=
+NULL
+) {
+
+281 
+ok
+ = 
+l
+;
+
+282 
+de
+;
+
+284 
+v
+ = *(
+ut8_t
+ *)
+
+;
+
+285 *
+ws
+ = (
+v
+ > 
+TCP_MAX_WINSHIFT
+) ? TCP_MAX_WINSHIFT : val;
+
+286 
+tts_n
+ -
+TCPOLEN_WINDOW
+;
+
+287 
+
+ = 1;
+
+290 i((
+
+ = 
+	`nbuf_adv
+(
+nbuf
+, 1, 1)=
+NULL
+) {
+
+291 
+ok
+ = 
+l
+;
+
+292 
+de
+;
+
+294 
+v
+ = *(
+ut8_t
+ *)
+
+;
+
+295 i(
+v
+ < 2 || v > 
+tts_n
+) {
+
+296 
+ok
+ = 
+l
+;
+
+297 
+de
+;
+
+299 
+tts_n
+ -
+v
+;
+
+300 
+
+ = 
+v
+ - 1;
+
+304 i(
+	`__edi_ue
+(
+tts_n
+ > 0)) {
+
+305 
+xt
+;
+
+307 
+ok
+ = 
+ue
+;
+
+308 
+de
+:
+
+309 i(
+	`nbuf_ag_p
+(
+nbuf
+, 
+NBUF_DATAREF_RESET
+)) {
+
+310 
+	`f_che
+(
+c
+);
+
+312  
+ok
+;
+
+313 
+	}
+}
+
+316 
+	$f_che_
+(
+f_che_t
+ *
+c
+, 
+nbuf_t
+ *
+nbuf
+)
+
+318 c *
+
+ = 
+	`nbuf_d
+(
+nbuf
+);
+
+319 c 
+ut8_t
+ 
+v
+ = *(c ut8_*)
+
+;
+
+320 
+ags
+ = 0;
+
+322 
+v
+ >> 4) {
+
+323 
+IPVERSION
+: {
+
+324 
+
+ *ip;
+
+326 
+
+ = 
+	`nbuf_su_ctig
+(
+nbuf
+, (ip));
+
+327 i(
+
+ =
+NULL
+) {
+
+332 i((
+u_t
+)(
+
+->
+_hl
+ << 2) < (ip)) {
+
+335 i(
+
+->
+_off
+ & ~
+	`hts
+(
+IP_DF
+ | 
+IP_RF
+)) {
+
+337 
+ags
+ |
+NPC_IPFRAG
+;
+
+341 
+c
+->
+c_
+ = (
+_addr
+);
+
+342 
+c
+->
+c_s
+[
+NPF_SRC
+] = (
+f_addr_t
+ *)&
+
+->
+_c
+;
+
+343 
+c
+->
+c_s
+[
+NPF_DST
+] = (
+f_addr_t
+ *)&
+
+->
+_d
+;
+
+344 
+c
+->
+c_hn
+ = 
+
+->
+_hl
+ << 2;
+
+345 
+c
+->
+c_o
+ = 
+
+->
+_p
+;
+
+347 
+c
+->
+c_
+.
+v4
+ = 
+
+;
+
+348 
+ags
+ |
+NPC_IP4
+;
+
+352 (
+IPV6_VERSION
+ >> 4): {
+
+353 
+6_hdr
+ *
+6
+;
+
+354 
+6_ext
+ *
+6e
+;
+
+355 
+size_t
+ 
+off
+, 
+hn
+;
+
+357 
+6
+ = 
+	`nbuf_su_ctig
+(
+nbuf
+, (
+6_hdr
+));
+
+358 i(
+6
+ =
+NULL
+) {
+
+363 
+hn
+ = (
+6_hdr
+);
+
+364 
+c
+->
+c_o
+ = 
+6
+->
+6_nxt
+;
+
+365 
+c
+->
+c_hn
+ = 
+hn
+;
+
+370 
+off
+ = 
+	`nbuf_offt
+(
+nbuf
+);
+
+371 
+	`nbuf_adv
+(
+nbuf
+, 
+hn
+, 0!
+NULL
+) {
+
+372 
+6e
+ = 
+	`nbuf_su_ctig
+(
+nbuf
+, (*ip6e));
+
+373 i(
+6e
+ =
+NULL
+) {
+
+380 
+c
+->
+c_o
+) {
+
+381 
+IPPROTO_HOPOPTS
+:
+
+382 
+IPPROTO_DSTOPTS
+:
+
+383 
+IPPROTO_ROUTING
+:
+
+384 
+hn
+ = (
+6e
+->
+6e_n
+ + 1) << 3;
+
+386 
+IPPROTO_FRAGMENT
+:
+
+387 
+hn
+ = (
+6_ag
+);
+
+388 
+ags
+ |
+NPC_IPFRAG
+;
+
+390 
+IPPROTO_AH
+:
+
+391 
+hn
+ = (
+6e
+->
+6e_n
+ + 2) << 2;
+
+394 
+hn
+ = 0;
+
+398 i(!
+hn
+) {
+
+401 
+c
+->
+c_o
+ = 
+6e
+->
+6e_nxt
+;
+
+402 
+c
+->
+c_hn
+ +
+hn
+;
+
+409 
+	`nbuf_t
+(
+nbuf
+);
+
+410 
+6
+ = 
+	`nbuf_d
+(
+nbuf
+);
+
+411 i(
+off
+) {
+
+412 
+	`nbuf_adv
+(
+nbuf
+, 
+off
+, 0);
+
+416 
+c
+->
+c_
+ = (
+6_addr
+);
+
+417 
+c
+->
+c_s
+[
+NPF_SRC
+] = (
+f_addr_t
+ *)&
+6
+->
+6_c
+;
+
+418 
+c
+->
+c_s
+[
+NPF_DST
+](
+f_addr_t
+ *)&
+6
+->
+6_d
+;
+
+420 
+c
+->
+c_
+.
+v6
+ = 
+6
+;
+
+421 
+ags
+ |
+NPC_IP6
+;
+
+427  
+ags
+;
+
+428 
+	}
+}
+
+437 
+	$f_che_l
+(
+f_che_t
+ *
+c
+)
+
+439 
+nbuf_t
+ *
+nbuf
+ = 
+c
+->
+c_nbuf
+;
+
+440 
+ags
+, 
+l4ags
+;
+
+441 
+u_t
+ 
+hn
+;
+
+447 
+aga
+:
+
+448 
+	`nbuf_unt_ag
+(
+nbuf
+, 
+NBUF_DATAREF_RESET
+);
+
+454 
+ags
+ = 
+	`f_che_
+(
+c
+, 
+nbuf
+);
+
+455 i((
+ags
+ & 
+NPC_IP46
+=0 || (ag& 
+NPC_IPFRAG
+) != 0) {
+
+456 
+	`nbuf_unt_ag
+(
+nbuf
+, 
+NBUF_DATAREF_RESET
+);
+
+457 
+c
+->
+c_fo
+ |
+ags
+;
+
+458  
+ags
+;
+
+460 
+hn
+ = 
+c
+->
+c_hn
+;
+
+462 
+c
+->
+c_o
+) {
+
+463 
+IPPROTO_TCP
+:
+
+465 
+c
+->
+c_l4
+.
+t
+ = 
+	`nbuf_adv
+(
+nbuf
+, 
+hn
+,
+
+466 (
+thdr
+));
+
+467 
+l4ags
+ = 
+NPC_LAYER4
+ | 
+NPC_TCP
+;
+
+469 
+IPPROTO_UDP
+:
+
+471 
+c
+->
+c_l4
+.
+udp
+ = 
+	`nbuf_adv
+(
+nbuf
+, 
+hn
+,
+
+472 (
+udphdr
+));
+
+473 
+l4ags
+ = 
+NPC_LAYER4
+ | 
+NPC_UDP
+;
+
+475 
+IPPROTO_ICMP
+:
+
+477 
+c
+->
+c_l4
+.
+icmp
+ = 
+	`nbuf_adv
+(
+nbuf
+, 
+hn
+,
+
+478 
+	`offtof
+(
+icmp
+, 
+icmp_void
+));
+
+479 
+l4ags
+ = 
+NPC_LAYER4
+ | 
+NPC_ICMP
+;
+
+481 
+IPPROTO_ICMPV6
+:
+
+483 
+c
+->
+c_l4
+.
+icmp6
+ = 
+	`nbuf_adv
+(
+nbuf
+, 
+hn
+,
+
+484 
+	`offtof
+(
+icmp6_hdr
+, 
+icmp6_da32
+));
+
+485 
+l4ags
+ = 
+NPC_LAYER4
+ | 
+NPC_ICMP
+;
+
+488 
+l4ags
+ = 0;
+
+492 i(
+	`nbuf_ag_p
+(
+nbuf
+, 
+NBUF_DATAREF_RESET
+)) {
+
+493 
+aga
+;
+
+497 i(
+l4ags
+ && 
+c
+->
+c_l4
+.
+hdr
+) {
+
+498 
+ags
+ |
+l4ags
+;
+
+500 
+c
+->
+c_fo
+ |
+ags
+;
+
+501  
+ags
+;
+
+502 
+	}
+}
+
+505 
+	$f_che
+(
+f_che_t
+ *
+c
+)
+
+507 
+nbuf_t
+ *
+nbuf
+ = 
+c
+->
+c_nbuf
+;
+
+508 c 
+mags
+ 
+__dgud
+ = 
+c
+->
+c_fo
+ & (
+NPC_IP46
+ | 
+NPC_LAYER4
+);
+
+509 
+ags
+ 
+__dgud
+;
+
+511 
+	`nbuf_t
+(
+nbuf
+);
+
+512 
+c
+->
+c_fo
+ = 0;
+
+513 
+ags
+ = 
+	`f_che_l
+(
+c
+);
+
+515 
+	`KASSERT
+((
+ags
+ & 
+mags
+) == mflags);
+
+516 
+	`KASSERT
+(
+	`nbuf_ag_p
+(
+nbuf
+, 
+NBUF_DATAREF_RESET
+) == 0);
+
+517 
+	}
+}
+
+522 
+bo
+
+
+523 
+	$f_rwr
+(c 
+f_che_t
+ *
+c
+, 
+u_t
+ 
+which
+, c 
+f_addr_t
+ *
+addr
+)
+
+525 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_IP46
+));
+
+526 
+	`KASSERT
+(
+which
+ =
+NPF_SRC
+ || which =
+NPF_DST
+);
+
+528 
+	`memy
+(
+c
+->
+c_s
+[
+which
+], 
+addr
+,pc->
+c_
+);
+
+529  
+ue
+;
+
+530 
+	}
+}
+
+535 
+bo
+
+
+536 
+	$f_rwt
+(c 
+f_che_t
+ *
+c
+, 
+u_t
+ 
+which
+, c 
+_pt_t
+ 
+pt
+)
+
+538 c 
+o
+ = 
+c
+->
+c_o
+;
+
+539 
+_pt_t
+ *
+t
+;
+
+541 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_TCP
+||pf_ischedpc, 
+NPC_UDP
+));
+
+542 
+	`KASSERT
+(
+o
+ =
+IPPROTO_TCP
+ ||r=
+IPPROTO_UDP
+);
+
+543 
+	`KASSERT
+(
+which
+ =
+NPF_SRC
+ || which =
+NPF_DST
+);
+
+546 i(
+o
+ =
+IPPROTO_TCP
+) {
+
+547 
+thdr
+ *
+th
+ = 
+c
+->
+c_l4
+.
+t
+;
+
+548 
+t
+ = (
+which
+ =
+NPF_SRC
+? &
+th
+->
+th_t
+ : &th->
+th_dpt
+;
+
+550 
+udphdr
+ *
+uh
+ = 
+c
+->
+c_l4
+.
+udp
+;
+
+551 
+t
+ = (
+which
+ =
+NPF_SRC
+? &
+uh
+->
+uh_t
+ : &uh->
+uh_dpt
+;
+
+553 
+	`memy
+(
+t
+, &
+pt
+, (
+_pt_t
+));
+
+554  
+ue
+;
+
+555 
+	}
+}
+
+560 
+bo
+
+
+561 
+	$f_rwrcksum
+(c 
+f_che_t
+ *
+c
+, 
+u_t
+ 
+which
+,
+
+562 c 
+f_addr_t
+ *
+addr
+, c 
+_pt_t
+ 
+pt
+)
+
+564 c 
+f_addr_t
+ *
+ddr
+ = 
+c
+->
+c_s
+[
+which
+];
+
+565 c 
+o
+ = 
+c
+->
+c_o
+;
+
+566 c 
+
+ = 
+c
+->
+c_
+;
+
+567 
+ut16_t
+ *
+ocksum
+;
+
+568 
+_pt_t
+ 
+t
+;
+
+570 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_LAYER4
+));
+
+571 
+	`KASSERT
+(
+which
+ =
+NPF_SRC
+ || which =
+NPF_DST
+);
+
+573 i(
+	`f_isched
+(
+c
+, 
+NPC_IP4
+)) {
+
+574 
+
+ * = 
+c
+->
+c_
+.
+v4
+;
+
+575 
+ut16_t
+ 
+sum
+ = 
+
+->
+_sum
+;
+
+578 
+
+->
+_sum
+ = 
+	`f_addr_cksum
+(
+sum
+, 
+
+, 
+ddr
+, 
+addr
+);
+
+581 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_IP6
+));
+
+585 i(
+o
+ =
+IPPROTO_ICMP
+ ||r=
+IPPROTO_ICMPV6
+) {
+
+586  
+ue
+;
+
+588 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_TCP
+||pf_ischedpc, 
+NPC_UDP
+));
+
+596 i(
+o
+ =
+IPPROTO_TCP
+) {
+
+597 
+thdr
+ *
+th
+ = 
+c
+->
+c_l4
+.
+t
+;
+
+599 
+ocksum
+ = &
+th
+->
+th_sum
+;
+
+600 
+t
+ = (
+which
+ =
+NPF_SRC
+? 
+th
+->
+th_t
+ :h->
+th_dpt
+;
+
+602 
+udphdr
+ *
+uh
+ = 
+c
+->
+c_l4
+.
+udp
+;
+
+604 
+	`KASSERT
+(
+o
+ =
+IPPROTO_UDP
+);
+
+605 
+ocksum
+ = &
+uh
+->
+uh_sum
+;
+
+606 i(*
+ocksum
+ == 0) {
+
+608  
+ue
+;
+
+610 
+t
+ = (
+which
+ =
+NPF_SRC
+? 
+uh
+->
+uh_t
+ : uh->
+uh_dpt
+;
+
+613 
+ut16_t
+ 
+cksum
+ = 
+	`f_addr_cksum
+(*
+ocksum
+, 
+
+, 
+ddr
+, 
+addr
+);
+
+614 i(
+pt
+) {
+
+615 
+cksum
+ = 
+	`f_fixup16_cksum
+(cksum, 
+t
+, 
+pt
+);
+
+619 
+	`memy
+(
+ocksum
+, &
+cksum
+, (
+ut16_t
+));
+
+620  
+ue
+;
+
+621 
+	}
+}
+
+627 
+	$f__rwr
+(c 
+f_che_t
+ *
+c
+, 
+u_t
+ 
+which
+,
+
+628 c 
+f_addr_t
+ *
+addr
+, c 
+_addr_t
+ 
+pt
+)
+
+630 c 
+o
+ = 
+c
+->
+c_o
+;
+
+637 i(!
+	`f_rwrcksum
+(
+c
+, 
+which
+, 
+addr
+, 
+pt
+)) {
+
+638  
+EINVAL
+;
+
+640 i(!
+	`f_rwr
+(
+c
+, 
+which
+, 
+addr
+)) {
+
+641  
+EINVAL
+;
+
+643 i(
+pt
+ == 0) {
+
+648 
+o
+) {
+
+649 
+IPPROTO_TCP
+:
+
+650 
+IPPROTO_UDP
+:
+
+652 i(!
+	`f_rwt
+(
+c
+, 
+which
+, 
+pt
+)) {
+
+653  
+EINVAL
+;
+
+656 
+IPPROTO_ICMP
+:
+
+657 
+IPPROTO_ICMPV6
+:
+
+658 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_ICMP
+));
+
+662  
+ENOTSUP
+;
+
+665 
+	}
+}
+
+672 
+	$f_t66_rwr
+(c 
+f_che_t
+ *
+c
+, 
+u_t
+ 
+which
+, c 
+f_addr_t
+ *
+ef
+,
+
+673 
+f_tmask_t
+ 
+n
+, 
+ut16_t
+ 
+adj
+)
+
+675 
+f_addr_t
+ *
+addr
+ = 
+c
+->
+c_s
+[
+which
+];
+
+676 
+m
+, 
+wd
+, 
+e
+ = 
+n
+ >> 4;
+
+677 
+ut32_t
+ 
+sum
+;
+
+679 
+	`KASSERT
+(
+which
+ =
+NPF_SRC
+ || which =
+NPF_DST
+);
+
+681 i(!
+	`f_isched
+(
+c
+, 
+NPC_IP6
+)) {
+
+682  
+EINVAL
+;
+
+684 i(
+n
+ <= 48) {
+
+689 
+wd
+ = 3;
+
+690 i(
+addr
+->
+s6_addr16
+[
+wd
+] == 0xffff) {
+
+691  
+EINVAL
+;
+
+698 i((
+addr
+->
+s6_addr32
+[2] == 0 &&ddr->s6_addr32[3] == 0) ||
+
+699 (
+addr
+->
+s6_addr32
+[2] == ~0U &&ddr->s6_addr32[3] == ~0U))
+
+700  
+EINVAL
+;
+
+703 
+wd
+ = 4; word < 8; word++)
+
+704 i(
+addr
+->
+s6_addr16
+[
+wd
+] != 0xffff)
+
+709 
+i
+ = 0; i < 
+e
+; i++) {
+
+710 
+addr
+->
+s6_addr16
+[
+i
+] = 
+ef
+->s6_addr16[i];
+
+717 i((
+m
+ = 
+n
+ - (
+e
+ << 4)) != 0) {
+
+718 c 
+ut16_t
+ 
+wdmask
+ = (1U << 
+m
+) - 1;
+
+719 c 
+i
+ = 
+e
+;
+
+721 
+addr
+->
+s6_addr16
+[
+i
+] = (
+ef
+->s6_addr16[i] & 
+wdmask
+) |
+
+722 (
+addr
+->
+s6_addr16
+[
+i
+] & ~
+wdmask
+);
+
+728 
+sum
+ = 
+addr
+->
+s6_addr16
+[
+wd
+] + 
+adj
+;
+
+729 
+sum
+ >> 16) {
+
+730 
+sum
+ = (sum >> 16) + (sum & 0xffff);
+
+732 i(
+sum
+ == 0xffff) {
+
+734 
+sum
+ = 0x0000;
+
+736 
+addr
+->
+s6_addr16
+[
+wd
+] = 
+sum
+;
+
+738 
+	}
+}
+
+740 #i
+defed
+(
+DDB
+|| defed(
+_NPF_TESTING
+)
+
+743 
+	$f_addr_dump
+(c 
+f_addr_t
+ *
+addr
+, 
+
+)
+
+745 i(
+
+ =(
+_addr
+)) {
+
+746 
+_addr
+ 
+
+;
+
+747 
+	`memy
+(&
+
+, 
+addr
+, 
+
+);
+
+748  
+	`_
+(
+
+);
+
+751 
+	}
+}
+
+	@npf/npf_mbuf.c
+
+39 
+	~<sys/cdefs.h
+>
+
+40 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_mbuf.c,v 1.13 2014/08/10 19:09:43mind Exp $");
+
+42 
+	~<sys/m.h
+>
+
+43 
+	~<sys/mbuf.h
+>
+
+45 
+	~"f_im.h
+"
+
+47 
+	#NBUF_ENSURE_ALIGN
+ (
+	`MAX
+(
+COHERENCY_UNIT
+, 64))
+
+	)
+
+48 
+	#NBUF_ENSURE_MASK
+ (
+NBUF_ENSURE_ALIGN
+ - 1)
+
+	)
+
+49 
+	#NBUF_ENSURE_ROUNDUP
+(
+x
+(((x+ 
+NBUF_ENSURE_ALIGN
+& ~
+NBUF_ENSURE_MASK
+)
+
+	)
+
+52 
+	$nbuf_
+(
+nbuf_t
+ *
+nbuf
+, 
+mbuf
+ *
+m
+, c 
+i_t
+ *
+i
+)
+
+54 
+u_t
+ 
+ifid
+ = 
+	`f_ifm_gid
+(
+i
+);
+
+56 
+	`KASSERT
+((
+m
+->
+m_ags
+ & 
+M_PKTHDR
+) != 0);
+
+58 
+nbuf
+->
+nb_mbuf0
+ = 
+m
+;
+
+59 
+nbuf
+->
+nb_i
+ = 
+i
+;
+
+60 
+nbuf
+->
+nb_ifid
+ = 
+ifid
+;
+
+61 
+	`nbuf_t
+(
+nbuf
+);
+
+62 
+	}
+}
+
+65 
+	$nbuf_t
+(
+nbuf_t
+ *
+nbuf
+)
+
+67 
+mbuf
+ *
+m
+ = 
+nbuf
+->
+nb_mbuf0
+;
+
+69 
+nbuf
+->
+nb_mbuf
+ = 
+m
+;
+
+70 
+nbuf
+->
+nb_
+ = 
+	`mtod
+(
+m
+, *);
+
+71 
+	}
+}
+
+74 
+	$nbuf_d
+(
+nbuf_t
+ *
+nbuf
+)
+
+76 
+	`KASSERT
+(
+nbuf
+->
+nb_
+);
+
+77  
+nbuf
+->
+nb_
+;
+
+78 
+	}
+}
+
+80 
+size_t
+
+
+81 
+	$nbuf_offt
+(c 
+nbuf_t
+ *
+nbuf
+)
+
+83 c 
+mbuf
+ *
+m
+ = 
+nbuf
+->
+nb_mbuf
+;
+
+84 c 
+u_t
+ 
+off
+ = (
+u_t
+)
+nbuf
+->
+nb_
+ - 
+	`mtod
+(
+m
+, uintptr_t);
+
+85 c 
+poff
+ = 
+	`m_ngth
+(
+nbuf
+->
+nb_mbuf0
+- m_ngth(
+m
++ 
+off
+;
+
+87  
+poff
+;
+
+88 
+	}
+}
+
+90 
+mbuf
+ *
+
+91 
+	$nbuf_hd_mbuf
+(
+nbuf_t
+ *
+nbuf
+)
+
+93  
+nbuf
+->
+nb_mbuf0
+;
+
+94 
+	}
+}
+
+96 
+bo
+
+
+97 
+	$nbuf_ag_p
+(c 
+nbuf_t
+ *
+nbuf
+, 
+ag
+)
+
+99  (
+nbuf
+->
+nb_ags
+ & 
+ag
+) != 0;
+
+100 
+	}
+}
+
+103 
+	$nbuf_unt_ag
+(
+nbuf_t
+ *
+nbuf
+, 
+ag
+)
+
+105 
+nbuf
+->
+nb_ags
+ &~
+ag
+;
+
+106 
+	}
+}
+
+116 
+	$nbuf_adv
+(
+nbuf_t
+ *
+nbuf
+, 
+size_t
+ 
+n
+, size_
+su
+)
+
+118 
+mbuf
+ *
+m
+ = 
+nbuf
+->
+nb_mbuf
+;
+
+119 
+u_t
+ 
+off
+, 
+wmk
+;
+
+120 
+ut8_t
+ *
+d
+;
+
+123 
+off
+ = (
+u_t
+)
+nbuf
+->
+nb_
+ - 
+	`mtod
+(
+m
+, u_t+ 
+n
+;
+
+124 
+wmk
+ = 
+m
+->
+m_n
+;
+
+127 
+	`__edi_l
+(
+wmk
+ <
+off
+)) {
+
+128 
+m
+ = m->
+m_xt
+;
+
+129 i(
+	`__edi_l
+(
+m
+ =
+NULL
+)) {
+
+134  
+NULL
+;
+
+136 
+wmk
+ +
+m
+->
+m_n
+;
+
+138 
+	`KASSERT
+(
+off
+ < 
+	`m_ngth
+(
+nbuf
+->
+nb_mbuf0
+));
+
+141 
+d
+ = 
+	`mtod
+(
+m
+, 
+ut8_t
+ *);
+
+142 
+	`KASSERT
+(
+off
+ >(
+wmk
+ - 
+m
+->
+m_n
+));
+
+143 
+d
+ +(
+off
+ - (
+wmk
+ - 
+m
+->
+m_n
+));
+
+145 
+nbuf
+->
+nb_mbuf
+ = 
+m
+;
+
+146 
+nbuf
+->
+nb_
+ = 
+d
+;
+
+148 i(
+su
+) {
+
+150 
+d
+ = 
+	`nbuf_su_ctig
+(
+nbuf
+, 
+su
+);
+
+152  
+d
+;
+
+153 
+	}
+}
+
+163 
+	$nbuf_su_ctig
+(
+nbuf_t
+ *
+nbuf
+, 
+size_t
+ 
+n
+)
+
+165 c 
+mbuf
+ * c 
+n
+ = 
+nbuf
+->
+nb_mbuf
+;
+
+166 c 
+size_t
+ 
+off
+ = (
+u_t
+)
+nbuf
+->
+nb_
+ - 
+	`mtod
+(
+n
+, uintptr_t);
+
+168 
+	`KASSERT
+(
+off
+ <
+n
+->
+m_n
+);
+
+170 i(
+	`__edi_l
+(
+n
+->
+m_n
+ < (
+off
+ + 
+n
+))) {
+
+171 
+mbuf
+ *
+m
+ = 
+nbuf
+->
+nb_mbuf0
+;
+
+172 c 
+size_t
+ 
+foff
+ = 
+	`nbuf_offt
+(
+nbuf
+);
+
+173 c 
+size_t
+ 
+
+ = 
+	`m_ngth
+(
+m
+);
+
+174 c 
+size_t
+ 
+mn
+ = 
+m
+->
+m_n
+;
+
+175 
+size_t
+ 
+rg
+;
+
+176 
+bo
+ 
+sucss
+;
+
+178 
+	`f_s_c
+(
+NPF_STAT_NBUF_NONCONTIG
+);
+
+181 i((
+rg
+ = 
+	`NBUF_ENSURE_ROUNDUP
+(
+foff
+ + 
+n
+)> 
+
+) {
+
+182 
+rg
+ = 
+foff
+ + 
+n
+;
+
+186 
+	`KASSERT
+((
+m
+->
+m_ags
+ & 
+M_PKTHDR
+) != 0);
+
+187 
+sucss
+ = 
+	`m_su_ctig
+(&
+m
+, 
+rg
+);
+
+188 
+	`KASSERT
+(
+m
+ !
+NULL
+);
+
+191 i(
+m
+ =
+nbuf
+->
+nb_mbuf0
+ && m->
+m_n
+ =
+mn
+) {
+
+192  
+sucss
+ ? 
+nbuf
+->
+nb_
+ : 
+NULL
+;
+
+200 
+	`KASSERT
+((
+m
+->
+m_ags
+ & 
+M_PKTHDR
+) != 0);
+
+201 
+nbuf
+->
+nb_mbuf0
+ = 
+m
+;
+
+202 
+nbuf
+->
+nb_mbuf
+ = 
+m
+;
+
+204 
+	`KASSERT
+(
+foff
+ < 
+m
+->
+m_n
+ && fof< 
+	`m_ngth
+(m));
+
+205 
+nbuf
+->
+nb_
+ = 
+	`mtod
+(
+m
+, 
+ut8_t
+ *+ 
+foff
+;
+
+206 
+nbuf
+->
+nb_ags
+ |
+NBUF_DATAREF_RESET
+;
+
+208 i(!
+sucss
+) {
+
+209 
+	`f_s_c
+(
+NPF_STAT_NBUF_CONTIG_FAIL
+);
+
+210  
+NULL
+;
+
+213  
+nbuf
+->
+nb_
+;
+
+214 
+	}
+}
+
+217 
+	$nbuf_su_wrab
+(
+nbuf_t
+ *
+nbuf
+, 
+size_t
+ 
+n
+)
+
+219 
+mbuf
+ *
+m
+ = 
+nbuf
+->
+nb_mbuf
+;
+
+220 c 
+u_t
+ 
+off
+ = (
+u_t
+)
+nbuf
+->
+nb_
+ - 
+	`mtod
+(
+m
+, uintptr_t);
+
+221 c 
+
+ = 
+off
+ + 
+n
+;
+
+222 
+bo
+ 
+hd_buf
+;
+
+224 
+	`KASSERT
+(
+off
+ < 
+	`m_ngth
+(
+nbuf
+->
+nb_mbuf0
+));
+
+226 i(!
+	`M_UNWRITABLE
+(
+m
+, 
+
+)) {
+
+227  
+nbuf
+->
+nb_
+;
+
+229 
+hd_buf
+ = (
+nbuf
+->
+nb_mbuf0
+ =
+m
+);
+
+230 i(
+	`m_makewrab
+(&
+m
+, 0, 
+
+, 
+M_NOWAIT
+)) {
+
+231 
+	`memt
+(
+nbuf
+, 0, (
+nbuf_t
+));
+
+232  
+NULL
+;
+
+234 i(
+hd_buf
+) {
+
+235 
+	`KASSERT
+((
+m
+->
+m_ags
+ & 
+M_PKTHDR
+) != 0);
+
+236 
+	`KASSERT
+(
+off
+ < 
+	`m_ngth
+(
+m
+));
+
+237 
+nbuf
+->
+nb_mbuf0
+ = 
+m
+;
+
+239 
+nbuf
+->
+nb_mbuf
+ = 
+m
+;
+
+240 
+nbuf
+->
+nb_
+ = 
+	`mtod
+(
+m
+, 
+ut8_t
+ *+ 
+off
+;
+
+242  
+nbuf
+->
+nb_
+;
+
+243 
+	}
+}
+
+245 
+bo
+
+
+246 
+	$nbuf_cksum_brr
+(
+nbuf_t
+ *
+nbuf
+, 
+di
+)
+
+248 
+mbuf
+ *
+m
+;
+
+250 i(
+di
+ !
+PFIL_OUT
+) {
+
+251  
+l
+;
+
+253 
+m
+ = 
+nbuf
+->
+nb_mbuf0
+;
+
+254 
+	`KASSERT
+((
+m
+->
+m_ags
+ & 
+M_PKTHDR
+) != 0);
+
+256 i(
+m
+->
+m_pkthdr
+.
+csum_ags
+ & (
+M_CSUM_TCPv4
+ | 
+M_CSUM_UDPv4
+)) {
+
+257 
+	`_dayed_cksum
+(
+m
+);
+
+258 
+m
+->
+m_pkthdr
+.
+csum_ags
+ &~(
+M_CSUM_TCPv4
+ | 
+M_CSUM_UDPv4
+);
+
+259  
+ue
+;
+
+261  
+l
+;
+
+262 
+	}
+}
+
+270 
+	$nbuf_add_g
+(
+nbuf_t
+ *
+nbuf
+, 
+ut32_t
+ 
+key
+, ut32_
+v
+)
+
+272 
+mbuf
+ *
+m
+ = 
+nbuf
+->
+nb_mbuf0
+;
+
+273 
+m_g
+ *
+mt
+;
+
+274 
+ut32_t
+ *
+d
+;
+
+276 
+	`KASSERT
+((
+m
+->
+m_ags
+ & 
+M_PKTHDR
+) != 0);
+
+278 
+mt
+ = 
+	`m_g_g
+(
+PACKET_TAG_NPF
+, (
+ut32_t
+), 
+M_NOWAIT
+);
+
+279 i(
+mt
+ =
+NULL
+) {
+
+280  
+ENOMEM
+;
+
+282 
+d
+ = (
+ut32_t
+ *)(
+mt
+ + 1);
+
+283 *
+d
+ = 
+v
+;
+
+284 
+	`m_g_d
+(
+m
+, 
+mt
+);
+
+286 
+	}
+}
+
+294 
+	$nbuf_fd_g
+(
+nbuf_t
+ *
+nbuf
+, 
+ut32_t
+ 
+key
+, **
+da
+)
+
+296 
+mbuf
+ *
+m
+ = 
+nbuf
+->
+nb_mbuf0
+;
+
+297 
+m_g
+ *
+mt
+;
+
+299 
+	`KASSERT
+((
+m
+->
+m_ags
+ & 
+M_PKTHDR
+) != 0);
+
+301 
+mt
+ = 
+	`m_g_fd
+(
+m
+, 
+PACKET_TAG_NPF
+, 
+NULL
+);
+
+302 i(
+mt
+ =
+NULL
+) {
+
+303  
+EINVAL
+;
+
+305 *
+da
+ = (*)(
+mt
+ + 1);
+
+307 
+	}
+}
+
+	@npf/npf_nat.c
+
+73 
+	~<sys/cdefs.h
+>
+
+74 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_nat.c,v 1.39 2014/12/30 19:11:44 christos Exp $");
+
+76 
+	~<sys/m.h
+>
+
+77 
+	~<sys/tys.h
+>
+
+79 
+	~<sys/omic.h
+>
+
+80 
+	~<sys/bs.h
+>
+
+81 
+	~<sys/cdv.h
+>
+
+82 
+	~<sys/kmem.h
+>
+
+83 
+	~<sys/mux.h
+>
+
+84 
+	~<sys/po.h
+>
+
+85 
+	~<sys/oc.h
+>
+
+86 
+	~<sys/g.h
+>
+
+88 
+	~<t/pf.h
+>
+
+89 
+	~<t/.h
+>
+
+91 
+	~"f_im.h
+"
+
+92 
+	~"f_cn.h
+"
+
+98 
+u_t
+ 
+	mp_ft
+;
+
+99 
+ut32_t
+ 
+	mp_bm
+[0];
+
+100 } 
+	tf_ptm_t
+;
+
+103 
+	#PORTMAP_FIRST
+ (1024)
+
+	)
+
+104 
+	#PORTMAP_SIZE
+ ((65536 - 
+PORTMAP_FIRST
+/ 32)
+
+	)
+
+105 
+	#PORTMAP_FILLED
+ ((
+ut32_t
+)~0U)
+
+	)
+
+106 
+	#PORTMAP_MASK
+ (31)
+
+	)
+
+107 
+	#PORTMAP_SHIFT
+ (5)
+
+	)
+
+109 
+	#PORTMAP_MEM_SIZE
+ \
+
+110 ((
+f_ptm_t
++ (
+PORTMAP_SIZE
+ * (
+ut32_t
+)))
+
+	)
+
+115 
+	sf_icy
+ {
+
+116 
+kmux_t
+ 
+	mn_lock
+;
+
+117 
+LIST_HEAD
+(, 
+f_t
+
+	mn_t_li
+;
+
+118 v
+u_t
+ 
+	mn_ft
+;
+
+119 
+f_ptm_t
+ * 
+	mn_ptm
+;
+
+120 
+ut64_t
+ 
+	mn_id
+;
+
+129 
+	mn_ty
+;
+
+130 
+u_t
+ 
+	mn_ags
+;
+
+131 
+u_t
+ 
+	mn_
+;
+
+132 
+f_addr_t
+ 
+	mn_ddr
+;
+
+133 
+f_tmask_t
+ 
+	mn_tmask
+;
+
+134 
+_pt_t
+ 
+	mn_t
+;
+
+135 
+u_t
+ 
+	mn_go
+;
+
+137 
+ut16_t
+ 
+	mn_t66_adj
+;
+
+141 
+	#NPF_NP_CMP_START
+ 
+	`offtof
+(
+f_icy_t
+, 
+n_ty
+)
+
+	)
+
+142 
+	#NPF_NP_CMP_SIZE
+ ((
+f_icy_t
+- 
+NPF_NP_CMP_START
+)
+
+	)
+
+147 
+	sf_t
+ {
+
+149 
+f_icy_t
+ * 
+	m_icy
+;
+
+155 
+f_addr_t
+ 
+	m_ddr
+;
+
+156 
+_pt_t
+ 
+	m_t
+;
+
+157 
+_pt_t
+ 
+	m_t
+;
+
+160 
+f_g_t
+ * 
+	m_g
+;
+
+161 
+u_t
+ 
+	m_g_g
+;
+
+163 
+LIST_ENTRY
+(
+f_t
+
+	m_y
+;
+
+164 
+f_cn_t
+ * 
+	m_cn
+;
+
+167 
+po_che_t
+ 
+t_che
+ 
+	g__ad_moly
+;
+
+174 
+	$f_t_sys
+()
+
+176 
+t_che
+ = 
+	`po_che_
+((
+f_t_t
+), 
+cohcy_un
+,
+
+177 0, 0, "", 
+NULL
+, 
+IPL_NET
+, NULL, NULL, NULL);
+
+178 
+	`KASSERT
+(
+t_che
+ !
+NULL
+);
+
+179 
+	}
+}
+
+182 
+	$f_t_sysfi
+()
+
+185 
+	`po_che_deroy
+(
+t_che
+);
+
+186 
+	}
+}
+
+193 
+f_icy_t
+ *
+
+194 
+	$f_t_wpicy
+(
+_diiy_t
+ 
+tdi
+, 
+f_rut_t
+ *
+rt
+)
+
+196 
+f_icy_t
+ *
+
+;
+
+197 
+_obje_t
+ 
+obj
+;
+
+198 
+f_ptm_t
+ *
+pm
+;
+
+200 
+
+ = 
+	`kmem_zloc
+((
+f_icy_t
+), 
+KM_SLEEP
+);
+
+203 
+	`_diiy_g_t32
+(
+tdi
+, "ty", &
+
+->
+n_ty
+);
+
+204 
+	`_diiy_g_ut32
+(
+tdi
+, "ags", &
+
+->
+n_ags
+);
+
+205 
+	`_diiy_g_ut64
+(
+tdi
+, "t-picy", &
+
+->
+n_id
+);
+
+208 i(((
+
+->
+n_ty
+ =
+NPF_NATIN
+^ (->n_ty =
+NPF_NATOUT
+)) == 0) {
+
+209 
+r
+;
+
+211 
+	`mux_
+(&
+
+->
+n_lock
+, 
+MUTEX_DEFAULT
+, 
+IPL_SOFTNET
+);
+
+212 
+	`LIST_INIT
+(&
+
+->
+n_t_li
+);
+
+215 
+obj
+ = 
+	`_diiy_g
+(
+tdi
+, "nat-ip");
+
+216 
+
+->
+n_
+ = 
+	`_da_size
+(
+obj
+);
+
+217 i(
+
+->
+n_
+ =0 ||p->n_ > (
+f_addr_t
+)) {
+
+218 
+r
+;
+
+220 
+	`memy
+(&
+
+->
+n_ddr
+, 
+	`_da_da_nocy
+(
+obj
+),p->
+n_
+);
+
+221 
+	`_diiy_g_ut8
+(
+tdi
+, "t-mask", &
+
+->
+n_tmask
+);
+
+222 
+	`_diiy_g_ut16
+(
+tdi
+, "t-pt", &
+
+->
+n_t
+);
+
+224 
+	`_diiy_g_ut32
+(
+tdi
+, "t-go", &
+
+->
+n_go
+);
+
+225 
+
+->
+n_go
+) {
+
+226 
+NPF_ALGO_NPT66
+:
+
+227 
+	`_diiy_g_ut16
+(
+tdi
+, "npt66-adj",
+
+228 &
+
+->
+n_t66_adj
+);
+
+231 i(
+
+->
+n_tmask
+ !
+NPF_NO_NETMASK
+)
+
+232 
+r
+;
+
+237 
+
+->
+n_ptm
+ = 
+NULL
+;
+
+238 i((
+
+->
+n_ags
+ & 
+NPF_NAT_PORTMAP
+) == 0) {
+
+240  
+
+;
+
+247 i(!
+	`f_rut_shm
+(
+rt
+, 
+
+)) {
+
+249 
+pm
+ = 
+	`kmem_zloc
+(
+PORTMAP_MEM_SIZE
+, 
+KM_SLEEP
+);
+
+250 
+pm
+->
+p_ft
+ = 1;
+
+251 
+	`KASSERT
+((
+u_t
+)
+pm
+->
+p_bm
+ == (uintptr_t)pm + (*pm));
+
+252 
+
+->
+n_ptm
+ = 
+pm
+;
+
+254 
+	`KASSERT
+(
+
+->
+n_ptm
+ !
+NULL
+);
+
+255 
+	`KASSERT
+(
+
+->
+n_ptm
+->
+p_ft
+ > 0);
+
+257  
+
+;
+
+258 
+r
+:
+
+259 
+	`mux_deroy
+(&
+
+->
+n_lock
+);
+
+260 
+	`kmem_
+(
+
+, (
+f_icy_t
+));
+
+261  
+NULL
+;
+
+262 
+	}
+}
+
+265 
+	$f_t_picyexpt
+(c 
+f_icy_t
+ *
+
+, 
+_diiy_t
+ 
+tdi
+)
+
+267 
+_da_t
+ 
+d
+;
+
+269 
+	`_diiy_t_t32
+(
+tdi
+, "ty", 
+
+->
+n_ty
+);
+
+270 
+	`_diiy_t_ut32
+(
+tdi
+, "ags", 
+
+->
+n_ags
+);
+
+272 
+d
+ = 
+	`_da__da
+(&
+
+->
+n_ddr
+,p->
+n_
+);
+
+273 
+	`_diiy_t_d_l
+(
+tdi
+, "t-", 
+d
+);
+
+275 
+	`_diiy_t_ut8
+(
+tdi
+, "t-mask", 
+
+->
+n_tmask
+);
+
+276 
+	`_diiy_t_ut16
+(
+tdi
+, "t-pt", 
+
+->
+n_t
+);
+
+277 
+	`_diiy_t_ut32
+(
+tdi
+, "t-go", 
+
+->
+n_go
+);
+
+279 
+
+->
+n_go
+) {
+
+280 
+NPF_ALGO_NPT66
+:
+
+281 
+	`_diiy_t_ut16
+(
+tdi
+, "t66-adj", 
+
+->
+n_t66_adj
+);
+
+284 
+	`_diiy_t_ut64
+(
+tdi
+, "t-picy", 
+
+->
+n_id
+);
+
+286 
+	}
+}
+
+294 
+	$f_t_picy
+(
+f_icy_t
+ *
+
+)
+
+296 
+f_ptm_t
+ *
+pm
+ = 
+
+->
+n_ptm
+;
+
+297 
+f_cn_t
+ *
+c
+;
+
+298 
+f_t_t
+ *
+
+;
+
+304 
+
+->
+n_ft
+) {
+
+305 
+	`mux_r
+(&
+
+->
+n_lock
+);
+
+306 
+	`LIST_FOREACH
+(
+
+, &
+
+->
+n_t_li
+, 
+_y
+) {
+
+307 
+c
+ = 
+
+->
+_cn
+;
+
+308 
+	`KASSERT
+(
+c
+ !
+NULL
+);
+
+309 
+	`f_cn_expe
+(
+c
+);
+
+311 
+	`mux_ex
+(&
+
+->
+n_lock
+);
+
+314 
+	`f_wk_sigl
+();
+
+315 
+	`ku
+("fg", 
+l
+, 1, 
+NULL
+);
+
+317 
+	`KASSERT
+(
+	`LIST_EMPTY
+(&
+
+->
+n_t_li
+));
+
+318 
+	`KASSERT
+(
+pm
+ =
+NULL
+ ||m->
+p_ft
+ > 0);
+
+321 i(
+pm
+ && 
+	`omic_dec_ut_nv
+(&pm->
+p_ft
+) == 0) {
+
+322 
+	`KASSERT
+((
+
+->
+n_ags
+ & 
+NPF_NAT_PORTMAP
+) != 0);
+
+323 
+	`kmem_
+(
+pm
+, 
+PORTMAP_MEM_SIZE
+);
+
+325 
+	`mux_deroy
+(&
+
+->
+n_lock
+);
+
+326 
+	`kmem_
+(
+
+, (
+f_icy_t
+));
+
+327 
+	}
+}
+
+330 
+	$f_t_g
+(
+f_icy_t
+ *
+
+, 
+f_g_t
+ *
+g
+)
+
+332 
+f_t_t
+ *
+
+;
+
+334 
+	`mux_r
+(&
+
+->
+n_lock
+);
+
+335 
+	`LIST_FOREACH
+(
+
+, &
+
+->
+n_t_li
+, 
+_y
+) {
+
+336 i(
+
+->
+_g
+ =
+g
+)
+
+337 
+
+->
+_g
+ = 
+NULL
+;
+
+339 
+	`mux_ex
+(&
+
+->
+n_lock
+);
+
+340 
+	}
+}
+
+347 
+bo
+
+
+348 
+	$f_t_cmicy
+(
+f_icy_t
+ *
+
+,pf_icy_*
+m
+)
+
+350 c *
+_w
+, *
+m_w
+;
+
+356 
+	`KASSERT
+(
+
+ && 
+m
+ &&p != mnp);
+
+357 
+_w
+ = (c 
+ut8_t
+ *)
+
+ + 
+NPF_NP_CMP_START
+;
+
+358 
+m_w
+ = (c 
+ut8_t
+ *)
+m
+ + 
+NPF_NP_CMP_START
+;
+
+359  
+	`memcmp
+(
+_w
+, 
+m_w
+, 
+NPF_NP_CMP_SIZE
+) == 0;
+
+360 
+	}
+}
+
+362 
+bo
+
+
+363 
+	$f_t_shm
+(
+f_icy_t
+ *
+
+,pf_icy_*
+m
+)
+
+365 
+f_ptm_t
+ *
+pm
+, *
+mpm
+;
+
+367 
+	`KASSERT
+(
+
+ && 
+m
+ &&p != mnp);
+
+368 
+	`KASSERT
+(
+	`LIST_EMPTY
+(&
+m
+->
+n_t_li
+));
+
+369 
+	`KASSERT
+(
+m
+->
+n_ft
+ == 0);
+
+372 i((
+
+->
+n_ags
+ & 
+m
+->n_ag& 
+NPF_NAT_PORTMAP
+) == 0) {
+
+373  
+l
+;
+
+375 i(
+
+->
+n_
+ !
+m
+->n_alen) {
+
+376  
+l
+;
+
+378 i(
+	`memcmp
+(&
+
+->
+n_ddr
+, &
+m
+->n_ddr,p->
+n_
+) != 0) {
+
+379  
+l
+;
+
+381 
+mpm
+ = 
+m
+->
+n_ptm
+;
+
+382 
+	`KASSERT
+(
+mpm
+ =
+NULL
+ || mpm->
+p_ft
+ > 0);
+
+388 i(
+mpm
+ && 
+	`omic_dec_ut_nv
+(&mpm->
+p_ft
+) == 0) {
+
+389 
+	`kmem_
+(
+mpm
+, 
+PORTMAP_MEM_SIZE
+);
+
+393 
+pm
+ = 
+
+->
+n_ptm
+;
+
+394 
+	`omic_c_ut
+(&
+pm
+->
+p_ft
+);
+
+395 
+m
+->
+n_ptm
+ = 
+pm
+;
+
+396  
+ue
+;
+
+397 
+	}
+}
+
+400 
+	$f_t_tid
+(
+f_icy_t
+ *
+
+, 
+ut64_t
+ 
+id
+)
+
+402 
+
+->
+n_id
+ = 
+id
+;
+
+403 
+	}
+}
+
+405 
+ut64_t
+
+
+406 
+	$f_t_gid
+(c 
+f_icy_t
+ *
+
+)
+
+408  
+
+->
+n_id
+;
+
+409 
+	}
+}
+
+417 
+_pt_t
+
+
+418 
+	$f_t_gpt
+(
+f_icy_t
+ *
+
+)
+
+420 
+f_ptm_t
+ *
+pm
+ = 
+
+->
+n_ptm
+;
+
+421 
+u_t
+ 
+n
+ = 
+PORTMAP_SIZE
+, 
+idx
+, 
+b
+;
+
+422 
+ut32_t
+ 
+m
+, 
+nm
+;
+
+424 
+	`KASSERT
+((
+
+->
+n_ags
+ & 
+NPF_NAT_PORTMAP
+) != 0);
+
+425 
+	`KASSERT
+(
+pm
+->
+p_ft
+ > 0);
+
+427 
+idx
+ = 
+	`g_32
+(% 
+PORTMAP_SIZE
+;
+
+429 
+	`KASSERT
+(
+idx
+ < 
+PORTMAP_SIZE
+);
+
+430 
+m
+ = 
+pm
+->
+p_bm
+[
+idx
+];
+
+431 i(
+	`__edi_l
+(
+m
+ =
+PORTMAP_FILLED
+)) {
+
+432 i(
+n
+-- == 0) {
+
+437 
+idx
+ = (idx ? idx : 
+PORTMAP_SIZE
+) - 1;
+
+440 
+b
+ = 
+	`ffs32
+(~
+m
+) - 1;
+
+441 
+nm
+ = 
+m
+ | (1 << 
+b
+);
+
+442 i(
+	`omic_s_32
+(&
+pm
+->
+p_bm
+[
+idx
+], 
+m
+, 
+nm
+) == map) {
+
+447  
+	`hts
+(
+PORTMAP_FIRST
+ + (
+idx
+ << 
+PORTMAP_SHIFT
++ 
+b
+);
+
+448 
+	}
+}
+
+453 
+bo
+
+
+454 
+	$f_t_kt
+(
+f_icy_t
+ *
+
+, 
+_pt_t
+ 
+pt
+)
+
+456 
+f_ptm_t
+ *
+pm
+ = 
+
+->
+n_ptm
+;
+
+457 
+ut32_t
+ 
+m
+, 
+nm
+;
+
+458 
+u_t
+ 
+idx
+, 
+b
+;
+
+460 
+	`KASSERT
+((
+
+->
+n_ags
+ & 
+NPF_NAT_PORTMAP
+) != 0);
+
+461 
+	`KASSERT
+(
+pm
+->
+p_ft
+ > 0);
+
+463 
+pt
+ = 
+	`ohs
+t- 
+PORTMAP_FIRST
+;
+
+464 
+idx
+ = 
+pt
+ >> 
+PORTMAP_SHIFT
+;
+
+465 
+b
+ = 
+pt
+ & 
+PORTMAP_MASK
+;
+
+466 
+m
+ = 
+pm
+->
+p_bm
+[
+idx
+];
+
+467 
+nm
+ = 
+m
+ | (1 << 
+b
+);
+
+468 i(
+m
+ =
+nm
+) {
+
+470  
+l
+;
+
+472  
+	`omic_s_32
+(&
+pm
+->
+p_bm
+[
+idx
+], 
+m
+, 
+nm
+) == map;
+
+473 
+	}
+}
+
+481 
+	$f_t_put
+(
+f_icy_t
+ *
+
+, 
+_pt_t
+ 
+pt
+)
+
+483 
+f_ptm_t
+ *
+pm
+ = 
+
+->
+n_ptm
+;
+
+484 
+ut32_t
+ 
+m
+, 
+nm
+;
+
+485 
+u_t
+ 
+idx
+, 
+b
+;
+
+487 
+	`KASSERT
+((
+
+->
+n_ags
+ & 
+NPF_NAT_PORTMAP
+) != 0);
+
+488 
+	`KASSERT
+(
+pm
+->
+p_ft
+ > 0);
+
+490 
+pt
+ = 
+	`ohs
+t- 
+PORTMAP_FIRST
+;
+
+491 
+idx
+ = 
+pt
+ >> 
+PORTMAP_SHIFT
+;
+
+492 
+b
+ = 
+pt
+ & 
+PORTMAP_MASK
+;
+
+494 
+m
+ = 
+pm
+->
+p_bm
+[
+idx
+];
+
+495 
+	`KASSERT
+(
+m
+ | (1 << 
+b
+));
+
+496 
+nm
+ = 
+m
+ & ~(1 << 
+b
+);
+
+497 } 
+	`omic_s_32
+(&
+pm
+->
+p_bm
+[
+idx
+], 
+m
+, 
+nm
+) != map);
+
+498 
+	}
+}
+
+504 
+le
+ 
+u_t
+
+
+505 
+	$f_t_which
+(c 
+ty
+, 
+bo
+ 
+fw
+)
+
+513 i(
+ty
+ =
+NPF_NATOUT
+) {
+
+514 
+fw
+ = !forw;
+
+516 
+	`KASSERT
+(
+ty
+ =
+NPF_NATIN
+);
+
+518 
+	`CTASSERT
+(
+NPF_SRC
+ =0 && 
+NPF_DST
+ == 1);
+
+519 
+	`KASSERT
+(
+fw
+ =
+NPF_SRC
+ || fw =
+NPF_DST
+);
+
+520  (
+u_t
+)
+fw
+;
+
+521 
+	}
+}
+
+528 
+f_icy_t
+ *
+
+529 
+	$f_t_e
+(
+f_che_t
+ *
+c
+, c 
+di
+)
+
+531 
+ock
+ = 
+	`f_cfig_ad_r
+();
+
+532 
+f_rut_t
+ *
+t
+ = 
+	`f_cfig_tt
+();
+
+533 
+f_icy_t
+ *
+
+;
+
+534 
+f_ru_t
+ *
+
+;
+
+536 
+
+ = 
+	`f_rut_e
+(
+c
+, 
+t
+, 
+di
+, 
+NPF_LAYER_3
+);
+
+537 i(
+
+ =
+NULL
+) {
+
+538 
+	`f_cfig_ad_ex
+(
+ock
+);
+
+539  
+NULL
+;
+
+541 
+
+ = 
+	`f_ru_gt
+(
+
+);
+
+542 
+	`omic_c_ut
+(&
+
+->
+n_ft
+);
+
+543 
+	`f_cfig_ad_ex
+(
+ock
+);
+
+544  
+
+;
+
+545 
+	}
+}
+
+550 
+f_t_t
+ *
+
+551 
+	$f_t_
+(
+f_che_t
+ *
+c
+, 
+f_icy_t
+ *
+
+, 
+f_cn_t
+ *
+c
+)
+
+553 c 
+o
+ = 
+c
+->
+c_o
+;
+
+554 
+f_t_t
+ *
+
+;
+
+556 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_IP46
+));
+
+557 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_LAYER4
+));
+
+560 
+
+ = 
+	`po_che_g
+(
+t_che
+, 
+PR_NOWAIT
+);
+
+561 i(
+
+ =
+NULL
+){
+
+562  
+NULL
+;
+
+564 
+	`f_s_c
+(
+NPF_STAT_NAT_CREATE
+);
+
+565 
+
+->
+_icy
+ = 
+
+;
+
+566 
+
+->
+_cn
+ = 
+c
+;
+
+567 
+
+->
+_g
+ = 
+NULL
+;
+
+570 i(
+
+->
+n_ty
+ =
+NPF_NATOUT
+) {
+
+572 
+	`memy
+(&
+
+->
+_ddr
+, 
+c
+->
+c_s
+[
+NPF_SRC
+],pc->
+c_
+);
+
+575 
+	`KASSERT
+(
+
+->
+n_ty
+ =
+NPF_NATIN
+);
+
+576 
+	`memy
+(&
+
+->
+_ddr
+, 
+c
+->
+c_s
+[
+NPF_DST
+],pc->
+c_
+);
+
+582 i((
+
+->
+n_ags
+ & 
+NPF_NAT_PORTS
+) == 0 ||
+
+583 (
+o
+ !
+IPPROTO_TCP
+ &&r!
+IPPROTO_UDP
+)) {
+
+584 
+
+->
+_t
+ = 0;
+
+585 
+
+->
+_t
+ = 0;
+
+586 
+out
+;
+
+590 i(
+o
+ =
+IPPROTO_TCP
+) {
+
+591 c 
+thdr
+ *
+th
+ = 
+c
+->
+c_l4
+.
+t
+;
+
+592 
+
+->
+_t
+ = (
+
+->
+n_ty
+ =
+NPF_NATOUT
+) ?
+
+593 
+th
+->
+th_t
+ :h->
+th_dpt
+;
+
+595 c 
+udphdr
+ *
+uh
+ = 
+c
+->
+c_l4
+.
+udp
+;
+
+596 
+
+->
+_t
+ = (
+
+->
+n_ty
+ =
+NPF_NATOUT
+) ?
+
+597 
+uh
+->
+uh_t
+ : uh->
+uh_dpt
+;
+
+601 i((
+
+->
+n_ags
+ & 
+NPF_NAT_PORTMAP
+) != 0) {
+
+602 
+
+->
+_t
+ = 
+	`f_t_gpt
+(
+
+);
+
+604 
+
+->
+_t
+ = 
+
+->
+n_t
+;
+
+606 
+out
+:
+
+607 
+	`mux_r
+(&
+
+->
+n_lock
+);
+
+608 
+	`LIST_INSERT_HEAD
+(&
+
+->
+n_t_li
+, 
+
+, 
+_y
+);
+
+609 
+	`mux_ex
+(&
+
+->
+n_lock
+);
+
+610  
+
+;
+
+611 
+	}
+}
+
+616 
+le
+ 
+
+617 
+	$f_t_e
+(
+f_che_t
+ *
+c
+, 
+f_t_t
+ *
+
+, 
+bo
+ 
+fw
+)
+
+619 c 
+f_icy_t
+ *
+
+ = 
+
+->
+_icy
+;
+
+620 c 
+u_t
+ 
+which
+ = 
+	`f_t_which
+(
+
+->
+n_ty
+, 
+fw
+);
+
+621 c 
+f_addr_t
+ *
+addr
+;
+
+622 
+_pt_t
+ 
+pt
+;
+
+624 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_IP46
+));
+
+625 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_LAYER4
+));
+
+627 i(
+fw
+) {
+
+629 
+addr
+ = &
+
+->
+n_ddr
+;
+
+630 
+pt
+ = 
+
+->
+_t
+;
+
+633 
+addr
+ = &
+
+->
+_ddr
+;
+
+634 
+pt
+ = 
+
+->
+_t
+;
+
+636 
+	`KASSERT
+((
+
+->
+n_ags
+ & 
+NPF_NAT_PORTS
+!0 || 
+pt
+ == 0);
+
+639 i((
+c
+->
+c_fo
+ & 
+NPC_ALG_EXEC
+) == 0) {
+
+640 
+c
+->
+c_fo
+ |
+NPC_ALG_EXEC
+;
+
+641 
+	`f_g_exec
+(
+c
+, 
+
+, 
+fw
+);
+
+642 
+	`f_che
+(
+c
+);
+
+644 
+	`KASSERT
+(!
+	`nbuf_ag_p
+(
+c
+->
+c_nbuf
+, 
+NBUF_DATAREF_RESET
+));
+
+647  
+	`f__rwr
+(
+c
+, 
+which
+, 
+addr
+, 
+pt
+);
+
+648 
+	}
+}
+
+653 
+le
+ 
+
+654 
+	$f_t_go
+(
+f_che_t
+ *
+c
+, c 
+f_icy_t
+ *
+
+, 
+bo
+ 
+fw
+)
+
+656 c 
+u_t
+ 
+which
+ = 
+	`f_t_which
+(
+
+->
+n_ty
+, 
+fw
+);
+
+657 
+r
+;
+
+659 
+
+->
+n_go
+) {
+
+660 
+NPF_ALGO_NPT66
+:
+
+661 
+r
+ = 
+	`f_t66_rwr
+(
+c
+, 
+which
+, &
+
+->
+n_ddr
+,
+
+662 
+
+->
+n_tmask
+,p->
+n_t66_adj
+);
+
+665 
+r
+ = 
+	`f__rwr
+(
+c
+, 
+which
+, &
+
+->
+n_ddr
+,p->
+n_t
+);
+
+669  
+r
+;
+
+670 
+	}
+}
+
+682 
+	$f_do_t
+(
+f_che_t
+ *
+c
+, 
+f_cn_t
+ *
+c
+, c 
+di
+)
+
+684 
+nbuf_t
+ *
+nbuf
+ = 
+c
+->
+c_nbuf
+;
+
+685 
+f_cn_t
+ *
+nc
+ = 
+NULL
+;
+
+686 
+f_icy_t
+ *
+
+;
+
+687 
+f_t_t
+ *
+
+;
+
+688 
+r
+;
+
+689 
+bo
+ 
+fw
+;
+
+692 i(!
+	`f_isched
+(
+c
+, 
+NPC_IP46
+|| !f_ischedpc, 
+NPC_LAYER4
+)) {
+
+695 
+	`KASSERT
+(!
+	`nbuf_ag_p
+(
+nbuf
+, 
+NBUF_DATAREF_RESET
+));
+
+702 i(
+c
+ && (
+
+ = 
+	`f_cn_gt
+(c, 
+di
+, &
+fw
+)!
+NULL
+) {
+
+703 
+
+ = 
+
+->
+_icy
+;
+
+704 
+e
+;
+
+711 
+
+ = 
+	`f_t_e
+(
+c
+, 
+di
+);
+
+712 i(
+
+ =
+NULL
+) {
+
+716 
+fw
+ = 
+ue
+;
+
+719 i(
+
+->
+n_ags
+ & 
+NPF_NAT_STATIC
+) {
+
+720 i(
+	`nbuf_cksum_brr
+(
+nbuf
+, 
+di
+)) {
+
+721 
+	`f_che
+(
+c
+);
+
+723 
+r
+ = 
+	`f_t_go
+(
+c
+, 
+
+, 
+fw
+);
+
+724 
+	`omic_dec_ut
+(&
+
+->
+n_ft
+);
+
+725  
+r
+;
+
+734 i(
+c
+ =
+NULL
+) {
+
+735 
+nc
+ = 
+	`f_cn_eablish
+(
+c
+, 
+di
+, 
+ue
+);
+
+736 i(
+nc
+ =
+NULL
+) {
+
+737 
+	`omic_dec_ut
+(&
+
+->
+n_ft
+);
+
+738  
+ENOMEM
+;
+
+740 
+c
+ = 
+nc
+;
+
+747 
+
+ = 
+	`f_t_
+(
+c
+, 
+
+, 
+c
+);
+
+748 i(
+
+ =
+NULL
+) {
+
+749 
+	`omic_dec_ut
+(&
+
+->
+n_ft
+);
+
+750 
+r
+ = 
+ENOMEM
+;
+
+751 
+out
+;
+
+755 
+r
+ = 
+	`f_cn_
+(
+c
+, 
+c
+, 
+
+, 
+
+->
+n_ty
+);
+
+756 i(
+r
+) {
+
+758 
+	`f_t_deroy
+(
+
+);
+
+759 
+out
+;
+
+763 i(
+	`f_g_mch
+(
+c
+, 
+
+, 
+di
+)) {
+
+764 
+	`KASSERT
+(
+
+->
+_g
+ !
+NULL
+);
+
+767 
+e
+:
+
+769 i(
+	`nbuf_cksum_brr
+(
+nbuf
+, 
+di
+)) {
+
+770 
+	`f_che
+(
+c
+);
+
+774 
+r
+ = 
+	`f_t_e
+(
+c
+, 
+
+, 
+fw
+);
+
+775 
+out
+:
+
+776 i(
+	`__edi_l
+(
+nc
+)) {
+
+777 i(
+r
+) {
+
+779 
+	`f_cn_expe
+(
+nc
+);
+
+781 
+	`f_cn_a
+(
+nc
+);
+
+783  
+r
+;
+
+784 
+	}
+}
+
+790 
+	$f_t_gs
+(
+f_t_t
+ *
+
+, 
+f_addr_t
+ **
+addr
+, 
+_pt_t
+ *
+pt
+)
+
+792 
+f_icy_t
+ *
+
+ = 
+
+->
+_icy
+;
+
+794 *
+addr
+ = &
+
+->
+n_ddr
+;
+
+795 *
+pt
+ = 
+
+->
+_t
+;
+
+796 
+	}
+}
+
+802 
+	$f_t_gig
+(
+f_t_t
+ *
+
+, 
+f_addr_t
+ **
+addr
+, 
+_pt_t
+ *
+pt
+)
+
+804 *
+addr
+ = &
+
+->
+_ddr
+;
+
+805 *
+pt
+ = 
+
+->
+_t
+;
+
+806 
+	}
+}
+
+812 
+	$f_t_lg
+(
+f_t_t
+ *
+
+, 
+f_g_t
+ *
+g
+, 
+u_t
+ 
+g
+)
+
+814 
+
+->
+_g
+ = 
+g
+;
+
+815 
+
+->
+_g_g
+ = 
+g
+;
+
+816 
+	}
+}
+
+822 
+	$f_t_deroy
+(
+f_t_t
+ *
+
+)
+
+824 
+f_icy_t
+ *
+
+ = 
+
+->
+_icy
+;
+
+827 i((
+
+->
+n_ags
+ & 
+NPF_NAT_PORTMAP
+!0 && 
+
+->
+_t
+) {
+
+828 
+	`f_t_put
+(
+
+, 
+
+->
+_t
+);
+
+831 
+	`mux_r
+(&
+
+->
+n_lock
+);
+
+832 
+	`LIST_REMOVE
+(
+
+, 
+_y
+);
+
+833 
+	`KASSERT
+(
+
+->
+n_ft
+ > 0);
+
+834 
+	`omic_dec_ut
+(&
+
+->
+n_ft
+);
+
+835 
+	`mux_ex
+(&
+
+->
+n_lock
+);
+
+837 
+	`po_che_put
+(
+t_che
+, 
+
+);
+
+838 
+	`f_s_c
+(
+NPF_STAT_NAT_DESTROY
+);
+
+839 
+	}
+}
+
+845 
+	$f_t_expt
+(
+_diiy_t
+ 
+cdi
+, 
+f_t_t
+ *
+
+)
+
+847 
+f_icy_t
+ *
+
+ = 
+
+->
+_icy
+;
+
+848 
+_diiy_t
+ 
+tdi
+;
+
+849 
+_da_t
+ 
+d
+;
+
+851 
+tdi
+ = 
+	`_diiy_
+();
+
+852 
+d
+ = 
+	`_da__da
+(&
+
+->
+_ddr
+, (
+f_addr_t
+));
+
+853 
+	`_diiy_t_d_l
+(
+tdi
+, "ddr", 
+d
+);
+
+854 
+	`_diiy_t_ut16
+(
+tdi
+, "t", 
+
+->
+_t
+);
+
+855 
+	`_diiy_t_ut16
+(
+tdi
+, "t", 
+
+->
+_t
+);
+
+856 
+	`_diiy_t_ut64
+(
+tdi
+, "t-picy", 
+
+->
+n_id
+);
+
+857 
+	`_diiy_t_d_l
+(
+cdi
+, "t", 
+tdi
+);
+
+858 
+	}
+}
+
+863 
+f_t_t
+ *
+
+864 
+	$f_t_impt
+(
+_diiy_t
+ 
+tdi
+, 
+f_rut_t
+ *
+i
+,
+
+865 
+f_cn_t
+ *
+c
+)
+
+867 
+f_icy_t
+ *
+
+;
+
+868 
+f_t_t
+ *
+
+;
+
+869 
+ut64_t
+ 
+_id
+;
+
+870 c *
+d
+;
+
+872 
+	`_diiy_g_ut64
+(
+tdi
+, "t-picy", &
+_id
+);
+
+873 i((
+
+ = 
+	`f_rut_fdt
+(
+i
+, 
+_id
+)=
+NULL
+) {
+
+874  
+NULL
+;
+
+876 
+
+ = 
+	`po_che_g
+(
+t_che
+, 
+PR_WAITOK
+);
+
+877 
+	`memt
+(
+
+, 0, (
+f_t_t
+));
+
+879 
+_obje_t
+ 
+obj
+ = 
+	`_diiy_g
+(
+tdi
+, "oaddr");
+
+880 i((
+d
+ = 
+	`_da_da_nocy
+(
+obj
+)=
+NULL
+ ||
+
+881 
+	`_da_size
+(
+obj
+!(
+f_addr_t
+)) {
+
+882 
+	`po_che_put
+(
+t_che
+, 
+
+);
+
+883  
+NULL
+;
+
+885 
+	`memy
+(&
+
+->
+_ddr
+, 
+d
+, (
+f_addr_t
+));
+
+886 
+	`_diiy_g_ut16
+(
+tdi
+, "t", &
+
+->
+_t
+);
+
+887 
+	`_diiy_g_ut16
+(
+tdi
+, "t", &
+
+->
+_t
+);
+
+890 i((
+
+->
+n_ags
+ & 
+NPF_NAT_PORTMAP
+!0 && 
+
+->
+_t
+ &
+
+891 !
+	`f_t_kt
+(
+
+, 
+
+->
+_t
+)) {
+
+892 
+	`po_che_put
+(
+t_che
+, 
+
+);
+
+893  
+NULL
+;
+
+895 
+	`f_s_c
+(
+NPF_STAT_NAT_CREATE
+);
+
+901 
+
+->
+_icy
+ = 
+
+;
+
+902 
+
+->
+_cn
+ = 
+c
+;
+
+903 
+
+->
+n_ft
+++;
+
+904 
+	`LIST_INSERT_HEAD
+(&
+
+->
+n_t_li
+, 
+
+, 
+_y
+);
+
+905  
+
+;
+
+906 
+	}
+}
+
+908 #i
+defed
+(
+DDB
+|| defed(
+_NPF_TESTING
+)
+
+911 
+	$f_t_dump
+(c 
+f_t_t
+ *
+
+)
+
+913 c 
+f_icy_t
+ *
+
+;
+
+914 
+_addr
+ 
+
+;
+
+916 
+
+ = 
+
+->
+_icy
+;
+
+917 
+	`memy
+(&
+
+, &
+
+->
+n_ddr
+, (ip));
+
+918 
+	`tf
+("\tNATP(%p):y %d fg0x%xadd%%d\n", 
+
+,
+
+919 
+
+->
+n_ty
+,p->
+n_ags
+, 
+	`_
+(
+
+), 
+	`ohs
+p->
+n_t
+));
+
+920 
+	`memy
+(&
+
+, &
+
+->
+_ddr
+, (ip));
+
+921 
+	`tf
+("\tNAT: originalddress %s oport %dport %d\n",
+
+922 
+	`_
+(
+
+), 
+	`ohs
+(
+
+->
+_t
+),tohst->
+_t
+));
+
+923 i(
+
+->
+_g
+) {
+
+924 
+	`tf
+("\tNAT ALG = %p, ARG = %p\n",
+
+925 
+
+->
+_g
+, (*t->
+_g_g
+);
+
+927 
+	}
+}
+
+	@npf/npf_rproc.c
+
+36 
+	~<sys/cdefs.h
+>
+
+37 
+__KERNEL_RCSID
+(0, "$NetBSD");
+
+39 
+	~<sys/m.h
+>
+
+40 
+	~<sys/tys.h
+>
+
+42 
+	~<sys/omic.h
+>
+
+43 
+	~<sys/kmem.h
+>
+
+44 
+	~<sys/mux.h
+>
+
+45 
+	~<sys/modu.h
+>
+
+47 
+	~"f_im.h
+"
+
+49 
+	#EXT_NAME_LEN
+ 32
+
+	)
+
+51 
+	sf_ext
+ {
+
+52 
+	mext_me
+[
+EXT_NAME_LEN
+];
+
+53 
+LIST_ENTRY
+(
+f_ext
+
+	mext_y
+;
+
+54 c 
+f_ext_s_t
+ * 
+	mext_s
+;
+
+55 
+	mext_ft
+;
+
+56 } 
+	tf_ext_t
+;
+
+58 
+	sf_roct
+ {
+
+59 
+LIST_HEAD
+(, 
+f_roc
+
+	ms_li
+;
+
+62 
+	#RPROC_NAME_LEN
+ 32
+
+	)
+
+63 
+	#RPROC_EXT_COUNT
+ 16
+
+	)
+
+65 
+	sf_roc
+ {
+
+67 
+ut32_t
+ 
+	m_ags
+;
+
+68 
+u_t
+ 
+	m_ft
+;
+
+71 
+	m_ext_cou
+;
+
+72 
+f_ext_t
+ * 
+	m_ext
+[
+RPROC_EXT_COUNT
+];
+
+73 * 
+	m_ext_ma
+[
+RPROC_EXT_COUNT
+];
+
+76 
+	m_me
+[
+RPROC_NAME_LEN
+];
+
+77 
+LIST_ENTRY
+(
+f_roc
+
+	m_y
+;
+
+80 
+	$LIST_HEAD
+(, 
+f_ext
+
+ext_li
+ 
+__che_igd
+;
+
+81 
+kmux_t
+ 
+ext_lock
+ 
+__che_igd
+;
+
+84 
+	$f_ext_sys
+()
+
+86 
+	`mux_
+(&
+ext_lock
+, 
+MUTEX_DEFAULT
+, 
+IPL_NONE
+);
+
+87 
+	`LIST_INIT
+(&
+ext_li
+);
+
+88 
+	}
+}
+
+91 
+	$f_ext_sysfi
+()
+
+93 
+	`KASSERT
+(
+	`LIST_EMPTY
+(&
+ext_li
+));
+
+94 
+	`mux_deroy
+(&
+ext_lock
+);
+
+95 
+	}
+}
+
+101 c 
+	gf_ext_efix
+[] = "npf_ext_";
+
+102 
+	#NPF_EXT_PREFLEN
+ ((
+f_ext_efix
+- 1)
+
+	)
+
+104 
+f_ext_t
+ *
+
+105 
+	$f_ext_lookup
+(c *
+me
+, 
+bo
+ 
+autd
+)
+
+107 
+f_ext_t
+ *
+ext
+;
+
+108 
+modme
+[
+RPROC_NAME_LEN
+ + 
+NPF_EXT_PREFLEN
+];
+
+109 
+r
+;
+
+111 
+	`KASSERT
+(
+	`mux_owd
+(&
+ext_lock
+));
+
+113 
+aga
+:
+
+114 
+	`LIST_FOREACH
+(
+ext
+, &
+ext_li
+, 
+ext_y
+)
+
+115 i(
+	`rcmp
+(
+ext
+->
+ext_me
+, 
+me
+) == 0)
+
+118 i(
+ext
+ !
+NULL
+ || !
+autd
+)
+
+119  
+ext
+;
+
+121 
+	`mux_ex
+(&
+ext_lock
+);
+
+122 
+autd
+ = 
+l
+;
+
+123 
+	`tf
+(
+modme
+, (modme), "%s%s", 
+f_ext_efix
+, 
+me
+);
+
+124 
+r
+ = 
+	`modu_autd
+(
+modme
+, 
+MODULE_CLASS_MISC
+);
+
+125 
+	`mux_r
+(&
+ext_lock
+);
+
+127 i(
+r
+)
+
+128  
+NULL
+;
+
+129 
+aga
+;
+
+130 
+	}
+}
+
+133 
+	$f_ext_gi
+(c *
+me
+, c 
+f_ext_s_t
+ *
+s
+)
+
+135 
+f_ext_t
+ *
+ext
+;
+
+137 
+ext
+ = 
+	`kmem_zloc
+((
+f_ext_t
+), 
+KM_SLEEP
+);
+
+138 
+	`y
+(
+ext
+->
+ext_me
+, 
+me
+, 
+EXT_NAME_LEN
+);
+
+139 
+ext
+->
+ext_s
+ = 
+s
+;
+
+141 
+	`mux_r
+(&
+ext_lock
+);
+
+142 i(
+	`f_ext_lookup
+(
+me
+, 
+l
+)) {
+
+143 
+	`mux_ex
+(&
+ext_lock
+);
+
+144 
+	`kmem_
+(
+ext
+, (
+f_ext_t
+));
+
+145  
+NULL
+;
+
+147 
+	`LIST_INSERT_HEAD
+(&
+ext_li
+, 
+ext
+, 
+ext_y
+);
+
+148 
+	`mux_ex
+(&
+ext_lock
+);
+
+150  (*)
+ext
+;
+
+151 
+	}
+}
+
+154 
+	$f_ext_uegi
+(*
+extid
+)
+
+156 
+f_ext_t
+ *
+ext
+ = 
+extid
+;
+
+161 i(
+ext
+->
+ext_ft
+) {
+
+162  
+EBUSY
+;
+
+165 
+	`mux_r
+(&
+ext_lock
+);
+
+166 i(
+ext
+->
+ext_ft
+) {
+
+167 
+	`mux_ex
+(&
+ext_lock
+);
+
+168  
+EBUSY
+;
+
+170 
+	`KASSERT
+(
+	`f_ext_lookup
+(
+ext
+->
+ext_me
+, 
+l
+));
+
+171 
+	`LIST_REMOVE
+(
+ext
+, 
+ext_y
+);
+
+172 
+	`mux_ex
+(&
+ext_lock
+);
+
+174 
+	`kmem_
+(
+ext
+, (
+f_ext_t
+));
+
+176 
+	}
+}
+
+179 
+	$f_ext_cru
+(c *
+me
+, 
+f_roc_t
+ *
+
+, 
+_diiy_t
+ 
+ms
+)
+
+181 c 
+f_ext_s_t
+ *
+exts
+;
+
+182 
+f_ext_t
+ *
+ext
+;
+
+183 
+i
+;
+
+184 
+r
+;
+
+186 i(
+
+->
+_ext_cou
+ >
+RPROC_EXT_COUNT
+) {
+
+187  
+ENOSPC
+;
+
+190 
+	`mux_r
+(&
+ext_lock
+);
+
+191 
+ext
+ = 
+	`f_ext_lookup
+(
+me
+, 
+ue
+);
+
+192 i(
+ext
+) {
+
+193 
+	`omic_c_ut
+(&
+ext
+->
+ext_ft
+);
+
+195 
+	`mux_ex
+(&
+ext_lock
+);
+
+197 i(!
+ext
+) {
+
+198  
+ENOENT
+;
+
+201 
+exts
+ = 
+ext
+->
+ext_s
+;
+
+202 
+	`KASSERT
+(
+exts
+ !
+NULL
+);
+
+204 
+r
+ = 
+exts
+->
+	`
+(
+
+, 
+ms
+);
+
+205 i(
+r
+) {
+
+206 
+	`omic_dec_ut
+(&
+ext
+->
+ext_ft
+);
+
+207  
+r
+;
+
+209 
+i
+ = 
+
+->
+_ext_cou
+++;
+
+210 
+
+->
+_ext
+[
+i
+] = 
+ext
+;
+
+212 
+	}
+}
+
+218 
+f_roct_t
+ *
+
+219 
+	$f_roct_
+()
+
+221 
+f_roct_t
+ *
+t
+;
+
+223 
+t
+ = 
+	`kmem_zloc
+((
+f_roct_t
+), 
+KM_SLEEP
+);
+
+224 
+	`LIST_INIT
+(&
+t
+->
+s_li
+);
+
+225  
+t
+;
+
+226 
+	}
+}
+
+229 
+	$f_roct_deroy
+(
+f_roct_t
+ *
+t
+)
+
+231 
+f_roc_t
+ *
+
+;
+
+233 (
+
+ = 
+	`LIST_FIRST
+(&
+t
+->
+s_li
+)!
+NULL
+) {
+
+234 
+	`LIST_REMOVE
+(
+
+, 
+_y
+);
+
+235 
+	`f_roc_a
+(
+
+);
+
+237 
+	`kmem_
+(
+t
+, (
+f_roct_t
+));
+
+238 
+	}
+}
+
+243 
+f_roc_t
+ *
+
+244 
+	$f_roct_lookup
+(
+f_roct_t
+ *
+t
+, c *
+me
+)
+
+246 
+f_roc_t
+ *
+
+;
+
+248 
+	`LIST_FOREACH
+(
+
+, &
+t
+->
+s_li
+, 
+_y
+) {
+
+249 i(
+	`cmp
+(
+
+->
+_me
+, 
+me
+, 
+RPROC_NAME_LEN
+) == 0)
+
+252  
+
+;
+
+253 
+	}
+}
+
+259 
+	$f_roct_
+(
+f_roct_t
+ *
+t
+, 
+f_roc_t
+ *
+
+)
+
+261 
+	`LIST_INSERT_HEAD
+(&
+t
+->
+s_li
+, 
+
+, 
+_y
+);
+
+262 
+	}
+}
+
+265 
+	$f_roct_expt
+(c 
+f_roct_t
+ *
+t
+, 
+_y_t
+ 
+rocs
+)
+
+267 
+_diiy_t
+ 
+di
+;
+
+268 c 
+f_roc_t
+ *
+
+;
+
+270 
+	`LIST_FOREACH
+(
+
+, &
+t
+->
+s_li
+, 
+_y
+) {
+
+271 
+di
+ = 
+	`_diiy_
+();
+
+272 
+	`_diiy_t_crg
+(
+di
+, "me", 
+
+->
+_me
+);
+
+273 
+	`_diiy_t_ut32
+(
+di
+, "ags", 
+
+->
+_ags
+);
+
+274 
+	`_y_add
+(
+rocs
+, 
+di
+);
+
+275 
+	`_obje_a
+(
+di
+);
+
+278 
+	}
+}
+
+284 
+f_roc_t
+ *
+
+285 
+	$f_roc_
+(
+_diiy_t
+ 
+di
+)
+
+287 c *
+me
+;
+
+288 
+f_roc_t
+ *
+
+;
+
+290 i(!
+	`_diiy_g_crg_nocy
+(
+di
+, "me", &
+me
+)) {
+
+291  
+NULL
+;
+
+294 
+
+ = 
+	`kmem__zloc
+((
+f_roc_t
+), 
+KM_SLEEP
+);
+
+295 
+
+->
+_ft
+ = 1;
+
+297 
+	`y
+(
+
+->
+_me
+, 
+me
+, 
+RPROC_NAME_LEN
+);
+
+298 
+	`_diiy_g_ut32
+(
+di
+, "ags", &
+
+->
+_ags
+);
+
+299  
+
+;
+
+300 
+	}
+}
+
+306 
+	$f_roc_acque
+(
+f_roc_t
+ *
+
+)
+
+308 
+	`omic_c_ut
+(&
+
+->
+_ft
+);
+
+309 
+	}
+}
+
+316 
+	$f_roc_a
+(
+f_roc_t
+ *
+
+)
+
+319 
+	`KASSERT
+(
+
+->
+_ft
+ > 0);
+
+320 i(
+	`omic_dec_ut_nv
+(&
+
+->
+_ft
+) != 0) {
+
+324 
+i
+ = 0; i < 
+
+->
+_ext_cou
+; i++) {
+
+325 
+f_ext_t
+ *
+ext
+ = 
+
+->
+_ext
+[
+i
+];
+
+326 c 
+f_ext_s_t
+ *
+exts
+ = 
+ext
+->
+ext_s
+;
+
+328 
+exts
+->
+	`dt
+(
+
+,p->
+_ext_ma
+[
+i
+]);
+
+329 
+	`omic_dec_ut
+(&
+ext
+->
+ext_ft
+);
+
+331 
+	`kmem__
+(
+
+, (
+f_roc_t
+));
+
+332 
+	}
+}
+
+335 
+	$f_roc_assign
+(
+f_roc_t
+ *
+
+, *
+ms
+)
+
+337 
+i
+ = 
+
+->
+_ext_cou
+;
+
+340 
+	`KASSERT
+(
+i
+ < 
+RPROC_EXT_COUNT
+);
+
+341 
+
+->
+_ext_ma
+[
+i
+] = 
+ms
+;
+
+342 
+	}
+}
+
+349 
+bo
+
+
+350 
+	$f_roc_run
+(
+f_che_t
+ *
+c
+, 
+f_roc_t
+ *
+
+, *
+decisi
+)
+
+352 c 
+extcou
+ = 
+
+->
+_ext_cou
+;
+
+354 
+	`KASSERT
+(!
+	`nbuf_ag_p
+(
+c
+->
+c_nbuf
+, 
+NBUF_DATAREF_RESET
+));
+
+355 
+	`KASSERT
+(
+
+->
+_ft
+ > 0);
+
+357 
+i
+ = 0; i < 
+extcou
+; i++) {
+
+358 c 
+f_ext_t
+ *
+ext
+ = 
+
+->
+_ext
+[
+i
+];
+
+359 c 
+f_ext_s_t
+ *
+exts
+ = 
+ext
+->
+ext_s
+;
+
+361 
+	`KASSERT
+(
+ext
+->
+ext_ft
+ > 0);
+
+362 i(!
+exts
+->
+	`oc
+(
+c
+, 
+
+->
+_ext_ma
+[
+i
+], 
+decisi
+)) {
+
+363  
+l
+;
+
+366 i(
+	`nbuf_ag_p
+(
+c
+->
+c_nbuf
+, 
+NBUF_DATAREF_RESET
+)) {
+
+367 
+	`f_che
+(
+c
+);
+
+371  
+ue
+;
+
+372 
+	}
+}
+
+	@npf/npf_ruleset.c
+
+36 
+	~<sys/cdefs.h
+>
+
+37 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_ruleset.c,v 1.42 2015/03/20 23:36:28mind Exp $");
+
+39 
+	~<sys/m.h
+>
+
+40 
+	~<sys/tys.h
+>
+
+42 
+	~<sys/omic.h
+>
+
+43 
+	~<sys/kmem.h
+>
+
+44 
+	~<sys/queue.h
+>
+
+45 
+	~<sys/mbuf.h
+>
+
+46 
+	~<sys/tys.h
+>
+
+48 
+	~<t/bpf.h
+>
+
+49 
+	~<t/bpfj.h
+>
+
+50 
+	~<t/pf.h
+>
+
+51 
+	~<t/if.h
+>
+
+53 
+	~"f_im.h
+"
+
+55 
+	sf_rut
+ {
+
+61 
+LIST_HEAD
+(, 
+f_ru
+
+	mrs_l
+;
+
+62 
+LIST_HEAD
+(, 
+f_ru
+
+	mrs_dymic
+;
+
+63 
+LIST_HEAD
+(, 
+f_ru
+
+	mrs_gc
+;
+
+66 
+ut64_t
+ 
+	mrs_idt
+;
+
+69 
+u_t
+ 
+	mrs_s
+;
+
+70 
+u_t
+ 
+	mrs_nems
+;
+
+73 
+f_ru_t
+ * 
+	mrs_rus
+[];
+
+76 
+	sf_ru
+ {
+
+78 
+ut32_t
+ 
+	mr_
+;
+
+79 
+u_t
+ 
+	mr_ifid
+;
+
+80 
+u_t
+ 
+	mr_sk_to
+;
+
+83 
+	mr_ty
+;
+
+84 
+bpfj_func_t
+ 
+	mr_jcode
+;
+
+85 * 
+	mr_code
+;
+
+86 
+u_t
+ 
+	mr_
+;
+
+89 
+f_icy_t
+ * 
+	mr_
+;
+
+90 
+f_roc_t
+ * 
+	mr_roc
+;
+
+97 
+f_ru_t
+ * 
+	mr_subt
+;
+
+98 
+LIST_ENTRY
+(
+f_ru
+
+	mr_dy
+;
+
+105 
+	mr_iy
+;
+
+106 
+f_ru_t
+ * 
+	mr_
+;
+
+107 
+f_ru_t
+ * 
+	mr_xt
+;
+
+112 
+ut64_t
+ 
+	mr_id
+;
+
+113 
+	mr_me
+[
+NPF_RULE_MAXNAMELEN
+];
+
+114 
+ut8_t
+ 
+	mr_key
+[
+NPF_RULE_MAXKEYLEN
+];
+
+117 
+LIST_ENTRY
+(
+f_ru
+
+	mr_ry
+;
+
+118 
+_da_t
+ 
+	mr_fo
+;
+
+121 
+	#SKIPTO_ADJ_FLAG
+ (1U << 31)
+
+	)
+
+122 
+	#SKIPTO_MASK
+ (
+SKIPTO_ADJ_FLAG
+ - 1)
+
+	)
+
+124 
+f_ru_expt
+(c 
+f_rut_t
+ *,
+
+125 c 
+f_ru_t
+ *, 
+_diiy_t
+);
+
+130 
+	#NPF_RULE_KEEPNAT
+ (0x01000000 & 
+NPF_RULE_PRIVMASK
+)
+
+	)
+
+132 
+	#NPF_DYNAMIC_GROUP_P
+(
+
+) \
+
+133 (((
+
+& 
+NPF_DYNAMIC_GROUP
+=NPF_DYNAMIC_GROUP)
+
+	)
+
+135 
+	#NPF_DYNAMIC_RULE_P
+(
+
+) \
+
+136 (((
+
+& 
+NPF_DYNAMIC_GROUP
+=
+NPF_RULE_DYNAMIC
+)
+
+	)
+
+138 
+f_rut_t
+ *
+
+139 
+	$f_rut_
+(
+size_t
+ 
+s
+)
+
+141 
+size_t
+ 
+n
+ = 
+	`offtof
+(
+f_rut_t
+, 
+rs_rus
+[
+s
+]);
+
+142 
+f_rut_t
+ *
+t
+;
+
+144 
+t
+ = 
+	`kmem_zloc
+(
+n
+, 
+KM_SLEEP
+);
+
+145 
+	`LIST_INIT
+(&
+t
+->
+rs_dymic
+);
+
+146 
+	`LIST_INIT
+(&
+t
+->
+rs_l
+);
+
+147 
+	`LIST_INIT
+(&
+t
+->
+rs_gc
+);
+
+148 
+t
+->
+rs_s
+ = 
+s
+;
+
+150  
+t
+;
+
+151 
+	}
+}
+
+154 
+	$f_rut_deroy
+(
+f_rut_t
+ *
+t
+)
+
+156 
+size_t
+ 
+n
+ = 
+	`offtof
+(
+f_rut_t
+, 
+rs_rus
+[
+t
+->
+rs_s
+]);
+
+157 
+f_ru_t
+ *
+
+;
+
+159 (
+
+ = 
+	`LIST_FIRST
+(&
+t
+->
+rs_l
+)!
+NULL
+) {
+
+160 i(
+	`NPF_DYNAMIC_GROUP_P
+(
+
+->
+r_
+)) {
+
+165 
+
+->
+r_subt
+ = 
+NULL
+;
+
+166 
+	`LIST_REMOVE
+(
+
+, 
+r_dy
+);
+
+168 i(
+	`NPF_DYNAMIC_RULE_P
+(
+
+->
+r_
+)) {
+
+170 
+	`KASSERT
+(
+
+->
+r_
+ !
+NULL
+);
+
+172 
+	`LIST_REMOVE
+(
+
+, 
+r_ry
+);
+
+173 
+	`f_ru_
+(
+
+);
+
+175 
+	`KASSERT
+(
+	`LIST_EMPTY
+(&
+t
+->
+rs_dymic
+));
+
+176 
+	`KASSERT
+(
+	`LIST_EMPTY
+(&
+t
+->
+rs_gc
+));
+
+177 
+	`kmem_
+(
+t
+, 
+n
+);
+
+178 
+	}
+}
+
+184 
+	$f_rut_
+(
+f_rut_t
+ *
+t
+, 
+f_ru_t
+ *
+
+)
+
+186 
+u_t
+ 
+n
+ = 
+t
+->
+rs_nems
+;
+
+188 
+	`KASSERT
+(
+n
+ < 
+t
+->
+rs_s
+);
+
+190 
+	`LIST_INSERT_HEAD
+(&
+t
+->
+rs_l
+, 
+
+, 
+r_ry
+);
+
+191 i(
+	`NPF_DYNAMIC_GROUP_P
+(
+
+->
+r_
+)) {
+
+192 
+	`LIST_INSERT_HEAD
+(&
+t
+->
+rs_dymic
+, 
+
+, 
+r_dy
+);
+
+194 
+	`KASSERTMSG
+(
+
+->
+r_
+ =
+NULL
+, "cannot be dynamicule");
+
+195 
+
+->
+r_
+ &~
+NPF_RULE_DYNAMIC
+;
+
+198 
+t
+->
+rs_rus
+[
+n
+] = 
+
+;
+
+199 
+t
+->
+rs_nems
+++;
+
+201 i(
+
+->
+r_sk_to
+ < ++
+n
+) {
+
+202 
+
+->
+r_sk_to
+ = 
+SKIPTO_ADJ_FLAG
+ | 
+n
+;
+
+204 
+	}
+}
+
+206 
+f_ru_t
+ *
+
+207 
+	$f_rut_lookup
+(
+f_rut_t
+ *
+t
+, c *
+me
+)
+
+209 
+f_ru_t
+ *
+
+;
+
+211 
+	`KASSERT
+(
+	`f_cfig_locked_p
+());
+
+213 
+	`LIST_FOREACH
+(
+
+, &
+t
+->
+rs_dymic
+, 
+r_dy
+) {
+
+214 
+	`KASSERT
+(
+	`NPF_DYNAMIC_GROUP_P
+(
+
+->
+r_
+));
+
+215 i(
+	`cmp
+(
+
+->
+r_me
+, 
+me
+, 
+NPF_RULE_MAXNAMELEN
+) == 0)
+
+218  
+
+;
+
+219 
+	}
+}
+
+225 
+	$f_rut_add
+(
+f_rut_t
+ *
+t
+, c *
+ame
+, 
+f_ru_t
+ *
+
+)
+
+227 
+f_ru_t
+ *
+rg
+, *
+
+, *
+rg
+;
+
+228 
+iocmd
+;
+
+230 i(!
+	`NPF_DYNAMIC_RULE_P
+(
+
+->
+r_
+)) {
+
+231  
+EINVAL
+;
+
+233 
+rg
+ = 
+	`f_rut_lookup
+(
+t
+, 
+ame
+);
+
+234 i(
+rg
+ =
+NULL
+) {
+
+235  
+ESRCH
+;
+
+239 
+
+->
+r_id
+ = ++
+t
+->
+rs_idt
+;
+
+240 
+
+->
+r_
+ = 
+rg
+;
+
+246 i((
+iocmd
+ = 
+
+->
+r_iy
+) < 0) {
+
+247 
+
+->
+r_iy
+ = 0;
+
+255 
+iocmd
+) {
+
+256 
+NPF_PRI_LAST
+:
+
+258 
+rg
+ = 
+NULL
+;
+
+259 
+
+ = 
+rg
+->
+r_subt
+;
+
+260 
+
+ && it->
+r_iy
+ <
+
+->r_priority) {
+
+261 
+rg
+ = 
+
+;
+
+262 
+
+ = it->
+r_xt
+;
+
+264 i(
+rg
+) {
+
+265 
+
+->
+r_xt
+ = 
+rg
+->r_next;
+
+266 
+	`memb_odur
+();
+
+267 
+rg
+->
+r_xt
+ = 
+
+;
+
+272 
+NPF_PRI_FIRST
+:
+
+273 
+
+->
+r_xt
+ = 
+rg
+->
+r_subt
+;
+
+274 
+	`memb_odur
+();
+
+275 
+rg
+->
+r_subt
+ = 
+
+;
+
+280 
+	`LIST_INSERT_HEAD
+(&
+t
+->
+rs_l
+, 
+
+, 
+r_ry
+);
+
+282 
+	}
+}
+
+285 
+	$f_rut_uk
+(
+f_ru_t
+ *
+
+,pf_ru_*
+ev
+)
+
+287 
+	`KASSERT
+(
+	`NPF_DYNAMIC_RULE_P
+(
+
+->
+r_
+));
+
+288 i(
+ev
+) {
+
+289 
+ev
+->
+r_xt
+ = 
+
+->r_next;
+
+291 
+f_ru_t
+ *
+rg
+ = 
+
+->
+r_
+;
+
+292 
+rg
+->
+r_subt
+ = 
+
+->
+r_xt
+;
+
+294 
+	`LIST_REMOVE
+(
+
+, 
+r_ry
+);
+
+295 
+	}
+}
+
+301 
+	$f_rut_move
+(
+f_rut_t
+ *
+t
+, c *
+ame
+, 
+ut64_t
+ 
+id
+)
+
+303 
+f_ru_t
+ *
+rg
+, *
+ev
+ = 
+NULL
+;
+
+305 i((
+rg
+ = 
+	`f_rut_lookup
+(
+t
+, 
+ame
+)=
+NULL
+) {
+
+306  
+ESRCH
+;
+
+308 
+f_ru_t
+ *
+
+ = 
+rg
+->
+r_subt
+;l;->
+r_xt
+) {
+
+309 
+	`KASSERT
+(
+
+->
+r_
+ =
+rg
+);
+
+310 
+	`KASSERT
+(
+	`NPF_DYNAMIC_RULE_P
+(
+
+->
+r_
+));
+
+313 i(
+
+->
+r_id
+ =
+id
+) {
+
+314 
+	`f_rut_uk
+(
+
+, 
+ev
+);
+
+315 
+	`LIST_INSERT_HEAD
+(&
+t
+->
+rs_gc
+, 
+
+, 
+r_ry
+);
+
+318 
+ev
+ = 
+
+;
+
+320  
+ENOENT
+;
+
+321 
+	}
+}
+
+327 
+	$f_rut_mkey
+(
+f_rut_t
+ *
+t
+, c *
+ame
+,
+
+328 c *
+key
+, 
+size_t
+ 
+n
+)
+
+330 
+f_ru_t
+ *
+rg
+, *
+a
+ = 
+NULL
+, *
+ev
+ = NULL, *
+ev
+ = NULL;
+
+332 
+	`KASSERT
+(
+n
+ && <
+NPF_RULE_MAXKEYLEN
+);
+
+334 i((
+rg
+ = 
+	`f_rut_lookup
+(
+t
+, 
+ame
+)=
+NULL
+) {
+
+335  
+ESRCH
+;
+
+339 
+f_ru_t
+ *
+
+ = 
+rg
+->
+r_subt
+;l;->
+r_xt
+) {
+
+340 
+	`KASSERT
+(
+
+->
+r_
+ =
+rg
+);
+
+341 
+	`KASSERT
+(
+	`NPF_DYNAMIC_RULE_P
+(
+
+->
+r_
+));
+
+342 i(
+	`memcmp
+(
+
+->
+r_key
+, 
+key
+, 
+n
+) == 0) {
+
+343 
+ev
+ = 
+ev
+;
+
+344 
+a
+ = 
+
+;
+
+346 
+ev
+ = 
+
+;
+
+348 i(!
+a
+) {
+
+349  
+ENOENT
+;
+
+351 
+	`f_rut_uk
+(
+a
+, 
+ev
+);
+
+352 
+	`LIST_INSERT_HEAD
+(&
+t
+->
+rs_gc
+, 
+a
+, 
+r_ry
+);
+
+354 
+	}
+}
+
+359 
+_diiy_t
+
+
+360 
+	$f_rut_li
+(
+f_rut_t
+ *
+t
+, c *
+ame
+)
+
+362 
+_diiy_t
+ 
+rgdi
+;
+
+363 
+_y_t
+ 
+rus
+;
+
+364 
+f_ru_t
+ *
+rg
+;
+
+366 
+	`KASSERT
+(
+	`f_cfig_locked_p
+());
+
+368 i((
+rg
+ = 
+	`f_rut_lookup
+(
+t
+, 
+ame
+)=
+NULL
+) {
+
+369  
+NULL
+;
+
+371 i((
+rgdi
+ = 
+	`_diiy_
+()=
+NULL
+) {
+
+372  
+NULL
+;
+
+374 i((
+rus
+ = 
+	`_y_
+()=
+NULL
+) {
+
+375 
+	`_obje_a
+(
+rgdi
+);
+
+376  
+NULL
+;
+
+379 
+f_ru_t
+ *
+
+ = 
+rg
+->
+r_subt
+;l;->
+r_xt
+) {
+
+380 
+_diiy_t
+ 
+di
+;
+
+382 
+	`KASSERT
+(
+
+->
+r_
+ =
+rg
+);
+
+383 
+	`KASSERT
+(
+	`NPF_DYNAMIC_RULE_P
+(
+
+->
+r_
+));
+
+385 
+di
+ = 
+	`_diiy_
+();
+
+386 i(
+	`f_ru_expt
+(
+t
+, 
+
+, 
+di
+)) {
+
+387 
+	`_obje_a
+(
+di
+);
+
+388 
+	`_obje_a
+(
+rus
+);
+
+389  
+NULL
+;
+
+391 
+	`_y_add
+(
+rus
+, 
+di
+);
+
+392 
+	`_obje_a
+(
+di
+);
+
+395 i(!
+	`_diiy_t
+(
+rgdi
+, "rus", 
+rus
+)) {
+
+396 
+	`_obje_a
+(
+rgdi
+);
+
+397 
+rgdi
+ = 
+NULL
+;
+
+399 
+	`_obje_a
+(
+rus
+);
+
+400  
+rgdi
+;
+
+401 
+	}
+}
+
+408 
+	$f_rut_ush
+(
+f_rut_t
+ *
+t
+, c *
+ame
+)
+
+410 
+f_ru_t
+ *
+rg
+, *
+
+;
+
+412 i((
+rg
+ = 
+	`f_rut_lookup
+(
+t
+, 
+ame
+)=
+NULL
+) {
+
+413  
+ESRCH
+;
+
+416 
+
+ = 
+	`omic_sw_r
+(&
+rg
+->
+r_subt
+, 
+NULL
+);
+
+417 
+	`memb_odur
+();
+
+419 
+
+) {
+
+420 
+	`KASSERT
+(
+	`NPF_DYNAMIC_RULE_P
+(
+
+->
+r_
+));
+
+421 
+	`KASSERT
+(
+
+->
+r_
+ =
+rg
+);
+
+423 
+	`LIST_REMOVE
+(
+
+, 
+r_ry
+);
+
+424 
+	`LIST_INSERT_HEAD
+(&
+t
+->
+rs_gc
+, 
+
+, 
+r_ry
+);
+
+425 
+
+ =l->
+r_xt
+;
+
+428 
+	}
+}
+
+434 
+	$f_rut_gc
+(
+f_rut_t
+ *
+t
+)
+
+436 
+f_ru_t
+ *
+
+;
+
+438 (
+
+ = 
+	`LIST_FIRST
+(&
+t
+->
+rs_gc
+)!
+NULL
+) {
+
+439 
+	`LIST_REMOVE
+(
+
+, 
+r_ry
+);
+
+440 
+	`f_ru_
+(
+
+);
+
+442 
+	}
+}
+
+448 
+	$f_rut_expt
+(c 
+f_rut_t
+ *
+t
+, 
+_y_t
+ 
+rus
+)
+
+450 c 
+u_t
+ 
+nems
+ = 
+t
+->
+rs_nems
+;
+
+451 
+r
+ = 0;
+
+452 
+u_t
+ 
+n
+ = 0;
+
+454 
+	`KASSERT
+(
+	`f_cfig_locked_p
+());
+
+456 
+n
+ < 
+nems
+) {
+
+457 c 
+f_ru_t
+ *
+
+ = 
+t
+->
+rs_rus
+[
+n
+];
+
+458 c 
+f_icy_t
+ *
+
+ = 
+
+->
+r_
+;
+
+459 
+_diiy_t
+ 
+di
+;
+
+461 
+di
+ = 
+	`_diiy_
+();
+
+462 i((
+r
+ = 
+	`f_ru_expt
+(
+t
+, 
+
+, 
+di
+)) != 0) {
+
+463 
+	`_obje_a
+(
+di
+);
+
+466 i(
+
+ && (
+r
+ = 
+	`f_t_picyexpt
+p, 
+di
+)) != 0) {
+
+467 
+	`_obje_a
+(
+di
+);
+
+470 
+	`_y_add
+(
+rus
+, 
+di
+);
+
+471 
+	`_obje_a
+(
+di
+);
+
+472 
+n
+++;
+
+474  
+r
+;
+
+475 
+	}
+}
+
+484 
+	$f_rut_ld
+(
+f_rut_t
+ *
+wt
+,pf_rut_*
+dt
+, 
+bo
+ 
+ld
+)
+
+486 
+f_ru_t
+ *
+rg
+, *
+
+;
+
+487 
+ut64_t
+ 
+nid
+ = 0;
+
+489 
+	`KASSERT
+(
+	`f_cfig_locked_p
+());
+
+494 
+	`LIST_FOREACH
+(
+rg
+, &
+wt
+->
+rs_dymic
+, 
+r_dy
+) {
+
+495 
+f_ru_t
+ *
+aive_rgroup
+;
+
+498 
+aive_rgroup
+ = 
+	`f_rut_lookup
+(
+dt
+, 
+rg
+->
+r_me
+);
+
+499 i(
+aive_rgroup
+ =
+NULL
+) {
+
+510 
+rg
+->
+r_subt
+ = 
+aive_rgroup
+->r_subset;
+
+516 
+
+ = 
+rg
+->
+r_subt
+;l;->
+r_xt
+) {
+
+517 
+	`KASSERT
+(
+	`NPF_DYNAMIC_RULE_P
+(
+
+->
+r_
+));
+
+518 
+	`LIST_REMOVE
+(
+
+, 
+r_ry
+);
+
+519 
+	`LIST_INSERT_HEAD
+(&
+wt
+->
+rs_l
+, 
+
+, 
+r_ry
+);
+
+521 
+	`KASSERT
+(
+
+->
+r_
+ =
+aive_rgroup
+);
+
+522 
+
+->
+r_
+ = 
+rg
+;
+
+531 i(
+ld
+)
+
+538 
+	`LIST_FOREACH
+(
+
+, &
+wt
+->
+rs_l
+, 
+r_ry
+) {
+
+539 
+f_icy_t
+ *
+
+;
+
+540 
+f_ru_t
+ *
+a
+;
+
+543 i((
+
+ = 
+
+->
+r_
+=
+NULL
+) {
+
+552 
+	`f_rut_shm
+(
+dt
+, 
+
+);
+
+555 
+	`LIST_FOREACH
+(
+a
+, &
+dt
+->
+rs_l
+, 
+r_ry
+) {
+
+556 i(!
+a
+->
+r_
+)
+
+558 i((
+a
+->
+r_
+ & 
+NPF_RULE_KEEPNAT
+) != 0)
+
+560 i(
+	`f_t_cmicy
+(
+a
+->
+r_
+, 
+
+))
+
+563 i(!
+a
+) {
+
+565 
+	`f_t_tid
+(
+
+, ++
+nid
+);
+
+570 
+
+->
+r_
+ = 
+a
+->r_natp;
+
+571 
+	`f_t_tid
+(
+
+->
+r_
+, ++
+nid
+);
+
+578 
+a
+->
+r_
+ |
+NPF_RULE_KEEPNAT
+;
+
+579 
+	`f_t_picy
+(
+
+);
+
+583 
+wt
+->
+rs_idt
+ = 
+dt
+->rs_idcnt;
+
+584 
+	}
+}
+
+589 
+f_ru_t
+ *
+
+590 
+	$f_rut_shm
+(
+f_rut_t
+ *
+t
+, 
+f_icy_t
+ *
+m
+)
+
+592 
+f_icy_t
+ *
+
+;
+
+593 
+f_ru_t
+ *
+
+;
+
+602 
+	`LIST_FOREACH
+(
+
+, &
+t
+->
+rs_l
+, 
+r_ry
+) {
+
+603 
+
+ = 
+
+->
+r_
+;
+
+604 i(
+
+ =
+NULL
+ ||=
+m
+)
+
+606 i(
+	`f_t_shm
+(
+
+, 
+m
+))
+
+609  
+
+;
+
+610 
+	}
+}
+
+612 
+f_icy_t
+ *
+
+613 
+	$f_rut_fdt
+(
+f_rut_t
+ *
+t
+, 
+ut64_t
+ 
+id
+)
+
+615 
+f_ru_t
+ *
+
+;
+
+617 
+	`LIST_FOREACH
+(
+
+, &
+t
+->
+rs_l
+, 
+r_ry
+) {
+
+618 
+f_icy_t
+ *
+
+ = 
+
+->
+r_
+;
+
+619 i(
+
+ && 
+	`f_t_gid
+p=
+id
+) {
+
+620  
+
+;
+
+623  
+NULL
+;
+
+624 
+	}
+}
+
+631 
+	$f_rut_g
+(
+f_rut_t
+ *
+t
+, 
+f_g_t
+ *
+g
+)
+
+633 
+f_ru_t
+ *
+
+;
+
+634 
+f_icy_t
+ *
+
+;
+
+636 
+	`LIST_FOREACH
+(
+
+, &
+t
+->
+rs_l
+, 
+r_ry
+) {
+
+637 i((
+
+ = 
+
+->
+r_
+!
+NULL
+) {
+
+638 
+	`f_t_g
+(
+
+, 
+g
+);
+
+641 
+	}
+}
+
+646 
+f_ru_t
+ *
+
+647 
+	$f_ru_loc
+(
+_diiy_t
+ 
+di
+)
+
+649 
+f_ru_t
+ *
+
+;
+
+650 c *
+ame
+;
+
+651 
+_da_t
+ 
+d
+;
+
+654 
+
+ = 
+	`kmem_zloc
+((
+f_ru_t
+), 
+KM_SLEEP
+);
+
+655 
+
+->
+r_
+ = 
+NULL
+;
+
+658 i(
+	`_diiy_g_crg_nocy
+(
+di
+, "me", &
+ame
+)) {
+
+659 
+	`y
+(
+
+->
+r_me
+, 
+ame
+, 
+NPF_RULE_MAXNAMELEN
+);
+
+661 
+
+->
+r_me
+[0] = '\0';
+
+665 
+	`_diiy_g_ut32
+(
+di
+, "", &
+
+->
+r_
+);
+
+666 
+
+->
+r_
+ &~
+NPF_RULE_PRIVMASK
+;
+
+668 i(
+	`NPF_DYNAMIC_RULE_P
+(
+
+->
+r_
+)) {
+
+670 
+	`_diiy_g_t32
+(
+di
+, "io", &
+
+->
+r_iy
+);
+
+673 
+	`_diiy_g_ut32
+(
+di
+, "sk-to", &
+
+->
+r_sk_to
+);
+
+677 i(
+	`_diiy_g_crg_nocy
+(
+di
+, "iame", &
+ame
+)) {
+
+678 i((
+
+->
+r_ifid
+ = 
+	`f_ifm_gi
+(
+ame
+)) == 0) {
+
+679 
+	`kmem_
+(
+
+, (
+f_ru_t
+));
+
+680  
+NULL
+;
+
+683 
+
+->
+r_ifid
+ = 0;
+
+687 
+_obje_t
+ 
+obj
+ = 
+	`_diiy_g
+(
+di
+, "key");
+
+688 c *
+key
+ = 
+	`_da_da_nocy
+(
+obj
+);
+
+690 i(
+key
+) {
+
+691 
+size_t
+ 
+n
+ = 
+	`_da_size
+(
+obj
+);
+
+692 i(
+n
+ > 
+NPF_RULE_MAXKEYLEN
+) {
+
+693 
+	`kmem_
+(
+
+, (
+f_ru_t
+));
+
+694  
+NULL
+;
+
+696 
+	`memy
+(
+
+->
+r_key
+, 
+key
+, 
+n
+);
+
+699 i((
+d
+ = 
+	`_diiy_g
+(
+di
+, "fo")!
+NULL
+) {
+
+700 
+
+->
+r_fo
+ = 
+	`_da_cy
+(
+d
+);
+
+702  
+
+;
+
+703 
+	}
+}
+
+706 
+	$f_ru_expt
+(c 
+f_rut_t
+ *
+t
+, c 
+f_ru_t
+ *
+
+,
+
+707 
+_diiy_t
+ 
+di
+)
+
+709 
+u_t
+ 
+sk_to
+ = 0;
+
+710 
+_da_t
+ 
+d
+;
+
+712 
+	`_diiy_t_ut32
+(
+di
+, "", 
+
+->
+r_
+);
+
+713 
+	`_diiy_t_t32
+(
+di
+, "io", 
+
+->
+r_iy
+);
+
+714 i((
+
+->
+r_sk_to
+ & 
+SKIPTO_ADJ_FLAG
+) == 0) {
+
+715 
+sk_to
+ = 
+
+->
+r_sk_to
+ & 
+SKIPTO_MASK
+;
+
+717 
+	`_diiy_t_ut32
+(
+di
+, "sk-to", 
+sk_to
+);
+
+718 
+	`_diiy_t_t32
+(
+di
+, "code-ty", 
+
+->
+r_ty
+);
+
+719 i(
+
+->
+r_code
+) {
+
+720 
+d
+ = 
+	`_da__da
+(
+
+->
+r_code
+,l->
+r_
+);
+
+721 
+	`_diiy_t_d_l
+(
+di
+, "code", 
+d
+);
+
+724 i(
+
+->
+r_ifid
+) {
+
+725 c *
+iame
+ = 
+	`f_ifm_gme
+(
+
+->
+r_ifid
+);
+
+726 
+	`_diiy_t_crg
+(
+di
+, "iame", 
+iame
+);
+
+728 
+	`_diiy_t_ut64
+(
+di
+, "id", 
+
+->
+r_id
+);
+
+730 i(
+
+->
+r_me
+[0]) {
+
+731 
+	`_diiy_t_crg
+(
+di
+, "me", 
+
+->
+r_me
+);
+
+733 i(
+	`NPF_DYNAMIC_RULE_P
+(
+
+->
+r_
+)) {
+
+734 
+d
+ = 
+	`_da__da
+(
+
+->
+r_key
+, 
+NPF_RULE_MAXKEYLEN
+);
+
+735 
+	`_diiy_t_d_l
+(
+di
+, "key", 
+d
+);
+
+737 i(
+
+->
+r_fo
+) {
+
+738 
+	`_diiy_t
+(
+di
+, "fo", 
+
+->
+r_fo
+);
+
+741 
+	}
+}
+
+750 
+	$f_ru_tcode
+(
+f_ru_t
+ *
+
+, c 
+ty
+, *
+code
+, 
+size_t
+ 
+size
+)
+
+752 
+	`KASSERT
+(
+ty
+ =
+NPF_CODE_BPF
+);
+
+754 
+
+->
+r_ty
+ = 
+ty
+;
+
+755 
+
+->
+r_code
+ = 
+code
+;
+
+756 
+
+->
+r_
+ = 
+size
+;
+
+757 
+
+->
+r_jcode
+ = 
+	`f_bpf_compe
+(
+code
+, 
+size
+);
+
+758 
+	}
+}
+
+764 
+	$f_ru_oc
+(
+f_ru_t
+ *
+
+, 
+f_roc_t
+ *
+
+)
+
+766 
+	`f_roc_acque
+(
+
+);
+
+767 
+
+->
+r_roc
+ = 
+
+;
+
+768 
+	}
+}
+
+774 
+	$f_ru_
+(
+f_ru_t
+ *
+
+)
+
+776 
+f_icy_t
+ *
+
+ = 
+
+->
+r_
+;
+
+777 
+f_roc_t
+ *
+
+ = 
+
+->
+r_roc
+;
+
+779 i(
+
+ && (
+
+->
+r_
+ & 
+NPF_RULE_KEEPNAT
+) == 0) {
+
+781 
+	`f_t_picy
+(
+
+);
+
+783 i(
+
+) {
+
+785 
+	`f_roc_a
+(
+
+);
+
+787 i(
+
+->
+r_code
+) {
+
+789 
+	`kmem_
+(
+
+->
+r_code
+,l->
+r_
+);
+
+791 i(
+
+->
+r_jcode
+) {
+
+793 
+	`bpf_j_code
+(
+
+->
+r_jcode
+);
+
+795 i(
+
+->
+r_fo
+) {
+
+796 
+	`_obje_a
+(
+
+->
+r_fo
+);
+
+798 
+	`kmem_
+(
+
+, (
+f_ru_t
+));
+
+799 
+	}
+}
+
+807 
+ut64_t
+
+
+808 
+	$f_ru_gid
+(c 
+f_ru_t
+ *
+
+)
+
+810 
+	`KASSERT
+(
+	`NPF_DYNAMIC_RULE_P
+(
+
+->
+r_
+));
+
+811  
+
+->
+r_id
+;
+
+812 
+	}
+}
+
+814 
+f_roc_t
+ *
+
+815 
+	$f_ru_groc
+(c 
+f_ru_t
+ *
+
+)
+
+817 
+f_roc_t
+ *
+
+ = 
+
+->
+r_roc
+;
+
+819 i(
+
+) {
+
+820 
+	`f_roc_acque
+(
+
+);
+
+822  
+
+;
+
+823 
+	}
+}
+
+825 
+f_icy_t
+ *
+
+826 
+	$f_ru_gt
+(c 
+f_ru_t
+ *
+
+)
+
+828  
+
+->
+r_
+;
+
+829 
+	}
+}
+
+836 
+	$f_ru_
+(
+f_ru_t
+ *
+
+, 
+f_icy_t
+ *
+
+)
+
+838 
+	`KASSERT
+(
+
+->
+r_
+ =
+NULL
+);
+
+839 
+
+->
+r_
+ = 
+
+;
+
+840 
+	}
+}
+
+846 
+le
+ 
+bo
+
+
+847 
+	$f_ru_e
+(c 
+f_ru_t
+ *
+
+, 
+bpf_gs_t
+ *
+bc_gs
+,
+
+848 c 
+di_mask
+, c 
+u_t
+ 
+ifid
+)
+
+851 i(
+
+->
+r_ifid
+ &&l->r_ifid !
+ifid
+) {
+
+852  
+l
+;
+
+856 i((
+
+->
+r_
+ & 
+NPF_RULE_DIMASK
+) != NPF_RULE_DIMASK) {
+
+857 i((
+
+->
+r_
+ & 
+di_mask
+) == 0)
+
+858  
+l
+;
+
+862 i(!
+
+->
+r_code
+) {
+
+863 
+	`KASSERT
+(
+
+->
+r_jcode
+ =
+NULL
+);
+
+864  
+ue
+;
+
+866 
+	`KASSERT
+(
+
+->
+r_ty
+ =
+NPF_CODE_BPF
+);
+
+867  
+	`f_bpf_fr
+(
+bc_gs
+, 
+
+->
+r_code
+,l->
+r_jcode
+) != 0;
+
+868 
+	}
+}
+
+874 
+le
+ 
+f_ru_t
+ *
+
+875 
+	$f_ru_e
+(c 
+f_ru_t
+ *
+rg
+, 
+bpf_gs_t
+ *
+bc_gs
+,
+
+876 c 
+di_mask
+, c 
+u_t
+ 
+ifid
+)
+
+878 
+f_ru_t
+ *
+f_
+ = 
+NULL
+, *
+
+;
+
+880 
+	`KASSERT
+(
+	`NPF_DYNAMIC_GROUP_P
+(
+rg
+->
+r_
+));
+
+882 
+
+ = 
+rg
+->
+r_subt
+;l;->
+r_xt
+) {
+
+883 
+	`KASSERT
+(!
+f_
+ || 
+
+->
+r_iy
+ >= final_rl->r_priority);
+
+884 i(!
+	`f_ru_e
+(
+
+, 
+bc_gs
+, 
+di_mask
+, 
+ifid
+)) {
+
+887 i(
+
+->
+r_
+ & 
+NPF_RULE_FINAL
+) {
+
+888  
+
+;
+
+890 
+f_
+ = 
+
+;
+
+892  
+f_
+;
+
+893 
+	}
+}
+
+901 
+f_ru_t
+ *
+
+902 
+	$f_rut_e
+(
+f_che_t
+ *
+c
+, c 
+f_rut_t
+ *
+t
+,
+
+903 c 
+di
+, c 
+y
+)
+
+905 
+nbuf_t
+ *
+nbuf
+ = 
+c
+->
+c_nbuf
+;
+
+906 c 
+di_mask
+ = (
+di
+ & 
+PFIL_IN
+? 
+NPF_RULE_IN
+ : 
+NPF_RULE_OUT
+;
+
+907 c 
+u_t
+ 
+nems
+ = 
+t
+->
+rs_nems
+;
+
+908 c 
+u_t
+ 
+ifid
+ = 
+nbuf
+->
+nb_ifid
+;
+
+909 
+f_ru_t
+ *
+f_
+ = 
+NULL
+;
+
+910 
+bpf_gs_t
+ 
+bc_gs
+;
+
+911 
+u_t
+ 
+n
+ = 0;
+
+913 
+	`KASSERT
+(((
+di
+ & 
+PFIL_IN
+!0^ ((d& 
+PFIL_OUT
+) != 0));
+
+919 
+ut32_t
+ 
+bc_wds
+[
+NPF_BPF_NWORDS
+];
+
+920 
+	`f_bpf_e
+(
+c
+, &
+bc_gs
+, 
+bc_wds
+);
+
+922 
+n
+ < 
+nems
+) {
+
+923 
+f_ru_t
+ *
+
+ = 
+t
+->
+rs_rus
+[
+n
+];
+
+924 c 
+u_t
+ 
+sk_to
+ = 
+
+->
+r_sk_to
+ & 
+SKIPTO_MASK
+;
+
+925 c 
+ut32_t
+ 
+
+ = 
+
+->
+r_
+;
+
+927 
+	`KASSERT
+(!
+	`nbuf_ag_p
+(
+nbuf
+, 
+NBUF_DATAREF_RESET
+));
+
+928 
+	`KASSERT
+(
+n
+ < 
+sk_to
+);
+
+931 i((
+
+ & 
+NPF_RULE_GROUP
+!0 && 
+f_
+) {
+
+936 i(!
+	`f_ru_e
+(
+
+, &
+bc_gs
+, 
+di_mask
+, 
+ifid
+)) {
+
+937 
+n
+ = 
+sk_to
+;
+
+941 i(
+	`NPF_DYNAMIC_GROUP_P
+(
+
+)) {
+
+946 
+
+ = 
+	`f_ru_e
+l, &
+bc_gs
+, 
+di_mask
+, 
+ifid
+);
+
+947 i(
+
+ !
+NULL
+) {
+
+948 
+f_
+ = 
+
+;
+
+951 } i((
+
+ & 
+NPF_RULE_GROUP
+) == 0) {
+
+955 
+f_
+ = 
+
+;
+
+959 i(
+
+ & 
+NPF_RULE_FINAL
+) {
+
+962 
+n
+++;
+
+965 
+	`KASSERT
+(!
+	`nbuf_ag_p
+(
+nbuf
+, 
+NBUF_DATAREF_RESET
+));
+
+966  
+f_
+;
+
+967 
+	}
+}
+
+975 
+	$f_ru_cude
+(c 
+f_ru_t
+ *
+
+, *
+t
+)
+
+978 *
+t
+ = 
+
+->
+r_
+;
+
+979  (
+
+->
+r_
+ & 
+NPF_RULE_PASS
+? 0 : 
+ENETUNREACH
+;
+
+980 
+	}
+}
+
+983 #i
+defed
+(
+DDB
+|| defed(
+_NPF_TESTING
+)
+
+986 
+	$f_rut_dump
+(c *
+me
+)
+
+988 
+f_rut_t
+ *
+t
+ = 
+	`f_cfig_rut
+();
+
+989 
+f_ru_t
+ *
+rg
+, *
+
+;
+
+991 
+	`LIST_FOREACH
+(
+rg
+, &
+t
+->
+rs_dymic
+, 
+r_dy
+) {
+
+992 
+	`tf
+("ru'%s':\n", 
+rg
+->
+r_me
+);
+
+993 
+
+ = 
+rg
+->
+r_subt
+;l;->
+r_xt
+) {
+
+994 
+	`tf
+("\tid %"
+PRIu64
+", key: ", 
+
+->
+r_id
+);
+
+995 
+u_t
+ 
+i
+ = 0; i < 
+NPF_RULE_MAXKEYLEN
+; i++)
+
+996 
+	`tf
+("%x", 
+
+->
+r_key
+[
+i
+]);
+
+997 
+	`tf
+("\n");
+
+1000 
+	}
+}
+
+	@npf/npf_sendpkt.c
+
+36 
+	~<sys/cdefs.h
+>
+
+37 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_sendpkt.c,v 1.15 2014/07/20 00:37:41mind Exp $");
+
+39 
+	~<sys/m.h
+>
+
+40 
+	~<sys/tys.h
+>
+
+42 
+	~<t/_sym.h
+>
+
+43 
+	~<t/.h
+>
+
+44 
+	~<t/.h
+>
+
+45 
+	~<t/_icmp.h
+>
+
+46 
+	~<t/_v.h
+>
+
+47 
+	~<t/t.h
+>
+
+48 
+	~<t/6.h
+>
+
+49 
+	~<t/icmp6.h
+>
+
+50 
+	~<t6/6_v.h
+>
+
+51 
+	~<sys/mbuf.h
+>
+
+53 
+	~"f_im.h
+"
+
+55 
+	#DEFAULT_IP_TTL
+ (
+_de
+)
+
+	)
+
+57 #ide
+INET6
+
+
+58 
+	#6_cksum
+(...0
+
+	)
+
+59 
+	#6_ouut
+(...0
+
+	)
+
+60 
+	#icmp6_r
+(
+m
+, ...
+	`m_m
+(m)
+
+	)
+
+67 
+	$f_tu_t
+(
+f_che_t
+ *
+c
+)
+
+69 
+mbuf
+ *
+m
+;
+
+70 
+
+ * = 
+NULL
+;
+
+71 
+6_hdr
+ *
+6
+ = 
+NULL
+;
+
+72 
+thdr
+ *
+h
+, *
+th
+;
+
+73 
+t_q
+ 
+q
+, 
+ack
+;
+
+74 
+tdn
+, 
+n
+;
+
+75 
+ut32_t
+ 
+w
+;
+
+78 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_IP46
+));
+
+79 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_LAYER4
+));
+
+80 
+tdn
+ = 
+	`f_tw
+(
+c
+, &
+q
+, &
+ack
+, &
+w
+);
+
+81 
+h
+ = 
+c
+->
+c_l4
+.
+t
+;
+
+83 i(
+h
+->
+th_ags
+ & 
+TH_RST
+) {
+
+88 i(
+	`f_isched
+(
+c
+, 
+NPC_IP4
+)) {
+
+89 
+n
+ = (
+
++ (
+thdr
+);
+
+90 } i(
+	`f_isched
+(
+c
+, 
+NPC_IP6
+)) {
+
+91 
+n
+ = (
+6_hdr
++ (
+thdr
+);
+
+93  
+EINVAL
+;
+
+96 
+m
+ = 
+	`m_ghdr
+(
+M_DONTWAIT
+, 
+MT_HEADER
+);
+
+97 i(
+m
+ =
+NULL
+) {
+
+98  
+ENOMEM
+;
+
+100 
+m
+->
+m_da
+ +
+max_lkhdr
+;
+
+101 
+m
+->
+m_n
+ = 
+n
+;
+
+102 
+m
+->
+m_pkthdr
+.
+n
+ =en;
+
+104 i(
+	`f_isched
+(
+c
+, 
+NPC_IP4
+)) {
+
+105 
+
+ *
+o
+ = 
+c
+->
+c_
+.
+v4
+;
+
+107 
+
+ = 
+	`mtod
+(
+m
+, ip *);
+
+108 
+	`memt
+(
+
+, 0, 
+n
+);
+
+114 
+
+->
+_p
+ = 
+IPPROTO_TCP
+;
+
+115 
+
+->
+_c
+.
+s_addr
+ = 
+o
+->
+_d
+.s_addr;
+
+116 
+
+->
+_d
+.
+s_addr
+ = 
+o
+->
+_c
+.s_addr;
+
+117 
+
+->
+_n
+ = 
+	`hts
+((
+thdr
+));
+
+119 
+th
+ = (
+thdr
+ *)(
+
+ + 1);
+
+121 
+6_hdr
+ *
+o
+ = 
+c
+->
+c_
+.
+v6
+;
+
+123 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_IP6
+));
+
+124 
+6
+ = 
+	`mtod
+(
+m
+, 
+6_hdr
+ *);
+
+125 
+	`memt
+(
+6
+, 0, 
+n
+);
+
+127 
+6
+->
+6_nxt
+ = 
+IPPROTO_TCP
+;
+
+128 
+6
+->
+6_hlim
+ = 
+IPV6_DEFHLIM
+;
+
+129 
+	`memy
+(&
+6
+->
+6_c
+, &
+o
+->
+6_d
+, (
+6_addr
+));
+
+130 
+	`memy
+(&
+6
+->
+6_d
+, &
+o
+->
+6_c
+, (
+6_addr
+));
+
+131 
+6
+->
+6_
+ = 
+	`hts
+(
+n
+);
+
+132 
+6
+->
+6_vfc
+ = 
+IPV6_VERSION
+;
+
+134 
+th
+ = (
+thdr
+ *)(
+6
+ + 1);
+
+140 
+th
+->
+th_t
+ = 
+h
+->
+th_dpt
+;
+
+141 
+th
+->
+th_dpt
+ = 
+h
+->
+th_t
+;
+
+142 
+th
+->
+th_q
+ = 
+	`htl
+(
+ack
+);
+
+143 i(
+h
+->
+th_ags
+ & 
+TH_SYN
+) {
+
+144 
+tdn
+++;
+
+146 
+th
+->
+th_ack
+ = 
+	`htl
+(
+q
+ + 
+tdn
+);
+
+147 
+th
+->
+th_off
+ = (
+thdr
+) >> 2;
+
+148 
+th
+->
+th_ags
+ = 
+TH_ACK
+ | 
+TH_RST
+;
+
+150 i(
+	`f_isched
+(
+c
+, 
+NPC_IP4
+)) {
+
+151 
+th
+->
+th_sum
+ = 
+	`_cksum
+(
+m
+, 
+n
+);
+
+156 
+
+->
+_v
+ = 
+IPVERSION
+;
+
+157 
+
+->
+_hl
+ = (ip) >> 2;
+
+158 
+
+->
+_tos
+ = 
+IPTOS_LOWDELAY
+;
+
+159 
+
+->
+_n
+ = 
+	`hts
+(
+n
+);
+
+160 
+
+->
+_l
+ = 
+DEFAULT_IP_TTL
+;
+
+162 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_IP6
+));
+
+163 
+th
+->
+th_sum
+ = 
+	`6_cksum
+(
+m
+, 
+IPPROTO_TCP
+, (
+6_hdr
+),
+
+164 (
+thdr
+));
+
+168 i(
+	`f_isched
+(
+c
+, 
+NPC_IP4
+)) {
+
+169  
+	`_ouut
+(
+m
+, 
+NULL
+, NULL, 
+IP_FORWARDING
+, NULL, NULL);
+
+171  
+	`6_ouut
+(
+m
+, 
+NULL
+, NULL, 
+IPV6_FORWARDING
+, NULL, NULL, NULL);
+
+172 
+	}
+}
+
+178 
+	$f_tu_icmp
+(c 
+f_che_t
+ *
+c
+)
+
+180 
+mbuf
+ *
+m
+ = 
+	`nbuf_hd_mbuf
+(
+c
+->
+c_nbuf
+);
+
+182 i(
+	`f_isched
+(
+c
+, 
+NPC_IP4
+)) {
+
+183 
+	`icmp_r
+(
+m
+, 
+ICMP_UNREACH
+, 
+ICMP_UNREACH_ADMIN_PROHIBIT
+, 0, 0);
+
+185 } i(
+	`f_isched
+(
+c
+, 
+NPC_IP6
+)) {
+
+186 
+	`icmp6_r
+(
+m
+, 
+ICMP6_DST_UNREACH
+, 
+ICMP6_DST_UNREACH_ADMIN
+, 0);
+
+189  
+EINVAL
+;
+
+190 
+	}
+}
+
+197 
+bo
+
+
+198 
+	$f_tu_block
+(
+f_che_t
+ *
+c
+, c 
+t
+)
+
+200 i(!
+	`f_isched
+(
+c
+, 
+NPC_IP46
+|| !f_ischedpc, 
+NPC_LAYER4
+)) {
+
+201  
+l
+;
+
+203 
+c
+->
+c_o
+) {
+
+204 
+IPPROTO_TCP
+:
+
+205 i(
+t
+ & 
+NPF_RULE_RETRST
+) {
+
+206 ()
+	`f_tu_t
+(
+c
+);
+
+209 
+IPPROTO_UDP
+:
+
+210 i(
+t
+ & 
+NPF_RULE_RETICMP
+)
+
+211 i(
+	`f_tu_icmp
+(
+c
+) == 0)
+
+212  
+ue
+;
+
+215  
+l
+;
+
+216 
+	}
+}
+
+	@npf/npf_state.c
+
+36 
+	~<sys/cdefs.h
+>
+
+37 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_state.c,v 1.17 2014/07/20 00:37:41mind Exp $");
+
+39 
+	~<sys/m.h
+>
+
+40 
+	~<sys/sym.h
+>
+
+42 
+	~<sys/mux.h
+>
+
+44 
+	~"f_im.h
+"
+
+52 
+	#NPF_ANY_CONN_CLOSED
+ 0
+
+	)
+
+53 
+	#NPF_ANY_CONN_NEW
+ 1
+
+	)
+
+54 
+	#NPF_ANY_CONN_ESTABLISHED
+ 2
+
+	)
+
+55 
+	#NPF_ANY_CONN_NSTATES
+ 3
+
+	)
+
+57 c 
+ut8_t
+ 
+	gf_gic_fsm
+[
+NPF_ANY_CONN_NSTATES
+][2] = {
+
+58 [
+NPF_ANY_CONN_CLOSED
+] = {
+
+59 [
+NPF_FLOW_FORW
+] = 
+NPF_ANY_CONN_NEW
+,
+
+61 [
+NPF_ANY_CONN_NEW
+] = {
+
+62 [
+NPF_FLOW_FORW
+] = 
+NPF_ANY_CONN_NEW
+,
+
+63 [
+NPF_FLOW_BACK
+] = 
+NPF_ANY_CONN_ESTABLISHED
+,
+
+65 [
+NPF_ANY_CONN_ESTABLISHED
+] = {
+
+66 [
+NPF_FLOW_FORW
+] = 
+NPF_ANY_CONN_ESTABLISHED
+,
+
+67 [
+NPF_FLOW_BACK
+] = 
+NPF_ANY_CONN_ESTABLISHED
+,
+
+71 
+u_t
+ 
+	gf_gic_timeout
+[] 
+	g__ad_moly
+ = {
+
+72 [
+NPF_ANY_CONN_CLOSED
+] = 0,
+
+73 [
+NPF_ANY_CONN_NEW
+] = 30,
+
+74 [
+NPF_ANY_CONN_ESTABLISHED
+] = 60,
+
+80 #i
+defed
+(
+_NPF_TESTING
+)
+
+81 (*
+f_e_me
+)(
+f_e_t
+ *, 
+bo
+
+NULL
+;
+
+82 
+	#NPF_STATE_SAMPLE
+(
+n
+, 
+r
+i(
+f_e_me
+(*f_e_me),);
+
+	)
+
+84 
+	#NPF_STATE_SAMPLE
+(
+n
+, 
+r
+)
+
+	)
+
+94 
+bo
+
+
+95 
+	$f_e_
+(
+f_che_t
+ *
+c
+, 
+f_e_t
+ *
+n
+)
+
+97 c 
+o
+ = 
+c
+->
+c_o
+;
+
+98 
+bo
+ 
+t
+;
+
+100 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_IP46
+));
+
+101 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_LAYER4
+));
+
+103 
+	`memt
+(
+n
+, 0, (
+f_e_t
+));
+
+105 
+o
+) {
+
+106 
+IPPROTO_TCP
+:
+
+108 
+t
+ = 
+	`f_e_t
+(
+c
+, 
+n
+, 
+NPF_FLOW_FORW
+);
+
+110 
+IPPROTO_UDP
+:
+
+111 
+IPPROTO_ICMP
+:
+
+113 
+n
+->
+n_e
+ = 
+f_gic_fsm
+[n->n_e][
+NPF_FLOW_FORW
+];
+
+114 
+t
+ = 
+ue
+;
+
+117 
+t
+ = 
+l
+;
+
+119 
+	`NPF_STATE_SAMPLE
+(
+n
+, 
+t
+);
+
+120  
+t
+;
+
+121 
+	}
+}
+
+124 
+	$f_e_deroy
+(
+f_e_t
+ *
+n
+)
+
+126 
+n
+->
+n_e
+ = 0;
+
+127 
+	}
+}
+
+135 
+bo
+
+
+136 
+	$f_e_e
+(
+f_che_t
+ *
+c
+, 
+f_e_t
+ *
+n
+, c 
+bo
+ 
+fw
+)
+
+138 c 
+o
+ = 
+c
+->
+c_o
+;
+
+139 c 
+di
+ = 
+fw
+ ? 
+NPF_FLOW_FORW
+ : 
+NPF_FLOW_BACK
+;
+
+140 
+bo
+ 
+t
+;
+
+142 
+o
+) {
+
+143 
+IPPROTO_TCP
+:
+
+145 
+t
+ = 
+	`f_e_t
+(
+c
+, 
+n
+, 
+di
+);
+
+147 
+IPPROTO_UDP
+:
+
+148 
+IPPROTO_ICMP
+:
+
+150 
+n
+->
+n_e
+ = 
+f_gic_fsm
+[n->n_e][
+di
+];
+
+151 
+t
+ = 
+ue
+;
+
+154 
+t
+ = 
+l
+;
+
+156 
+	`NPF_STATE_SAMPLE
+(
+n
+, 
+t
+);
+
+158  
+t
+;
+
+159 
+	}
+}
+
+165 
+	$f_e_ime
+(c 
+f_e_t
+ *
+n
+, c 
+o
+)
+
+167 c 
+u_t
+ 
+e
+ = 
+n
+->
+n_e
+;
+
+168 
+timeout
+ = 0;
+
+170 
+o
+) {
+
+171 
+IPPROTO_TCP
+:
+
+173 
+timeout
+ = 
+	`f_e_t_timeout
+(
+n
+);
+
+175 
+IPPROTO_UDP
+:
+
+176 
+IPPROTO_ICMP
+:
+
+178 
+timeout
+ = 
+f_gic_timeout
+[
+e
+];
+
+181 
+	`KASSERT
+(
+l
+);
+
+183  
+timeout
+;
+
+184 
+	}
+}
+
+187 
+	$f_e_dump
+(c 
+f_e_t
+ *
+n
+)
+
+189 #i
+	`defed
+(
+DDB
+|| defed(
+_NPF_TESTING
+)
+
+190 c 
+f_te_t
+ *
+f
+ = &
+n
+->
+n_t
+[0];
+
+191 c 
+f_te_t
+ *
+t
+ = &
+n
+->
+n_t
+[1];
+
+193 
+	`tf
+("\tstate (%p) %d:\n\t\t"
+
+196 
+n
+,->
+n_e
+,
+
+197 
+f
+->
+n_d
+, f->
+n_maxd
+, f->
+n_maxw
+, f->
+n_ws
+,
+
+198 
+t
+->
+n_d
+,->
+n_maxd
+,->
+n_maxw
+,->
+n_ws
+
+
+201 
+	}
+}
+
+203 #i
+defed
+(
+_NPF_TESTING
+)
+
+205 
+f_e_tm
+((*
+func
+)(
+f_e_t
+ *, 
+bo
+))
+
+207 
+f_e_me
+ = 
+func
+;
+
+208 
+	}
+}
+
+	@npf/npf_state_tcp.c
+
+36 
+	~<sys/cdefs.h
+>
+
+37 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_state_tcp.c,v 1.16 2014/07/25 20:07:32mind Exp $");
+
+39 
+	~<sys/m.h
+>
+
+40 
+	~<sys/tys.h
+>
+
+42 
+	~<t/.h
+>
+
+43 
+	~<t/t.h
+>
+
+44 
+	~<t/t_q.h
+>
+
+46 
+	~"f_im.h
+"
+
+52 
+	#NPF_TCPS_OK
+ 255
+
+	)
+
+53 
+	#NPF_TCPS_CLOSED
+ 0
+
+	)
+
+54 
+	#NPF_TCPS_SYN_SENT
+ 1
+
+	)
+
+55 
+	#NPF_TCPS_SIMSYN_SENT
+ 2
+
+	)
+
+56 
+	#NPF_TCPS_SYN_RECEIVED
+ 3
+
+	)
+
+57 
+	#NPF_TCPS_ESTABLISHED
+ 4
+
+	)
+
+58 
+	#NPF_TCPS_FIN_SENT
+ 5
+
+	)
+
+59 
+	#NPF_TCPS_FIN_RECEIVED
+ 6
+
+	)
+
+60 
+	#NPF_TCPS_CLOSE_WAIT
+ 7
+
+	)
+
+61 
+	#NPF_TCPS_FIN_WAIT
+ 8
+
+	)
+
+62 
+	#NPF_TCPS_CLOSING
+ 9
+
+	)
+
+63 
+	#NPF_TCPS_LAST_ACK
+ 10
+
+	)
+
+64 
+	#NPF_TCPS_TIME_WAIT
+ 11
+
+	)
+
+66 
+	#NPF_TCP_NSTATES
+ 12
+
+	)
+
+71 
+u_t
+ 
+	gf_t_timeouts
+[] 
+	g__ad_moly
+ = {
+
+73 [
+NPF_TCPS_CLOSED
+] = 10,
+
+75 [
+NPF_TCPS_SYN_SENT
+] = 30,
+
+76 [
+NPF_TCPS_SIMSYN_SENT
+] = 30,
+
+77 [
+NPF_TCPS_SYN_RECEIVED
+] = 60,
+
+79 [
+NPF_TCPS_ESTABLISHED
+] = 60 * 60 * 24,
+
+81 [
+NPF_TCPS_FIN_SENT
+] = 60 * 2 * 2,
+
+82 [
+NPF_TCPS_FIN_RECEIVED
+] = 60 * 2 * 2,
+
+84 [
+NPF_TCPS_CLOSE_WAIT
+] = 60 * 60 * 6,
+
+85 [
+NPF_TCPS_FIN_WAIT
+] = 60 * 60 * 6,
+
+87 [
+NPF_TCPS_CLOSING
+] = 30,
+
+88 [
+NPF_TCPS_LAST_ACK
+] = 30,
+
+89 [
+NPF_TCPS_TIME_WAIT
+] = 60 * 2 * 2,
+
+92 
+bo
+ 
+f_ri_d_r
+ 
+	g__ad_moly
+ = 
+ue
+;
+
+94 
+	#NPF_TCP_MAXACKWIN
+ 66000
+
+	)
+
+100 
+	#TCPFC_INVALID
+ 0
+
+	)
+
+101 
+	#TCPFC_SYN
+ 1
+
+	)
+
+102 
+	#TCPFC_SYNACK
+ 2
+
+	)
+
+103 
+	#TCPFC_ACK
+ 3
+
+	)
+
+104 
+	#TCPFC_FIN
+ 4
+
+	)
+
+105 
+	#TCPFC_COUNT
+ 5
+
+	)
+
+107 
+le
+ 
+u_t
+
+
+108 
+	$f_t2
+(c 
+u_t
+ 
+t
+)
+
+110 
+u_t
+ 
+i
+, 
+c
+;
+
+112 
+	`CTASSERT
+(
+TH_FIN
+ == 0x01);
+
+113 
+	`CTASSERT
+(
+TH_SYN
+ == 0x02);
+
+114 
+	`CTASSERT
+(
+TH_ACK
+ == 0x10);
+
+131 
+i
+ = (
+t
+ & (
+TH_SYN
+ | 
+TH_FIN
+)| ( & 
+TH_ACK
+) >> 2);
+
+132 
+c
+ = (0x2430140 >> (
+i
+ << 2)) & 7;
+
+134 
+	`KASSERT
+(
+c
+ < 
+TCPFC_COUNT
+);
+
+135  
+c
+;
+
+136 
+	}
+}
+
+148 c 
+ut8_t
+ 
+	gf_t_fsm
+[
+NPF_TCP_NSTATES
+][2][
+TCPFC_COUNT
+] = {
+
+149 [
+NPF_TCPS_CLOSED
+] = {
+
+150 [
+NPF_FLOW_FORW
+] = {
+
+152 [
+TCPFC_SYN
+] = 
+NPF_TCPS_SYN_SENT
+,
+
+155 [
+NPF_TCPS_SYN_SENT
+] = {
+
+156 [
+NPF_FLOW_FORW
+] = {
+
+158 [
+TCPFC_SYN
+] = 
+NPF_TCPS_OK
+,
+
+160 [
+NPF_FLOW_BACK
+] = {
+
+162 [
+TCPFC_SYNACK
+] = 
+NPF_TCPS_SYN_RECEIVED
+,
+
+164 [
+TCPFC_SYN
+] = 
+NPF_TCPS_SIMSYN_SENT
+,
+
+167 [
+NPF_TCPS_SIMSYN_SENT
+] = {
+
+168 [
+NPF_FLOW_FORW
+] = {
+
+170 [
+TCPFC_SYN
+] = 
+NPF_TCPS_OK
+,
+
+172 [
+TCPFC_SYNACK
+] = 
+NPF_TCPS_SYN_RECEIVED
+,
+
+174 [
+NPF_FLOW_BACK
+] = {
+
+176 [
+TCPFC_SYN
+] = 
+NPF_TCPS_OK
+,
+
+178 [
+TCPFC_SYNACK
+] = 
+NPF_TCPS_SYN_RECEIVED
+,
+
+180 [
+TCPFC_FIN
+] = 
+NPF_TCPS_FIN_RECEIVED
+,
+
+183 [
+NPF_TCPS_SYN_RECEIVED
+] = {
+
+184 [
+NPF_FLOW_FORW
+] = {
+
+186 [
+TCPFC_ACK
+] = 
+NPF_TCPS_ESTABLISHED
+,
+
+188 [
+TCPFC_FIN
+] = 
+NPF_TCPS_FIN_SENT
+,
+
+190 [
+NPF_FLOW_BACK
+] = {
+
+192 [
+TCPFC_SYNACK
+] = 
+NPF_TCPS_OK
+,
+
+194 [
+TCPFC_ACK
+] = 
+NPF_TCPS_OK
+,
+
+196 [
+TCPFC_FIN
+] = 
+NPF_TCPS_FIN_RECEIVED
+,
+
+199 [
+NPF_TCPS_ESTABLISHED
+] = {
+
+204 [
+NPF_FLOW_FORW
+] = {
+
+205 [
+TCPFC_ACK
+] = 
+NPF_TCPS_OK
+,
+
+207 [
+TCPFC_FIN
+] = 
+NPF_TCPS_FIN_SENT
+,
+
+209 [
+NPF_FLOW_BACK
+] = {
+
+210 [
+TCPFC_ACK
+] = 
+NPF_TCPS_OK
+,
+
+212 [
+TCPFC_FIN
+] = 
+NPF_TCPS_FIN_RECEIVED
+,
+
+215 [
+NPF_TCPS_FIN_SENT
+] = {
+
+216 [
+NPF_FLOW_FORW
+] = {
+
+218 [
+TCPFC_ACK
+] = 
+NPF_TCPS_OK
+,
+
+219 [
+TCPFC_FIN
+] = 
+NPF_TCPS_OK
+,
+
+221 [
+NPF_FLOW_BACK
+] = {
+
+223 [
+TCPFC_ACK
+] = 
+NPF_TCPS_FIN_WAIT
+,
+
+225 [
+TCPFC_FIN
+] = 
+NPF_TCPS_CLOSING
+,
+
+228 [
+NPF_TCPS_FIN_RECEIVED
+] = {
+
+232 [
+NPF_FLOW_FORW
+] = {
+
+233 [
+TCPFC_ACK
+] = 
+NPF_TCPS_CLOSE_WAIT
+,
+
+234 [
+TCPFC_FIN
+] = 
+NPF_TCPS_CLOSING
+,
+
+236 [
+NPF_FLOW_BACK
+] = {
+
+237 [
+TCPFC_ACK
+] = 
+NPF_TCPS_OK
+,
+
+238 [
+TCPFC_FIN
+] = 
+NPF_TCPS_OK
+,
+
+241 [
+NPF_TCPS_CLOSE_WAIT
+] = {
+
+243 [
+NPF_FLOW_FORW
+] = {
+
+244 [
+TCPFC_ACK
+] = 
+NPF_TCPS_OK
+,
+
+245 [
+TCPFC_FIN
+] = 
+NPF_TCPS_LAST_ACK
+,
+
+247 [
+NPF_FLOW_BACK
+] = {
+
+248 [
+TCPFC_ACK
+] = 
+NPF_TCPS_OK
+,
+
+249 [
+TCPFC_FIN
+] = 
+NPF_TCPS_LAST_ACK
+,
+
+252 [
+NPF_TCPS_FIN_WAIT
+] = {
+
+254 [
+NPF_FLOW_FORW
+] = {
+
+255 [
+TCPFC_ACK
+] = 
+NPF_TCPS_OK
+,
+
+256 [
+TCPFC_FIN
+] = 
+NPF_TCPS_LAST_ACK
+,
+
+258 [
+NPF_FLOW_BACK
+] = {
+
+259 [
+TCPFC_ACK
+] = 
+NPF_TCPS_OK
+,
+
+260 [
+TCPFC_FIN
+] = 
+NPF_TCPS_LAST_ACK
+,
+
+263 [
+NPF_TCPS_CLOSING
+] = {
+
+265 [
+NPF_FLOW_FORW
+] = {
+
+266 [
+TCPFC_ACK
+] = 
+NPF_TCPS_LAST_ACK
+,
+
+268 [
+NPF_FLOW_BACK
+] = {
+
+269 [
+TCPFC_ACK
+] = 
+NPF_TCPS_LAST_ACK
+,
+
+272 [
+NPF_TCPS_LAST_ACK
+] = {
+
+274 [
+NPF_FLOW_FORW
+] = {
+
+275 [
+TCPFC_ACK
+] = 
+NPF_TCPS_TIME_WAIT
+,
+
+277 [
+NPF_FLOW_BACK
+] = {
+
+278 [
+TCPFC_ACK
+] = 
+NPF_TCPS_TIME_WAIT
+,
+
+281 [
+NPF_TCPS_TIME_WAIT
+] = {
+
+283 [
+NPF_FLOW_FORW
+] = {
+
+284 [
+TCPFC_SYN
+] = 
+NPF_TCPS_SYN_SENT
+,
+
+293 
+bo
+
+
+294 
+	$f_t_wdow
+(
+f_che_t
+ *
+c
+, 
+f_e_t
+ *
+n
+, c 
+di
+)
+
+296 c 
+thdr
+ * c 
+th
+ = 
+c
+->
+c_l4
+.
+t
+;
+
+297 c 
+t
+ = 
+th
+->
+th_ags
+;
+
+298 
+f_te_t
+ *
+fe
+, *
+te
+;
+
+299 
+tdn
+, 
+ackskew
+;
+
+300 
+t_q
+ 
+q
+, 
+ack
+, 
+d
+;
+
+301 
+ut32_t
+ 
+w
+;
+
+303 
+	`KASSERT
+(
+	`f_isched
+(
+c
+, 
+NPC_TCP
+));
+
+304 
+	`KASSERT
+(
+di
+ =
+NPF_FLOW_FORW
+ || d=
+NPF_FLOW_BACK
+);
+
+324 
+tdn
+ = 
+	`f_tw
+(
+	`__UNCONST
+(
+c
+), &
+q
+, &
+ack
+, &
+w
+);
+
+325 
+d
+ = 
+q
+ + 
+tdn
+;
+
+326 i(
+t
+ & 
+TH_SYN
+) {
+
+327 
+d
+++;
+
+329 i(
+t
+ & 
+TH_FIN
+) {
+
+330 
+d
+++;
+
+333 
+fe
+ = &
+n
+->
+n_t
+[
+di
+];
+
+334 
+te
+ = &
+n
+->
+n_t
+[!
+di
+];
+
+335 
+w
+ = w ? (w << 
+fe
+->
+n_ws
+) : 1;
+
+341 i(
+	`__edi_l
+(
+fe
+->
+n_maxw
+ == 0)) {
+
+347 
+fe
+->
+n_d
+ = 
+d
+;
+
+348 
+fe
+->
+n_maxd
+ = 
+d
+;
+
+349 
+fe
+->
+n_maxw
+ = 
+w
+;
+
+350 
+te
+->
+n_d
+ = 0;
+
+351 
+te
+->
+n_maxd
+ = 0;
+
+352 
+te
+->
+n_maxw
+ = 1;
+
+358 
+fe
+->
+n_ws
+ = 0;
+
+359 ()
+	`f_tch_tts
+(
+c
+, 
+NULL
+, &
+fe
+->
+n_ws
+);
+
+361 
+te
+->
+n_ws
+ = 0;
+
+364  
+ue
+;
+
+367 i(
+fe
+->
+n_d
+ == 0) {
+
+372 
+fe
+->
+n_d
+ = 
+d
+;
+
+373 
+fe
+->
+n_maxd
+ = 
+d
+ + 1;
+
+374 
+fe
+->
+n_maxw
+ = 
+w
+;
+
+375 
+fe
+->
+n_ws
+ = 0;
+
+378 i(
+t
+ & 
+TH_SYN
+) {
+
+379 ()
+	`f_tch_tts
+(
+c
+, 
+NULL
+, &
+fe
+->
+n_ws
+);
+
+383 i((
+t
+ & 
+TH_ACK
+) == 0) {
+
+385 
+ack
+ = 
+te
+->
+n_d
+;
+
+386 } i((
+t
+ & (
+TH_ACK
+|
+TH_RST
+)=(TH_ACK|TH_RST&& 
+ack
+ == 0) {
+
+388 
+ack
+ = 
+te
+->
+n_d
+;
+
+391 i(
+	`__edi_l
+(
+t
+ & 
+TH_RST
+)) {
+
+393 i(
+q
+ =0 && 
+n
+->
+n_e
+ =
+NPF_TCPS_SYN_SENT
+) {
+
+394 
+d
+ = 
+fe
+->
+n_d
+;
+
+395 
+q
+ = 
+d
+;
+
+399 i(
+f_ri_d_r
+ && (
+fe
+->
+n_d
+ - 
+q
+) > 1) {
+
+400  
+l
+;
+
+408 i(!
+	`SEQ_LEQ
+(
+d
+, 
+fe
+->
+n_maxd
+)) {
+
+409 
+	`f_s_c
+(
+NPF_STAT_INVALID_STATE_TCP1
+);
+
+410  
+l
+;
+
+414 i(!
+	`SEQ_GEQ
+(
+q
+, 
+fe
+->
+n_d
+ - 
+te
+->
+n_maxw
+)) {
+
+415 
+	`f_s_c
+(
+NPF_STAT_INVALID_STATE_TCP2
+);
+
+416  
+l
+;
+
+423 
+ackskew
+ = 
+te
+->
+n_d
+ - 
+ack
+;
+
+424 i(
+ackskew
+ < -
+NPF_TCP_MAXACKWIN
+ ||
+
+425 
+ackskew
+ > (
+NPF_TCP_MAXACKWIN
+ << 
+fe
+->
+n_ws
+)) {
+
+426 
+	`f_s_c
+(
+NPF_STAT_INVALID_STATE_TCP3
+);
+
+427  
+l
+;
+
+437 i(
+ackskew
+ < 0) {
+
+438 
+te
+->
+n_d
+ = 
+ack
+;
+
+441 i(
+fe
+->
+n_maxw
+ < 
+w
+) {
+
+442 
+fe
+->
+n_maxw
+ = 
+w
+;
+
+444 i(
+	`SEQ_GT
+(
+d
+, 
+fe
+->
+n_d
+)) {
+
+445 
+fe
+->
+n_d
+ = 
+d
+;
+
+448 i(
+	`SEQ_GEQ
+(
+ack
+ + 
+w
+, 
+te
+->
+n_maxd
+)) {
+
+449 
+te
+->
+n_maxd
+ = 
+ack
+ + 
+w
+;
+
+451  
+ue
+;
+
+452 
+	}
+}
+
+458 
+bo
+
+
+459 
+	$f_e_t
+(
+f_che_t
+ *
+c
+, 
+f_e_t
+ *
+n
+, 
+di
+)
+
+461 c 
+thdr
+ * c 
+th
+ = 
+c
+->
+c_l4
+.
+t
+;
+
+462 c 
+u_t
+ 
+t
+ = 
+th
+->
+th_ags
+, 
+e
+ = 
+n
+->
+n_e
+;
+
+463 
+u_t
+ 
+ne
+;
+
+465 
+	`KASSERT
+(
+n
+->
+n_e
+ < 
+NPF_TCP_NSTATES
+);
+
+468 i(
+	`__edi_ue
+((
+t
+ & 
+TH_RST
+) == 0)) {
+
+469 c 
+u_t
+ 
+ag
+ = 
+	`f_t2
+(
+t
+);
+
+470 
+ne
+ = 
+f_t_fsm
+[
+e
+][
+di
+][
+ag
+];
+
+471 } i(
+e
+ =
+NPF_TCPS_TIME_WAIT
+) {
+
+473 
+ne
+ = 
+NPF_TCPS_OK
+;
+
+475 
+ne
+ = 
+NPF_TCPS_CLOSED
+;
+
+479 i(!
+	`f_t_wdow
+(
+c
+, 
+n
+, 
+di
+)) {
+
+480  
+l
+;
+
+482 i(
+	`__edi_ue
+(
+ne
+ =
+NPF_TCPS_OK
+)) {
+
+483  
+ue
+;
+
+486 
+n
+->
+n_e
+ = 
+ne
+;
+
+487  
+ue
+;
+
+488 
+	}
+}
+
+491 
+	$f_e_t_timeout
+(c 
+f_e_t
+ *
+n
+)
+
+493 c 
+u_t
+ 
+e
+ = 
+n
+->
+n_e
+;
+
+495 
+	`KASSERT
+(
+e
+ < 
+NPF_TCP_NSTATES
+);
+
+496  
+f_t_timeouts
+[
+e
+];
+
+497 
+	}
+}
+
+	@npf/npf_tableset.c
+
+43 
+	~<sys/cdefs.h
+>
+
+44 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_tableset.c,v 1.22 2014/08/11 01:54:12mind Exp $");
+
+46 
+	~<sys/m.h
+>
+
+47 
+	~<sys/tys.h
+>
+
+49 
+	~<sys/omic.h
+>
+
+50 
+	~<sys/hash.h
+>
+
+51 
+	~<sys/cdbr.h
+>
+
+52 
+	~<sys/kmem.h
+>
+
+53 
+	~<sys/mloc.h
+>
+
+54 
+	~<sys/po.h
+>
+
+55 
+	~<sys/queue.h
+>
+
+56 
+	~<sys/rwlock.h
+>
+
+57 
+	~<sys/sym.h
+>
+
+58 
+	~<sys/tys.h
+>
+
+60 
+	~"f_im.h
+"
+
+62 
+	sf_tb
+ {
+
+64 
+LIST_ENTRY
+(
+f_tb
+
+	m_hasht
+;
+
+65 
+_node_t
+ 
+	m_node
+;
+
+67 
+	m_
+;
+
+68 
+f_addr_t
+ 
+	m_addr
+;
+
+69 } 
+	tf_tb_t
+;
+
+71 
+LIST_HEAD
+(
+f_hashl
+, 
+f_tb
+);
+
+73 
+	sf_b
+ {
+
+80 
+f_hashl
+ *
+	mt_hashl
+;
+
+81 
+u_lg
+ 
+	mt_hashmask
+;
+
+84 
+__t
+ 
+	mt_
+[2];
+
+87 * 
+	mt_blob
+;
+
+88 
+size_t
+ 
+	mt_bsize
+;
+
+89 
+cdbr
+ * 
+	mt_cdb
+;
+
+97 
+	mt_ty
+;
+
+98 
+u_t
+ 
+	mt_id
+;
+
+99 
+krwlock_t
+ 
+	mt_lock
+;
+
+102 
+u_t
+ 
+	mt_nems
+;
+
+103 
+u_t
+ 
+	mt_ft
+;
+
+104 
+	mt_me
+[
+NPF_TABLE_MAXNAMELEN
+];
+
+107 
+	sf_bt
+ {
+
+108 
+u_t
+ 
+	mts_nems
+;
+
+109 
+f_b_t
+ * 
+	mts_m
+[];
+
+112 
+	#NPF_TABLESET_SIZE
+(
+n
+) \
+
+113 (
+	`offtof
+(
+f_bt_t
+, 
+ts_m
+[
+n
+]* (
+f_b_t
+ *))
+
+	)
+
+115 
+	#NPF_ADDRLEN2TREE
+(
+
+(n>> 4)
+
+	)
+
+117 
+po_che_t
+ 
+tb_che
+ 
+	g__ad_moly
+;
+
+123 
+	$f_bt_sys
+()
+
+125 
+tb_che
+ = 
+	`po_che_
+((
+f_tb_t
+), 
+cohcy_un
+,
+
+126 0, 0, "bl", 
+NULL
+, 
+IPL_NONE
+, NULL, NULL, NULL);
+
+127 
+	}
+}
+
+130 
+	$f_bt_sysfi
+()
+
+132 
+	`po_che_deroy
+(
+tb_che
+);
+
+133 
+	}
+}
+
+135 
+f_bt_t
+ *
+
+136 
+	$f_bt_
+(
+u_t
+ 
+nems
+)
+
+138 
+f_bt_t
+ *
+ts
+ = 
+	`kmem_zloc
+(
+	`NPF_TABLESET_SIZE
+(
+nems
+), 
+KM_SLEEP
+);
+
+139 
+ts
+->
+ts_nems
+ = 
+nems
+;
+
+140  
+ts
+;
+
+141 
+	}
+}
+
+144 
+	$f_bt_deroy
+(
+f_bt_t
+ *
+ts
+)
+
+150 
+u_t
+ 
+tid
+ = 0;id < 
+ts
+->
+ts_nems
+;id++) {
+
+151 
+f_b_t
+ *
+t
+ = 
+ts
+->
+ts_m
+[
+tid
+];
+
+153 i(
+t
+ && 
+	`omic_dec_ut_nv
+(&t->
+t_ft
+) == 0) {
+
+154 
+	`f_b_deroy
+(
+t
+);
+
+157 
+	`kmem_
+(
+ts
+, 
+	`NPF_TABLESET_SIZE
+s->
+ts_nems
+));
+
+158 
+	}
+}
+
+166 
+	$f_bt_
+(
+f_bt_t
+ *
+ts
+, 
+f_b_t
+ *
+t
+)
+
+168 c 
+u_t
+ 
+tid
+ = 
+t
+->
+t_id
+;
+
+169 
+r
+;
+
+171 
+	`KASSERT
+((
+u_t
+)
+tid
+ < 
+ts
+->
+ts_nems
+);
+
+173 i(
+ts
+->
+ts_m
+[
+tid
+] =
+NULL
+) {
+
+174 
+	`omic_c_ut
+(&
+t
+->
+t_ft
+);
+
+175 
+ts
+->
+ts_m
+[
+tid
+] = 
+t
+;
+
+176 
+r
+ = 0;
+
+178 
+r
+ = 
+EEXIST
+;
+
+180  
+r
+;
+
+181 
+	}
+}
+
+186 
+f_b_t
+ *
+
+187 
+	$f_bt_gbyme
+(
+f_bt_t
+ *
+ts
+, c *
+me
+)
+
+189 
+f_b_t
+ *
+t
+;
+
+191 
+u_t
+ 
+tid
+ = 0;id < 
+ts
+->
+ts_nems
+;id++) {
+
+192 i((
+t
+ = 
+ts
+->
+ts_m
+[
+tid
+]=
+NULL
+)
+
+194 i(
+	`rcmp
+(
+me
+, 
+t
+->
+t_me
+) == 0)
+
+195  
+t
+;
+
+197  
+NULL
+;
+
+198 
+	}
+}
+
+200 
+f_b_t
+ *
+
+201 
+	$f_bt_gbyid
+(
+f_bt_t
+ *
+ts
+, 
+u_t
+ 
+tid
+)
+
+203 i(
+	`__edi_ue
+(
+tid
+ < 
+ts
+->
+ts_nems
+)) {
+
+204  
+ts
+->
+ts_m
+[
+tid
+];
+
+206  
+NULL
+;
+
+207 
+	}
+}
+
+216 
+	$f_bt_ld
+(
+f_bt_t
+ *
+s
+,pf_bt_*
+s
+)
+
+218 
+u_t
+ 
+tid
+ = 0;id < 
+s
+->
+ts_nems
+;id++) {
+
+219 
+f_b_t
+ *
+t
+, *
+
+;
+
+221 i((
+t
+ = 
+s
+->
+ts_m
+[
+tid
+]=
+NULL
+) {
+
+226 i(
+t
+->
+t_nems
+) {
+
+231 
+
+ = 
+	`f_bt_gbyme
+(
+s
+, 
+t
+->
+t_me
+);
+
+232 i(
+
+ =
+NULL
+) {
+
+238 i(
+t
+->
+t_ty
+ !
+
+->t_type) {
+
+247 
+	`omic_c_ut
+(&
+
+->
+t_ft
+);
+
+248 
+s
+->
+ts_m
+[
+tid
+] = 
+
+;
+
+250 
+	`KASSERT
+(
+	`f_cfig_locked_p
+());
+
+251 
+
+->
+t_id
+ = 
+tid
+;
+
+254 
+t
+->
+t_ft
+--;
+
+255 
+	`f_b_deroy
+(
+t
+);
+
+257 
+	}
+}
+
+260 
+	$f_bt_expt
+(c 
+f_bt_t
+ *
+ts
+, 
+_y_t
+ 
+bs
+)
+
+262 c 
+f_b_t
+ *
+t
+;
+
+264 
+	`KASSERT
+(
+	`f_cfig_locked_p
+());
+
+266 
+u_t
+ 
+tid
+ = 0;id < 
+ts
+->
+ts_nems
+;id++) {
+
+267 i((
+t
+ = 
+ts
+->
+ts_m
+[
+tid
+]=
+NULL
+) {
+
+270 
+_diiy_t
+ 
+tdi
+ = 
+	`_diiy_
+();
+
+271 
+	`_diiy_t_crg
+(
+tdi
+, "me", 
+t
+->
+t_me
+);
+
+272 
+	`_diiy_t_ut32
+(
+tdi
+, "ty", 
+t
+->
+t_ty
+);
+
+273 
+	`_diiy_t_ut32
+(
+tdi
+, "id", 
+tid
+);
+
+275 
+	`_y_add
+(
+bs
+, 
+tdi
+);
+
+276 
+	`_obje_a
+(
+tdi
+);
+
+279 
+	}
+}
+
+285 
+f_tb_t
+ *
+
+286 
+	$b_hash_lookup
+(c 
+f_b_t
+ *
+t
+, c 
+f_addr_t
+ *
+addr
+,
+
+287 c 
+
+, 
+f_hashl
+ **
+rhtbl
+)
+
+289 c 
+ut32_t
+ 
+hidx
+ = 
+	`hash32_buf
+(
+addr
+, 
+
+, 
+HASH32_BUF_INIT
+);
+
+290 
+f_hashl
+ *
+htbl
+ = &
+t
+->
+t_hashl
+[
+hidx
+ &->
+t_hashmask
+];
+
+291 
+f_tb_t
+ *
+t
+;
+
+297 
+	`LIST_FOREACH
+(
+t
+, 
+htbl
+, 
+_hasht
+) {
+
+298 i(
+t
+->
+_
+ !
+
+) {
+
+301 i(
+	`memcmp
+(&
+t
+->
+_addr
+, 
+addr
+, 
+
+) == 0) {
+
+305 *
+rhtbl
+ = 
+htbl
+;
+
+306  
+t
+;
+
+307 
+	}
+}
+
+310 
+	$b_hash_deroy
+(
+f_b_t
+ *
+t
+)
+
+312 
+n
+ = 0; <
+t
+->
+t_hashmask
+;++) {
+
+313 
+f_tb_t
+ *
+t
+;
+
+315 (
+t
+ = 
+	`LIST_FIRST
+(&
+t
+->
+t_hashl
+[
+n
+])!
+NULL
+) {
+
+316 
+	`LIST_REMOVE
+(
+t
+, 
+_hasht
+);
+
+317 
+	`po_che_put
+(
+tb_che
+, 
+t
+);
+
+320 
+	}
+}
+
+323 
+	$b__deroy
+(
+__t
+ *
+
+)
+
+325 
+f_tb_t
+ *
+t
+;
+
+327 (
+t
+ = 
+	`e_e
+(
+
+, 
+NULL
+, 
+PT_ASCENDING
+)) != NULL) {
+
+328 
+	`e_move_node
+(
+
+, 
+t
+);
+
+329 
+	`po_che_put
+(
+tb_che
+, 
+t
+);
+
+331 
+	}
+}
+
+336 
+f_b_t
+ *
+
+337 
+	$f_b_
+(c *
+me
+, 
+u_t
+ 
+tid
+, 
+ty
+,
+
+338 *
+blob
+, 
+size_t
+ 
+size
+)
+
+340 
+f_b_t
+ *
+t
+;
+
+342 
+t
+ = 
+	`kmem_zloc
+((
+f_b_t
+), 
+KM_SLEEP
+);
+
+343 
+	`y
+(
+t
+->
+t_me
+, 
+me
+, 
+NPF_TABLE_MAXNAMELEN
+);
+
+345 
+ty
+) {
+
+346 
+NPF_TABLE_TREE
+:
+
+347 
+	`e_
+(&
+t
+->
+t_
+[0], &
+f_b_e_s
+,
+
+348 (*)((
+_addr
+/ (
+ut32_t
+)),
+
+349 
+	`offtof
+(
+f_tb_t
+, 
+_node
+),
+
+350 
+	`offtof
+(
+f_tb_t
+, 
+_addr
+));
+
+351 
+	`e_
+(&
+t
+->
+t_
+[1], &
+f_b_e_s
+,
+
+352 (*)((
+6_addr
+/ (
+ut32_t
+)),
+
+353 
+	`offtof
+(
+f_tb_t
+, 
+_node
+),
+
+354 
+	`offtof
+(
+f_tb_t
+, 
+_addr
+));
+
+356 
+NPF_TABLE_HASH
+:
+
+357 
+t
+->
+t_hashl
+ = 
+	`hash
+(1024, 
+HASH_LIST
+, 
+ue
+, &t->
+t_hashmask
+);
+
+358 i(
+t
+->
+t_hashl
+ =
+NULL
+) {
+
+359 
+	`kmem_
+(
+t
+, (
+f_b_t
+));
+
+360  
+NULL
+;
+
+363 
+NPF_TABLE_CDB
+:
+
+364 
+t
+->
+t_blob
+ = 
+blob
+;
+
+365 
+t
+->
+t_bsize
+ = 
+size
+;
+
+366 
+t
+->
+t_cdb
+ = 
+	`cdbr__mem
+(
+blob
+, 
+size
+, 
+CDBR_DEFAULT
+, 
+NULL
+, NULL);
+
+367 i(
+t
+->
+t_cdb
+ =
+NULL
+) {
+
+368 
+	`kmem_
+(
+t
+, (
+f_b_t
+));
+
+369 
+	`
+(
+blob
+, 
+M_TEMP
+);
+
+370  
+NULL
+;
+
+372 
+t
+->
+t_nems
+ = 
+	`cdbr_s
+->
+t_cdb
+);
+
+375 
+	`KASSERT
+(
+l
+);
+
+377 
+	`rw_
+(&
+t
+->
+t_lock
+);
+
+378 
+t
+->
+t_ty
+ = 
+ty
+;
+
+379 
+t
+->
+t_id
+ = 
+tid
+;
+
+381  
+t
+;
+
+382 
+	}
+}
+
+388 
+	$f_b_deroy
+(
+f_b_t
+ *
+t
+)
+
+390 
+	`KASSERT
+(
+t
+->
+t_ft
+ == 0);
+
+392 
+t
+->
+t_ty
+) {
+
+393 
+NPF_TABLE_HASH
+:
+
+394 
+	`b_hash_deroy
+(
+t
+);
+
+395 
+	`hashde
+(
+t
+->
+t_hashl
+, 
+HASH_LIST
+,->
+t_hashmask
+);
+
+397 
+NPF_TABLE_TREE
+:
+
+398 
+	`b__deroy
+(&
+t
+->
+t_
+[0]);
+
+399 
+	`b__deroy
+(&
+t
+->
+t_
+[1]);
+
+401 
+NPF_TABLE_CDB
+:
+
+402 
+	`cdbr_o
+(
+t
+->
+t_cdb
+);
+
+403 
+	`
+(
+t
+->
+t_blob
+, 
+M_TEMP
+);
+
+406 
+	`KASSERT
+(
+l
+);
+
+408 
+	`rw_deroy
+(&
+t
+->
+t_lock
+);
+
+409 
+	`kmem_
+(
+t
+, (
+f_b_t
+));
+
+410 
+	}
+}
+
+416 
+	$f_b_check
+(
+f_bt_t
+ *
+ts
+, c *
+me
+, 
+u_t
+ 
+tid
+, 
+ty
+)
+
+418 i((
+u_t
+)
+tid
+ >
+ts
+->
+ts_nems
+) {
+
+419  
+EINVAL
+;
+
+421 i(
+ts
+->
+ts_m
+[
+tid
+] !
+NULL
+) {
+
+422  
+EEXIST
+;
+
+424 
+ty
+) {
+
+425 
+NPF_TABLE_TREE
+:
+
+426 
+NPF_TABLE_HASH
+:
+
+427 
+NPF_TABLE_CDB
+:
+
+430  
+EINVAL
+;
+
+432 i(
+	`
+(
+me
+>
+NPF_TABLE_MAXNAMELEN
+) {
+
+433  
+ENAMETOOLONG
+;
+
+435 i(
+	`f_bt_gbyme
+(
+ts
+, 
+me
+)) {
+
+436  
+EEXIST
+;
+
+439 
+	}
+}
+
+442 
+	$b_cidr_check
+(c 
+u_t
+ 
+aidx
+, c 
+f_addr_t
+ *
+addr
+,
+
+443 c 
+f_tmask_t
+ 
+mask
+)
+
+445 i(
+aidx
+ > 1) {
+
+446  
+EINVAL
+;
+
+448 i(
+mask
+ > 
+NPF_MAX_NETMASK
+ && mask !
+NPF_NO_NETMASK
+) {
+
+449  
+EINVAL
+;
+
+456 i(
+mask
+ >(
+aidx
+ ? 128 : 32&& mask !
+NPF_NO_NETMASK
+) {
+
+457  
+EINVAL
+;
+
+460 
+	}
+}
+
+466 
+	$f_b_
+(
+f_b_t
+ *
+t
+, c 
+
+,
+
+467 c 
+f_addr_t
+ *
+addr
+, c 
+f_tmask_t
+ 
+mask
+)
+
+469 c 
+u_t
+ 
+aidx
+ = 
+	`NPF_ADDRLEN2TREE
+(
+
+);
+
+470 
+f_tb_t
+ *
+t
+;
+
+471 
+r
+;
+
+473 
+r
+ = 
+	`b_cidr_check
+(
+aidx
+, 
+addr
+, 
+mask
+);
+
+474 i(
+r
+) {
+
+475  
+r
+;
+
+477 
+t
+ = 
+	`po_che_g
+(
+tb_che
+, 
+PR_WAITOK
+);
+
+478 
+	`memy
+(&
+t
+->
+_addr
+, 
+addr
+, 
+
+);
+
+479 
+t
+->
+_
+ = 
+
+;
+
+484 
+	`rw_r
+(&
+t
+->
+t_lock
+, 
+RW_WRITER
+);
+
+485 
+t
+->
+t_ty
+) {
+
+486 
+NPF_TABLE_HASH
+: {
+
+487 
+f_hashl
+ *
+htbl
+;
+
+492 i(
+mask
+ !
+NPF_NO_NETMASK
+) {
+
+493 
+r
+ = 
+EINVAL
+;
+
+496 i(!
+	`b_hash_lookup
+(
+t
+, 
+addr
+, 
+
+, &
+htbl
+)) {
+
+497 
+	`LIST_INSERT_HEAD
+(
+htbl
+, 
+t
+, 
+_hasht
+);
+
+498 
+t
+->
+t_nems
+++;
+
+500 
+r
+ = 
+EEXIST
+;
+
+504 
+NPF_TABLE_TREE
+: {
+
+505 
+__t
+ *
+
+ = &
+t
+->
+t_
+[
+aidx
+];
+
+506 
+bo
+ 
+ok
+;
+
+511 
+ok
+ = (
+mask
+ !
+NPF_NO_NETMASK
+) ?
+
+512 
+	`e__mask_node
+(
+
+, 
+t
+, 
+mask
+) :
+
+513 
+	`e__node
+(
+
+, 
+t
+);
+
+514 i(
+ok
+) {
+
+515 
+t
+->
+t_nems
+++;
+
+516 
+r
+ = 0;
+
+518 
+r
+ = 
+EEXIST
+;
+
+522 
+NPF_TABLE_CDB
+:
+
+523 
+r
+ = 
+EINVAL
+;
+
+526 
+	`KASSERT
+(
+l
+);
+
+528 
+	`rw_ex
+(&
+t
+->
+t_lock
+);
+
+530 i(
+r
+) {
+
+531 
+	`po_che_put
+(
+tb_che
+, 
+t
+);
+
+533  
+r
+;
+
+534 
+	}
+}
+
+540 
+	$f_b_move
+(
+f_b_t
+ *
+t
+, c 
+
+,
+
+541 c 
+f_addr_t
+ *
+addr
+, c 
+f_tmask_t
+ 
+mask
+)
+
+543 c 
+u_t
+ 
+aidx
+ = 
+	`NPF_ADDRLEN2TREE
+(
+
+);
+
+544 
+f_tb_t
+ *
+t
+ = 
+NULL
+;
+
+545 
+r
+ = 
+ENOENT
+;
+
+547 
+r
+ = 
+	`b_cidr_check
+(
+aidx
+, 
+addr
+, 
+mask
+);
+
+548 i(
+r
+) {
+
+549  
+r
+;
+
+552 
+	`rw_r
+(&
+t
+->
+t_lock
+, 
+RW_WRITER
+);
+
+553 
+t
+->
+t_ty
+) {
+
+554 
+NPF_TABLE_HASH
+: {
+
+555 
+f_hashl
+ *
+htbl
+;
+
+557 
+t
+ = 
+	`b_hash_lookup
+(
+t
+, 
+addr
+, 
+
+, &
+htbl
+);
+
+558 i(
+	`__edi_ue
+(
+t
+ !
+NULL
+)) {
+
+559 
+	`LIST_REMOVE
+(
+t
+, 
+_hasht
+);
+
+560 
+t
+->
+t_nems
+--;
+
+564 
+NPF_TABLE_TREE
+: {
+
+565 
+__t
+ *
+
+ = &
+t
+->
+t_
+[
+aidx
+];
+
+567 
+t
+ = 
+	`e_fd_node
+(
+
+, 
+addr
+);
+
+568 i(
+	`__edi_ue
+(
+t
+ !
+NULL
+)) {
+
+569 
+	`e_move_node
+(
+
+, 
+t
+);
+
+570 
+t
+->
+t_nems
+--;
+
+574 
+NPF_TABLE_CDB
+:
+
+575 
+r
+ = 
+EINVAL
+;
+
+578 
+	`KASSERT
+(
+l
+);
+
+579 
+t
+ = 
+NULL
+;
+
+581 
+	`rw_ex
+(&
+t
+->
+t_lock
+);
+
+583 i(
+t
+) {
+
+584 
+	`po_che_put
+(
+tb_che
+, 
+t
+);
+
+586  
+r
+;
+
+587 
+	}
+}
+
+594 
+	$f_b_lookup
+(
+f_b_t
+ *
+t
+, c 
+
+, c 
+f_addr_t
+ *
+addr
+)
+
+596 c 
+u_t
+ 
+aidx
+ = 
+	`NPF_ADDRLEN2TREE
+(
+
+);
+
+597 
+f_hashl
+ *
+htbl
+;
+
+598 c *
+da
+;
+
+599 
+size_t
+ 
+dn
+;
+
+600 
+bo
+ 
+found
+;
+
+602 i(
+	`__edi_l
+(
+aidx
+ > 1)) {
+
+603  
+EINVAL
+;
+
+606 
+t
+->
+t_ty
+) {
+
+607 
+NPF_TABLE_HASH
+:
+
+608 
+	`rw_r
+(&
+t
+->
+t_lock
+, 
+RW_READER
+);
+
+609 
+found
+ = 
+	`b_hash_lookup
+(
+t
+, 
+addr
+, 
+
+, &
+htbl
+!
+NULL
+;
+
+610 
+	`rw_ex
+(&
+t
+->
+t_lock
+);
+
+612 
+NPF_TABLE_TREE
+:
+
+613 
+	`rw_r
+(&
+t
+->
+t_lock
+, 
+RW_READER
+);
+
+614 
+found
+ = 
+	`e_fd_node
+(&
+t
+->
+t_
+[
+aidx
+], 
+addr
+!
+NULL
+;
+
+615 
+	`rw_ex
+(&
+t
+->
+t_lock
+);
+
+617 
+NPF_TABLE_CDB
+:
+
+618 i(
+	`cdbr_fd
+(
+t
+->
+t_cdb
+, 
+addr
+, 
+
+, &
+da
+, &
+dn
+) == 0) {
+
+619 
+found
+ = 
+dn
+ =
+
+ && 
+	`memcmp
+(
+addr
+, 
+da
+, dlen) == 0;
+
+621 
+found
+ = 
+l
+;
+
+625 
+	`KASSERT
+(
+l
+);
+
+626 
+found
+ = 
+l
+;
+
+629  
+found
+ ? 0 : 
+ENOENT
+;
+
+630 
+	}
+}
+
+633 
+	$b_t_cyout
+(c 
+f_addr_t
+ *
+addr
+, c 
+
+, 
+f_tmask_t
+ 
+mask
+,
+
+634 *
+ubuf
+, 
+size_t
+ 
+n
+, size_*
+off
+)
+
+636 *
+ubu
+ = (
+ut8_t
+ *)
+ubuf
+ + *
+off
+;
+
+637 
+f_iol_t_t
+ 
+ut
+;
+
+639 i((*
+off
+ +(
+f_iol_t_t
+)> 
+n
+) {
+
+640  
+ENOMEM
+;
+
+642 
+ut
+.
+
+ =len;
+
+643 
+	`memy
+(&
+ut
+.
+addr
+,ddr, (
+f_addr_t
+));
+
+644 
+ut
+.
+mask
+ = mask;
+
+646  
+	`cyout
+(&
+ut
+, 
+ubu
+, (
+f_iol_t_t
+));
+
+647 
+	}
+}
+
+650 
+	$b_hash_li
+(c 
+f_b_t
+ *
+t
+, *
+ubuf
+, 
+size_t
+ 
+n
+)
+
+652 
+size_t
+ 
+off
+ = 0;
+
+653 
+r
+ = 0;
+
+655 
+n
+ = 0; <
+t
+->
+t_hashmask
+;++) {
+
+656 
+f_tb_t
+ *
+t
+;
+
+658 
+	`LIST_FOREACH
+(
+t
+, &
+t
+->
+t_hashl
+[
+n
+], 
+_hasht
+) {
+
+659 
+r
+ = 
+	`b_t_cyout
+(&
+t
+->
+_addr
+,
+
+660 
+t
+->
+_
+, 0, 
+ubuf
+, 
+n
+, &
+off
+);
+
+661 i(
+r
+)
+
+665  
+r
+;
+
+666 
+	}
+}
+
+669 
+	$b__li
+(
+__t
+ *
+
+, 
+f_tmask_t
+ 
+maxmask
+, *
+ubuf
+,
+
+670 
+size_t
+ 
+n
+, size_*
+off
+)
+
+672 
+f_tb_t
+ *
+t
+ = 
+NULL
+;
+
+673 
+r
+ = 0;
+
+675 (
+t
+ = 
+	`e_e
+(
+
+,, 
+PT_ASCENDING
+)!
+NULL
+) {
+
+676 
+_bn_t
+ 
+bn
+;
+
+678 i(!
+	`e_mask_node_p
+(
+
+, 
+t
+, &
+bn
+)) {
+
+679 
+bn
+ = 
+maxmask
+;
+
+681 
+r
+ = 
+	`b_t_cyout
+(&
+t
+->
+_addr
+,->
+_
+,
+
+682 
+bn
+, 
+ubuf
+, 
+n
+, 
+off
+);
+
+683 i(
+r
+)
+
+686  
+r
+;
+
+687 
+	}
+}
+
+690 
+	$b_cdb_li
+(
+f_b_t
+ *
+t
+, *
+ubuf
+, 
+size_t
+ 
+n
+)
+
+692 
+size_t
+ 
+off
+ = 0, 
+dn
+;
+
+693 c *
+da
+;
+
+694 
+r
+ = 0;
+
+696 
+size_t
+ 
+i
+ = 0; i < 
+t
+->
+t_nems
+; i++) {
+
+697 i(
+	`cdbr_g
+(
+t
+->
+t_cdb
+, 
+i
+, &
+da
+, &
+dn
+) != 0) {
+
+698  
+EINVAL
+;
+
+700 
+r
+ = 
+	`b_t_cyout
+(
+da
+, 
+dn
+, 0, 
+ubuf
+, 
+n
+, &
+off
+);
+
+701 i(
+r
+)
+
+704  
+r
+;
+
+705 
+	}
+}
+
+711 
+	$f_b_li
+(
+f_b_t
+ *
+t
+, *
+ubuf
+, 
+size_t
+ 
+n
+)
+
+713 
+size_t
+ 
+off
+ = 0;
+
+714 
+r
+ = 0;
+
+716 
+	`rw_r
+(&
+t
+->
+t_lock
+, 
+RW_READER
+);
+
+717 
+t
+->
+t_ty
+) {
+
+718 
+NPF_TABLE_HASH
+:
+
+719 
+r
+ = 
+	`b_hash_li
+(
+t
+, 
+ubuf
+, 
+n
+);
+
+721 
+NPF_TABLE_TREE
+:
+
+722 
+r
+ = 
+	`b__li
+(&
+t
+->
+t_
+[0], 32, 
+ubuf
+, 
+n
+, &
+off
+);
+
+723 i(
+r
+)
+
+725 
+r
+ = 
+	`b__li
+(&
+t
+->
+t_
+[1], 128, 
+ubuf
+, 
+n
+, &
+off
+);
+
+727 
+NPF_TABLE_CDB
+:
+
+728 
+r
+ = 
+	`b_cdb_li
+(
+t
+, 
+ubuf
+, 
+n
+);
+
+731 
+	`KASSERT
+(
+l
+);
+
+733 
+	`rw_ex
+(&
+t
+->
+t_lock
+);
+
+735  
+r
+;
+
+736 
+	}
+}
+
+742 
+	$f_b_ush
+(
+f_b_t
+ *
+t
+)
+
+744 
+r
+ = 0;
+
+746 
+	`rw_r
+(&
+t
+->
+t_lock
+, 
+RW_WRITER
+);
+
+747 
+t
+->
+t_ty
+) {
+
+748 
+NPF_TABLE_HASH
+:
+
+749 
+	`b_hash_deroy
+(
+t
+);
+
+750 
+t
+->
+t_nems
+ = 0;
+
+752 
+NPF_TABLE_TREE
+:
+
+753 
+	`b__deroy
+(&
+t
+->
+t_
+[0]);
+
+754 
+	`b__deroy
+(&
+t
+->
+t_
+[1]);
+
+755 
+t
+->
+t_nems
+ = 0;
+
+757 
+NPF_TABLE_CDB
+:
+
+758 
+r
+ = 
+EINVAL
+;
+
+761 
+	`KASSERT
+(
+l
+);
+
+763 
+	`rw_ex
+(&
+t
+->
+t_lock
+);
+
+764  
+r
+;
+
+765 
+	}
+}
+
+	@npf/npf_tableset_ptree.c
+
+36 
+	~<sys/cdefs.h
+>
+
+37 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_tableset_ptree.c,v 1.1 2012/07/15 00:23:01mind Exp $");
+
+39 
+	~<sys/m.h
+>
+
+40 
+	~<sys/tys.h
+>
+
+42 
+	~<sys/bs.h
+>
+
+43 
+	~<sys/e.h
+>
+
+45 
+	~"f_im.h
+"
+
+47 
+	#DIV32
+ 5
+
+	)
+
+49 
+__t
+
+
+50 
+	$f_e_key
+(c *
+vkey
+, 
+_boff_t
+ 
+boff
+,
+
+51 
+_bn_t
+ 
+bn
+, *
+x
+)
+
+53 c 
+ut32_t
+ *
+addr
+ = (c ut32_*)
+vkey
+;
+
+55 
+	`KASSERT
+(
+boff
+ < 32 * (c 
+u_t
+)
+x
+);
+
+56 
+	`KASSERT
+(
+bn
+ == 1);
+
+58 c 
+ut32_t
+ 
+bs
+ = 
+	`ohl
+(
+addr
+[
+boff
+ >> 
+DIV32
+]);
+
+59 c 
+ut32_t
+ 
+mask
+ = 0x80000000U >> (
+boff
+ & 31);
+
+60  (
+bs
+ & 
+mask
+? 
+PT_SLOT_RIGHT
+ : 
+PT_SLOT_LEFT
+;
+
+61 
+	}
+}
+
+63 
+bo
+
+
+64 
+	$f_e_mchkey
+(c *
+v
+, c *
+vright
+,
+
+65 
+_boff_t
+ 
+boff
+, 
+_bn_t
+ 
+bn
+, *
+x
+)
+
+67 c 
+ut32_t
+ *
+
+ = (c ut32_*)
+v
+;
+
+68 c 
+ut32_t
+ *
+right
+ = (c ut32_*)
+vright
+;
+
+69 c 
+u_t
+ 
+nwds
+ = (c 
+u_t
+)
+x
+;
+
+70 
+size_t
+ 
+i
+ = 
+boff
+ >> 
+DIV32
+;
+
+73 i(
+nwds
+ * 32 < 
+boff
+ + 
+bn
+ ||words * 32 < bitlen) {
+
+74 
+bn
+ = 
+nwds
+ * 32 - 
+boff
+;
+
+78 
+
+ +
+i
+;
+
+79 
+right
+ +
+i
+;
+
+80 
+boff
+ -
+i
+ * 32;
+
+82 ; 
+i
+ < 
+nwds
+; i++, 
+
+++, 
+right
+++, 
+boff
+ = 0) {
+
+83 c 
+ut32_t
+ 
+bs
+ = 
+	`ohl
+(*
+
+ ^ *
+right
+);
+
+84 c sigd 
+xbn
+ = 32 - (
+boff
+ + 
+bn
+);
+
+85 
+ut32_t
+ 
+mask
+ = 
+UINT32_MAX
+ >> 
+boff
+;
+
+91 
+	`KASSERT
+((
+size_t
+)
+boff
+ < 32);
+
+92 i(
+xbn
+ > 0) {
+
+93 
+mask
+ &
+UINT32_MAX
+ << 
+xbn
+;
+
+97 i(
+bs
+ & 
+mask
+) {
+
+98  
+l
+;
+
+102 i(
+xbn
+ >= 0) {
+
+105 
+bn
+ = -
+xbn
+;
+
+108  
+ue
+;
+
+109 
+	}
+}
+
+111 
+bo
+
+
+112 
+	$f_e_mchnode
+(c *
+v
+, c *
+vright
+,
+
+113 
+_boff_t
+ 
+maxboff
+,t_boff_*
+bof
+,t_boff_*
+p
+, *
+x
+)
+
+115 c 
+ut32_t
+ 
+zs
+[4] = { 0, 0, 0, 0 };
+
+116 c 
+ut32_t
+ *
+
+ = (c ut32_*)
+v
+;
+
+117 c 
+ut32_t
+ *
+right
+ = 
+vright
+ ? (c ut32_*)vrigh: 
+zs
+;
+
+118 
+_boff_t
+ 
+boff
+ = *
+bof
+;
+
+119 c 
+u_t
+ 
+nwds
+ = (c 
+u_t
+)
+x
+;
+
+120 
+size_t
+ 
+i
+ = 
+boff
+ >> 
+DIV32
+;
+
+123 i(
+maxboff
+ > 
+nwds
+ * 32) {
+
+124 
+maxboff
+ = 
+nwds
+ * 32;
+
+126 
+_boff_t
+ 
+bn
+ = 
+maxboff
+ - 
+boff
+;
+
+129 *
+p
+ = 
+PT_SLOT_LEFT
+;
+
+130 
+
+ +
+i
+;
+
+131 
+right
+ +
+i
+;
+
+132 
+boff
+ -
+i
+ * 32;
+
+134 ; 
+i
+ < 
+nwds
+; i++, 
+
+++, 
+right
+++, 
+boff
+ = 0) {
+
+135 c sigd 
+xbn
+ = 32 - (
+boff
+ + 
+bn
+);
+
+136 
+ut32_t
+ 
+bs
+ = 
+	`ohl
+(*
+
+ ^ *
+right
+);
+
+137 
+ut32_t
+ 
+mask
+ = 
+UINT32_MAX
+ >> 
+boff
+;
+
+139 
+	`KASSERT
+((
+size_t
+)
+boff
+ < 32);
+
+140 i(
+xbn
+ > 0) {
+
+141 
+mask
+ &
+UINT32_MAX
+ << 
+xbn
+;
+
+145 
+bs
+ &
+mask
+;
+
+146 i(
+bs
+) {
+
+151 
+boff
+ = 32 * 
+i
+ + (32 - 
+	`s32
+(
+bs
+));
+
+153 
+	`KASSERT
+(
+boff
+ < 
+nwds
+ * 32);
+
+154 
+	`KASSERT
+(
+boff
+ >*
+bof
+);
+
+155 
+	`KASSERT
+(
+boff
+ <
+maxboff
+);
+
+157 *
+bof
+ = 
+boff
+;
+
+158 i((
+	`ohl
+(*
+
+>> (31 - 
+boff
+)) & 1) {
+
+159 *
+p
+ = 
+PT_SLOT_RIGHT
+;
+
+162 
+	`KASSERT
+(
+	`f_e_key
+(
+v
+, 
+boff
+, 1, 
+x
+)
+
+163 =*
+p
+);
+
+164  
+l
+;
+
+166 i(
+xbn
+ >= 0) {
+
+167 
+i
+++;
+
+170 
+bn
+ = -
+xbn
+;
+
+173 
+boff
+ = 32 * 
+i
+;
+
+174 *
+bof
+ = 
+boff
+ < 
+maxboff
+ ? bitoff : maxbitoff;
+
+175  
+ue
+;
+
+176 
+	}
+}
+
+178 c 
+__s_t
+ 
+	gf_b_e_s
+ = {
+
+179 .
+to_mchnode
+ = 
+f_e_mchnode
+,
+
+180 .
+	gto_mchkey
+ = 
+f_e_mchkey
+,
+
+181 .
+	gto_node
+ = 
+f_e_key
+,
+
+182 .
+	gto_key
+ = 
+f_e_key
+,
+
+	@npf/npf_worker.c
+
+32 
+	~<sys/cdefs.h
+>
+
+33 
+__KERNEL_RCSID
+(0, "$NetBSD:pf_worker.c,v 1.1 2013/06/02 02:20:04mind Exp $");
+
+35 
+	~<sys/m.h
+>
+
+36 
+	~<sys/tys.h
+>
+
+38 
+	~<sys/mux.h
+>
+
+39 
+	~<sys/kl.h
+>
+
+40 
+	~<sys/kthad.h
+>
+
+42 
+	~"f_im.h
+"
+
+44 
+	#NPF_MAX_WORKS
+ 4
+
+	)
+
+45 
+	#WORKER_INTERVAL
+ 
+	`mohz
+(5 * 1000)
+
+	)
+
+47 
+kmux_t
+ 
+	gwk_lock
+;
+
+48 
+kcdv_t
+ 
+	gwk_cv
+;
+
+49 
+kcdv_t
+ 
+	gwk_evt_cv
+;
+
+50 
+lwp_t
+ * 
+	gwk_lwp
+;
+
+51 
+ut64_t
+ 
+	gwk_lo
+;
+
+53 
+f_wkfunc_t
+ 
+	gwk_funcs
+[
+NPF_MAX_WORKS
+];
+
+55 
+	$f_wk
+(*
+__dd
+;
+
+58 
+	$f_wk_sys
+()
+
+60 
+	`mux_
+(&
+wk_lock
+, 
+MUTEX_DEFAULT
+, 
+IPL_SOFTNET
+);
+
+61 
+	`cv_
+(&
+wk_cv
+, "npfgccv");
+
+62 
+	`cv_
+(&
+wk_evt_cv
+, "npfevcv");
+
+63 
+wk_lwp
+ = (
+lwp_t
+ *)0xdeadbabe;
+
+64 
+wk_lo
+ = 1;
+
+66 i(
+	`kthad_
+(
+PRI_NONE
+, 
+KTHREAD_MPSAFE
+ | 
+KTHREAD_MUSTJOIN
+, 
+NULL
+,
+
+67 
+f_wk
+, 
+NULL
+, &
+wk_lwp
+, "npfgc")) {
+
+68  
+ENOMEM
+;
+
+71 
+	}
+}
+
+74 
+	$f_wk_sysfi
+()
+
+76 
+lwp_t
+ *
+l
+ = 
+wk_lwp
+;
+
+79 
+	`mux_r
+(&
+wk_lock
+);
+
+80 
+wk_lwp
+ = 
+NULL
+;
+
+81 
+	`cv_brd
+(&
+wk_cv
+);
+
+82 
+	`mux_ex
+(&
+wk_lock
+);
+
+83 
+	`kthad_jo
+(
+l
+);
+
+86 
+	`cv_deroy
+(&
+wk_cv
+);
+
+87 
+	`cv_deroy
+(&
+wk_evt_cv
+);
+
+88 
+	`mux_deroy
+(&
+wk_lock
+);
+
+89 
+	}
+}
+
+92 
+	$f_wk_sigl
+()
+
+94 
+	`mux_r
+(&
+wk_lock
+);
+
+95 
+	`cv_sigl
+(&
+wk_cv
+);
+
+96 
+	`mux_ex
+(&
+wk_lock
+);
+
+97 
+	}
+}
+
+99 
+bo
+
+
+100 
+	$f_wk_t
+(
+f_wkfunc_t
+ 
+fd
+,pf_wkfunc_
+t
+)
+
+102 
+u_t
+ 
+i
+ = 0; i < 
+NPF_MAX_WORKS
+; i++) {
+
+103 i(
+wk_funcs
+[
+i
+] =
+fd
+) {
+
+104 
+wk_funcs
+[
+i
+] = 
+t
+;
+
+105  
+ue
+;
+
+108  
+l
+;
+
+109 
+	}
+}
+
+112 
+	$f_wk_gi
+(
+f_wkfunc_t
+ 
+func
+)
+
+114 
+	`mux_r
+(&
+wk_lock
+);
+
+115 
+	`f_wk_t
+(
+NULL
+, 
+func
+);
+
+116 
+	`mux_ex
+(&
+wk_lock
+);
+
+117 
+	}
+}
+
+120 
+	$f_wk_uegi
+(
+f_wkfunc_t
+ 
+func
+)
+
+122 
+ut64_t
+ 
+l
+ = 
+wk_lo
+;
+
+124 
+	`mux_r
+(&
+wk_lock
+);
+
+125 
+	`f_wk_t
+(
+func
+, 
+NULL
+);
+
+126 
+wk_lo
+ =
+l
+) {
+
+127 
+	`cv_sigl
+(&
+wk_cv
+);
+
+128 
+	`cv_wa
+(&
+wk_evt_cv
+, &
+wk_lock
+);
+
+130 
+	`mux_ex
+(&
+wk_lock
+);
+
+131 
+	}
+}
+
+134 
+	$f_wk
+(*
+g
+)
+
+137 c 
+bo
+ 
+fish
+ = (
+wk_lwp
+ =
+NULL
+);
+
+138 
+u_t
+ 
+i
+ = 
+NPF_MAX_WORKS
+;
+
+139 
+f_wkfunc_t
+ 
+wk
+;
+
+142 
+i
+--) {
+
+143 i((
+wk
+ = 
+wk_funcs
+[
+i
+]!
+NULL
+) {
+
+144 
+	`wk
+();
+
+149 i(
+fish
+) {
+
+154 
+	`mux_r
+(&
+wk_lock
+);
+
+155 
+wk_lo
+++;
+
+156 
+	`cv_brd
+(&
+wk_evt_cv
+);
+
+157 
+	`cv_timedwa
+(&
+wk_cv
+, &
+wk_lock
+, 
+WORKER_INTERVAL
+);
+
+158 
+	`mux_ex
+(&
+wk_lock
+);
+
+160 
+	`kthad_ex
+(0);
+
+161 
+	}
+}
+
+	@pfil.c
+
+30 
+	~<sys/cdefs.h
+>
+
+31 
+__KERNEL_RCSID
+(0, "$NetBSD:fil.c,v 1.28 2013/06/29 21:06:58mind Exp $");
+
+33 
+	~<sys/m.h
+>
+
+34 
+	~<sys/sym.h
+>
+
+35 
+	~<sys/queue.h
+>
+
+36 
+	~<sys/kmem.h
+>
+
+38 
+	~<t/if.h
+>
+
+39 
+	~<t/pf.h
+>
+
+41 
+	#MAX_HOOKS
+ 8
+
+	)
+
+44 
+pf_func_t
+ 
+	mpf_func
+;
+
+45 * 
+	mpf_g
+;
+
+46 } 
+	tpf_hook_t
+;
+
+49 
+pf_hook_t
+ 
+	mhooks
+[
+MAX_HOOKS
+];
+
+50 
+u_t
+ 
+	mnhooks
+;
+
+51 } 
+	tpf_li_t
+;
+
+53 
+	spf_hd
+ {
+
+54 
+pf_li_t
+ 
+	mph_
+;
+
+55 
+pf_li_t
+ 
+	mph_out
+;
+
+56 
+pf_li_t
+ 
+	mph_iddr
+;
+
+57 
+pf_li_t
+ 
+	mph_ivt
+;
+
+58 
+	mph_ty
+;
+
+59 * 
+	mph_key
+;
+
+60 
+LIST_ENTRY
+(
+pf_hd
+
+	mph_li
+;
+
+63 c 
+	gpf_ag_s
+[] = {
+
+64 
+PFIL_IN
+, 
+PFIL_OUT
+, 
+PFIL_IFADDR
+, 
+PFIL_IFNET
+
+
+67 
+	$LIST_HEAD
+(, 
+pf_hd
+
+pf_hd_li
+ 
+__ad_moly
+ =
+
+68 
+	`LIST_HEAD_INITIALIZER
+(&
+pf_hd_li
+);
+
+73 
+pf_hd_t
+ *
+
+74 
+	$pf_hd_
+(
+ty
+, *
+key
+)
+
+76 
+pf_hd_t
+ *
+ph
+;
+
+78 i(
+	`pf_hd_g
+(
+ty
+, 
+key
+)) {
+
+79  
+NULL
+;
+
+81 
+ph
+ = 
+	`kmem_zloc
+((
+pf_hd_t
+), 
+KM_SLEEP
+);
+
+82 
+ph
+->
+ph_ty
+ = 
+ty
+;
+
+83 
+ph
+->
+ph_key
+ = 
+key
+;
+
+85 
+	`LIST_INSERT_HEAD
+(&
+pf_hd_li
+, 
+ph
+, 
+ph_li
+);
+
+86  
+ph
+;
+
+87 
+	}
+}
+
+93 
+	$pf_hd_deroy
+(
+pf_hd_t
+ *
+pfh
+)
+
+95 
+	`LIST_REMOVE
+(
+pfh
+, 
+ph_li
+);
+
+96 
+	`kmem_
+(
+pfh
+, (
+pf_hd_t
+));
+
+97 
+	}
+}
+
+102 
+pf_hd_t
+ *
+
+103 
+	$pf_hd_g
+(
+ty
+, *
+key
+)
+
+105 
+pf_hd_t
+ *
+ph
+;
+
+107 
+	`LIST_FOREACH
+(
+ph
+, &
+pf_hd_li
+, 
+ph_li
+) {
+
+108 i(
+ph
+->
+ph_ty
+ =
+ty
+ &&h->
+ph_key
+ =
+key
+)
+
+111  
+ph
+;
+
+112 
+	}
+}
+
+114 
+pf_li_t
+ *
+
+115 
+	$pf_hook_g
+(
+d
+, 
+pf_hd_t
+ *
+ph
+)
+
+117 
+d
+) {
+
+118 
+PFIL_IN
+:
+
+119  &
+ph
+->
+ph_
+;
+
+120 
+PFIL_OUT
+:
+
+121  &
+ph
+->
+ph_out
+;
+
+122 
+PFIL_IFADDR
+:
+
+123  &
+ph
+->
+ph_iddr
+;
+
+124 
+PFIL_IFNET
+:
+
+125  &
+ph
+->
+ph_ivt
+;
+
+127  
+NULL
+;
+
+128 
+	}
+}
+
+131 
+	$pf_li_add
+(
+pf_li_t
+ *
+phli
+, 
+pf_func_t
+ 
+func
+, *
+g
+, 
+ags
+)
+
+133 c 
+u_t
+ 
+nhooks
+ = 
+phli
+->nhooks;
+
+134 
+pf_hook_t
+ *
+pfh
+;
+
+137 i(
+nhooks
+ =
+MAX_HOOKS
+) {
+
+138  
+ENOSPC
+;
+
+140 
+	`KASSERT
+(
+nhooks
+ < 
+MAX_HOOKS
+);
+
+143 
+u_t
+ 
+i
+ = 0; i < 
+nhooks
+; i++) {
+
+144 
+pfh
+ = &
+phli
+->
+hooks
+[
+i
+];
+
+145 i(
+pfh
+->
+pf_func
+ =
+func
+ &&fh->
+pf_g
+ =
+g
+)
+
+146  
+EEXIST
+;
+
+154 i(
+ags
+ & 
+PFIL_IN
+) {
+
+156 
+size_t
+ 
+n
+ = (
+pf_hook_t
+* 
+nhooks
+;
+
+157 
+pfh
+ = &
+phli
+->
+hooks
+[0];
+
+158 
+	`memmove
+(&
+phli
+->
+hooks
+[1], 
+pfh
+, 
+n
+);
+
+160 
+pfh
+ = &
+phli
+->
+hooks
+[
+nhooks
+];
+
+162 
+phli
+->
+nhooks
+++;
+
+164 
+pfh
+->
+pf_func
+ = 
+func
+;
+
+165 
+pfh
+->
+pf_g
+ = 
+g
+;
+
+167 
+	}
+}
+
+180 
+	$pf_add_hook
+(
+pf_func_t
+ 
+func
+, *
+g
+, 
+ags
+, 
+pf_hd_t
+ *
+ph
+)
+
+182 
+r
+ = 0;
+
+184 
+	`KASSERT
+(
+func
+ !
+NULL
+);
+
+186 
+u_t
+ 
+i
+ = 0; i < 
+	`__ycou
+(
+pf_ag_s
+); i++) {
+
+187 c 
+f
+ = 
+pf_ag_s
+[
+i
+];
+
+188 
+pf_li_t
+ *
+phli
+;
+
+190 i((
+ags
+ & 
+f
+) == 0) {
+
+193 
+phli
+ = 
+	`pf_hook_g
+(
+f
+, 
+ph
+);
+
+194 i((
+r
+ = 
+	`pf_li_add
+(
+phli
+, 
+func
+, 
+g
+, 
+ags
+)) != 0) {
+
+198 i(
+r
+) {
+
+199 
+	`pf_move_hook
+(
+func
+, 
+g
+, 
+ags
+, 
+ph
+);
+
+201  
+r
+;
+
+202 
+	}
+}
+
+208 
+	$pf_li_move
+(
+pf_li_t
+ *
+phli
+, 
+pf_func_t
+ 
+func
+, *
+g
+)
+
+210 c 
+u_t
+ 
+nhooks
+ = 
+phli
+->nhooks;
+
+212 
+u_t
+ 
+i
+ = 0; i < 
+nhooks
+; i++) {
+
+213 
+pf_hook_t
+ *
+
+, *
+pfh
+ = &
+phli
+->
+hooks
+[
+i
+];
+
+215 i(
+pfh
+->
+pf_func
+ !
+func
+ ||fh->
+pf_g
+ !
+g
+) {
+
+218 i((
+
+ = &
+phli
+->
+hooks
+[
+nhooks
+ - 1]!
+pfh
+) {
+
+219 
+	`memy
+(
+pfh
+, 
+
+, (
+pf_hook_t
+));
+
+221 
+phli
+->
+nhooks
+--;
+
+224  
+ENOENT
+;
+
+225 
+	}
+}
+
+231 
+	$pf_move_hook
+(
+pf_func_t
+ 
+func
+, *
+g
+, 
+ags
+, 
+pf_hd_t
+ *
+ph
+)
+
+233 
+u_t
+ 
+i
+ = 0; i < 
+	`__ycou
+(
+pf_ag_s
+); i++) {
+
+234 c 
+f
+ = 
+pf_ag_s
+[
+i
+];
+
+235 
+pf_li_t
+ *
+pi
+;
+
+237 i((
+ags
+ & 
+f
+) == 0) {
+
+240 
+pi
+ = 
+	`pf_hook_g
+(
+f
+, 
+ph
+);
+
+241 ()
+	`pf_li_move
+(
+pi
+, 
+func
+, 
+g
+);
+
+244 
+	}
+}
+
+250 
+	$pf_run_hooks
+(
+pf_hd_t
+ *
+ph
+, 
+mbuf
+ **
+mp
+, 
+i_t
+ *
+i
+, 
+d
+)
+
+252 c 
+bo
+ 
+ss_mbuf
+ = (
+d
+ & 
+PFIL_ALL
+!0 && 
+mp
+;
+
+253 
+mbuf
+ *
+m
+ = 
+ss_mbuf
+ ? *
+mp
+ : 
+NULL
+;
+
+254 
+pf_li_t
+ *
+phli
+;
+
+255 
+t
+ = 0;
+
+257 i((
+phli
+ = 
+	`pf_hook_g
+(
+d
+, 
+ph
+)=
+NULL
+) {
+
+258  
+t
+;
+
+261 
+u_t
+ 
+i
+ = 0; i < 
+phli
+->
+nhooks
+; i++) {
+
+262 
+pf_hook_t
+ *
+pfh
+ = &
+phli
+->
+hooks
+[
+i
+];
+
+263 
+pf_func_t
+ 
+func
+ = 
+pfh
+->
+pf_func
+;
+
+265 i(
+	`__edi_ue
+(
+d
+ & 
+PFIL_ALL
+)) {
+
+266 
+t
+ = (*
+func
+)(
+pfh
+->
+pf_g
+, &
+m
+, 
+i
+, 
+d
+);
+
+267 i(
+m
+ =
+NULL
+)
+
+270 
+t
+ = (*
+func
+)(
+pfh
+->
+pf_g
+, 
+mp
+, 
+i
+, 
+d
+);
+
+272 i(
+t
+)
+
+276 i(
+ss_mbuf
+) {
+
+277 *
+mp
+ = 
+m
+;
+
+279  
+t
+;
+
+280 
+	}
+}
+
+	@pfil.h
+
+29 #ide
+_NET_PFIL_H_
+
+
+30 
+	#_NET_PFIL_H_
+
+
+	)
+
+32 
+	~<sys/queue.h
+>
+
+34 
+	gmbuf
+;
+
+35 
+	gi
+;
+
+41 (*
+	tpf_func_t
+)(*, 
+	tmbuf
+ **, 
+	ti
+ *, );
+
+43 
+	#PFIL_IN
+ 0x00000001
+
+	)
+
+44 
+	#PFIL_OUT
+ 0x00000002
+
+	)
+
+45 
+	#PFIL_ALL
+ (
+PFIL_IN
+|
+PFIL_OUT
+)
+
+	)
+
+46 
+	#PFIL_IFADDR
+ 0x00000008
+
+	)
+
+47 
+	#PFIL_IFNET
+ 0x00000010
+
+	)
+
+50 
+	#PFIL_IFNET_ATTACH
+ 0
+
+	)
+
+51 
+	#PFIL_IFNET_DETACH
+ 1
+
+	)
+
+53 
+	#PFIL_TYPE_AF
+ 1
+
+	)
+
+54 
+	#PFIL_TYPE_IFNET
+ 2
+
+	)
+
+56 
+pf_hd
+ 
+	tpf_hd_t
+;
+
+58 #ifde
+_KERNEL
+
+
+60 
+	`pf_run_hooks
+(
+pf_hd_t
+ *, 
+mbuf
+ **, 
+i
+ *, );
+
+61 
+	`pf_add_hook
+(
+pf_func_t
+, *, , 
+pf_hd_t
+ *);
+
+62 
+	`pf_move_hook
+(
+pf_func_t
+, *, , 
+pf_hd_t
+ *);
+
+64 
+pf_hd_t
+ * 
+	`pf_hd_
+(, *);
+
+65 
+	`pf_hd_deroy
+(
+pf_hd_t
+ *);
+
+66 
+pf_hd_t
+ * 
+	`pf_hd_g
+(, *);
+
+69 
+pf_hd_t
+ *
+if_pf
+;
+
+	@pfkeyv2.h
+
+39 #ide
+_NET_PFKEYV2_H_
+
+
+40 
+	#_NET_PFKEYV2_H_
+
+
+	)
+
+48 #ide
+__PFKEY_V2_H
+
+
+49 
+	#__PFKEY_V2_H
+ 1
+
+	)
+
+51 
+	#PF_KEY_V2
+ 2
+
+	)
+
+52 
+	#PFKEYV2_REVISION
+ 199806L
+
+	)
+
+54 
+	#SADB_RESERVED
+ 0
+
+	)
+
+55 
+	#SADB_GETSPI
+ 1
+
+	)
+
+56 
+	#SADB_UPDATE
+ 2
+
+	)
+
+57 
+	#SADB_ADD
+ 3
+
+	)
+
+58 
+	#SADB_DELETE
+ 4
+
+	)
+
+59 
+	#SADB_GET
+ 5
+
+	)
+
+60 
+	#SADB_ACQUIRE
+ 6
+
+	)
+
+61 
+	#SADB_REGISTER
+ 7
+
+	)
+
+62 
+	#SADB_EXPIRE
+ 8
+
+	)
+
+63 
+	#SADB_FLUSH
+ 9
+
+	)
+
+64 
+	#SADB_DUMP
+ 10
+
+	)
+
+65 
+	#SADB_X_PROMISC
+ 11
+
+	)
+
+66 
+	#SADB_X_PCHANGE
+ 12
+
+	)
+
+68 
+	#SADB_X_SPDUPDATE
+ 13
+
+	)
+
+69 
+	#SADB_X_SPDADD
+ 14
+
+	)
+
+70 
+	#SADB_X_SPDDELETE
+ 15
+
+	)
+
+71 
+	#SADB_X_SPDGET
+ 16
+
+	)
+
+72 
+	#SADB_X_SPDACQUIRE
+ 17
+
+	)
+
+73 
+	#SADB_X_SPDDUMP
+ 18
+
+	)
+
+74 
+	#SADB_X_SPDFLUSH
+ 19
+
+	)
+
+75 
+	#SADB_X_SPDSETIDX
+ 20
+
+	)
+
+76 
+	#SADB_X_SPDEXPIRE
+ 21
+
+	)
+
+77 
+	#SADB_X_SPDDELETE2
+ 22
+
+	)
+
+78 
+	#SADB_X_NAT_T_NEW_MAPPING
+ 23
+
+	)
+
+80 
+	#SADB_X_MIGRATE
+ 24
+
+	)
+
+82 
+	#SADB_MAX
+ 23
+
+	)
+
+84 
+	sdb_msg
+ {
+
+85 
+ut8_t
+ 
+	mdb_msg_vsi
+;
+
+86 
+ut8_t
+ 
+	mdb_msg_ty
+;
+
+87 
+ut8_t
+ 
+	mdb_msg_o
+;
+
+88 
+ut8_t
+ 
+	mdb_msg_ty
+;
+
+89 
+ut16_t
+ 
+	mdb_msg_n
+;
+
+90 
+ut16_t
+ 
+	mdb_msg_rved
+;
+
+91 
+ut32_t
+ 
+	mdb_msg_q
+;
+
+92 
+ut32_t
+ 
+	mdb_msg_pid
+;
+
+95 
+	sdb_ext
+ {
+
+96 
+ut16_t
+ 
+	mdb_ext_n
+;
+
+97 
+ut16_t
+ 
+	mdb_ext_ty
+;
+
+100 
+	sdb_
+ {
+
+101 
+ut16_t
+ 
+	mdb__n
+;
+
+102 
+ut16_t
+ 
+	mdb__exy
+;
+
+103 
+ut32_t
+ 
+	mdb__i
+;
+
+104 
+ut8_t
+ 
+	mdb__ay
+;
+
+105 
+ut8_t
+ 
+	mdb__e
+;
+
+106 
+ut8_t
+ 
+	mdb__auth
+;
+
+107 
+ut8_t
+ 
+	mdb__y
+;
+
+108 
+ut32_t
+ 
+	mdb__ags
+;
+
+111 
+	sdb_litime
+ {
+
+112 
+ut16_t
+ 
+	mdb_litime_n
+;
+
+113 
+ut16_t
+ 
+	mdb_litime_exy
+;
+
+114 
+ut32_t
+ 
+	mdb_litime_lotis
+;
+
+115 
+ut64_t
+ 
+	mdb_litime_bys
+;
+
+116 
+ut64_t
+ 
+	mdb_litime_addtime
+;
+
+117 
+ut64_t
+ 
+	mdb_litime_utime
+;
+
+120 
+	sdb_addss
+ {
+
+121 
+ut16_t
+ 
+	mdb_addss_n
+;
+
+122 
+ut16_t
+ 
+	mdb_addss_exy
+;
+
+123 
+ut8_t
+ 
+	mdb_addss_o
+;
+
+124 
+ut8_t
+ 
+	mdb_addss_efixn
+;
+
+125 
+ut16_t
+ 
+	mdb_addss_rved
+;
+
+128 
+	sdb_key
+ {
+
+129 
+ut16_t
+ 
+	mdb_key_n
+;
+
+130 
+ut16_t
+ 
+	mdb_key_exy
+;
+
+131 
+ut16_t
+ 
+	mdb_key_bs
+;
+
+132 
+ut16_t
+ 
+	mdb_key_rved
+;
+
+135 
+	sdb_idt
+ {
+
+136 
+ut16_t
+ 
+	mdb_idt_n
+;
+
+137 
+ut16_t
+ 
+	mdb_idt_exy
+;
+
+138 
+ut16_t
+ 
+	mdb_idt_ty
+;
+
+139 
+ut16_t
+ 
+	mdb_idt_rved
+;
+
+140 
+ut64_t
+ 
+	mdb_idt_id
+;
+
+143 
+	sdb_ns
+ {
+
+144 
+ut16_t
+ 
+	mdb_ns_n
+;
+
+145 
+ut16_t
+ 
+	mdb_ns_exy
+;
+
+146 
+ut32_t
+ 
+	mdb_ns_dpd
+;
+
+147 
+ut8_t
+ 
+	mdb_ns_ns_v
+;
+
+148 
+ut8_t
+ 
+	mdb_ns_ns_n
+;
+
+149 
+ut8_t
+ 
+	mdb_ns_g_v
+;
+
+150 
+ut8_t
+ 
+	mdb_ns_g_n
+;
+
+151 
+ut32_t
+ 
+	mdb_ns_rved
+;
+
+154 
+	sdb_
+ {
+
+155 
+ut16_t
+ 
+	mdb__n
+;
+
+156 
+ut16_t
+ 
+	mdb__exy
+;
+
+157 
+ut8_t
+ 
+	mdb__ay
+;
+
+158 
+ut8_t
+ 
+	mdb__rved
+[3];
+
+161 
+	sdb_comb
+ {
+
+162 
+ut8_t
+ 
+	mdb_comb_auth
+;
+
+163 
+ut8_t
+ 
+	mdb_comb_y
+;
+
+164 
+ut16_t
+ 
+	mdb_comb_ags
+;
+
+165 
+ut16_t
+ 
+	mdb_comb_auth_mbs
+;
+
+166 
+ut16_t
+ 
+	mdb_comb_auth_maxbs
+;
+
+167 
+ut16_t
+ 
+	mdb_comb_y_mbs
+;
+
+168 
+ut16_t
+ 
+	mdb_comb_y_maxbs
+;
+
+169 
+ut32_t
+ 
+	mdb_comb_rved
+;
+
+170 
+ut32_t
+ 
+	mdb_comb_so_lotis
+;
+
+171 
+ut32_t
+ 
+	mdb_comb_hd_lotis
+;
+
+172 
+ut64_t
+ 
+	mdb_comb_so_bys
+;
+
+173 
+ut64_t
+ 
+	mdb_comb_hd_bys
+;
+
+174 
+ut64_t
+ 
+	mdb_comb_so_addtime
+;
+
+175 
+ut64_t
+ 
+	mdb_comb_hd_addtime
+;
+
+176 
+ut64_t
+ 
+	mdb_comb_so_utime
+;
+
+177 
+ut64_t
+ 
+	mdb_comb_hd_utime
+;
+
+180 
+	sdb_sud
+ {
+
+181 
+ut16_t
+ 
+	mdb_sud_n
+;
+
+182 
+ut16_t
+ 
+	mdb_sud_exy
+;
+
+183 
+ut32_t
+ 
+	mdb_sud_rved
+;
+
+186 
+	sdb_g
+ {
+
+187 
+ut8_t
+ 
+	mdb_g_id
+;
+
+188 
+ut8_t
+ 
+	mdb_g_ivn
+;
+
+189 
+ut16_t
+ 
+	mdb_g_mbs
+;
+
+190 
+ut16_t
+ 
+	mdb_g_maxbs
+;
+
+191 
+ut16_t
+ 
+	mdb_g_rved
+;
+
+194 
+	sdb_ge
+ {
+
+195 
+ut16_t
+ 
+	mdb_ge_n
+;
+
+196 
+ut16_t
+ 
+	mdb_ge_exy
+;
+
+197 
+ut32_t
+ 
+	mdb_ge_m
+;
+
+198 
+ut32_t
+ 
+	mdb_ge_max
+;
+
+199 
+ut32_t
+ 
+	mdb_ge_rved
+;
+
+202 
+	sdb_x_kmive
+ {
+
+203 
+ut16_t
+ 
+	mdb_x_kmive_n
+;
+
+204 
+ut16_t
+ 
+	mdb_x_kmive_exy
+;
+
+205 
+ut32_t
+ 
+	mdb_x_kmive_rved
+;
+
+214 
+	sdb_x_2
+ {
+
+215 
+ut16_t
+ 
+	mdb_x_2_n
+;
+
+216 
+ut16_t
+ 
+	mdb_x_2_exy
+;
+
+217 
+ut8_t
+ 
+	mdb_x_2_mode
+;
+
+218 
+ut8_t
+ 
+	mdb_x_2_rved1
+;
+
+219 
+ut16_t
+ 
+	mdb_x_2_rved2
+;
+
+220 
+ut32_t
+ 
+	mdb_x_2_qu
+;
+
+221 
+ut32_t
+ 
+	mdb_x_2_qid
+;
+
+226 
+	sdb_x_picy
+ {
+
+227 
+ut16_t
+ 
+	mdb_x_picy_n
+;
+
+228 
+ut16_t
+ 
+	mdb_x_picy_exy
+;
+
+229 
+ut16_t
+ 
+	mdb_x_picy_ty
+;
+
+230 
+ut8_t
+ 
+	mdb_x_picy_d
+;
+
+231 
+ut8_t
+ 
+	mdb_x_picy_rved
+;
+
+232 
+ut32_t
+ 
+	mdb_x_picy_id
+;
+
+233 
+ut32_t
+ 
+	mdb_x_picy_rved2
+;
+
+246 
+	sdb_x_eque
+ {
+
+247 
+ut16_t
+ 
+	mdb_x_eque_n
+;
+
+248 
+ut16_t
+ 
+	mdb_x_eque_o
+;
+
+249 
+ut8_t
+ 
+	mdb_x_eque_mode
+;
+
+250 
+ut8_t
+ 
+	mdb_x_eque_v
+;
+
+251 
+ut16_t
+ 
+	mdb_x_eque_qid
+;
+
+264 
+	sdb_x_t_t_ty
+ {
+
+265 
+ut16_t
+ 
+	mdb_x_t_t_ty_n
+;
+
+266 
+ut16_t
+ 
+	mdb_x_t_t_ty_exy
+;
+
+267 
+ut8_t
+ 
+	mdb_x_t_t_ty_ty
+;
+
+268 
+ut8_t
+ 
+	mdb_x_t_t_ty_rved
+[3];
+
+273 
+	sdb_x_t_t_pt
+ {
+
+274 
+ut16_t
+ 
+	mdb_x_t_t_pt_n
+;
+
+275 
+ut16_t
+ 
+	mdb_x_t_t_pt_exy
+;
+
+276 
+ut16_t
+ 
+	mdb_x_t_t_pt_pt
+;
+
+277 
+ut16_t
+ 
+	mdb_x_t_t_pt_rved
+;
+
+282 
+	sdb_x_t_t_ag
+ {
+
+283 
+ut16_t
+ 
+	mdb_x_t_t_ag_n
+;
+
+284 
+ut16_t
+ 
+	mdb_x_t_t_ag_exy
+;
+
+285 
+ut16_t
+ 
+	mdb_x_t_t_ag_agn
+;
+
+286 
+ut16_t
+ 
+	mdb_x_t_t_ag_rved
+;
+
+290 
+	#SADB_EXT_RESERVED
+ 0
+
+	)
+
+291 
+	#SADB_EXT_SA
+ 1
+
+	)
+
+292 
+	#SADB_EXT_LIFETIME_CURRENT
+ 2
+
+	)
+
+293 
+	#SADB_EXT_LIFETIME_HARD
+ 3
+
+	)
+
+294 
+	#SADB_EXT_LIFETIME_SOFT
+ 4
+
+	)
+
+295 
+	#SADB_EXT_ADDRESS_SRC
+ 5
+
+	)
+
+296 
+	#SADB_EXT_ADDRESS_DST
+ 6
+
+	)
+
+297 
+	#SADB_EXT_ADDRESS_PROXY
+ 7
+
+	)
+
+298 
+	#SADB_EXT_KEY_AUTH
+ 8
+
+	)
+
+299 
+	#SADB_EXT_KEY_ENCRYPT
+ 9
+
+	)
+
+300 
+	#SADB_EXT_IDENTITY_SRC
+ 10
+
+	)
+
+301 
+	#SADB_EXT_IDENTITY_DST
+ 11
+
+	)
+
+302 
+	#SADB_EXT_SENSITIVITY
+ 12
+
+	)
+
+303 
+	#SADB_EXT_PROPOSAL
+ 13
+
+	)
+
+304 
+	#SADB_EXT_SUPPORTED_AUTH
+ 14
+
+	)
+
+305 
+	#SADB_EXT_SUPPORTED_ENCRYPT
+ 15
+
+	)
+
+306 
+	#SADB_EXT_SPIRANGE
+ 16
+
+	)
+
+307 
+	#SADB_X_EXT_KMPRIVATE
+ 17
+
+	)
+
+308 
+	#SADB_X_EXT_POLICY
+ 18
+
+	)
+
+309 
+	#SADB_X_EXT_SA2
+ 19
+
+	)
+
+310 
+	#SADB_X_EXT_NAT_T_TYPE
+ 20
+
+	)
+
+311 
+	#SADB_X_EXT_NAT_T_SPORT
+ 21
+
+	)
+
+312 
+	#SADB_X_EXT_NAT_T_DPORT
+ 22
+
+	)
+
+313 
+	#SADB_X_EXT_NAT_T_OA
+ 23
+
+	)
+
+314 
+	#SADB_X_EXT_NAT_T_OAI
+ 23
+
+	)
+
+315 
+	#SADB_X_EXT_NAT_T_OAR
+ 24
+
+	)
+
+316 
+	#SADB_X_EXT_NAT_T_FRAG
+ 25
+
+	)
+
+318 
+	#SADB_X_EXT_TAG
+ 25
+
+	)
+
+319 
+	#SADB_X_EXT_SA3
+ 26
+
+	)
+
+320 
+	#SADB_X_EXT_PACKET
+ 27
+
+	)
+
+322 
+	#SADB_EXT_MAX
+ 25
+
+	)
+
+324 
+	#SADB_SATYPE_UNSPEC
+ 0
+
+	)
+
+325 
+	#SADB_SATYPE_AH
+ 2
+
+	)
+
+326 
+	#SADB_SATYPE_ESP
+ 3
+
+	)
+
+327 
+	#SADB_SATYPE_RSVP
+ 5
+
+	)
+
+328 
+	#SADB_SATYPE_OSPFV2
+ 6
+
+	)
+
+329 
+	#SADB_SATYPE_RIPV2
+ 7
+
+	)
+
+330 
+	#SADB_SATYPE_MIP
+ 8
+
+	)
+
+331 
+	#SADB_X_SATYPE_IPCOMP
+ 9
+
+	)
+
+333 
+	#SADB_X_SATYPE_TCPSIGNATURE
+ 11
+
+	)
+
+334 
+	#SADB_SATYPE_MAX
+ 12
+
+	)
+
+336 
+	#SADB_SASTATE_LARVAL
+ 0
+
+	)
+
+337 
+	#SADB_SASTATE_MATURE
+ 1
+
+	)
+
+338 
+	#SADB_SASTATE_DYING
+ 2
+
+	)
+
+339 
+	#SADB_SASTATE_DEAD
+ 3
+
+	)
+
+340 
+	#SADB_SASTATE_MAX
+ 3
+
+	)
+
+342 
+	#SADB_SAFLAGS_PFS
+ 1
+
+	)
+
+345 
+	#SADB_AALG_NONE
+ 0
+
+	)
+
+346 
+	#SADB_AALG_MD5HMAC
+ 2
+
+	)
+
+347 
+	#SADB_AALG_SHA1HMAC
+ 3
+
+	)
+
+348 
+	#SADB_AALG_MAX
+ 251
+
+	)
+
+350 
+	#SADB_X_AALG_SHA2_256
+ 5
+
+	)
+
+351 
+	#SADB_X_AALG_SHA2_384
+ 6
+
+	)
+
+352 
+	#SADB_X_AALG_SHA2_512
+ 7
+
+	)
+
+353 
+	#SADB_X_AALG_RIPEMD160HMAC
+ 8
+
+	)
+
+354 
+	#SADB_X_AALG_AES_XCBC_MAC
+ 9
+
+	)
+
+355 
+	#SADB_X_AALG_AES128GMAC
+ 11
+
+	)
+
+356 
+	#SADB_X_AALG_AES192GMAC
+ 12
+
+	)
+
+357 
+	#SADB_X_AALG_AES256GMAC
+ 13
+
+	)
+
+359 
+	#SADB_X_AALG_MD5
+ 249
+
+	)
+
+360 
+	#SADB_X_AALG_SHA
+ 250
+
+	)
+
+361 
+	#SADB_X_AALG_NULL
+ 251
+
+	)
+
+362 
+	#SADB_X_AALG_TCP_MD5
+ 252
+
+	)
+
+365 
+	#SADB_EALG_NONE
+ 0
+
+	)
+
+366 
+	#SADB_EALG_DESCBC
+ 2
+
+	)
+
+367 
+	#SADB_EALG_3DESCBC
+ 3
+
+	)
+
+368 
+	#SADB_EALG_NULL
+ 11
+
+	)
+
+369 
+	#SADB_EALG_MAX
+ 250
+
+	)
+
+371 
+	#SADB_X_EALG_CAST128CBC
+ 6
+
+	)
+
+372 
+	#SADB_X_EALG_BLOWFISHCBC
+ 7
+
+	)
+
+373 
+	#SADB_X_EALG_RIJNDAELCBC
+ 12
+
+	)
+
+374 
+	#SADB_X_EALG_AES
+ 12
+
+	)
+
+375 
+	#SADB_X_EALG_AESCTR
+ 13
+
+	)
+
+376 
+	#SADB_X_EALG_AESGCM8
+ 18
+
+	)
+
+377 
+	#SADB_X_EALG_AESGCM12
+ 19
+
+	)
+
+378 
+	#SADB_X_EALG_AESGCM16
+ 20
+
+	)
+
+379 
+	#SADB_X_EALG_CAMELLIACBC
+ 22
+
+	)
+
+380 
+	#SADB_X_EALG_AESGMAC
+ 23
+
+	)
+
+382 
+	#SADB_X_EALG_SKIPJACK
+ 250
+
+	)
+
+385 
+	#SADB_X_CALG_NONE
+ 0
+
+	)
+
+386 
+	#SADB_X_CALG_OUI
+ 1
+
+	)
+
+387 
+	#SADB_X_CALG_DEFLATE
+ 2
+
+	)
+
+388 
+	#SADB_X_CALG_LZS
+ 3
+
+	)
+
+389 
+	#SADB_X_CALG_MAX
+ 4
+
+	)
+
+391 
+	#SADB_IDENTTYPE_RESERVED
+ 0
+
+	)
+
+392 
+	#SADB_IDENTTYPE_PREFIX
+ 1
+
+	)
+
+393 
+	#SADB_IDENTTYPE_FQDN
+ 2
+
+	)
+
+394 
+	#SADB_IDENTTYPE_USERFQDN
+ 3
+
+	)
+
+395 
+	#SADB_X_IDENTTYPE_ADDR
+ 4
+
+	)
+
+396 
+	#SADB_IDENTTYPE_MAX
+ 4
+
+	)
+
+399 
+	#SADB_X_EXT_NONE
+ 0x0000
+
+	)
+
+400 
+	#SADB_X_EXT_OLD
+ 0x0001
+
+	)
+
+402 
+	#SADB_X_EXT_IV4B
+ 0x0010
+
+	)
+
+403 
+	#SADB_X_EXT_DERIV
+ 0x0020
+
+	)
+
+404 
+	#SADB_X_EXT_CYCSEQ
+ 0x0040
+
+	)
+
+407 
+	#SADB_X_EXT_PSEQ
+ 0x0000
+
+	)
+
+408 
+	#SADB_X_EXT_PRAND
+ 0x0100
+
+	)
+
+409 
+	#SADB_X_EXT_PZERO
+ 0x0200
+
+	)
+
+410 
+	#SADB_X_EXT_PMASK
+ 0x0300
+
+	)
+
+413 
+	#SADB_X_EXT_RAWCPI
+ 0x0080
+
+	)
+
+416 
+	#SADB_KEY_FLAGS_MAX
+ 0x0fff
+
+	)
+
+419 
+	#PFKEY_SPI_SIZE
+ (
+ut32_t
+)
+
+	)
+
+422 
+	#SADB_X_LIFETIME_ALLOCATIONS
+ 0
+
+	)
+
+423 
+	#SADB_X_LIFETIME_BYTES
+ 1
+
+	)
+
+424 
+	#SADB_X_LIFETIME_ADDTIME
+ 2
+
+	)
+
+425 
+	#SADB_X_LIFETIME_USETIME
+ 3
+
+	)
+
+428 
+	#PFKEY_SOFT_LIFETIME_RATE
+ 80
+
+	)
+
+431 
+	#PFKEY_ALIGN8
+(
+a
+(1 + ((- 1| (8 - 1)))
+
+	)
+
+432 
+	#PFKEY_EXTLEN
+(
+msg
+) \
+
+433 
+	`PFKEY_UNUNIT64
+(((c 
+db_ext
+ *)(c *)(
+msg
+))->
+db_ext_n
+)
+
+	)
+
+434 
+	#PFKEY_ADDR_PREFIX
+(
+ext
+) \
+
+435 (((c 
+db_addss
+ *)(c *)(
+ext
+))->
+db_addss_efixn
+)
+
+	)
+
+436 
+	#PFKEY_ADDR_PROTO
+(
+ext
+) \
+
+437 (((c 
+db_addss
+ *)(c *)(
+ext
+))->
+db_addss_o
+)
+
+	)
+
+438 
+	#PFKEY_ADDR_SADDR
+(
+ext
+) \
+
+439 ((
+sockaddr
+ *)(*)((*)(*)(
+ext
+) + \
+
+440 (
+db_addss
+)))
+
+	)
+
+443 
+	#PFKEY_UNUNIT64
+(
+a
+(<< 3)
+
+	)
+
+444 
+	#PFKEY_UNIT64
+(
+a
+(>> 3)
+
+	)
+
+	@pktqueue.c
+
+38 
+	~<sys/cdefs.h
+>
+
+39 
+__KERNEL_RCSID
+(0, "$NetBSD:ktqueue.c,v 1.8 2014/07/04 01:50:22 ozaki-r Exp $");
+
+41 
+	~<sys/m.h
+>
+
+42 
+	~<sys/tys.h
+>
+
+44 
+	~<sys/omic.h
+>
+
+45 
+	~<sys/u.h
+>
+
+46 
+	~<sys/pcq.h
+>
+
+47 
+	~<sys/.h
+>
+
+48 
+	~<sys/mbuf.h
+>
+
+49 
+	~<sys/oc.h
+>
+
+50 
+	~<sys/ru.h
+>
+
+51 
+	~<t/pktqueue.h
+>
+
+52 
+	~"../../../fm/cos/coun.h
+"
+
+53 
+rump_vmid
+;
+
+57 
+	#PKTQ_CLPAD
+ \
+
+58 
+	`MAX
+(
+COHERENCY_UNIT
+, COHERENCY_UNIT - (
+kmux_t
+- (
+u_t
+))
+
+	)
+
+60 
+	spktqueue
+ {
+
+66 
+kmux_t
+ 
+	mpq_lock
+;
+
+67 v
+u_t
+ 
+	mpq_brr
+;
+
+68 
+ut8_t
+ 
+	m_d
+[
+PKTQ_CLPAD
+];
+
+71 
+u_t
+ 
+	mpq_maxn
+;
+
+72 
+ru_t
+ * 
+	mpq_cous
+;
+
+73 * 
+	mpq_sih
+;
+
+76 
+pcq_t
+ * 
+	mpq_queue
+[];
+
+80 
+	#PQCNT_ENQUEUE
+ 0
+
+	)
+
+81 
+	#PQCNT_DEQUEUE
+ 1
+
+	)
+
+82 
+	#PQCNT_DROP
+ 2
+
+	)
+
+83 
+	#PQCNT_NCOUNTERS
+ 3
+
+	)
+
+86 
+ut64_t
+ 
+	mcou
+[
+PQCNT_NCOUNTERS
+];
+
+87 } 
+	tpktq_cous_t
+;
+
+90 
+	#PKTQ_MARKER
+ ((*)(~0ULL))
+
+	)
+
+95 
+	#PKTQUEUE_STRUCT_LEN
+(
+nu
+) \
+
+96 
+	`roundup2
+(
+	`offtof
+(
+pktqueue_t
+, 
+pq_queue
+[
+nu
+]), 
+cohcy_un
+)
+
+	)
+
+98 
+pktqueue_t
+ *
+
+99 
+pktq_
+(
+size_t
+ 
+maxn
+, (*
+h
+)(*), *
+sc
+)
+
+101 c 
+u_t
+ 
+sags
+ = 
+SOFTINT_NET
+ | 
+SOFTINT_MPSAFE
+ | 
+SOFTINT_RCPU
+;
+
+102 c 
+size_t
+ 
+n
+ = 
+	`PKTQUEUE_STRUCT_LEN
+(
+nu
+);
+
+103 
+pktqueue_t
+ *
+pq
+;
+
+104 
+ru_t
+ *
+pc
+;
+
+105 *
+sih
+;
+
+107 i((
+pc
+ = 
+	`ru_loc
+((
+pktq_cous_t
+))=
+NULL
+) {
+
+108  
+NULL
+;
+
+110 i((
+sih
+ = 
+	`sot_eablish
+(
+sags
+, 
+h
+, 
+sc
+)=
+NULL
+) {
+
+111 
+	`ru_
+(
+pc
+, (
+pktq_cous_t
+));
+
+112  
+NULL
+;
+
+115 
+pq
+ = 
+	`kmem_zloc
+(
+n
+, 
+KM_SLEEP
+);
+
+116 
+u_t
+ 
+i
+ = 0; i < 
+nu
+; i++) {
+
+117 
+pq
+->
+pq_queue
+[
+i
+] = 
+	`pcq_
+(
+maxn
+, 
+KM_SLEEP
+);
+
+119 
+	`mux_
+(&
+pq
+->
+pq_lock
+, 
+MUTEX_DEFAULT
+, 
+IPL_NONE
+);
+
+120 
+pq
+->
+pq_maxn
+ = 
+maxn
+;
+
+121 
+pq
+->
+pq_cous
+ = 
+pc
+;
+
+122 
+pq
+->
+pq_sih
+ = 
+sih
+;
+
+124  
+pq
+;
+
+125 
+	}
+}
+
+128 
+	$pktq_deroy
+(
+pktqueue_t
+ *
+pq
+)
+
+130 c 
+size_t
+ 
+n
+ = 
+	`PKTQUEUE_STRUCT_LEN
+(
+nu
+);
+
+132 
+u_t
+ 
+i
+ = 0; i < 
+nu
+; i++) {
+
+133 
+pcq_t
+ *
+q
+ = 
+pq
+->
+pq_queue
+[
+i
+];
+
+134 
+	`KASSERT
+(
+	`pcq_ek
+(
+q
+=
+NULL
+);
+
+135 
+	`pcq_deroy
+(
+q
+);
+
+137 
+	`ru_
+(
+pq
+->
+pq_cous
+, (
+pktq_cous_t
+));
+
+138 
+	`sot_diablish
+(
+pq
+->
+pq_sih
+);
+
+139 
+	`mux_deroy
+(&
+pq
+->
+pq_lock
+);
+
+140 
+	`kmem_
+(
+pq
+, 
+n
+);
+
+141 
+	}
+}
+
+149 
+le
+ 
+
+150 
+	$pktq_c_cou
+(
+pktqueue_t
+ *
+pq
+, 
+u_t
+ 
+i
+)
+
+152 
+ru_t
+ *
+pc
+ = 
+pq
+->
+pq_cous
+;
+
+153 
+pktq_cous_t
+ *
+c
+;
+
+155 
+c
+ = 
+	`ru_gf
+(
+pc
+);
+
+156 
+c
+->
+cou
+[
+i
+]++;
+
+157 
+	`ru_puef
+(
+pc
+);
+
+158 
+	}
+}
+
+161 
+	$pktq_c_cous
+(*
+mem
+, *
+g
+, 
+u_fo
+ *
+ci
+)
+
+163 c 
+pktq_cous_t
+ *
+c
+ = 
+mem
+;
+
+164 
+pktq_cous_t
+ *
+sum
+ = 
+g
+;
+
+166 
+u_t
+ 
+i
+ = 0; i < 
+PQCNT_NCOUNTERS
+; i++) {
+
+167 
+sum
+->
+cou
+[
+i
+] +
+c
+->count[i];
+
+169 
+	}
+}
+
+171 
+ut64_t
+
+
+172 
+	$pktq_g_cou
+(
+pktqueue_t
+ *
+pq
+, 
+pktq_cou_t
+ 
+c
+)
+
+174 
+pktq_cous_t
+ 
+sum
+;
+
+176 i(
+c
+ !
+PKTQ_MAXLEN
+) {
+
+177 
+	`memt
+(&
+sum
+, 0, (sum));
+
+178 
+	`ru_fch
+(
+pq
+->
+pq_cous
+, 
+pktq_c_cous
+, &
+sum
+);
+
+180 
+c
+) {
+
+181 
+PKTQ_NITEMS
+:
+
+182  
+sum
+.
+cou
+[
+PQCNT_ENQUEUE
+] - sum.cou[
+PQCNT_DEQUEUE
+];
+
+183 
+PKTQ_DROPS
+:
+
+184  
+sum
+.
+cou
+[
+PQCNT_DROP
+];
+
+185 
+PKTQ_MAXLEN
+:
+
+186  
+pq
+->
+pq_maxn
+;
+
+189 
+	}
+}
+
+191 
+ut32_t
+
+
+192 
+	$pktq_s_hash
+(c 
+mbuf
+ *
+m
+ 
+__unud
+)
+
+199 
+	}
+}
+
+208 
+bo
+
+
+209 
+	$cos_pktq_queue
+(*
+buff
+, 
+to_vmid
+)
+
+211 
+	`tf
+("cos_pktq_enqueue\n");
+
+212 
+	`KASSERT
+(
+	`km_dibd
+());
+
+214 if(!
+	`rump_shmem_wre
+(
+buff
+, (buff), 
+rump_vmid
+, 
+to_vmid
+)){
+
+215  
+l
+;
+
+218  
+ue
+;
+
+219 
+	}
+}
+
+221 
+bo
+
+
+222 
+	$pktq_queue
+(
+pktqueue_t
+ *
+pq
+, 
+mbuf
+ *
+m
+, c 
+u_t
+ 
+hash
+ 
+__unud
+)
+
+224 
+	`tf
+("pktq_enqueue\n");
+
+225 #i
+	`defed
+(
+_RUMPKERNEL
+|| defed(
+_RUMP_NATIVE_ABI
+)
+
+226 c 
+uid
+ = 
+	`curu
+()->
+ci_dex
+;
+
+228 c 
+uid
+ = 
+hash
+ % 
+nu
+;
+
+230 
+	`KASSERT
+(
+	`km_dibd
+());
+
+232 i(
+	`__edi_l
+(!
+	`pcq_put
+(
+pq
+->
+pq_queue
+[
+uid
+], 
+m
+))) {
+
+233 
+	`pktq_c_cou
+(
+pq
+, 
+PQCNT_DROP
+);
+
+234  
+l
+;
+
+236 
+	`sot_schedu_u
+(
+pq
+->
+pq_sih
+, 
+	`u_lookup
+(
+uid
+));
+
+237 
+	`pktq_c_cou
+(
+pq
+, 
+PQCNT_ENQUEUE
+);
+
+238  
+ue
+;
+
+239 
+	}
+}
+
+248 
+mbuf
+ *
+
+249 
+	$cos_pktq_dequeue
+(
+pktqueue_t
+ *
+pq
+)
+
+251 
+mbuf
+ *
+m
+;
+
+253 if(!
+	`rump_shmem_ad
+(&
+m
+, !
+rump_vmid
+,ump_vmid)){
+
+254 
+	`tf
+("read failed\n");
+
+255  
+NULL
+;
+
+257 i(
+	`__edi_ue
+(
+m
+ !
+NULL
+)) {
+
+258 
+	`pktq_c_cou
+(
+pq
+, 
+PQCNT_DEQUEUE
+);
+
+260  
+m
+;
+
+261 
+	}
+}
+
+263 
+mbuf
+ *
+
+264 
+	$pktq_dequeue
+(
+pktqueue_t
+ *
+pq
+)
+
+266 c 
+u_fo
+ *
+ci
+ = 
+	`curu
+();
+
+267 c 
+uid
+ = 
+	`u_dex
+(
+ci
+);
+
+268 
+mbuf
+ *
+m
+;
+
+270 
+m
+ = 
+	`pcq_g
+(
+pq
+->
+pq_queue
+[
+uid
+]);
+
+271 i(
+	`__edi_l
+(
+m
+ =
+PKTQ_MARKER
+)) {
+
+273 
+	`omic_c_ut
+(&
+pq
+->
+pq_brr
+);
+
+274  
+NULL
+;
+
+276 i(
+	`__edi_ue
+(
+m
+ !
+NULL
+)) {
+
+277 
+	`pktq_c_cou
+(
+pq
+, 
+PQCNT_DEQUEUE
+);
+
+279  
+m
+;
+
+280 
+	}
+}
+
+288 
+	$pktq_brr
+(
+pktqueue_t
+ *
+pq
+)
+
+290 
+u_t
+ 
+ndg
+ = 0;
+
+292 
+	`mux_r
+(&
+pq
+->
+pq_lock
+);
+
+293 
+	`KASSERT
+(
+pq
+->
+pq_brr
+ == 0);
+
+295 
+u_t
+ 
+i
+ = 0; i < 
+nu
+; i++) {
+
+296 
+pcq_t
+ *
+q
+ = 
+pq
+->
+pq_queue
+[
+i
+];
+
+299 i(
+	`pcq_ek
+(
+q
+=
+NULL
+) {
+
+303 !
+	`pcq_put
+(
+q
+, 
+PKTQ_MARKER
+)) {
+
+304 
+	`ku
+("pktqsync", 
+l
+, 1, 
+NULL
+);
+
+306 
+	`km_dib
+();
+
+307 
+	`sot_schedu_u
+(
+pq
+->
+pq_sih
+, 
+	`u_lookup
+(
+i
+));
+
+308 
+	`km_ab
+();
+
+309 
+ndg
+++;
+
+313 
+pq
+->
+pq_brr
+ !
+ndg
+) {
+
+314 
+	`ku
+("pktqsync", 
+l
+, 1, 
+NULL
+);
+
+316 
+pq
+->
+pq_brr
+ = 0;
+
+317 
+	`mux_ex
+(&
+pq
+->
+pq_lock
+);
+
+318 
+	}
+}
+
+326 
+	$pktq_ush
+(
+pktqueue_t
+ *
+pq
+)
+
+328 
+mbuf
+ *
+m
+;
+
+330 
+u_t
+ 
+i
+ = 0; i < 
+nu
+; i++) {
+
+331 (
+m
+ = 
+	`pcq_g
+(
+pq
+->
+pq_queue
+[
+i
+])!
+NULL
+) {
+
+332 
+	`pktq_c_cou
+(
+pq
+, 
+PQCNT_DEQUEUE
+);
+
+333 
+	`m_m
+(
+m
+);
+
+336 
+	}
+}
+
+343 
+	$pktq_t_maxn
+(
+pktqueue_t
+ *
+pq
+, 
+size_t
+ 
+maxn
+)
+
+345 c 
+u_t
+ 
+bys
+ = 
+nu
+ * (
+pcq_t
+ *);
+
+346 
+pcq_t
+ **
+qs
+;
+
+348 i(!
+maxn
+ || max> 
+PCQ_MAXLEN
+)
+
+349  
+EINVAL
+;
+
+350 i(
+pq
+->
+pq_maxn
+ =
+maxn
+)
+
+354 
+qs
+ = 
+	`kmem_zloc
+(
+bys
+, 
+KM_SLEEP
+);
+
+355 
+u_t
+ 
+i
+ = 0; i < 
+nu
+; i++) {
+
+356 
+qs
+[
+i
+] = 
+	`pcq_
+(
+maxn
+, 
+KM_SLEEP
+);
+
+358 
+	`mux_r
+(&
+pq
+->
+pq_lock
+);
+
+359 
+u_t
+ 
+i
+ = 0; i < 
+nu
+; i++) {
+
+361 
+pcq_t
+ *
+q
+ = 
+pq
+->
+pq_queue
+[
+i
+];
+
+362 
+pq
+->
+pq_queue
+[
+i
+] = 
+qs
+[i];
+
+363 
+qs
+[
+i
+] = 
+q
+;
+
+365 
+pq
+->
+pq_maxn
+ = 
+maxn
+;
+
+366 
+	`mux_ex
+(&
+pq
+->
+pq_lock
+);
+
+380 
+	`pktq_brr
+(
+pq
+);
+
+382 
+u_t
+ 
+i
+ = 0; i < 
+nu
+; i++) {
+
+383 
+mbuf
+ *
+m
+;
+
+385 (
+m
+ = 
+	`pcq_g
+(
+qs
+[
+i
+])!
+NULL
+) {
+
+386 !
+	`pcq_put
+(
+pq
+->
+pq_queue
+[
+i
+], 
+m
+)) {
+
+387 
+	`ku
+("pktqnq", 
+l
+, 1, 
+NULL
+);
+
+390 
+	`pcq_deroy
+(
+qs
+[
+i
+]);
+
+394 
+	`kmem_
+(
+qs
+, 
+bys
+);
+
+396 
+	}
+}
+
+399 
+	$sysl_pktq_maxn
+(
+SYSCTLFN_ARGS
+, 
+pktqueue_t
+ *
+pq
+)
+
+401 
+u_t
+ 
+nmaxn
+ = 
+	`pktq_g_cou
+(
+pq
+, 
+PKTQ_MAXLEN
+);
+
+402 
+sysode
+ 
+node
+ = *
+ode
+;
+
+403 
+r
+;
+
+405 
+node
+.
+sysl_da
+ = &
+nmaxn
+;
+
+406 
+r
+ = 
+	`sysl_lookup
+(
+	`SYSCTLFN_CALL
+(&
+node
+));
+
+407 i(
+r
+ || 
+wp
+ =
+NULL
+)
+
+408  
+r
+;
+
+409  
+	`pktq_t_maxn
+(
+pq
+, 
+nmaxn
+);
+
+410 
+	}
+}
+
+413 
+	$sysl_pktq_cou
+(
+SYSCTLFN_ARGS
+, 
+pktqueue_t
+ *
+pq
+, 
+u_t
+ 
+cou_id
+)
+
+415 
+cou
+ = 
+	`pktq_g_cou
+(
+pq
+, 
+cou_id
+);
+
+416 
+sysode
+ 
+node
+ = *
+ode
+;
+
+417 
+node
+.
+sysl_da
+ = &
+cou
+;
+
+418  
+	`sysl_lookup
+(
+	`SYSCTLFN_CALL
+(&
+node
+));
+
+419 
+	}
+}
+
+	@pktqueue.h
+
+32 #ide
+_NET_PKTQUEUE_H_
+
+
+33 
+	#_NET_PKTQUEUE_H_
+
+
+	)
+
+35 #i!
+defed
+(
+_KERNEL
+)
+
+39 
+	~<sys/sysl.h
+>
+
+41 
+	gmbuf
+;
+
+43 
+pktqueue
+ 
+	tpktqueue_t
+;
+
+45 um { 
+	mPKTQ_MAXLEN
+, 
+	mPKTQ_NITEMS
+, 
+	mPKTQ_DROPS
+ } 
+	tpktq_cou_t
+;
+
+47 
+pktqueue_t
+ * 
+pktq_
+(
+size_t
+, (*)(*), *);
+
+48 
+	`pktq_deroy
+(
+pktqueue_t
+ *);
+
+50 
+bo
+ 
+	`pktq_queue
+(
+pktqueue_t
+ *, 
+mbuf
+ *, c 
+u_t
+);
+
+51 
+bo
+ 
+	`cos_pktq_queue
+(* 
+buff
+, 
+to_vmid
+);
+
+52 
+mbuf
+ * 
+	`pktq_dequeue
+(
+pktqueue_t
+ *);
+
+53 
+mbuf
+ * 
+	`cos_pktq_dequeue
+(
+pktqueue_t
+ *);
+
+54 
+	`pktq_brr
+(
+pktqueue_t
+ *);
+
+55 
+	`pktq_ush
+(
+pktqueue_t
+ *);
+
+56 
+	`pktq_t_maxn
+(
+pktqueue_t
+ *, 
+size_t
+);
+
+58 
+ut32_t
+ 
+	`pktq_s_hash
+(c 
+mbuf
+ *);
+
+59 
+ut64_t
+ 
+	`pktq_g_cou
+(
+pktqueue_t
+ *, 
+pktq_cou_t
+);
+
+61 
+	`sysl_pktq_maxn
+(
+SYSCTLFN_PROTO
+, 
+pktqueue_t
+ *);
+
+62 
+	`sysl_pktq_cou
+(
+SYSCTLFN_PROTO
+, 
+pktqueue_t
+ *, 
+u_t
+);
+
+	@ppp-comp.h
+
+38 #ide
+_NET_PPP_COMP_H_
+
+
+39 
+	#_NET_PPP_COMP_H_
+
+
+	)
+
+45 #ide
+DO_BSD_COMPRESS
+
+
+46 
+	#DO_BSD_COMPRESS
+ 1
+
+	)
+
+48 #ide
+DO_DEFLATE
+
+
+49 
+	#DO_DEFLATE
+ 1
+
+	)
+
+51 
+	#DO_PREDICTOR_1
+ 0
+
+	)
+
+52 
+	#DO_PREDICTOR_2
+ 0
+
+	)
+
+57 #ide
+PPP_COMPRESSORS_MAX
+
+
+58 
+	#PPP_COMPRESSORS_MAX
+ 8
+
+	)
+
+64 #ifde
+PACKETPTR
+
+
+65 
+	~<sys/queue.h
+>
+
+67 
+	scomess
+ {
+
+68 
+	mcomess_o
+;
+
+71 *(*
+	mcomp_loc
+)(
+	mu_ch
+ *, );
+
+73 (*
+	mcomp_
+)(*);
+
+75 (*
+	mcomp_
+)(*, 
+	mu_ch
+ *, , , , );
+
+77 (*
+	mcomp_t
+)(*);
+
+79 (*
+	mcomess
+)(*, 
+	mPACKETPTR
+ *, PACKETPTR, , );
+
+81 (*
+	mcomp_
+)(*, 
+	mcomp
+ *);
+
+84 *(*
+	mdecomp_loc
+)(
+	mu_ch
+ *, );
+
+86 (*
+	mdecomp_
+)(*);
+
+88 (*
+	mdecomp_
+)(*, 
+	mu_ch
+ *, , , , , );
+
+90 (*
+	mdecomp_t
+)(*);
+
+92 (*
+	mdecomess
+)(*, 
+	mPACKETPTR
+, PACKETPTR *);
+
+94 (*
+	mcomp
+)(*, 
+	mPACKETPTR
+);
+
+96 (*
+	mdecomp_
+)(*, 
+	mcomp
+ *);
+
+98 
+LIST_ENTRY
+(
+comess
+
+	mcomp_li
+;
+
+99 
+	mcomp_ft
+;
+
+111 
+	#DECOMP_OK
+ 0
+
+	)
+
+112 
+	#DECOMP_ERROR
+ 1
+
+	)
+
+113 
+	#DECOMP_FATALERROR
+ 2
+
+	)
+
+118 
+	#CCP_CONFREQ
+ 1
+
+	)
+
+119 
+	#CCP_CONFACK
+ 2
+
+	)
+
+120 
+	#CCP_CONFNAK
+ 3
+
+	)
+
+121 
+	#CCP_CONFREJ
+ 4
+
+	)
+
+122 
+	#CCP_TERMREQ
+ 5
+
+	)
+
+123 
+	#CCP_TERMACK
+ 6
+
+	)
+
+124 
+	#CCP_RESETREQ
+ 14
+
+	)
+
+125 
+	#CCP_RESETACK
+ 15
+
+	)
+
+130 
+	#CCP_MAX_OPTION_LENGTH
+ 64
+
+	)
+
+135 
+	#CCP_CODE
+(
+dp
+((dp)[0])
+
+	)
+
+136 
+	#CCP_ID
+(
+dp
+((dp)[1])
+
+	)
+
+137 
+	#CCP_LENGTH
+(
+dp
+(((dp)[2] << 8+ (dp)[3])
+
+	)
+
+138 
+	#CCP_HDRLEN
+ 4
+
+	)
+
+140 
+	#CCP_OPT_CODE
+(
+dp
+((dp)[0])
+
+	)
+
+141 
+	#CCP_OPT_LENGTH
+(
+dp
+((dp)[1])
+
+	)
+
+142 
+	#CCP_OPT_MINLEN
+ 2
+
+	)
+
+147 
+	#CI_BSD_COMPRESS
+ 21
+
+	)
+
+148 
+	#CILEN_BSD_COMPRESS
+ 3
+
+	)
+
+151 
+	#BSD_NBITS
+(
+x
+((x& 0x1F
+
+	)
+
+152 
+	#BSD_VERSION
+(
+x
+((x>> 5
+
+	)
+
+153 
+	#BSD_CURRENT_VERSION
+ 1
+
+	)
+
+154 
+	#BSD_MAKE_OPT
+(
+v
+, 
+n
+(((v<< 5| (n))
+
+	)
+
+156 
+	#BSD_MIN_BITS
+ 9
+
+	)
+
+157 
+	#BSD_MAX_BITS
+ 15
+
+	)
+
+162 
+	#CI_DEFLATE
+ 26
+
+	)
+
+163 
+	#CI_DEFLATE_DRAFT
+ 24
+
+	)
+
+165 
+	#CILEN_DEFLATE
+ 4
+
+	)
+
+167 
+	#DEFLATE_MIN_SIZE
+ 8
+
+	)
+
+168 
+	#DEFLATE_MAX_SIZE
+ 15
+
+	)
+
+169 
+	#DEFLATE_METHOD_VAL
+ 8
+
+	)
+
+170 
+	#DEFLATE_SIZE
+(
+x
+(((x>> 4+ 
+DEFLATE_MIN_SIZE
+)
+
+	)
+
+171 
+	#DEFLATE_METHOD
+(
+x
+((x& 0x0F)
+
+	)
+
+172 
+	#DEFLATE_MAKE_OPT
+(
+w
+((((w- 
+DEFLATE_MIN_SIZE
+) << 4) \
+
+173 + 
+DEFLATE_METHOD_VAL
+)
+
+	)
+
+174 
+	#DEFLATE_CHK_SEQUENCE
+ 0
+
+	)
+
+179 
+	#CI_MPPE
+ 18
+
+	)
+
+180 
+	#CILEN_MPPE
+ 6
+
+	)
+
+182 
+	#MPPE_PAD
+ 4
+
+	)
+
+183 
+	#MPPE_MAX_KEY_LEN
+ 16
+
+	)
+
+186 
+	#MPPE_OPT_40
+ 0x01
+
+	)
+
+187 
+	#MPPE_OPT_128
+ 0x02
+
+	)
+
+188 
+	#MPPE_OPT_STATEFUL
+ 0x04
+
+	)
+
+190 
+	#MPPE_OPT_56
+ 0x08
+
+	)
+
+191 
+	#MPPE_OPT_MPPC
+ 0x10
+
+	)
+
+192 
+	#MPPE_OPT_D
+ 0x20
+
+	)
+
+193 
+	#MPPE_OPT_UNSUPPORTED
+ (
+MPPE_OPT_56
+|
+MPPE_OPT_MPPC
+|
+MPPE_OPT_D
+)
+
+	)
+
+194 
+	#MPPE_OPT_UNKNOWN
+ 0x40
+
+	)
+
+203 
+	#MPPE_C_BIT
+ 0x01
+
+	)
+
+204 
+	#MPPE_D_BIT
+ 0x10
+
+	)
+
+205 
+	#MPPE_L_BIT
+ 0x20
+
+	)
+
+206 
+	#MPPE_S_BIT
+ 0x40
+
+	)
+
+207 
+	#MPPE_M_BIT
+ 0x80
+
+	)
+
+208 
+	#MPPE_H_BIT
+ 0x01
+
+	)
+
+211 
+	#MPPE_ALL_BITS
+ (
+MPPE_D_BIT
+|
+MPPE_L_BIT
+|
+MPPE_S_BIT
+|
+MPPE_M_BIT
+|
+MPPE_H_BIT
+)
+
+	)
+
+214 
+	#MPPE_OPTS_TO_CI
+(
+ts
+, 
+ci
+) \
+
+216 
+u_ch
+ *
+r
+ = 
+ci
+; \
+
+219 i(
+ts
+ & 
+MPPE_OPT_STATEFUL
+) \
+
+220 *
+r
+++ = 0x0; \
+
+222 *
+r
+++ = 
+MPPE_H_BIT
+; \
+
+223 *
+r
+++ = 0; \
+
+224 *
+r
+++ = 0; \
+
+227 *
+r
+ = 0; \
+
+228 i(
+ts
+ & 
+MPPE_OPT_128
+) \
+
+229 *
+r
+ |
+MPPE_S_BIT
+; \
+
+230 i(
+ts
+ & 
+MPPE_OPT_40
+) \
+
+231 *
+r
+ |
+MPPE_L_BIT
+; \
+
+233 }  0)
+
+	)
+
+236 
+	#MPPE_CI_TO_OPTS
+(
+ci
+, 
+ts
+) \
+
+238 
+u_ch
+ *
+r
+ = 
+ci
+; \
+
+240 
+ts
+ = 0; \
+
+243 i(!(
+r
+[0] & 
+MPPE_H_BIT
+)) \
+
+244 
+ts
+ |
+MPPE_OPT_STATEFUL
+; \
+
+247 i(
+r
+[3] & 
+MPPE_S_BIT
+) \
+
+248 
+ts
+ |
+MPPE_OPT_128
+; \
+
+249 i(
+r
+[3] & 
+MPPE_L_BIT
+) \
+
+250 
+ts
+ |
+MPPE_OPT_40
+; \
+
+253 i(
+r
+[3] & 
+MPPE_M_BIT
+) \
+
+254 
+ts
+ |
+MPPE_OPT_56
+; \
+
+255 i(
+r
+[3] & 
+MPPE_D_BIT
+) \
+
+256 
+ts
+ |
+MPPE_OPT_D
+; \
+
+257 i(
+r
+[3] & 
+MPPE_C_BIT
+) \
+
+258 
+ts
+ |
+MPPE_OPT_MPPC
+; \
+
+261 i(
+r
+[0] & ~
+MPPE_H_BIT
+) \
+
+262 
+ts
+ |
+MPPE_OPT_UNKNOWN
+; \
+
+263 i(
+r
+[1] ||tr[2]) \
+
+264 
+ts
+ |
+MPPE_OPT_UNKNOWN
+; \
+
+265 i(
+r
+[3] & ~
+MPPE_ALL_BITS
+) \
+
+266 
+ts
+ |
+MPPE_OPT_UNKNOWN
+; \
+
+267 }  0)
+
+	)
+
+272 
+	#CI_PREDICTOR_1
+ 1
+
+	)
+
+273 
+	#CILEN_PREDICTOR_1
+ 2
+
+	)
+
+274 
+	#CI_PREDICTOR_2
+ 2
+
+	)
+
+275 
+	#CILEN_PREDICTOR_2
+ 2
+
+	)
+
+	@ppp-deflate.c
+
+41 
+	~<sys/cdefs.h
+>
+
+42 
+__KERNEL_RCSID
+(0, "$NetBSD:pp-deflate.c,v 1.20 2008/12/17 20:51:37 cegger Exp $");
+
+44 
+	~<sys/m.h
+>
+
+45 
+	~<sys/sym.h
+>
+
+46 
+	~<sys/mbuf.h
+>
+
+47 
+	~<sys/modu.h
+>
+
+48 
+	~<t/if.h
+>
+
+49 
+	~<t/p_defs.h
+>
+
+50 
+	~<t/if_p.h
+>
+
+51 
+	~<t/zlib.h
+>
+
+53 
+	#PACKETPTR
+ 
+mbuf
+ *
+
+	)
+
+54 
+	~<t/p-comp.h
+>
+
+56 #i
+DO_DEFLATE
+
+
+58 
+	#DEFLATE_DEBUG
+ 1
+
+	)
+
+63 
+	sdee_e
+ {
+
+64 
+	mqno
+;
+
+65 
+	mw_size
+;
+
+66 
+	mun
+;
+
+67 
+	mhd
+;
+
+68 
+	mmru
+;
+
+69 
+	mdebug
+;
+
+70 
+z_am
+ 
+	mrm
+;
+
+71 
+comp
+ 
+	ms
+;
+
+74 
+	#DEFLATE_OVHD
+ 2
+
+	)
+
+76 *
+zloc
+(*, 
+u_t
+ 
+ems
+, u_
+size
+);
+
+77 
+z
+(*, *
+r
+);
+
+78 *
+z_comp_loc
+(
+u_ch
+ *
+tis
+, 
+t_n
+);
+
+79 *
+z_decomp_loc
+(
+u_ch
+ *
+tis
+, 
+t_n
+);
+
+80 
+z_comp_
+(*
+e
+);
+
+81 
+z_decomp_
+(*
+e
+);
+
+82 
+z_comp_
+(*
+e
+, 
+u_ch
+ *
+tis
+, 
+t_n
+,
+
+83 
+un
+, 
+hd
+, 
+debug
+);
+
+84 
+z_decomp_
+(*
+e
+, 
+u_ch
+ *
+tis
+, 
+t_n
+,
+
+85 
+un
+, 
+hd
+, 
+mru
+, 
+debug
+);
+
+86 
+z_comess
+(*
+e
+, 
+mbuf
+ **
+mt
+,
+
+87 
+mbuf
+ *
+mp
+, 
+
+, 
+max
+);
+
+88 
+z_comp
+(*
+e
+, 
+mbuf
+ *
+dmsg
+);
+
+89 
+z_decomess
+(*
+e
+, 
+mbuf
+ *
+cmp
+,
+
+90 
+mbuf
+ **
+dm
+);
+
+91 
+z_comp_t
+(*
+e
+);
+
+92 
+z_decomp_t
+(*
+e
+);
+
+93 
+z_comp_s
+(*
+e
+, 
+comp
+ *
+s
+);
+
+98 
+comess
+ 
+	gp_dee
+[2] = { {
+
+99 .
+comess_o
+ = 
+CI_DEFLATE
+,
+
+100 .
+	gcomp_loc
+ = 
+z_comp_loc
+,
+
+101 .
+	gcomp_
+ = 
+z_comp_
+,
+
+102 .
+	gcomp_
+ = 
+z_comp_
+,
+
+103 .
+	gcomp_t
+ = 
+z_comp_t
+,
+
+104 .
+	gcomess
+ = 
+z_comess
+,
+
+105 .
+	gcomp_
+ = 
+z_comp_s
+,
+
+106 .
+	gdecomp_loc
+ = 
+z_decomp_loc
+,
+
+107 .
+	gdecomp_
+ = 
+z_decomp_
+,
+
+108 .
+	gdecomp_
+ = 
+z_decomp_
+,
+
+109 .
+	gdecomp_t
+ = 
+z_decomp_t
+,
+
+110 .
+	gdecomess
+ = 
+z_decomess
+,
+
+111 .
+	gcomp
+ = 
+z_comp
+,
+
+112 .
+	gdecomp_
+ = 
+z_comp_s
+,
+
+115 .
+	gcomess_o
+ = 
+CI_DEFLATE_DRAFT
+,
+
+116 .
+	gcomp_loc
+ = 
+z_comp_loc
+,
+
+117 .
+	gcomp_
+ = 
+z_comp_
+,
+
+118 .
+	gcomp_
+ = 
+z_comp_
+,
+
+119 .
+	gcomp_t
+ = 
+z_comp_t
+,
+
+120 .
+	gcomess
+ = 
+z_comess
+,
+
+121 .
+	gcomp_
+ = 
+z_comp_s
+,
+
+122 .
+	gdecomp_loc
+ = 
+z_decomp_loc
+,
+
+123 .
+	gdecomp_
+ = 
+z_decomp_
+,
+
+124 .
+	gdecomp_
+ = 
+z_decomp_
+,
+
+125 .
+	gdecomp_t
+ = 
+z_decomp_t
+,
+
+126 .
+	gdecomess
+ = 
+z_decomess
+,
+
+127 .
+	gcomp
+ = 
+z_comp
+,
+
+128 .
+	gdecomp_
+ = 
+z_comp_s
+,
+
+134 
+	$zloc
+(*
+nud
+, 
+u_t
+ 
+ems
+, u_
+size
+)
+
+136 *
+r
+;
+
+138 
+r
+ = 
+	`mloc
+(
+ems
+ * 
+size
+, 
+M_DEVBUF
+, 
+M_NOWAIT
+);
+
+139  
+r
+;
+
+140 
+	}
+}
+
+143 
+	$z
+(*
+nud
+, *
+r
+)
+
+145 
+	`
+(
+r
+, 
+M_DEVBUF
+);
+
+146 
+	}
+}
+
+152 
+	$z_comp_loc
+(
+u_ch
+ *
+tis
+, 
+t_n
+)
+
+154 
+dee_e
+ *
+e
+;
+
+155 
+w_size
+;
+
+157 i(
+t_n
+ !
+CILEN_DEFLATE
+
+
+158 || (
+tis
+[0] !
+CI_DEFLATE
+ && ois[0] !
+CI_DEFLATE_DRAFT
+)
+
+159 || 
+tis
+[1] !
+CILEN_DEFLATE
+
+
+160 || 
+	`DEFLATE_METHOD
+(
+tis
+[2]!
+DEFLATE_METHOD_VAL
+
+
+161 || 
+tis
+[3] !
+DEFLATE_CHK_SEQUENCE
+)
+
+162  
+NULL
+;
+
+163 
+w_size
+ = 
+	`DEFLATE_SIZE
+(
+tis
+[2]);
+
+164 i(
+w_size
+ < 
+DEFLATE_MIN_SIZE
+ || w_siz> 
+DEFLATE_MAX_SIZE
+)
+
+165  
+NULL
+;
+
+167 
+e
+ = 
+	`mloc
+((
+dee_e
+), 
+M_DEVBUF
+, 
+M_NOWAIT
+);
+
+168 i(
+e
+ =
+NULL
+)
+
+169  
+NULL
+;
+
+171 
+e
+->
+rm
+.
+xt_
+ = 
+NULL
+;
+
+172 
+e
+->
+rm
+.
+zloc
+ = zalloc;
+
+173 
+e
+->
+rm
+.
+z
+ = zfree;
+
+174 i(
+	`deeIn2
+(&
+e
+->
+rm
+, 
+Z_DEFAULT_COMPRESSION
+, 
+DEFLATE_METHOD_VAL
+,
+
+175 -
+w_size
+, 8, 
+Z_DEFAULT_STRATEGY
+!
+Z_OK
+) {
+
+176 
+	`
+(
+e
+, 
+M_DEVBUF
+);
+
+177  
+NULL
+;
+
+180 
+e
+->
+w_size
+ = w_size;
+
+181 
+	`memt
+(&
+e
+->
+s
+, 0, (state->stats));
+
+182  (*
+e
+;
+
+183 
+	}
+}
+
+186 
+	$z_comp_
+(*
+g
+)
+
+188 
+dee_e
+ *
+e
+ = (dee_*
+g
+;
+
+190 
+	`deeEnd
+(&
+e
+->
+rm
+);
+
+191 
+	`
+(
+e
+, 
+M_DEVBUF
+);
+
+192 
+	}
+}
+
+195 
+	$z_comp_
+(*
+g
+, 
+u_ch
+ *
+tis
+, 
+t_n
+, 
+un
+, 
+hd
+,
+
+196 
+debug
+)
+
+198 
+dee_e
+ *
+e
+ = (dee_*
+g
+;
+
+200 i(
+t_n
+ < 
+CILEN_DEFLATE
+
+
+201 || (
+tis
+[0] !
+CI_DEFLATE
+ && ois[0] !
+CI_DEFLATE_DRAFT
+)
+
+202 || 
+tis
+[1] !
+CILEN_DEFLATE
+
+
+203 || 
+	`DEFLATE_METHOD
+(
+tis
+[2]!
+DEFLATE_METHOD_VAL
+
+
+204 || 
+	`DEFLATE_SIZE
+(
+tis
+[2]!
+e
+->
+w_size
+
+
+205 || 
+tis
+[3] !
+DEFLATE_CHK_SEQUENCE
+)
+
+208 
+e
+->
+qno
+ = 0;
+
+209 
+e
+->
+un
+ = unit;
+
+210 
+e
+->
+hd
+ = hdrlen;
+
+211 
+e
+->
+debug
+ = debug;
+
+213 
+	`deeRet
+(&
+e
+->
+rm
+);
+
+216 
+	}
+}
+
+219 
+	$z_comp_t
+(*
+g
+)
+
+221 
+dee_e
+ *
+e
+ = (dee_*
+g
+;
+
+223 
+e
+->
+qno
+ = 0;
+
+224 
+	`deeRet
+(&
+e
+->
+rm
+);
+
+225 
+	}
+}
+
+228 
+	$z_comess
+(*
+g
+,
+
+229 
+mbuf
+ **
+mt
+ ,
+
+230 
+mbuf
+ *
+mp
+ ,
+
+231 
+ig_n
+, 
+max
+)
+
+233 
+dee_e
+ *
+e
+ = (dee_*
+g
+;
+
+234 
+u_ch
+ *
+
+, *
+wr
+;
+
+235 
+o
+, 
+
+, 
+wa
+, 
+r
+, 
+ush
+;
+
+236 
+mbuf
+ *
+m
+;
+
+241 
+
+ = 
+	`mtod
+(
+mp
+, 
+u_ch
+ *);
+
+242 
+o
+ = 
+	`PPP_PROTOCOL
+(
+
+);
+
+243 i(
+o
+ > 0x3fff ||roto == 0xfd ||roto == 0xfb) {
+
+244 *
+mt
+ = 
+NULL
+;
+
+245  
+ig_n
+;
+
+249 i(
+max
+ > 
+ig_n
+)
+
+250 
+max
+ = 
+ig_n
+;
+
+251 
+	`MGET
+(
+m
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+252 *
+mt
+ = 
+m
+;
+
+253 i(
+m
+ !
+NULL
+) {
+
+254 
+m
+->
+m_n
+ = 0;
+
+255 i(
+max
+ + 
+e
+->
+hd
+ > 
+MLEN
+)
+
+256 
+	`MCLGET
+(
+m
+, 
+M_DONTWAIT
+);
+
+257 
+wa
+ = 
+	`M_TRAILINGSPACE
+(
+m
+);
+
+258 i(
+e
+->
+hd
+ + 
+PPP_HDRLEN
+ + 2 < 
+wa
+) {
+
+259 
+m
+->
+m_da
+ +
+e
+->
+hd
+;
+
+260 
+wa
+ -
+e
+->
+hd
+;
+
+262 
+wr
+ = 
+	`mtod
+(
+m
+, 
+u_ch
+ *);
+
+267 
+wr
+[0] = 
+	`PPP_ADDRESS
+(
+
+);
+
+268 
+wr
+[1] = 
+	`PPP_CONTROL
+(
+
+);
+
+269 
+wr
+[2] = 
+PPP_COMP
+ >> 8;
+
+270 
+wr
+[3] = 
+PPP_COMP
+;
+
+271 
+wr
+ +
+PPP_HDRLEN
+;
+
+272 
+wr
+[0] = 
+e
+->
+qno
+ >> 8;
+
+273 
+wr
+[1] = 
+e
+->
+qno
+;
+
+274 
+wr
+ += 2;
+
+275 
+e
+->
+rm
+.
+xt_out
+ = 
+wr
+;
+
+276 
+e
+->
+rm
+.
+ava_out
+ = 
+wa
+ - (
+PPP_HDRLEN
+ + 2);
+
+278 
+e
+->
+rm
+.
+xt_out
+ = 
+NULL
+;
+
+279 
+e
+->
+rm
+.
+ava_out
+ = 1000000;
+
+280 
+wr
+ = 
+NULL
+;
+
+281 
+wa
+ = 0;
+
+283 ++
+e
+->
+qno
+;
+
+285 
+
+ +(
+o
+ > 0xff)? 2: 3;
+
+286 
+e
+->
+rm
+.
+xt_
+ = 
+
+;
+
+287 
+e
+->
+rm
+.
+ava_
+ = 
+	`mtod
+(
+mp
+, 
+u_ch
+ *+ mp->
+m_n
+ - 
+
+;
+
+288 
+mp
+ = mp->
+m_xt
+;
+
+289 
+ush
+ = (
+mp
+ =
+NULL
+)? 
+Z_PACKET_FLUSH
+: 
+Z_NO_FLUSH
+;
+
+290 
+
+ = 0;
+
+292 
+r
+ = 
+	`dee
+(&
+e
+->
+rm
+, 
+ush
+);
+
+293 i(
+r
+ !
+Z_OK
+) {
+
+294 
+	`tf
+("z_compress: deflateeturned %d (%s)\n",
+
+295 
+r
+, (
+e
+->
+rm
+.
+msg
+? state->strm.msg: ""));
+
+298 i(
+ush
+ !
+Z_NO_FLUSH
+ && 
+e
+->
+rm
+.
+ava_out
+ != 0)
+
+300 i(
+e
+->
+rm
+.
+ava_
+ =0 && 
+mp
+ !
+NULL
+) {
+
+301 
+e
+->
+rm
+.
+xt_
+ = 
+	`mtod
+(
+mp
+, 
+u_ch
+ *);
+
+302 
+e
+->
+rm
+.
+ava_
+ = 
+mp
+->
+m_n
+;
+
+303 
+mp
+ = mp->
+m_xt
+;
+
+304 i(
+mp
+ =
+NULL
+)
+
+305 
+ush
+ = 
+Z_PACKET_FLUSH
+;
+
+307 i(
+e
+->
+rm
+.
+ava_out
+ == 0) {
+
+308 i(
+m
+ !
+NULL
+) {
+
+309 
+m
+->
+m_n
+ = 
+wa
+;
+
+310 
+
+ +
+wa
+;
+
+311 
+	`MGET
+(
+m
+->
+m_xt
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+312 
+m
+ = m->
+m_xt
+;
+
+313 i(
+m
+ !
+NULL
+) {
+
+314 
+m
+->
+m_n
+ = 0;
+
+315 i(
+max
+ - 
+
+ > 
+MLEN
+)
+
+316 
+	`MCLGET
+(
+m
+, 
+M_DONTWAIT
+);
+
+317 
+e
+->
+rm
+.
+xt_out
+ = 
+	`mtod
+(
+m
+, 
+u_ch
+ *);
+
+318 
+e
+->
+rm
+.
+ava_out
+ = 
+wa
+ = 
+	`M_TRAILINGSPACE
+(
+m
+);
+
+321 i(
+m
+ =
+NULL
+) {
+
+322 
+e
+->
+rm
+.
+xt_out
+ = 
+NULL
+;
+
+323 
+e
+->
+rm
+.
+ava_out
+ = 1000000;
+
+327 i(
+m
+ !
+NULL
+)
+
+328 
+
+ +(
+m
+->
+m_n
+ = 
+wa
+ - 
+e
+->
+rm
+.
+ava_out
+);
+
+333 i(
+m
+ !
+NULL
+ && 
+
+ < 
+ig_n
+) {
+
+334 
+e
+->
+s
+.
+comp_bys
+ +
+
+;
+
+335 
+e
+->
+s
+.
+comp_cks
+++;
+
+337 i(*
+mt
+ !
+NULL
+) {
+
+338 
+	`m_m
+(*
+mt
+);
+
+339 *
+mt
+ = 
+NULL
+;
+
+341 
+e
+->
+s
+.
+c_bys
+ +
+ig_n
+;
+
+342 
+e
+->
+s
+.
+c_cks
+++;
+
+343 
+
+ = 
+ig_n
+;
+
+345 
+e
+->
+s
+.
+unc_bys
+ +
+ig_n
+;
+
+346 
+e
+->
+s
+.
+unc_cks
+++;
+
+348  
+
+;
+
+349 
+	}
+}
+
+352 
+	$z_comp_s
+(*
+g
+, 
+comp
+ *
+s
+)
+
+354 
+dee_e
+ *
+e
+ = (dee_*
+g
+;
+
+355 
+u_t
+ 
+out
+;
+
+357 *
+s
+ = 
+e
+->stats;
+
+358 
+s
+->
+tio
+ = sts->
+unc_bys
+;
+
+359 
+out
+ = 
+s
+->
+comp_bys
+ + sts->
+c_bys
+;
+
+360 i(
+s
+->
+tio
+ <= 0x7ffffff)
+
+361 
+s
+->
+tio
+ <<= 8;
+
+363 
+out
+ >>= 8;
+
+364 i(
+out
+ != 0)
+
+365 
+s
+->
+tio
+ /
+out
+;
+
+366 
+	}
+}
+
+372 
+	$z_decomp_loc
+(
+u_ch
+ *
+tis
+, 
+t_n
+)
+
+374 
+dee_e
+ *
+e
+;
+
+375 
+w_size
+;
+
+377 i(
+t_n
+ !
+CILEN_DEFLATE
+
+
+378 || (
+tis
+[0] !
+CI_DEFLATE
+ && ois[0] !
+CI_DEFLATE_DRAFT
+)
+
+379 || 
+tis
+[1] !
+CILEN_DEFLATE
+
+
+380 || 
+	`DEFLATE_METHOD
+(
+tis
+[2]!
+DEFLATE_METHOD_VAL
+
+
+381 || 
+tis
+[3] !
+DEFLATE_CHK_SEQUENCE
+)
+
+382  
+NULL
+;
+
+383 
+w_size
+ = 
+	`DEFLATE_SIZE
+(
+tis
+[2]);
+
+384 i(
+w_size
+ < 
+DEFLATE_MIN_SIZE
+ || w_siz> 
+DEFLATE_MAX_SIZE
+)
+
+385  
+NULL
+;
+
+387 
+e
+ = 
+	`mloc
+((
+dee_e
+), 
+M_DEVBUF
+, 
+M_NOWAIT
+);
+
+388 i(
+e
+ =
+NULL
+)
+
+389  
+NULL
+;
+
+391 
+e
+->
+rm
+.
+xt_out
+ = 
+NULL
+;
+
+392 
+e
+->
+rm
+.
+zloc
+ = zalloc;
+
+393 
+e
+->
+rm
+.
+z
+ = zfree;
+
+394 i(
+	`eIn2
+(&
+e
+->
+rm
+, -
+w_size
+!
+Z_OK
+) {
+
+395 
+	`
+(
+e
+, 
+M_DEVBUF
+);
+
+396  
+NULL
+;
+
+399 
+e
+->
+w_size
+ = w_size;
+
+400 
+	`memt
+(&
+e
+->
+s
+, 0, (state->stats));
+
+401  (*
+e
+;
+
+402 
+	}
+}
+
+405 
+	$z_decomp_
+(*
+g
+)
+
+407 
+dee_e
+ *
+e
+ = (dee_*
+g
+;
+
+409 
+	`eEnd
+(&
+e
+->
+rm
+);
+
+410 
+	`
+(
+e
+, 
+M_DEVBUF
+);
+
+411 
+	}
+}
+
+414 
+	$z_decomp_
+(*
+g
+, 
+u_ch
+ *
+tis
+, 
+t_n
+, 
+un
+, 
+hd
+,
+
+415 
+mru
+, 
+debug
+)
+
+417 
+dee_e
+ *
+e
+ = (dee_*
+g
+;
+
+419 i(
+t_n
+ < 
+CILEN_DEFLATE
+
+
+420 || (
+tis
+[0] !
+CI_DEFLATE
+ && ois[0] !
+CI_DEFLATE_DRAFT
+)
+
+421 || 
+tis
+[1] !
+CILEN_DEFLATE
+
+
+422 || 
+	`DEFLATE_METHOD
+(
+tis
+[2]!
+DEFLATE_METHOD_VAL
+
+
+423 || 
+	`DEFLATE_SIZE
+(
+tis
+[2]!
+e
+->
+w_size
+
+
+424 || 
+tis
+[3] !
+DEFLATE_CHK_SEQUENCE
+)
+
+427 
+e
+->
+qno
+ = 0;
+
+428 
+e
+->
+un
+ = unit;
+
+429 
+e
+->
+hd
+ = hdrlen;
+
+430 
+e
+->
+debug
+ = debug;
+
+431 
+e
+->
+mru
+ = mru;
+
+433 
+	`eRet
+(&
+e
+->
+rm
+);
+
+436 
+	}
+}
+
+439 
+	$z_decomp_t
+(*
+g
+)
+
+441 
+dee_e
+ *
+e
+ = (dee_*
+g
+;
+
+443 
+e
+->
+qno
+ = 0;
+
+444 
+	`eRet
+(&
+e
+->
+rm
+);
+
+445 
+	}
+}
+
+464 
+	$z_decomess
+(*
+g
+, 
+mbuf
+ *
+mi
+, mbu**
+m
+)
+
+466 
+dee_e
+ *
+e
+ = (dee_*
+g
+;
+
+467 
+mbuf
+ *
+mo
+, *
+mo_hd
+;
+
+468 
+u_ch
+ *
+
+, *
+wr
+;
+
+469 
+
+, 
+
+, 
+oa
+;
+
+470 
+q
+, 
+i
+, 
+ush
+, 
+r
+, 
+decode_o
+;
+
+471 
+u_ch
+ 
+hdr
+[
+PPP_HDRLEN
+ + 
+DEFLATE_OVHD
+];
+
+473 *
+m
+ = 
+NULL
+;
+
+474 
+
+ = 
+	`mtod
+(
+mi
+, 
+u_ch
+ *);
+
+475 
+
+ = 
+mi
+->
+m_n
+;
+
+476 
+i
+ = 0; i < 
+PPP_HDRLEN
+ + 
+DEFLATE_OVHD
+; ++i) {
+
+477 
+
+ <= 0) {
+
+478 
+mi
+ = mi->
+m_xt
+;
+
+479 i(
+mi
+ =
+NULL
+)
+
+480  
+DECOMP_ERROR
+;
+
+481 
+
+ = 
+	`mtod
+(
+mi
+, 
+u_ch
+ *);
+
+482 
+
+ = 
+mi
+->
+m_n
+;
+
+484 
+hdr
+[
+i
+] = *
+
+++;
+
+485 --
+
+;
+
+489 
+q
+ = (
+hdr
+[
+PPP_HDRLEN
+] << 8) + hdr[PPP_HDRLEN+1];
+
+490 i(
+q
+ !
+e
+->
+qno
+) {
+
+491 i(
+e
+->
+debug
+)
+
+492 
+	`tf
+("z_decompress%d: bad seq # %d,xpected %d\n",
+
+493 
+e
+->
+un
+, 
+q
+, s->
+qno
+);
+
+494  
+DECOMP_ERROR
+;
+
+496 ++
+e
+->
+qno
+;
+
+499 
+	`MGETHDR
+(
+mo
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+500 i(
+mo
+ =
+NULL
+)
+
+501  
+DECOMP_ERROR
+;
+
+502 
+mo_hd
+ = 
+mo
+;
+
+503 
+mo
+->
+m_n
+ = 0;
+
+504 
+mo
+->
+m_xt
+ = 
+NULL
+;
+
+505 
+	`MCLGET
+(
+mo
+, 
+M_DONTWAIT
+);
+
+506 
+oa
+ = 
+	`M_TRAILINGSPACE
+(
+mo
+);
+
+507 i(
+e
+->
+hd
+ + 
+PPP_HDRLEN
+ < 
+oa
+) {
+
+508 
+mo
+->
+m_da
+ +
+e
+->
+hd
+;
+
+509 
+oa
+ -
+e
+->
+hd
+;
+
+516 
+wr
+ = 
+	`mtod
+(
+mo
+, 
+u_ch
+ *);
+
+517 
+wr
+[0] = 
+	`PPP_ADDRESS
+(
+hdr
+);
+
+518 
+wr
+[1] = 
+	`PPP_CONTROL
+(
+hdr
+);
+
+519 
+wr
+[2] = 0;
+
+526 
+e
+->
+rm
+.
+xt_
+ = 
+
+;
+
+527 
+e
+->
+rm
+.
+ava_
+ = 
+
+;
+
+528 
+mi
+ = mi->
+m_xt
+;
+
+529 
+ush
+ = (
+mi
+ =
+NULL
+)? 
+Z_PACKET_FLUSH
+: 
+Z_NO_FLUSH
+;
+
+530 
+
+ +
+PPP_HDRLEN
+ + 
+DEFLATE_OVHD
+;
+
+531 
+e
+->
+rm
+.
+xt_out
+ = 
+wr
+ + 3;
+
+532 
+e
+->
+rm
+.
+ava_out
+ = 1;
+
+533 
+decode_o
+ = 1;
+
+534 
+
+ = 0;
+
+540 
+r
+ = 
+	`e
+(&
+e
+->
+rm
+, 
+ush
+);
+
+541 i(
+r
+ !
+Z_OK
+) {
+
+542 #i!
+DEFLATE_DEBUG
+
+
+543 i(
+e
+->
+debug
+)
+
+545 
+	`tf
+("z_decompress%d: inflateeturned %d (%s)\n",
+
+546 
+e
+->
+un
+, 
+r
+, (e->
+rm
+.
+msg
+? state->strm.msg: ""));
+
+547 
+	`m_m
+(
+mo_hd
+);
+
+548  
+DECOMP_FATALERROR
+;
+
+550 i(
+ush
+ !
+Z_NO_FLUSH
+ && 
+e
+->
+rm
+.
+ava_out
+ != 0)
+
+552 i(
+e
+->
+rm
+.
+ava_
+ =0 && 
+mi
+ !
+NULL
+) {
+
+553 
+e
+->
+rm
+.
+xt_
+ = 
+	`mtod
+(
+mi
+, 
+u_ch
+ *);
+
+554 
+e
+->
+rm
+.
+ava_
+ = 
+mi
+->
+m_n
+;
+
+555 
+
+ +
+mi
+->
+m_n
+;
+
+556 
+mi
+ = mi->
+m_xt
+;
+
+557 i(
+mi
+ =
+NULL
+)
+
+558 
+ush
+ = 
+Z_PACKET_FLUSH
+;
+
+560 i(
+e
+->
+rm
+.
+ava_out
+ == 0) {
+
+561 i(
+decode_o
+) {
+
+562 
+e
+->
+rm
+.
+ava_out
+ = 
+oa
+ - 
+PPP_HDRLEN
+;
+
+563 i((
+wr
+[3] & 1) == 0) {
+
+565 
+wr
+[2] = wptr[3];
+
+566 --
+e
+->
+rm
+.
+xt_out
+;
+
+567 ++
+e
+->
+rm
+.
+ava_out
+;
+
+568 --
+
+;
+
+570 
+decode_o
+ = 0;
+
+572 
+mo
+->
+m_n
+ = 
+oa
+;
+
+573 
+
+ +
+oa
+;
+
+574 
+	`MGET
+(
+mo
+->
+m_xt
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+575 
+mo
+ = mo->
+m_xt
+;
+
+576 i(
+mo
+ =
+NULL
+) {
+
+577 
+	`m_m
+(
+mo_hd
+);
+
+578  
+DECOMP_ERROR
+;
+
+580 
+	`MCLGET
+(
+mo
+, 
+M_DONTWAIT
+);
+
+581 
+e
+->
+rm
+.
+xt_out
+ = 
+	`mtod
+(
+mo
+, 
+u_ch
+ *);
+
+582 
+e
+->
+rm
+.
+ava_out
+ = 
+oa
+ = 
+	`M_TRAILINGSPACE
+(
+mo
+);
+
+586 i(
+decode_o
+) {
+
+587 
+	`m_m
+(
+mo_hd
+);
+
+588  
+DECOMP_ERROR
+;
+
+590 
+
+ +(
+mo
+->
+m_n
+ = 
+oa
+ - 
+e
+->
+rm
+.
+ava_out
+);
+
+591 #i
+DEFLATE_DEBUG
+
+
+592 i(
+
+ > 
+e
+->
+mru
+ + 
+PPP_HDRLEN
+)
+
+593 
+	`tf
+("ppp_deflate%d:xceeded mru (%d > %d)\n",
+
+594 
+e
+->
+un
+, 
+
+, s->
+mru
+ + 
+PPP_HDRLEN
+);
+
+597 
+e
+->
+s
+.
+unc_bys
+ +
+
+;
+
+598 
+e
+->
+s
+.
+unc_cks
+++;
+
+599 
+e
+->
+s
+.
+comp_bys
+ +
+
+;
+
+600 
+e
+->
+s
+.
+comp_cks
+++;
+
+602 *
+m
+ = 
+mo_hd
+;
+
+603  
+DECOMP_OK
+;
+
+604 
+	}
+}
+
+610 
+	$z_comp
+(*
+g
+, 
+mbuf
+ *
+mi
+)
+
+612 
+dee_e
+ *
+e
+ = (dee_*
+g
+;
+
+613 
+u_ch
+ *
+
+;
+
+614 
+
+, 
+o
+, 
+r
+;
+
+619 
+
+ = 
+	`mtod
+(
+mi
+, 
+u_ch
+ *);
+
+620 
+o
+ = 
+	`PPP_PROTOCOL
+(
+
+);
+
+621 i(
+o
+ > 0x3fff ||roto == 0xfd ||roto == 0xfb)
+
+624 ++
+e
+->
+qno
+;
+
+632 
+
+ = 
+mi
+->
+m_n
+;
+
+633 
+e
+->
+rm
+.
+xt_
+ = 
+
+ + 3;
+
+634 
+e
+->
+rm
+.
+ava_
+ = 
+
+ - 3;
+
+635 i(
+o
+ > 0xff) {
+
+636 --
+e
+->
+rm
+.
+xt_
+;
+
+637 ++
+e
+->
+rm
+.
+ava_
+;
+
+640 
+r
+ = 
+	`eIncomp
+(&
+e
+->
+rm
+);
+
+641 i(
+r
+ !
+Z_OK
+) {
+
+643 #i!
+DEFLATE_DEBUG
+
+
+644 i(
+e
+->
+debug
+)
+
+646 
+	`tf
+("z_incomp%d: inflateIncompeturned %d (%s)\n",
+
+647 
+e
+->
+un
+, 
+r
+, (e->
+rm
+.
+msg
+? state->strm.msg: ""));
+
+650 
+mi
+ = mi->
+m_xt
+;
+
+651 i(
+mi
+ =
+NULL
+)
+
+653 
+e
+->
+rm
+.
+xt_
+ = 
+	`mtod
+(
+mi
+, 
+u_ch
+ *);
+
+654 
+e
+->
+rm
+.
+ava_
+ = 
+mi
+->
+m_n
+;
+
+655 
+
+ +
+mi
+->
+m_n
+;
+
+661 
+e
+->
+s
+.
+c_bys
+ +
+
+;
+
+662 
+e
+->
+s
+.
+c_cks
+++;
+
+663 
+e
+->
+s
+.
+unc_bys
+ +
+
+;
+
+664 
+e
+->
+s
+.
+unc_cks
+++;
+
+665 
+	}
+}
+
+667 
+MODULE
+(
+MODULE_CLASS_MISC
+, 
+p_dee
+, 
+NULL
+);
+
+670 
+	$p_dee_modcmd
+(
+modcmd_t
+ 
+cmd
+, *
+g
+)
+
+673 
+cmd
+) {
+
+674 
+MODULE_CMD_INIT
+:
+
+675  
+	`p_gi_comess
+(
+p_dee
+, 2);
+
+676 
+MODULE_CMD_FINI
+:
+
+677  
+	`p_uegi_comess
+(
+p_dee
+, 2);
+
+678 
+MODULE_CMD_STAT
+:
+
+681  
+ENOTTY
+;
+
+684  
+ENOTTY
+;
+
+685 
+	}
+}
+
+	@ppp_defs.h
+
+39 #ide
+_NET_PPP_DEFS_H_
+
+
+40 
+	#_NET_PPP_DEFS_H_
+
+
+	)
+
+45 
+	#PPP_HDRLEN
+ 4
+
+	)
+
+46 
+	#PPP_FCSLEN
+ 2
+
+	)
+
+56 
+	#PPP_MTU
+ 1500
+
+	)
+
+57 
+	#PPP_MAXMTU
+ 65535 - (
+PPP_HDRLEN
+ + 
+PPP_FCSLEN
+)
+
+	)
+
+58 
+	#PPP_MINMTU
+ 64
+
+	)
+
+59 
+	#PPP_MRU
+ 1500
+
+	)
+
+60 
+	#PPP_MAXMRU
+ 65000
+
+	)
+
+61 
+	#PPP_MINMRU
+ 128
+
+	)
+
+63 
+	#PPP_ADDRESS
+(
+p
+(((c 
+u_ch
+ *)))[0])
+
+	)
+
+64 
+	#PPP_CONTROL
+(
+p
+(((c 
+u_ch
+ *)))[1])
+
+	)
+
+65 
+	#PPP_PROTOCOL
+(
+p
+) \
+
+66 ((((c 
+u_ch
+ *)(
+p
+))[2] << 8+ ((c u_ch *)))[3])
+
+	)
+
+71 
+	#PPP_ALLSTATIONS
+ 0xf
+
+	)
+
+72 
+	#PPP_UI
+ 0x03
+
+	)
+
+73 
+	#PPP_FLAG
+ 0x7
+
+	)
+
+74 
+	#PPP_ESCAPE
+ 0x7d
+
+	)
+
+75 
+	#PPP_TRANS
+ 0x20
+
+	)
+
+80 
+	#PPP_IP
+ 0x0021
+
+	)
+
+81 
+	#PPP_ISO
+ 0x0023
+
+	)
+
+82 
+	#PPP_XNS
+ 0x0025
+
+	)
+
+83 
+	#PPP_AT
+ 0x0029
+
+	)
+
+84 
+	#PPP_IPX
+ 0x002b
+
+	)
+
+85 
+	#PPP_VJC_COMP
+ 0x002d
+
+	)
+
+86 
+	#PPP_VJC_UNCOMP
+ 0x002
+
+	)
+
+87 
+	#PPP_IPV6
+ 0x0057
+
+	)
+
+88 
+	#PPP_COMP
+ 0x00fd
+
+	)
+
+89 
+	#PPP_IPCP
+ 0x8021
+
+	)
+
+90 
+	#PPP_ATCP
+ 0x8029
+
+	)
+
+91 
+	#PPP_IPXCP
+ 0x802b
+
+	)
+
+92 
+	#PPP_IPV6CP
+ 0x8057
+
+	)
+
+93 
+	#PPP_CCP
+ 0x80fd
+
+	)
+
+94 
+	#PPP_ECP
+ 0x8053
+
+	)
+
+95 
+	#PPP_LCP
+ 0xc021
+
+	)
+
+96 
+	#PPP_PAP
+ 0xc023
+
+	)
+
+97 
+	#PPP_LQR
+ 0xc025
+
+	)
+
+98 
+	#PPP_CHAP
+ 0xc223
+
+	)
+
+99 
+	#PPP_CBCP
+ 0xc029
+
+	)
+
+100 
+	#PPP_EAP
+ 0xc227
+
+	)
+
+105 
+	#PPP_INITFCS
+ 0xfff
+
+	)
+
+106 
+	#PPP_GOODFCS
+ 0xf0b8
+
+	)
+
+107 
+	#PPP_FCS
+(
+fcs
+, 
+c
+(((fcs>> 8^ 
+fcab
+[((fcs^ (c)& 0xff])
+
+	)
+
+112 
+ut32_t
+ 
+	text_accm
+[8];
+
+117 
+	eNPmode
+ {
+
+118 
+	mNPMODE_PASS
+,
+
+119 
+	mNPMODE_DROP
+,
+
+120 
+	mNPMODE_ERROR
+,
+
+121 
+	mNPMODE_QUEUE
+
+
+127 
+	sp
+ {
+
+128 
+	mp_ibys
+;
+
+129 
+	mp_acks
+;
+
+130 
+	mp_s
+;
+
+131 
+	mp_obys
+;
+
+132 
+	mp_acks
+;
+
+133 
+	mp_s
+;
+
+136 
+	svj
+ {
+
+137 
+	mvjs_cks
+;
+
+138 
+	mvjs_comesd
+;
+
+139 
+	mvjs_ches
+;
+
+140 
+	mvjs_miss
+;
+
+141 
+	mvjs_uncomesd
+;
+
+142 
+	mvjs_comesd
+;
+
+143 
+	mvjs_r
+;
+
+144 
+	mvjs_tosd
+;
+
+147 
+	sp_s
+ {
+
+148 
+p
+ 
+	mp
+;
+
+149 
+vj
+ 
+	mvj
+;
+
+152 
+	scomp
+ {
+
+153 
+	munc_bys
+;
+
+154 
+	munc_cks
+;
+
+155 
+	mcomp_bys
+;
+
+156 
+	mcomp_cks
+;
+
+157 
+	mc_bys
+;
+
+158 
+	mc_cks
+;
+
+159 
+	mtio
+;
+
+162 
+	sp_comp_s
+ {
+
+163 
+comp
+ 
+	mc
+;
+
+164 
+comp
+ 
+	md
+;
+
+171 
+	sp_id
+ {
+
+172 
+time_t
+ 
+	mxm_id
+;
+
+173 
+time_t
+ 
+	mcv_id
+;
+
+	@ppp_tty.c
+
+95 
+	~<sys/cdefs.h
+>
+
+96 
+__KERNEL_RCSID
+(0, "$NetBSD:pp_tty.c,v 1.58 2014/05/22 16:31:19 dholland Exp $");
+
+98 
+	~"p.h
+"
+
+100 
+	~"t_p.h
+"
+
+101 
+	#VJC
+
+
+	)
+
+102 
+	#PPP_COMPRESS
+
+
+	)
+
+104 
+	~<sys/m.h
+>
+
+105 
+	~<sys/oc.h
+>
+
+106 
+	~<sys/mbuf.h
+>
+
+107 
+	~<sys/dk.h
+>
+
+108 
+	~<sys/sock.h
+>
+
+109 
+	~<sys/iol.h
+>
+
+110 
+	~<sys/fe.h
+>
+
+111 
+	~<sys/y.h
+>
+
+112 
+	~<sys/kl.h
+>
+
+113 
+	~<sys/cf.h
+>
+
+114 
+	~<sys/vnode.h
+>
+
+115 
+	~<sys/sym.h
+>
+
+116 
+	~<sys/kauth.h
+>
+
+118 
+	~<t/if.h
+>
+
+119 
+	~<t/if_tys.h
+>
+
+121 #ifde
+VJC
+
+
+122 
+	~<t/.h
+>
+
+123 
+	~<t/_sym.h
+>
+
+124 
+	~<t/.h
+>
+
+125 
+	~<t/comess.h
+>
+
+128 
+	~<t/bpf.h
+>
+
+129 
+	~<t/p_defs.h
+>
+
+130 
+	~<t/if_p.h
+>
+
+131 
+	~<t/if_pv.h
+>
+
+133 
+p
+(
+dev_t
+ 
+dev
+, 
+y
+ *
+
+);
+
+134 
+po
+(
+y
+ *
+
+, 
+ag
+);
+
+135 
+d
+(
+y
+ *
+
+, 
+uio
+ *uio, 
+ag
+);
+
+136 
+pwre
+(
+y
+ *
+
+, 
+uio
+ *uio, 
+ag
+);
+
+137 
+iol
+(
+y
+ *
+
+, 
+u_lg
+ 
+cmd
+, *
+da
+, 
+ag
+,
+
+138 
+lwp
+ *);
+
+139 
+pput
+(
+c
+, 
+y
+ *
+
+);
+
+140 
+pt
+(
+y
+ *
+
+);
+
+142 
+lesw
+ 
+	gp_disc
+ = {
+
+143 .
+l_me
+ = "ppp",
+
+144 .
+	gl_
+ = 
+p
+,
+
+145 .
+	gl_o
+ = 
+po
+,
+
+146 .
+	gl_ad
+ = 
+d
+,
+
+147 .
+	gl_wre
+ = 
+pwre
+,
+
+148 .
+	gl_iol
+ = 
+iol
+,
+
+149 .
+	gl_rt
+ = 
+pput
+,
+
+150 .
+	gl_t
+ = 
+pt
+,
+
+151 .
+	gl_modem
+ = 
+ymodem
+,
+
+152 .
+	gl_pl
+ = 
+pl
+
+
+155 
+cvame
+(
+p_soc
+ *
+sc
+, 
+mbuf
+ *
+m
+);
+
+156 
+ut16_t
+ 
+pfcs
+(ut16_
+fcs
+, c 
+ut8_t
+ *
+
+, 
+n
+);
+
+157 
+psynct
+(
+p_soc
+ *
+sc
+);
+
+158 
+synct
+(
+p_soc
+ *);
+
+159 
+sync
+(
+p_soc
+ *);
+
+160 
+synq
+(
+p_soc
+ *);
+
+161 
+p_timeout
+(*);
+
+162 
+pgm
+(
+p_soc
+ *
+sc
+);
+
+163 
+pdumpb
+(
+u_ch
+ *
+b
+, 
+l
+);
+
+164 
+ogch
+(
+p_soc
+ *, );
+
+165 
+pdumpame
+(
+p_soc
+ *
+sc
+, 
+mbuf
+* 
+m
+, 
+xm
+);
+
+170 
+	#M_IS_CLUSTER
+(
+m
+((m)->
+m_ags
+ & 
+M_EXT
+)
+
+	)
+
+172 
+	#M_DATASTART
+(
+m
+) \
+
+173 (
+	`M_IS_CLUSTER
+(
+m
+? (m)->
+m_ext
+.
+ext_buf
+ : \
+
+174 (
+m
+)->
+m_ags
+ & 
+M_PKTHDR
+ ? (m)->
+m_pktd
+ : (m)->
+m_d
+)
+
+	)
+
+176 
+	#M_DATASIZE
+(
+m
+) \
+
+177 (
+	`M_IS_CLUSTER
+(
+m
+? (m)->
+m_ext
+.
+ext_size
+ : \
+
+178 (
+m
+)->
+m_ags
+ & 
+M_PKTHDR
+ ? 
+MHLEN
+: 
+MLEN
+)
+
+	)
+
+183 
+	#ESCAPE_P
+(
+c
+(
+sc
+->
+sc_asyncm
+[(c>> 5] & (1 << ((c& 0x1F)))
+
+	)
+
+190 
+	#CCOUNT
+(
+q
+((q)->
+c_cc
+)
+
+	)
+
+192 
+	#PPP_LOWAT
+ 100
+
+	)
+
+193 
+	#PPP_HIWAT
+ 400
+
+	)
+
+202 
+	$p
+(
+dev_t
+ 
+dev
+, 
+y
+ *
+
+)
+
+204 
+lwp
+ *
+l
+ = 
+cuwp
+;
+
+205 
+p_soc
+ *
+sc
+;
+
+206 
+r
+, 
+s
+;
+
+208 
+r
+ = 
+	`kauth_authize_twk
+(
+l
+->
+l_ed
+, 
+KAUTH_NETWORK_INTERFACE_PPP
+,
+
+209 
+KAUTH_REQ_NETWORK_INTERFACE_PPP_ADD
+, 
+NULL
+, NULL, NULL);
+
+210 i(
+r
+)
+
+211  (
+r
+);
+
+213 
+s
+ = 
+	`ty
+();
+
+215 i(
+
+->
+t_lesw
+ =&
+p_disc
+) {
+
+216 
+sc
+ = (
+p_soc
+ *
+
+->
+t_sc
+;
+
+217 i(
+sc
+ !
+NULL
+ && sc->
+sc_devp
+ =(*
+
+) {
+
+218 
+	`lx
+(
+s
+);
+
+223 i((
+sc
+ = 
+	`oc
+(
+l
+->
+l_oc
+->
+p_pid
+)=
+NULL
+) {
+
+224 
+	`lx
+(
+s
+);
+
+225  
+ENXIO
+;
+
+228 i(
+sc
+->
+sc_lq
+)
+
+229 (*
+sc
+->
+sc_lq
+)(sc);
+
+232 
+	`bpf_chge_ty
+(&
+sc
+->
+sc_if
+, 
+DLT_PPP_SERIAL
+, 
+PPP_HDRLEN
+);
+
+234 
+sc
+->
+sc_
+ = 0;
+
+235 
+sc
+->
+sc_m
+ = 
+NULL
+;
+
+236 
+	`memt
+(
+sc
+->
+sc_asyncm
+, 0, (sc->sc_asyncmap));
+
+237 
+sc
+->
+sc_asyncm
+[0] = 0xffffffff;
+
+238 
+sc
+->
+sc_asyncm
+[3] = 0x60000000;
+
+239 
+sc
+->
+sc_syncm
+ = 0;
+
+240 
+sc
+->
+sc_devp
+ = (*
+
+;
+
+241 
+sc
+->
+sc_t
+ = 
+synct
+;
+
+242 
+sc
+->
+sc_
+ = 
+sync
+;
+
+243 
+sc
+->
+sc_lq
+ = 
+synq
+;
+
+244 
+sc
+->
+sc_outm
+ = 
+NULL
+;
+
+245 
+	`pgm
+(
+sc
+);
+
+246 
+sc
+->
+sc_if
+.
+if_ags
+ |
+IFF_RUNNING
+;
+
+247 
+sc
+->
+sc_if
+.
+if_baud
+ = 
+
+->
+t_od
+;
+
+249 
+
+->
+t_sc
+ = (*
+sc
+;
+
+250 
+	`mux__r
+(&
+y_lock
+);
+
+251 
+	`yush
+(
+
+, 
+FREAD
+ | 
+FWRITE
+);
+
+252 
+	`mux__ex
+(&
+y_lock
+);
+
+254 
+	`lx
+(
+s
+);
+
+256 
+	}
+}
+
+265 
+	$po
+(
+y
+ *
+
+, 
+ag
+)
+
+267 
+p_soc
+ *
+sc
+;
+
+268 
+s
+;
+
+270 
+s
+ = 
+	`ty
+();
+
+271 
+	`mux__r
+(&
+y_lock
+);
+
+272 
+	`yush
+(
+
+, 
+FREAD
+|
+FWRITE
+);
+
+273 
+	`mux__ex
+(&
+y_lock
+);
+
+274 
+	`yldisc_a
+(
+
+->
+t_lesw
+);
+
+275 
+
+->
+t_lesw
+ = 
+	`yldisc_deu
+();
+
+276 
+sc
+ = (
+p_soc
+ *
+
+->
+t_sc
+;
+
+277 i(
+sc
+ !
+NULL
+) {
+
+278 
+
+->
+t_sc
+ = 
+NULL
+;
+
+279 i(
+
+ =(
+y
+ *
+sc
+->
+sc_devp
+) {
+
+280 
+	`synq
+(
+sc
+);
+
+281 
+	`pdoc
+(
+sc
+);
+
+284 
+	`lx
+(
+s
+);
+
+286 
+	}
+}
+
+292 
+	$synq
+(
+p_soc
+ *
+sc
+)
+
+294 
+s
+;
+
+297 
+	`bpf_chge_ty
+(&
+sc
+->
+sc_if
+, 
+DLT_NULL
+, 0);
+
+299 
+s
+ = 
+	`ty
+();
+
+300 i(
+sc
+->
+sc_outm
+) {
+
+301 
+	`m_m
+(
+sc
+->
+sc_outm
+);
+
+302 
+sc
+->
+sc_outm
+ = 
+NULL
+;
+
+304 i(
+sc
+->
+sc_m
+) {
+
+305 
+	`m_m
+(
+sc
+->
+sc_m
+);
+
+306 
+sc
+->
+sc_m
+ = 
+NULL
+;
+
+308 i(
+sc
+->
+sc_ags
+ & 
+SC_TIMEOUT
+) {
+
+309 
+	`out_
+(&
+sc
+->
+sc_timo_ch
+);
+
+310 
+sc
+->
+sc_ags
+ &~
+SC_TIMEOUT
+;
+
+312 
+	`lx
+(
+s
+);
+
+313 
+	}
+}
+
+319 
+	$d
+(
+y
+ *
+
+, 
+uio
+ *uio, 
+ag
+)
+
+321 
+p_soc
+ *
+sc
+ = (p_so*)
+
+->
+t_sc
+;
+
+322 
+mbuf
+ *
+m
+, *
+m0
+;
+
+323 
+r
+ = 0;
+
+325 i(
+sc
+ =
+NULL
+)
+
+331 
+	`mux__r
+(&
+y_lock
+);
+
+333 i(
+
+ !(
+y
+ *
+sc
+->
+sc_devp
+ ||
+
+334 
+
+->
+t_lesw
+ !&
+p_disc
+) {
+
+335 
+	`mux__ex
+(&
+y_lock
+);
+
+338 i(
+sc
+->
+sc_q
+.
+ifq_hd
+ !
+NULL
+)
+
+340 i((
+
+->
+t_e
+ & 
+TS_CARR_ON
+=0 && (->
+t_cag
+ & 
+CLOCAL
+) == 0
+
+341 && (
+
+->
+t_e
+ & 
+TS_ISOPEN
+)) {
+
+342 
+	`mux__ex
+(&
+y_lock
+);
+
+345 i(
+
+->
+t_e
+ & 
+TS_ASYNC
+ || 
+ag
+ & 
+IO_NDELAY
+) {
+
+346 
+	`mux__ex
+(&
+y_lock
+);
+
+347  (
+EWOULDBLOCK
+);
+
+349 
+r
+ = 
+	`yp
+(
+
+, &->
+t_wcv
+, 
+ue
+, 0);
+
+350 i(
+r
+) {
+
+351 
+	`mux__ex
+(&
+y_lock
+);
+
+352  
+r
+;
+
+357 
+	`gc
+(&
+
+->
+t_nq
+);
+
+360 
+	`IF_DEQUEUE
+(&
+sc
+->
+sc_q
+, 
+m0
+);
+
+361 
+	`mux__ex
+(&
+y_lock
+);
+
+363 
+m
+ = 
+m0
+; m && 
+uio
+->
+uio_sid
+; m = m->
+m_xt
+)
+
+364 i((
+r
+ = 
+	`uiomove
+(
+	`mtod
+(
+m
+, 
+u_ch
+ *), m->
+m_n
+, 
+uio
+)) != 0)
+
+366 
+	`m_m
+(
+m0
+);
+
+367  (
+r
+);
+
+368 
+	}
+}
+
+374 
+	$pwre
+(
+y
+ *
+
+, 
+uio
+ *uio, 
+ag
+)
+
+376 
+p_soc
+ *
+sc
+ = (p_so*)
+
+->
+t_sc
+;
+
+377 
+mbuf
+ *
+m
+, *
+m0
+;
+
+378 
+sockaddr
+ 
+d
+;
+
+379 
+n
+, 
+r
+;
+
+381 i((
+
+->
+t_e
+ & 
+TS_CARR_ON
+=0 && (->
+t_cag
+ & 
+CLOCAL
+) == 0)
+
+383 i(
+
+->
+t_lesw
+ !&
+p_disc
+)
+
+384  (
+EINVAL
+);
+
+385 i(
+sc
+ =
+NULL
+ || 
+
+ !(
+y
+ *sc->
+sc_devp
+)
+
+386  
+EIO
+;
+
+387 i(
+uio
+->
+uio_sid
+ > 
+sc
+->
+sc_if
+.
+if_mtu
+ + 
+PPP_HDRLEN
+ ||
+
+388 
+uio
+->
+uio_sid
+ < 
+PPP_HDRLEN
+)
+
+389  (
+EMSGSIZE
+);
+
+391 
+	`MGETHDR
+(
+m0
+, 
+M_WAIT
+, 
+MT_DATA
+);
+
+392 i(
+m0
+ =
+NULL
+)
+
+393  
+ENOBUFS
+;
+
+395 
+m0
+->
+m_n
+ = 0;
+
+396 
+m0
+->
+m_pkthdr
+.
+n
+ = 
+uio
+->
+uio_sid
+;
+
+397 
+m0
+->
+m_pkthdr
+.
+rcvif
+ = 
+NULL
+;
+
+399 i(
+uio
+->
+uio_sid
+ >
+MCLBYTES
+ / 2)
+
+400 
+	`MCLGET
+(
+m0
+, 
+M_DONTWAIT
+);
+
+402 
+m
+ = 
+m0
+; 
+uio
+->
+uio_sid
+;) {
+
+403 
+n
+ = 
+	`M_TRAILINGSPACE
+(
+m
+);
+
+404 i(
+n
+ > 
+uio
+->
+uio_sid
+)
+
+405 
+n
+ = 
+uio
+->
+uio_sid
+;
+
+406 i((
+r
+ = 
+	`uiomove
+(
+	`mtod
+(
+m
+, 
+u_ch
+ *), 
+n
+, 
+uio
+)) != 0) {
+
+407 
+	`m_m
+(
+m0
+);
+
+408  (
+r
+);
+
+410 
+m
+->
+m_n
+ = 
+n
+;
+
+412 i(
+uio
+->
+uio_sid
+ == 0)
+
+415 
+	`MGET
+(
+m
+->
+m_xt
+, 
+M_WAIT
+, 
+MT_DATA
+);
+
+416 i(
+m
+->
+m_xt
+ =
+NULL
+) {
+
+417 
+	`m_m
+(
+m0
+);
+
+418  
+ENOBUFS
+;
+
+420 
+m
+ = m->
+m_xt
+;
+
+421 
+m
+->
+m_n
+ = 0;
+
+423 
+d
+.
+_my
+ = 
+AF_UNSPEC
+;
+
+424 
+	`bcy
+(
+	`mtod
+(
+m0
+, 
+u_ch
+ *), 
+d
+.
+_da
+, 
+PPP_HDRLEN
+);
+
+425 
+	`m_adj
+(
+m0
+, 
+PPP_HDRLEN
+);
+
+426  ((*
+sc
+->
+sc_if
+.
+if_ouut
+)(&sc->sc_if, 
+m0
+, &
+d
+, (
+y
+ *)0));
+
+427 
+	}
+}
+
+436 
+	$iol
+(
+y
+ *
+
+, 
+u_lg
+ 
+cmd
+, *
+da
+, 
+ag
+, 
+lwp
+ *
+l
+)
+
+438 
+p_soc
+ *
+sc
+ = (p_so*
+
+->
+t_sc
+;
+
+439 
+r
+, 
+s
+;
+
+441 i(
+sc
+ =
+NULL
+ || 
+
+ !(
+y
+ *sc->
+sc_devp
+)
+
+442  (
+EPASSTHROUGH
+);
+
+444 
+r
+ = 0;
+
+445 
+cmd
+) {
+
+446 
+TIOCRCVFRAME
+:
+
+447 
+	`cvame
+(
+sc
+,*((
+mbuf
+ **)
+da
+));
+
+450 
+PPPIOCSASYNCMAP
+:
+
+451 i((
+r
+ = 
+	`kauth_authize_devi_y
+(
+l
+->
+l_ed
+,
+
+452 
+KAUTH_DEVICE_TTY_PRIVSET
+, 
+
+)) != 0)
+
+454 
+sc
+->
+sc_asyncm
+[0] = *(
+u_t
+ *)
+da
+;
+
+457 
+PPPIOCGASYNCMAP
+:
+
+458 *(
+u_t
+ *)
+da
+ = 
+sc
+->
+sc_asyncm
+[0];
+
+461 
+PPPIOCSRASYNCMAP
+:
+
+462 i((
+r
+ = 
+	`kauth_authize_devi_y
+(
+l
+->
+l_ed
+,
+
+463 
+KAUTH_DEVICE_TTY_PRIVSET
+, 
+
+)) != 0)
+
+465 
+sc
+->
+sc_syncm
+ = *(
+u_t
+ *)
+da
+;
+
+468 
+PPPIOCGRASYNCMAP
+:
+
+469 *(
+u_t
+ *)
+da
+ = 
+sc
+->
+sc_syncm
+;
+
+472 
+PPPIOCSXASYNCMAP
+:
+
+473 i((
+r
+ = 
+	`kauth_authize_devi_y
+(
+l
+->
+l_ed
+,
+
+474 
+KAUTH_DEVICE_TTY_PRIVSET
+, 
+
+)) != 0)
+
+476 
+s
+ = 
+	`ty
+();
+
+477 
+	`bcy
+(
+da
+, 
+sc
+->
+sc_asyncm
+, (sc->sc_asyncmap));
+
+478 
+sc
+->
+sc_asyncm
+[1] = 0;
+
+479 
+sc
+->
+sc_asyncm
+[2] &= ~0x40000000;
+
+480 
+sc
+->
+sc_asyncm
+[3] |= 0x60000000;
+
+481 
+	`lx
+(
+s
+);
+
+484 
+PPPIOCGXASYNCMAP
+:
+
+485 
+	`bcy
+(
+sc
+->
+sc_asyncm
+, 
+da
+, (sc->sc_asyncmap));
+
+489 
+r
+ = 
+	`piol
+(
+sc
+, 
+cmd
+, 
+da
+, 
+ag
+, 
+l
+);
+
+490 i(
+r
+ =0 && 
+cmd
+ =
+PPPIOCSMRU
+)
+
+491 
+	`pgm
+(
+sc
+);
+
+494  
+r
+;
+
+495 
+	}
+}
+
+501 
+	$cvame
+(
+p_soc
+ *
+sc
+, 
+mbuf
+ *
+m
+)
+
+503 
+n
+, 
+s
+;
+
+504 
+mbuf
+ *
+n
+;
+
+505 
+u_ch
+ 
+hdr
+[4];
+
+506 
+hn
+,
+cou
+;
+
+508 
+n
+=
+m
+,
+n
+=0;!
+NULL
+;n->
+m_xt
+)
+
+509 
+n
+ +
+n
+->
+m_n
+;
+
+510 i(
+n
+==0) {
+
+511 
+	`m_m
+(
+m
+);
+
+516 
+n
+=
+m
+,
+hn
+=0;n!=
+NULL
+ && hn<(
+hdr
+);n->
+m_xt
+) {
+
+517 
+cou
+ = ((
+hdr
+)-
+hn
+< 
+n
+->
+m_n
+ ?
+
+518 (
+hdr
+)-
+hn
+ : 
+n
+->
+m_n
+;
+
+519 
+	`bcy
+(
+	`mtod
+(
+n
+,
+u_ch
+*),&
+hdr
+[
+hn
+],
+cou
+);
+
+520 
+hn
++=
+cou
+;
+
+523 
+s
+ = 
+	`ty
+();
+
+526 i(
+hdr
+[0] !
+PPP_ALLSTATIONS
+) {
+
+527 i(
+sc
+->
+sc_ags
+ & 
+SC_REJ_COMP_AC
+) {
+
+528 i(
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)
+
+529 
+	`tf
+(
+
+531 
+sc
+->
+sc_if
+.
+if_xme
+, 
+hdr
+[0]);
+
+532 
+ba
+;
+
+534 
+	`M_PREPEND
+(
+m
+,2,
+M_DONTWAIT
+);
+
+535 i(
+m
+==
+NULL
+) {
+
+536 
+	`lx
+(
+s
+);
+
+539 
+hdr
+[3] = hdr[1];
+
+540 
+hdr
+[2] = hdr[0];
+
+541 
+hdr
+[0] = 
+PPP_ALLSTATIONS
+;
+
+542 
+hdr
+[1] = 
+PPP_UI
+;
+
+543 
+n
+ += 2;
+
+547 i(
+hdr
+[2] & 1) {
+
+549 
+	`M_PREPEND
+(
+m
+,1,
+M_DONTWAIT
+);
+
+550 i(
+m
+==
+NULL
+) {
+
+551 
+	`lx
+(
+s
+);
+
+554 
+hdr
+[3] = hdr[2];
+
+555 
+hdr
+[2] = 0;
+
+556 
+n
+++;
+
+560 i(!(
+hdr
+[3] & 1)) {
+
+561 i(
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)
+
+562 
+	`tf
+("%s: badroc %x\n", 
+sc
+->
+sc_if
+.
+if_xme
+,
+
+563 (
+hdr
+[2] << 8) + hdr[3]);
+
+564 
+ba
+;
+
+568 i(
+n
+ > 
+sc
+->
+sc_mru
+ + 
+PPP_HDRLEN
+) {
+
+569 i(
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)
+
+570 
+	`tf
+("%s:ackobig\n", 
+sc
+->
+sc_if
+.
+if_xme
+);
+
+571 
+ba
+;
+
+575 
+n
+=
+m
+,
+hn
+=0;n!=
+NULL
+ && hn<(
+hdr
+);n->
+m_xt
+) {
+
+576 
+cou
+ = ((
+hdr
+)-
+hn
+< 
+n
+->
+m_n
+ ?
+
+577 (
+hdr
+)-
+hn
+ : 
+n
+->
+m_n
+;
+
+578 
+	`bcy
+(&
+hdr
+[
+hn
+],
+	`mtod
+(
+n
+,
+u_ch
+*),
+cou
+);
+
+579 
+hn
++=
+cou
+;
+
+584 
+cou
+ = 
+n
+ < 
+MHLEN
+ ?en : MHLEN;
+
+585 i(
+m
+->
+m_n
+ < 
+cou
+) {
+
+586 
+m
+ = 
+	`m_puup
+(m,
+cou
+);
+
+587 i(
+m
+==
+NULL
+)
+
+588 
+ba
+;
+
+591 
+sc
+->
+sc_s
+.
+p_ibys
+ +
+n
+;
+
+593 i(
+sc
+->
+sc_ags
+ & 
+SC_LOG_RAWIN
+)
+
+594 
+	`pdumpame
+(
+sc
+,
+m
+,0);
+
+596 
+	`kt
+(
+sc
+, 
+m
+, 0);
+
+597 
+	`lx
+(
+s
+);
+
+599 
+ba
+:
+
+600 
+	`m_m
+(
+m
+);
+
+601 
+	`lx
+(
+s
+);
+
+602 
+	}
+}
+
+607 c 
+ut16_t
+ 
+	gfcab
+[256] = {
+
+645 
+ut16_t
+
+
+646 
+	$pfcs
+(
+ut16_t
+ 
+fcs
+, c 
+ut8_t
+ *
+
+, 
+n
+)
+
+648 
+n
+--)
+
+649 
+fcs
+ = 
+	`PPP_FCS
+(fcs, *
+
+++);
+
+650  (
+fcs
+);
+
+651 
+	}
+}
+
+657 
+	$psynct
+(
+p_soc
+ *
+sc
+)
+
+659 
+y
+ *
+
+ = (y *
+sc
+->
+sc_devp
+;
+
+660 
+mbuf
+ *
+m
+, *
+n
+;
+
+661 c 
+cdevsw
+ *
+cdev
+;
+
+662 
+n
+;
+
+664 
+m
+ = 
+sc
+->
+sc_outm
+;;) {
+
+665 i(
+m
+ =
+NULL
+) {
+
+666 
+m
+ = 
+	`p_dequeue
+(
+sc
+);
+
+667 i(
+m
+ =
+NULL
+)
+
+669 i(
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)
+
+670 
+	`pdumpame
+(
+sc
+,
+m
+,1);
+
+672 
+n
+=
+m
+,
+n
+=0;n!=
+NULL
+;n->
+m_xt
+)
+
+673 
+n
+ +
+n
+->
+m_n
+;
+
+676 
+cdev
+ = 
+	`cdevsw_lookup
+(
+
+->
+t_dev
+);
+
+677 i(
+cdev
+ =
+NULL
+ ||
+
+678 (*
+cdev
+->
+d_iol
+)(
+
+->
+t_dev
+, 
+TIOCXMTFRAME
+, (*)&
+m
+,
+
+681 
+sc
+->
+sc_outm
+ = 
+m
+;
+
+684 
+sc
+->
+sc_outm
+ = 
+m
+ = 
+NULL
+;
+
+685 
+sc
+->
+sc_s
+.
+p_obys
+ +
+n
+;
+
+687 
+	}
+}
+
+694 
+	$synct
+(
+p_soc
+ *
+sc
+)
+
+696 
+y
+ *
+
+ = (y *
+sc
+->
+sc_devp
+;
+
+697 
+mbuf
+ *
+m
+;
+
+698 
+n
+;
+
+699 
+u_ch
+ *
+t
+, *
+
+, *
+
+;
+
+700 
+n
+, 
+nde
+, 
+de
+, 
+id
+;
+
+701 
+mbuf
+ *
+m2
+;
+
+703 i(
+sc
+->
+sc_ags
+ & 
+SC_SYNC
+){
+
+704 
+	`psynct
+(
+sc
+);
+
+708 
+	`mux__r
+(&
+y_lock
+);
+
+710 
+id
+ = 0;
+
+711 
+	`CCOUNT
+(&
+
+->
+t_outq
+< 
+PPP_HIWAT
+) {
+
+716 
+m
+ = 
+sc
+->
+sc_outm
+;
+
+717 i(
+m
+ =
+NULL
+) {
+
+721 
+m
+ = 
+	`p_dequeue
+(
+sc
+);
+
+722 i(
+m
+ =
+NULL
+) {
+
+723 
+id
+ = 1;
+
+732 i(
+	`CCOUNT
+(&
+
+->
+t_outq
+) == 0) {
+
+733 ++
+sc
+->
+sc_s
+.
+p_obys
+;
+
+734 (
+	`putc
+(
+PPP_FLAG
+, &
+
+->
+t_outq
+);
+
+738 
+sc
+->
+sc_outfcs
+ = 
+	`pfcs
+(
+PPP_INITFCS
+, 
+	`mtod
+(
+m
+, 
+ut8_t
+ *), m->
+m_n
+);
+
+742 
+t
+ = 
+	`mtod
+(
+m
+, 
+u_ch
+ *);
+
+743 
+n
+ = 
+m
+->
+m_n
+;
+
+744 
+
+ = 
+t
+ + 
+n
+;
+
+745 
+n
+ > 0) {
+
+750 
+
+ = 
+t
+; c< 
+
+; cp++)
+
+751 i(
+	`ESCAPE_P
+(*
+
+))
+
+753 
+n
+ = 
+
+ - 
+t
+;
+
+754 i(
+n
+) {
+
+756 
+nde
+ = 
+n
+ - 
+	`b_to_q
+(
+t
+,, &
+
+->
+t_outq
+);
+
+757 
+n
+ -
+nde
+;
+
+758 
+t
+ +
+nde
+;
+
+759 
+sc
+->
+sc_s
+.
+p_obys
+ +
+nde
+;
+
+761 i(
+nde
+ < 
+n
+)
+
+769 i(
+n
+) {
+
+770 i(
+	`putc
+(
+PPP_ESCAPE
+, &
+
+->
+t_outq
+))
+
+772 i(
+	`putc
+(*
+t
+ ^ 
+PPP_TRANS
+, &
+
+->
+t_outq
+)) {
+
+773 (
+	`uutc
+(&
+
+->
+t_outq
+);
+
+776 
+sc
+->
+sc_s
+.
+p_obys
+ += 2;
+
+777 
+t
+++;
+
+778 
+n
+--;
+
+788 
+de
+ = 
+n
+ == 0;
+
+789 i(
+de
+ && 
+m
+->
+m_xt
+ =
+NULL
+) {
+
+790 
+u_ch
+ *
+p
+, *
+q
+;
+
+791 
+c
+;
+
+792 
+u_ch
+ 
+dq
+[8];
+
+797 
+p
+ = 
+dq
+;
+
+798 
+c
+ = ~
+sc
+->
+sc_outfcs
+ & 0xFF;
+
+799 i(
+	`ESCAPE_P
+(
+c
+)) {
+
+800 *
+p
+++ = 
+PPP_ESCAPE
+;
+
+801 *
+p
+++ = 
+c
+ ^ 
+PPP_TRANS
+;
+
+803 *
+p
+++ = 
+c
+;
+
+804 
+c
+ = (~
+sc
+->
+sc_outfcs
+ >> 8) & 0xFF;
+
+805 i(
+	`ESCAPE_P
+(
+c
+)) {
+
+806 *
+p
+++ = 
+PPP_ESCAPE
+;
+
+807 *
+p
+++ = 
+c
+ ^ 
+PPP_TRANS
+;
+
+809 *
+p
+++ = 
+c
+;
+
+810 *
+p
+++ = 
+PPP_FLAG
+;
+
+816 
+q
+ = 
+dq
+; q < 
+p
+; ++q)
+
+817 i(
+	`putc
+(*
+q
+, &
+
+->
+t_outq
+)) {
+
+818 
+de
+ = 0;
+
+819 ; 
+q
+ > 
+dq
+; --q)
+
+820 
+	`uutc
+(&
+
+->
+t_outq
+);
+
+823 i(
+de
+)
+
+824 
+sc
+->
+sc_s
+.
+p_obys
+ +
+q
+ - 
+dq
+;
+
+827 i(!
+de
+) {
+
+829 
+m
+->
+m_da
+ = 
+t
+;
+
+830 
+m
+->
+m_n
+ = 
+n
+;
+
+835 
+	`MFREE
+(
+m
+, 
+m2
+);
+
+836 
+m
+ = 
+m2
+;
+
+837 i(
+m
+ =
+NULL
+) {
+
+841 
+sc
+->
+sc_outfcs
+ = 
+	`pfcs
+(sc->sc_outfcs, 
+	`mtod
+(
+m
+, 
+ut8_t
+ *), m->
+m_n
+);
+
+849 
+sc
+->
+sc_outm
+ = 
+m
+;
+
+850 i(
+m
+)
+
+855 
+	`pt
+(
+
+);
+
+862 i(!
+id
+ && (
+sc
+->
+sc_ags
+ & 
+SC_TIMEOUT
+) == 0) {
+
+863 
+	`out_t
+(&
+sc
+->
+sc_timo_ch
+, 1, 
+p_timeout
+, sc);
+
+864 
+sc
+->
+sc_ags
+ |
+SC_TIMEOUT
+;
+
+867 
+	`mux__ex
+(&
+y_lock
+);
+
+868 
+	}
+}
+
+875 
+	$sync
+(
+p_soc
+ *
+sc
+)
+
+877 
+y
+ *
+
+;
+
+880 
+	`mux__r
+(&
+y_lock
+);
+
+881 
+
+ = (
+y
+ *
+sc
+->
+sc_devp
+;
+
+882 
+	`putc
+(0, &
+
+->
+t_nq
+);
+
+883 
+	`wakeup
+(
+
+);
+
+884 
+	`mux__ex
+(&
+y_lock
+);
+
+885 
+	}
+}
+
+894 
+	$pt
+(
+y
+ *
+
+)
+
+896 
+p_soc
+ *
+sc
+ = (p_so*
+
+->
+t_sc
+;
+
+902 i(
+
+->
+t_roc
+ !
+NULL
+)
+
+903 (*
+
+->
+t_roc
+)(tp);
+
+910 i((
+	`CCOUNT
+(&
+
+->
+t_outq
+>
+PPP_LOWAT
+)
+
+911 && ((
+sc
+ =
+NULL
+|| (sc->
+sc_ags
+ & 
+SC_TIMEOUT
+)))
+
+913 #ifde
+ALTQ
+
+
+919 i(
+	`ALTQ_IS_ENABLED
+(&
+sc
+->
+sc_if
+.
+if_d
+))
+
+922 i(!((
+
+->
+t_e
+ & 
+TS_CARR_ON
+=0 && (->
+t_cag
+ & 
+CLOCAL
+) == 0)
+
+923 && 
+sc
+ !
+NULL
+ && 
+
+ =(
+y
+ *sc->
+sc_devp
+) {
+
+924 
+	`p_t
+(
+sc
+);
+
+928 
+	}
+}
+
+934 
+	$p_timeout
+(*
+x
+)
+
+936 
+p_soc
+ *
+sc
+ = (p_so*
+x
+;
+
+937 
+y
+ *
+
+ = (y *
+sc
+->
+sc_devp
+;
+
+939 
+	`mux__r
+(&
+y_lock
+);
+
+940 
+sc
+->
+sc_ags
+ &~
+SC_TIMEOUT
+;
+
+941 
+	`pt
+(
+
+);
+
+942 
+	`mux__ex
+(&
+y_lock
+);
+
+943 
+	}
+}
+
+949 
+	$pgm
+(
+p_soc
+ *
+sc
+)
+
+951 
+mbuf
+ *
+m
+, **
+mp
+;
+
+952 
+n
+;
+
+954 
+mp
+ = &
+sc
+->
+sc_m
+;
+
+955 
+n
+ = 
+sc
+->
+sc_mru
+ + 
+PPP_HDRLEN
+ + 
+PPP_FCSLEN
+;en > 0; ){
+
+956 i((
+m
+ = *
+mp
+=
+NULL
+) {
+
+957 
+	`MGETHDR
+(
+m
+, 
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+958 i(
+m
+ =
+NULL
+)
+
+960 *
+mp
+ = 
+m
+;
+
+961 
+	`MCLGET
+(
+m
+, 
+M_DONTWAIT
+);
+
+963 
+n
+ -
+	`M_DATASIZE
+(
+m
+);
+
+964 
+mp
+ = &
+m
+->
+m_xt
+;
+
+966 
+	}
+}
+
+971 c 
+	gryb
+[8] = {
+
+977 
+	$pput
+(
+c
+, 
+y
+ *
+
+)
+
+979 
+p_soc
+ *
+sc
+;
+
+980 
+mbuf
+ *
+m
+;
+
+981 
+
+, 
+s
+;
+
+982 
+su
+;
+
+984 
+sc
+ = (
+p_soc
+ *
+
+->
+t_sc
+;
+
+985 i(
+sc
+ =
+NULL
+ || 
+
+ !(
+y
+ *sc->
+sc_devp
+)
+
+988 ++
+tk_n
+;
+
+989 ++
+sc
+->
+sc_s
+.
+p_ibys
+;
+
+991 i(
+c
+ & 
+TTY_FE
+) {
+
+993 i(
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)
+
+994 
+	`tf
+("%s: bad ch %x\n", 
+sc
+->
+sc_if
+.
+if_xme
+, 
+c
+);
+
+995 
+ush
+;
+
+998 
+c
+ &= 0xff;
+
+1003 
+su
+ = 
+	`y_y_xxoff
+(
+
+, 
+c
+);
+
+1004 i(
+su
+ == 0) {
+
+1010 
+s
+ = 
+	`ty
+();
+
+1011 i(
+c
+ & 0x80)
+
+1012 
+sc
+->
+sc_ags
+ |
+SC_RCV_B7_1
+;
+
+1014 
+sc
+->
+sc_ags
+ |
+SC_RCV_B7_0
+;
+
+1015 i(
+ryb
+[
+c
+ >> 5] & (1 << (c & 0x1F)))
+
+1016 
+sc
+->
+sc_ags
+ |
+SC_RCV_ODDP
+;
+
+1018 
+sc
+->
+sc_ags
+ |
+SC_RCV_EVNP
+;
+
+1019 
+	`lx
+(
+s
+);
+
+1021 
+	`ogch
+(
+sc
+, 
+c
+);
+
+1023 i(
+c
+ =
+PPP_FLAG
+) {
+
+1024 
+
+ = 
+sc
+->
+sc_
+;
+
+1025 
+sc
+->
+sc_
+ = 0;
+
+1027 i((
+sc
+->
+sc_ags
+ & 
+SC_LOG_RAWIN
+&& sc->
+sc_w
+.
+cou
+ > 0)
+
+1028 
+	`ogch
+(
+sc
+, -1);
+
+1034 i(
+sc
+->
+sc_ags
+ & (
+SC_FLUSH
+ | 
+SC_ESCAPED
+)
+
+1035 || (
+
+ > 0 && 
+sc
+->
+sc_fcs
+ !
+PPP_GOODFCS
+)) {
+
+1036 
+s
+ = 
+	`ty
+();
+
+1037 
+sc
+->
+sc_ags
+ |
+SC_PKTLOST
+;
+
+1038 i((
+sc
+->
+sc_ags
+ & (
+SC_FLUSH
+ | 
+SC_ESCAPED
+)) == 0){
+
+1039 i(
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)
+
+1040 
+	`tf
+("%s: bad fc%x\n", 
+sc
+->
+sc_if
+.
+if_xme
+,
+
+1041 
+sc
+->
+sc_fcs
+);
+
+1042 
+sc
+->
+sc_if
+.
+if_s
+++;
+
+1043 
+sc
+->
+sc_s
+.
+p_s
+++;
+
+1045 
+sc
+->
+sc_ags
+ &~(
+SC_FLUSH
+ | 
+SC_ESCAPED
+);
+
+1046 
+	`lx
+(
+s
+);
+
+1050 i(
+
+ < 
+PPP_HDRLEN
+ + 
+PPP_FCSLEN
+) {
+
+1051 i(
+
+) {
+
+1052 i(
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)
+
+1053 
+	`tf
+("%s:osh(%d)\n", 
+sc
+->
+sc_if
+.
+if_xme
+, 
+
+);
+
+1054 
+s
+ = 
+	`ty
+();
+
+1055 
+sc
+->
+sc_if
+.
+if_s
+++;
+
+1056 
+sc
+->
+sc_s
+.
+p_s
+++;
+
+1057 
+sc
+->
+sc_ags
+ |
+SC_PKTLOST
+;
+
+1058 
+	`lx
+(
+s
+);
+
+1066 
+
+ -= 2;
+
+1067 i(--
+sc
+->
+sc_mc
+->
+m_n
+ == 0) {
+
+1068 
+m
+ = 
+sc
+->
+sc_m
+; m->
+m_xt
+ !sc->
+sc_mc
+; m = m->m_next)
+
+1070 
+sc
+->
+sc_mc
+ = 
+m
+;
+
+1072 
+sc
+->
+sc_mc
+->
+m_n
+--;
+
+1075 
+m
+ = 
+sc
+->
+sc_m
+;
+
+1076 
+sc
+->
+sc_m
+ = sc->
+sc_mc
+->
+m_xt
+;
+
+1077 
+sc
+->
+sc_mc
+->
+m_xt
+ = 
+NULL
+;
+
+1079 
+	`kt
+(
+sc
+, 
+m
+, sc->
+sc_ags
+ & 
+SC_PKTLOST
+);
+
+1080 i(
+sc
+->
+sc_ags
+ & 
+SC_PKTLOST
+) {
+
+1081 
+s
+ = 
+	`ty
+();
+
+1082 
+sc
+->
+sc_ags
+ &~
+SC_PKTLOST
+;
+
+1083 
+	`lx
+(
+s
+);
+
+1086 
+	`pgm
+(
+sc
+);
+
+1090 i(
+sc
+->
+sc_ags
+ & 
+SC_FLUSH
+) {
+
+1091 i(
+sc
+->
+sc_ags
+ & 
+SC_LOG_FLUSH
+)
+
+1092 
+	`ogch
+(
+sc
+, 
+c
+);
+
+1096 i(
+c
+ < 0x20 && (
+sc
+->
+sc_syncm
+ & (1 << c)))
+
+1099 
+s
+ = 
+	`ty
+();
+
+1100 i(
+sc
+->
+sc_ags
+ & 
+SC_ESCAPED
+) {
+
+1101 
+sc
+->
+sc_ags
+ &~
+SC_ESCAPED
+;
+
+1102 
+c
+ ^
+PPP_TRANS
+;
+
+1103 } i(
+c
+ =
+PPP_ESCAPE
+) {
+
+1104 
+sc
+->
+sc_ags
+ |
+SC_ESCAPED
+;
+
+1105 
+	`lx
+(
+s
+);
+
+1108 
+	`lx
+(
+s
+);
+
+1119 i(
+sc
+->
+sc_
+ == 0) {
+
+1121 i(
+sc
+->
+sc_m
+ =
+NULL
+) {
+
+1122 
+	`pgm
+(
+sc
+);
+
+1123 i(
+sc
+->
+sc_m
+ =
+NULL
+) {
+
+1124 i(
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)
+
+1125 
+	`tf
+("%s:pumbufs!\n", 
+sc
+->
+sc_if
+.
+if_xme
+);
+
+1126 
+ush
+;
+
+1129 
+m
+ = 
+sc
+->
+sc_m
+;
+
+1130 
+m
+->
+m_n
+ = 0;
+
+1131 
+m
+->
+m_da
+ = 
+	`M_DATASTART
+(
+sc
+->
+sc_m
+);
+
+1132 
+sc
+->
+sc_mc
+ = 
+m
+;
+
+1133 
+sc
+->
+sc_mp
+ = 
+	`mtod
+(
+m
+, *);
+
+1134 
+sc
+->
+sc_fcs
+ = 
+PPP_INITFCS
+;
+
+1135 i(
+c
+ !
+PPP_ALLSTATIONS
+) {
+
+1136 i(
+sc
+->
+sc_ags
+ & 
+SC_REJ_COMP_AC
+) {
+
+1137 i(
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)
+
+1138 
+	`tf
+("%s: garbageeceived: 0x%x (need 0xFF)\n",
+
+1139 
+sc
+->
+sc_if
+.
+if_xme
+, 
+c
+);
+
+1140 
+ush
+;
+
+1142 *
+sc
+->
+sc_mp
+++ = 
+PPP_ALLSTATIONS
+;
+
+1143 *
+sc
+->
+sc_mp
+++ = 
+PPP_UI
+;
+
+1144 
+sc
+->
+sc_
+ += 2;
+
+1145 
+m
+->
+m_n
+ += 2;
+
+1148 i(
+sc
+->
+sc_
+ =1 && 
+c
+ !
+PPP_UI
+) {
+
+1149 i(
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)
+
+1150 
+	`tf
+("%s: missing UI (0x3), got 0x%x\n",
+
+1151 
+sc
+->
+sc_if
+.
+if_xme
+, 
+c
+);
+
+1152 
+ush
+;
+
+1154 i(
+sc
+->
+sc_
+ =2 && (
+c
+ & 1) == 1) {
+
+1156 *
+sc
+->
+sc_mp
+++ = 0;
+
+1157 
+sc
+->
+sc_
+++;
+
+1158 
+sc
+->
+sc_mc
+->
+m_n
+++;
+
+1160 i(
+sc
+->
+sc_
+ =3 && (
+c
+ & 1) == 0) {
+
+1161 i(
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)
+
+1162 
+	`tf
+("%s: badroc %x\n", 
+sc
+->
+sc_if
+.
+if_xme
+,
+
+1163 (
+sc
+->
+sc_mp
+[-1] << 8+ 
+c
+);
+
+1164 
+ush
+;
+
+1168 i(++
+sc
+->
+sc_
+ > sc->
+sc_mru
+ + 
+PPP_HDRLEN
+ + 
+PPP_FCSLEN
+) {
+
+1169 i(
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)
+
+1170 
+	`tf
+("%s:ackobig\n", 
+sc
+->
+sc_if
+.
+if_xme
+);
+
+1171 
+ush
+;
+
+1175 
+m
+ = 
+sc
+->
+sc_mc
+;
+
+1176 i(
+	`M_TRAILINGSPACE
+(
+m
+) <= 0) {
+
+1177 i(
+m
+->
+m_xt
+ =
+NULL
+) {
+
+1178 
+	`pgm
+(
+sc
+);
+
+1179 i(
+m
+->
+m_xt
+ =
+NULL
+) {
+
+1180 i(
+sc
+->
+sc_ags
+ & 
+SC_DEBUG
+)
+
+1181 
+	`tf
+("%s:ow iumbufs!\n", 
+sc
+->
+sc_if
+.
+if_xme
+);
+
+1182 
+ush
+;
+
+1185 
+sc
+->
+sc_mc
+ = 
+m
+ = m->
+m_xt
+;
+
+1186 
+m
+->
+m_n
+ = 0;
+
+1187 
+m
+->
+m_da
+ = 
+	`M_DATASTART
+(m);
+
+1188 
+sc
+->
+sc_mp
+ = 
+	`mtod
+(
+m
+, *);
+
+1191 ++
+m
+->
+m_n
+;
+
+1192 *
+sc
+->
+sc_mp
+++ = 
+c
+;
+
+1193 
+sc
+->
+sc_fcs
+ = 
+	`PPP_FCS
+(sc->sc_fcs, 
+c
+);
+
+1196 
+ush
+:
+
+1197 i(!(
+sc
+->
+sc_ags
+ & 
+SC_FLUSH
+)) {
+
+1198 
+s
+ = 
+	`ty
+();
+
+1199 
+sc
+->
+sc_if
+.
+if_s
+++;
+
+1200 
+sc
+->
+sc_s
+.
+p_s
+++;
+
+1201 
+sc
+->
+sc_ags
+ |
+SC_FLUSH
+;
+
+1202 
+	`lx
+(
+s
+);
+
+1203 i(
+sc
+->
+sc_ags
+ & 
+SC_LOG_FLUSH
+)
+
+1204 
+	`ogch
+(
+sc
+, 
+c
+);
+
+1207 
+	}
+}
+
+1209 
+	#MAX_DUMP_BYTES
+ 128
+
+	)
+
+1212 
+	$ogch
+(
+p_soc
+ *
+sc
+, 
+c
+)
+
+1214 i(
+c
+ >= 0) {
+
+1215 
+sc
+->
+sc_w
+.
+buf
+[sc->
+sc_w_t
+++] = 
+c
+;
+
+1216 i(
+sc
+->
+sc_w
+.
+cou
+ < (sc->sc_w.
+buf
+))
+
+1217 
+sc
+->
+sc_w
+.
+cou
+++;
+
+1219 i(
+sc
+->
+sc_w_t
+ >(sc->
+sc_w
+.
+buf
+)
+
+1220 || (
+c
+ < 0 && 
+sc
+->
+sc_w_t
+ > 0)) {
+
+1221 i(
+sc
+->
+sc_ags
+ & (
+SC_LOG_FLUSH
+|
+SC_LOG_RAWIN
+)) {
+
+1222 
+	`tf
+("%put: ", 
+sc
+->
+sc_if
+.
+if_xme
+);
+
+1223 
+	`pdumpb
+(
+sc
+->
+sc_w
+.
+buf
+, sc->
+sc_w_t
+);
+
+1225 i(
+c
+ < 0)
+
+1226 
+sc
+->
+sc_w
+.
+cou
+ = 0;
+
+1227 
+sc
+->
+sc_w_t
+ = 0;
+
+1229 
+	}
+}
+
+1232 
+	$pdumpb
+(
+u_ch
+ *
+b
+, 
+l
+)
+
+1234 
+bf
+[3*
+MAX_DUMP_BYTES
++4];
+
+1235 *
+bp
+ = 
+bf
+;
+
+1237 
+l
+--) {
+
+1238 i(
+bp
+ >
+bf
+ + (bf) - 3) {
+
+1239 *
+bp
+++ = '>';
+
+1242 *
+bp
+++ = 
+hexdigs
+[*
+b
+ >> 4];
+
+1243 *
+bp
+++ = 
+hexdigs
+[*
+b
+++ & 0xf];
+
+1244 *
+bp
+++ = ' ';
+
+1247 *
+bp
+ = 0;
+
+1248 
+	`tf
+("%s\n", 
+bf
+);
+
+1249 
+	}
+}
+
+1252 
+	$pdumpame
+(
+p_soc
+ *
+sc
+, 
+mbuf
+ *
+m
+, 
+xm
+)
+
+1254 
+i
+,
+lcou
+,
+cycou
+,
+cou
+;
+
+1255 
+lbuf
+[16];
+
+1256 *
+da
+;
+
+1258 i(
+m
+ =
+NULL
+)
+
+1261 
+cou
+=
+m
+->
+m_n
+,
+da
+=
+	`mtod
+(m,*);m !
+NULL
+;) {
+
+1263 
+lcou
+=0;lcou < (
+lbuf
+);lcou +
+cycou
+) {
+
+1264 i(!
+cou
+) {
+
+1265 
+m
+ = m->
+m_xt
+;
+
+1266 i(
+m
+ =
+NULL
+)
+
+1268 
+cou
+ = 
+m
+->
+m_n
+;
+
+1269 
+da
+ = 
+	`mtod
+(
+m
+,*);
+
+1271 
+cycou
+ = (
+cou
+ > (
+lbuf
+)-
+lcou
+) ?
+
+1272 (
+lbuf
+)-
+lcou
+ : 
+cou
+;
+
+1273 
+	`bcy
+(
+da
+,&
+lbuf
+[
+lcou
+],
+cycou
+);
+
+1274 
+da
+ +
+cycou
+;
+
+1275 
+cou
+ -
+cycou
+;
+
+1279 
+	`tf
+("%%s:", 
+sc
+->
+sc_if
+.
+if_xme
+,
+
+1280 
+xm
+ ? "output" : "input ");
+
+1281 
+i
+=0;i<
+lcou
+;i++)
+
+1282 
+	`tf
+("%02x ",(
+u_ch
+)
+lbuf
+[
+i
+]);
+
+1283 ;
+i
+<(
+lbuf
+);i++)
+
+1284 
+	`tf
+(" ");
+
+1285 
+i
+=0;i<
+lcou
+;i++)
+
+1286 
+	`tf
+("%c",(
+lbuf
+[
+i
+] >= 040 &&
+
+1287 
+lbuf
+[
+i
+] <= 0176) ?buf[i] : '.');
+
+1288 
+	`tf
+("\n");
+
+1290 
+	}
+}
+
+	@radix.c
+
+38 
+	~<sys/cdefs.h
+>
+
+39 
+__KERNEL_RCSID
+(0, "$NetBSD:adix.c,v 1.44 2011/07/17 20:54:52 joerg Exp $");
+
+41 #ide
+_NET_RADIX_H_
+
+
+42 
+	~<sys/m.h
+>
+
+43 
+	~<sys/queue.h
+>
+
+44 
+	~<sys/kmem.h
+>
+
+45 #ifdef 
+_KERNEL
+
+
+46 
+	~"t_.h
+"
+
+48 
+	~<sys/sym.h
+>
+
+49 
+	~<sys/mloc.h
+>
+
+50 
+	#M_DONTWAIT
+ 
+M_NOWAIT
+
+
+	)
+
+51 
+	~<sys/doma.h
+>
+
+53 
+	~<dlib.h
+>
+
+55 
+	~<sys/syog.h
+>
+
+56 
+	~<t/dix.h
+>
+
+59 (*
+	t_r_t
+)(*, c *
+	tfmt
+, ...);
+
+61 
+max_keyn
+;
+
+62 
+dix_mask
+ *
+_mkli
+;
+
+63 
+dix_node_hd
+ *
+mask_hd
+;
+
+64 *
+addmask_key
+;
+
+65 c 
+nm_chs
+[] =
+
+66 {0, 0x80, 0xc0, 0xe0, 0xf0, 0xf8, 0xfc, 0x, -1
+	}
+};
+
+67 *
+	g_zos
+, *
+	g_es
+;
+
+69 
+	#_maskt
+ (
+mask_hd
+->
+h_t
+)
+
+	)
+
+71 
+_tisfs_af
+(c *, 
+dix_node
+ *, );
+
+72 
+_xobr
+(const *, const *);
+
+73 
+dix_mask
+ *
+_w_dix_mask
+(
+dix_node
+ *,
+
+74 
+dix_mask
+ *);
+
+75 
+dix_node
+ *
+_wkxt
+(dix_nod*, 
+_r_t
+,
+
+77 
+dix_node
+ *
+_wkf
+(dix_nod*, 
+_r_t
+,
+
+79 
+_nodrt
+(
+dix_node
+ *, 
+_r_t
+, *,
+
+82 
+	#SUBTREE_OPEN
+ "[ "
+
+	)
+
+83 
+	#SUBTREE_CLOSE
+ " ]"
+
+	)
+
+85 #ifde
+RN_DEBUG
+
+
+86 
+_t
+(
+dix_node_hd
+ *, 
+_r_t
+, *);
+
+123 
+dix_node
+ *
+
+124 
+	$_ch
+(
+
+125 c *
+v_g
+,
+
+126 
+dix_node
+ *
+hd
+)
+
+128 c 
+u_ch
+ * c 
+v
+ = 
+v_g
+;
+
+129 
+dix_node
+ *
+x
+;
+
+131 
+x
+ = 
+hd
+; x->
+_b
+ >= 0;) {
+
+132 i(
+x
+->
+_bmask
+ & 
+v
+[x->
+_off
+])
+
+133 
+x
+ = x->
+_r
+;
+
+135 
+x
+ = x->
+_l
+;
+
+137  
+x
+;
+
+138 
+	}
+}
+
+140 
+dix_node
+ *
+
+141 
+	$_ch_m
+(
+
+142 c *
+v_g
+,
+
+143 
+dix_node
+ *
+hd
+,
+
+144 c *
+m_g
+)
+
+146 
+dix_node
+ *
+x
+;
+
+147 c 
+u_ch
+ * c 
+v
+ = 
+v_g
+;
+
+148 c 
+u_ch
+ * c 
+m
+ = 
+m_g
+;
+
+150 
+x
+ = 
+hd
+; x->
+_b
+ >= 0;) {
+
+151 i((
+x
+->
+_bmask
+ & 
+m
+[x->
+_off
+]) &&
+
+152 (
+x
+->
+_bmask
+ & 
+v
+[x->
+_off
+]))
+
+153 
+x
+ = x->
+_r
+;
+
+155 
+x
+ = x->
+_l
+;
+
+157  
+x
+;
+
+158 
+	}
+}
+
+161 
+	$_fes
+(
+
+162 c *
+m_g
+,
+
+163 c *
+n_g
+)
+
+165 c *
+m
+ = 
+m_g
+;
+
+166 c *
+n
+ = 
+n_g
+;
+
+167 c *
+lim
+ = 
+n
+ + *(c 
+u_ch
+ *)n;
+
+168 c *
+lim2
+ = 
+lim
+;
+
+169 
+lg
+ = (*(c 
+u_ch
+ *)
+n
+++- ()(*(c u_ch *)
+m
+++);
+
+170 
+masks_e_equ
+ = 1;
+
+172 i(
+lg
+ > 0)
+
+173 
+lim
+ -
+lg
+;
+
+174 
+n
+ < 
+lim
+) {
+
+175 i(*
+n
+ & ~(*
+m
+))
+
+177 i(*
+n
+++ !*
+m
+++)
+
+178 
+masks_e_equ
+ = 0;
+
+180 
+n
+ < 
+lim2
+)
+
+181 i(*
+n
+++)
+
+183 i(
+masks_e_equ
+ && (
+lg
+ < 0))
+
+184 
+lim2
+ = 
+m
+ - 
+lg
+; m <im2; )
+
+185 i(*
+m
+++)
+
+187  !
+masks_e_equ
+;
+
+188 
+	}
+}
+
+190 
+dix_node
+ *
+
+191 
+	$_lookup
+(
+
+192 c *
+v_g
+,
+
+193 c *
+m_g
+,
+
+194 
+dix_node_hd
+ *
+hd
+)
+
+196 
+dix_node
+ *
+x
+;
+
+197 c *
+tmask
+ = 
+NULL
+;
+
+199 i(
+m_g
+) {
+
+200 i((
+x
+ = 
+	`_addmask
+(
+m_g
+, 1, 
+hd
+->
+h_t
+->
+_off
+)) == 0)
+
+201  
+NULL
+;
+
+202 
+tmask
+ = 
+x
+->
+_key
+;
+
+204 
+x
+ = 
+	`_mch
+(
+v_g
+, 
+hd
+);
+
+205 i(
+x
+ !
+NULL
+ && 
+tmask
+ != NULL) {
+
+206 
+x
+ !
+NULL
+ && x->
+_mask
+ !
+tmask
+)
+
+207 
+x
+ = x->
+_dudkey
+;
+
+209  
+x
+;
+
+210 
+	}
+}
+
+213 
+	$_tisfs_af
+(
+
+214 c *
+l
+,
+
+215 
+dix_node
+ *
+af
+,
+
+216 
+sk
+)
+
+218 c *
+
+ = 
+l
+;
+
+219 c *
+2
+ = 
+af
+->
+_key
+;
+
+220 c *
+3
+ = 
+af
+->
+_mask
+;
+
+221 c *
+lim
+;
+
+222 
+ngth
+ = 
+	`m
+(*(c 
+u_ch
+ *)
+
+, *(c u_ch *)
+2
+);
+
+224 i(
+3
+ == 0)
+
+225 
+3
+ = 
+_es
+;
+
+227 
+ngth
+ = 
+	`m
+gth, *(c 
+u_ch
+ *)
+3
+);
+
+228 
+lim
+ = 
+
+ + 
+ngth
+; 
+3
+ +
+sk
+; 
+2
+ += skip;
+
+229 
+
+ +
+sk
+; c< 
+lim
+; cp++, 
+2
+++, 
+3
+++)
+
+230 i((*
+
+ ^ *
+2
+& *
+3
+)
+
+233 
+	}
+}
+
+235 
+dix_node
+ *
+
+236 
+	$_mch
+(
+
+237 c *
+v_g
+,
+
+238 
+dix_node_hd
+ *
+hd
+)
+
+240 c * c 
+v
+ = 
+v_g
+;
+
+241 
+dix_node
+ *
+t
+ = 
+hd
+->
+h_t
+;
+
+242 
+dix_node
+ *
+t
+ = 
+t
+;
+
+243 
+dix_node
+ *
+x
+;
+
+244 
+dix_node
+ *
+ved_t
+;
+
+245 c *
+
+ = 
+v
+;
+
+246 c *
+2
+;
+
+247 c *
+lim
+;
+
+248 
+off
+ = 
+t
+->
+_off
+;
+
+249 
+vn
+ = *(c 
+u_ch
+ *)
+
+;
+
+250 
+mched_off
+;
+
+251 
+
+, 
+b
+, 
+_b
+;
+
+257 ; 
+t
+->
+_b
+ >= 0; ) {
+
+258 i(
+t
+->
+_bmask
+ & 
+
+[t->
+_off
+])
+
+259 
+t
+ =->
+_r
+;
+
+261 
+t
+ =->
+_l
+;
+
+274 i(
+t
+->
+_mask
+)
+
+275 
+vn
+ = *(c 
+u_ch
+ *)
+t
+->
+_mask
+;
+
+276 
+
+ +
+off
+; 
+2
+ = 
+t
+->
+_key
+ + off; 
+lim
+ = 
+v
+ + 
+vn
+;
+
+277 ; 
+
+ < 
+lim
+; cp++, 
+2
+++)
+
+278 i(*
+
+ !*
+2
+)
+
+279 
+1
+;
+
+284 i((
+t
+->
+_ags
+ & 
+RNF_ROOT
+&&->
+_dudkey
+)
+
+285 
+t
+ =->
+_dudkey
+;
+
+286  
+t
+;
+
+287 
+1
+:
+
+288 
+
+ = (*
+
+ ^ *
+2
+) & 0xff;
+
+289 
+b
+ = 7; (
+
+ >>= 1) > 0;)
+
+290 
+b
+--;
+
+291 
+mched_off
+ = 
+
+ - 
+v
+;
+
+292 
+b
+ +
+mched_off
+ << 3;
+
+293 
+_b
+ = -1 - 
+b
+;
+
+297 i((
+ved_t
+ = 
+t
+)->
+_mask
+ == 0)
+
+298 
+t
+ =->
+_dudkey
+;
+
+299 ; 
+t
+; =->
+_dudkey
+)
+
+305 i(
+t
+->
+_ags
+ & 
+RNF_NORMAL
+) {
+
+306 i(
+_b
+ <
+t
+->rn_b)
+
+307  
+t
+;
+
+308 } i(
+	`_tisfs_af
+(
+v
+, 
+t
+, 
+mched_off
+))
+
+309  
+t
+;
+
+310 
+t
+ = 
+ved_t
+;
+
+313 
+dix_mask
+ *
+m
+;
+
+314 
+t
+ =->
+_p
+;
+
+315 
+m
+ = 
+t
+->
+_mkli
+;
+
+316 i(
+m
+) {
+
+324 i(
+m
+->
+rm_ags
+ & 
+RNF_NORMAL
+) {
+
+325 i(
+_b
+ <
+m
+->
+rm_b
+)
+
+326  
+m
+->
+rm_af
+;
+
+328 
+off
+ = 
+	`m
+(
+t
+->
+_off
+, 
+mched_off
+);
+
+329 
+x
+ = 
+	`_ch_m
+(
+v
+, 
+t
+, 
+m
+->
+rm_mask
+);
+
+330 
+x
+ && x->
+_mask
+ !
+m
+->
+rm_mask
+)
+
+331 
+x
+ = x->
+_dudkey
+;
+
+332 i(
+x
+ && 
+	`_tisfs_af
+(
+v
+, x, 
+off
+))
+
+333  
+x
+;
+
+335 
+m
+ = m->
+rm_mkli
+;
+
+336 } 
+m
+);
+
+338 } 
+t
+ !
+t
+);
+
+339  
+NULL
+;
+
+340 
+	}
+}
+
+343 
+	$_nodrt
+(
+dix_node
+ *
+
+, 
+_r_t
+ 
+r
+, *
+g
+,
+
+344 c *
+dim
+)
+
+346 (*
+r
+)(
+g
+, "%s(%s%p:<%p><%p><%p>)",
+
+347 
+dim
+, ((*)
+
+ =
+g
+? "*" : "",n,n->
+_p
+,
+
+348 
+
+->
+_l
+,n->
+_r
+);
+
+349 
+	}
+}
+
+351 #ifde
+RN_DEBUG
+
+
+352 
+	g_debug
+ = 1;
+
+355 
+	$_dbg_t
+(*
+g
+, c *
+fmt
+, ...)
+
+357 
+va_li
+ 
+
+;
+
+359 
+	`va_t
+(
+
+, 
+fmt
+);
+
+360 
+	`vlog
+(
+LOG_DEBUG
+, 
+fmt
+, 
+
+);
+
+361 
+	`va_d
+(
+
+);
+
+362 
+	}
+}
+
+365 
+	$_t
+(
+dix_node_hd
+ *
+h
+, 
+_r_t
+ 
+r
+, *
+g
+)
+
+367 
+dix_node
+ *
+dup
+, *
+
+;
+
+368 c *
+dim
+;
+
+370 i(
+r
+ =
+NULL
+)
+
+373 
+
+ = 
+	`_wkf
+(
+h
+->
+h_t
+, 
+r
+, 
+g
+);
+
+376 
+dim
+ = "";
+
+377 
+dup
+ = 
+
+; du!
+NULL
+; dudup->
+_dudkey
+) {
+
+378 i((
+dup
+->
+_ags
+ & 
+RNF_ROOT
+) != 0)
+
+380 
+	`_nodrt
+(
+dup
+, 
+r
+, 
+g
+, 
+dim
+);
+
+381 
+dim
+ = ", ";
+
+383 
+
+ = 
+	`_wkxt
+n, 
+r
+, 
+g
+);
+
+384 i(
+
+->
+_ags
+ & 
+RNF_ROOT
+)
+
+388 
+	}
+}
+
+390 
+	#av
+(
+__hd
+, 
+__
+
+	`_t
+((__hd), 
+_dbg_t
+, (__))
+
+	)
+
+393 
+dix_node
+ *
+
+394 
+	$_w
+(
+
+395 c *
+v
+,
+
+396 
+b
+,
+
+397 
+dix_node
+ 
+nodes
+[2])
+
+399 
+dix_node
+ *
+
+ = 
+nodes
+;
+
+400 
+dix_node
+ *
+t
+ = 
+
+ + 1;
+
+401 
+t
+->
+_b
+ = 
+b
+;->
+_bmask
+ = 0x80 >> (b & 7);
+
+402 
+t
+->
+_l
+ = 
+
+;->
+_off
+ = 
+b
+ >> 3;
+
+403 
+
+->
+_b
+ = -1;t->
+_key
+ = 
+v
+;t->
+_p
+ = 
+t
+;
+
+404 
+
+->
+_ags
+ = 
+t
+->_ag
+RNF_ACTIVE
+;
+
+405  
+t
+;
+
+406 
+	}
+}
+
+408 
+dix_node
+ *
+
+409 
+	$_
+(
+
+410 c *
+v_g
+,
+
+411 
+dix_node_hd
+ *
+hd
+,
+
+412 *
+dury
+,
+
+413 
+dix_node
+ 
+nodes
+[2])
+
+415 
+dix_node
+ *
+t
+ = 
+hd
+->
+h_t
+;
+
+416 
+dix_node
+ *
+t
+ = 
+	`_ch
+(
+v_g
+, 
+t
+);
+
+417 
+dix_node
+ *
+
+;
+
+418 c *
+v
+ = 
+v_g
+;
+
+419 
+hd_off
+ = 
+t
+->
+_off
+;
+
+420 
+vn
+ = *((c 
+u_ch
+ *)
+v
+);
+
+421 c *
+
+ = 
+v
+ + 
+hd_off
+;
+
+422 
+b
+;
+
+427 c *
+2
+ = 
+t
+->
+_key
+ + 
+hd_off
+;
+
+428 c *
+lim
+ = 
+v
+ + 
+vn
+;
+
+429 
+cmp_s
+;
+
+431 
+
+ < 
+lim
+)
+
+432 i(*
+2
+++ !*
+
+++)
+
+433 
+1
+;
+
+434 *
+dury
+ = 1;
+
+435  
+t
+;
+
+436 
+1
+:
+
+437 *
+dury
+ = 0;
+
+438 
+cmp_s
+ = (
+
+[-1] ^ 
+2
+[-1]) & 0xff;
+
+439 
+b
+ = (
+
+ - 
+v
+<< 3; 
+cmp_s
+; b--)
+
+440 
+cmp_s
+ >>= 1;
+
+443 
+dix_node
+ *
+p
+, *
+x
+ = 
+t
+;
+
+444 
+
+ = 
+v
+;
+
+446 
+p
+ = 
+x
+;
+
+447 i(
+
+[
+x
+->
+_off
+] & x->
+_bmask
+)
+
+448 
+x
+ = x->
+_r
+;
+
+449 
+x
+ = x->
+_l
+;
+
+450 } 
+b
+ > (
+x
+->
+_b
+);
+
+451 #ifde
+RN_DEBUG
+
+
+452 i(
+_debug
+)
+
+453 
+	`log
+(
+LOG_DEBUG
+, "%s: Gog In:\n", 
+__func__
+), 
+	`av
+(
+hd
+, 
+p
+);
+
+455 
+t
+ = 
+	`_w
+(
+v_g
+, 
+b
+, 
+nodes
+); 
+
+ =->
+_l
+;
+
+456 i((
+
+[
+p
+->
+_off
+] &->
+_bmask
+) == 0)
+
+457 
+p
+->
+_l
+ = 
+t
+;
+
+459 
+p
+->
+_r
+ = 
+t
+;
+
+460 
+x
+->
+_p
+ = 
+t
+;->_
+p
+;
+
+461 i((
+
+[
+t
+->
+_off
+] &->
+_bmask
+) == 0) {
+
+462 
+t
+->
+_r
+ = 
+x
+;
+
+464 
+t
+->
+_r
+ = 
+
+;->
+_l
+ = 
+x
+;
+
+466 #ifde
+RN_DEBUG
+
+
+467 i(
+_debug
+) {
+
+468 
+	`log
+(
+LOG_DEBUG
+, "%s: Comg Out:\n", 
+__func__
+),
+
+469 
+	`av
+(
+hd
+, 
+p
+);
+
+473  
+
+;
+
+474 
+	}
+}
+
+476 
+dix_node
+ *
+
+477 
+	$_addmask
+(
+
+478 c *
+n_g
+,
+
+479 
+ch
+,
+
+480 
+sk
+)
+
+482 c *
+tmask
+ = 
+n_g
+;
+
+483 c *
+
+;
+
+484 c *
+lim
+;
+
+485 
+dix_node
+ *
+x
+;
+
+486 
+dix_node
+ *
+ved_x
+;
+
+487 
+b
+ = 0, 
+mn
+, 
+j
+;
+
+488 
+maskduid
+, 
+m0
+, 
+im
+;
+
+489 
+_zd
+ = 0;
+
+491 i((
+mn
+ = *(c 
+u_ch
+ *)
+tmask
+> 
+max_keyn
+)
+
+492 
+mn
+ = 
+max_keyn
+;
+
+493 i(
+sk
+ == 0)
+
+494 
+sk
+ = 1;
+
+495 i(
+mn
+ <
+sk
+)
+
+496  
+mask_hd
+->
+h_nodes
+;
+
+497 i(
+sk
+ > 1)
+
+498 
+	`memmove
+(
+addmask_key
+ + 1, 
+_es
+ + 1, 
+sk
+ - 1);
+
+499 i((
+m0
+ = 
+mn
+> 
+sk
+)
+
+500 
+	`memmove
+(
+addmask_key
+ + 
+sk
+, 
+tmask
+ + sk, 
+mn
+ - skip);
+
+504 
+
+ = 
+addmask_key
+ + 
+mn
+; (cp >ddmask_key) && cp[-1] == 0;)
+
+505 
+
+--;
+
+506 
+mn
+ = 
+
+ - 
+addmask_key
+;
+
+507 i(
+mn
+ <
+sk
+) {
+
+508 i(
+m0
+ >
+_zd
+)
+
+509 
+_zd
+ = 
+mn
+;
+
+510  
+mask_hd
+->
+h_nodes
+;
+
+512 i(
+m0
+ < 
+_zd
+)
+
+513 
+	`memt
+(
+addmask_key
+ + 
+m0
+, 0, 
+_zd
+ - m0);
+
+514 *
+addmask_key
+ = 
+_zd
+ = 
+mn
+;
+
+515 
+x
+ = 
+	`_ch
+(
+addmask_key
+, 
+_maskt
+);
+
+516 i(
+	`memcmp
+(
+addmask_key
+, 
+x
+->
+_key
+, 
+mn
+) != 0)
+
+517 
+x
+ = 0;
+
+518 i(
+x
+ || 
+ch
+)
+
+519  
+x
+;
+
+520 
+	`R_Mloc
+(
+x
+, 
+dix_node
+ *, 
+max_keyn
+ + 2 *  (*x));
+
+521 i((
+ved_x
+ = 
+x
+=
+NULL
+)
+
+522  
+NULL
+;
+
+523 
+	`memt
+(
+x
+, 0, 
+max_keyn
+ + 2 *  (*x));
+
+524 
+
+ = 
+tmask
+ = (*)(
+x
+ + 2);
+
+525 
+	`memmove
+(
+x
+ + 2, 
+addmask_key
+, 
+mn
+);
+
+526 
+x
+ = 
+	`_
+(
+
+, 
+mask_hd
+, &
+maskduid
+, x);
+
+527 i(
+maskduid
+) {
+
+528 
+	`log
+(
+LOG_ERR
+, "rn_addmask: mask impossiblylready inree\n");
+
+529 
+	`Fe
+(
+ved_x
+);
+
+530  
+x
+;
+
+535 
+lim
+ = 
+tmask
+ + 
+mn
+; 
+im
+ = 1;
+
+536 
+
+ = 
+tmask
+ + 
+sk
+; ( < 
+lim
+&& *(c 
+u_ch
+ *)cp == 0xff;)
+
+537 
+
+++;
+
+538 i(
+
+ !
+lim
+) {
+
+539 
+j
+ = 0x80; (j & *
+
+) != 0; j >>= 1)
+
+540 
+b
+++;
+
+541 i(*
+
+ !
+nm_chs
+[
+b
+] || c!(
+lim
+ - 1))
+
+542 
+im
+ = 0;
+
+544 
+b
+ +(
+
+ - 
+tmask
+) << 3;
+
+545 
+x
+->
+_b
+ = -1 - 
+b
+;
+
+546 i(
+im
+)
+
+547 
+x
+->
+_ags
+ |
+RNF_NORMAL
+;
+
+548  
+x
+;
+
+549 
+	}
+}
+
+552 
+	$_xobr
+(
+
+553 c *
+m_g
+,
+
+554 c *
+n_g
+)
+
+556 c 
+u_ch
+ *
+mp
+ = 
+m_g
+;
+
+557 c 
+u_ch
+ *
+
+ = 
+n_g
+;
+
+558 c 
+u_ch
+ *
+lim
+;
+
+560 i(*
+mp
+ > *
+
+)
+
+562 i(*
+mp
+ =*
+
+)
+
+563 
+lim
+ = 
+mp
+ + *mp; mp <im;)
+
+564 i(*
+mp
+++ > *
+
+++)
+
+567 
+	}
+}
+
+569 
+dix_mask
+ *
+
+570 
+	$_w_dix_mask
+(
+
+571 
+dix_node
+ *
+
+,
+
+572 
+dix_mask
+ *
+xt
+)
+
+574 
+dix_mask
+ *
+m
+;
+
+576 
+	`MKG
+(
+m
+);
+
+577 i(
+m
+ =
+NULL
+) {
+
+578 
+	`log
+(
+LOG_ERR
+, "Mask forouteotntered\n");
+
+579  
+NULL
+;
+
+581 
+	`memt
+(
+m
+, 0, (*m));
+
+582 
+m
+->
+rm_b
+ = 
+
+->
+_b
+;
+
+583 
+m
+->
+rm_ags
+ = 
+
+->
+_ags
+;
+
+584 i(
+
+->
+_ags
+ & 
+RNF_NORMAL
+)
+
+585 
+m
+->
+rm_af
+ = 
+
+;
+
+587 
+m
+->
+rm_mask
+ = 
+
+->
+_mask
+;
+
+588 
+m
+->
+rm_mkli
+ = 
+xt
+;
+
+589 
+
+->
+_mkli
+ = 
+m
+;
+
+590  
+m
+;
+
+591 
+	}
+}
+
+593 
+dix_node
+ *
+
+594 
+	$_addrou
+(
+
+595 c *
+v_g
+,
+
+596 c *
+n_g
+,
+
+597 
+dix_node_hd
+ *
+hd
+,
+
+598 
+dix_node
+ 
+nodes
+[2])
+
+600 c *
+v
+ = 
+v_g
+, *
+tmask
+ = 
+n_g
+;
+
+601 
+dix_node
+ *
+t
+, *
+x
+ = 
+NULL
+, *
+
+;
+
+602 
+dix_node
+ *
+ved_
+, *
+t
+ = 
+hd
+->
+h_t
+;
+
+603 
+b
+ = 0, 
+b_af
+ = 0;
+
+604 
+keyduid
+;
+
+605 c *
+mmask
+;
+
+606 
+dix_mask
+ *
+m
+, **
+mp
+;
+
+615 i(
+tmask
+ !
+NULL
+) {
+
+616 i((
+x
+ = 
+	`_addmask
+(
+tmask
+, 0, 
+t
+->
+_off
+)=
+NULL
+)
+
+617  
+NULL
+;
+
+618 
+b_af
+ = 
+x
+->
+_b
+;
+
+619 
+b
+ = -1 - 
+x
+->
+_b
+;
+
+620 
+tmask
+ = 
+x
+->
+_key
+;
+
+625 
+ved_
+ = 
+
+ = 
+	`_
+(
+v
+, 
+hd
+, &
+keyduid
+, 
+nodes
+);
+
+626 i(
+keyduid
+) {
+
+627 
+t
+ = 
+
+;!
+NULL
+; =t,->
+_dudkey
+) {
+
+628 i(
+
+->
+_mask
+ =
+tmask
+)
+
+629  
+NULL
+;
+
+630 i(
+tmask
+ =
+NULL
+ ||
+
+631 (
+
+->
+_mask
+ !
+NULL
+ &&
+
+632 (
+b_af
+ < 
+
+->
+_b
+ ||
+
+633 
+	`_fes
+(
+tmask
+, 
+
+->
+_mask
+) ||
+
+634 
+	`_xobr
+(
+tmask
+, 
+
+->
+_mask
+))))
+
+650 i(
+
+ =
+ved_
+) {
+
+651 
+dix_node
+ *
+xx
+ = 
+x
+;
+
+653 (
+
+ = 
+nodes
+)->
+_dudkey
+ = 
+t
+;
+
+654 
+
+->
+_ags
+ = 
+t
+->rn_flags;
+
+655 
+
+->
+_p
+ = 
+x
+ = 
+t
+->rn_p;
+
+656 
+t
+->
+_p
+ = 
+
+;
+
+657 i(
+x
+->
+_l
+ =
+t
+)
+
+658 
+x
+->
+_l
+ = 
+
+;
+
+660 
+x
+->
+_r
+ = 
+
+;
+
+661 
+ved_
+ = 
+
+;
+
+662 
+x
+ = 
+xx
+;
+
+664 (
+
+ = 
+nodes
+)->
+_dudkey
+ = 
+t
+->rn_dupedkey;
+
+665 
+t
+->
+_dudkey
+ = 
+
+;
+
+666 
+
+->
+_p
+ = 
+t
+;
+
+667 i(
+
+->
+_dudkey
+)
+
+668 
+
+->
+_dudkey
+->
+_p
+ =t;
+
+670 
+
+->
+_key
+ = 
+v
+;
+
+671 
+
+->
+_b
+ = -1;
+
+672 
+
+->
+_ags
+ = 
+RNF_ACTIVE
+;
+
+677 i(
+tmask
+ !
+NULL
+) {
+
+678 
+
+->
+_mask
+ = 
+tmask
+;
+
+679 
+
+->
+_b
+ = 
+x
+->rn_b;
+
+680 
+
+->
+_ags
+ |
+x
+->_ag& 
+RNF_NORMAL
+;
+
+682 
+t
+ = 
+ved_
+->
+_p
+;
+
+683 i(
+keyduid
+)
+
+684 
+2
+;
+
+685 
+b_af
+ = -1 - 
+t
+->
+_b
+;
+
+686 i(
+t
+->
+_r
+ =
+ved_
+)
+
+687 
+x
+ = 
+t
+->
+_l
+;
+
+689 
+x
+ = 
+t
+->
+_r
+;
+
+691 i(
+x
+->
+_b
+ < 0) {
+
+692 
+mp
+ = &
+t
+->
+_mkli
+; 
+x
+ !
+NULL
+; x = x->
+_dudkey
+) {
+
+693 i(
+x
+->
+_mask
+ !
+NULL
+ && x->
+_b
+ >
+b_af
+ &&
+
+694 
+x
+->
+_mkli
+ =
+NULL
+) {
+
+695 *
+mp
+ = 
+m
+ = 
+	`_w_dix_mask
+(
+x
+, 
+NULL
+);
+
+696 i(
+m
+ !
+NULL
+)
+
+697 
+mp
+ = &
+m
+->
+rm_mkli
+;
+
+700 } i(
+x
+->
+_mkli
+ !
+NULL
+) {
+
+704 
+mp
+ = &
+x
+->
+_mkli
+; (
+m
+ = *mp!
+NULL
+; m&m->
+rm_mkli
+)
+
+705 i(
+m
+->
+rm_b
+ >
+b_af
+)
+
+707 
+t
+->
+_mkli
+ = 
+m
+;
+
+708 *
+mp
+ = 
+NULL
+;
+
+710 
+2
+:
+
+712 i(
+tmask
+ =
+NULL
+ || 
+b
+ > 
+t
+->
+_b
+)
+
+713  
+
+;
+
+714 
+b_af
+ = 
+
+->
+_b
+;
+
+716 
+x
+ = 
+t
+;
+
+717 
+t
+ =->
+_p
+;
+
+718 } 
+b
+ <
+t
+->
+_b
+ && 
+x
+ !
+t
+);
+
+725 
+mp
+ = &
+x
+->
+_mkli
+; (
+m
+ = *mp!
+NULL
+; m&m->
+rm_mkli
+) {
+
+726 i(
+m
+->
+rm_b
+ < 
+b_af
+)
+
+728 i(
+m
+->
+rm_b
+ > 
+b_af
+)
+
+730 i(
+m
+->
+rm_ags
+ & 
+RNF_NORMAL
+) {
+
+731 
+mmask
+ = 
+m
+->
+rm_af
+->
+_mask
+;
+
+732 i(
+
+->
+_ags
+ & 
+RNF_NORMAL
+) {
+
+733 
+	`log
+(
+LOG_ERR
+, "Non-uniqueormaloute,"
+
+735  
+
+;
+
+738 
+mmask
+ = 
+m
+->
+rm_mask
+;
+
+739 i(
+mmask
+ =
+tmask
+) {
+
+740 
+m
+->
+rm_fs
+++;
+
+741 
+
+->
+_mkli
+ = 
+m
+;
+
+742  
+
+;
+
+744 i(
+	`_fes
+(
+tmask
+, 
+mmask
+|| 
+	`_xobr
+(netmask, mmask))
+
+747 *
+mp
+ = 
+	`_w_dix_mask
+(
+
+, *mp);
+
+748  
+
+;
+
+749 
+	}
+}
+
+751 
+dix_node
+ *
+
+752 
+	$_de1
+(
+
+753 c *
+v_g
+,
+
+754 c *
+tmask_g
+,
+
+755 
+dix_node_hd
+ *
+hd
+,
+
+756 
+dix_node
+ *
+
+)
+
+758 
+dix_node
+ *
+t
+, *
+p
+, *
+x
+, *
+
+;
+
+759 
+dix_mask
+ *
+m
+, *
+ved_m
+, **
+mp
+;
+
+760 
+dix_node
+ *
+dudkey
+, *
+ved_
+, *
+t
+;
+
+761 c *
+v
+, *
+tmask
+;
+
+762 
+b
+, 
+hd_off
+, 
+vn
+;
+
+764 
+v
+ = 
+v_g
+;
+
+765 
+tmask
+ = 
+tmask_g
+;
+
+766 
+x
+ = 
+hd
+->
+h_t
+;
+
+767 
+
+ = 
+	`_ch
+(
+v
+, 
+x
+);
+
+768 
+hd_off
+ = 
+x
+->
+_off
+;
+
+769 
+vn
+ = *(c 
+u_ch
+ *)
+v
+;
+
+770 
+ved_
+ = 
+
+;
+
+771 
+t
+ = 
+x
+;
+
+772 i(
+
+ =
+NULL
+ ||
+
+773 
+	`memcmp
+(
+v
+ + 
+hd_off
+, 
+
+->
+_key
+ + hd_off, 
+vn
+ - head_off) != 0)
+
+774  
+NULL
+;
+
+778 i(
+tmask
+ !
+NULL
+) {
+
+779 i((
+x
+ = 
+	`_addmask
+(
+tmask
+, 1, 
+hd_off
+)=
+NULL
+)
+
+780  
+NULL
+;
+
+781 
+tmask
+ = 
+x
+->
+_key
+;
+
+782 
+
+->
+_mask
+ !
+tmask
+)
+
+783 i((
+
+ =t->
+_dudkey
+=
+NULL
+)
+
+784  
+NULL
+;
+
+786 i(
+
+->
+_mask
+ =
+NULL
+ || (
+ved_m
+ = 
+m
+ =t->
+_mkli
+) == NULL)
+
+787 
+1
+;
+
+788 i(
+
+->
+_ags
+ & 
+RNF_NORMAL
+) {
+
+789 i(
+m
+->
+rm_af
+ !
+
+ || m->
+rm_fs
+ > 0) {
+
+790 
+	`log
+(
+LOG_ERR
+, "rn_delete: inconsistentnnotation\n");
+
+791  
+NULL
+;
+
+794 i(
+m
+->
+rm_mask
+ !
+
+->
+_mask
+) {
+
+795 
+	`log
+(
+LOG_ERR
+, "rn_delete: inconsistentnnotation\n");
+
+796 
+1
+;
+
+798 i(--
+m
+->
+rm_fs
+ >= 0)
+
+799 
+1
+;
+
+801 
+b
+ = -1 - 
+
+->
+_b
+;
+
+802 
+t
+ = 
+ved_
+->
+_p
+;
+
+803 i(
+b
+ > 
+t
+->
+_b
+)
+
+804 
+1
+;
+
+806 
+x
+ = 
+t
+;
+
+807 
+t
+ =->
+_p
+;
+
+808 } 
+b
+ <
+t
+->
+_b
+ && 
+x
+ !
+t
+);
+
+809 
+mp
+ = &
+x
+->
+_mkli
+; (
+m
+ = *mp!
+NULL
+; m&m->
+rm_mkli
+) {
+
+810 i(
+m
+ =
+ved_m
+) {
+
+811 *
+mp
+ = 
+m
+->
+rm_mkli
+;
+
+812 
+	`MKFe
+(
+m
+);
+
+816 i(
+m
+ =
+NULL
+) {
+
+817 
+	`log
+(
+LOG_ERR
+, "rn_delete: couldn't find ournnotation\n");
+
+818 i(
+
+->
+_ags
+ & 
+RNF_NORMAL
+)
+
+819  
+NULL
+;
+
+821 
+1
+:
+
+825 i(
+
+->
+_ags
+ & 
+RNF_ROOT
+)
+
+826  
+NULL
+;
+
+827 #ifde
+RN_DEBUG
+
+
+828 i(
+_debug
+)
+
+829 
+	`log
+(
+LOG_DEBUG
+, "%s: Gog In:\n", 
+__func__
+), 
+	`av
+(
+hd
+, 
+
+);
+
+831 
+t
+ = 
+
+->
+_p
+;
+
+832 
+dudkey
+ = 
+ved_
+->
+_dudkey
+;
+
+833 i(
+dudkey
+ !
+NULL
+) {
+
+838 i(
+
+ =
+ved_
+) {
+
+839 
+x
+ = 
+dudkey
+;
+
+840 
+x
+->
+_p
+ = 
+t
+;
+
+841 i(
+t
+->
+_l
+ =
+
+)
+
+842 
+t
+->
+_l
+ = 
+x
+;
+
+844 
+t
+->
+_r
+ = 
+x
+;
+
+847 
+x
+ = 
+p
+ = 
+ved_
+;
+
+848 
+p
+ !
+NULL
+ &&->
+_dudkey
+ !
+
+;)
+
+849 
+p
+ =->
+_dudkey
+;
+
+850 i(
+p
+ !
+NULL
+) {
+
+851 
+p
+->
+_dudkey
+ = 
+
+->rn_dupedkey;
+
+852 i(
+
+->
+_dudkey
+ !
+NULL
+)
+
+853 
+
+->
+_dudkey
+->
+_p
+ = 
+p
+;
+
+855 
+	`log
+(
+LOG_ERR
+, "rn_delete: couldn't find us\n");
+
+857 
+t
+ = 
+
+ + 1;
+
+858 i(
+t
+->
+_ags
+ & 
+RNF_ACTIVE
+) {
+
+859 *++
+x
+ = *
+t
+;
+
+860 
+p
+ = 
+t
+->
+_p
+;
+
+861 i(
+p
+->
+_l
+ =
+t
+)
+
+862 
+p
+->
+_l
+ = 
+x
+;
+
+864 
+p
+->
+_r
+ = 
+x
+;
+
+865 
+x
+->
+_l
+->
+_p
+ = x;
+
+866 
+x
+->
+_r
+->
+_p
+ = x;
+
+868 
+out
+;
+
+870 i(
+t
+->
+_l
+ =
+
+)
+
+871 
+x
+ = 
+t
+->
+_r
+;
+
+873 
+x
+ = 
+t
+->
+_l
+;
+
+874 
+p
+ = 
+t
+->
+_p
+;
+
+875 i(
+p
+->
+_r
+ =
+t
+)
+
+876 
+p
+->
+_r
+ = 
+x
+;
+
+878 
+p
+->
+_l
+ = 
+x
+;
+
+879 
+x
+->
+_p
+ = 
+p
+;
+
+883 i(
+t
+->
+_mkli
+ =
+NULL
+)
+
+885 i(
+x
+->
+_b
+ >= 0) {
+
+886 
+mp
+ = &
+x
+->
+_mkli
+; (
+m
+ = *mp!
+NULL
+; m&m->
+rm_mkli
+)
+
+888 *
+mp
+ = 
+t
+->
+_mkli
+;
+
+893 
+m
+ = 
+t
+->
+_mkli
+;
+
+894 
+m
+ !
+NULL
+ && 
+x
+ != NULL;
+
+895 
+x
+ = x->
+_dudkey
+) {
+
+896 i(
+m
+ =
+x
+->
+_mkli
+) {
+
+897 
+dix_mask
+ *
+mm
+ = 
+m
+->
+rm_mkli
+;
+
+898 
+x
+->
+_mkli
+ = 
+NULL
+;
+
+899 i(--(
+m
+->
+rm_fs
+) < 0)
+
+900 
+	`MKFe
+(
+m
+);
+
+901 
+m
+ = 
+mm
+;
+
+904 i(
+m
+ !
+NULL
+) {
+
+905 
+	`log
+(
+LOG_ERR
+, "rn_delete: Orphaned Mask %pt %p\n",
+
+906 
+m
+, 
+x
+);
+
+912 
+x
+ = 
+
+ + 1;
+
+913 i(
+t
+ !
+x
+) {
+
+914 *
+t
+ = *
+x
+;
+
+915 
+t
+->
+_l
+->
+_p
+ =;
+
+916 
+t
+->
+_r
+->
+_p
+ =;
+
+917 
+p
+ = 
+x
+->
+_p
+;
+
+918 i(
+p
+->
+_l
+ =
+x
+)
+
+919 
+p
+->
+_l
+ = 
+t
+;
+
+921 
+p
+->
+_r
+ = 
+t
+;
+
+923 
+out
+:
+
+924 #ifde
+RN_DEBUG
+
+
+925 i(
+_debug
+) {
+
+926 
+	`log
+(
+LOG_DEBUG
+, "%s: Comg Out:\n", 
+__func__
+),
+
+927 
+	`av
+(
+hd
+, 
+
+);
+
+930 
+
+->
+_ags
+ &~
+RNF_ACTIVE
+;
+
+931 
+
+[1].
+_ags
+ &~
+RNF_ACTIVE
+;
+
+932  
+
+;
+
+933 
+	}
+}
+
+935 
+dix_node
+ *
+
+936 
+	$_de
+(
+
+937 c *
+v_g
+,
+
+938 c *
+tmask_g
+,
+
+939 
+dix_node_hd
+ *
+hd
+)
+
+941  
+	`_de1
+(
+v_g
+, 
+tmask_g
+, 
+hd
+, 
+NULL
+);
+
+942 
+	}
+}
+
+944 
+dix_node
+ *
+
+945 
+	$_wkxt
+(
+dix_node
+ *
+
+, 
+_r_t
+ 
+r
+, *
+g
+)
+
+948 
+
+->
+_p
+->
+_r
+ = && (->
+_ags
+ & 
+RNF_ROOT
+) == 0) {
+
+949 i(
+r
+ !
+NULL
+)
+
+950 (*
+r
+)(
+g
+, 
+SUBTREE_CLOSE
+);
+
+951 
+
+ =n->
+_p
+;
+
+953 i(
+r
+)
+
+954 
+	`_nodrt
+(
+
+->
+_p
+, 
+r
+, 
+g
+, "");
+
+956 
+
+ =n->
+_p
+->
+_r
+;n->
+_b
+ >= 0;) {
+
+957 i(
+r
+ !
+NULL
+)
+
+958 (*
+r
+)(
+g
+, 
+SUBTREE_OPEN
+);
+
+959 
+
+ =n->
+_l
+;
+
+961  
+
+;
+
+962 
+	}
+}
+
+964 
+dix_node
+ *
+
+965 
+	$_wkf
+(
+dix_node
+ *
+
+, 
+_r_t
+ 
+r
+, *
+g
+)
+
+968 
+
+->
+_b
+ >= 0) {
+
+969 i(
+r
+ !
+NULL
+)
+
+970 (*
+r
+)(
+g
+, 
+SUBTREE_OPEN
+);
+
+971 
+
+ =n->
+_l
+;
+
+973  
+
+;
+
+974 
+	}
+}
+
+977 
+_wk
+(
+
+978 
+dix_node_hd
+ *
+h
+,
+
+979 (*
+f
+)(
+dix_node
+ *, *),
+
+980 *
+w
+)
+
+982 
+r
+;
+
+983 
+dix_node
+ *
+ba
+, *
+xt
+, *
+
+;
+
+989 
+
+ = 
+	`_wkf
+(
+h
+->
+h_t
+, 
+NULL
+, NULL);
+
+991 
+ba
+ = 
+
+;
+
+992 
+xt
+ = 
+	`_wkxt
+(
+
+, 
+NULL
+, NULL);
+
+994 (
+
+ = 
+ba
+!
+NULL
+) {
+
+995 
+ba
+ = 
+
+->
+_dudkey
+;
+
+996 i(!(
+
+->
+_ags
+ & 
+RNF_ROOT
+&& (
+r
+ = (*
+f
+)n, 
+w
+)))
+
+997  
+r
+;
+
+999 
+
+ = 
+xt
+;
+
+1000 i(
+
+->
+_ags
+ & 
+RNF_ROOT
+)
+
+1004 
+	}
+}
+
+1006 
+	sday
+ {
+
+1007 **
+	mhd
+;
+
+1008 
+	moff
+;
+
+1009 
+SLIST_ENTRY
+(
+day
+
+	ms
+;
+
+1011 
+	$SLIST_HEAD
+(, 
+day
+
+days
+ = 
+	`SLIST_HEAD_INITIALIZER
+(
+dayhds
+);
+
+1012 
+dix_lized
+;
+
+1019 
+	$_dayed
+(**
+hd
+, 
+off
+)
+
+1021 
+day
+ *
+di
+;
+
+1023 
+	`KASSERT
+(
+dix_lized
+ == 0);
+
+1025 
+di
+ = 
+	`kmem_loc
+((*di), 
+KM_SLEEP
+);
+
+1026 
+di
+->
+hd
+ = head;
+
+1027 
+di
+->
+off
+ = off;
+
+1028 
+	`SLIST_INSERT_HEAD
+(&
+days
+, 
+di
+, 
+s
+);
+
+1029 
+	}
+}
+
+1032 
+	$_hd
+(**
+hd
+, 
+off
+)
+
+1034 
+dix_node_hd
+ *
+h
+;
+
+1036 i(*
+hd
+ !
+NULL
+)
+
+1038 
+	`R_Mloc
+(
+h
+, 
+dix_node_hd
+ *,  (*rnh));
+
+1039 i(
+h
+ =
+NULL
+)
+
+1041 *
+hd
+ = 
+h
+;
+
+1042  
+	`_hd0
+(
+h
+, 
+off
+);
+
+1043 
+	}
+}
+
+1046 
+	$_hd0
+(
+dix_node_hd
+ *
+h
+, 
+off
+)
+
+1048 
+dix_node
+ *
+t
+;
+
+1049 
+dix_node
+ *
+
+;
+
+1050 
+dix_node
+ *
+t
+;
+
+1052 
+	`memt
+(
+h
+, 0, (*rnh));
+
+1053 
+t
+ = 
+	`_w
+(
+_zos
+, 
+off
+, 
+h
+->
+h_nodes
+);
+
+1054 
+t
+ = 
+h
+->
+h_nodes
+ + 2;
+
+1055 
+t
+->
+_r
+ = 
+t
+;
+
+1056 
+t
+->
+_p
+ =;
+
+1057 
+
+ = 
+t
+->
+_l
+;
+
+1058 
+
+->
+_ags
+ = 
+t
+->_ag
+RNF_ROOT
+ | 
+RNF_ACTIVE
+;
+
+1059 
+
+->
+_b
+ = -1 - 
+off
+;
+
+1060 *
+t
+ = *
+
+;
+
+1061 
+t
+->
+_key
+ = 
+_es
+;
+
+1062 
+h
+->
+h_addaddr
+ = 
+_addrou
+;
+
+1063 
+h
+->
+h_daddr
+ = 
+_de
+;
+
+1064 
+h
+->
+h_mchaddr
+ = 
+_mch
+;
+
+1065 
+h
+->
+h_lookup
+ = 
+_lookup
+;
+
+1066 
+h
+->
+h_t
+ = 
+t
+;
+
+1068 
+	}
+}
+
+1071 
+	$_
+()
+
+1073 *
+
+, *
+lim
+;
+
+1074 
+day
+ *
+di
+;
+
+1075 #ifde
+_KERNEL
+
+
+1076 
+doma
+ *
+dp
+;
+
+1078 i(
+dix_lized
+)
+
+1079 
+	`nic
+("radixlready initialized");
+
+1080 
+dix_lized
+ = 1;
+
+1082 
+	`DOMAIN_FOREACH
+(
+dp
+) {
+
+1083 i(
+dp
+->
+dom_maxkey
+ > 
+max_keyn
+)
+
+1084 
+max_keyn
+ = 
+dp
+->
+dom_maxkey
+;
+
+1087 i(
+max_keyn
+ == 0) {
+
+1088 
+	`log
+(
+LOG_ERR
+,
+
+1093 
+	`R_Mloc
+(
+_zos
+, *, 3 * 
+max_keyn
+);
+
+1094 i(
+_zos
+ =
+NULL
+)
+
+1095 
+	`nic
+("rn_init");
+
+1096 
+	`memt
+(
+_zos
+, 0, 3 * 
+max_keyn
+);
+
+1097 
+_es
+ = 
+
+ = 
+_zos
+ + 
+max_keyn
+;
+
+1098 
+addmask_key
+ = 
+lim
+ = 
+_es
+ + 
+max_keyn
+;
+
+1099 
+
+ < 
+lim
+)
+
+1100 *
+
+++ = -1;
+
+1101 i(
+	`_hd
+((*)&
+mask_hd
+, 0) == 0)
+
+1102 
+	`nic
+("rn_init 2");
+
+1104 (
+di
+ = 
+	`SLIST_FIRST
+(&
+days
+)!
+NULL
+) {
+
+1105 i(!
+	`_hd
+(
+di
+->
+hd
+, di->
+off
+))
+
+1106 
+	`nic
+("delayedn_inithead failed");
+
+1107 
+	`SLIST_REMOVE_HEAD
+(&
+days
+, 
+s
+);
+
+1108 
+	`kmem_
+(
+di
+, (*di));
+
+1110 
+	}
+}
+
+	@radix.h
+
+34 #ide
+_NET_RADIX_H_
+
+
+35 
+	#_NET_RADIX_H_
+
+
+	)
+
+41 
+	sdix_node
+ {
+
+42 
+dix_mask
+ *
+	m_mkli
+;
+
+43 
+dix_node
+ *
+	m_p
+;
+
+44 
+	m_b
+;
+
+45 
+	m_bmask
+;
+
+46 
+u_ch
+ 
+	m_ags
+;
+
+47 
+	#RNF_NORMAL
+ 1
+
+	)
+
+48 
+	#RNF_ROOT
+ 2
+
+	)
+
+49 
+	#RNF_ACTIVE
+ 4
+
+	)
+
+52 c *
+	m_Key
+;
+
+53 c *
+	m_Mask
+;
+
+54 
+dix_node
+ *
+	m_Dudkey
+;
+
+55 } 
+	m_af
+;
+
+57 
+	m_Off
+;
+
+58 
+dix_node
+ *
+	m_L
+;
+
+59 
+dix_node
+ *
+	m_R
+;
+
+60 } 
+	m_node
+;
+
+61 } 
+	m_u
+;
+
+62 #ifde
+RN_DEBUG
+
+
+63 
+	m_fo
+;
+
+64 
+dix_node
+ *
+	m_tw
+;
+
+65 
+dix_node
+ *
+	m_ybro
+;
+
+69 
+	#_dudkey
+ 
+_u
+.
+_af
+.
+_Dudkey
+
+
+	)
+
+70 
+	#_key
+ 
+_u
+.
+_af
+.
+_Key
+
+
+	)
+
+71 
+	#_mask
+ 
+_u
+.
+_af
+.
+_Mask
+
+
+	)
+
+72 
+	#_off
+ 
+_u
+.
+_node
+.
+_Off
+
+
+	)
+
+73 
+	#_l
+ 
+_u
+.
+_node
+.
+_L
+
+
+	)
+
+74 
+	#_r
+ 
+_u
+.
+_node
+.
+_R
+
+
+	)
+
+80 
+	sdix_mask
+ {
+
+81 
+	mrm_b
+;
+
+82 
+	mrm_unud
+;
+
+83 
+u_ch
+ 
+	mrm_ags
+;
+
+84 
+dix_mask
+ *
+	mrm_mkli
+;
+
+86 c *
+	mrmu_mask
+;
+
+87 
+dix_node
+ *
+	mrmu_af
+;
+
+88 } 
+	mrm_rmu
+;
+
+89 
+	mrm_fs
+;
+
+92 
+	#rm_mask
+ 
+rm_rmu
+.
+rmu_mask
+
+
+	)
+
+93 
+	#rm_af
+ 
+rm_rmu
+.
+rmu_af
+
+
+	)
+
+95 
+	#MKG
+(
+m
+) {\
+
+96 i(
+_mkli
+) {\
+
+97 
+m
+ = 
+_mkli
+; \
+
+98 
+_mkli
+ = (
+m
+)->
+rm_mkli
+; \
+
+100 
+	`R_Mloc
+(
+m
+, 
+dix_mask
+ *,  (*(m))); }\
+
+101 
+
+	)
+
+102 
+	#MKFe
+(
+m
+{ (m)->
+rm_mkli
+ = 
+_mkli
+;n_mkli = (m);}
+
+	)
+
+104 
+	sdix_node_hd
+ {
+
+105 
+dix_node
+ *
+	mh_t
+;
+
+106 
+	mh_addrsize
+;
+
+107 
+	mh_pktsize
+;
+
+108 
+	mdix_node
+ *(*
+	mh_addaddr
+)
+
+109 (c *
+	mv
+, c *
+	mmask
+,
+
+110 
+dix_node_hd
+ *
+	mhd
+, 
+dix_node
+ 
+	mnodes
+[]);
+
+111 
+	mdix_node
+ *(*
+	mh_addpkt
+)
+
+112 (c *
+	mv
+, c *
+	mmask
+,
+
+113 
+dix_node_hd
+ *
+	mhd
+, 
+dix_node
+ 
+	mnodes
+[]);
+
+114 
+	mdix_node
+ *(*
+	mh_daddr
+)
+
+115 (c *
+	mv
+, c *
+	mmask
+, 
+dix_node_hd
+ *
+	mhd
+);
+
+116 
+	mdix_node
+ *(*
+	mh_dpkt
+)
+
+117 (c *
+	mv
+, c *
+	mmask
+, 
+dix_node_hd
+ *
+	mhd
+);
+
+118 
+	mdix_node
+ *(*
+	mh_mchaddr
+)
+
+119 (c *
+	mv
+, 
+dix_node_hd
+ *
+	mhd
+);
+
+120 
+	mdix_node
+ *(*
+	mh_lookup
+)
+
+121 (c *
+	mv
+, c *
+	mmask
+, 
+dix_node_hd
+ *
+	mhd
+);
+
+122 
+	mdix_node
+ *(*
+	mh_mchpkt
+)
+
+123 (c *
+	mv
+, 
+dix_node_hd
+ *
+	mhd
+);
+
+124 
+dix_node
+ 
+	mh_nodes
+[3];
+
+127 #ifde
+_KERNEL
+
+
+128 
+dix_mask
+ *
+_mkli
+;
+
+130 
+	#R_Mloc
+(
+p
+, 
+t
+, 
+n
+ = (t
+	`mloc
+((
+size_t
+)), 
+M_RTABLE
+, 
+M_NOWAIT
+))
+
+	)
+
+131 
+	#Fe
+(
+p
+
+	`
+, 
+M_RTABLE
+);
+
+	)
+
+134 
+_
+();
+
+135 
+_hd
+(**, );
+
+136 
+_dayed
+(**, );
+
+137 
+_hd0
+(
+dix_node_hd
+ *, );
+
+138 
+_fes
+(const *, const *);
+
+139 
+_wk
+(
+dix_node_hd
+ *,
+
+140 (*)(
+dix_node
+ *, *),
+
+142 
+dix_node
+
+
+143 *
+	`_addmask
+(const *, , ),
+
+144 *
+	`_addrou
+(c *, c *, 
+dix_node_hd
+ *,
+
+145 
+dix_node
+ [2]),
+
+146 *
+	`_de1
+(c *, c *, 
+dix_node_hd
+ *,
+
+147 
+dix_node
+ *),
+
+148 *
+	`_de
+(c *, c *, 
+dix_node_hd
+ *),
+
+149 *
+	`_
+(c *, 
+dix_node_hd
+ *, *,
+
+150 
+dix_node
+ [2]),
+
+151 *
+	`_lookup
+(c *, c *, 
+dix_node_hd
+ *),
+
+152 *
+	`_mch
+(c *, 
+dix_node_hd
+ *),
+
+153 *
+	`_w
+(c *, , 
+dix_node
+[2]),
+
+154 *
+	`_ch
+(c *, 
+dix_node
+ *),
+
+155 *
+	`_ch_m
+(c *, 
+dix_node
+ *, const *);
+
+	@raw_cb.c
+
+34 
+	~<sys/cdefs.h
+>
+
+35 
+__KERNEL_RCSID
+(0, "$NetBSD:aw_cb.c,v 1.22 2014/05/21 20:43:56mind Exp $");
+
+37 
+	~<sys/m.h
+>
+
+38 
+	~<sys/sym.h
+>
+
+39 
+	~<sys/mbuf.h
+>
+
+40 
+	~<sys/sock.h
+>
+
+41 
+	~<sys/sockv.h
+>
+
+42 
+	~<sys/doma.h
+>
+
+43 
+	~<sys/osw.h
+>
+
+44 
+	~<sys/kmem.h
+>
+
+46 
+	~<t/if.h
+>
+
+47 
+	~<t/rou.h
+>
+
+48 
+	~<t/w_cb.h
+>
+
+49 
+	~<t/.h
+>
+
+60 
+wcbhd
+ 
+	gwcb
+ = 
+LIST_HEAD_INITIALIZER
+(
+wcb
+);
+
+62 
+u_lg
+ 
+	gw_nda
+ = 
+RAWSNDQ
+;
+
+63 
+u_lg
+ 
+	gw_cva
+ = 
+RAWRCVQ
+;
+
+69 
+	$w_ch
+(
+sock
+ *
+so
+, 
+o
+)
+
+71 
+wcb
+ *
+
+;
+
+72 
+r
+;
+
+80 
+
+ = 
+	`sawcb
+(
+so
+);
+
+81 
+	`KASSERT
+(
+
+ !
+NULL
+);
+
+82 
+	`soock
+(
+so
+);
+
+84 i((
+r
+ = 
+	`serve
+(
+so
+, 
+w_nda
+, 
+w_cva
+)) != 0) {
+
+85  
+r
+;
+
+87 
+
+->
+rcb_sock
+ = 
+so
+;
+
+88 
+
+->
+rcb_o
+.
+_my
+ = 
+so
+->
+so_o
+->
+_doma
+->
+dom_my
+;
+
+89 
+
+->
+rcb_o
+.
+_oc
+ = 
+o
+;
+
+90 
+	`LIST_INSERT_HEAD
+(&
+wcb
+, 
+
+, 
+rcb_li
+);
+
+91 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+94 
+	}
+}
+
+100 
+	$w_dach
+(
+sock
+ *
+so
+)
+
+102 
+wcb
+ *
+
+ = 
+	`sawcb
+(
+so
+);
+
+103 c 
+size_t
+ 
+rcb_n
+ = 
+
+->rcb_len;
+
+105 
+	`KASSERT
+(
+
+ !
+NULL
+);
+
+106 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+107 
+	`KASSERT
+(
+so
+->
+so_lock
+ =
+sot_lock
+);
+
+110 
+	`LIST_REMOVE
+(
+
+, 
+rcb_li
+);
+
+111 
+so
+->
+so_pcb
+ = 
+NULL
+;
+
+114 
+	`so
+(
+so
+);
+
+115 
+	`kmem_
+(
+
+, 
+rcb_n
+);
+
+116 
+	`mux_r
+(
+sot_lock
+);
+
+117 
+	}
+}
+
+123 
+	$w_disc
+(
+wcb
+ *
+
+)
+
+125 
+sock
+ *
+so
+ = 
+
+->
+rcb_sock
+;
+
+127 i(
+so
+->
+so_e
+ & 
+SS_NOFDREF
+) {
+
+128 
+	`w_dach
+(
+so
+);
+
+130 
+	}
+}
+
+	@raw_cb.h
+
+34 #ide
+_NET_RAW_CB_H_
+
+
+35 
+	#_NET_RAW_CB_H_
+
+
+	)
+
+37 #ifde
+_KERNEL
+
+
+43 
+	swcb
+ {
+
+44 
+LIST_ENTRY
+(
+wcb
+
+	mrcb_li
+;
+
+45 
+sock
+ *
+	mrcb_sock
+;
+
+46 
+sockaddr
+ *
+	mrcb_ddr
+;
+
+47 
+sockaddr
+ *
+	mrcb_ddr
+;
+
+48 
+socko
+ 
+	mrcb_o
+;
+
+49 
+size_t
+ 
+	mrcb_n
+;
+
+52 
+	#sawcb
+(
+so
+((
+wcb
+ *)(so)->
+so_pcb
+)
+
+	)
+
+57 
+	#RAWSNDQ
+ 8192
+
+	)
+
+58 
+	#RAWRCVQ
+ 8192
+
+	)
+
+60 
+LIST_HEAD
+(
+wcbhd
+, 
+wcb
+);
+
+61 
+wcbhd
+ 
+wcb
+;
+
+63 
+w_ch
+(
+sock
+ *, );
+
+64 *
+w_lput
+(, c 
+sockaddr
+ *, *);
+
+65 
+w_dach
+(
+sock
+ *);
+
+66 
+w_disc
+(
+wcb
+ *);
+
+67 
+w_
+();
+
+68 
+w_put
+(
+mbuf
+ *, ...);
+
+69 
+w_uq
+(
+sock
+ *,
+
+70 , 
+mbuf
+ *, mbu*, mbu*, 
+lwp
+ *);
+
+71 
+w_tsockaddr
+(
+wcb
+ *, 
+sockaddr
+ *);
+
+72 
+w_ddr
+(
+wcb
+ *, 
+sockaddr
+ *);
+
+73 
+w_nd
+(
+sock
+ *,
+
+74 
+mbuf
+ *, 
+sockaddr
+ *, mbu*, 
+lwp
+ *);
+
+	@raw_usrreq.c
+
+38 
+	~<sys/cdefs.h
+>
+
+39 
+__KERNEL_RCSID
+(0, "$NetBSD:aw_usrreq.c,v 1.54 2015/05/02 17:18:03tr Exp $");
+
+41 
+	~<sys/m.h
+>
+
+42 
+	~<sys/mbuf.h
+>
+
+43 
+	~<sys/doma.h
+>
+
+44 
+	~<sys/osw.h
+>
+
+45 
+	~<sys/sock.h
+>
+
+46 
+	~<sys/sockv.h
+>
+
+47 
+	~<sys/o.h
+>
+
+48 
+	~<sys/sym.h
+>
+
+49 
+	~<sys/oc.h
+>
+
+50 
+	~<sys/kauth.h
+>
+
+52 
+	~<t/if.h
+>
+
+53 
+	~<t/rou.h
+>
+
+54 
+	~<t/ti.h
+>
+
+55 
+	~<t/w_cb.h
+>
+
+58 
+	$w_
+()
+
+60 
+	`LIST_INIT
+(&
+wcb
+);
+
+61 
+	}
+}
+
+63 
+le
+ 
+
+64 
+	$equ
+(c 
+sockaddr
+ *
+a1
+, c sockadd*
+a2
+)
+
+66  
+	`memcmp
+(
+a1
+, 
+a2
+,1->
+_n
+) == 0;
+
+67 
+	}
+}
+
+74 
+	$w_put
+(
+mbuf
+ *
+m0
+, ...)
+
+76 
+wcb
+ *
+
+;
+
+77 
+mbuf
+ *
+m
+ = 
+m0
+;
+
+78 
+sock
+ *
+
+;
+
+79 
+va_li
+ 
+
+;
+
+80 
+socko
+ *
+o
+;
+
+81 
+sockaddr
+ *
+c
+, *
+d
+;
+
+83 
+	`KASSERT
+(
+	`mux_owd
+(
+sot_lock
+));
+
+85 
+	`va_t
+(
+
+, 
+m0
+);
+
+86 
+o
+ = 
+	`va_g
+(
+
+, 
+socko
+ *);
+
+87 
+c
+ = 
+	`va_g
+(
+
+, 
+sockaddr
+ *);
+
+88 
+d
+ = 
+	`va_g
+(
+
+, 
+sockaddr
+ *);
+
+89 
+	`va_d
+(
+
+);
+
+91 
+
+ = 
+NULL
+;
+
+92 
+	`LIST_FOREACH
+(
+
+, &
+wcb
+, 
+rcb_li
+) {
+
+93 i(
+
+->
+rcb_o
+.
+_my
+ !
+o
+->sp_family)
+
+95 i(
+
+->
+rcb_o
+.
+_oc
+ &&
+
+96 
+
+->
+rcb_o
+.
+_oc
+ !
+o
+->sp_protocol)
+
+106 i(
+
+->
+rcb_ddr
+ && !
+	`equ
+p->rcb_ddr, 
+d
+))
+
+108 i(
+
+->
+rcb_ddr
+ && !
+	`equ
+p->rcb_ddr, 
+c
+))
+
+110 i(
+
+ !
+NULL
+) {
+
+111 
+mbuf
+ *
+n
+;
+
+112 i((
+n
+ = 
+	`m_cy
+(
+m
+, 0, 
+M_COPYALL
+)=
+NULL
+)
+
+114 i(
+	`sbndaddr
+(&
+
+->
+so_rcv
+, 
+c
+, 
+n
+, 
+NULL
+) == 0)
+
+116 
+	`m_m
+(
+n
+);
+
+118 
+	`swakeup
+(
+
+);
+
+121 
+
+ = 
+
+->
+rcb_sock
+;
+
+123 i(
+
+ =
+NULL
+ || 
+	`sbndaddr
+(&->
+so_rcv
+, 
+c
+, 
+m
+, NULL) == 0)
+
+124 
+	`m_m
+(
+m
+);
+
+126 
+	`swakeup
+(
+
+);
+
+128 
+	}
+}
+
+131 
+	$w_lput
+(
+cmd
+, c 
+sockaddr
+ *
+g
+, *
+d
+)
+
+134 i(()
+cmd
+ >
+PRC_NCMDS
+)
+
+135  
+NULL
+;
+
+136  
+NULL
+;
+
+138 
+	}
+}
+
+141 
+	$w_tsockaddr
+(
+wcb
+ *
+
+, 
+sockaddr
+ *
+m
+)
+
+144 
+	`memy
+(
+m
+, 
+
+->
+rcb_ddr
+,p->rcb_ddr->
+_n
+);
+
+145 
+	}
+}
+
+148 
+	$w_ddr
+(
+wcb
+ *
+
+, 
+sockaddr
+ *
+m
+)
+
+151 
+	`memy
+(
+m
+, 
+
+->
+rcb_ddr
+,p->rcb_ddr->
+_n
+);
+
+152 
+	}
+}
+
+155 
+	$w_nd
+(
+sock
+ *
+so
+, 
+mbuf
+ *
+m
+, 
+sockaddr
+ *
+m
+,
+
+156 
+mbuf
+ *
+c
+, 
+lwp
+ *
+l
+)
+
+158 
+wcb
+ *
+
+ = 
+	`sawcb
+(
+so
+);
+
+159 
+r
+ = 0;
+
+161 
+	`KASSERT
+(
+
+ !
+NULL
+);
+
+167 i(
+c
+ && c->
+m_n
+) {
+
+168 
+	`m_m
+(
+c
+);
+
+169 
+	`m_m
+(
+m
+);
+
+170  
+EINVAL
+;
+
+172 i(
+m
+) {
+
+173 i((
+so
+->
+so_e
+ & 
+SS_ISCONNECTED
+) != 0) {
+
+174 
+r
+ = 
+EISCONN
+;
+
+175 
+d
+;
+
+177 
+r
+ = (*
+so
+->
+so_o
+->
+_uqs
+->
+_c
+)(so, 
+m
+, 
+l
+);
+
+178 i(
+r
+) {
+
+179 
+d
+:
+
+180 
+	`m_m
+(
+m
+);
+
+181  
+r
+;
+
+184 i((
+so
+->
+so_e
+ & 
+SS_ISCONNECTED
+) == 0) {
+
+185 
+r
+ = 
+ENOTCONN
+;
+
+186 
+d
+;
+
+189 
+r
+ = (*
+so
+->
+so_o
+->
+_ouut
+)(
+m
+, so);
+
+190 i(
+m
+)
+
+191 
+	`w_disc
+(
+
+);
+
+193  
+r
+;
+
+194 
+	}
+}
+
+197 
+	$w_uq
+(
+sock
+ *
+so
+, 
+q
+, 
+mbuf
+ *
+m
+, mbu*
+m
+,
+
+198 
+mbuf
+ *
+c
+, 
+lwp
+ *
+l
+)
+
+201 
+	`KASSERT
+(
+q
+ !
+PRU_ATTACH
+);
+
+202 
+	`KASSERT
+(
+q
+ !
+PRU_DETACH
+);
+
+203 
+	`KASSERT
+(
+q
+ !
+PRU_ACCEPT
+);
+
+204 
+	`KASSERT
+(
+q
+ !
+PRU_BIND
+);
+
+205 
+	`KASSERT
+(
+q
+ !
+PRU_LISTEN
+);
+
+206 
+	`KASSERT
+(
+q
+ !
+PRU_CONNECT
+);
+
+207 
+	`KASSERT
+(
+q
+ !
+PRU_CONNECT2
+);
+
+208 
+	`KASSERT
+(
+q
+ !
+PRU_DISCONNECT
+);
+
+209 
+	`KASSERT
+(
+q
+ !
+PRU_SHUTDOWN
+);
+
+210 
+	`KASSERT
+(
+q
+ !
+PRU_ABORT
+);
+
+211 
+	`KASSERT
+(
+q
+ !
+PRU_CONTROL
+);
+
+212 
+	`KASSERT
+(
+q
+ !
+PRU_SENSE
+);
+
+213 
+	`KASSERT
+(
+q
+ !
+PRU_PEERADDR
+);
+
+214 
+	`KASSERT
+(
+q
+ !
+PRU_SOCKADDR
+);
+
+215 
+	`KASSERT
+(
+q
+ !
+PRU_RCVD
+);
+
+216 
+	`KASSERT
+(
+q
+ !
+PRU_RCVOOB
+);
+
+217 
+	`KASSERT
+(
+q
+ !
+PRU_SEND
+);
+
+218 
+	`KASSERT
+(
+q
+ !
+PRU_SENDOOB
+);
+
+219 
+	`KASSERT
+(
+q
+ !
+PRU_PURGEIF
+);
+
+221 i(
+	`sawcb
+(
+so
+=
+NULL
+)
+
+222  
+EINVAL
+;
+
+224 
+	`nic
+("raw_usrreq");
+
+227 
+	}
+}
+
+	@route.c
+
+93 
+	~"t_.h
+"
+
+94 
+	~"t_rou.h
+"
+
+96 
+	~<sys/cdefs.h
+>
+
+97 
+__KERNEL_RCSID
+(0, "$NetBSD:oute.c,v 1.144 2015/04/30 09:57:38 ozaki-r Exp $");
+
+99 
+	~<sys/m.h
+>
+
+100 #ifde
+RTFLUSH_DEBUG
+
+
+101 
+	~<sys/sysl.h
+>
+
+103 
+	~<sys/sym.h
+>
+
+104 
+	~<sys/out.h
+>
+
+105 
+	~<sys/oc.h
+>
+
+106 
+	~<sys/mbuf.h
+>
+
+107 
+	~<sys/sock.h
+>
+
+108 
+	~<sys/sockv.h
+>
+
+109 
+	~<sys/doma.h
+>
+
+110 
+	~<sys/osw.h
+>
+
+111 
+	~<sys/kl.h
+>
+
+112 
+	~<sys/iol.h
+>
+
+113 
+	~<sys/po.h
+>
+
+114 
+	~<sys/kauth.h
+>
+
+116 
+	~<t/if.h
+>
+
+117 
+	~<t/if_dl.h
+>
+
+118 
+	~<t/rou.h
+>
+
+120 
+	~<t/.h
+>
+
+121 
+	~<t/_v.h
+>
+
+123 #ifde
+RTFLUSH_DEBUG
+
+
+124 
+	#che_debug
+(
+	`__edi_l
+(
+_che_debug
+)
+
+	)
+
+126 
+	#che_debug
+(0
+
+	)
+
+129 
+
+ 
+	g
+;
+
+131 
+	gash
+;
+
+133 
+po
+ 
+	gy_po
+;
+
+134 
+po
+ 
+	gtim_po
+;
+
+136 
+out
+ 
+	g_tim_ch
+;
+
+138 #ifde
+RTFLUSH_DEBUG
+
+
+139 
+	g_che_debug
+ = 0;
+
+142 
+kauth_li_t
+ 
+	grou_li
+;
+
+144 
+demsg
+(
+y
+ *);
+
+145 
+ushe1
+(
+y
+ *, *);
+
+146 
+ushe
+(
+_my_t
+ 
+my
+, 
+y
+ *);
+
+147 
+ushl
+();
+
+149 
+_maskedcy
+(c 
+sockaddr
+ *,
+
+150 
+sockaddr
+ *, const sockaddr *);
+
+152 
+che_r
+(
+rou
+ *);
+
+153 
+che_vide
+(
+dom_li
+ *);
+
+155 #ifde
+RTFLUSH_DEBUG
+
+
+156 
+sysl_t_che_tup
+(
+sysog
+ **);
+
+158 
+	$sysl_t_che_tup
+(
+sysog
+ **
+og
+)
+
+160 c 
+sysode
+ *
+ode
+;
+
+162 i(
+	`sysl_v
+(
+og
+, 0, 
+NULL
+, &
+ode
+, 
+CTLFLAG_PERMANENT
+,
+
+163 
+CTLTYPE_NODE
+,
+
+164 "che", 
+	`SYSCTL_DESCR
+("Route cacheelated settings"),
+
+165 
+NULL
+, 0, NULL, 0, 
+CTL_NET
+, 
+CTL_CREATE
+, 
+CTL_EOL
+) != 0)
+
+167 i(
+	`sysl_v
+(
+og
+, 0, &
+ode
+, &rnode,
+
+168 
+CTLFLAG_PERMANENT
+|
+CTLFLAG_READWRITE
+, 
+CTLTYPE_INT
+,
+
+169 "debug", 
+	`SYSCTL_DESCR
+("Debugoute caches"),
+
+170 
+NULL
+, 0, &
+_che_debug
+, 0, 
+CTL_CREATE
+, 
+CTL_EOL
+) != 0)
+
+172 
+	}
+}
+
+175 
+le
+ 
+
+176 
+	$_deroy
+(
+y
+ *
+
+)
+
+178 i(
+
+->
+__key
+ !
+NULL
+)
+
+179 
+	`sockaddr_
+(
+
+->
+__key
+);
+
+180 i(
+
+->
+_geway
+ !
+NULL
+)
+
+181 
+	`sockaddr_
+(
+
+->
+_geway
+);
+
+182 i(
+	`_gg
+(
+
+!
+NULL
+)
+
+183 
+	`sockaddr_
+(
+	`_gg
+(
+
+));
+
+184 
+
+->
+__key
+ =t->
+_geway
+ =t->
+_g
+ = 
+NULL
+;
+
+185 
+	}
+}
+
+187 
+le
+ c 
+sockaddr
+ *
+
+188 
+	$_tkey
+(
+y
+ *
+
+, c 
+sockaddr
+ *
+key
+, 
+ags
+)
+
+190 i(
+
+->
+__key
+ =
+key
+)
+
+191 
+out
+;
+
+193 i(
+
+->
+__key
+ !
+NULL
+)
+
+194 
+	`sockaddr_
+(
+
+->
+__key
+);
+
+195 
+
+->
+__key
+ = 
+	`sockaddr_dup
+(
+key
+, 
+ags
+);
+
+196 
+out
+:
+
+197 
+
+->
+_nodes
+->
+_key
+ = (c *t->
+__key
+;
+
+198  
+
+->
+__key
+;
+
+199 
+	}
+}
+
+201 
+iddr
+ *
+
+202 
+	$_g_i
+(
+y
+ *
+
+)
+
+204 
+iddr
+ *
+i
+;
+
+206 i((
+i
+ = 
+
+->
+_i
+=
+NULL
+)
+
+207  
+i
+;
+
+208 i(
+i
+->
+i_gi
+ =
+NULL
+)
+
+209  
+i
+;
+
+211 i(
+i
+->
+i_qno
+ !
+NULL
+ && *i->i_qn=
+
+->
+_i_qno
+)
+
+212  
+i
+;
+
+215 
+i
+ = (*i->
+i_gi
+)(i, 
+	`_gkey
+(
+
+));
+
+216 
+	`_a_i
+(
+
+, 
+i
+);
+
+217  
+i
+;
+
+219 
+	}
+}
+
+222 
+	$_t_i1
+(
+y
+ *
+
+, 
+iddr
+ *
+i
+)
+
+224 
+
+->
+_i
+ = 
+i
+;
+
+225 i(
+i
+->
+i_qno
+ !
+NULL
+)
+
+226 
+
+->
+_i_qno
+ = *
+i
+->
+i_qno
+;
+
+227 
+	}
+}
+
+233 
+	$_i_ced
+(c 
+y
+ *
+
+, c 
+iddr
+ *
+i
+)
+
+235 c 
+sockaddr
+ *
+key
+, *
+d
+, *
+od
+;
+
+236 
+sockaddr_age
+ 
+maskedd
+;
+
+238 
+key
+ = 
+	`_gkey
+(
+
+);
+
+239 
+d
+ = 
+
+->
+_ags
+ & 
+RTF_HOST
+ ? 
+i
+->
+i_daddr
+ : i->
+i_addr
+;
+
+240 i(
+d
+ =
+NULL
+ ||
+
+241 
+d
+->
+_my
+ !
+key
+->sa_family ||
+
+242 
+d
+->
+_n
+ !
+key
+->sa_len)
+
+244 i((
+
+->
+_ags
+ & 
+RTF_HOST
+=0 && 
+i
+->
+i_tmask
+) {
+
+245 
+od
+ = 
+d
+;
+
+246 
+d
+ = (
+sockaddr
+ *)&
+maskedd
+;
+
+247 
+	`_maskedcy
+(
+od
+, (
+sockaddr
+ *)&
+maskedd
+,
+
+248 
+i
+->
+i_tmask
+);
+
+250  (
+	`memcmp
+(
+d
+, 
+key
+, d->
+_n
+) == 0);
+
+251 
+	}
+}
+
+254 
+	$_a_i
+(
+y
+ *
+
+, 
+iddr
+ *
+i
+)
+
+256 i(
+
+->
+_i
+ &&
+
+257 
+
+->
+_i
+ !
+i
+ &&
+
+258 
+
+->
+_i
+->
+i_ags
+ & 
+IFA_ROUTE
+ &&
+
+259 
+	`_i_ced
+(
+
+,t->
+_i
+))
+
+261 
+	`RT_DPRINTF
+("rt->_rt_key = %p, ifa = %p, "
+
+263 (*)
+
+->
+__key
+, (*t->
+_i
+);
+
+264 
+
+->
+_i
+->
+i_ags
+ &~
+IFA_ROUTE
+;
+
+265 i(
+	`_i_ced
+(
+
+, 
+i
+)) {
+
+266 
+	`RT_DPRINTF
+("rt->_rt_key = %p, ifa = %p, "
+
+268 (*)
+
+->
+__key
+, (*)
+i
+);
+
+269 
+i
+->
+i_ags
+ |
+IFA_ROUTE
+;
+
+273 
+	`if
+(
+i
+);
+
+274 
+	`i
+(
+
+->
+_i
+);
+
+275 
+	`_t_i1
+(
+
+, 
+i
+);
+
+276 
+	}
+}
+
+279 
+	$_t_i
+(
+y
+ *
+
+, 
+iddr
+ *
+i
+)
+
+281 
+	`if
+(
+i
+);
+
+282 
+	`_t_i1
+(
+
+, 
+i
+);
+
+283 
+	}
+}
+
+286 
+	$rou_li_cb
+(
+kauth_ed_t
+ 
+ed
+, 
+kauth_ai_t
+ 
+ai
+, *
+cook
+,
+
+287 *
+g0
+, *
+g1
+, *
+g2
+, *
+g3
+)
+
+289 
+_msghdr
+ *
+m
+;
+
+290 
+su
+;
+
+292 
+su
+ = 
+KAUTH_RESULT_DEFER
+;
+
+293 
+m
+ = 
+g1
+;
+
+295 i(
+ai
+ !
+KAUTH_NETWORK_ROUTE
+)
+
+296  
+su
+;
+
+298 i(
+m
+->
+m_ty
+ =
+RTM_GET
+)
+
+299 
+su
+ = 
+KAUTH_RESULT_ALLOW
+;
+
+301  
+su
+;
+
+302 
+	}
+}
+
+305 
+	$_
+()
+
+308 #ifde
+RTFLUSH_DEBUG
+
+
+309 
+	`sysl_t_che_tup
+(
+NULL
+);
+
+312 
+	`po_
+(&
+y_po
+, (
+y
+), 0, 0, 0, "rtentpl",
+
+313 
+NULL
+, 
+IPL_SOFTNET
+);
+
+314 
+	`po_
+(&
+tim_po
+, (
+tim
+), 0, 0, 0, "rttmrpl",
+
+315 
+NULL
+, 
+IPL_SOFTNET
+);
+
+317 
+	`_
+();
+
+318 
+	`bl_
+();
+
+320 
+rou_li
+ = 
+	`kauth_li_sce
+(
+KAUTH_SCOPE_NETWORK
+,
+
+321 
+rou_li_cb
+, 
+NULL
+);
+
+322 
+	}
+}
+
+325 
+	$ushl
+(
+my
+)
+
+327 
+doma
+ *
+dom
+;
+
+329 i(
+	`che_debug
+())
+
+330 
+	`tf
+("%s:\n", 
+__func__
+);
+
+332 i((
+dom
+ = 
+	`pffddoma
+(
+my
+)=
+NULL
+)
+
+335 
+	`che_vide
+(&
+dom
+->
+dom_che
+);
+
+336 
+	}
+}
+
+339 
+	$che
+(
+rou
+ *
+ro
+)
+
+341 
+doma
+ *
+dom
+;
+
+343 
+	`che_vs
+(
+ro
+);
+
+344 
+	`KASSERT
+(
+ro
+->
+_ro_
+ !
+NULL
+);
+
+345 
+	`KASSERT
+(
+ro
+->
+ro_vid
+ =
+l
+);
+
+346 
+	`KASSERT
+(
+	`che_gd
+(
+ro
+!
+NULL
+);
+
+348 i((
+dom
+ = 
+	`pffddoma
+(
+	`che_gd
+(
+ro
+)->
+_my
+)=
+NULL
+)
+
+351 
+	`LIST_INSERT_HEAD
+(&
+dom
+->
+dom_che
+, 
+ro
+, 
+ro_che_xt
+);
+
+352 
+	`che_vs
+(
+ro
+);
+
+353 
+	}
+}
+
+358 
+y
+ *
+
+359 
+	$loc1
+(c 
+sockaddr
+ *
+d
+, 
+pt
+)
+
+361 
+bl_t
+ *
+bl
+ = 
+	`_gb
+(
+d
+->
+_my
+);
+
+362 
+y
+ *
+
+;
+
+363 
+y
+ *
+w
+ = 
+NULL
+;
+
+364 
+_addrfo
+ 
+fo
+;
+
+365 
+s
+ = 
+	`lsot
+(), 
+r
+ = 0, 
+msgty
+ = 
+RTM_MISS
+;
+
+367 i(
+bl
+ !
+NULL
+ && (
+
+ = 
+	`_mchaddr
+tbl, 
+d
+)) != NULL) {
+
+368 
+w
+ = 
+
+;
+
+369 i(
+pt
+ && (
+
+->
+_ags
+ & 
+RTF_CLONING
+)) {
+
+370 
+r
+ = 
+	`que
+(
+RTM_RESOLVE
+, 
+d
+, 
+NULL
+, NULL, 0,
+
+371 &
+w
+);
+
+372 i(
+r
+) {
+
+373 
+w
+ = 
+
+;
+
+374 
+
+->
+_ft
+++;
+
+375 
+miss
+;
+
+377 
+	`KASSERT
+(
+w
+ !
+NULL
+);
+
+378 
+
+ = 
+w
+;
+
+379 i(
+
+->
+_ags
+ & 
+RTF_XRESOLVE
+) {
+
+380 
+msgty
+ = 
+RTM_RESOLVE
+;
+
+381 
+miss
+;
+
+384 
+	`memt
+(&
+fo
+, 0, (info));
+
+385 
+fo
+.
+i_fo
+[
+RTAX_DST
+] = 
+	`_gkey
+(
+
+);
+
+386 
+fo
+.
+i_fo
+[
+RTAX_NETMASK
+] = 
+	`_mask
+(
+
+);
+
+387 
+fo
+.
+i_fo
+[
+RTAX_GATEWAY
+] = 
+
+->
+_geway
+;
+
+388 i(
+
+->
+_i
+ !
+NULL
+) {
+
+389 
+fo
+.
+i_fo
+[
+RTAX_IFP
+] =
+
+390 
+
+->
+_i
+->
+if_dl
+->
+i_addr
+;
+
+391 
+fo
+.
+i_fo
+[
+RTAX_IFA
+] = 
+
+->
+_i
+->
+i_addr
+;
+
+393 
+	`_missmsg
+(
+RTM_ADD
+, &
+fo
+, 
+
+->
+_ags
+, 0);
+
+395 
+
+->
+_ft
+++;
+
+397 
+
+.
+s_uch
+++;
+
+398 
+miss
+: i(
+pt
+) {
+
+399 
+	`memt
+((*)&
+fo
+, 0, (info));
+
+400 
+fo
+.
+i_fo
+[
+RTAX_DST
+] = 
+d
+;
+
+401 
+	`_missmsg
+(
+msgty
+, &
+fo
+, 0, 
+r
+);
+
+404 
+	`lx
+(
+s
+);
+
+405  
+w
+;
+
+406 
+	}
+}
+
+409 
+	$
+(
+y
+ *
+
+)
+
+411 
+iddr
+ *
+i
+;
+
+413 
+	`KASSERT
+(
+
+ !
+NULL
+);
+
+414 
+	`KASSERT
+(
+
+->
+_ft
+ > 0);
+
+416 
+
+->
+_ft
+--;
+
+417 i(
+
+->
+_ft
+ =0 && (->
+_ags
+ & 
+RTF_UP
+) == 0) {
+
+418 
+	`_as_aive
+(
+
+);
+
+419 
+ash
+--;
+
+420 
+	`_tim_move_l
+(
+
+, 0);
+
+421 
+i
+ = 
+
+->
+_i
+;
+
+422 
+
+->
+_i
+ = 
+NULL
+;
+
+423 
+	`i
+(
+i
+);
+
+424 
+
+->
+_i
+ = 
+NULL
+;
+
+425 
+	`_deroy
+(
+
+);
+
+426 
+	`po_put
+(&
+y_po
+, 
+
+);
+
+428 
+	}
+}
+
+439 
+	$de
+(c 
+sockaddr
+ *
+d
+, c sockadd*
+geway
+,
+
+440 c 
+sockaddr
+ *
+tmask
+, 
+ags
+, c sockadd*
+c
+,
+
+441 
+y
+ **
+p
+)
+
+443 
+y
+ *
+
+;
+
+444 
+r
+ = 0;
+
+445 
+ut64_t
+ *
+
+ = 
+NULL
+;
+
+446 
+_addrfo
+ 
+fo
+;
+
+447 
+iddr
+ *
+i
+;
+
+450 i((
+i
+ = 
+	`i_ifwht
+(
+geway
+)=
+NULL
+) {
+
+451 
+r
+ = 
+ENETUNREACH
+;
+
+452 
+out
+;
+
+454 
+
+ = 
+	`loc1
+(
+d
+, 0);
+
+461 i(!(
+ags
+ & 
+RTF_DONE
+&& 
+
+ &&
+
+462 (
+	`sockaddr_cmp
+(
+c
+, 
+
+->
+_geway
+!0 ||t->
+_i
+ !
+i
+))
+
+463 
+r
+ = 
+EINVAL
+;
+
+464 i(
+	`i_ifwhaddr
+(
+geway
+))
+
+465 
+r
+ = 
+EHOSTUNREACH
+;
+
+466 i(
+r
+)
+
+467 
+de
+;
+
+474 i(
+
+ =
+NULL
+ || (
+	`_mask
+t&&t_maskt)->
+_n
+ < 2))
+
+475 
+
+;
+
+480 i(
+
+->
+_ags
+ & 
+RTF_GATEWAY
+) {
+
+481 i(((
+
+->
+_ags
+ & 
+RTF_HOST
+=0&& (
+ags
+ & RTF_HOST)) {
+
+486 
+
+:
+
+487 i(
+
+ !
+NULL
+)
+
+488 
+	`
+(
+
+);
+
+489 
+ags
+ |
+RTF_GATEWAY
+ | 
+RTF_DYNAMIC
+;
+
+490 
+	`memt
+(&
+fo
+, 0, (info));
+
+491 
+fo
+.
+i_fo
+[
+RTAX_DST
+] = 
+d
+;
+
+492 
+fo
+.
+i_fo
+[
+RTAX_GATEWAY
+] = 
+geway
+;
+
+493 
+fo
+.
+i_fo
+[
+RTAX_NETMASK
+] = 
+tmask
+;
+
+494 
+fo
+.
+i_i
+ = 
+i
+;
+
+495 
+fo
+.
+i_ags
+ = 
+ags
+;
+
+496 
+
+ = 
+NULL
+;
+
+497 
+r
+ = 
+	`que1
+(
+RTM_ADD
+, &
+fo
+, &
+
+);
+
+498 i(
+
+ !
+NULL
+)
+
+499 
+ags
+ = 
+
+->
+_ags
+;
+
+500 
+
+ = &
+
+.
+s_dymic
+;
+
+506 
+
+->
+_ags
+ |
+RTF_MODIFIED
+;
+
+507 
+ags
+ |
+RTF_MODIFIED
+;
+
+508 
+
+ = &
+
+.
+s_wgeway
+;
+
+509 
+	`_tge
+(
+
+, 
+geway
+);
+
+512 
+r
+ = 
+EHOSTUNREACH
+;
+
+513 
+de
+:
+
+514 i(
+
+) {
+
+515 i(
+p
+ !
+NULL
+ && !
+r
+)
+
+516 *
+p
+ = 
+
+;
+
+518 
+	`
+(
+
+);
+
+520 
+out
+:
+
+521 i(
+r
+)
+
+522 
+
+.
+s_badde
+++;
+
+523 i(
+
+ !
+NULL
+)
+
+524 (*
+
+)++;
+
+525 
+	`memt
+(&
+fo
+, 0, (info));
+
+526 
+fo
+.
+i_fo
+[
+RTAX_DST
+] = 
+d
+;
+
+527 
+fo
+.
+i_fo
+[
+RTAX_GATEWAY
+] = 
+geway
+;
+
+528 
+fo
+.
+i_fo
+[
+RTAX_NETMASK
+] = 
+tmask
+;
+
+529 
+fo
+.
+i_fo
+[
+RTAX_AUTHOR
+] = 
+c
+;
+
+530 
+	`_missmsg
+(
+RTM_REDIRECT
+, &
+fo
+, 
+ags
+, 
+r
+);
+
+531 
+	}
+}
+
+537 
+	$demsg
+(
+y
+ *
+
+)
+
+539 
+r
+;
+
+540 
+_addrfo
+ 
+fo
+;
+
+547 
+	`memt
+(&
+fo
+, 0, (info));
+
+548 
+fo
+.
+i_fo
+[
+RTAX_DST
+] = 
+	`_gkey
+(
+
+);
+
+549 
+fo
+.
+i_fo
+[
+RTAX_NETMASK
+] = 
+	`_mask
+(
+
+);
+
+550 
+fo
+.
+i_fo
+[
+RTAX_GATEWAY
+] = 
+
+->
+_geway
+;
+
+551 
+fo
+.
+i_ags
+ = 
+
+->
+_ags
+;
+
+552 
+r
+ = 
+	`que1
+(
+RTM_DELETE
+, &
+fo
+, &
+
+);
+
+554 
+	`_missmsg
+(
+RTM_DELETE
+, &
+fo
+, info.
+i_ags
+, 
+r
+);
+
+557 i(
+r
+ =0 && 
+
+->
+_ft
+ <= 0) {
+
+558 
+
+->
+_ft
+++;
+
+559 
+	`
+(
+
+);
+
+561  
+r
+;
+
+562 
+	}
+}
+
+565 
+	$ushe1
+(
+y
+ *
+
+, *
+g
+)
+
+567 
+y
+ *
+
+;
+
+569 
+
+ = (
+y
+ *)
+g
+;
+
+570 i((
+
+->
+_ags
+ & 
+RTF_CLONED
+!0 &&t->
+_
+ =
+
+)
+
+571 
+	`demsg
+(
+
+);
+
+573 
+	}
+}
+
+576 
+	$ushe
+(
+_my_t
+ 
+my
+, 
+y
+ *
+
+)
+
+579 #ifde
+DIAGNOSTIC
+
+
+580 i(!
+
+ || (->
+_ags
+ & 
+RTF_CLONING
+) == 0)
+
+581 
+	`nic
+("rtflushclone: called withon-cloningoute");
+
+583 
+	`_wk
+(
+my
+, 
+ushe1
+, (*)
+
+);
+
+584 
+	}
+}
+
+586 
+iddr
+ *
+
+587 
+	$i_ifwhrou
+(
+ags
+, c 
+sockaddr
+ *
+d
+,
+
+588 c 
+sockaddr
+ *
+geway
+)
+
+590 
+iddr
+ *
+i
+;
+
+591 i((
+ags
+ & 
+RTF_GATEWAY
+) == 0) {
+
+599 
+i
+ = 
+NULL
+;
+
+600 i((
+ags
+ & 
+RTF_HOST
+&& 
+geway
+->
+_my
+ !
+AF_LINK
+)
+
+601 
+i
+ = 
+	`i_ifwhdaddr
+(
+d
+);
+
+602 i(
+i
+ =
+NULL
+)
+
+603 
+i
+ = 
+	`i_ifwhaddr
+(
+geway
+);
+
+610 
+i
+ = 
+	`i_ifwhdaddr
+(
+geway
+);
+
+612 i(
+i
+ =
+NULL
+)
+
+613 
+i
+ = 
+	`i_ifwht
+(
+geway
+);
+
+614 i(
+i
+ =
+NULL
+) {
+
+615 
+y
+ *
+
+ = 
+	`loc1
+(
+d
+, 0);
+
+616 i(
+
+ =
+NULL
+)
+
+617  
+NULL
+;
+
+618 
+
+->
+_ft
+--;
+
+619 i((
+i
+ = 
+
+->
+_i
+=
+NULL
+)
+
+620  
+NULL
+;
+
+622 i(
+i
+->
+i_addr
+->
+_my
+ !
+d
+->sa_family) {
+
+623 
+iddr
+ *
+oi
+ = 
+i
+;
+
+624 
+i
+ = 
+	`iof_ifaddr
+(
+d
+, i->
+i_i
+);
+
+625 i(
+i
+ =
+NULL
+)
+
+626 
+i
+ = 
+oi
+;
+
+628  
+i
+;
+
+629 
+	}
+}
+
+632 
+	$que
+(
+q
+, c 
+sockaddr
+ *
+d
+, c sockadd*
+geway
+,
+
+633 c 
+sockaddr
+ *
+tmask
+, 
+ags
+, 
+y
+ **
+t_t
+)
+
+635 
+_addrfo
+ 
+fo
+;
+
+637 
+	`memt
+(&
+fo
+, 0, (info));
+
+638 
+fo
+.
+i_ags
+ = 
+ags
+;
+
+639 
+fo
+.
+i_fo
+[
+RTAX_DST
+] = 
+d
+;
+
+640 
+fo
+.
+i_fo
+[
+RTAX_GATEWAY
+] = 
+geway
+;
+
+641 
+fo
+.
+i_fo
+[
+RTAX_NETMASK
+] = 
+tmask
+;
+
+642  
+	`que1
+(
+q
+, &
+fo
+, 
+t_t
+);
+
+643 
+	}
+}
+
+646 
+	$_gi
+(
+_addrfo
+ *
+fo
+)
+
+648 
+iddr
+ *
+i
+;
+
+649 c 
+sockaddr
+ *
+d
+ = 
+fo
+->
+i_fo
+[
+RTAX_DST
+];
+
+650 c 
+sockaddr
+ *
+geway
+ = 
+fo
+->
+i_fo
+[
+RTAX_GATEWAY
+];
+
+651 c 
+sockaddr
+ *
+iaddr
+ = 
+fo
+->
+i_fo
+[
+RTAX_IFA
+];
+
+652 c 
+sockaddr
+ *
+iaddr
+ = 
+fo
+->
+i_fo
+[
+RTAX_IFP
+];
+
+653 
+ags
+ = 
+fo
+->
+i_ags
+;
+
+659 i(
+fo
+->
+i_i
+ =
+NULL
+ && 
+iaddr
+ != NULL
+
+660 && 
+iaddr
+->
+_my
+ =
+AF_LINK
+ &&
+
+661 (
+i
+ = 
+	`i_ifwht
+(
+iaddr
+)!
+NULL
+)
+
+662 
+fo
+->
+i_i
+ = 
+i
+->
+i_i
+;
+
+663 i(
+fo
+->
+i_i
+ =
+NULL
+ && 
+iaddr
+ != NULL)
+
+664 
+fo
+->
+i_i
+ = 
+	`i_ifwhaddr
+(
+iaddr
+);
+
+665 i(
+fo
+->
+i_i
+ =
+NULL
+) {
+
+666 c 
+sockaddr
+ *
+
+;
+
+668 
+
+ = 
+iaddr
+ !
+NULL
+ ? ifaaddr :
+
+669 (
+geway
+ !
+NULL
+ ? geway : 
+d
+);
+
+670 i(
+
+ !
+NULL
+ && 
+fo
+->
+i_i
+ != NULL)
+
+671 
+fo
+->
+i_i
+ = 
+	`iof_ifaddr
+(
+
+, info->
+i_i
+);
+
+672 i(
+d
+ !
+NULL
+ && 
+geway
+ != NULL)
+
+673 
+fo
+->
+i_i
+ = 
+	`i_ifwhrou
+(
+ags
+, 
+d
+, 
+geway
+);
+
+674 i(
+
+ !
+NULL
+)
+
+675 
+fo
+->
+i_i
+ = 
+	`i_ifwhrou
+(
+ags
+, 
+
+, sa);
+
+677 i((
+i
+ = 
+fo
+->
+i_i
+=
+NULL
+)
+
+678  
+ENETUNREACH
+;
+
+679 i(
+i
+->
+i_gi
+ !
+NULL
+)
+
+680 
+fo
+->
+i_i
+ = 
+i
+ = (*i->
+i_gi
+)(i, 
+d
+);
+
+681 i(
+fo
+->
+i_i
+ =
+NULL
+)
+
+682 
+fo
+->
+i_i
+ = 
+i
+->
+i_i
+;
+
+684 
+	}
+}
+
+687 
+	$que1
+(
+q
+, 
+_addrfo
+ *
+fo
+, 
+y
+ **
+t_t
+)
+
+689 
+s
+ = 
+	`lsot
+();
+
+690 
+r
+ = 0, 
+rc
+;
+
+691 
+y
+ *
+
+, *
+t
+;
+
+692 
+bl_t
+ *
+bl
+;
+
+693 
+iddr
+ *
+i
+, *
+i2
+;
+
+694 
+sockaddr_age
+ 
+maskedd
+;
+
+695 c 
+sockaddr
+ *
+d
+ = 
+fo
+->
+i_fo
+[
+RTAX_DST
+];
+
+696 c 
+sockaddr
+ *
+geway
+ = 
+fo
+->
+i_fo
+[
+RTAX_GATEWAY
+];
+
+697 c 
+sockaddr
+ *
+tmask
+ = 
+fo
+->
+i_fo
+[
+RTAX_NETMASK
+];
+
+698 
+ags
+ = 
+fo
+->
+i_ags
+;
+
+699 
+	#ndr
+(
+x
+{ 
+r
+ = x ; 
+bad
+; }
+
+	)
+
+701 i((
+bl
+ = 
+	`_gb
+(
+d
+->
+_my
+)=
+NULL
+)
+
+702 
+	`ndr
+(
+ESRCH
+);
+
+703 i(
+ags
+ & 
+RTF_HOST
+)
+
+704 
+tmask
+ = 
+NULL
+;
+
+705 
+q
+) {
+
+706 
+RTM_DELETE
+:
+
+707 i(
+tmask
+) {
+
+708 
+	`_maskedcy
+(
+d
+, (
+sockaddr
+ *)&
+maskedd
+,
+
+709 
+tmask
+);
+
+710 
+d
+ = (
+sockaddr
+ *)&
+maskedd
+;
+
+712 i((
+
+ = 
+	`_lookup
+(
+bl
+, 
+d
+, 
+tmask
+)=
+NULL
+)
+
+713 
+	`ndr
+(
+ESRCH
+);
+
+714 i((
+
+->
+_ags
+ & 
+RTF_CLONING
+) != 0) {
+
+716 
+	`ushe
+(
+d
+->
+_my
+, 
+
+);
+
+718 i((
+
+ = 
+	`_daddr
+(
+bl
+, 
+d
+, 
+tmask
+)=
+NULL
+)
+
+719 
+	`ndr
+(
+ESRCH
+);
+
+720 i(
+
+->
+_gwrou
+) {
+
+721 
+	`
+(
+
+->
+_gwrou
+);
+
+722 
+
+->
+_gwrou
+ = 
+NULL
+;
+
+724 i(
+
+->
+_
+) {
+
+725 
+
+->
+_
+->
+_ft
+--;
+
+726 
+
+->
+_
+ = 
+NULL
+;
+
+728 
+
+->
+_ags
+ &~
+RTF_UP
+;
+
+729 i((
+i
+ = 
+
+->
+_i
+)) {
+
+730 i(
+i
+->
+i_ags
+ & 
+IFA_ROUTE
+ &&
+
+731 
+	`_i_ced
+(
+
+, 
+i
+)) {
+
+732 
+	`RT_DPRINTF
+("rt->_rt_key = %p, ifa = %p, "
+
+734 (*)
+
+->
+__key
+, (*)
+i
+);
+
+735 
+i
+->
+i_ags
+ &~
+IFA_ROUTE
+;
+
+737 i(
+i
+->
+i_que
+)
+
+738 
+i
+->
+	`i_que
+(
+RTM_DELETE
+, 
+
+, 
+fo
+);
+
+740 
+ash
+++;
+
+741 i(
+t_t
+)
+
+742 *
+t_t
+ = 
+
+;
+
+743 i(
+
+->
+_ft
+ <= 0) {
+
+744 
+
+->
+_ft
+++;
+
+745 
+	`
+(
+
+);
+
+749 
+RTM_RESOLVE
+:
+
+750 i(
+t_t
+ =
+NULL
+ || (
+
+ = *ret_nrt) == NULL)
+
+751 
+	`ndr
+(
+EINVAL
+);
+
+752 i((
+
+->
+_ags
+ & 
+RTF_CLONING
+) == 0)
+
+753 
+	`ndr
+(
+EINVAL
+);
+
+754 
+i
+ = 
+
+->
+_i
+;
+
+755 
+ags
+ = 
+
+->
+_ags
+ & ~(
+RTF_CLONING
+ | 
+RTF_STATIC
+);
+
+756 
+ags
+ |
+RTF_CLONED
+;
+
+757 
+geway
+ = 
+
+->
+_geway
+;
+
+758 
+ags
+ |
+RTF_HOST
+;
+
+759 
+makou
+;
+
+761 
+RTM_ADD
+:
+
+762 i(
+fo
+->
+i_i
+ =
+NULL
+ && (
+r
+ = 
+	`_gi
+(info)))
+
+763 
+	`ndr
+(
+r
+);
+
+764 
+i
+ = 
+fo
+->
+i_i
+;
+
+765 
+makou
+:
+
+767 
+
+ = 
+	`po_g
+(&
+y_po
+, 
+PR_NOWAIT
+);
+
+768 i(
+
+ =
+NULL
+)
+
+769 
+	`ndr
+(
+ENOBUFS
+);
+
+770 
+	`memt
+(
+
+, 0, (*rt));
+
+771 
+
+->
+_ags
+ = 
+RTF_UP
+ | 
+ags
+;
+
+772 
+	`LIST_INIT
+(&
+
+->
+_tim
+);
+
+773 
+	`RT_DPRINTF
+("->__key = %p\n", (*)
+
+->
+__key
+);
+
+774 i(
+	`_tkey
+(
+
+, 
+d
+, 
+M_NOWAIT
+=
+NULL
+ ||
+
+775 
+	`_tge
+(
+
+, 
+geway
+) != 0) {
+
+776 
+	`po_put
+(&
+y_po
+, 
+
+);
+
+777 
+	`ndr
+(
+ENOBUFS
+);
+
+779 
+	`RT_DPRINTF
+("->__key = %p\n", (*)
+
+->
+__key
+);
+
+780 i(
+tmask
+) {
+
+781 
+	`_maskedcy
+(
+d
+, (
+sockaddr
+ *)&
+maskedd
+,
+
+782 
+tmask
+);
+
+783 
+	`_tkey
+(
+
+, (
+sockaddr
+ *)&
+maskedd
+, 
+M_NOWAIT
+);
+
+784 
+	`RT_DPRINTF
+("->__key = %p\n", (*)
+
+->
+__key
+);
+
+786 
+	`_tkey
+(
+
+, 
+d
+, 
+M_NOWAIT
+);
+
+787 
+	`RT_DPRINTF
+("->__key = %p\n", (*)
+
+->
+__key
+);
+
+789 
+	`_t_i
+(
+
+, 
+i
+);
+
+790 i(
+fo
+->
+i_fo
+[
+RTAX_TAG
+] !
+NULL
+)
+
+791 
+	`_ag
+(
+
+, 
+fo
+->
+i_fo
+[
+RTAX_TAG
+]);
+
+792 
+	`RT_DPRINTF
+("->__key = %p\n", (*)
+
+->
+__key
+);
+
+793 i(
+fo
+->
+i_fo
+[
+RTAX_IFP
+] !
+NULL
+ &&
+
+794 (
+i2
+ = 
+	`i_ifwht
+(
+fo
+->
+i_fo
+[
+RTAX_IFP
+])!
+NULL
+ &&
+
+795 
+i2
+->
+i_i
+ !
+NULL
+)
+
+796 
+
+->
+_i
+ = 
+i2
+->
+i_i
+;
+
+798 
+
+->
+_i
+ = 
+i
+->
+i_i
+;
+
+799 i(
+q
+ =
+RTM_RESOLVE
+) {
+
+800 
+
+->
+_rmx
+ = (*
+t_t
+)->rt_rmx;
+
+801 
+
+->
+_
+ = *
+t_t
+;
+
+802 
+
+->
+_
+->
+_ft
+++;
+
+804 
+	`RT_DPRINTF
+("->__key = %p\n", (*)
+
+->
+__key
+);
+
+805 
+rc
+ = 
+	`_addaddr
+(
+bl
+, 
+
+, 
+tmask
+);
+
+806 
+	`RT_DPRINTF
+("->__key = %p\n", (*)
+
+->
+__key
+);
+
+807 i(
+rc
+ !0 && (
+t
+ = 
+	`loc1
+(
+	`_gkey
+(
+
+), 0)!
+NULL
+) {
+
+809 i((
+t
+->
+_ags
+ & 
+RTF_CLONED
+) != 0) {
+
+810 
+	`demsg
+(
+t
+);
+
+811 
+rc
+ = 
+	`_addaddr
+(
+bl
+, 
+
+, 
+tmask
+);
+
+813 
+	`
+(
+t
+);
+
+814 
+	`RT_DPRINTF
+("->__key = %p\n", (*)
+
+->
+__key
+);
+
+816 
+	`RT_DPRINTF
+("->__key = %p\n", (*)
+
+->
+__key
+);
+
+817 i(
+rc
+ != 0) {
+
+818 
+	`i
+(
+i
+);
+
+819 i((
+
+->
+_ags
+ & 
+RTF_CLONED
+!0 &&t->
+_
+)
+
+820 
+	`
+(
+
+->
+_
+);
+
+821 i(
+
+->
+_gwrou
+)
+
+822 
+	`
+(
+
+->
+_gwrou
+);
+
+823 
+	`_deroy
+(
+
+);
+
+824 
+	`po_put
+(&
+y_po
+, 
+
+);
+
+825 
+	`ndr
+(
+rc
+);
+
+827 
+	`RT_DPRINTF
+("->__key = %p\n", (*)
+
+->
+__key
+);
+
+828 i(
+i
+->
+i_que
+)
+
+829 
+i
+->
+	`i_que
+(
+q
+, 
+
+, 
+fo
+);
+
+830 
+	`RT_DPRINTF
+("->__key = %p\n", (*)
+
+->
+__key
+);
+
+831 i(
+t_t
+) {
+
+832 *
+t_t
+ = 
+
+;
+
+833 
+
+->
+_ft
+++;
+
+835 i((
+
+->
+_ags
+ & 
+RTF_CLONING
+) != 0) {
+
+837 
+	`ushe
+(
+d
+->
+_my
+, 
+
+);
+
+839 
+	`ushl
+(
+d
+->
+_my
+);
+
+841 
+RTM_GET
+:
+
+842 i(
+tmask
+ !
+NULL
+) {
+
+843 
+	`_maskedcy
+(
+d
+, (
+sockaddr
+ *)&
+maskedd
+,
+
+844 
+tmask
+);
+
+845 
+d
+ = (
+sockaddr
+ *)&
+maskedd
+;
+
+847 i((
+
+ = 
+	`_lookup
+(
+bl
+, 
+d
+, 
+tmask
+)=
+NULL
+)
+
+848 
+	`ndr
+(
+ESRCH
+);
+
+849 i(
+t_t
+ !
+NULL
+) {
+
+850 *
+t_t
+ = 
+
+;
+
+851 
+
+->
+_ft
+++;
+
+855 
+bad
+:
+
+856 
+	`lx
+(
+s
+);
+
+857  
+r
+;
+
+858 
+	}
+}
+
+861 
+	$_tge
+(
+y
+ *
+
+, c 
+sockaddr
+ *
+ge
+)
+
+863 
+	`KASSERT
+(
+
+ !->
+_gwrou
+);
+
+865 
+	`KASSERT
+(
+
+->
+__key
+ !
+NULL
+);
+
+866 
+	`RT_DPRINTF
+("->__key = %p\n", (*)
+
+->
+__key
+);
+
+868 i(
+
+->
+_gwrou
+) {
+
+869 
+	`
+(
+
+->
+_gwrou
+);
+
+870 
+
+->
+_gwrou
+ = 
+NULL
+;
+
+872 
+	`KASSERT
+(
+
+->
+__key
+ !
+NULL
+);
+
+873 
+	`RT_DPRINTF
+("->__key = %p\n", (*)
+
+->
+__key
+);
+
+874 i(
+
+->
+_geway
+ !
+NULL
+)
+
+875 
+	`sockaddr_
+(
+
+->
+_geway
+);
+
+876 
+	`KASSERT
+(
+
+->
+__key
+ !
+NULL
+);
+
+877 
+	`RT_DPRINTF
+("->__key = %p\n", (*)
+
+->
+__key
+);
+
+878 i((
+
+->
+_geway
+ = 
+	`sockaddr_dup
+(
+ge
+, 
+M_ZERO
+ | 
+M_NOWAIT
+)=
+NULL
+)
+
+879  
+ENOMEM
+;
+
+880 
+	`KASSERT
+(
+
+->
+__key
+ !
+NULL
+);
+
+881 
+	`RT_DPRINTF
+("->__key = %p\n", (*)
+
+->
+__key
+);
+
+883 i(
+
+->
+_ags
+ & 
+RTF_GATEWAY
+) {
+
+884 
+	`KASSERT
+(
+
+->
+__key
+ !
+NULL
+);
+
+885 
+	`RT_DPRINTF
+("->__key = %p\n", (*)
+
+->
+__key
+);
+
+886 
+
+->
+_gwrou
+ = 
+	`loc1
+(
+ge
+, 1);
+
+894 
+	`KASSERT
+(
+
+->
+__key
+ !
+NULL
+);
+
+895 
+	`RT_DPRINTF
+("->__key = %p\n", (*)
+
+->
+__key
+);
+
+896 i(
+
+->
+_gwrou
+
+
+897 && !(
+
+->
+_rmx
+.
+rmx_locks
+ & 
+RTV_MTU
+)
+
+898 && 
+
+->
+_rmx
+.
+rmx_mtu
+
+
+899 && 
+
+->
+_rmx
+.
+rmx_mtu
+ >t->
+_gwrou
+->rt_rmx.rmx_mtu) {
+
+900 
+
+->
+_rmx
+.
+rmx_mtu
+ =t->
+_gwrou
+->rt_rmx.rmx_mtu;
+
+903 
+	`KASSERT
+(
+
+->
+__key
+ !
+NULL
+);
+
+904 
+	`RT_DPRINTF
+("->__key = %p\n", (*)
+
+->
+__key
+);
+
+906 
+	}
+}
+
+909 
+	$_maskedcy
+(c 
+sockaddr
+ *
+c
+, sockadd*
+d
+,
+
+910 c 
+sockaddr
+ *
+tmask
+)
+
+912 c *
+tmaskp
+ = &
+tmask
+->
+_da
+[0],
+
+913 *
+
+ = &
+c
+->
+_da
+[0];
+
+914 *
+dp
+ = &
+d
+->
+_da
+[0];
+
+915 c *
+maskd
+ = (*)
+d
+ + 
+	`MIN
+(
+tmask
+->
+_n
+, 
+c
+->sa_len);
+
+916 c *
+nd
+ = (*)
+d
+ + 
+c
+->
+_n
+;
+
+918 
+d
+->
+_n
+ = 
+c
+->sa_len;
+
+919 
+d
+->
+_my
+ = 
+c
+->sa_family;
+
+921 
+dp
+ < 
+maskd
+)
+
+922 *
+dp
+++ = *
+
+++ & *
+tmaskp
+++;
+
+923 i(
+dp
+ < 
+nd
+)
+
+924 
+	`memt
+(
+dp
+, 0, (
+size_t
+)(
+nd
+ - dstp));
+
+925 
+	}
+}
+
+931 
+	$_wmsg
+(
+cmd
+, 
+y
+ *
+
+)
+
+933 
+_addrfo
+ 
+fo
+;
+
+935 
+	`memt
+((*)&
+fo
+, 0, (info));
+
+936 
+fo
+.
+i_fo
+[
+RTAX_DST
+] = 
+	`_gkey
+(
+
+);
+
+937 
+fo
+.
+i_fo
+[
+RTAX_GATEWAY
+] = 
+
+->
+_geway
+;
+
+938 
+fo
+.
+i_fo
+[
+RTAX_NETMASK
+] = 
+	`_mask
+(
+
+);
+
+939 i(
+
+->
+_i
+) {
+
+940 
+fo
+.
+i_fo
+[
+RTAX_IFP
+] = 
+
+->
+_i
+->
+if_dl
+->
+i_addr
+;
+
+941 
+fo
+.
+i_fo
+[
+RTAX_IFA
+] = 
+
+->
+_i
+->
+i_addr
+;
+
+944 
+	`_missmsg
+(
+cmd
+, &
+fo
+, 
+
+->
+_ags
+, 0);
+
+945 
+	}
+}
+
+952 
+	$
+(
+iddr
+ *
+i
+, 
+cmd
+, 
+ags
+)
+
+954 
+y
+ *
+
+;
+
+955 
+sockaddr
+ *
+d
+, *
+od
+;
+
+956 
+sockaddr_age
+ 
+maskedd
+;
+
+957 
+y
+ *
+t
+ = 
+NULL
+;
+
+958 
+r
+;
+
+959 
+_addrfo
+ 
+fo
+;
+
+960 
+sockaddr_dl
+ *
+sdl
+;
+
+961 c 
+sockaddr_dl
+ *
+ifsdl
+;
+
+963 
+d
+ = 
+ags
+ & 
+RTF_HOST
+ ? 
+i
+->
+i_daddr
+ : i->
+i_addr
+;
+
+964 i(
+cmd
+ =
+RTM_DELETE
+) {
+
+965 i((
+ags
+ & 
+RTF_HOST
+=0 && 
+i
+->
+i_tmask
+) {
+
+967 
+od
+ = 
+d
+;
+
+968 
+d
+ = (
+sockaddr
+ *)&
+maskedd
+;
+
+969 
+	`_maskedcy
+(
+od
+, 
+d
+, 
+i
+->
+i_tmask
+);
+
+971 i((
+
+ = 
+	`loc1
+(
+d
+, 0)!
+NULL
+) {
+
+972 
+
+->
+_ft
+--;
+
+973 i(
+
+->
+_i
+ !
+i
+)
+
+974  (
+ags
+ & 
+RTF_HOST
+? 
+EHOSTUNREACH
+
+
+975 : 
+ENETUNREACH
+;
+
+978 
+	`memt
+(&
+fo
+, 0, (info));
+
+979 
+fo
+.
+i_i
+ = 
+i
+;
+
+980 
+fo
+.
+i_ags
+ = 
+ags
+ | 
+i
+->
+i_ags
+;
+
+981 
+fo
+.
+i_fo
+[
+RTAX_DST
+] = 
+d
+;
+
+982 
+fo
+.
+i_fo
+[
+RTAX_GATEWAY
+] = 
+i
+->
+i_addr
+;
+
+989 i(
+cmd
+ !
+RTM_LLINFO_UPD
+)
+
+990 
+fo
+.
+i_fo
+[
+RTAX_NETMASK
+] = 
+i
+->
+i_tmask
+;
+
+991 
+r
+ = 
+	`que1
+((
+cmd
+ =
+RTM_LLINFO_UPD
+? 
+RTM_GET
+ : cmd, &
+fo
+,
+
+992 &
+t
+);
+
+993 i(
+r
+ !0 || (
+
+ = 
+t
+=
+NULL
+)
+
+995 
+cmd
+) {
+
+996 
+RTM_DELETE
+:
+
+997 
+	`_wmsg
+(
+cmd
+, 
+t
+);
+
+998 i(
+
+->
+_ft
+ <= 0) {
+
+999 
+
+->
+_ft
+++;
+
+1000 
+	`
+(
+
+);
+
+1003 
+RTM_LLINFO_UPD
+:
+
+1004 
+
+->
+_ft
+--;
+
+1005 
+	`RT_DPRINTF
+("%s: updg%s\n", 
+__func__
+,
+
+1006 ((
+
+->
+_ags
+ & 
+RTF_LLINFO
+) == 0) ? " (nolinfo)" : "");
+
+1008 
+ifsdl
+ = 
+i
+->
+i_i
+->
+if_dl
+;
+
+1010 i((
+
+->
+_ags
+ & 
+RTF_LLINFO
+) != 0 &&
+
+1011 (
+sdl
+ = 
+	`tosdl
+(
+
+->
+_geway
+)!
+NULL
+ &&
+
+1012 
+sdl
+->
+sdl_my
+ =
+AF_LINK
+ &&
+
+1013 
+	`sockaddr_dl_ddr
+(
+sdl
+, sdl->
+sdl_n
+, 
+	`CLLADDR
+(
+ifsdl
+),
+
+1014 
+i
+->
+i_i
+->
+if_add
+=
+NULL
+) {
+
+1015 
+r
+ = 
+EINVAL
+;
+
+1019 i(
+cmd
+ =
+RTM_LLINFO_UPD
+ && 
+i
+->
+i_que
+ !
+NULL
+)
+
+1020 
+i
+->
+	`i_que
+(
+RTM_LLINFO_UPD
+, 
+
+, &
+fo
+);
+
+1021 
+	`_wmsg
+(
+RTM_CHANGE
+, 
+t
+);
+
+1023 
+RTM_ADD
+:
+
+1024 
+
+->
+_ft
+--;
+
+1025 i(
+
+->
+_i
+ !
+i
+) {
+
+1026 
+	`tf
+(": wrg i (%pwa(%p)\n", 
+i
+,
+
+1027 
+
+->
+_i
+);
+
+1028 i(
+
+->
+_i
+->
+i_que
+ !
+NULL
+) {
+
+1029 
+
+->
+_i
+->
+	`i_que
+(
+RTM_DELETE
+,t,
+
+1030 &
+fo
+);
+
+1032 
+	`_a_i
+(
+
+, 
+i
+);
+
+1033 
+
+->
+_i
+ = 
+i
+->
+i_i
+;
+
+1034 i(
+i
+->
+i_que
+ !
+NULL
+)
+
+1035 
+i
+->
+	`i_que
+(
+RTM_ADD
+, 
+
+, &
+fo
+);
+
+1037 
+	`_wmsg
+(
+cmd
+, 
+t
+);
+
+1040  
+r
+;
+
+1041 
+	}
+}
+
+1043 c 
+_addr
+ 
+	gmask32
+ = {.
+s_addr
+ = 
+INADDR_BROADCAST
+};
+
+1047 
+	$_i_loeque
+(
+cmd
+, 
+iddr
+ *
+i
+)
+
+1049 
+sockaddr
+ *
+l1_
+;
+
+1050 
+sockaddr_
+ 
+l1_s
+;
+
+1051 #ifde
+INET6
+
+
+1052 
+sockaddr_6
+ 
+l1_s6
+;
+
+1054 
+y
+ *
+t
+ = 
+NULL
+;
+
+1055 
+ags
+, 
+e
+;
+
+1057 
+i
+->
+i_addr
+->
+_my
+) {
+
+1058 
+AF_INET
+:
+
+1059 
+	`sockaddr__
+(&
+l1_s
+, &
+mask32
+, 0);
+
+1060 
+l1_
+ = (
+sockaddr
+ *)&
+l1_s
+;
+
+1062 #ifde
+INET6
+
+
+1063 
+AF_INET6
+:
+
+1064 
+	`sockaddr_6_
+(&
+l1_s6
+, &
+6mask128
+, 0, 0, 0);
+
+1065 
+l1_
+ = (
+sockaddr
+ *)&
+l1_s6
+;
+
+1072 
+ags
+ = 
+RTF_UP
+ | 
+RTF_HOST
+ | 
+RTF_LOCAL
+;
+
+1073 i(!(
+i
+->
+i_i
+->
+if_ags
+ & (
+IFF_LOOPBACK
+ | 
+IFF_POINTOPOINT
+)))
+
+1074 
+ags
+ |
+RTF_LLINFO
+;
+
+1075 
+e
+ = 
+	`que
+(
+cmd
+, 
+i
+->
+i_addr
+, i->i_addr, 
+l1_
+, 
+ags
+, &
+t
+);
+
+1079 i(
+cmd
+ =
+RTM_ADD
+ && 
+t
+ && 
+i
+ !t->
+_i
+)
+
+1080 
+	`_a_i
+(
+t
+, 
+i
+);
+
+1082 
+	`_waddrmsg
+(
+cmd
+, 
+i
+, 
+e
+, 
+t
+);
+
+1083 i(
+t
+) {
+
+1084 i(
+cmd
+ =
+RTM_DELETE
+) {
+
+1085 i(
+t
+->
+_ft
+ <= 0) {
+
+1087 
+t
+->
+_ft
+++;
+
+1088 
+	`
+(
+t
+);
+
+1092 
+t
+->
+_ft
+--;
+
+1095  
+e
+;
+
+1096 
+	}
+}
+
+1103 
+	$_i_addlol
+(
+iddr
+ *
+i
+)
+
+1105 
+y
+ *
+
+;
+
+1106 
+e
+;
+
+1109 
+
+ = 
+	`loc1
+(
+i
+->
+i_addr
+, 0);
+
+1110 i(
+
+ =
+NULL
+ || (->
+_ags
+ & 
+RTF_HOST
+) == 0 ||
+
+1111 (
+
+->
+_i
+->
+if_ags
+ & 
+IFF_LOOPBACK
+) == 0)
+
+1112 
+e
+ = 
+	`_i_loeque
+(
+RTM_ADD
+, 
+i
+);
+
+1114 
+e
+ = 0;
+
+1115 
+	`_waddrmsg
+(
+RTM_NEWADDR
+, 
+i
+, 0, 
+NULL
+);
+
+1117 i(
+
+ !
+NULL
+)
+
+1118 
+
+->
+_ft
+--;
+
+1119  
+e
+;
+
+1120 
+	}
+}
+
+1127 
+	$_i_mlol
+(
+iddr
+ *
+i
+, idd*
+t_i
+)
+
+1129 
+y
+ *
+
+;
+
+1130 
+e
+ = 0;
+
+1132 
+
+ = 
+	`loc1
+(
+i
+->
+i_addr
+, 0);
+
+1142 i(
+
+ !
+NULL
+ &&
+
+1143 (
+
+->
+_ags
+ & 
+RTF_HOST
+) &&
+
+1144 (
+
+->
+_i
+->
+if_ags
+ & 
+IFF_LOOPBACK
+))
+
+1150 i(
+t_i
+ =
+NULL
+)
+
+1151 
+e
+ = 
+	`_i_loeque
+(
+RTM_DELETE
+, 
+i
+);
+
+1153 
+	`_a_i
+(
+
+, 
+t_i
+);
+
+1154 
+	`_wmsg
+(
+RTM_CHANGE
+, 
+
+);
+
+1157 
+	`_waddrmsg
+(
+RTM_DELADDR
+, 
+i
+, 0, 
+NULL
+);
+
+1158 i(
+
+ !
+NULL
+)
+
+1159 
+
+->
+_ft
+--;
+
+1160 
+	`tf
+("return here before failing\n");
+
+1161  
+e
+;
+
+1162 
+	}
+}
+
+1173 
+	$LIST_HEAD
+(, 
+tim_queue
+
+tim_queue_hd
+;
+
+1174 
+__de
+ = 0;
+
+1176 
+	#RTTIMER_CALLOUT
+(
+r
+) do { \
+
+1177 i(
+r
+->
+t_func
+ !
+NULL
+) { \
+
+1178 (*
+r
+->
+t_func
+)->
+t_
+,); \
+
+1180 
+	`que
+((
+RTM_DELETE
+, \
+
+1181 
+	`_gkey
+(
+r
+->
+t_
+), \
+
+1184 
+	}
+}  0)
+
+	)
+
+1194 
+	$_tim_
+()
+
+1196 
+	`as
+(
+__de
+ == 0);
+
+1198 
+	`LIST_INIT
+(&
+tim_queue_hd
+);
+
+1199 
+	`out_
+(&
+_tim_ch
+, 0);
+
+1200 
+	`out_t
+(&
+_tim_ch
+, 
+hz
+, 
+_tim_tim
+, 
+NULL
+);
+
+1201 
+__de
+ = 1;
+
+1202 
+	}
+}
+
+1204 
+tim_queue
+ *
+
+1205 
+	$_tim_queue_
+(
+u_t
+ 
+timeout
+)
+
+1207 
+tim_queue
+ *
+q
+;
+
+1209 i(
+__de
+ == 0)
+
+1210 
+	`_tim_
+();
+
+1212 
+	`R_Mloc
+(
+q
+, 
+tim_queue
+ *,  *rtq);
+
+1213 i(
+q
+ =
+NULL
+)
+
+1214  
+NULL
+;
+
+1215 
+	`memt
+(
+q
+, 0, (*rtq));
+
+1217 
+q
+->
+q_timeout
+ = 
+timeout
+;
+
+1218 
+	`TAILQ_INIT
+(&
+q
+->
+q_hd
+);
+
+1219 
+	`LIST_INSERT_HEAD
+(&
+tim_queue_hd
+, 
+q
+, 
+q_lk
+);
+
+1221  
+q
+;
+
+1222 
+	}
+}
+
+1225 
+	$_tim_queue_chge
+(
+tim_queue
+ *
+q
+, 
+timeout
+)
+
+1228 
+q
+->
+q_timeout
+ = 
+timeout
+;
+
+1229 
+	}
+}
+
+1232 
+	$_tim_queue_move_l
+(
+tim_queue
+ *
+q
+, 
+deroy
+)
+
+1234 
+tim
+ *
+r
+;
+
+1236 (
+r
+ = 
+	`TAILQ_FIRST
+(&
+q
+->
+q_hd
+)!
+NULL
+) {
+
+1237 
+	`LIST_REMOVE
+(
+r
+, 
+t_lk
+);
+
+1238 
+	`TAILQ_REMOVE
+(&
+q
+->
+q_hd
+, 
+r
+, 
+t_xt
+);
+
+1239 i(
+deroy
+)
+
+1240 
+	`RTTIMER_CALLOUT
+(
+r
+);
+
+1242 
+	`po_put
+(&
+tim_po
+, 
+r
+);
+
+1243 i(
+q
+->
+q_cou
+ > 0)
+
+1244 
+q
+->
+q_cou
+--;
+
+1246 
+	`tf
+("rt_timer_queue_remove_all: "
+
+1249 
+	}
+}
+
+1252 
+	$_tim_queue_deroy
+(
+tim_queue
+ *
+q
+, 
+deroy
+)
+
+1255 
+	`_tim_queue_move_l
+(
+q
+, 
+deroy
+);
+
+1257 
+	`LIST_REMOVE
+(
+q
+, 
+q_lk
+);
+
+1262 
+	}
+}
+
+1265 
+	$_tim_cou
+(
+tim_queue
+ *
+q
+)
+
+1267  
+q
+->
+q_cou
+;
+
+1268 
+	}
+}
+
+1271 
+	$_tim_move_l
+(
+y
+ *
+
+, 
+deroy
+)
+
+1273 
+tim
+ *
+r
+;
+
+1275 (
+r
+ = 
+	`LIST_FIRST
+(&
+
+->
+_tim
+)!
+NULL
+) {
+
+1276 
+	`LIST_REMOVE
+(
+r
+, 
+t_lk
+);
+
+1277 
+	`TAILQ_REMOVE
+(&
+r
+->
+t_queue
+->
+q_hd
+,, 
+t_xt
+);
+
+1278 i(
+deroy
+)
+
+1279 
+	`RTTIMER_CALLOUT
+(
+r
+);
+
+1280 i(
+r
+->
+t_queue
+->
+q_cou
+ > 0)
+
+1281 
+r
+->
+t_queue
+->
+q_cou
+--;
+
+1283 
+	`tf
+("rt_timer_remove_all:tq_counteached 0\n");
+
+1285 
+	`po_put
+(&
+tim_po
+, 
+r
+);
+
+1287 
+	}
+}
+
+1290 
+_tim_add
+(
+y
+ *
+
+,
+
+1291 (*
+func
+)(
+y
+ *, 
+tim
+ *),
+
+1292 
+tim_queue
+ *
+queue
+)
+
+1294 
+tim
+ *
+r
+;
+
+1295 
+s
+;
+
+1301 
+	`LIST_FOREACH
+(
+r
+, &
+
+->
+_tim
+, 
+t_lk
+) {
+
+1302 i(
+r
+->
+t_func
+ =
+func
+)
+
+1305 i(
+r
+ !
+NULL
+) {
+
+1306 
+	`LIST_REMOVE
+(
+r
+, 
+t_lk
+);
+
+1307 
+	`TAILQ_REMOVE
+(&
+r
+->
+t_queue
+->
+q_hd
+,, 
+t_xt
+);
+
+1308 i(
+r
+->
+t_queue
+->
+q_cou
+ > 0)
+
+1309 
+r
+->
+t_queue
+->
+q_cou
+--;
+
+1311 
+	`tf
+("rt_timer_add:tq_counteached 0\n");
+
+1313 
+s
+ = 
+	`lsot
+();
+
+1314 
+r
+ = 
+	`po_g
+(&
+tim_po
+, 
+PR_NOWAIT
+);
+
+1315 
+	`lx
+(
+s
+);
+
+1316 i(
+r
+ =
+NULL
+)
+
+1317  
+ENOBUFS
+;
+
+1320 
+	`memt
+(
+r
+, 0, (*r));
+
+1322 
+r
+->
+t_
+ = 
+
+;
+
+1323 
+r
+->
+t_time
+ = 
+time_uime
+;
+
+1324 
+r
+->
+t_func
+ = 
+func
+;
+
+1325 
+r
+->
+t_queue
+ = 
+queue
+;
+
+1326 
+	`LIST_INSERT_HEAD
+(&
+
+->
+_tim
+, 
+r
+, 
+t_lk
+);
+
+1327 
+	`TAILQ_INSERT_TAIL
+(&
+queue
+->
+q_hd
+, 
+r
+, 
+t_xt
+);
+
+1328 
+r
+->
+t_queue
+->
+q_cou
+++;
+
+1331 
+	}
+}
+
+1335 
+	$_tim_tim
+(*
+g
+)
+
+1337 
+tim_queue
+ *
+q
+;
+
+1338 
+tim
+ *
+r
+;
+
+1339 
+s
+;
+
+1341 
+s
+ = 
+	`lsot
+();
+
+1342 
+	`LIST_FOREACH
+(
+q
+, &
+tim_queue_hd
+, 
+q_lk
+) {
+
+1343 (
+r
+ = 
+	`TAILQ_FIRST
+(&
+q
+->
+q_hd
+)!
+NULL
+ &&
+
+1344 (
+r
+->
+t_time
+ + 
+q
+->
+q_timeout
+< 
+time_uime
+) {
+
+1345 
+	`LIST_REMOVE
+(
+r
+, 
+t_lk
+);
+
+1346 
+	`TAILQ_REMOVE
+(&
+q
+->
+q_hd
+, 
+r
+, 
+t_xt
+);
+
+1347 
+	`RTTIMER_CALLOUT
+(
+r
+);
+
+1348 
+	`po_put
+(&
+tim_po
+, 
+r
+);
+
+1349 i(
+q
+->
+q_cou
+ > 0)
+
+1350 
+q
+->
+q_cou
+--;
+
+1352 
+	`tf
+("rt_timer_timer:tq_counteached 0\n");
+
+1355 
+	`lx
+(
+s
+);
+
+1357 
+	`out_t
+(&
+_tim_ch
+, 
+hz
+, 
+_tim_tim
+, 
+NULL
+);
+
+1358 
+	}
+}
+
+1360 
+y
+ *
+
+1361 
+	$_che_
+(
+rou
+ *
+ro
+, 
+ag
+)
+
+1363 
+	`che_vs
+(
+ro
+);
+
+1364 
+	`KASSERT
+(
+ro
+->
+_ro_
+ =
+NULL
+);
+
+1366 i(
+	`che_gd
+(
+ro
+=
+NULL
+)
+
+1367  
+NULL
+;
+
+1368 
+ro
+->
+ro_vid
+ = 
+l
+;
+
+1369 i((
+ro
+->
+_ro_
+ = 
+	`loc1
+(
+	`che_gd
+o), 
+ag
+)!
+NULL
+)
+
+1370 
+	`che
+(
+ro
+);
+
+1372 
+	`che_vs
+(
+ro
+);
+
+1373  
+ro
+->
+_ro_
+;
+
+1374 
+	}
+}
+
+1376 
+y
+ *
+
+1377 
+	$che_
+(
+rou
+ *
+ro
+)
+
+1379  
+	`_che_
+(
+ro
+, 1);
+
+1380 
+	}
+}
+
+1382 
+y
+ *
+
+1383 
+	$che__noe
+(
+rou
+ *
+ro
+)
+
+1385  
+	`_che_
+(
+ro
+, 0);
+
+1386 
+	}
+}
+
+1388 
+y
+ *
+
+1389 
+	$che_upde
+(
+rou
+ *
+ro
+, 
+e
+)
+
+1391 
+	`che_r
+(
+ro
+);
+
+1392  
+	`_che_
+(
+ro
+, 
+e
+);
+
+1393 
+	}
+}
+
+1396 
+	$che_cy
+(
+rou
+ *
+w_ro
+, c rou *
+d_ro
+)
+
+1398 
+y
+ *
+
+;
+
+1400 
+	`KASSERT
+(
+w_ro
+ !
+d_ro
+);
+
+1401 
+	`che_vs
+(
+w_ro
+);
+
+1402 
+	`che_vs
+(
+d_ro
+);
+
+1404 i((
+
+ = 
+	`che_vide
+(
+d_ro
+)!
+NULL
+)
+
+1405 
+
+->
+_ft
+++;
+
+1407 i(
+	`che_gd
+(
+d_ro
+=
+NULL
+ ||
+
+1408 
+	`che_td
+(
+w_ro
+, 
+	`che_gd
+(
+d_ro
+)) != 0)
+
+1411 
+w_ro
+->
+ro_vid
+ = 
+l
+;
+
+1412 i((
+w_ro
+->
+_ro_
+ = 
+
+!
+NULL
+)
+
+1413 
+	`che
+(
+w_ro
+);
+
+1414 
+	`che_vs
+(
+w_ro
+);
+
+1415 
+	}
+}
+
+1417 
+dom_li
+ 
+	gvid_rous
+ = 
+LIST_HEAD_INITIALIZER
+(dom_rtlist);
+
+1420 
+	$che_vide
+(
+dom_li
+ *
+li
+)
+
+1422 
+rou
+ *
+ro
+;
+
+1424 (
+ro
+ = 
+	`LIST_FIRST
+(
+li
+)!
+NULL
+) {
+
+1425 
+	`che_vs
+(
+ro
+);
+
+1426 
+	`KASSERT
+(
+ro
+->
+_ro_
+ !
+NULL
+);
+
+1427 
+ro
+->
+ro_vid
+ = 
+ue
+;
+
+1428 
+	`LIST_REMOVE
+(
+ro
+, 
+ro_che_xt
+);
+
+1429 
+	`LIST_INSERT_HEAD
+(&
+vid_rous
+, 
+ro
+, 
+ro_che_xt
+);
+
+1430 
+	`che_vs
+(
+ro
+);
+
+1432 
+	}
+}
+
+1435 
+	$che_r
+(
+rou
+ *
+ro
+)
+
+1437 
+	`che_vs
+(
+ro
+);
+
+1438 i(
+ro
+->
+_ro_
+ =
+NULL
+)
+
+1441 
+	`LIST_REMOVE
+(
+ro
+, 
+ro_che_xt
+);
+
+1443 
+	`
+(
+ro
+->
+_ro_
+);
+
+1444 
+ro
+->
+_ro_
+ = 
+NULL
+;
+
+1445 
+ro
+->
+ro_vid
+ = 
+l
+;
+
+1446 
+	`che_vs
+(
+ro
+);
+
+1447 
+	}
+}
+
+1449 
+y
+ *
+
+1450 
+	$che_lookup2
+(
+rou
+ *
+ro
+, c 
+sockaddr
+ *
+d
+, 
+e
+,
+
+1451 *
+hp
+)
+
+1453 c 
+sockaddr
+ *
+od
+;
+
+1454 
+y
+ *
+
+ = 
+NULL
+;
+
+1456 
+od
+ = 
+	`che_gd
+(
+ro
+);
+
+1457 i(
+od
+ =
+NULL
+)
+
+1458 
+miss
+;
+
+1460 i(
+	`sockaddr_cmp
+(
+od
+, 
+d
+) != 0) {
+
+1461 
+	`che_
+(
+ro
+);
+
+1462 
+miss
+;
+
+1465 
+
+ = 
+	`che_vide
+(
+ro
+);
+
+1466 i(
+
+ =
+NULL
+) {
+
+1467 
+	`che_r
+(
+ro
+);
+
+1468 
+miss
+;
+
+1471 *
+hp
+ = 1;
+
+1472 
+	`che_vs
+(
+ro
+);
+
+1474  
+
+;
+
+1475 
+miss
+:
+
+1476 *
+hp
+ = 0;
+
+1477 i(
+	`che_td
+(
+ro
+, 
+d
+) == 0)
+
+1478 
+
+ = 
+	`_che_
+(
+ro
+, 
+e
+);
+
+1480 
+	`che_vs
+(
+ro
+);
+
+1482  
+
+;
+
+1483 
+	}
+}
+
+1486 
+	$che_
+(
+rou
+ *
+ro
+)
+
+1488 
+	`che_r
+(
+ro
+);
+
+1489 i(
+ro
+->
+ro_
+ !
+NULL
+) {
+
+1490 
+	`sockaddr_
+(
+ro
+->
+ro_
+);
+
+1491 
+ro
+->
+ro_
+ = 
+NULL
+;
+
+1493 
+	`che_vs
+(
+ro
+);
+
+1494 
+	}
+}
+
+1497 
+	$che_td
+(
+rou
+ *
+ro
+, c 
+sockaddr
+ *
+
+)
+
+1499 
+	`KASSERT
+(
+
+ !
+NULL
+);
+
+1501 
+	`che_vs
+(
+ro
+);
+
+1502 i(
+ro
+->
+ro_
+ !
+NULL
+) {
+
+1503 i(
+ro
+->
+ro_
+->
+_my
+ =
+
+->sa_family) {
+
+1504 
+	`che_r
+(
+ro
+);
+
+1505 
+	`sockaddr_cy
+(
+ro
+->
+ro_
+,o->ro_->
+_n
+, 
+
+);
+
+1506 
+	`che_vs
+(
+ro
+);
+
+1510 
+	`che_
+(
+ro
+);
+
+1513 
+	`KASSERT
+(
+ro
+->
+_ro_
+ =
+NULL
+);
+
+1515 i((
+ro
+->
+ro_
+ = 
+	`sockaddr_dup
+(
+
+, 
+M_ZERO
+ | 
+M_NOWAIT
+)=
+NULL
+) {
+
+1516 
+	`che_vs
+(
+ro
+);
+
+1517  
+ENOMEM
+;
+
+1519 
+	`che_vs
+(
+ro
+);
+
+1521 
+	}
+}
+
+1523 c 
+sockaddr
+ *
+
+1524 
+	$_ag
+(
+y
+ *
+
+, c 
+sockaddr
+ *
+g
+)
+
+1526 i(
+
+->
+_g
+ !
+g
+) {
+
+1527 i(
+
+->
+_g
+ !
+NULL
+)
+
+1528 
+	`sockaddr_
+(
+
+->
+_g
+);
+
+1529 
+
+->
+_g
+ = 
+	`sockaddr_dup
+(
+g
+, 
+M_ZERO
+ | 
+M_NOWAIT
+);
+
+1531  
+
+->
+_g
+;
+
+1532 
+	}
+}
+
+1534 
+sockaddr
+ *
+
+1535 
+	$_gg
+(
+y
+ *
+
+)
+
+1537  
+
+->
+_g
+;
+
+1538 
+	}
+}
+
+	@route.h
+
+34 #ide
+_NET_ROUTE_H_
+
+
+35 
+	#_NET_ROUTE_H_
+
+
+	)
+
+37 
+	~<sys/queue.h
+>
+
+38 
+	~<sys/sock.h
+>
+
+39 
+	~<sys/tys.h
+>
+
+40 
+	~<t/if.h
+>
+
+42 #i!(
+defed
+(
+_KERNEL
+|| defed(
+_STANDALONE
+))
+
+43 
+	~<dbo.h
+>
+
+58 
+	srou
+ {
+
+59 
+y
+ *
+	m_ro_
+;
+
+60 
+sockaddr
+ *
+	mro_
+;
+
+61 
+LIST_ENTRY
+(
+rou
+
+	mro_che_xt
+;
+
+62 
+bo
+ 
+	mro_vid
+;
+
+69 
+	s_mrics
+ {
+
+70 
+ut64_t
+ 
+	mrmx_locks
+;
+
+71 
+ut64_t
+ 
+	mrmx_mtu
+;
+
+72 
+ut64_t
+ 
+	mrmx_hcou
+;
+
+73 
+ut64_t
+ 
+	mrmx_cvpe
+;
+
+74 
+ut64_t
+ 
+	mrmx_ndpe
+;
+
+75 
+ut64_t
+ 
+	mrmx_shsh
+;
+
+76 
+ut64_t
+ 
+	mrmx_t
+;
+
+77 
+ut64_t
+ 
+	mrmx_tv
+;
+
+78 
+time_t
+ 
+	mrmx_expe
+;
+
+79 
+time_t
+ 
+	mrmx_pk
+;
+
+87 
+	#RTM_RTTUNIT
+ 1000000
+
+	)
+
+88 
+	#RTTTOPRHZ
+(
+r
+(/ (
+RTM_RTTUNIT
+ / 
+PR_SLOWHZ
+))
+
+	)
+
+98 #ide
+RNF_NORMAL
+
+
+99 
+	~<t/dix.h
+>
+
+101 
+	sy
+ {
+
+102 
+dix_node
+ 
+	m_nodes
+[2];
+
+103 
+	#_mask
+(
+r
+((c 
+sockaddr
+ *)()->
+_nodes
+->
+_mask
+))
+
+	)
+
+104 
+sockaddr
+ *
+	m_geway
+;
+
+105 
+	m_ags
+;
+
+106 
+	m_ft
+;
+
+107 
+ut64_t
+ 
+	m_u
+;
+
+108 
+i
+ *
+	m_i
+;
+
+109 
+iddr
+ *
+	m_i
+;
+
+110 
+ut32_t
+ 
+	m_i_qno
+;
+
+111 * 
+	m_fo
+;
+
+112 
+_mrics
+ 
+	m_rmx
+;
+
+113 
+y
+ *
+	m_gwrou
+;
+
+114 
+LIST_HEAD
+(, 
+tim
+
+	m_tim
+;
+
+115 
+y
+ *
+	m_
+;
+
+116 
+sockaddr
+ *
+	m__key
+;
+
+117 
+sockaddr
+ *
+	m_g
+;
+
+120 
+le
+ c 
+sockaddr
+ *
+
+121 
+	$_gkey
+(c 
+y
+ *
+
+)
+
+123  
+
+->
+__key
+;
+
+124 
+	}
+}
+
+130 
+	sry
+ {
+
+131 
+ut32_t
+ 
+	m_hash
+;
+
+132 
+sockaddr
+ 
+	m_d
+;
+
+133 
+sockaddr
+ 
+	m_geway
+;
+
+134 
+t16_t
+ 
+	m_ags
+;
+
+135 
+t16_t
+ 
+	m_ft
+;
+
+136 
+ut32_t
+ 
+	m_u
+;
+
+137 
+i
+ *
+	m_i
+;
+
+140 
+	#RTF_UP
+ 0x1
+
+	)
+
+141 
+	#RTF_GATEWAY
+ 0x2
+
+	)
+
+142 
+	#RTF_HOST
+ 0x4
+
+	)
+
+143 
+	#RTF_REJECT
+ 0x8
+
+	)
+
+144 
+	#RTF_DYNAMIC
+ 0x10
+
+	)
+
+145 
+	#RTF_MODIFIED
+ 0x20
+
+	)
+
+146 
+	#RTF_DONE
+ 0x40
+
+	)
+
+147 
+	#RTF_MASK
+ 0x80
+
+	)
+
+148 
+	#RTF_CLONING
+ 0x100
+
+	)
+
+149 
+	#RTF_XRESOLVE
+ 0x200
+
+	)
+
+150 
+	#RTF_LLINFO
+ 0x400
+
+	)
+
+151 
+	#RTF_STATIC
+ 0x800
+
+	)
+
+152 
+	#RTF_BLACKHOLE
+ 0x1000
+
+	)
+
+153 
+	#RTF_CLONED
+ 0x2000
+
+	)
+
+154 
+	#RTF_PROTO2
+ 0x4000
+
+	)
+
+155 
+	#RTF_PROTO1
+ 0x8000
+
+	)
+
+156 
+	#RTF_SRC
+ 0x10000
+
+	)
+
+157 
+	#RTF_ANNOUNCE
+ 0x20000
+
+	)
+
+158 
+	#RTF_LOCAL
+ 0x40000
+
+	)
+
+159 
+	#RTF_BROADCAST
+ 0x80000
+
+	)
+
+164 
+	s
+ {
+
+165 
+ut64_t
+ 
+	ms_badde
+;
+
+166 
+ut64_t
+ 
+	ms_dymic
+;
+
+167 
+ut64_t
+ 
+	ms_wgeway
+;
+
+168 
+ut64_t
+ 
+	ms_uch
+;
+
+169 
+ut64_t
+ 
+	ms_wdrd
+;
+
+177 #i!
+defed
+(
+_KERNEL
+|| !defed(
+COMPAT_RTSOCK
+)
+
+183 
+	#__ign64
+ 
+	`__igd
+((
+ut64_t
+))
+
+	)
+
+185 
+	#__ign64
+
+
+	)
+
+188 
+	s_msghdr
+ {
+
+189 
+u_sht
+ 
+m_msgn
+ 
+	m__ign64
+;
+
+191 
+u_ch
+ 
+	mm_vsi
+;
+
+192 
+u_ch
+ 
+	mm_ty
+;
+
+193 
+u_sht
+ 
+	mm_dex
+;
+
+194 
+	mm_ags
+;
+
+195 
+	mm_addrs
+;
+
+196 
+pid_t
+ 
+	mm_pid
+;
+
+197 
+	mm_q
+;
+
+198 
+	mm_o
+;
+
+199 
+	mm_u
+;
+
+200 
+	mm_s
+;
+
+201 
+_mrics
+ 
+m_rmx
+ 
+	m__ign64
+;
+
+205 #unde
+__ign64
+
+
+207 
+	#RTM_VERSION
+ 4
+
+	)
+
+209 
+	#RTM_ADD
+ 0x1
+
+	)
+
+210 
+	#RTM_DELETE
+ 0x2
+
+	)
+
+211 
+	#RTM_CHANGE
+ 0x3
+
+	)
+
+212 
+	#RTM_GET
+ 0x4
+
+	)
+
+213 
+	#RTM_LOSING
+ 0x5
+
+	)
+
+214 
+	#RTM_REDIRECT
+ 0x6
+
+	)
+
+215 
+	#RTM_MISS
+ 0x7
+
+	)
+
+216 
+	#RTM_LOCK
+ 0x8
+
+	)
+
+217 
+	#RTM_OLDADD
+ 0x9
+
+	)
+
+218 
+	#RTM_OLDDEL
+ 0x
+
+	)
+
+219 
+	#RTM_RESOLVE
+ 0xb
+
+	)
+
+220 
+	#RTM_NEWADDR
+ 0x
+
+	)
+
+221 
+	#RTM_DELADDR
+ 0xd
+
+	)
+
+222 
+	#RTM_OOIFINFO
+ 0x
+
+	)
+
+223 
+	#RTM_OIFINFO
+ 0x
+
+	)
+
+224 
+	#RTM_IFANNOUNCE
+ 0x10
+
+	)
+
+225 
+	#RTM_IEEE80211
+ 0x11
+
+	)
+
+226 
+	#RTM_SETGATE
+ 0x12
+
+	)
+
+229 
+	#RTM_LLINFO_UPD
+ 0x13
+
+	)
+
+232 
+	#RTM_IFINFO
+ 0x14
+
+	)
+
+233 
+	#RTM_CHGADDR
+ 0x15
+
+	)
+
+235 
+	#RTV_MTU
+ 0x1
+
+	)
+
+236 
+	#RTV_HOPCOUNT
+ 0x2
+
+	)
+
+237 
+	#RTV_EXPIRE
+ 0x4
+
+	)
+
+238 
+	#RTV_RPIPE
+ 0x8
+
+	)
+
+239 
+	#RTV_SPIPE
+ 0x10
+
+	)
+
+240 
+	#RTV_SSTHRESH
+ 0x20
+
+	)
+
+241 
+	#RTV_RTT
+ 0x40
+
+	)
+
+242 
+	#RTV_RTTVAR
+ 0x80
+
+	)
+
+247 
+	#RTA_DST
+ 0x1
+
+	)
+
+248 
+	#RTA_GATEWAY
+ 0x2
+
+	)
+
+249 
+	#RTA_NETMASK
+ 0x4
+
+	)
+
+250 
+	#RTA_GENMASK
+ 0x8
+
+	)
+
+251 
+	#RTA_IFP
+ 0x10
+
+	)
+
+252 
+	#RTA_IFA
+ 0x20
+
+	)
+
+253 
+	#RTA_AUTHOR
+ 0x40
+
+	)
+
+254 
+	#RTA_BRD
+ 0x80
+
+	)
+
+255 
+	#RTA_TAG
+ 0x100
+
+	)
+
+260 
+	#RTAX_DST
+ 0
+
+	)
+
+261 
+	#RTAX_GATEWAY
+ 1
+
+	)
+
+262 
+	#RTAX_NETMASK
+ 2
+
+	)
+
+263 
+	#RTAX_GENMASK
+ 3
+
+	)
+
+264 
+	#RTAX_IFP
+ 4
+
+	)
+
+265 
+	#RTAX_IFA
+ 5
+
+	)
+
+266 
+	#RTAX_AUTHOR
+ 6
+
+	)
+
+267 
+	#RTAX_BRD
+ 7
+
+	)
+
+268 
+	#RTAX_TAG
+ 8
+
+	)
+
+269 
+	#RTAX_MAX
+ 9
+
+	)
+
+271 
+	#RT_ROUNDUP2
+(
+a
+, 
+n
+(> 0 ? (1 + ((- 1| (- 1)): (n))
+
+	)
+
+272 
+	#RT_ROUNDUP
+(
+a
+
+	`RT_ROUNDUP2
+(), (
+ut64_t
+))
+
+	)
+
+273 
+	#RT_ADVANCE
+(
+x
+, 
+n
+(x +
+	`RT_ROUNDUP
+()->
+_n
+))
+
+	)
+
+275 
+	s_addrfo
+ {
+
+276 
+	mi_addrs
+;
+
+277 c 
+sockaddr
+ *
+	mi_fo
+[
+RTAX_MAX
+];
+
+278 
+	mi_ags
+;
+
+279 
+iddr
+ *
+	mi_i
+;
+
+280 
+i
+ *
+	mi_i
+;
+
+283 
+	srou_cb
+ {
+
+284 
+	m_cou
+;
+
+285 
+	m6_cou
+;
+
+286 
+	munud1
+;
+
+287 
+	mms_cou
+;
+
+288 
+	my_cou
+;
+
+297 
+	stim
+ {
+
+298 
+TAILQ_ENTRY
+(
+tim
+
+	mt_xt
+;
+
+299 
+LIST_ENTRY
+(
+tim
+
+	mt_lk
+;
+
+300 
+tim_queue
+ *
+	mt_queue
+;
+
+301 
+y
+ *
+	mt_
+;
+
+302 (*
+	mt_func
+)(
+	my
+ *, 
+	mtim
+ *);
+
+303 
+time_t
+ 
+	mt_time
+;
+
+306 
+	stim_queue
+ {
+
+307 
+	mq_timeout
+;
+
+308 
+	mq_cou
+;
+
+309 
+TAILQ_HEAD
+(, 
+tim
+
+	mq_hd
+;
+
+310 
+LIST_ENTRY
+(
+tim_queue
+
+	mq_lk
+;
+
+314 
+	gbl
+;
+
+315 
+bl
+ 
+	tbl_t
+;
+
+317 #ifde
+_KERNEL
+
+
+319 
+	sbl
+ {
+
+320 
+dix_node_hd
+ 
+	mt_h
+;
+
+323 
+	s_wkg
+ {
+
+324 
+	mw_
+;
+
+325 
+	mw_g
+;
+
+326 
+	mw_giv
+;
+
+327 
+	mw_eded
+;
+
+328 * 
+	mw_whe
+;
+
+329 
+	mw_tmemsize
+;
+
+330 
+	mw_tmemeded
+;
+
+331 * 
+	mw_tmem
+;
+
+335 
+	#RT_DPRINTF
+(
+__fmt
+, ...d{ }  0)
+
+	)
+
+337 
+	#RT_DPRINTF
+(
+__fmt
+, ...
+
+	)
+
+340 
+	swk
+ {
+
+341 (*
+	mrw_f
+)(
+	my
+ *, *);
+
+342 *
+	mrw_v
+;
+
+348 
+	srou_fo
+ {
+
+349 
+sockaddr
+ 
+	mri_d
+;
+
+350 
+sockaddr
+ 
+	mri_c
+;
+
+351 
+rou_cb
+ 
+	mri_cb
+;
+
+352 
+	mri_maxqn
+;
+
+353 
+ifqueue
+ 
+	mri_q
+;
+
+354 *
+	mri_sih
+;
+
+357 
+rou_fo
+oute_info;
+
+358 
+
+tstat;
+
+360 
+	gsock
+;
+
+362 
+_
+();
+
+364 
+_tim_add
+(
+y
+ *,
+
+365 (*)(
+y
+ *, 
+tim
+ *),
+
+366 
+tim_queue
+ *);
+
+368 
+	`_tim_cou
+(
+tim_queue
+ *);
+
+369 
+	`_tim_
+();
+
+370 
+	`_tim_queue_chge
+(
+tim_queue
+ *, );
+
+371 
+tim_queue
+ *
+
+372 
+	`_tim_queue_
+(
+u_t
+);
+
+373 
+	`_tim_queue_deroy
+(
+tim_queue
+ *, );
+
+374 
+	`_tim_queue_move_l
+(
+tim_queue
+ *, );
+
+375 
+	`_tim_move_l
+(
+y
+ *, );
+
+376 
+	`_tim_tim
+(*);
+
+378 
+	`_wmsg
+(, 
+y
+ *);
+
+379 
+y
+ *
+
+380 
+	`loc1
+(c 
+sockaddr
+ *, );
+
+381 
+	`
+(
+y
+ *);
+
+382 
+	`
+(
+iddr
+ *, , );
+
+383 
+	`de
+(c 
+sockaddr
+ *, const sockaddr *,
+
+384 c 
+sockaddr
+ *, , const sockaddr *,
+
+385 
+y
+ **);
+
+386 
+	`que
+(, c 
+sockaddr
+ *,
+
+387 c 
+sockaddr
+ *, const sockaddr *, ,
+
+388 
+y
+ **);
+
+389 
+	`que1
+(, 
+_addrfo
+ *, 
+y
+ **);
+
+391 
+	`_i_addlol
+(
+iddr
+ *);
+
+392 
+	`_i_mlol
+(
+iddr
+ *, ifaddr *);
+
+393 
+iddr
+ *
+
+394 
+	`_g_i
+(
+y
+ *);
+
+395 
+	`_gi
+(
+_addrfo
+ *);
+
+396 
+	`_a_i
+(
+y
+ *, 
+iddr
+ *);
+
+397 
+	`_tge
+(
+y
+ *, c 
+sockaddr
+ *);
+
+399 c 
+sockaddr
+ *
+
+400 
+	`_ag
+(
+y
+ *, c 
+sockaddr
+ *);
+
+401 
+sockaddr
+ *
+
+402 
+	`_gg
+(
+y
+ *);
+
+404 
+	`che_cy
+(
+rou
+ *, const route *);
+
+405 
+	`che_
+(
+rou
+ *);
+
+406 
+y
+ *
+
+407 
+	`che_
+(
+rou
+ *);
+
+408 
+y
+ *
+
+409 
+	`che__noe
+(
+rou
+ *);
+
+410 
+y
+ *
+
+411 
+	`che_lookup2
+(
+rou
+ *, c 
+sockaddr
+ *, ,
+
+413 
+	`che_td
+(
+rou
+ *, c 
+sockaddr
+ *);
+
+414 
+y
+ *
+
+415 
+	`che_upde
+(
+rou
+ *, );
+
+417 
+le
+ 
+
+418 
+	$che_vs
+(c 
+rou
+ *
+ro
+)
+
+420 
+	`KASSERT
+(
+ro
+->
+ro_
+ !
+NULL
+ ||o->
+_ro_
+ == NULL);
+
+421 
+	`KASSERT
+(!
+ro
+->
+ro_vid
+ ||o->
+_ro_
+ !
+NULL
+);
+
+422 
+	}
+}
+
+424 
+le
+ 
+y
+ *
+
+425 
+	$che_lookup1
+(
+rou
+ *
+ro
+, c 
+sockaddr
+ *
+d
+, 
+e
+)
+
+427 
+h
+;
+
+429  
+	`che_lookup2
+(
+ro
+, 
+d
+, 
+e
+, &
+h
+);
+
+430 
+	}
+}
+
+432 
+le
+ 
+y
+ *
+
+433 
+	$che_lookup_noe
+(
+rou
+ *
+ro
+, c 
+sockaddr
+ *
+d
+)
+
+435  
+	`che_lookup1
+(
+ro
+, 
+d
+, 0);
+
+436 
+	}
+}
+
+438 
+le
+ 
+y
+ *
+
+439 
+	$che_lookup
+(
+rou
+ *
+ro
+, c 
+sockaddr
+ *
+d
+)
+
+441  
+	`che_lookup1
+(
+ro
+, 
+d
+, 1);
+
+442 
+	}
+}
+
+444 
+le
+ c 
+sockaddr
+ *
+
+445 
+	$che_gd
+(c 
+rou
+ *
+ro
+)
+
+447 
+	`che_vs
+(
+ro
+);
+
+448  
+ro
+->
+ro_
+;
+
+449 
+	}
+}
+
+455 
+le
+ 
+y
+ *
+
+456 
+	$che_vide
+(c 
+rou
+ *
+ro
+)
+
+458 
+y
+ *
+
+ = 
+ro
+->
+_ro_
+;
+
+460 
+	`che_vs
+(
+ro
+);
+
+462 i(
+ro
+->
+ro_vid
+)
+
+463  
+NULL
+;
+
+465 i(
+
+ !
+NULL
+ && (->
+_ags
+ & 
+RTF_UP
+!0 &&t->
+_i
+ != NULL)
+
+466  
+
+;
+
+467  
+NULL
+;
+
+469 
+	}
+}
+
+472 
+_80211msg
+(
+i
+ *, , *, 
+size_t
+);
+
+473 
+_iounmsg
+(
+i
+ *, );
+
+474 
+_ifmsg
+(
+i
+ *);
+
+475 
+_missmsg
+(, c 
+_addrfo
+ *, , );
+
+476 
+mbuf
+ *
+
+477 
+_msg1
+(, 
+_addrfo
+ *, *, );
+
+478 
+_waddrmsg
+(, 
+iddr
+ *, , 
+y
+ *);
+
+479 
+rou_queue
+(
+mbuf
+ *, );
+
+482 
+_addaddr
+(
+bl_t
+ *, 
+y
+ *, c 
+sockaddr
+ *);
+
+483 
+_as_aive
+(c 
+y
+ *);
+
+484 
+y
+ *
+
+485 
+_daddr
+(
+bl_t
+ *, c 
+sockaddr
+ *,
+
+486 c 
+sockaddr
+ *);
+
+487 
+bl_t
+ *
+_gb
+(
+_my_t
+);
+
+488 
+_hd
+(
+bl_t
+ **, );
+
+489 
+y
+ *
+
+490 
+_lookup
+(
+bl_t
+ *, c 
+sockaddr
+ *,
+
+491 c 
+sockaddr
+ *);
+
+492 
+y
+ *
+
+493 
+_mchaddr
+(
+bl_t
+ *, c 
+sockaddr
+ *);
+
+494 
+_wk
+(
+_my_t
+, (*)(
+y
+ *, *), *);
+
+495 
+	`bl_
+();
+
+	@rtbl.c
+
+93 #ifde
+_KERNEL
+
+
+94 
+	~"t_rou.h
+"
+
+97 
+	~<sys/cdefs.h
+>
+
+98 
+__KERNEL_RCSID
+(0, "$NetBSD:tbl.c,v 1.1 2011/03/31 19:40:52 dyoung Exp $");
+
+100 
+	~<sys/m.h
+>
+
+101 
+	~<sys/kmem.h
+>
+
+102 
+	~<sys/sysl.h
+>
+
+103 
+	~<sys/sym.h
+>
+
+104 
+	~<sys/out.h
+>
+
+105 
+	~<sys/oc.h
+>
+
+106 
+	~<sys/mbuf.h
+>
+
+107 
+	~<sys/sock.h
+>
+
+108 
+	~<sys/sockv.h
+>
+
+109 
+	~<sys/doma.h
+>
+
+110 
+	~<sys/osw.h
+>
+
+111 
+	~<sys/kl.h
+>
+
+112 
+	~<sys/iol.h
+>
+
+113 
+	~<sys/po.h
+>
+
+114 
+	~<sys/kauth.h
+>
+
+116 
+	~<t/if.h
+>
+
+117 
+	~<t/if_dl.h
+>
+
+118 
+	~<t/rou.h
+>
+
+119 
+	~<t/w_cb.h
+>
+
+121 
+bl_t
+ *
+	g_bs
+[
+AF_MAX
++1];
+
+124 
+	$_hd
+(
+bl_t
+ **
+
+, 
+off
+)
+
+126 
+bl_t
+ *
+t
+;
+
+127 i(*
+
+ !
+NULL
+)
+
+129 i((
+t
+ = 
+	`kmem_loc
+((*t), 
+KM_SLEEP
+)=
+NULL
+)
+
+131 *
+
+ = 
+t
+;
+
+132  
+	`_hd0
+(&
+t
+->
+t_h
+, 
+off
+);
+
+133 
+	}
+}
+
+135 
+y
+ *
+
+136 
+	$_mchaddr
+(
+bl_t
+ *
+t
+, c 
+sockaddr
+ *
+d
+)
+
+138 
+dix_node_hd
+ *
+h
+ = &
+t
+->
+t_h
+;
+
+139 
+dix_node
+ *
+
+;
+
+141 
+
+ = 
+h
+->
+	`h_mchaddr
+(
+d
+,nh);
+
+142 i(
+
+ =
+NULL
+ || (->
+_ags
+ & 
+RNF_ROOT
+) != 0)
+
+143  
+NULL
+;
+
+144  (
+y
+ *)
+
+;
+
+145 
+	}
+}
+
+148 
+	$_addaddr
+(
+bl_t
+ *
+t
+, 
+y
+ *
+
+, c 
+sockaddr
+ *
+tmask
+)
+
+150 
+dix_node_hd
+ *
+h
+ = &
+t
+->
+t_h
+;
+
+151 
+dix_node
+ *
+
+;
+
+153 
+
+ = 
+h
+->
+	`h_addaddr
+(
+	`_gkey
+(
+
+), 
+tmask
+,nh,t->
+_nodes
+);
+
+155  (
+
+ =
+NULL
+? 
+EEXIST
+ : 0;
+
+156 
+	}
+}
+
+158 
+y
+ *
+
+159 
+	$_lookup
+(
+bl_t
+ *
+t
+, c 
+sockaddr
+ *
+d
+, c sockadd*
+tmask
+)
+
+161 
+dix_node_hd
+ *
+h
+ = &
+t
+->
+t_h
+;
+
+162 
+dix_node
+ *
+
+;
+
+164 
+
+ = 
+h
+->
+	`h_lookup
+(
+d
+, 
+tmask
+,nh);
+
+165 i(
+
+ =
+NULL
+ || (->
+_ags
+ & 
+RNF_ROOT
+) != 0)
+
+166  
+NULL
+;
+
+167  (
+y
+ *)
+
+;
+
+168 
+	}
+}
+
+170 
+y
+ *
+
+171 
+	$_daddr
+(
+bl_t
+ *
+t
+, c 
+sockaddr
+ *
+d
+,
+
+172 c 
+sockaddr
+ *
+tmask
+)
+
+174 
+dix_node_hd
+ *
+h
+ = &
+t
+->
+t_h
+;
+
+175 
+dix_node
+ *
+
+;
+
+177 i((
+
+ = 
+h
+->
+	`h_daddr
+(
+d
+, 
+tmask
+,nh)=
+NULL
+)
+
+178  
+NULL
+;
+
+179 i(
+
+->
+_ags
+ & (
+RNF_ACTIVE
+ | 
+RNF_ROOT
+))
+
+180 
+	`nic
+("%s", 
+__func__
+);
+
+181  (
+y
+ *)
+
+;
+
+182 
+	}
+}
+
+185 
+	$_wk_vis
+(
+dix_node
+ *
+
+, *
+v
+)
+
+187 
+wk
+ *
+rw
+ = (wk *)
+v
+;
+
+189  (*
+rw
+->
+rw_f
+)((
+y
+ *)
+
+,w->
+rw_v
+);
+
+190 
+	}
+}
+
+193 
+_wk
+(
+_my_t
+ 
+my
+, (*
+f
+)(
+y
+ *, *), *
+v
+)
+
+195 
+bl_t
+ *
+t
+ = 
+_bs
+[
+my
+];
+
+196 
+wk
+ 
+rw
+;
+
+198 i(
+t
+ =
+NULL
+)
+
+201 
+rw
+.
+rw_f
+ = 
+f
+;
+
+202 
+rw
+.
+rw_v
+ = 
+v
+;
+
+204  
+	`_wk
+(&
+t
+->
+t_h
+, 
+_wk_vis
+, &
+rw
+);
+
+205 
+	}
+}
+
+207 
+bl_t
+ *
+
+208 
+	$_gb
+(
+_my_t
+ 
+af
+)
+
+210 i(
+af
+ >
+	`__ycou
+(
+_bs
+))
+
+211  
+NULL
+;
+
+212  
+_bs
+[
+af
+];
+
+213 
+	}
+}
+
+216 
+	$bl_
+()
+
+218 
+doma
+ *
+dom
+;
+
+219 
+	`DOMAIN_FOREACH
+(
+dom
+)
+
+220 i(
+dom
+->
+dom_ch
+)
+
+221 
+dom
+->
+	`dom_ch
+(&
+_bs
+[dom->
+dom_my
+],
+
+222 
+dom
+->
+dom_offt
+);
+
+223 
+	}
+}
+
+226 
+	$_as_aive
+(c 
+y
+ *
+
+)
+
+228 i(
+
+->
+_nodes
+->
+_ags
+ & (
+RNF_ACTIVE
+ | 
+RNF_ROOT
+))
+
+229 
+	`nic
+ ("rtfree 2");
+
+230 
+	}
+}
+
+	@rtsock.c
+
+63 
+	~<sys/cdefs.h
+>
+
+64 
+__KERNEL_RCSID
+(0, "$NetBSD:tsock.c,v 1.171 2015/05/02 17:18:03tr Exp $");
+
+66 #ifde
+_KERNEL_OPT
+
+
+67 
+	~"t_.h
+"
+
+68 
+	~"t_ms.h
+"
+
+69 
+	~"t_comt_tbsd.h
+"
+
+72 
+	~<sys/m.h
+>
+
+73 
+	~<sys/sym.h
+>
+
+74 
+	~<sys/oc.h
+>
+
+75 
+	~<sys/sock.h
+>
+
+76 
+	~<sys/sockv.h
+>
+
+77 
+	~<sys/doma.h
+>
+
+78 
+	~<sys/osw.h
+>
+
+79 
+	~<sys/sysl.h
+>
+
+80 
+	~<sys/kauth.h
+>
+
+81 
+	~<sys/kmem.h
+>
+
+82 
+	~<sys/.h
+>
+
+83 #ifde
+RTSOCK_DEBUG
+
+
+84 
+	~<t/.h
+>
+
+87 
+	~<t/if.h
+>
+
+88 
+	~<t/rou.h
+>
+
+89 
+	~<t/w_cb.h
+>
+
+91 
+	~<tms/ms.h
+>
+
+93 #i
+defed
+(
+COMPAT_14
+|| defed(
+COMPAT_50
+)
+
+94 
+	~<comt/t/if.h
+>
+
+95 
+	~<comt/t/rou.h
+>
+
+97 #ifde
+COMPAT_RTSOCK
+
+
+98 
+	#RTM_XVERSION
+ 
+RTM_OVERSION
+
+
+	)
+
+99 
+	#RT_XADVANCE
+(
+a
+,
+b
+
+	`RT_OADVANCE
+,b)
+
+	)
+
+100 
+	#RT_XROUNDUP
+(
+n
+
+	`RT_OROUNDUP
+)
+
+	)
+
+101 
+	#PF_XROUTE
+ 
+PF_OROUTE
+
+
+	)
+
+102 
+	#_xmsghdr
+ 
+_msghdr50
+
+
+	)
+
+103 
+	#if_xmsghdr
+ 
+if_msghdr
+
+
+	)
+
+104 
+	#i_xmsghdr
+ 
+i_msghdr50
+
+
+	)
+
+105 
+	#if_xnounmsghdr
+ 
+if_nounmsghdr50
+
+
+	)
+
+106 
+	#COMPATNAME
+(
+x
+
+comt_50_
+ ## 
+	)
+x
+
+107 
+	#DOMAINNAME
+ "ou"
+
+	)
+
+108 
+CTASSERT
+((
+i_xmsghdr
+) == 20);
+
+109 
+DOMAIN_DEFINE
+(
+comt_50_roudoma
+);
+
+111 
+	#RTM_XVERSION
+ 
+RTM_VERSION
+
+
+	)
+
+112 
+	#RT_XADVANCE
+(
+a
+,
+b
+
+	`RT_ADVANCE
+,b)
+
+	)
+
+113 
+	#RT_XROUNDUP
+(
+n
+
+	`RT_ROUNDUP
+)
+
+	)
+
+114 
+	#PF_XROUTE
+ 
+PF_ROUTE
+
+
+	)
+
+115 
+	#_xmsghdr
+ 
+_msghdr
+
+
+	)
+
+116 
+	#if_xmsghdr
+ 
+if_msghdr
+
+
+	)
+
+117 
+	#i_xmsghdr
+ 
+i_msghdr
+
+
+	)
+
+118 
+	#if_xnounmsghdr
+ 
+if_nounmsghdr
+
+
+	)
+
+119 
+	#COMPATNAME
+(
+x
+
+	)
+x
+
+120 
+	#DOMAINNAME
+ "rou"
+
+	)
+
+121 
+CTASSERT
+((
+i_xmsghdr
+) == 24);
+
+122 #ifde
+COMPAT_50
+
+
+123 
+	#COMPATCALL
+(
+me
+, 
+gs
+
+comt_50_
+ ##am
+	)
+args
+
+125 
+DOMAIN_DEFINE
+(
+roudoma
+);
+
+126 #unde
+COMPAT_50
+
+
+127 #unde
+COMPAT_14
+
+
+130 #ide
+COMPATCALL
+
+
+131 
+	#COMPATCALL
+(
+me
+, 
+gs
+d{ }  0)
+
+	)
+
+134 #ifde
+RTSOCK_DEBUG
+
+
+135 
+	#RT_IN_PRINT
+(
+b
+, 
+a
+(
+	`_t
+((b), (b), \
+
+136 &((c 
+sockaddr_
+ *)
+fo
+.
+i_fo
+[(
+a
+)])->
+s_addr
+), (
+b
+))
+
+	)
+
+139 
+rou_fo
+ 
+COMPATNAME
+(route_info) = {
+
+140 .
+ri_d
+ = { .
+_n
+ = 2, .
+	g_my
+ = 
+PF_XROUTE
+, },
+
+141 .
+	gri_c
+ = { .
+_n
+ = 2, .
+	g_my
+ = 
+PF_XROUTE
+, },
+
+142 .
+	gri_maxqn
+ = 
+IFQ_MAXLEN
+,
+
+145 
+	#PRESERVED_RTF
+ (
+RTF_UP
+ | 
+RTF_GATEWAY
+ | 
+RTF_HOST
+ | 
+RTF_DONE
+ | 
+RTF_MASK
+)
+
+	)
+
+147 
+	$COMPATNAME
+(
+rou_
+)();
+
+148 
+	$COMPATNAME
+(
+rou_ouut
+)(
+mbuf
+ *, ...);
+
+150 
+	`_msg2
+(, 
+_addrfo
+ *, *, 
+_wkg
+ *, *);
+
+151 
+	`_xaddrs
+(
+u_ch
+, c *, c *, 
+_addrfo
+ *);
+
+152 
+mbuf
+ *
+	`_makeiounmsg
+(
+i
+ *, , ,
+
+153 
+_addrfo
+ *);
+
+154 
+	`_tmrics
+(, c 
+_xmsghdr
+ *, 
+y
+ *);
+
+155 
+	`m_tmrics
+(c 
+y
+ *, 
+_xmsghdr
+ *);
+
+156 
+	`sysl_t_rou_tup
+(
+sysog
+ **);
+
+157 
+	`sysl_dumry
+(
+y
+ *, *);
+
+158 
+	`sysl_ii
+(, 
+_wkg
+ *, );
+
+159 
+	`sysl_ab
+(
+SYSCTLFN_PROTO
+);
+
+160 
+	`_adjucou
+(, );
+
+163 
+	$_adjucou
+(
+af
+, 
+t
+)
+
+165 
+rou_cb
+ * c 
+cb
+ = &
+	`COMPATNAME
+(
+rou_fo
+).
+ri_cb
+;
+
+167 
+cb
+->
+y_cou
+ +
+t
+;
+
+169 
+af
+) {
+
+170 
+AF_INET
+:
+
+171 
+cb
+->
+_cou
+ +
+t
+;
+
+173 #ifde
+INET6
+
+
+174 
+AF_INET6
+:
+
+175 
+cb
+->
+6_cou
+ +
+t
+;
+
+178 
+AF_MPLS
+:
+
+179 
+cb
+->
+ms_cou
+ +
+t
+;
+
+182 
+	}
+}
+
+185 
+	$COMPATNAME
+(
+rou_ch
+)(
+sock
+ *
+so
+, 
+o
+)
+
+187 
+wcb
+ *
+
+;
+
+188 
+s
+, 
+r
+;
+
+190 
+	`KASSERT
+(
+	`sawcb
+(
+so
+=
+NULL
+);
+
+191 
+
+ = 
+	`kmem_zloc
+((*), 
+KM_SLEEP
+);
+
+192 
+
+->
+rcb_n
+ = (*rp);
+
+193 
+so
+->
+so_pcb
+ = 
+
+;
+
+195 
+s
+ = 
+	`lsot
+();
+
+196 i((
+r
+ = 
+	`w_ch
+(
+so
+, 
+o
+)) == 0) {
+
+197 
+	`_adjucou
+(
+
+->
+rcb_o
+.
+_oc
+, 1);
+
+198 
+
+->
+rcb_ddr
+ = &
+	`COMPATNAME
+(
+rou_fo
+).
+ri_c
+;
+
+199 
+
+->
+rcb_ddr
+ = &
+	`COMPATNAME
+(
+rou_fo
+).
+ri_d
+;
+
+201 
+	`lx
+(
+s
+);
+
+203 i(
+r
+) {
+
+204 
+	`kmem_
+(
+
+, (*rp));
+
+205 
+so
+->
+so_pcb
+ = 
+NULL
+;
+
+206  
+r
+;
+
+209 
+	`soisced
+(
+so
+);
+
+210 
+so
+->
+so_tis
+ |
+SO_USELOOPBACK
+;
+
+211 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+213  
+r
+;
+
+214 
+	}
+}
+
+217 
+	$COMPATNAME
+(
+rou_dach
+)(
+sock
+ *
+so
+)
+
+219 
+wcb
+ *
+
+ = 
+	`sawcb
+(
+so
+);
+
+220 
+s
+;
+
+222 
+	`KASSERT
+(
+
+ !
+NULL
+);
+
+223 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+225 
+s
+ = 
+	`lsot
+();
+
+226 
+	`_adjucou
+(
+
+->
+rcb_o
+.
+_oc
+, -1);
+
+227 
+	`w_dach
+(
+so
+);
+
+228 
+	`lx
+(
+s
+);
+
+229 
+	}
+}
+
+232 
+	$COMPATNAME
+(
+rou_ac
+)(
+sock
+ *
+so
+, 
+sockaddr
+ *
+m
+)
+
+234 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+236 
+	`nic
+("route_accept");
+
+238  
+EOPNOTSUPP
+;
+
+239 
+	}
+}
+
+242 
+	$COMPATNAME
+(
+rou_bd
+)(
+sock
+ *
+so
+, 
+sockaddr
+ *
+m
+, 
+lwp
+ *
+l
+)
+
+244 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+246  
+EOPNOTSUPP
+;
+
+247 
+	}
+}
+
+250 
+	$COMPATNAME
+(
+rou_li
+)(
+sock
+ *
+so
+, 
+lwp
+ *
+l
+)
+
+252 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+254  
+EOPNOTSUPP
+;
+
+255 
+	}
+}
+
+258 
+	$COMPATNAME
+(
+rou_c
+)(
+sock
+ *
+so
+, 
+sockaddr
+ *
+m
+, 
+lwp
+ *
+l
+)
+
+260 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+262  
+EOPNOTSUPP
+;
+
+263 
+	}
+}
+
+266 
+	$COMPATNAME
+(
+rou_c2
+)(
+sock
+ *
+so
+, sock *
+so2
+)
+
+268 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+270  
+EOPNOTSUPP
+;
+
+271 
+	}
+}
+
+274 
+	$COMPATNAME
+(
+rou_disc
+)(
+sock
+ *
+so
+)
+
+276 
+wcb
+ *
+
+ = 
+	`sawcb
+(
+so
+);
+
+277 
+s
+;
+
+279 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+280 
+	`KASSERT
+(
+
+ !
+NULL
+);
+
+282 
+s
+ = 
+	`lsot
+();
+
+283 
+	`soisdisced
+(
+so
+);
+
+284 
+	`w_disc
+(
+
+);
+
+285 
+	`lx
+(
+s
+);
+
+288 
+	}
+}
+
+291 
+	$COMPATNAME
+(
+rou_shutdown
+)(
+sock
+ *
+so
+)
+
+293 
+s
+;
+
+295 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+300 
+s
+ = 
+	`lsot
+();
+
+301 
+	`sondme
+(
+so
+);
+
+302 
+	`lx
+(
+s
+);
+
+304 
+	}
+}
+
+307 
+	$COMPATNAME
+(
+rou_abt
+)(
+sock
+ *
+so
+)
+
+309 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+311 
+	`nic
+("route_abort");
+
+313  
+EOPNOTSUPP
+;
+
+314 
+	}
+}
+
+317 
+	$COMPATNAME
+(
+rou_iol
+)(
+sock
+ *
+so
+, 
+u_lg
+ 
+cmd
+, *
+m
+,
+
+318 
+i
+ * 
+i
+)
+
+320  
+EOPNOTSUPP
+;
+
+321 
+	}
+}
+
+324 
+	$COMPATNAME
+(
+rou_
+)(
+sock
+ *
+so
+, 
+
+ *
+ub
+)
+
+326 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+329 
+	}
+}
+
+332 
+	$COMPATNAME
+(
+rou_addr
+)(
+sock
+ *
+so
+, 
+sockaddr
+ *
+m
+)
+
+334 
+wcb
+ *
+
+ = 
+	`sawcb
+(
+so
+);
+
+336 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+337 
+	`KASSERT
+(
+
+ !
+NULL
+);
+
+338 
+	`KASSERT
+(
+m
+ !
+NULL
+);
+
+340 i(
+
+->
+rcb_ddr
+ =
+NULL
+)
+
+341  
+ENOTCONN
+;
+
+343 
+	`w_ddr
+(
+
+, 
+m
+);
+
+345 
+	}
+}
+
+348 
+	$COMPATNAME
+(
+rou_sockaddr
+)(
+sock
+ *
+so
+, 
+sockaddr
+ *
+m
+)
+
+350 
+wcb
+ *
+
+ = 
+	`sawcb
+(
+so
+);
+
+352 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+353 
+	`KASSERT
+(
+
+ !
+NULL
+);
+
+354 
+	`KASSERT
+(
+m
+ !
+NULL
+);
+
+356 i(
+
+->
+rcb_ddr
+ =
+NULL
+)
+
+357  
+ENOTCONN
+;
+
+359 
+	`w_tsockaddr
+(
+
+, 
+m
+);
+
+361 
+	}
+}
+
+364 
+	$COMPATNAME
+(
+rou_rcvd
+)(
+sock
+ *
+so
+, 
+ags
+, 
+lwp
+ *
+l
+)
+
+366 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+368  
+EOPNOTSUPP
+;
+
+369 
+	}
+}
+
+372 
+	$COMPATNAME
+(
+rou_cvoob
+)(
+sock
+ *
+so
+, 
+mbuf
+ *
+m
+, 
+ags
+)
+
+374 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+376  
+EOPNOTSUPP
+;
+
+377 
+	}
+}
+
+380 
+	$COMPATNAME
+(
+rou_nd
+)(
+sock
+ *
+so
+, 
+mbuf
+ *
+m
+,
+
+381 
+sockaddr
+ *
+m
+, 
+mbuf
+ *
+c
+, 
+lwp
+ *
+l
+)
+
+383 
+r
+ = 0;
+
+384 
+s
+;
+
+386 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+388 
+s
+ = 
+	`lsot
+();
+
+389 
+r
+ = 
+	`w_nd
+(
+so
+, 
+m
+, 
+m
+, 
+c
+, 
+l
+);
+
+390 
+	`lx
+(
+s
+);
+
+392  
+r
+;
+
+393 
+	}
+}
+
+396 
+	$COMPATNAME
+(
+rou_ndoob
+)(
+sock
+ *
+so
+, 
+mbuf
+ *
+m
+,
+
+397 
+mbuf
+ *
+c
+)
+
+399 
+	`KASSERT
+(
+	`socked
+(
+so
+));
+
+401 
+	`m_m
+(
+m
+);
+
+402 
+	`m_m
+(
+c
+);
+
+404  
+EOPNOTSUPP
+;
+
+405 
+	}
+}
+
+407 
+	$COMPATNAME
+(
+rou_purgeif
+)(
+sock
+ *
+so
+, 
+i
+ *
+i
+)
+
+410 
+	`nic
+("route_purgeif");
+
+412  
+EOPNOTSUPP
+;
+
+413 
+	}
+}
+
+417 
+	$COMPATNAME
+(
+rou_ouut
+)(
+mbuf
+ *
+m
+, ...)
+
+419 
+socko
+ 
+o
+ = { .
+_my
+ = 
+PF_XROUTE
+, };
+
+420 
+_xmsghdr
+ *
+m
+ = 
+NULL
+;
+
+421 
+_xmsghdr
+ *
+d_m
+ = 
+NULL
+;
+
+422 
+y
+ *
+
+ = 
+NULL
+;
+
+423 
+y
+ *
+ved_t
+ = 
+NULL
+;
+
+424 
+_addrfo
+ 
+fo
+;
+
+425 
+n
+, 
+r
+ = 0;
+
+426 
+i
+ *
+i
+ = 
+NULL
+;
+
+427 
+iddr
+ *
+i
+ = 
+NULL
+;
+
+428 
+sock
+ *
+so
+;
+
+429 
+va_li
+ 
+
+;
+
+430 
+_my_t
+ 
+my
+;
+
+432 
+	`va_t
+(
+
+, 
+m
+);
+
+433 
+so
+ = 
+	`va_g
+(
+
+, 
+sock
+ *);
+
+434 
+	`va_d
+(
+
+);
+
+436 
+	#ndr
+(
+e
+d{ 
+r
+ =; 
+ush
+;}  0)
+
+	)
+
+437 i(
+m
+ =
+NULL
+ || ((m->
+m_n
+ < (
+t32_t
+)) &&
+
+438 (
+m
+ = 
+	`m_puup
+(m, (
+t32_t
+))=
+NULL
+))
+
+439  
+ENOBUFS
+;
+
+440 i((
+m
+->
+m_ags
+ & 
+M_PKTHDR
+) == 0)
+
+441 
+	`nic
+("%s", 
+__func__
+);
+
+442 
+n
+ = 
+m
+->
+m_pkthdr
+.len;
+
+443 i(
+n
+ < (*
+m
+) ||
+
+444 
+n
+ !
+	`mtod
+(
+m
+, 
+_xmsghdr
+ *)->
+m_msgn
+) {
+
+445 
+fo
+.
+i_fo
+[
+RTAX_DST
+] = 
+NULL
+;
+
+446 
+	`ndr
+(
+EINVAL
+);
+
+448 
+	`R_Mloc
+(
+m
+, 
+_xmsghdr
+ *, 
+n
+);
+
+449 i(
+m
+ =
+NULL
+) {
+
+450 
+fo
+.
+i_fo
+[
+RTAX_DST
+] = 
+NULL
+;
+
+451 
+	`ndr
+(
+ENOBUFS
+);
+
+453 
+	`m_cyda
+(
+m
+, 0, 
+n
+, 
+m
+);
+
+454 i(
+m
+->
+m_vsi
+ !
+RTM_XVERSION
+) {
+
+455 
+fo
+.
+i_fo
+[
+RTAX_DST
+] = 
+NULL
+;
+
+456 
+	`ndr
+(
+EPROTONOSUPPORT
+);
+
+458 
+m
+->
+m_pid
+ = 
+curoc
+->
+p_pid
+;
+
+459 
+	`memt
+(&
+fo
+, 0, (info));
+
+460 
+fo
+.
+i_addrs
+ = 
+m
+->
+m_addrs
+;
+
+461 i(
+	`_xaddrs
+(
+m
+->
+m_ty
+, (c *)tm + 1), 
+n
+ + (*)rtm,
+
+462 &
+fo
+)) {
+
+463 
+	`ndr
+(
+EINVAL
+);
+
+465 
+fo
+.
+i_ags
+ = 
+m
+->
+m_ags
+;
+
+466 #ifde
+RTSOCK_DEBUG
+
+
+467 i(
+fo
+.
+i_fo
+[
+RTAX_DST
+]->
+_my
+ =
+AF_INET
+) {
+
+468 
+abuf
+[
+INET_ADDRSTRLEN
+];
+
+469 
+	`tf
+("%s:xaed info.i_fo[RTAX_DST] %s\n", 
+__func__
+,
+
+470 
+	`RT_IN_PRINT
+(
+abuf
+, 
+RTAX_DST
+));
+
+473 i(
+fo
+.
+i_fo
+[
+RTAX_DST
+] =
+NULL
+ ||
+
+474 (
+fo
+.
+i_fo
+[
+RTAX_DST
+]->
+_my
+ >
+AF_MAX
+)) {
+
+475 
+	`ndr
+(
+EINVAL
+);
+
+477 i(
+fo
+.
+i_fo
+[
+RTAX_GATEWAY
+] !
+NULL
+ &&
+
+478 (
+fo
+.
+i_fo
+[
+RTAX_GATEWAY
+]->
+_my
+ >
+AF_MAX
+)) {
+
+479 
+	`ndr
+(
+EINVAL
+);
+
+486 i(
+	`kauth_authize_twk
+(
+cuwp
+->
+l_ed
+, 
+KAUTH_NETWORK_ROUTE
+,
+
+487 0, 
+m
+, 
+NULL
+, NULL) != 0)
+
+488 
+	`ndr
+(
+EACCES
+);
+
+490 
+m
+->
+m_ty
+) {
+
+492 
+RTM_ADD
+:
+
+493 i(
+fo
+.
+i_fo
+[
+RTAX_GATEWAY
+] =
+NULL
+) {
+
+494 
+	`ndr
+(
+EINVAL
+);
+
+496 
+r
+ = 
+	`que1
+(
+m
+->
+m_ty
+, &
+fo
+, &
+ved_t
+);
+
+497 i(
+r
+ =0 && 
+ved_t
+) {
+
+498 
+	`_tmrics
+(
+m
+->
+m_s
+,tm, 
+ved_t
+);
+
+499 
+ved_t
+->
+_ft
+--;
+
+503 
+RTM_DELETE
+:
+
+504 
+r
+ = 
+	`que1
+(
+m
+->
+m_ty
+, &
+fo
+, &
+ved_t
+);
+
+505 i(
+r
+ == 0) {
+
+506 (
+
+ = 
+ved_t
+)->
+_ft
+++;
+
+507 
+pt
+;
+
+511 
+RTM_GET
+:
+
+512 
+RTM_CHANGE
+:
+
+513 
+RTM_LOCK
+:
+
+518 
+r
+ = 
+	`que1
+(
+RTM_GET
+, &
+fo
+, &
+
+);
+
+519 i(
+r
+ != 0)
+
+520 
+	`ndr
+(
+r
+);
+
+521 i(
+m
+->
+m_ty
+ !
+RTM_GET
+) {
+
+522 i(
+	`memcmp
+(
+fo
+.
+i_fo
+[
+RTAX_DST
+], 
+	`_gkey
+(
+
+),
+
+523 
+fo
+.
+i_fo
+[
+RTAX_DST
+]->
+_n
+) != 0)
+
+524 
+	`ndr
+(
+ESRCH
+);
+
+525 i(
+fo
+.
+i_fo
+[
+RTAX_NETMASK
+] =
+NULL
+ &&
+
+526 
+	`_mask
+(
+
+!
+NULL
+)
+
+527 
+	`ndr
+(
+ETOOMANYREFS
+);
+
+530 
+m
+->
+m_ty
+) {
+
+531 
+RTM_GET
+:
+
+532 
+pt
+:
+
+533 
+fo
+.
+i_fo
+[
+RTAX_DST
+] = 
+	`_gkey
+(
+
+);
+
+534 
+fo
+.
+i_fo
+[
+RTAX_GATEWAY
+] = 
+
+->
+_geway
+;
+
+535 
+fo
+.
+i_fo
+[
+RTAX_NETMASK
+] = 
+	`_mask
+(
+
+);
+
+536 
+fo
+.
+i_fo
+[
+RTAX_TAG
+] = 
+	`_gg
+(
+
+);
+
+537 i((
+m
+->
+m_addrs
+ & (
+RTA_IFP
+ | 
+RTA_IFA
+)) == 0)
+
+539 i((
+i
+ = 
+
+->
+_i
+!
+NULL
+) {
+
+540 c 
+iddr
+ *
+i
+;
+
+541 
+fo
+.
+i_fo
+[
+RTAX_IFP
+] = 
+i
+->
+if_dl
+->
+i_addr
+;
+
+547 
+i
+ = 
+	`_g_i
+(
+
+);
+
+548 
+fo
+.
+i_fo
+[
+RTAX_IFA
+] = 
+i
+->
+i_addr
+;
+
+549 #ifde
+RTSOCK_DEBUG
+
+
+550 i(
+fo
+.
+i_fo
+[
+RTAX_IFA
+]->
+_my
+ ==
+
+551 
+AF_INET
+) {
+
+552 
+ibuf
+[
+INET_ADDRSTRLEN
+];
+
+553 
+abuf
+[
+INET_ADDRSTRLEN
+];
+
+554 
+	`tf
+("%s: copying out RTAX_IFA %s "
+
+557 
+__func__
+,
+
+558 
+	`RT_IN_PRINT
+(
+ibuf
+, 
+RTAX_IFA
+),
+
+559 
+	`RT_IN_PRINT
+(
+abuf
+, 
+RTAX_DST
+),
+
+560 (*)
+i
+->
+i_gi
+,
+
+561 
+i
+->
+i_qno
+);
+
+564 i(
+i
+->
+if_ags
+ & 
+IFF_POINTOPOINT
+) {
+
+565 
+fo
+.
+i_fo
+[
+RTAX_BRD
+] =
+
+566 
+i
+->
+i_daddr
+;
+
+568 
+fo
+.
+i_fo
+[
+RTAX_BRD
+] = 
+NULL
+;
+
+569 
+m
+->
+m_dex
+ = 
+i
+->
+if_dex
+;
+
+571 
+fo
+.
+i_fo
+[
+RTAX_IFP
+] = 
+NULL
+;
+
+572 
+fo
+.
+i_fo
+[
+RTAX_IFA
+] = 
+NULL
+;
+
+574 ()
+	`_msg2
+(
+m
+->
+m_ty
+, &
+fo
+, 
+NULL
+, NULL, &
+n
+);
+
+575 i(
+n
+ > 
+m
+->
+m_msgn
+) {
+
+576 
+d_m
+ = 
+m
+;
+
+577 
+	`R_Mloc
+(
+m
+, 
+_xmsghdr
+ *, 
+n
+);
+
+578 i(
+m
+ =
+NULL
+)
+
+579 
+	`ndr
+(
+ENOBUFS
+);
+
+580 ()
+	`memy
+(
+m
+, 
+d_m
+, old_m->
+m_msgn
+);
+
+582 ()
+	`_msg2
+(
+m
+->
+m_ty
+, &
+fo
+,tm, 
+NULL
+, 0);
+
+583 
+m
+->
+m_ags
+ = 
+
+->
+_ags
+;
+
+584 
+	`m_tmrics
+(
+
+, 
+m
+);
+
+585 
+m
+->
+m_addrs
+ = 
+fo
+.
+i_addrs
+;
+
+588 
+RTM_CHANGE
+:
+
+594 i((
+r
+ = 
+	`_gi
+(&
+fo
+)) != 0)
+
+595 
+	`ndr
+(
+r
+);
+
+596 i(
+fo
+.
+i_fo
+[
+RTAX_GATEWAY
+] &&
+
+597 
+	`_tge
+(
+
+, 
+fo
+.
+i_fo
+[
+RTAX_GATEWAY
+]))
+
+598 
+	`ndr
+(
+EDQUOT
+);
+
+599 i(
+fo
+.
+i_fo
+[
+RTAX_TAG
+])
+
+600 
+	`_ag
+(
+
+, 
+fo
+.
+i_fo
+[
+RTAX_TAG
+]);
+
+604 i(
+fo
+.
+i_fo
+[
+RTAX_IFP
+] &&
+
+605 (
+i
+ = 
+	`i_ifwht
+(
+fo
+.
+i_fo
+[
+RTAX_IFP
+])) &&
+
+606 (
+i
+ = 
+i
+->
+i_i
+&& (
+fo
+.
+i_fo
+[
+RTAX_IFA
+] ||
+
+607 
+fo
+.
+i_fo
+[
+RTAX_GATEWAY
+])) {
+
+608 i(
+fo
+.
+i_fo
+[
+RTAX_IFA
+] =
+NULL
+ ||
+
+609 (
+i
+ = 
+	`i_ifwhaddr
+(
+
+610 
+fo
+.
+i_fo
+[
+RTAX_IFA
+])=
+NULL
+)
+
+611 
+i
+ = 
+	`iof_ifaddr
+(
+
+612 
+fo
+.
+i_fo
+[
+RTAX_IFA
+] ?
+
+613 
+fo
+.
+i_fo
+[
+RTAX_IFA
+] :
+
+614 
+fo
+.
+i_fo
+[
+RTAX_GATEWAY
+], 
+i
+);
+
+615 } i((
+fo
+.
+i_fo
+[
+RTAX_IFA
+] &&
+
+616 (
+i
+ = 
+	`i_ifwhaddr
+(
+fo
+.
+i_fo
+[
+RTAX_IFA
+]))) ||
+
+617 (
+fo
+.
+i_fo
+[
+RTAX_GATEWAY
+] &&
+
+618 (
+i
+ = 
+	`i_ifwhrou
+(
+
+->
+_ags
+,
+
+619 
+	`_gkey
+(
+
+), 
+fo
+.
+i_fo
+[
+RTAX_GATEWAY
+])))) {
+
+620 
+i
+ = 
+i
+->
+i_i
+;
+
+622 i(
+i
+) {
+
+623 
+iddr
+ *
+oi
+ = 
+
+->
+_i
+;
+
+624 i(
+oi
+ !
+i
+) {
+
+625 i(
+oi
+ && oi->
+i_que
+) {
+
+626 
+oi
+->
+	`i_que
+(
+RTM_DELETE
+,
+
+627 
+
+, &
+fo
+);
+
+629 
+	`_a_i
+(
+
+, 
+i
+);
+
+630 
+
+->
+_i
+ = 
+i
+;
+
+633 i(
+i
+ && 
+
+->
+_i
+ != ifp)
+
+634 
+
+->
+_i
+ = 
+i
+;
+
+635 
+	`_tmrics
+(
+m
+->
+m_s
+,tm, 
+
+);
+
+636 i(
+
+->
+_ags
+ !
+fo
+.
+i_ags
+)
+
+637 
+
+->
+_ags
+ = (
+fo
+.
+i_ags
+ & ~
+PRESERVED_RTF
+)
+
+638 | (
+
+->
+_ags
+ & 
+PRESERVED_RTF
+);
+
+639 i(
+
+->
+_i
+ &&t->_i->
+i_que
+)
+
+640 
+
+->
+_i
+->
+	`i_que
+(
+RTM_ADD
+,t, &
+fo
+);
+
+642 
+RTM_LOCK
+:
+
+643 
+
+->
+_rmx
+.
+rmx_locks
+ &~(
+m
+->
+m_s
+);
+
+644 
+
+->
+_rmx
+.
+rmx_locks
+ |=
+
+645 (
+m
+->
+m_s
+ &tm->
+m_rmx
+.
+rmx_locks
+);
+
+651 
+	`ndr
+(
+EOPNOTSUPP
+);
+
+654 
+ush
+:
+
+655 i(
+m
+) {
+
+656 i(
+r
+)
+
+657 
+m
+->
+m_o
+ = 
+r
+;
+
+659 
+m
+->
+m_ags
+ |
+RTF_DONE
+;
+
+661 
+my
+ = 
+fo
+.
+i_fo
+[
+RTAX_DST
+] ? info.i_fo[RTAX_DST]->
+_my
+ :
+
+667 i(
+d_m
+ !
+NULL
+)
+
+668 
+	`Fe
+(
+d_m
+);
+
+669 i(
+
+)
+
+670 
+	`
+(
+
+);
+
+672 
+wcb
+ *
+
+ = 
+NULL
+;
+
+676 i((
+so
+->
+so_tis
+ & 
+SO_USELOOPBACK
+) == 0) {
+
+677 i(
+	`COMPATNAME
+(
+rou_fo
+).
+ri_cb
+.
+y_cou
+ <= 1) {
+
+678 i(
+m
+)
+
+679 
+	`Fe
+(
+m
+);
+
+680 
+	`m_m
+(
+m
+);
+
+681  
+r
+;
+
+684 
+
+ = 
+	`sawcb
+(
+so
+);
+
+686 i(
+m
+) {
+
+687 
+	`m_cyback
+(
+m
+, 0, 
+m
+->
+m_msgn
+,tm);
+
+688 i(
+m
+->
+m_pkthdr
+.
+n
+ < 
+m
+->
+m_msgn
+) {
+
+689 
+	`m_m
+(
+m
+);
+
+690 
+m
+ = 
+NULL
+;
+
+691 } i(
+m
+->
+m_pkthdr
+.
+n
+ > 
+m
+->
+m_msgn
+)
+
+692 
+	`m_adj
+(
+m
+, 
+m
+->
+m_msgn
+ - m->
+m_pkthdr
+.
+n
+);
+
+693 
+	`Fe
+(
+m
+);
+
+695 i(
+
+)
+
+696 
+
+->
+rcb_o
+.
+_my
+ = 0;
+
+697 i(
+my
+)
+
+698 
+o
+.
+_oc
+ = 
+my
+;
+
+699 i(
+m
+)
+
+700 
+	`w_put
+(
+m
+, &
+o
+, &
+	`COMPATNAME
+(
+rou_fo
+).
+ri_c
+,
+
+701 &
+	`COMPATNAME
+(
+rou_fo
+).
+ri_d
+);
+
+702 i(
+
+)
+
+703 
+
+->
+rcb_o
+.
+_my
+ = 
+PF_XROUTE
+;
+
+705  
+r
+;
+
+706 
+	}
+}
+
+709 
+	$_tmrics
+(
+which
+, c 
+_xmsghdr
+ *
+
+, 
+y
+ *
+out
+)
+
+711 
+	#mric
+(
+f
+, 
+e
+i(
+which
+ & (f)
+out
+->
+_rmx
+.
+
+->
+m_rmx
+.e;
+
+	)
+
+712 
+	`mric
+(
+RTV_RPIPE
+, 
+rmx_cvpe
+);
+
+713 
+	`mric
+(
+RTV_SPIPE
+, 
+rmx_ndpe
+);
+
+714 
+	`mric
+(
+RTV_SSTHRESH
+, 
+rmx_shsh
+);
+
+715 
+	`mric
+(
+RTV_RTT
+, 
+rmx_t
+);
+
+716 
+	`mric
+(
+RTV_RTTVAR
+, 
+rmx_tv
+);
+
+717 
+	`mric
+(
+RTV_HOPCOUNT
+, 
+rmx_hcou
+);
+
+718 
+	`mric
+(
+RTV_MTU
+, 
+rmx_mtu
+);
+
+719 
+	`mric
+(
+RTV_EXPIRE
+, 
+rmx_expe
+);
+
+720 #unde
+mric
+
+
+721 
+	}
+}
+
+724 
+	$m_tmrics
+(c 
+y
+ *
+
+, 
+_xmsghdr
+ *
+out
+)
+
+726 
+	#mric
+(
+e
+
+out
+->
+m_rmx
+.
+
+->
+_rmx
+.e;
+
+	)
+
+727 
+	`mric
+(
+rmx_cvpe
+);
+
+728 
+	`mric
+(
+rmx_ndpe
+);
+
+729 
+	`mric
+(
+rmx_shsh
+);
+
+730 
+	`mric
+(
+rmx_t
+);
+
+731 
+	`mric
+(
+rmx_tv
+);
+
+732 
+	`mric
+(
+rmx_hcou
+);
+
+733 
+	`mric
+(
+rmx_mtu
+);
+
+734 
+	`mric
+(
+rmx_expe
+);
+
+735 #unde
+mric
+
+
+736 
+	}
+}
+
+739 
+	$_xaddrs
+(
+u_ch
+ 
+mty
+, c *
+
+, c *
+lim
+,
+
+740 
+_addrfo
+ *
+fo
+)
+
+742 c 
+sockaddr
+ *
+
+ = 
+NULL
+;
+
+743 
+i
+;
+
+745 
+i
+ = 0; i < 
+RTAX_MAX
+ && 
+
+ < 
+lim
+; i++) {
+
+746 i((
+fo
+->
+i_addrs
+ & (1 << 
+i
+)) == 0)
+
+748 
+fo
+->
+i_fo
+[
+i
+] = 
+
+ = (c 
+sockaddr
+ *)
+
+;
+
+749 
+	`RT_XADVANCE
+(
+
+, 
+
+);
+
+756 i(
+mty
+ =
+RTM_GET
+) {
+
+757 i(((
+fo
+->
+i_addrs
+ &
+
+758 (~((1 << 
+RTAX_IFP
+| (1 << 
+RTAX_IFA
+)))& (~0 << 
+i
+)) != 0)
+
+760 } i((
+fo
+->
+i_addrs
+ & (~0 << 
+i
+)) != 0)
+
+763 i(
+
+ !
+lim
+) {
+
+764 i(
+i
+ =
+RTAX_NETMASK
+ + 1 && 
+
+ !
+NULL
+ &&
+
+765 
+
+ - 
+	`RT_XROUNDUP
+(
+
+->
+_n
++ sa->_=
+lim
+)
+
+776 
+	}
+}
+
+779 
+	$_gn
+(
+ty
+)
+
+781 #ide
+COMPAT_RTSOCK
+
+
+782 
+	`CTASSERT
+(
+	`__ignof
+(
+i_msghdr
+>(
+ut64_t
+));
+
+783 
+	`CTASSERT
+(
+	`__ignof
+(
+if_msghdr
+>(
+ut64_t
+));
+
+784 
+	`CTASSERT
+(
+	`__ignof
+(
+if_nounmsghdr
+>(
+ut64_t
+));
+
+785 
+	`CTASSERT
+(
+	`__ignof
+(
+_msghdr
+>(
+ut64_t
+));
+
+788 
+ty
+) {
+
+789 
+RTM_DELADDR
+:
+
+790 
+RTM_NEWADDR
+:
+
+791 
+RTM_CHGADDR
+:
+
+792  (
+i_xmsghdr
+);
+
+794 
+RTM_OOIFINFO
+:
+
+795 #ifde
+COMPAT_14
+
+
+796  (
+if_msghdr14
+);
+
+798 #ifde
+DIAGNOSTIC
+
+
+799 
+	`tf
+("RTM_OOIFINFO\n");
+
+803 
+RTM_OIFINFO
+:
+
+804 #ifde
+COMPAT_50
+
+
+805  (
+if_msghdr50
+);
+
+807 #ifde
+DIAGNOSTIC
+
+
+808 
+	`tf
+("RTM_OIFINFO\n");
+
+813 
+RTM_IFINFO
+:
+
+814  (
+if_xmsghdr
+);
+
+816 
+RTM_IFANNOUNCE
+:
+
+817 
+RTM_IEEE80211
+:
+
+818  (
+if_xnounmsghdr
+);
+
+821  (
+_xmsghdr
+);
+
+823 
+	}
+}
+
+826 
+mbuf
+ *
+
+827 
+	$COMPATNAME
+(
+_msg1
+)(
+ty
+, 
+_addrfo
+ *
+fo
+, *
+da
+, 
+d
+)
+
+829 
+_xmsghdr
+ *
+m
+;
+
+830 
+mbuf
+ *
+m
+;
+
+831 
+i
+;
+
+832 c 
+sockaddr
+ *
+
+;
+
+833 
+n
+, 
+dn
+;
+
+835 
+m
+ = 
+	`m_ghdr
+(
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+836 i(
+m
+ =
+NULL
+)
+
+837  
+m
+;
+
+838 
+	`MCLAIM
+(
+m
+, &
+	`COMPATNAME
+(
+roudoma
+).
+dom_mowr
+);
+
+840 i((
+n
+ = 
+	`_gn
+(
+ty
+)) == -1)
+
+841 
+out
+;
+
+842 i(
+n
+ > 
+MHLEN
+ + 
+MLEN
+)
+
+843 
+	`nic
+("%s: mesgtolg", 
+__func__
+);
+
+844 i(
+n
+ > 
+MHLEN
+) {
+
+845 
+m
+->
+m_xt
+ = 
+	`m_g
+(
+M_DONTWAIT
+, 
+MT_DATA
+);
+
+846 i(
+m
+->
+m_xt
+ =
+NULL
+)
+
+847 
+out
+;
+
+848 
+	`MCLAIM
+(
+m
+->
+m_xt
+, m->
+m_owr
+);
+
+849 
+m
+->
+m_pkthdr
+.
+n
+ =en;
+
+850 
+m
+->
+m_n
+ = 
+MHLEN
+;
+
+851 
+m
+->
+m_xt
+->
+m_n
+ = 
+n
+ - 
+MHLEN
+;
+
+853 
+m
+->
+m_pkthdr
+.
+n
+ = m->
+m_n
+ =en;
+
+855 
+m
+->
+m_pkthdr
+.
+rcvif
+ = 
+NULL
+;
+
+856 
+	`m_cyback
+(
+m
+, 0, 
+d
+, 
+da
+);
+
+857 i(
+n
+ > 
+d
+)
+
+858 ()
+	`memt
+(
+	`mtod
+(
+m
+, *+ 
+d
+, 0, 
+n
+ - datalen);
+
+859 
+m
+ = 
+	`mtod
+(
+m
+, 
+_xmsghdr
+ *);
+
+860 
+i
+ = 0; i < 
+RTAX_MAX
+; i++) {
+
+861 i((
+
+ = 
+fo
+->
+i_fo
+[
+i
+]=
+NULL
+)
+
+863 
+fo
+->
+i_addrs
+ |(1 << 
+i
+);
+
+864 
+dn
+ = 
+	`RT_XROUNDUP
+(
+
+->
+_n
+);
+
+865 
+	`m_cyback
+(
+m
+, 
+n
+, 
+
+->
+_n
+, sa);
+
+866 i(
+dn
+ !
+
+->
+_n
+) {
+
+871 
+	`m_cyback
+(
+m
+, 
+n
+ + 
+
+->
+_n
+,
+
+872 
+dn
+ - 
+
+->
+_n
+, "\0\0\0\0\0\0");
+
+874 
+n
+ +
+dn
+;
+
+876 i(
+m
+->
+m_pkthdr
+.
+n
+ !=en)
+
+877 
+out
+;
+
+878 
+m
+->
+m_msgn
+ = 
+n
+;
+
+879 
+m
+->
+m_vsi
+ = 
+RTM_XVERSION
+;
+
+880 
+m
+->
+m_ty
+ = 
+ty
+;
+
+881  
+m
+;
+
+882 
+out
+:
+
+883 
+	`m_m
+(
+m
+);
+
+884  
+NULL
+;
+
+885 
+	}
+}
+
+901 
+	$_msg2
+(
+ty
+, 
+_addrfo
+ *
+fo
+, *
+v
+, 
+_wkg
+ *
+w
+,
+
+902 *
+
+)
+
+904 
+i
+;
+
+905 
+n
+, 
+dn
+, 
+cd_time
+ = 0;
+
+906 *
+0
+, *
+
+ = 
+v
+;
+
+908 
+fo
+->
+i_addrs
+ = 0;
+
+909 
+aga
+:
+
+910 i((
+n
+ = 
+	`_gn
+(
+ty
+)) == -1)
+
+911  
+EINVAL
+;
+
+913 i((
+0
+ = 
+
+!
+NULL
+)
+
+914 
+
+ +
+n
+;
+
+915 
+i
+ = 0; i < 
+RTAX_MAX
+; i++) {
+
+916 c 
+sockaddr
+ *
+
+;
+
+918 i((
+
+ = 
+fo
+->
+i_fo
+[
+i
+]=
+NULL
+)
+
+920 
+fo
+->
+i_addrs
+ |(1 << 
+i
+);
+
+921 
+dn
+ = 
+	`RT_XROUNDUP
+(
+
+->
+_n
+);
+
+922 i(
+
+) {
+
+923 
+diff
+ = 
+dn
+ - 
+
+->
+_n
+;
+
+924 ()
+	`memy
+(
+
+, 
+
+, (
+size_t
+)->
+_n
+);
+
+925 
+
+ +
+
+->
+_n
+;
+
+926 i(
+diff
+ > 0) {
+
+927 ()
+	`memt
+(
+
+, 0, (
+size_t
+)
+diff
+);
+
+928 
+
+ +
+diff
+;
+
+931 
+n
+ +
+dn
+;
+
+933 i(
+
+ =
+NULL
+ && 
+w
+ !NULL && !
+cd_time
+) {
+
+934 
+_wkg
+ *
+rw
+ = 
+w
+;
+
+936 
+rw
+->
+w_eded
+ +
+n
+;
+
+937 i(
+rw
+->
+w_eded
+ <0 &&w->
+w_whe
+) {
+
+938 i(
+rw
+->
+w_tmemsize
+ < 
+n
+) {
+
+939 i(
+rw
+->
+w_tmem
+)
+
+940 
+	`
+(
+rw
+->
+w_tmem
+, 
+M_RTABLE
+);
+
+941 
+rw
+->
+w_tmem
+ = 
+	`mloc
+(
+n
+, 
+M_RTABLE
+, 
+M_NOWAIT
+);
+
+942 i(
+rw
+->
+w_tmem
+)
+
+943 
+rw
+->
+w_tmemsize
+ = 
+n
+;
+
+945 
+rw
+->
+w_tmemsize
+ = 0;
+
+947 i(
+rw
+->
+w_tmem
+) {
+
+948 
+
+ = 
+rw
+->
+w_tmem
+;
+
+949 
+cd_time
+ = 1;
+
+950 
+aga
+;
+
+952 
+rw
+->
+w_tmemeded
+ = 
+n
+;
+
+953  
+ENOBUFS
+;
+
+957 i(
+
+) {
+
+958 
+_xmsghdr
+ *
+m
+ = (_xmsghd*)
+0
+;
+
+960 
+m
+->
+m_vsi
+ = 
+RTM_XVERSION
+;
+
+961 
+m
+->
+m_ty
+ = 
+ty
+;
+
+962 
+m
+->
+m_msgn
+ = 
+n
+;
+
+964 i(
+
+)
+
+965 *
+
+ = 
+n
+;
+
+967 
+	}
+}
+
+976 
+	$COMPATNAME
+(
+_missmsg
+)(
+ty
+, c 
+_addrfo
+ *
+fo
+, 
+ags
+,
+
+977 
+r
+)
+
+979 
+_xmsghdr
+ 
+m
+;
+
+980 
+mbuf
+ *
+m
+;
+
+981 c 
+sockaddr
+ *
+
+ = 
+fo
+->
+i_fo
+[
+RTAX_DST
+];
+
+982 
+_addrfo
+ 
+fo
+ = *
+fo
+;
+
+984 
+	`COMPATCALL
+(
+_missmsg
+, (
+ty
+, 
+fo
+, 
+ags
+, 
+r
+));
+
+985 i(
+	`COMPATNAME
+(
+rou_fo
+).
+ri_cb
+.
+y_cou
+ == 0)
+
+987 
+	`memt
+(&
+m
+, 0, (rtm));
+
+988 
+m
+.
+m_ags
+ = 
+RTF_DONE
+ | 
+ags
+;
+
+989 
+m
+.
+m_o
+ = 
+r
+;
+
+990 
+m
+ = 
+	`COMPATNAME
+(
+_msg1
+)(
+ty
+, &
+fo
+, &
+m
+, (rtm));
+
+991 i(
+m
+ =
+NULL
+)
+
+993 
+	`mtod
+(
+m
+, 
+_xmsghdr
+ *)->
+m_addrs
+ = 
+fo
+.
+i_addrs
+;
+
+994 
+	`COMPATNAME
+(
+rou_queue
+)(
+m
+, 
+
+ ? sa->
+_my
+ : 0);
+
+995 
+	}
+}
+
+1002 
+	$COMPATNAME
+(
+_ifmsg
+)(
+i
+ *
+i
+)
+
+1004 
+if_xmsghdr
+ 
+ifm
+;
+
+1005 
+mbuf
+ *
+m
+;
+
+1006 
+_addrfo
+ 
+fo
+;
+
+1008 
+	`COMPATCALL
+(
+_ifmsg
+, (
+i
+));
+
+1009 i(
+	`COMPATNAME
+(
+rou_fo
+).
+ri_cb
+.
+y_cou
+ == 0)
+
+1011 ()
+	`memt
+(&
+fo
+, 0, (info));
+
+1012 ()
+	`memt
+(&
+ifm
+, 0, (ifm));
+
+1013 
+ifm
+.
+ifm_dex
+ = 
+i
+->
+if_dex
+;
+
+1014 
+ifm
+.
+ifm_ags
+ = 
+i
+->
+if_ags
+;
+
+1015 
+ifm
+.
+ifm_da
+ = 
+i
+->
+if_da
+;
+
+1016 
+ifm
+.
+ifm_addrs
+ = 0;
+
+1017 
+m
+ = 
+	`COMPATNAME
+(
+_msg1
+)(
+RTM_IFINFO
+, &
+fo
+, &
+ifm
+, (ifm));
+
+1018 i(
+m
+ =
+NULL
+)
+
+1020 
+	`COMPATNAME
+(
+rou_queue
+)(
+m
+, 0);
+
+1021 #ifde
+COMPAT_14
+
+
+1022 
+	`comt_14__oifmsg
+(
+i
+);
+
+1024 #ifde
+COMPAT_50
+
+
+1025 
+	`comt_50__oifmsg
+(
+i
+);
+
+1027 
+	}
+}
+
+1039 
+	$COMPATNAME
+(
+_waddrmsg
+)(
+cmd
+, 
+iddr
+ *
+i
+, 
+r
+,
+
+1040 
+y
+ *
+
+)
+
+1042 
+	#cmdss
+(
+__cmd
+, 
+__ss
+(((__cmd<< 2| (__ss))
+
+	)
+
+1043 
+_addrfo
+ 
+fo
+;
+
+1044 c 
+sockaddr
+ *
+
+;
+
+1045 
+ss
+;
+
+1046 
+mbuf
+ *
+m
+;
+
+1047 
+i
+ *
+i
+;
+
+1048 
+_xmsghdr
+ 
+m
+;
+
+1049 
+i_xmsghdr
+ 
+im
+;
+
+1050 
+ncmd
+;
+
+1052 
+	`KASSERT
+(
+i
+ !
+NULL
+);
+
+1053 
+i
+ = 
+i
+->
+i_i
+;
+
+1054 
+	`COMPATCALL
+(
+_waddrmsg
+, (
+cmd
+, 
+i
+, 
+r
+, 
+
+));
+
+1055 i(
+	`COMPATNAME
+(
+rou_fo
+).
+ri_cb
+.
+y_cou
+ == 0)
+
+1057 
+ss
+ = 1;ass < 3;ass++) {
+
+1058 
+	`memt
+(&
+fo
+, 0, (info));
+
+1059 
+	`cmdss
+(
+cmd
+, 
+ss
+)) {
+
+1060 
+	`cmdss
+(
+RTM_ADD
+, 1):
+
+1061 
+	`cmdss
+(
+RTM_CHANGE
+, 1):
+
+1062 
+	`cmdss
+(
+RTM_DELETE
+, 2):
+
+1063 
+	`cmdss
+(
+RTM_NEWADDR
+, 1):
+
+1064 
+	`cmdss
+(
+RTM_DELADDR
+, 1):
+
+1065 
+	`cmdss
+(
+RTM_CHGADDR
+, 1):
+
+1066 
+cmd
+) {
+
+1067 
+RTM_ADD
+:
+
+1068 
+ncmd
+ = 
+RTM_NEWADDR
+;
+
+1070 
+RTM_DELETE
+:
+
+1071 
+ncmd
+ = 
+RTM_DELADDR
+;
+
+1073 
+RTM_CHANGE
+:
+
+1074 
+ncmd
+ = 
+RTM_CHGADDR
+;
+
+1077 
+ncmd
+ = 
+cmd
+;
+
+1079 
+fo
+.
+i_fo
+[
+RTAX_IFA
+] = 
+
+ = 
+i
+->
+i_addr
+;
+
+1080 
+	`KASSERT
+(
+i
+->
+if_dl
+ !
+NULL
+);
+
+1081 
+fo
+.
+i_fo
+[
+RTAX_IFP
+] = 
+i
+->
+if_dl
+->
+i_addr
+;
+
+1082 
+fo
+.
+i_fo
+[
+RTAX_NETMASK
+] = 
+i
+->
+i_tmask
+;
+
+1083 
+fo
+.
+i_fo
+[
+RTAX_BRD
+] = 
+i
+->
+i_daddr
+;
+
+1084 
+	`memt
+(&
+im
+, 0, (ifam));
+
+1085 
+im
+.
+im_dex
+ = 
+i
+->
+if_dex
+;
+
+1086 
+im
+.
+im_mric
+ = 
+i
+->
+i_mric
+;
+
+1087 
+im
+.
+im_ags
+ = 
+i
+->
+i_ags
+;
+
+1088 
+m
+ = 
+	`COMPATNAME
+(
+_msg1
+)(
+ncmd
+, &
+fo
+, &
+im
+, (ifam));
+
+1089 i(
+m
+ =
+NULL
+)
+
+1091 
+	`mtod
+(
+m
+, 
+i_xmsghdr
+ *)->
+im_addrs
+ =
+
+1092 
+fo
+.
+i_addrs
+;
+
+1094 
+	`cmdss
+(
+RTM_ADD
+, 2):
+
+1095 
+	`cmdss
+(
+RTM_CHANGE
+, 2):
+
+1096 
+	`cmdss
+(
+RTM_DELETE
+, 1):
+
+1097 i(
+
+ =
+NULL
+)
+
+1099 
+fo
+.
+i_fo
+[
+RTAX_NETMASK
+] = 
+	`_mask
+(
+
+);
+
+1100 
+fo
+.
+i_fo
+[
+RTAX_DST
+] = 
+
+ = 
+	`_gkey
+(
+
+);
+
+1101 
+fo
+.
+i_fo
+[
+RTAX_GATEWAY
+] = 
+
+->
+_geway
+;
+
+1102 
+	`memt
+(&
+m
+, 0, (rtm));
+
+1103 
+m
+.
+m_dex
+ = 
+i
+->
+if_dex
+;
+
+1104 
+m
+.
+m_ags
+ |
+
+->
+_ags
+;
+
+1105 
+m
+.
+m_o
+ = 
+r
+;
+
+1106 
+m
+ = 
+	`COMPATNAME
+(
+_msg1
+)(
+cmd
+, &
+fo
+, &
+m
+, (rtm));
+
+1107 i(
+m
+ =
+NULL
+)
+
+1109 
+	`mtod
+(
+m
+, 
+_xmsghdr
+ *)->
+m_addrs
+ = 
+fo
+.
+i_addrs
+;
+
+1114 #ifde
+DIAGNOSTIC
+
+
+1115 i(
+m
+ =
+NULL
+)
+
+1116 
+	`nic
+("%s: cd wh wrg commd", 
+__func__
+);
+
+1118 
+	`COMPATNAME
+(
+rou_queue
+)(
+m
+, 
+
+ ? sa->
+_my
+ : 0);
+
+1120 #unde
+cmdss
+
+
+1121 
+	}
+}
+
+1123 
+mbuf
+ *
+
+1124 
+	$_makeiounmsg
+(
+i
+ *
+i
+, 
+ty
+, 
+wh
+,
+
+1125 
+_addrfo
+ *
+fo
+)
+
+1127 
+if_xnounmsghdr
+ 
+in
+;
+
+1129 
+	`memt
+(
+fo
+, 0, (*info));
+
+1130 
+	`memt
+(&
+in
+, 0, (ifan));
+
+1131 
+in
+.
+in_dex
+ = 
+i
+->
+if_dex
+;
+
+1132 
+	`y
+(
+in
+.
+in_me
+, 
+i
+->
+if_xme
+, (ifan.ifan_name));
+
+1133 
+in
+.
+in_wh
+ = 
+wh
+;
+
+1134  
+	`COMPATNAME
+(
+_msg1
+)(
+ty
+, 
+fo
+, &
+in
+, (ifan));
+
+1135 
+	}
+}
+
+1142 
+	$COMPATNAME
+(
+_iounmsg
+)(
+i
+ *
+i
+, 
+wh
+)
+
+1144 
+mbuf
+ *
+m
+;
+
+1145 
+_addrfo
+ 
+fo
+;
+
+1147 
+	`COMPATCALL
+(
+_iounmsg
+, (
+i
+, 
+wh
+));
+
+1148 i(
+	`COMPATNAME
+(
+rou_fo
+).
+ri_cb
+.
+y_cou
+ == 0)
+
+1150 
+m
+ = 
+	`_makeiounmsg
+(
+i
+, 
+RTM_IFANNOUNCE
+, 
+wh
+, &
+fo
+);
+
+1151 i(
+m
+ =
+NULL
+)
+
+1153 
+	`COMPATNAME
+(
+rou_queue
+)(
+m
+, 0);
+
+1154 
+	}
+}
+
+1162 
+	$COMPATNAME
+(
+_80211msg
+)(
+i
+ *
+i
+, 
+wh
+, *
+da
+,
+
+1163 
+size_t
+ 
+da_n
+)
+
+1165 
+mbuf
+ *
+m
+;
+
+1166 
+_addrfo
+ 
+fo
+;
+
+1168 
+	`COMPATCALL
+(
+_80211msg
+, (
+i
+, 
+wh
+, 
+da
+, 
+da_n
+));
+
+1169 i(
+	`COMPATNAME
+(
+rou_fo
+).
+ri_cb
+.
+y_cou
+ == 0)
+
+1171 
+m
+ = 
+	`_makeiounmsg
+(
+i
+, 
+RTM_IEEE80211
+, 
+wh
+, &
+fo
+);
+
+1172 i(
+m
+ =
+NULL
+)
+
+1181 i(
+da_n
+ > 
+	`M_TRAILINGSPACE
+(
+m
+)) {
+
+1182 
+mbuf
+ *
+n
+ = 
+	`m_g
+(
+M_NOWAIT
+, 
+MT_DATA
+);
+
+1183 i(
+n
+ =
+NULL
+) {
+
+1184 
+	`m_m
+(
+m
+);
+
+1187 ()
+	`memy
+(
+	`mtod
+(
+n
+, *), 
+da
+, 
+da_n
+);
+
+1188 
+n
+->
+m_n
+ = 
+da_n
+;
+
+1189 
+m
+->
+m_xt
+ = 
+n
+;
+
+1190 } i(
+da_n
+ > 0) {
+
+1191 ()
+	`memy
+(
+	`mtod
+(
+m
+, 
+ut8_t
+ *+ m->
+m_n
+, 
+da
+, 
+da_n
+);
+
+1192 
+m
+->
+m_n
+ +
+da_n
+;
+
+1194 i(
+m
+->
+m_ags
+ & 
+M_PKTHDR
+)
+
+1195 
+m
+->
+m_pkthdr
+.
+n
+ +
+da_n
+;
+
+1196 
+	`mtod
+(
+m
+, 
+if_xnounmsghdr
+ *)->
+in_msgn
+ +
+da_n
+;
+
+1197 
+	`COMPATNAME
+(
+rou_queue
+)(
+m
+, 0);
+
+1198 
+	}
+}
+
+1204 
+	$sysl_dumry
+(
+y
+ *
+
+, *
+v
+)
+
+1206 
+_wkg
+ *
+w
+ = 
+v
+;
+
+1207 
+r
+ = 0, 
+size
+;
+
+1208 
+_addrfo
+ 
+fo
+;
+
+1210 i(
+w
+->
+w_
+ =
+NET_RT_FLAGS
+ && !(
+
+->
+_ags
+ & w->
+w_g
+))
+
+1212 
+	`memt
+(&
+fo
+, 0, (info));
+
+1213 
+fo
+.
+i_fo
+[
+RTAX_DST
+] = 
+	`_gkey
+(
+
+);
+
+1214 
+fo
+.
+i_fo
+[
+RTAX_GATEWAY
+] = 
+
+->
+_geway
+;
+
+1215 
+fo
+.
+i_fo
+[
+RTAX_NETMASK
+] = 
+	`_mask
+(
+
+);
+
+1216 
+fo
+.
+i_fo
+[
+RTAX_TAG
+] = 
+	`_gg
+(
+
+);
+
+1217 i(
+
+->
+_i
+) {
+
+1218 c 
+iddr
+ *
+i
+;
+
+1219 
+fo
+.
+i_fo
+[
+RTAX_IFP
+] = 
+
+->
+_i
+->
+if_dl
+->
+i_addr
+;
+
+1224 
+i
+ = 
+	`_g_i
+(
+
+);
+
+1225 
+fo
+.
+i_fo
+[
+RTAX_IFA
+] = 
+i
+->
+i_addr
+;
+
+1226 i(
+
+->
+_i
+->
+if_ags
+ & 
+IFF_POINTOPOINT
+)
+
+1227 
+fo
+.
+i_fo
+[
+RTAX_BRD
+] = 
+i
+->
+i_daddr
+;
+
+1229 i((
+r
+ = 
+	`_msg2
+(
+RTM_GET
+, &
+fo
+, 0, 
+w
+, &
+size
+)))
+
+1230  
+r
+;
+
+1231 i(
+w
+->
+w_whe
+ && w->
+w_tmem
+ && w->
+w_eded
+ <= 0) {
+
+1232 
+_xmsghdr
+ *
+m
+ = (_xmsghd*)
+w
+->
+w_tmem
+;
+
+1234 
+m
+->
+m_ags
+ = 
+
+->
+_ags
+;
+
+1235 
+m
+->
+m_u
+ = 
+
+->
+_u
+;
+
+1236 
+	`m_tmrics
+(
+
+, 
+m
+);
+
+1237 
+	`KASSERT
+(
+
+->
+_i
+ !
+NULL
+);
+
+1238 
+m
+->
+m_dex
+ = 
+
+->
+_i
+->
+if_dex
+;
+
+1239 
+m
+->
+m_o
+ =tm->
+m_pid
+ =tm->
+m_q
+ = 0;
+
+1240 
+m
+->
+m_addrs
+ = 
+fo
+.
+i_addrs
+;
+
+1241 i((
+r
+ = 
+	`cyout
+(
+m
+, 
+w
+->
+w_whe
+, 
+size
+)) != 0)
+
+1242 
+w
+->
+w_whe
+ = 
+NULL
+;
+
+1244 
+w
+->
+w_whe
+ = (*)w->w_wh+ 
+size
+;
+
+1246  
+r
+;
+
+1247 
+	}
+}
+
+1250 
+	$sysl_ii
+(
+af
+, 
+_wkg
+ *
+w
+, 
+ty
+)
+
+1252 
+i
+ *
+i
+;
+
+1253 
+iddr
+ *
+i
+;
+
+1254 
+_addrfo
+ 
+fo
+;
+
+1255 
+n
+, 
+r
+ = 0;
+
+1257 
+	`memt
+(&
+fo
+, 0, (info));
+
+1258 
+	`IFNET_FOREACH
+(
+i
+) {
+
+1259 i(
+w
+->
+w_g
+ && w->w_g !
+i
+->
+if_dex
+)
+
+1261 i(
+	`IFADDR_EMPTY
+(
+i
+))
+
+1263 
+fo
+.
+i_fo
+[
+RTAX_IFP
+] = 
+i
+->
+if_dl
+->
+i_addr
+;
+
+1264 
+ty
+) {
+
+1265 
+NET_RT_IFLIST
+:
+
+1266 
+r
+ = 
+	`_msg2
+(
+RTM_IFINFO
+, &
+fo
+, 
+NULL
+, 
+w
+, &
+n
+);
+
+1268 #ifde
+COMPAT_14
+
+
+1269 
+NET_RT_OOIFLIST
+:
+
+1270 
+r
+ = 
+	`_msg2
+(
+RTM_OOIFINFO
+, &
+fo
+, 
+NULL
+, 
+w
+, &
+n
+);
+
+1273 #ifde
+COMPAT_50
+
+
+1274 
+NET_RT_OIFLIST
+:
+
+1275 
+r
+ = 
+	`_msg2
+(
+RTM_OIFINFO
+, &
+fo
+, 
+NULL
+, 
+w
+, &
+n
+);
+
+1279 
+	`nic
+("sysctl_iflist(1)");
+
+1281 i(
+r
+)
+
+1282  
+r
+;
+
+1283 
+fo
+.
+i_fo
+[
+RTAX_IFP
+] = 
+NULL
+;
+
+1284 i(
+w
+->
+w_whe
+ && w->
+w_tmem
+ && w->
+w_eded
+ <= 0) {
+
+1285 
+ty
+) {
+
+1286 
+NET_RT_IFLIST
+: {
+
+1287 
+if_xmsghdr
+ *
+ifm
+;
+
+1289 
+ifm
+ = (
+if_xmsghdr
+ *)
+w
+->
+w_tmem
+;
+
+1290 
+ifm
+->
+ifm_dex
+ = 
+i
+->
+if_dex
+;
+
+1291 
+ifm
+->
+ifm_ags
+ = 
+i
+->
+if_ags
+;
+
+1292 
+ifm
+->
+ifm_da
+ = 
+i
+->
+if_da
+;
+
+1293 
+ifm
+->
+ifm_addrs
+ = 
+fo
+.
+i_addrs
+;
+
+1294 
+r
+ = 
+	`cyout
+(
+ifm
+, 
+w
+->
+w_whe
+, 
+n
+);
+
+1295 i(
+r
+)
+
+1296  
+r
+;
+
+1297 
+w
+->
+w_whe
+ = (*)w->w_wh+ 
+n
+;
+
+1301 #ifde
+COMPAT_14
+
+
+1302 
+NET_RT_OOIFLIST
+:
+
+1303 
+r
+ = 
+	`comt_14_ii
+(
+i
+, 
+w
+, &
+fo
+, 
+n
+);
+
+1304 i(
+r
+)
+
+1305  
+r
+;
+
+1308 #ifde
+COMPAT_50
+
+
+1309 
+NET_RT_OIFLIST
+:
+
+1310 
+r
+ = 
+	`comt_50_ii
+(
+i
+, 
+w
+, &
+fo
+, 
+n
+);
+
+1311 i(
+r
+)
+
+1312  
+r
+;
+
+1316 
+	`nic
+("sysctl_iflist(2)");
+
+1319 
+	`IFADDR_FOREACH
+(
+i
+, 
+i
+) {
+
+1320 i(
+af
+ &&!
+i
+->
+i_addr
+->
+_my
+)
+
+1322 
+fo
+.
+i_fo
+[
+RTAX_IFA
+] = 
+i
+->
+i_addr
+;
+
+1323 
+fo
+.
+i_fo
+[
+RTAX_NETMASK
+] = 
+i
+->
+i_tmask
+;
+
+1324 
+fo
+.
+i_fo
+[
+RTAX_BRD
+] = 
+i
+->
+i_daddr
+;
+
+1325 i((
+r
+ = 
+	`_msg2
+(
+RTM_NEWADDR
+, &
+fo
+, 0, 
+w
+, &
+n
+)))
+
+1326  
+r
+;
+
+1327 i(
+w
+->
+w_whe
+ && w->
+w_tmem
+ && w->
+w_eded
+ <= 0) {
+
+1328 
+i_xmsghdr
+ *
+im
+;
+
+1330 
+im
+ = (
+i_xmsghdr
+ *)
+w
+->
+w_tmem
+;
+
+1331 
+im
+->
+im_dex
+ = 
+i
+->
+i_i
+->
+if_dex
+;
+
+1332 
+im
+->
+im_ags
+ = 
+i
+->
+i_ags
+;
+
+1333 
+im
+->
+im_mric
+ = 
+i
+->
+i_mric
+;
+
+1334 
+im
+->
+im_addrs
+ = 
+fo
+.
+i_addrs
+;
+
+1335 
+r
+ = 
+	`cyout
+(
+w
+->
+w_tmem
+, w->
+w_whe
+, 
+n
+);
+
+1336 i(
+r
+)
+
+1337  
+r
+;
+
+1338 
+w
+->
+w_whe
+ = (*)w->w_wh+ 
+n
+;
+
+1341 
+fo
+.
+i_fo
+[
+RTAX_IFA
+] = info.i_fo[
+RTAX_NETMASK
+] =
+
+1342 
+fo
+.
+i_fo
+[
+RTAX_BRD
+] = 
+NULL
+;
+
+1345 
+	}
+}
+
+1348 
+	$sysl_ab
+(
+SYSCTLFN_ARGS
+)
+
+1350 *
+whe
+ = 
+dp
+;
+
+1351 
+size_t
+ *
+giv
+ = 
+d
+;
+
+1352 
+i
+, 
+s
+, 
+r
+ = 
+EINVAL
+;
+
+1353 
+u_ch
+ 
+af
+;
+
+1354 
+_wkg
+ 
+w
+;
+
+1356 i(
+m
+ =1 && 
+me
+[0] =
+CTL_QUERY
+)
+
+1357  
+	`sysl_quy
+(
+	`SYSCTLFN_CALL
+(
+ode
+));
+
+1359 i(
+wp
+)
+
+1360  
+EPERM
+;
+
+1361 i(
+m
+ != 3)
+
+1362  
+EINVAL
+;
+
+1363 
+af
+ = 
+me
+[0];
+
+1364 
+w
+.
+w_tmemeded
+ = 0;
+
+1365 
+w
+.
+w_tmemsize
+ = 0;
+
+1366 
+w
+.
+w_tmem
+ = 
+NULL
+;
+
+1367 
+aga
+:
+
+1369 i(
+w
+.
+w_tmemeded
+) {
+
+1370 
+w
+.
+w_tmem
+ = 
+	`mloc
+(w.
+w_tmemeded
+, 
+M_RTABLE
+, 
+M_WAITOK
+);
+
+1371 
+w
+.
+w_tmemsize
+ = w.
+w_tmemeded
+;
+
+1372 
+w
+.
+w_tmemeded
+ = 0;
+
+1374 
+w
+.
+w_
+ = 
+me
+[1];
+
+1375 
+w
+.
+w_g
+ = 
+me
+[2];
+
+1376 
+w
+.
+w_giv
+ = *
+giv
+;
+
+1377 
+w
+.
+w_eded
+ = 0 - w.
+w_giv
+;
+
+1378 
+w
+.
+w_whe
+ = 
+whe
+;
+
+1380 
+s
+ = 
+	`lsot
+();
+
+1381 
+w
+.
+w_
+) {
+
+1383 
+NET_RT_DUMP
+:
+
+1384 
+NET_RT_FLAGS
+:
+
+1385 
+i
+ = 1; i <
+AF_MAX
+; i++)
+
+1386 i((
+af
+ =0 ||=
+i
+) &&
+
+1387 (
+r
+ = 
+	`_wk
+(
+i
+, 
+sysl_dumry
+, &
+w
+)))
+
+1391 #ifde
+COMPAT_14
+
+
+1392 
+NET_RT_OOIFLIST
+:
+
+1393 
+r
+ = 
+	`sysl_ii
+(
+af
+, &
+w
+, w.
+w_
+);
+
+1396 #ifde
+COMPAT_50
+
+
+1397 
+NET_RT_OIFLIST
+:
+
+1398 
+r
+ = 
+	`sysl_ii
+(
+af
+, &
+w
+, w.
+w_
+);
+
+1401 
+NET_RT_IFLIST
+:
+
+1402 
+r
+ = 
+	`sysl_ii
+(
+af
+, &
+w
+, w.
+w_
+);
+
+1405 
+	`lx
+(
+s
+);
+
+1408 i(
+r
+ =
+ENOBUFS
+ && 
+w
+.
+w_tmem
+ =0 && w.
+w_tmemeded
+)
+
+1409 
+aga
+;
+
+1411 i(
+w
+.
+w_tmem
+)
+
+1412 
+	`
+(
+w
+.
+w_tmem
+, 
+M_RTABLE
+);
+
+1413 
+w
+.
+w_eded
+ +w.
+w_giv
+;
+
+1414 i(
+whe
+) {
+
+1415 *
+giv
+ = (*)
+w
+.
+w_whe
+ - (*)
+whe
+;
+
+1416 i(*
+giv
+ < 
+w
+.
+w_eded
+)
+
+1417  
+ENOMEM
+;
+
+1419 *
+giv
+ = (11 * 
+w
+.
+w_eded
+) / 10;
+
+1421  
+r
+;
+
+1422 
+	}
+}
+
+1428 
+	$COMPATNAME
+(
+rou_
+)(*
+cook
+)
+
+1430 
+socko
+ 
+o
+ = { .
+_my
+ = 
+PF_XROUTE
+, };
+
+1431 
+rou_fo
+ * c 
+ri
+ = &
+	`COMPATNAME
+(route_info);
+
+1432 
+mbuf
+ *
+m
+;
+
+1433 
+s
+;
+
+1435 
+	`mux_r
+(
+sot_lock
+);
+
+1436 
+	`KERNEL_LOCK
+(1, 
+NULL
+);
+
+1437 !
+	`IF_IS_EMPTY
+(&
+ri
+->
+ri_q
+)) {
+
+1438 
+s
+ = 
+	`
+();
+
+1439 
+	`IF_DEQUEUE
+(&
+ri
+->
+ri_q
+, 
+m
+);
+
+1440 
+	`lx
+(
+s
+);
+
+1441 i(
+m
+ =
+NULL
+)
+
+1443 
+o
+.
+_oc
+ = 
+	`M_GETCTX
+(
+m
+, 
+u_t
+);
+
+1444 
+	`w_put
+(
+m
+, &
+o
+, &
+ri
+->
+ri_c
+, &ri->
+ri_d
+);
+
+1446 
+	`KERNEL_UNLOCK_ONE
+(
+NULL
+);
+
+1447 
+	`mux_ex
+(
+sot_lock
+);
+
+1448 
+	}
+}
+
+1454 
+	$COMPATNAME
+(
+rou_queue
+)(
+mbuf
+ *
+m
+, 
+my
+)
+
+1456 
+rou_fo
+ * c 
+ri
+ = &
+	`COMPATNAME
+(route_info);
+
+1457 
+s
+, 
+wamy
+;
+
+1459 
+s
+ = 
+	`
+();
+
+1460 i(
+	`IF_QFULL
+(&
+ri
+->
+ri_q
+)) {
+
+1461 
+	`IF_DROP
+(&
+ri
+->
+ri_q
+);
+
+1462 
+	`m_m
+(
+m
+);
+
+1464 
+wamy
+ = 
+	`IF_IS_EMPTY
+(&
+ri
+->
+ri_q
+);
+
+1465 
+	`M_SETCTX
+(
+m
+, (
+u_t
+)
+my
+);
+
+1466 
+	`IF_ENQUEUE
+(&
+ri
+->
+ri_q
+, 
+m
+);
+
+1467 i(
+wamy
+)
+
+1468 
+	`sot_schedu
+(
+ri
+->
+ri_sih
+);
+
+1470 
+	`lx
+(
+s
+);
+
+1471 
+	}
+}
+
+1474 
+	$COMPATNAME
+(
+rou_
+)()
+
+1476 
+rou_fo
+ * c 
+ri
+ = &
+	`COMPATNAME
+(route_info);
+
+1478 #ide
+COMPAT_RTSOCK
+
+
+1479 
+	`_
+();
+
+1482 
+	`sysl_t_rou_tup
+(
+NULL
+);
+
+1483 
+ri
+->
+ri_q
+.
+ifq_maxn
+ =i->
+ri_maxqn
+;
+
+1484 
+ri
+->
+ri_sih
+ = 
+	`sot_eablish
+(
+SOFTINT_NET
+ | 
+SOFTINT_MPSAFE
+,
+
+1485 
+	`COMPATNAME
+(
+rou_
+), 
+NULL
+);
+
+1486 
+	}
+}
+
+1491 #ide
+COMPAT_RTSOCK
+
+
+1492 
+PR_WRAP_USRREQS
+(
+rou
+);
+
+1494 
+PR_WRAP_USRREQS
+(
+comt_50_rou
+);
+
+1497 c 
+_uqs
+ 
+	grou_uqs
+ = {
+
+1498 .
+_ch
+ = 
+COMPATNAME
+(
+rou_ch_w
+),
+
+1499 .
+	g_dach
+ = 
+COMPATNAME
+(
+rou_dach_w
+),
+
+1500 .
+	g_ac
+ = 
+COMPATNAME
+(
+rou_ac_w
+),
+
+1501 .
+	g_bd
+ = 
+COMPATNAME
+(
+rou_bd_w
+),
+
+1502 .
+	g_li
+ = 
+COMPATNAME
+(
+rou_li_w
+),
+
+1503 .
+	g_c
+ = 
+COMPATNAME
+(
+rou_c_w
+),
+
+1504 .
+	g_c2
+ = 
+COMPATNAME
+(
+rou_c2_w
+),
+
+1505 .
+	g_disc
+ = 
+COMPATNAME
+(
+rou_disc_w
+),
+
+1506 .
+	g_shutdown
+ = 
+COMPATNAME
+(
+rou_shutdown_w
+),
+
+1507 .
+	g_abt
+ = 
+COMPATNAME
+(
+rou_abt_w
+),
+
+1508 .
+	g_iol
+ = 
+COMPATNAME
+(
+rou_iol_w
+),
+
+1509 .
+	g_
+ = 
+COMPATNAME
+(
+rou__w
+),
+
+1510 .
+	g_addr
+ = 
+COMPATNAME
+(
+rou_addr_w
+),
+
+1511 .
+	g_sockaddr
+ = 
+COMPATNAME
+(
+rou_sockaddr_w
+),
+
+1512 .
+	g_rcvd
+ = 
+COMPATNAME
+(
+rou_rcvd_w
+),
+
+1513 .
+	g_cvoob
+ = 
+COMPATNAME
+(
+rou_cvoob_w
+),
+
+1514 .
+	g_nd
+ = 
+COMPATNAME
+(
+rou_nd_w
+),
+
+1515 .
+	g_ndoob
+ = 
+COMPATNAME
+(
+rou_ndoob_w
+),
+
+1516 .
+	g_purgeif
+ = 
+COMPATNAME
+(
+rou_purgeif_w
+),
+
+1519 c 
+osw
+ 
+COMPATNAME
+(
+rou_osw
+)[] = {
+
+1521 .
+_ty
+ = 
+SOCK_RAW
+,
+
+1522 .
+	g_doma
+ = &
+COMPATNAME
+(
+roudoma
+),
+
+1523 .
+	g_ags
+ = 
+PR_ATOMIC
+|
+PR_ADDR
+,
+
+1524 .
+	g_put
+ = 
+w_put
+,
+
+1525 .
+	g_ouut
+ = 
+COMPATNAME
+(
+rou_ouut
+),
+
+1526 .
+	g_lput
+ = 
+w_lput
+,
+
+1527 .
+	g_uqs
+ = &
+rou_uqs
+,
+
+1528 .
+	g_
+ = 
+w_
+,
+
+1532 
+doma
+ 
+COMPATNAME
+(
+roudoma
+) = {
+
+1533 .
+dom_my
+ = 
+PF_XROUTE
+,
+
+1534 .
+	gdom_me
+ = 
+DOMAINNAME
+,
+
+1535 .
+	gdom_
+ = 
+COMPATNAME
+(
+rou_
+),
+
+1536 .
+	gdom_osw
+ = 
+COMPATNAME
+(
+rou_osw
+),
+
+1537 .
+	gdom_oswNPROTOSW
+ =
+
+1538 &
+COMPATNAME
+(
+rou_osw
+)[
+__ycou
+(COMPATNAME(route_protosw))],
+
+1542 
+	$sysl_t_rou_tup
+(
+sysog
+ **
+og
+)
+
+1544 c 
+sysode
+ *
+ode
+ = 
+NULL
+;
+
+1546 
+	`sysl_v
+(
+og
+, 0, 
+NULL
+, &
+ode
+,
+
+1547 
+CTLFLAG_PERMANENT
+,
+
+1548 
+CTLTYPE_NODE
+, 
+DOMAINNAME
+,
+
+1549 
+	`SYSCTL_DESCR
+("PF_ROUTE information"),
+
+1550 
+NULL
+, 0, NULL, 0,
+
+1551 
+CTL_NET
+, 
+PF_XROUTE
+, 
+CTL_EOL
+);
+
+1553 
+	`sysl_v
+(
+og
+, 0, 
+NULL
+, NULL,
+
+1554 
+CTLFLAG_PERMANENT
+,
+
+1555 
+CTLTYPE_NODE
+, "rtable",
+
+1556 
+	`SYSCTL_DESCR
+("Routingable information"),
+
+1557 
+sysl_ab
+, 0, 
+NULL
+, 0,
+
+1558 
+CTL_NET
+, 
+PF_XROUTE
+, 0 , 
+CTL_EOL
+);
+
+1560 
+	`sysl_v
+(
+og
+, 0, &
+ode
+, 
+NULL
+,
+
+1561 
+CTLFLAG_PERMANENT
+,
+
+1562 
+CTLTYPE_STRUCT
+, "stats",
+
+1563 
+	`SYSCTL_DESCR
+("Routing statistics"),
+
+1564 
+NULL
+, 0, &
+
+, (rtstat),
+
+1565 
+CTL_CREATE
+, 
+CTL_EOL
+);
+
+1566 
+	}
+}
+
+	@slcompress.c
+
+43 
+	~<sys/cdefs.h
+>
+
+44 
+__KERNEL_RCSID
+(0, "$NetBSD: slcompress.c,v 1.38 2009/04/18 15:20:06sutsui Exp $");
+
+46 
+	~"t_.h
+"
+
+47 #ifde
+INET
+
+
+48 
+	~<sys/m.h
+>
+
+49 
+	~<sys/mbuf.h
+>
+
+50 
+	~<sys/sym.h
+>
+
+52 
+	~<t/.h
+>
+
+53 
+	~<t/_sym.h
+>
+
+54 
+	~<t/.h
+>
+
+55 
+	~<t/t.h
+>
+
+57 
+	~<t/comess.h
+>
+
+59 #ide
+SL_NO_STATS
+
+
+60 
+	#INCR
+(
+cou
+++
+comp
+->cou;
+
+	)
+
+62 
+	#INCR
+(
+cou
+)
+
+	)
+
+67 
+	$_comess_
+(
+comess
+ *
+comp
+)
+
+69 
+u_t
+ 
+i
+;
+
+70 
+ce
+ *
+te
+ = 
+comp
+->tstate;
+
+72 
+	`memt
+(
+comp
+, 0, (*comp));
+
+73 
+i
+ = 
+MAX_STATES
+ - 1; i > 0; --i) {
+
+74 
+te
+[
+i
+].
+cs_id
+ = i;
+
+75 
+te
+[
+i
+].
+cs_xt
+ = &tstate[i - 1];
+
+77 
+te
+[0].
+cs_xt
+ = &te[
+MAX_STATES
+ - 1];
+
+78 
+te
+[0].
+cs_id
+ = 0;
+
+79 
+comp
+->
+_cs
+ = &
+te
+[0];
+
+80 
+comp
+->
+_cv
+ = 255;
+
+81 
+comp
+->
+_xm
+ = 255;
+
+82 
+comp
+->
+ags
+ = 
+SLF_TOSS
+;
+
+83 
+	}
+}
+
+91 
+	$_comess_tup
+(
+comess
+ *
+comp
+, 
+max_e
+)
+
+93 
+u_t
+ 
+i
+;
+
+94 
+ce
+ *
+te
+ = 
+comp
+->tstate;
+
+96 i(
+max_e
+ == -1) {
+
+97 
+max_e
+ = 
+MAX_STATES
+ - 1;
+
+98 
+	`memt
+(
+comp
+, 0, (*comp));
+
+101 
+	`memt
+(
+comp
+->
+te
+, 0, (comp->tstate));
+
+102 
+	`memt
+(
+comp
+->
+re
+, 0, (comp->rstate));
+
+104 
+i
+ = 
+max_e
+; i > 0; --i) {
+
+105 
+te
+[
+i
+].
+cs_id
+ = i;
+
+106 
+te
+[
+i
+].
+cs_xt
+ = &tstate[i - 1];
+
+108 
+te
+[0].
+cs_xt
+ = &te[
+max_e
+];
+
+109 
+te
+[0].
+cs_id
+ = 0;
+
+110 
+comp
+->
+_cs
+ = &
+te
+[0];
+
+111 
+comp
+->
+_cv
+ = 255;
+
+112 
+comp
+->
+_xm
+ = 255;
+
+113 
+comp
+->
+ags
+ = 
+SLF_TOSS
+;
+
+114 
+	}
+}
+
+121 
+	#ENCODE
+(
+n
+) { \
+
+122 i((
+ut16_t
+)(
+n
+) >= 256) { \
+
+123 *
+
+++ = 0; \
+
+124 
+
+[1] = (
+n
+); \
+
+125 
+
+[0] = (
+n
+) >> 8; \
+
+126 
+
+ += 2; \
+
+128 *
+
+++ = (
+n
+); \
+
+130 }
+
+	)
+
+131 
+	#ENCODEZ
+(
+n
+) { \
+
+132 i((
+ut16_t
+)(
+n
+) >= 256 || (uint16_t)(n) == 0) { \
+
+133 *
+
+++ = 0; \
+
+134 
+
+[1] = (
+n
+); \
+
+135 
+
+[0] = (
+n
+) >> 8; \
+
+136 
+
+ += 2; \
+
+138 *
+
+++ = (
+n
+); \
+
+140 }
+
+	)
+
+142 
+	#DECODEL
+(
+f
+) { \
+
+143 i(*
+
+ == 0) {\
+
+144 (
+f
+
+	`htl
+(
+	`ohl
+(f+ ((
+
+[1] << 8) | cp[2])); \
+
+145 
+
+ += 3; \
+
+147 (
+f
+
+	`htl
+(
+	`ohl
+(f+ (
+ut32_t
+)*
+
+++); \
+
+149 }
+
+	)
+
+151 
+	#DECODES
+(
+f
+) { \
+
+152 i(*
+
+ == 0) {\
+
+153 (
+f
+
+	`hts
+(
+	`ohs
+(f+ ((
+
+[1] << 8) | cp[2])); \
+
+154 
+
+ += 3; \
+
+156 (
+f
+
+	`hts
+(
+	`ohs
+(f+ (
+ut32_t
+)*
+
+++); \
+
+158 }
+
+	)
+
+160 
+	#DECODEU
+(
+f
+) { \
+
+161 i(*
+
+ == 0) {\
+
+162 (
+f
+
+	`hts
+((
+
+[1] << 8) | cp[2]); \
+
+163 
+
+ += 3; \
+
+165 (
+f
+
+	`hts
+((
+ut32_t
+)*
+
+++); \
+
+167 }
+
+	)
+
+169 
+u_t
+
+
+170 
+	$_comess_t
+(
+mbuf
+ *
+m
+, 
+
+ *, 
+comess
+ *
+comp
+,
+
+171 
+comess_cid
+)
+
+173 
+ce
+ *
+cs
+ = 
+comp
+->
+_cs
+->
+cs_xt
+;
+
+174 
+u_t
+ 
+hn
+ = 
+
+->
+_hl
+;
+
+175 
+thdr
+ *
+h
+;
+
+176 
+thdr
+ *
+th
+;
+
+177 
+u_t
+ 
+dS
+, 
+dA
+;
+
+178 
+u_t
+ 
+chges
+ = 0;
+
+179 
+u_ch
+ 
+w_q
+[16];
+
+180 
+u_ch
+ *
+
+ = 
+w_q
+;
+
+188 i((
+
+->
+_off
+ & 
+	`hts
+(0x3fff)|| 
+m
+->
+m_n
+ < 40)
+
+189  (
+TYPE_IP
+);
+
+191 
+th
+ = (
+thdr
+ *)&((
+t32_t
+ *)
+
+)[
+hn
+];
+
+192 i((
+th
+->
+th_ags
+ & (
+TH_SYN
+|
+TH_FIN
+|
+TH_RST
+|
+TH_ACK
+)) != TH_ACK)
+
+193  (
+TYPE_IP
+);
+
+201 
+	`INCR
+(
+s_cks
+)
+
+202 i(
+
+->
+_c
+.
+s_addr
+ !
+cs
+->
+cs_
+.ip_src.s_addr ||
+
+203 
+
+->
+_d
+.
+s_addr
+ !
+cs
+->
+cs_
+.ip_dst.s_addr ||
+
+204 *(
+t32_t
+ *)
+th
+ !((t32_*)&
+cs
+->
+cs_
+)[cs->cs_.
+_hl
+]) {
+
+217 
+ce
+ *
+lcs
+;
+
+218 
+ce
+ *
+cs
+ = 
+comp
+->
+_cs
+;
+
+221 
+lcs
+ = 
+cs
+; ccs->
+cs_xt
+;
+
+222 
+	`INCR
+(
+s_ches
+)
+
+223 i(
+
+->
+_c
+.
+s_addr
+ =
+cs
+->
+cs_
+.ip_src.s_addr
+
+224 && 
+
+->
+_d
+.
+s_addr
+ =
+cs
+->
+cs_
+.ip_dst.s_addr
+
+225 && *(
+t32_t
+ *)
+th
+ ==
+
+226 ((
+t32_t
+ *)&
+cs
+->
+cs_
+)[cs->cs_.
+_hl
+])
+
+227 
+found
+;
+
+228 } 
+cs
+ !
+cs
+);
+
+238 
+	`INCR
+(
+s_miss
+)
+
+239 
+comp
+->
+_cs
+ = 
+lcs
+;
+
+240 
+hn
+ +
+th
+->
+th_off
+;
+
+241 
+hn
+ <<= 2;
+
+242 i(
+hn
+ > 
+m
+->
+m_n
+)
+
+243  (
+TYPE_IP
+);
+
+244 
+uncomesd
+;
+
+246 
+found
+:
+
+250 i(
+cs
+ =
+cs
+)
+
+251 
+comp
+->
+_cs
+ = 
+lcs
+;
+
+253 
+lcs
+->
+cs_xt
+ = 
+cs
+->cs_next;
+
+254 
+cs
+->
+cs_xt
+ = 
+cs
+->cs_next;
+
+255 
+cs
+->
+cs_xt
+ = 
+cs
+;
+
+270 
+h
+ = (
+thdr
+ *)&((
+t32_t
+ *)&
+cs
+->
+cs_
+)[
+hn
+];
+
+271 
+dS
+ = 
+hn
+;
+
+272 
+hn
+ +
+th
+->
+th_off
+;
+
+273 
+hn
+ <<= 2;
+
+274 i(
+hn
+ > 
+m
+->
+m_n
+)
+
+275  (
+TYPE_IP
+);
+
+277 i(((
+ut16_t
+ *)
+
+)[0] !((ut16_*)&
+cs
+->
+cs_
+)[0] ||
+
+278 ((
+ut16_t
+ *)
+
+)[3] !((ut16_*)&
+cs
+->
+cs_
+)[3] ||
+
+279 ((
+ut16_t
+ *)
+
+)[4] !((ut16_*)&
+cs
+->
+cs_
+)[4] ||
+
+280 
+th
+->
+th_off
+ !
+h
+->th_off ||
+
+281 (
+dS
+ > 5 &&
+
+282 
+	`memcmp
+(
+
+ + 1, &
+cs
+->
+cs_
+ + 1, (
+dS
+ - 5) << 2)) ||
+
+283 (
+th
+->
+th_off
+ > 5 &&
+
+284 
+	`memcmp
+(
+th
+ + 1, 
+h
+ + 1, (th->
+th_off
+ - 5) << 2)))
+
+285 
+uncomesd
+;
+
+293 i(
+th
+->
+th_ags
+ & 
+TH_URG
+) {
+
+294 
+dS
+ = 
+	`ohs
+(
+th
+->
+th_u
+);
+
+295 
+	`ENCODEZ
+(
+dS
+);
+
+296 
+chges
+ |
+NEW_U
+;
+
+297 } i(
+th
+->
+th_u
+ !
+h
+->th_urp)
+
+302 
+uncomesd
+;
+
+304 
+dS
+ = (
+ut16_t
+)(
+	`ohs
+(
+th
+->
+th_w
+-tohs(
+h
+->th_win));
+
+305 i(
+dS
+) {
+
+306 
+	`ENCODE
+(
+dS
+);
+
+307 
+chges
+ |
+NEW_W
+;
+
+310 
+dA
+ = 
+	`ohl
+(
+th
+->
+th_ack
+-tohl(
+h
+->th_ack);
+
+311 i(
+dA
+) {
+
+312 i(
+dA
+ > 0xffff)
+
+313 
+uncomesd
+;
+
+314 
+	`ENCODE
+(
+dA
+);
+
+315 
+chges
+ |
+NEW_A
+;
+
+318 
+dS
+ = 
+	`ohl
+(
+th
+->
+th_q
+-tohl(
+h
+->th_seq);
+
+319 i(
+dS
+) {
+
+320 i(
+dS
+ > 0xffff)
+
+321 
+uncomesd
+;
+
+322 
+	`ENCODE
+(
+dS
+);
+
+323 
+chges
+ |
+NEW_S
+;
+
+326 
+chges
+) {
+
+337 i(
+
+->
+_n
+ !
+cs
+->
+cs_
+.ip_len &&
+
+338 
+	`ohs
+(
+cs
+->
+cs_
+.
+_n
+=
+hn
+)
+
+343 
+SPECIAL_I
+:
+
+344 
+SPECIAL_D
+:
+
+349 
+uncomesd
+;
+
+351 
+NEW_S
+|
+NEW_A
+:
+
+352 i(
+dS
+ =
+dA
+ &&
+
+353 
+dS
+ =
+	`ohs
+(
+cs
+->
+cs_
+.
+_n
+- 
+hn
+) {
+
+355 
+chges
+ = 
+SPECIAL_I
+;
+
+356 
+
+ = 
+w_q
+;
+
+360 
+NEW_S
+:
+
+361 i(
+dS
+ =
+	`ohs
+(
+cs
+->
+cs_
+.
+_n
+- 
+hn
+) {
+
+363 
+chges
+ = 
+SPECIAL_D
+;
+
+364 
+
+ = 
+w_q
+;
+
+369 
+dS
+ = 
+	`ohs
+(
+
+->
+_id
+-tohs(
+cs
+->
+cs_
+.ip_id);
+
+370 i(
+dS
+ != 1) {
+
+371 
+	`ENCODEZ
+(
+dS
+);
+
+372 
+chges
+ |
+NEW_I
+;
+
+374 i(
+th
+->
+th_ags
+ & 
+TH_PUSH
+)
+
+375 
+chges
+ |
+TCP_PUSH_BIT
+;
+
+380 
+dA
+ = 
+	`ohs
+(
+th
+->
+th_sum
+);
+
+381 
+	`memy
+(&
+cs
+->
+cs_
+, 
+
+, 
+hn
+);
+
+392 
+dS
+ = 
+
+ - 
+w_q
+;
+
+393 
+
+ = (
+u_ch
+ *)
+
+;
+
+394 i(
+comess_cid
+ =0 || 
+comp
+->
+_xm
+ !
+cs
+->
+cs_id
+) {
+
+395 
+comp
+->
+_xm
+ = 
+cs
+->
+cs_id
+;
+
+396 
+hn
+ -
+dS
+ + 4;
+
+397 
+
+ +
+hn
+;
+
+398 *
+
+++ = 
+chges
+ | 
+NEW_C
+;
+
+399 *
+
+++ = 
+cs
+->
+cs_id
+;
+
+401 
+hn
+ -
+dS
+ + 3;
+
+402 
+
+ +
+hn
+;
+
+403 *
+
+++ = 
+chges
+;
+
+405 
+m
+->
+m_n
+ -
+hn
+;
+
+406 
+m
+->
+m_da
+ +
+hn
+;
+
+407 *
+
+++ = 
+dA
+ >> 8;
+
+408 *
+
+++ = 
+dA
+;
+
+409 
+	`memy
+(
+
+, 
+w_q
+, 
+dS
+);
+
+410 
+	`INCR
+(
+s_comesd
+)
+
+411  (
+TYPE_COMPRESSED_TCP
+);
+
+418 
+uncomesd
+:
+
+419 
+	`memy
+(&
+cs
+->
+cs_
+, 
+
+, 
+hn
+);
+
+420 
+
+->
+_p
+ = 
+cs
+->
+cs_id
+;
+
+421 
+comp
+->
+_xm
+ = 
+cs
+->
+cs_id
+;
+
+422  (
+TYPE_UNCOMPRESSED_TCP
+);
+
+423 
+	}
+}
+
+427 
+	$_uncomess_t
+(
+u_ch
+ **
+bu
+, 
+n
+, 
+u_t
+ 
+ty
+, 
+comess
+ *
+comp
+)
+
+429 
+u_ch
+ *
+hdr
+, *
+
+;
+
+430 
+vjn
+;
+
+431 
+u_t
+ 
+hn
+;
+
+433 
+
+ = 
+bu
+ ? *bu : 
+NULL
+;
+
+434 
+vjn
+ = 
+	`_uncomess_t_ce
+(
+
+, 
+n
+,, 
+ty
+, 
+comp
+, &
+hdr
+, &
+hn
+);
+
+435 i(
+vjn
+ < 0)
+
+437 i(
+vjn
+ == 0)
+
+438  (
+n
+);
+
+440 
+
+ +
+vjn
+;
+
+441 
+n
+ -
+vjn
+;
+
+451 i(()
+
+ & 3) {
+
+452 i(
+n
+ > 0)
+
+453 
+	`memmove
+((*)(()
+
+ &~ 3), cp, 
+n
+);
+
+454 
+
+ = (
+u_ch
+ *)(()cp &~ 3);
+
+456 
+
+ -
+hn
+;
+
+457 
+n
+ +
+hn
+;
+
+458 
+	`memy
+(
+
+, 
+hdr
+, 
+hn
+);
+
+460 *
+bu
+ = 
+
+;
+
+461  (
+n
+);
+
+462 
+	}
+}
+
+472 
+	$_uncomess_t_ce
+(
+u_ch
+ *
+buf
+, 
+bu
+, 
+t_n
+, 
+u_t
+ 
+ty
+,
+
+473 
+comess
+ *
+comp
+, 
+u_ch
+ **
+hd
+, 
+u_t
+ *
+h
+)
+
+475 
+u_ch
+ *
+
+;
+
+476 
+u_t
+ 
+hn
+, 
+chges
+;
+
+477 
+thdr
+ *
+th
+;
+
+478 
+ce
+ *
+cs
+;
+
+479 
+
+ *ip;
+
+480 
+ut16_t
+ *
+bp
+;
+
+481 
+u_t
+ 
+vjn
+;
+
+483 
+ty
+) {
+
+485 
+TYPE_UNCOMPRESSED_TCP
+:
+
+486 i(
+buf
+ =
+NULL
+)
+
+487 
+bad
+;
+
+488 
+
+ = ( *
+buf
+;
+
+489 i(
+
+->
+_p
+ >
+MAX_STATES
+)
+
+490 
+bad
+;
+
+491 
+cs
+ = &
+comp
+->
+re
+[comp->
+_cv
+ = 
+
+->
+_p
+];
+
+492 
+comp
+->
+ags
+ &=~ 
+SLF_TOSS
+;
+
+493 
+
+->
+_p
+ = 
+IPPROTO_TCP
+;
+
+498 
+hn
+ = 
+
+->
+_hl
+ << 2;
+
+499 i(
+hn
+ + (
+thdr
+> 
+bu
+)
+
+500 
+bad
+;
+
+501 
+hn
+ +((
+thdr
+ *)&((*)
+
+)[hn])->
+th_off
+ << 2;
+
+502 i(
+hn
+ > 
+MAX_HDR
+ || h> 
+bu
+)
+
+503 
+bad
+;
+
+504 
+	`memy
+(&
+cs
+->
+cs_
+, 
+
+, 
+hn
+);
+
+505 
+cs
+->
+cs_hn
+ = 
+hn
+;
+
+506 
+	`INCR
+(
+s_uncomesd
+)
+
+507 *
+hd
+ = (
+u_ch
+ *&
+cs
+->
+cs_
+;
+
+508 *
+h
+ = 
+hn
+;
+
+512 
+bad
+;
+
+514 
+TYPE_COMPRESSED_TCP
+:
+
+518 
+	`INCR
+(
+s_comesd
+)
+
+519 i(
+buf
+ =
+NULL
+)
+
+520 
+bad
+;
+
+521 
+
+ = 
+buf
+;
+
+522 
+chges
+ = *
+
+++;
+
+523 i(
+chges
+ & 
+NEW_C
+) {
+
+526 i(*
+
+ >
+MAX_STATES
+)
+
+527 
+bad
+;
+
+529 
+comp
+->
+ags
+ &=~ 
+SLF_TOSS
+;
+
+530 
+comp
+->
+_cv
+ = *
+
+++;
+
+535 i(
+comp
+->
+ags
+ & 
+SLF_TOSS
+) {
+
+536 
+	`INCR
+(
+s_tosd
+)
+
+540 
+cs
+ = &
+comp
+->
+re
+[comp->
+_cv
+];
+
+541 
+hn
+ = 
+cs
+->
+cs_
+.
+_hl
+ << 2;
+
+542 
+th
+ = (
+thdr
+ *)&((
+u_ch
+ *)&
+cs
+->
+cs_
+)[
+hn
+];
+
+543 
+th
+->
+th_sum
+ = 
+	`hts
+((*
+
+ << 8) | cp[1]);
+
+544 
+
+ += 2;
+
+545 i(
+chges
+ & 
+TCP_PUSH_BIT
+)
+
+546 
+th
+->
+th_ags
+ |
+TH_PUSH
+;
+
+548 
+th
+->
+th_ags
+ &=~ 
+TH_PUSH
+;
+
+550 
+chges
+ & 
+SPECIALS_MASK
+) {
+
+551 
+SPECIAL_I
+:
+
+553 
+u_t
+ 
+i
+ = 
+	`ohs
+(
+cs
+->
+cs_
+.
+_n
+- cs->
+cs_hn
+;
+
+554 
+th
+->
+th_ack
+ = 
+	`htl
+(
+	`ohl
+h->th_ack+ 
+i
+);
+
+555 
+th
+->
+th_q
+ = 
+	`htl
+(
+	`ohl
+h->th_q+ 
+i
+);
+
+559 
+SPECIAL_D
+:
+
+560 
+th
+->
+th_q
+ = 
+	`htl
+(
+	`ohl
+h->th_q+ 
+	`ohs
+(
+cs
+->
+cs_
+.
+_n
+)
+
+561 - 
+cs
+->
+cs_hn
+);
+
+565 i(
+chges
+ & 
+NEW_U
+) {
+
+566 
+th
+->
+th_ags
+ |
+TH_URG
+;
+
+567 
+	`DECODEU
+(
+th
+->
+th_u
+)
+
+569 
+th
+->
+th_ags
+ &=~ 
+TH_URG
+;
+
+570 i(
+chges
+ & 
+NEW_W
+)
+
+571 
+	`DECODES
+(
+th
+->
+th_w
+)
+
+572 i(
+chges
+ & 
+NEW_A
+)
+
+573 
+	`DECODEL
+(
+th
+->
+th_ack
+)
+
+574 i(
+chges
+ & 
+NEW_S
+)
+
+575 
+	`DECODEL
+(
+th
+->
+th_q
+)
+
+578 i(
+chges
+ & 
+NEW_I
+) {
+
+579 
+	`DECODES
+(
+cs
+->
+cs_
+.
+_id
+)
+
+581 
+cs
+->
+cs_
+.
+_id
+ = 
+	`hts
+(
+	`ohs
+(cs->cs_ip.ip_id) + 1);
+
+588 
+vjn
+ = 
+
+ - 
+buf
+;
+
+589 
+bu
+ -
+vjn
+;
+
+590 i(
+bu
+ < 0)
+
+593 
+bad
+;
+
+595 
+t_n
+ +
+cs
+->
+cs_hn
+ - 
+vjn
+;
+
+596 
+cs
+->
+cs_
+.
+_n
+ = 
+	`hts
+(
+t_n
+);
+
+599 
+bp
+ = (
+ut16_t
+ *&
+cs
+->
+cs_
+;
+
+600 
+cs
+->
+cs_
+.
+_sum
+ = 0;
+
+601 
+chges
+ = 0; 
+hn
+ > 0; hlen -= 2)
+
+602 
+chges
+ +*
+bp
+++;
+
+603 
+chges
+ = (changes & 0xffff) + (changes >> 16);
+
+604 
+chges
+ = (changes & 0xffff) + (changes >> 16);
+
+605 
+cs
+->
+cs_
+.
+_sum
+ = ~ 
+chges
+;
+
+607 *
+hd
+ = (
+u_ch
+ *&
+cs
+->
+cs_
+;
+
+608 *
+h
+ = 
+cs
+->
+cs_hn
+;
+
+609  
+vjn
+;
+
+611 
+bad
+:
+
+612 
+comp
+->
+ags
+ |
+SLF_TOSS
+;
+
+613 
+	`INCR
+(
+s_r
+)
+
+615 
+	}
+}
+
+	@slcompress.h
+
+42 #ide
+_NET_SLCOMPRESS_H_
+
+
+43 
+	#_NET_SLCOMPRESS_H_
+
+
+	)
+
+45 
+	#MAX_STATES
+ 16
+
+	)
+
+46 
+	#MAX_HDR
+ 
+MLEN
+
+
+	)
+
+92 
+	#TYPE_IP
+ 0x40
+
+	)
+
+93 
+	#TYPE_UNCOMPRESSED_TCP
+ 0x70
+
+	)
+
+94 
+	#TYPE_COMPRESSED_TCP
+ 0x80
+
+	)
+
+95 
+	#TYPE_ERROR
+ 0x00
+
+	)
+
+98 
+	#NEW_C
+ 0x40
+
+	)
+
+99 
+	#NEW_I
+ 0x20
+
+	)
+
+100 
+	#NEW_S
+ 0x08
+
+	)
+
+101 
+	#NEW_A
+ 0x04
+
+	)
+
+102 
+	#NEW_W
+ 0x02
+
+	)
+
+103 
+	#NEW_U
+ 0x01
+
+	)
+
+106 
+	#SPECIAL_I
+ (
+NEW_S
+|
+NEW_W
+|
+NEW_U
+
+
+	)
+
+107 
+	#SPECIAL_D
+ (
+NEW_S
+|
+NEW_A
+|
+NEW_W
+|
+NEW_U
+
+
+	)
+
+108 
+	#SPECIALS_MASK
+ (
+NEW_S
+|
+NEW_A
+|
+NEW_W
+|
+NEW_U
+)
+
+	)
+
+110 
+	#TCP_PUSH_BIT
+ 0x10
+
+	)
+
+119 
+	sce
+ {
+
+120 
+ce
+ *
+	mcs_xt
+;
+
+121 
+ut16_t
+ 
+	mcs_hn
+;
+
+122 
+u_ch
+ 
+	mcs_id
+;
+
+123 
+u_ch
+ 
+	mcs_fr
+;
+
+125 
+	mcsu_hdr
+[
+MAX_HDR
+];
+
+126 #ifde
+INET
+
+
+127 
+
+ 
+	mcsu_
+;
+
+129 } 
+	mcs_u
+;
+
+131 
+	#cs_
+ 
+cs_u
+.
+csu_
+
+
+	)
+
+132 
+	#cs_hdr
+ 
+cs_u
+.
+csu_hdr
+
+
+	)
+
+138 
+	scomess
+ {
+
+139 
+ce
+ *
+	m_cs
+;
+
+140 
+u_ch
+ 
+	m_cv
+;
+
+141 
+u_ch
+ 
+	m_xm
+;
+
+142 
+ut16_t
+ 
+	mags
+;
+
+143 #ide
+SL_NO_STATS
+
+
+144 
+	ms_cks
+;
+
+145 
+	ms_comesd
+;
+
+146 
+	ms_ches
+;
+
+147 
+	ms_miss
+;
+
+148 
+	ms_uncomesd
+;
+
+149 
+	ms_comesd
+;
+
+150 
+	ms_r
+;
+
+151 
+	ms_tosd
+;
+
+153 
+ce
+ 
+	mte
+[
+MAX_STATES
+];
+
+154 
+ce
+ 
+	mre
+[
+MAX_STATES
+];
+
+157 
+	#SLF_TOSS
+ 1
+
+	)
+
+159 
+_comess_
+(
+comess
+ *);
+
+160 
+_comess_tup
+(
+comess
+ *, );
+
+161 #ifde
+INET
+
+
+162 
+u_t
+ 
+_comess_t
+(
+mbuf
+ *,
+
+163 
+
+ *, 
+comess
+ *, );
+
+165 
+_uncomess_t
+(
+u_ch
+ **, , 
+u_t
+, 
+comess
+ *);
+
+166 
+_uncomess_t_ce
+(
+u_ch
+ *, , , 
+u_t
+,
+
+167 
+comess
+ *, 
+u_ch
+ **, 
+u_t
+ *);
+
+	@slip.h
+
+34 #ide
+_NET_SLIP_H_
+
+
+35 
+	#_NET_SLIP_H_
+
+
+	)
+
+38 
+	#SLIOCGUNIT
+ 
+	`_IOR
+('t', 88, 
+
+	)
+
+44 
+	#SLIP_HDRLEN
+ 16
+
+	)
+
+47 
+	#SLX_DIR
+ 0
+
+	)
+
+48 
+	#SLX_CHDR
+ 1
+
+	)
+
+49 
+	#CHDR_LEN
+ 15
+
+	)
+
+51 
+	#SLIPDIR_IN
+ 0
+
+	)
+
+52 
+	#SLIPDIR_OUT
+ 1
+
+	)
+
+	@zlib.c
+
+24 
+	~<sys/cdefs.h
+>
+
+25 
+__KERNEL_RCSID
+(0, "$NetBSD: zlib.c,v 1.34 2013/12/29 08:09:44goyette Exp $");
+
+27 
+	#NO_DUMMY_DECL
+
+
+	)
+
+28 
+	#NO_ZCFUNCS
+
+
+	)
+
+29 
+	#MY_ZCALLOC
+
+
+	)
+
+31 #i
+defed
+(
+__FeBSD__
+&& (defed(
+KERNEL
+|| defed(
+_KERNEL
+))
+
+32 
+	#e
+ 
+e_p
+
+
+	)
+
+50 #ide
+_Z_UTIL_H
+
+
+51 
+	#_Z_UTIL_H
+
+
+	)
+
+53 
+	~"zlib.h
+"
+
+55 #i
+defed
+(
+KERNEL
+|| defed(
+_KERNEL
+)
+
+57 
+	~<sys/m.h
+>
+
+58 
+	~<sys/time.h
+>
+
+59 
+	~<sys/sym.h
+>
+
+60 
+	#HAVE_MEMCPY
+
+
+	)
+
+62 #i
+defed
+(
+__KERNEL__
+)
+
+64 
+	~<lux/rg.h
+>
+
+65 
+	#HAVE_MEMCPY
+
+
+	)
+
+69 #i
+defed
+(
+__NBSD__
+&& (defed(
+_KERNEL
+|| defed(
+_STANDALONE
+))
+
+72 
+	~<lib/libkn/libkn.h
+>
+
+75 
+	~<sys/tys.h
+>
+
+76 
+	~<sys/m.h
+>
+
+77 #ifde
+STDC
+
+
+78 
+	~<ddef.h
+>
+
+79 
+	~<rg.h
+>
+
+80 
+	~<dlib.h
+>
+
+82 #ifde
+NO_ERRNO_H
+
+
+83 
+o
+;
+
+85 
+	~<o.h
+>
+
+91 #ide
+lol
+
+
+92 
+	#lol
+ 
+
+	)
+
+96 
+	tuch
+;
+
+97 
+uch
+ 
+	tFAR
+ 
+	tuchf
+;
+
+98 
+	tush
+;
+
+99 
+ush
+ 
+	tFAR
+ 
+	tushf
+;
+
+100 
+	tulg
+;
+
+102 c *
+z_rmsg
+[10];
+
+105 
+	#ERR_MSG
+(
+r
+
+z_rmsg
+[
+Z_NEED_DICT
+-)]
+
+	)
+
+107 
+	#ERR_RETURN
+(
+rm
+,
+r
+) \
+
+108  (
+rm
+->
+msg
+ = 
+	`ERR_MSG
+(
+r
+), (r))
+
+	)
+
+113 #ide
+DEF_WBITS
+
+
+114 
+	#DEF_WBITS
+ 
+MAX_WBITS
+
+
+	)
+
+118 #i
+MAX_MEM_LEVEL
+ >= 8
+
+119 
+	#DEF_MEM_LEVEL
+ 8
+
+	)
+
+121 
+	#DEF_MEM_LEVEL
+ 
+MAX_MEM_LEVEL
+
+
+	)
+
+125 
+	#STORED_BLOCK
+ 0
+
+	)
+
+126 
+	#STATIC_TREES
+ 1
+
+	)
+
+127 
+	#DYN_TREES
+ 2
+
+	)
+
+130 
+	#MIN_MATCH
+ 3
+
+	)
+
+131 
+	#MAX_MATCH
+ 258
+
+	)
+
+134 
+	#PRESET_DICT
+ 0x20
+
+	)
+
+138 #ifde
+MSDOS
+
+
+139 
+	#OS_CODE
+ 0x00
+
+	)
+
+140 #i
+defed
+(
+__TURBOC__
+|| defed(
+__BORLANDC__
+)
+
+141 #if(
+__STDC__
+ =1&& (
+defed
+(
+__LARGE__
+|| defed(
+__COMPACT__
+))
+
+143 
+_Cde
+ 
+r
+*
+block
+ );
+
+144 *
+_Cde
+ 
+rmloc
+
+nbys
+ );
+
+146 
+	~<loc.h
+>
+
+149 
+	~<mloc.h
+>
+
+153 #ifde
+OS2
+
+
+154 
+	#OS_CODE
+ 0x06
+
+	)
+
+157 #ifde
+WIN32
+
+
+158 
+	#OS_CODE
+ 0x0b
+
+	)
+
+161 #i
+defed
+(
+VAXC
+|| defed(
+VMS
+)
+
+162 
+	#OS_CODE
+ 0x02
+
+	)
+
+163 
+	#F_OPEN
+(
+me
+, 
+mode
+) \
+
+164 
+	`f
+((
+me
+), (
+mode
+), "mbc=60", "x=m", "rfm=fix", "mrs=512")
+
+	)
+
+167 #ifde
+AMIGA
+
+
+168 
+	#OS_CODE
+ 0x01
+
+	)
+
+171 #i
+defed
+(
+ATARI
+|| defed(
+i
+)
+
+172 
+	#OS_CODE
+ 0x05
+
+	)
+
+175 #i
+defed
+(
+MACOS
+|| defed(
+TARGET_OS_MAC
+)
+
+176 
+	#OS_CODE
+ 0x07
+
+	)
+
+177 #i
+defed
+(
+__MWERKS__
+&& 
+__de_os
+ !
+__be_os
+ && __de_o!
+__w32_os
+
+
+178 
+	~<unix.h
+>
+
+180 #ide
+fd
+
+
+181 
+	#fd
+(
+fd
+,
+mode
+
+NULL
+
+
+	)
+
+186 #ifde
+__50SERIES
+
+
+187 
+	#OS_CODE
+ 0x0F
+
+	)
+
+190 #ifde
+TOPS20
+
+
+191 
+	#OS_CODE
+ 0x0a
+
+	)
+
+194 #i
+defed
+(
+_BEOS_
+|| defed(
+RISCOS
+)
+
+195 
+	#fd
+(
+fd
+,
+mode
+
+NULL
+
+
+	)
+
+198 #i(
+defed
+(
+_MSC_VER
+) && (_MSC_VER > 600))
+
+199 
+	#fd
+(
+fd
+,
+ty
+
+	`_fd
+(fd,ty)
+
+	)
+
+205 #ide
+OS_CODE
+
+
+206 
+	#OS_CODE
+ 0x03
+
+	)
+
+209 #ide
+F_OPEN
+
+
+210 
+	#F_OPEN
+(
+me
+, 
+mode
+
+	`f
+(ame), (mode))
+
+	)
+
+215 #ifde
+HAVE_STRERROR
+
+
+216 *
+
+();
+
+217 
+	#z
+(
+um
+
+	`
+num)
+
+	)
+
+219 
+	#z
+(
+um
+""
+
+	)
+
+222 #i
+defed
+(
+pyr
+)
+
+223 
+	#NO_MEMCPY
+
+
+	)
+
+225 #i
+defed
+(
+SMALL_MEDIUM
+&& !defed(
+_MSC_VER
+&& !defed(
+__SC__
+)
+
+230 
+	#NO_MEMCPY
+
+
+	)
+
+232 #i
+defed
+(
+STDC
+&& !defed(
+HAVE_MEMCPY
+&& !defed(
+NO_MEMCPY
+)
+
+233 
+	#HAVE_MEMCPY
+
+
+	)
+
+235 #ifde
+HAVE_MEMCPY
+
+
+236 #ifde
+SMALL_MEDIUM
+
+
+237 
+	#zmemy
+ 
+_fmemy
+
+
+	)
+
+238 
+	#zmemcmp
+ 
+_fmemcmp
+
+
+	)
+
+239 
+	#zmemzo
+(
+de
+, 
+n
+
+	`_fmemt
+(de, 0,)
+
+	)
+
+241 
+	#zmemy
+ 
+memy
+
+
+	)
+
+242 
+	#zmemcmp
+ 
+memcmp
+
+
+	)
+
+243 
+	#zmemzo
+(
+de
+, 
+n
+
+	`memt
+(de, 0,)
+
+	)
+
+246 
+zmemy
+(
+Byf
+* 
+de
+, c Byf* 
+sour
+, 
+uI
+ 
+n
+);
+
+247 
+zmemcmp
+(c 
+Byf
+* 
+s1
+, c Byf* 
+s2
+, 
+uI
+ 
+n
+);
+
+248 
+zmemzo
+(
+Byf
+* 
+de
+, 
+uI
+ 
+n
+);
+
+252 #i
+defed
+(
+DEBUG_ZLIB
+&& !defed(
+_KERNEL
+&& !defed(
+_STANDALONE
+)
+
+253 
+	~<dio.h
+>
+
+254 
+z_vbo
+;
+
+255 
+z_r
+(*
+m
+);
+
+256 
+	#As
+(
+cd
+,
+msg
+{if(!(cd)
+	`z_r
+(msg);}
+
+	)
+
+257 
+	#T
+(
+x
+{i(
+z_vbo
+>=0
+rtf
+ x ;}
+
+	)
+
+258 
+	#Tv
+(
+x
+{i(
+z_vbo
+>0
+rtf
+ x ;}
+
+	)
+
+259 
+	#Tvv
+(
+x
+{i(
+z_vbo
+>1
+rtf
+ x ;}
+
+	)
+
+260 
+	#Tc
+(
+c
+,
+x
+{i(
+z_vbo
+>0 && (c)
+rtf
+ x ;}
+
+	)
+
+261 
+	#Tcv
+(
+c
+,
+x
+{i(
+z_vbo
+>1 && (c)
+rtf
+ x ;}
+
+	)
+
+263 
+	#As
+(
+cd
+,
+msg
+)
+
+	)
+
+264 
+	#T
+(
+x
+)
+
+	)
+
+265 
+	#Tv
+(
+x
+)
+
+	)
+
+266 
+	#Tvv
+(
+x
+)
+
+	)
+
+267 
+	#Tc
+(
+c
+,
+x
+)
+
+	)
+
+268 
+	#Tcv
+(
+c
+,
+x
+)
+
+	)
+
+272 
+	$uLg
+ (
+	tZEXPORT
+ *
+	tcheck_func
+)(
+	tuLg
+ 
+	tcheck
+, c 
+	tByf
+ *
+	tbuf
+,
+
+273 
+	tuI
+ 
+	tn
+);
+
+274 
+voidpf
+ 
+	`zoc
+(voidp
+aque
+, 
+ems
+, 
+size
+);
+
+275 
+	`zc
+(
+voidpf
+ 
+aque
+, voidp
+r
+);
+
+277 
+	#ZALLOC
+(
+rm
+, 
+ems
+, 
+size
+) \
+
+278 (*((
+rm
+)->
+zloc
+))((rm)->
+aque
+, (
+ems
+), (
+size
+))
+
+	)
+
+279 
+	#ZFREE
+(
+rm
+, 
+addr
+(*((rm)->
+z
+))((rm)->
+aque
+, (
+voidpf
+)ddr))
+
+	)
+
+280 
+	#TRY_FREE
+(
+s
+, 
+p
+{i
+	`ZFREE
+(s,);
+	}
+
+	)
+}
+
+299 #ide
+_DEFLATE_H
+
+
+300 
+	#_DEFLATE_H
+
+
+	)
+
+308 
+	#LENGTH_CODES
+ 29
+
+	)
+
+311 
+	#LITERALS
+ 256
+
+	)
+
+314 
+	#L_CODES
+ (
+LITERALS
++1+
+LENGTH_CODES
+)
+
+	)
+
+317 
+	#D_CODES
+ 30
+
+	)
+
+320 
+	#BL_CODES
+ 19
+
+	)
+
+323 
+	#HEAP_SIZE
+ (2*
+L_CODES
++1)
+
+	)
+
+326 
+	#MAX_BITS
+ 15
+
+	)
+
+329 
+	#INIT_STATE
+ 42
+
+	)
+
+330 
+	#BUSY_STATE
+ 113
+
+	)
+
+331 
+	#FINISH_STATE
+ 666
+
+	)
+
+336 
+	s_da_s
+ {
+
+338 
+ush
+ 
+	meq
+;
+
+339 
+ush
+ 
+	mcode
+;
+
+340 } 
+	mfc
+;
+
+342 
+ush
+ 
+	mdad
+;
+
+343 
+ush
+ 
+	mn
+;
+
+344 } 
+	mdl
+;
+
+345 } 
+	tFAR
+ 
+	t_da
+;
+
+347 
+	#Fq
+ 
+fc
+.
+eq
+
+
+	)
+
+348 
+	#Code
+ 
+fc
+.
+code
+
+
+	)
+
+349 
+	#Dad
+ 
+dl
+.
+dad
+
+
+	)
+
+350 
+	#L
+ 
+dl
+.
+n
+
+
+	)
+
+352 
+ic__desc_s
+ 
+	tic__desc
+;
+
+354 
+	s_desc_s
+ {
+
+355 
+_da
+ *
+	mdyn_
+;
+
+356 
+	mmax_code
+;
+
+357 
+ic__desc
+ *
+	m_desc
+;
+
+358 } 
+	tFAR
+ 
+	t_desc
+;
+
+360 
+ush
+ 
+	tPos
+;
+
+361 
+Pos
+ 
+	tFAR
+ 
+	tPosf
+;
+
+362 
+	tIPos
+;
+
+368 
+	sdee_e
+ {
+
+369 
+z_amp
+ 
+	mrm
+;
+
+370 
+	mus
+;
+
+371 
+Byf
+ *
+	mndg_buf
+;
+
+372 
+ulg
+ 
+	mndg_buf_size
+;
+
+373 
+Byf
+ *
+	mndg_out
+;
+
+374 
+	mndg
+;
+
+375 
+	mnohd
+;
+
+376 
+By
+ 
+	mda_ty
+;
+
+377 
+By
+ 
+	mmhod
+;
+
+378 
+	m_ush
+;
+
+382 
+uI
+ 
+	mw_size
+;
+
+383 
+uI
+ 
+	mw_bs
+;
+
+384 
+uI
+ 
+	mw_mask
+;
+
+386 
+Byf
+ *
+	mwdow
+;
+
+396 
+ulg
+ 
+	mwdow_size
+;
+
+401 
+Posf
+ *
+	mev
+;
+
+407 
+Posf
+ *
+	mhd
+;
+
+409 
+uI
+ 
+	ms_h
+;
+
+410 
+uI
+ 
+	mhash_size
+;
+
+411 
+uI
+ 
+	mhash_bs
+;
+
+412 
+uI
+ 
+	mhash_mask
+;
+
+414 
+uI
+ 
+	mhash_shi
+;
+
+421 
+	mblock_t
+;
+
+426 
+uI
+ 
+	mmch_ngth
+;
+
+427 
+IPos
+ 
+	mev_mch
+;
+
+428 
+	mmch_avaab
+;
+
+429 
+uI
+ 
+	mrt
+;
+
+430 
+uI
+ 
+	mmch_t
+;
+
+431 
+uI
+ 
+	mlookahd
+;
+
+433 
+uI
+ 
+	mev_ngth
+;
+
+438 
+uI
+ 
+	mmax_cha_ngth
+;
+
+444 
+uI
+ 
+	mmax_zy_mch
+;
+
+449 
+	#max__ngth
+ 
+max_zy_mch
+
+
+	)
+
+455 
+	mv
+;
+
+456 
+	mgy
+;
+
+458 
+uI
+ 
+	mgood_mch
+;
+
+461 
+	mni_mch
+;
+
+465 
+_da_s
+ 
+	mdyn_e
+[
+HEAP_SIZE
+];
+
+466 
+_da_s
+ 
+	mdyn_d
+[2*
+D_CODES
++1];
+
+467 
+_da_s
+ 
+	mbl_
+[2*
+BL_CODES
++1];
+
+469 
+_desc_s
+ 
+	ml_desc
+;
+
+470 
+_desc_s
+ 
+	md_desc
+;
+
+471 
+_desc_s
+ 
+	mbl_desc
+;
+
+473 
+ush
+ 
+	mbl_cou
+[
+MAX_BITS
++1];
+
+476 
+	mhp
+[2*
+L_CODES
++1];
+
+477 
+	mhp_n
+;
+
+478 
+	mhp_max
+;
+
+483 
+uch
+ 
+	mdth
+[2*
+L_CODES
++1];
+
+487 
+uchf
+ *
+	ml_buf
+;
+
+489 
+uI
+ 
+	ml_bufsize
+;
+
+509 
+uI
+ 
+	m_l
+;
+
+511 
+ushf
+ *
+	md_buf
+;
+
+517 
+ulg
+ 
+	mt_n
+;
+
+518 
+ulg
+ 
+	mic_n
+;
+
+519 
+uI
+ 
+	mmches
+;
+
+520 
+	m_eob_n
+;
+
+522 #ifde
+DEBUG_ZLIB
+
+
+523 
+ulg
+ 
+	mcomesd_n
+;
+
+524 
+ulg
+ 
+	mbs_
+;
+
+527 
+ush
+ 
+	mbi_buf
+;
+
+531 
+	mbi_vid
+;
+
+536 } 
+	tFAR
+ 
+	tdee_e
+;
+
+541 
+	#put_by
+(
+s
+, 
+c
+{s->
+ndg_buf
+[s->
+ndg
+++] = (c);}
+
+	)
+
+544 
+	#MIN_LOOKAHEAD
+ (
+MAX_MATCH
++
+MIN_MATCH
++1)
+
+	)
+
+549 
+	#MAX_DIST
+(
+s
+((s)->
+w_size
+-
+MIN_LOOKAHEAD
+)
+
+	)
+
+555 
+__
+(
+dee_e
+ *
+s
+);
+
+556 
+__y
+(
+dee_e
+ *
+s
+, 
+di
+, 
+lc
+);
+
+557 
+__ush_block
+(
+dee_e
+ *
+s
+, 
+chf
+ *
+buf
+, 
+ulg
+ 
+ed_n
+,
+
+558 
+eof
+);
+
+559 
+__ign
+(
+dee_e
+ *
+s
+);
+
+560 
+__ed_block
+(
+dee_e
+ *
+s
+, 
+chf
+ *
+buf
+, 
+ulg
+ 
+ed_n
+,
+
+561 
+eof
+);
+
+562 
+__ed_ty_ly
+(
+dee_e
+ *);
+
+564 
+	#d_code
+(
+di
+) \
+
+565 ((
+di
+< 256 ? 
+_di_code
+[di] : _di_code[256+((di)>>7)])
+
+	)
+
+571 #ide
+DEBUG_ZLIB
+
+
+574 #i
+defed
+(
+GEN_TREES_H
+|| !defed(
+STDC
+)
+
+575 
+uch
+ 
+_ngth_code
+[];
+
+576 
+uch
+ 
+_di_code
+[];
+
+578 c 
+uch
+ 
+_ngth_code
+[];
+
+579 c 
+uch
+ 
+_di_code
+[];
+
+582 
+	#__y_l
+(
+s
+, 
+c
+, 
+ush
+) \
+
+583 { 
+uch
+ 
+cc
+ = (
+c
+); \
+
+584 
+s
+->
+d_buf
+[s->
+_l
+] = 0; \
+
+585 
+s
+->
+l_buf
+[s->
+_l
+++] = 
+cc
+; \
+
+586 
+s
+->
+dyn_e
+[
+cc
+].
+Fq
+++; \
+
+587 
+ush
+ = (
+s
+->
+_l
+ =s->
+l_bufsize
+-1); \
+
+588 }
+
+	)
+
+589 
+	#__y_di
+(
+s
+, 
+di
+, 
+ngth
+, 
+ush
+) \
+
+590 { 
+uch
+ 
+n
+ = (
+ngth
+); \
+
+591 
+ush
+ 
+di
+ = (
+di
+); \
+
+592 
+s
+->
+d_buf
+[s->
+_l
+] = 
+di
+; \
+
+593 
+s
+->
+l_buf
+[s->
+_l
+++] = 
+n
+; \
+
+594 
+di
+--; \
+
+595 
+s
+->
+dyn_e
+[
+_ngth_code
+[
+n
+]+
+LITERALS
++1].
+Fq
+++; \
+
+596 
+s
+->
+dyn_d
+[
+	`d_code
+(
+di
+)].
+Fq
+++; \
+
+597 
+ush
+ = (
+s
+->
+_l
+ =s->
+l_bufsize
+-1); \
+
+598 }
+
+	)
+
+600 
+	#__y_l
+(
+s
+, 
+c
+, 
+ush
+ush = 
+	`__y
+(s, 0, c)
+
+	)
+
+601 
+	#__y_di
+(
+s
+, 
+di
+, 
+ngth
+, 
+ush
+) \
+
+602 
+ush
+ = 
+	`__y
+(
+s
+, 
+di
+, 
+ngth
+)
+
+	)
+
+663 c 
+	gdee_cyright
+[] =
+
+676 
+	med_me
+,
+
+677 
+	mblock_de
+,
+
+678 
+	mfish_d
+,
+
+679 
+	mfish_de
+
+
+680 } 
+	tblock_e
+;
+
+682 
+	$block_e
+ (*
+	tcomess_func
+)(
+	tdee_e
+ *
+	ts
+, 
+	tush
+);
+
+685 
+lol
+ 
+	`fl_wdow
+(
+dee_e
+ *
+s
+);
+
+686 
+lol
+ 
+block_e
+ 
+	`dee_ed
+(
+dee_e
+ *
+s
+, 
+ush
+);
+
+687 
+lol
+ 
+block_e
+ 
+	`dee_
+(
+dee_e
+ *
+s
+, 
+ush
+);
+
+688 
+lol
+ 
+block_e
+ 
+	`dee_ow
+(
+dee_e
+ *
+s
+, 
+ush
+);
+
+689 
+lol
+ 
+	`lm_
+(
+dee_e
+ *
+s
+);
+
+690 
+lol
+ 
+	`putShtMSB
+(
+dee_e
+ *
+s
+, 
+uI
+ 
+b
+);
+
+691 
+lol
+ 
+	`ush_ndg
+(
+z_amp
+ 
+rm
+);
+
+692 
+lol
+ 
+	`ad_buf
+(
+z_amp
+ 
+rm
+, 
+Byf
+ *
+buf
+, 
+size
+);
+
+693 #ifde
+ASMV
+
+
+694 
+	`mch_
+();
+
+695 
+uI
+ 
+	`lge_mch
+(
+dee_e
+ *
+s
+, 
+IPos
+ 
+cur_mch
+);
+
+697 
+lol
+ 
+uI
+ 
+	`lge_mch
+(
+dee_e
+ *
+s
+, 
+IPos
+ 
+cur_mch
+);
+
+700 #ifde
+DEBUG_ZLIB
+
+
+701 
+lol
+ 
+	`check_mch
+(
+dee_e
+ *
+s
+, 
+IPos
+ 
+t
+, IPo
+mch
+,
+
+702 
+ngth
+);
+
+709 
+	#NIL
+ 0
+
+	)
+
+712 #ide
+TOO_FAR
+
+
+713 
+	#TOO_FAR
+ 4096
+
+	)
+
+717 
+	#MIN_LOOKAHEAD
+ (
+MAX_MATCH
++
+MIN_MATCH
++1)
+
+	)
+
+727 
+	scfig_s
+ {
+
+728 
+ush
+ 
+good_ngth
+;
+
+729 
+ush
+ 
+max_zy
+;
+
+730 
+ush
+ 
+ni_ngth
+;
+
+731 
+ush
+ 
+max_cha
+;
+
+732 
+comess_func
+ 
+func
+;
+
+733 } 
+	tcfig
+;
+
+735 
+lol
+ c 
+cfig
+ 
+cfiguti_b
+[10] = {
+
+737  {0, 0, 0, 0, 
+dee_ed
+},
+
+738  {4, 4, 8, 4, 
+dee_
+},
+
+739  {4, 5, 16, 8, 
+dee_
+},
+
+740  {4, 6, 32, 32, 
+dee_
+},
+
+742  {4, 4, 16, 16, 
+dee_ow
+},
+
+743  {8, 16, 32, 32, 
+dee_ow
+},
+
+744  {8, 16, 128, 128, 
+dee_ow
+},
+
+745  {8, 32, 128, 256, 
+dee_ow
+},
+
+746  {32, 128, 258, 1024, 
+dee_ow
+},
+
+747  {32, 258, 258, 4096, 
+dee_ow
+}
+	}
+};
+
+754 
+	#EQUAL
+ 0
+
+	)
+
+757 #ide
+NO_DUMMY_DECL
+
+
+758 
+	sic__desc_s
+ {
+	mdummy
+;};
+
+767 
+	#UPDATE_HASH
+(
+s
+,
+h
+,
+c
+(h = (((h)<<s->
+hash_shi
+^ (c)& s->
+hash_mask
+)
+
+	)
+
+780 #ifde
+FASTEST
+
+
+781 
+	#INSERT_STRING
+(
+s
+, 
+r
+, 
+mch_hd
+) \
+
+782 (
+	`UPDATE_HASH
+(
+s
+, s->
+s_h
+, s->
+wdow
+[(
+r
++ (
+MIN_MATCH
+-1)]), \
+
+783 
+mch_hd
+ = 
+s
+->
+hd
+[s->
+s_h
+], \
+
+784 
+s
+->
+hd
+[s->
+s_h
+] = (
+Pos
+)(
+r
+))
+
+	)
+
+786 
+	#INSERT_STRING
+(
+s
+, 
+r
+, 
+mch_hd
+) \
+
+787 (
+	`UPDATE_HASH
+(
+s
+, s->
+s_h
+, s->
+wdow
+[(
+r
++ (
+MIN_MATCH
+-1)]), \
+
+788 
+s
+->
+ev
+[(
+r
+& s->
+w_mask
+] = 
+mch_hd
+ = s->
+hd
+[s->
+s_h
+], \
+
+789 
+s
+->
+hd
+[s->
+s_h
+] = (
+Pos
+)(
+r
+))
+
+	)
+
+796 
+	#CLEAR_HASH
+(
+s
+) \
+
+797 
+s
+->
+hd
+[s->
+hash_size
+-1] = 
+NIL
+; \
+
+798 
+	`zmemzo
+((
+Byf
+ *)
+s
+->
+hd
+, ()(s->
+hash_size
+-1)*(*s->hd));
+
+	)
+
+802 
+ZEXPORT
+ 
+	$deeIn_
+(
+z_amp
+ 
+rm
+,
+
+803 
+v
+, c *
+vsi
+, 
+am_size
+)
+
+805  
+	`deeIn2_
+(
+rm
+, 
+v
+, 
+Z_DEFLATED
+, 
+MAX_WBITS
+, 
+DEF_MEM_LEVEL
+,
+
+806 
+Z_DEFAULT_STRATEGY
+, 
+vsi
+, 
+am_size
+);
+
+808 
+	}
+}
+
+812 
+ZEXPORT
+ 
+	$deeIn2_
+(
+z_amp
+ 
+rm
+,
+
+813 
+v
+, 
+mhod
+, 
+wdowBs
+, 
+memLev
+, 
+gy
+,
+
+814 c *
+vs
+, 
+am_size
+)
+
+816 
+dee_e
+ *
+s
+;
+
+817 
+nohd
+ = 0;
+
+818 c * 
+my_vsi
+ = 
+ZLIB_VERSION
+;
+
+820 
+ushf
+ *
+ovy
+;
+
+825 i(
+vs
+ =
+Z_NULL
+ || vs[0] !
+my_vsi
+[0] ||
+
+826 
+am_size
+ !(
+z_am
+)) {
+
+827  
+Z_VERSION_ERROR
+;
+
+829 i(
+rm
+ =
+Z_NULL
+ 
+Z_STREAM_ERROR
+;
+
+831 
+rm
+->
+msg
+ = 
+Z_NULL
+;
+
+832 #ide
+NO_ZCFUNCS
+
+
+833 i(
+rm
+->
+zloc
+ =
+Z_NULL
+) {
+
+834 
+rm
+->
+zloc
+ = 
+zoc
+;
+
+835 
+rm
+->
+aque
+ = (
+voidpf
+)0;
+
+837 i(
+rm
+->
+z
+ =
+Z_NULL
+rm->z = 
+zc
+;
+
+840 i(
+v
+ =
+Z_DEFAULT_COMPRESSION
+)evel = 6;
+
+841 #ifde
+FASTEST
+
+
+842 
+v
+ = 1;
+
+845 i(
+wdowBs
+ < 0) {
+
+846 
+nohd
+ = 1;
+
+847 
+wdowBs
+ = -windowBits;
+
+849 i(
+memLev
+ < 1 || memLev > 
+MAX_MEM_LEVEL
+ || 
+mhod
+ !
+Z_DEFLATED
+ ||
+
+850 
+wdowBs
+ < 9 || wdowB> 15 || 
+v
+ < 0 ||evel > 9 ||
+
+851 
+gy
+ < 0 || segy > 
+Z_HUFFMAN_ONLY
+) {
+
+852  
+Z_STREAM_ERROR
+;
+
+854 
+s
+ = (
+dee_e
+ *
+	`ZALLOC
+(
+rm
+, 1, (deflate_state));
+
+855 i(
+s
+ =
+Z_NULL
+ 
+Z_MEM_ERROR
+;
+
+856 
+rm
+->
+e
+ = (
+_e
+ 
+FAR
+ *)
+s
+;
+
+857 
+s
+->
+rm
+ = strm;
+
+859 
+s
+->
+nohd
+ =oheader;
+
+860 
+s
+->
+w_bs
+ = 
+wdowBs
+;
+
+861 
+s
+->
+w_size
+ = 1 << s->
+w_bs
+;
+
+862 
+s
+->
+w_mask
+ = s->
+w_size
+ - 1;
+
+864 
+s
+->
+hash_bs
+ = 
+memLev
+ + 7;
+
+865 
+s
+->
+hash_size
+ = 1 << s->
+hash_bs
+;
+
+866 
+s
+->
+hash_mask
+ = s->
+hash_size
+ - 1;
+
+867 
+s
+->
+hash_shi
+ = ((s->
+hash_bs
++
+MIN_MATCH
+-1)/MIN_MATCH);
+
+869 
+s
+->
+wdow
+ = (
+Byf
+ *
+	`ZALLOC
+(
+rm
+, s->
+w_size
+, 2*(
+By
+));
+
+870 
+s
+->
+ev
+ = (
+Posf
+ *
+	`ZALLOC
+(
+rm
+, s->
+w_size
+, (
+Pos
+));
+
+871 
+s
+->
+hd
+ = (
+Posf
+ *
+	`ZALLOC
+(
+rm
+, s->
+hash_size
+, (
+Pos
+));
+
+873 
+s
+->
+l_bufsize
+ = 1 << (
+memLev
+ + 6);
+
+875 
+ovy
+ = (
+ushf
+ *
+	`ZALLOC
+(
+rm
+, 
+s
+->
+l_bufsize
+, (
+ush
+)+2);
+
+876 
+s
+->
+ndg_buf
+ = (
+uchf
+ *
+ovy
+;
+
+877 
+s
+->
+ndg_buf_size
+ = (
+ulg
+)s->
+l_bufsize
+ * ((
+ush
+)+2L);
+
+879 i(
+s
+->
+wdow
+ =
+Z_NULL
+ || s->
+ev
+ =Z_NULL || s->
+hd
+ == Z_NULL ||
+
+880 
+s
+->
+ndg_buf
+ =
+Z_NULL
+) {
+
+881 
+rm
+->
+msg
+ = 
+	`ERR_MSG
+(
+Z_MEM_ERROR
+);
+
+882 
+s
+->
+us
+ = 
+INIT_STATE
+;
+
+883 
+	`deeEnd
+ (
+rm
+);
+
+884  
+Z_MEM_ERROR
+;
+
+886 
+s
+->
+d_buf
+ = 
+ovy
+ + s->
+l_bufsize
+/(
+ush
+);
+
+887 
+s
+->
+l_buf
+ = s->
+ndg_buf
+ + (1+(
+ush
+))*s->
+l_bufsize
+;
+
+889 
+s
+->
+v
+ =evel;
+
+890 
+s
+->
+gy
+ = strategy;
+
+891 
+s
+->
+mhod
+ = (
+By
+)method;
+
+893  
+	`deeRet
+(
+rm
+);
+
+894 
+	}
+}
+
+898 
+ZEXPORT
+ 
+	$deeSDiiy
+ (
+z_amp
+ 
+rm
+,
+
+899 c 
+Byf
+ *
+diiy
+,
+
+900 
+uI
+ 
+diLgth
+)
+
+902 
+dee_e
+ *
+s
+;
+
+903 
+uI
+ 
+ngth
+ = 
+diLgth
+;
+
+904 
+uI
+ 
+n
+;
+
+905 
+IPos
+ 
+hash_hd
+ = 0;
+
+907 i(
+rm
+ =
+Z_NULL
+ || sm->
+e
+ =Z_NULL || 
+diiy
+ == Z_NULL)
+
+908  
+Z_STREAM_ERROR
+;
+
+910 
+s
+ = (
+dee_e
+ *)
+rm
+->
+e
+;
+
+911 i(
+s
+->
+us
+ !
+INIT_STATE
+ 
+Z_STREAM_ERROR
+;
+
+913 
+rm
+->
+adr
+ = 
+	`adr32
+(rm->adr, 
+diiy
+, 
+diLgth
+);
+
+915 i(
+ngth
+ < 
+MIN_MATCH
+ 
+Z_OK
+;
+
+916 i(
+ngth
+ > 
+	`MAX_DIST
+(
+s
+)) {
+
+917 
+ngth
+ = 
+	`MAX_DIST
+(
+s
+);
+
+918 #ide
+USE_DICT_HEAD
+
+
+919 
+diiy
+ +
+diLgth
+ - 
+ngth
+;
+
+922 
+	`zmemy
+(
+s
+->
+wdow
+, 
+diiy
+, 
+ngth
+);
+
+923 
+s
+->
+rt
+ = 
+ngth
+;
+
+924 
+s
+->
+block_t
+ = ()
+ngth
+;
+
+930 
+s
+->
+s_h
+ = s->
+wdow
+[0];
+
+931 
+	`UPDATE_HASH
+(
+s
+, s->
+s_h
+, s->
+wdow
+[1]);
+
+932 
+n
+ = 0; <
+ngth
+ - 
+MIN_MATCH
+;++) {
+
+933 
+	`INSERT_STRING
+(
+s
+, 
+n
+, 
+hash_hd
+);
+
+935 i(
+hash_hd
+) hash_head = 0;
+
+936  
+Z_OK
+;
+
+937 
+	}
+}
+
+941 
+ZEXPORT
+ 
+	$deeRet
+ (
+z_amp
+ 
+rm
+)
+
+943 
+dee_e
+ *
+s
+;
+
+945 i(
+rm
+ =
+Z_NULL
+ || sm->
+e
+ == Z_NULL ||
+
+946 
+rm
+->
+zloc
+ =
+Z_NULL
+ || sm->
+z
+ =Z_NULL 
+Z_STREAM_ERROR
+;
+
+948 
+rm
+->
+t_
+ = sm->
+t_out
+ = 0;
+
+949 
+rm
+->
+msg
+ = 
+Z_NULL
+;
+
+950 
+rm
+->
+da_ty
+ = 
+Z_UNKNOWN
+;
+
+952 
+s
+ = (
+dee_e
+ *)
+rm
+->
+e
+;
+
+953 
+s
+->
+ndg
+ = 0;
+
+954 
+s
+->
+ndg_out
+ = s->
+ndg_buf
+;
+
+956 i(
+s
+->
+nohd
+ < 0) {
+
+957 
+s
+->
+nohd
+ = 0;
+
+959 
+s
+->
+us
+ = s->
+nohd
+ ? 
+BUSY_STATE
+ : 
+INIT_STATE
+;
+
+960 
+rm
+->
+adr
+ = 1;
+
+961 
+s
+->
+_ush
+ = 
+Z_NO_FLUSH
+;
+
+963 
+	`__
+(
+s
+);
+
+964 
+	`lm_
+(
+s
+);
+
+966  
+Z_OK
+;
+
+967 
+	}
+}
+
+971 
+ZEXPORT
+ 
+	$deePams
+(
+rm
+, 
+v
+, 
+gy
+)
+
+972 
+z_amp
+ 
+rm
+;
+
+973 
+v
+;
+
+974 
+gy
+;
+
+976 
+dee_e
+ *
+s
+;
+
+977 
+comess_func
+ 
+func
+;
+
+978 
+r
+ = 
+Z_OK
+;
+
+980 i(
+rm
+ =
+Z_NULL
+ || sm->
+e
+ =Z_NULL 
+Z_STREAM_ERROR
+;
+
+981 
+s
+ = (
+dee_e
+ *)
+rm
+->
+e
+;
+
+983 i(
+v
+ =
+Z_DEFAULT_COMPRESSION
+) {
+
+984 
+v
+ = 6;
+
+986 i(
+v
+ < 0 ||ev > 9 || 
+gy
+ < 0 || segy > 
+Z_HUFFMAN_ONLY
+) {
+
+987  
+Z_STREAM_ERROR
+;
+
+989 
+func
+ = 
+cfiguti_b
+[
+s
+->
+v
+].func;
+
+991 i(
+func
+ !
+cfiguti_b
+[
+v
+].fun&& 
+rm
+->
+t_
+ != 0) {
+
+993 
+r
+ = 
+	`dee
+(
+rm
+, 
+Z_PARTIAL_FLUSH
+);
+
+995 i(
+s
+->
+v
+ !=evel) {
+
+996 
+s
+->
+v
+ =evel;
+
+997 
+s
+->
+max_zy_mch
+ = 
+cfiguti_b
+[
+v
+].
+max_zy
+;
+
+998 
+s
+->
+good_mch
+ = 
+cfiguti_b
+[
+v
+].
+good_ngth
+;
+
+999 
+s
+->
+ni_mch
+ = 
+cfiguti_b
+[
+v
+].
+ni_ngth
+;
+
+1000 
+s
+->
+max_cha_ngth
+ = 
+cfiguti_b
+[
+v
+].
+max_cha
+;
+
+1002 
+s
+->
+gy
+ = strategy;
+
+1003  
+r
+;
+
+1004 
+	}
+}
+
+1012 
+lol
+ 
+	$putShtMSB
+ (
+dee_e
+ *
+s
+, 
+uI
+ 
+b
+)
+
+1014 
+	`put_by
+(
+s
+, (
+By
+)(
+b
+ >> 8));
+
+1015 
+	`put_by
+(
+s
+, (
+By
+)(
+b
+ & 0xff));
+
+1016 
+	}
+}
+
+1024 
+lol
+ 
+	$ush_ndg
+(
+z_amp
+ 
+rm
+)
+
+1026 
+dee_e
+ *
+s
+ = (dee_*
+rm
+->
+e
+;
+
+1027 
+n
+ = 
+s
+->
+ndg
+;
+
+1029 i(
+n
+ > 
+rm
+->
+ava_out
+)en = strm->avail_out;
+
+1030 i(
+n
+ == 0) ;
+
+1032 i(
+rm
+->
+xt_out
+ !
+Z_NULL
+) {
+
+1033 
+	`zmemy
+(
+rm
+->
+xt_out
+, 
+s
+->
+ndg_out
+, 
+n
+);
+
+1034 
+rm
+->
+xt_out
+ +
+n
+;
+
+1036 
+s
+->
+ndg_out
+ +
+n
+;
+
+1037 
+rm
+->
+t_out
+ +
+n
+;
+
+1038 
+rm
+->
+ava_out
+ -
+n
+;
+
+1039 
+s
+->
+ndg
+ -
+n
+;
+
+1040 i(
+s
+->
+ndg
+ == 0) {
+
+1041 
+s
+->
+ndg_out
+ = s->
+ndg_buf
+;
+
+1043 
+	}
+}
+
+1046 
+ZEXPORT
+ 
+	$dee
+ (
+z_amp
+ 
+rm
+, 
+ush
+)
+
+1048 
+d_ush
+;
+
+1049 
+dee_e
+ *
+s
+;
+
+1051 i(
+rm
+ =
+Z_NULL
+ || sm->
+e
+ == Z_NULL ||
+
+1052 
+ush
+ > 
+Z_FINISH
+ || flush < 0) {
+
+1053  
+Z_STREAM_ERROR
+;
+
+1055 
+s
+ = (
+dee_e
+ *)
+rm
+->
+e
+;
+
+1057 i((
+rm
+->
+xt_
+ =
+Z_NULL
+ && sm->
+ava_
+ != 0) ||
+
+1058 (
+s
+->
+us
+ =
+FINISH_STATE
+ && 
+ush
+ !
+Z_FINISH
+)) {
+
+1059 
+	`ERR_RETURN
+(
+rm
+, 
+Z_STREAM_ERROR
+);
+
+1061 i(
+rm
+->
+ava_out
+ =0
+	`ERR_RETURN
+(rm, 
+Z_BUF_ERROR
+);
+
+1063 
+s
+->
+rm
+ = strm;
+
+1064 
+d_ush
+ = 
+s
+->
+_ush
+;
+
+1065 
+s
+->
+_ush
+ = 
+ush
+;
+
+1068 i(
+s
+->
+us
+ =
+INIT_STATE
+) {
+
+1070 
+uI
+ 
+hd
+ = (
+Z_DEFLATED
+ + ((
+s
+->
+w_bs
+-8)<<4)) << 8;
+
+1071 
+uI
+ 
+v_ags
+ = (
+s
+->
+v
+-1) >> 1;
+
+1073 i(
+v_ags
+ > 3)evel_flags = 3;
+
+1074 
+hd
+ |(
+v_ags
+ << 6);
+
+1075 i(
+s
+->
+rt
+ !0
+hd
+ |
+PRESET_DICT
+;
+
+1076 
+hd
+ += 31 - (header % 31);
+
+1078 
+s
+->
+us
+ = 
+BUSY_STATE
+;
+
+1079 
+	`putShtMSB
+(
+s
+, 
+hd
+);
+
+1082 i(
+s
+->
+rt
+ != 0) {
+
+1083 
+	`putShtMSB
+(
+s
+, (
+uI
+)(
+rm
+->
+adr
+ >> 16));
+
+1084 
+	`putShtMSB
+(
+s
+, (
+uI
+)(
+rm
+->
+adr
+ & 0xffff));
+
+1086 
+rm
+->
+adr
+ = 1L;
+
+1090 i(
+s
+->
+ndg
+ != 0) {
+
+1091 
+	`ush_ndg
+(
+rm
+);
+
+1092 i(
+rm
+->
+ava_out
+ == 0) {
+
+1099 
+s
+->
+_ush
+ = -1;
+
+1100  
+Z_OK
+;
+
+1107 } i(
+rm
+->
+ava_
+ =0 && 
+ush
+ <
+d_ush
+ &&
+
+1108 
+ush
+ !
+Z_FINISH
+) {
+
+1109 
+	`ERR_RETURN
+(
+rm
+, 
+Z_BUF_ERROR
+);
+
+1113 i(
+s
+->
+us
+ =
+FINISH_STATE
+ && 
+rm
+->
+ava_
+ != 0) {
+
+1114 
+	`ERR_RETURN
+(
+rm
+, 
+Z_BUF_ERROR
+);
+
+1119 i(
+rm
+->
+ava_
+ !0 || 
+s
+->
+lookahd
+ != 0 ||
+
+1120 (
+ush
+ !
+Z_NO_FLUSH
+ && 
+s
+->
+us
+ !
+FINISH_STATE
+)) {
+
+1121 
+block_e
+ 
+be
+;
+
+1123 
+be
+ = (*(
+cfiguti_b
+[
+s
+->
+v
+].
+func
+))(s, 
+ush
+);
+
+1125 i(
+be
+ =
+fish_d
+ || b=
+fish_de
+) {
+
+1126 
+s
+->
+us
+ = 
+FINISH_STATE
+;
+
+1128 i(
+be
+ =
+ed_me
+ || b=
+fish_d
+) {
+
+1129 i(
+rm
+->
+ava_out
+ == 0) {
+
+1130 
+s
+->
+_ush
+ = -1;
+
+1132  
+Z_OK
+;
+
+1141 i(
+be
+ =
+block_de
+) {
+
+1142 i(
+ush
+ =
+Z_PARTIAL_FLUSH
+) {
+
+1143 
+	`__ign
+(
+s
+);
+
+1144 } i(
+ush
+ =
+Z_PACKET_FLUSH
+) {
+
+1147 
+	`__ed_ty_ly
+(
+s
+);
+
+1149 
+	`__ed_block
+(
+s
+, (*)0, 0L, 0);
+
+1153 i(
+ush
+ =
+Z_FULL_FLUSH
+) {
+
+1154 
+	`CLEAR_HASH
+(
+s
+);
+
+1157 
+	`ush_ndg
+(
+rm
+);
+
+1158 i(
+rm
+->
+ava_out
+ == 0) {
+
+1159 
+s
+->
+_ush
+ = -1;
+
+1160  
+Z_OK
+;
+
+1164 
+	`As
+(
+rm
+->
+ava_out
+ > 0, "bug2");
+
+1166 i(
+ush
+ !
+Z_FINISH
+ 
+Z_OK
+;
+
+1167 i(
+s
+->
+nohd
+ 
+Z_STREAM_END
+;
+
+1170 
+	`putShtMSB
+(
+s
+, (
+uI
+)(
+rm
+->
+adr
+ >> 16));
+
+1171 
+	`putShtMSB
+(
+s
+, (
+uI
+)(
+rm
+->
+adr
+ & 0xffff));
+
+1172 
+	`ush_ndg
+(
+rm
+);
+
+1176 
+s
+->
+nohd
+ = -1;
+
+1177  
+s
+->
+ndg
+ !0 ? 
+Z_OK
+ : 
+Z_STREAM_END
+;
+
+1178 
+	}
+}
+
+1181 
+ZEXPORT
+ 
+	$deeEnd
+ (
+z_amp
+ 
+rm
+)
+
+1183 
+us
+;
+
+1184 
+dee_e
+ *
+s
+;
+
+1186 i(
+rm
+ =
+Z_NULL
+ || sm->
+e
+ =Z_NULL 
+Z_STREAM_ERROR
+;
+
+1187 
+s
+ = (
+dee_e
+ *
+rm
+->
+e
+;
+
+1189 
+us
+ = 
+s
+->status;
+
+1190 i(
+us
+ !
+INIT_STATE
+ && stu!
+BUSY_STATE
+ &&
+
+1191 
+us
+ !
+FINISH_STATE
+) {
+
+1192  
+Z_STREAM_ERROR
+;
+
+1196 
+	`TRY_FREE
+(
+rm
+, 
+s
+->
+ndg_buf
+);
+
+1197 
+	`TRY_FREE
+(
+rm
+, 
+s
+->
+hd
+);
+
+1198 
+	`TRY_FREE
+(
+rm
+, 
+s
+->
+ev
+);
+
+1199 
+	`TRY_FREE
+(
+rm
+, 
+s
+->
+wdow
+);
+
+1201 
+	`ZFREE
+(
+rm
+, 
+s
+);
+
+1202 
+rm
+->
+e
+ = 
+Z_NULL
+;
+
+1204  
+us
+ =
+BUSY_STATE
+ ? 
+Z_DATA_ERROR
+ : 
+Z_OK
+;
+
+1205 
+	}
+}
+
+1213 
+ZEXPORT
+ 
+	$deeCy
+ (
+z_amp
+ 
+de
+, z_am
+sour
+)
+
+1215 #ifde
+MAXSEG_64K
+
+
+1216  
+Z_STREAM_ERROR
+;
+
+1218 
+dee_e
+ *
+ds
+;
+
+1219 
+dee_e
+ *
+ss
+;
+
+1220 
+ushf
+ *
+ovy
+;
+
+1223 i(
+sour
+ =
+Z_NULL
+ || 
+de
+ =Z_NULL || sour->
+e
+ == Z_NULL) {
+
+1224  
+Z_STREAM_ERROR
+;
+
+1227 
+ss
+ = (
+dee_e
+ *)
+sour
+->
+e
+;
+
+1229 *
+de
+ = *
+sour
+;
+
+1231 
+ds
+ = (
+dee_e
+ *
+	`ZALLOC
+(
+de
+, 1, (deflate_state));
+
+1232 i(
+ds
+ =
+Z_NULL
+ 
+Z_MEM_ERROR
+;
+
+1233 
+de
+->
+e
+ = (*
+ds
+;
+
+1234 *
+ds
+ = *
+ss
+;
+
+1235 
+ds
+->
+rm
+ = 
+de
+;
+
+1237 
+ds
+->
+wdow
+ = (
+Byf
+ *
+	`ZALLOC
+(
+de
+, ds->
+w_size
+, 2*(
+By
+));
+
+1238 
+ds
+->
+ev
+ = (
+Posf
+ *
+	`ZALLOC
+(
+de
+, ds->
+w_size
+, (
+Pos
+));
+
+1239 
+ds
+->
+hd
+ = (
+Posf
+ *
+	`ZALLOC
+(
+de
+, ds->
+hash_size
+, (
+Pos
+));
+
+1240 
+ovy
+ = (
+ushf
+ *
+	`ZALLOC
+(
+de
+, 
+ds
+->
+l_bufsize
+, (
+ush
+)+2);
+
+1241 
+ds
+->
+ndg_buf
+ = (
+uchf
+ *
+ovy
+;
+
+1243 i(
+ds
+->
+wdow
+ =
+Z_NULL
+ || ds->
+ev
+ =Z_NULL || ds->
+hd
+ == Z_NULL ||
+
+1244 
+ds
+->
+ndg_buf
+ =
+Z_NULL
+) {
+
+1245 
+ds
+->
+us
+ = 
+INIT_STATE
+;
+
+1246 
+	`deeEnd
+ (
+de
+);
+
+1247  
+Z_MEM_ERROR
+;
+
+1250 
+	`zmemy
+(
+ds
+->
+wdow
+, 
+ss
+->wdow, ds->
+w_size
+ * 2 * (
+By
+));
+
+1251 
+	`zmemy
+(
+ds
+->
+ev
+, 
+ss
+->ev, ds->
+w_size
+ * (
+Pos
+));
+
+1252 
+	`zmemy
+(
+ds
+->
+hd
+, 
+ss
+->hd, ds->
+hash_size
+ * (
+Pos
+));
+
+1253 
+	`zmemy
+(
+ds
+->
+ndg_buf
+, 
+ss
+->ndg_buf, (
+uI
+)ds->
+ndg_buf_size
+);
+
+1255 
+ds
+->
+ndg_out
+ = ds->
+ndg_buf
+ + (
+ss
+->pending_out - ss->pending_buf);
+
+1256 
+ds
+->
+d_buf
+ = 
+ovy
+ + ds->
+l_bufsize
+/(
+ush
+);
+
+1257 
+ds
+->
+l_buf
+ = ds->
+ndg_buf
+ + (1+(
+ush
+))*ds->
+l_bufsize
+;
+
+1259 
+ds
+->
+l_desc
+.
+dyn_
+ = ds->
+dyn_e
+;
+
+1260 
+ds
+->
+d_desc
+.
+dyn_
+ = ds->
+dyn_d
+;
+
+1261 
+ds
+->
+bl_desc
+.
+dyn_
+ = ds->
+bl_
+;
+
+1263  
+Z_OK
+;
+
+1265 
+	}
+}
+
+1273 
+	$deeOuutPdg
+ (
+z_amp
+ 
+rm
+)
+
+1275 i(
+rm
+ =
+Z_NULL
+ || sm->
+e
+ == Z_NULL)  0;
+
+1277  ((
+dee_e
+ *)(
+rm
+->
+e
+))->
+ndg
+;
+
+1278 
+	}
+}
+
+1288 
+lol
+ 
+	$ad_buf
+(
+z_amp
+ 
+rm
+,
+
+1289 
+Byf
+ *
+buf
+,
+
+1290 
+size
+)
+
+1292 
+n
+ = 
+rm
+->
+ava_
+;
+
+1294 i(
+n
+ > 
+size
+)en = size;
+
+1295 i(
+n
+ == 0)  0;
+
+1297 
+rm
+->
+ava_
+ -
+n
+;
+
+1299 i(!((
+dee_e
+ *)(
+rm
+->
+e
+))->
+nohd
+) {
+
+1300 
+rm
+->
+adr
+ = 
+	`adr32
+(rm->adr, sm->
+xt_
+, 
+n
+);
+
+1302 
+	`zmemy
+(
+buf
+, 
+rm
+->
+xt_
+, 
+n
+);
+
+1303 
+rm
+->
+xt_
+ +
+n
+;
+
+1304 
+rm
+->
+t_
+ +
+n
+;
+
+1306  ()
+n
+;
+
+1307 
+	}
+}
+
+1312 
+lol
+ 
+	$lm_
+ (
+dee_e
+ *
+s
+)
+
+1314 
+s
+->
+wdow_size
+ = (
+ulg
+)2L*s->
+w_size
+;
+
+1316 
+	`CLEAR_HASH
+(
+s
+);
+
+1320 
+s
+->
+max_zy_mch
+ = 
+cfiguti_b
+[s->
+v
+].
+max_zy
+;
+
+1321 
+s
+->
+good_mch
+ = 
+cfiguti_b
+[s->
+v
+].
+good_ngth
+;
+
+1322 
+s
+->
+ni_mch
+ = 
+cfiguti_b
+[s->
+v
+].
+ni_ngth
+;
+
+1323 
+s
+->
+max_cha_ngth
+ = 
+cfiguti_b
+[s->
+v
+].
+max_cha
+;
+
+1325 
+s
+->
+rt
+ = 0;
+
+1326 
+s
+->
+block_t
+ = 0L;
+
+1327 
+s
+->
+lookahd
+ = 0;
+
+1328 
+s
+->
+mch_ngth
+ = s->
+ev_ngth
+ = 
+MIN_MATCH
+-1;
+
+1329 
+s
+->
+mch_avaab
+ = 0;
+
+1330 
+s
+->
+s_h
+ = 0;
+
+1331 #ifde
+ASMV
+
+
+1332 
+	`mch_
+();
+
+1334 
+	}
+}
+
+1345 #ide
+ASMV
+
+
+1349 #ide
+FASTEST
+
+
+1350 
+lol
+ 
+uI
+ 
+	$lge_mch
+(
+dee_e
+ *
+s
+,
+
+1351 
+IPos
+ 
+cur_mch
+)
+
+1353 
+cha_ngth
+ = 
+s
+->
+max_cha_ngth
+;
+
+1354 
+Byf
+ *
+sn
+ = 
+s
+->
+wdow
+ + s->
+rt
+;
+
+1355 
+Byf
+ *
+mch
+;
+
+1356 
+n
+;
+
+1357 
+be_n
+ = 
+s
+->
+ev_ngth
+;
+
+1358 
+ni_mch
+ = 
+s
+->nice_match;
+
+1359 
+IPos
+ 
+lim
+ = 
+s
+->
+rt
+ > (IPos)
+	`MAX_DIST
+(s) ?
+
+1360 
+s
+->
+rt
+ - (
+IPos
+)
+	`MAX_DIST
+(s: 
+NIL
+;
+
+1364 
+Posf
+ *
+ev
+ = 
+s
+->prev;
+
+1365 
+uI
+ 
+wmask
+ = 
+s
+->
+w_mask
+;
+
+1367 #ifde
+UNALIGNED_OK
+
+
+1371 
+Byf
+ *
+nd
+ = 
+s
+->
+wdow
+ + s->
+rt
+ + 
+MAX_MATCH
+ - 1;
+
+1372 
+ush
+ 
+sn_t
+ = *(
+ushf
+*)
+sn
+;
+
+1373 
+ush
+ 
+sn_d
+ = *(
+ushf
+*)(
+sn
++
+be_n
+-1);
+
+1375 
+Byf
+ *
+nd
+ = 
+s
+->
+wdow
+ + s->
+rt
+ + 
+MAX_MATCH
+;
+
+1376 
+By
+ 
+sn_d1
+ = 
+sn
+[
+be_n
+-1];
+
+1377 
+By
+ 
+sn_d
+ = 
+sn
+[
+be_n
+];
+
+1383 
+	`As
+(
+s
+->
+hash_bs
+ >8 && 
+MAX_MATCH
+ == 258, "Codeoo clever");
+
+1386 i(
+s
+->
+ev_ngth
+ >s->
+good_mch
+) {
+
+1387 
+cha_ngth
+ >>= 2;
+
+1392 i((
+uI
+)
+ni_mch
+ > 
+s
+->
+lookahd
+)ice_match = s->lookahead;
+
+1394 
+	`As
+((
+ulg
+)
+s
+->
+rt
+ <s->
+wdow_size
+-
+MIN_LOOKAHEAD
+, "needookahead");
+
+1397 
+	`As
+(
+cur_mch
+ < 
+s
+->
+rt
+, "no future");
+
+1398 
+mch
+ = 
+s
+->
+wdow
+ + 
+cur_mch
+;
+
+1403 #i(
+	`defed
+(
+UNALIGNED_OK
+&& 
+MAX_MATCH
+ == 258)
+
+1407 i(*(
+ushf
+*)(
+mch
++
+be_n
+-1!
+sn_d
+ ||
+
+1408 *(
+ushf
+*)
+mch
+ !
+sn_t
+) ;
+
+1419 
+	`As
+(
+sn
+[2] =
+mch
+[2], "scan[2]?");
+
+1420 
+sn
+++, 
+mch
+++;
+
+1422 } *(
+ushf
+*)(
+sn
++=2=*(ushf*)(
+mch
++=2) &&
+
+1423 *(
+ushf
+*)(
+sn
++=2=*(ushf*)(
+mch
++=2) &&
+
+1424 *(
+ushf
+*)(
+sn
++=2=*(ushf*)(
+mch
++=2) &&
+
+1425 *(
+ushf
+*)(
+sn
++=2=*(ushf*)(
+mch
++=2) &&
+
+1426 
+sn
+ < 
+nd
+);
+
+1430 
+	`As
+(
+sn
+ <
+s
+->
+wdow
++()(s->
+wdow_size
+-1), "wild scan");
+
+1431 i(*
+sn
+ =*
+mch
+) scan++;
+
+1433 
+n
+ = (
+MAX_MATCH
+ - 1- ()(
+nd
+-
+sn
+);
+
+1434 
+sn
+ = 
+nd
+ - (
+MAX_MATCH
+-1);
+
+1438 i(
+mch
+[
+be_n
+] !
+sn_d
+ ||
+
+1439 
+mch
+[
+be_n
+-1] !
+sn_d1
+ ||
+
+1440 *
+mch
+ !*
+sn
+ ||
+
+1441 *++
+mch
+ !
+sn
+[1]) ;
+
+1449 
+sn
+ +2, 
+mch
+++;
+
+1450 
+	`As
+(*
+sn
+ =*
+mch
+, "match[2]?");
+
+1456 } *++
+sn
+ =*++
+mch
+ && *++scan == *++match &&
+
+1457 *++
+sn
+ =*++
+mch
+ && *++scan == *++match &&
+
+1458 *++
+sn
+ =*++
+mch
+ && *++scan == *++match &&
+
+1459 *++
+sn
+ =*++
+mch
+ && *++scan == *++match &&
+
+1460 
+sn
+ < 
+nd
+);
+
+1462 
+	`As
+(
+sn
+ <
+s
+->
+wdow
++()(s->
+wdow_size
+-1), "wild scan");
+
+1464 
+n
+ = 
+MAX_MATCH
+ - ()(
+nd
+ - 
+sn
+);
+
+1465 
+sn
+ = 
+nd
+ - 
+MAX_MATCH
+;
+
+1469 i(
+n
+ > 
+be_n
+) {
+
+1470 
+s
+->
+mch_t
+ = 
+cur_mch
+;
+
+1471 
+be_n
+ = 
+n
+;
+
+1472 i(
+n
+ >
+ni_mch
+) ;
+
+1473 #ifde
+UNALIGNED_OK
+
+
+1474 
+sn_d
+ = *(
+ushf
+*)(
+sn
++
+be_n
+-1);
+
+1476 
+sn_d1
+ = 
+sn
+[
+be_n
+-1];
+
+1477 
+sn_d
+ = 
+sn
+[
+be_n
+];
+
+1480 } (
+cur_mch
+ = 
+ev
+[cur_mch & 
+wmask
+]> 
+lim
+
+
+1481 && --
+cha_ngth
+ != 0);
+
+1483 i((
+uI
+)
+be_n
+ <
+s
+->
+lookahd
+)  (uInt)best_len;
+
+1484  
+s
+->
+lookahd
+;
+
+1485 
+	}
+}
+
+1491 
+lol
+ 
+uI
+ 
+	$lge_mch
+(
+s
+, 
+cur_mch
+)
+
+1492 
+dee_e
+ *
+s
+;
+
+1493 
+IPos
+ 
+cur_mch
+;
+
+1495 
+Byf
+ *
+sn
+ = 
+s
+->
+wdow
+ + s->
+rt
+;
+
+1496 
+Byf
+ *
+mch
+;
+
+1497 
+n
+;
+
+1498 
+Byf
+ *
+nd
+ = 
+s
+->
+wdow
+ + s->
+rt
+ + 
+MAX_MATCH
+;
+
+1503 
+	`As
+(
+s
+->
+hash_bs
+ >8 && 
+MAX_MATCH
+ == 258, "Codeoo clever");
+
+1505 
+	`As
+((
+ulg
+)
+s
+->
+rt
+ <s->
+wdow_size
+-
+MIN_LOOKAHEAD
+, "needookahead");
+
+1507 
+	`As
+(
+cur_mch
+ < 
+s
+->
+rt
+, "no future");
+
+1509 
+mch
+ = 
+s
+->
+wdow
+ + 
+cur_mch
+;
+
+1513 i(
+mch
+[0] !
+sn
+[0] || mch[1] !sn[1] 
+MIN_MATCH
+-1;
+
+1521 
+sn
+ +2, 
+mch
+ += 2;
+
+1522 
+	`As
+(*
+sn
+ =*
+mch
+, "match[2]?");
+
+1528 } *++
+sn
+ =*++
+mch
+ && *++scan == *++match &&
+
+1529 *++
+sn
+ =*++
+mch
+ && *++scan == *++match &&
+
+1530 *++
+sn
+ =*++
+mch
+ && *++scan == *++match &&
+
+1531 *++
+sn
+ =*++
+mch
+ && *++scan == *++match &&
+
+1532 
+sn
+ < 
+nd
+);
+
+1534 
+	`As
+(
+sn
+ <
+s
+->
+wdow
++()(s->
+wdow_size
+-1), "wild scan");
+
+1536 
+n
+ = 
+MAX_MATCH
+ - ()(
+nd
+ - 
+sn
+);
+
+1538 i(
+n
+ < 
+MIN_MATCH
+)  MIN_MATCH - 1;
+
+1540 
+s
+->
+mch_t
+ = 
+cur_mch
+;
+
+1541  
+n
+ <
+s
+->
+lookahd
+ ?en : s->lookahead;
+
+1542 
+	}
+}
+
+1546 #ifde
+DEBUG_ZLIB
+
+
+1550 
+lol
+ 
+	$check_mch
+(
+s
+, 
+t
+, 
+mch
+, 
+ngth
+)
+
+1551 
+dee_e
+ *
+s
+;
+
+1552 
+IPos
+ 
+t
+, 
+mch
+;
+
+1553 
+ngth
+;
+
+1556 i(
+	`zmemcmp
+(
+s
+->
+wdow
+ + 
+mch
+,
+
+1557 
+s
+->
+wdow
+ + 
+t
+, 
+ngth
+!
+EQUAL
+) {
+
+1558 
+	`rtf
+(
+dr
+, " start %u, match %u,ength %d\n",
+
+1559 
+t
+, 
+mch
+, 
+ngth
+);
+
+1561 
+	`rtf
+(
+dr
+, "%c%c", 
+s
+->
+wdow
+[
+mch
+++], s->wdow[
+t
+++]);
+
+1562 } --
+ngth
+ != 0);
+
+1563 
+	`z_r
+("invalid match");
+
+1565 i(
+z_vbo
+ > 1) {
+
+1566 
+	`rtf
+(
+dr
+,"\\[%d,%d]", 
+t
+-
+mch
+, 
+ngth
+);
+
+1567 d{ 
+	`putc
+(
+s
+->
+wdow
+[
+t
+++], 
+dr
+); } --
+ngth
+ != 0);
+
+1569 
+	}
+}
+
+1571 
+	#check_mch
+(
+s
+, 
+t
+, 
+mch
+, 
+ngth
+)
+
+	)
+
+1584 
+lol
+ 
+	$fl_wdow
+(
+dee_e
+ *
+s
+)
+
+1586 
+n
+, 
+m
+;
+
+1587 
+Posf
+ *
+p
+;
+
+1588 
+me
+;
+
+1589 
+uI
+ 
+wsize
+ = 
+s
+->
+w_size
+;
+
+1592 
+me
+ = ()(
+s
+->
+wdow_size
+ -(
+ulg
+)s->
+lookahd
+ -(ulg)s->
+rt
+);
+
+1595 i(
+me
+ =0 && 
+s
+->
+rt
+ =0 && s->
+lookahd
+ == 0) {
+
+1596 
+me
+ = 
+wsize
+;
+
+1598 } i(
+me
+ == ()(-1)) {
+
+1602 
+me
+--;
+
+1607 } i(
+s
+->
+rt
+ >
+wsize
++
+	`MAX_DIST
+(s)) {
+
+1609 
+	`zmemy
+(
+s
+->
+wdow
+, s->wdow+
+wsize
+, ()wsize);
+
+1610 
+s
+->
+mch_t
+ -
+wsize
+;
+
+1611 
+s
+->
+rt
+ -
+wsize
+;
+
+1612 
+s
+->
+block_t
+ -(
+wsize
+;
+
+1620 
+n
+ = 
+s
+->
+hash_size
+;
+
+1621 
+p
+ = &
+s
+->
+hd
+[
+n
+];
+
+1623 
+m
+ = *--
+p
+;
+
+1624 *
+p
+ = (
+Pos
+)(
+m
+ >
+wsize
+ ? m-wsiz: 
+NIL
+);
+
+1625 } --
+n
+);
+
+1627 
+n
+ = 
+wsize
+;
+
+1628 #ide
+FASTEST
+
+
+1629 
+p
+ = &
+s
+->
+ev
+[
+n
+];
+
+1631 
+m
+ = *--
+p
+;
+
+1632 *
+p
+ = (
+Pos
+)(
+m
+ >
+wsize
+ ? m-wsiz: 
+NIL
+);
+
+1636 } --
+n
+);
+
+1638 
+me
+ +
+wsize
+;
+
+1640 i(
+s
+->
+rm
+->
+ava_
+ == 0) ;
+
+1653 
+	`As
+(
+me
+ >= 2, "more < 2");
+
+1655 
+n
+ = 
+	`ad_buf
+(
+s
+->
+rm
+, s->
+wdow
+ + s->
+rt
+ + s->
+lookahd
+, 
+me
+);
+
+1656 
+s
+->
+lookahd
+ +
+n
+;
+
+1659 i(
+s
+->
+lookahd
+ >
+MIN_MATCH
+) {
+
+1660 
+s
+->
+s_h
+ = s->
+wdow
+[s->
+rt
+];
+
+1661 
+	`UPDATE_HASH
+(
+s
+, s->
+s_h
+, s->
+wdow
+[s->
+rt
++1]);
+
+1662 #i
+MIN_MATCH
+ != 3
+
+1663 
+Cl
+ 
+	`UPDATE_HASH
+(
+MIN_MATCH
+-3 
+me
+ 
+times
+
+
+1670 } 
+s
+->
+lookahd
+ < 
+MIN_LOOKAHEAD
+ && s->
+rm
+->
+ava_
+ != 0);
+
+1671 
+	}
+}
+
+1677 
+	#FLUSH_BLOCK_ONLY
+(
+s
+, 
+eof
+) { \
+
+1678 
+	`__ush_block
+(
+s
+, (s->
+block_t
+ >= 0L ? \
+
+1679 (
+chf
+ *)&
+s
+->
+wdow
+[()s->
+block_t
+] : \
+
+1680 (
+chf
+ *)
+Z_NULL
+), \
+
+1681 (
+ulg
+)(()
+s
+->
+rt
+ - s->
+block_t
+), \
+
+1682 (
+eof
+)); \
+
+1683 
+s
+->
+block_t
+ = s->
+rt
+; \
+
+1684 
+	`ush_ndg
+(
+s
+->
+rm
+); \
+
+1685 
+	`Tv
+((
+dr
+,"[FLUSH]")); \
+
+1686 }
+
+	)
+
+1689 
+	#FLUSH_BLOCK
+(
+s
+, 
+eof
+) { \
+
+1690 
+	`FLUSH_BLOCK_ONLY
+(
+s
+, 
+eof
+); \
+
+1691 i(
+s
+->
+rm
+->
+ava_out
+ =0 (
+eof
+? 
+fish_d
+ : 
+ed_me
+; \
+
+1692 }
+
+	)
+
+1703 
+lol
+ 
+block_e
+ 
+	$dee_ed
+(
+dee_e
+ *
+s
+, 
+ush
+)
+
+1708 
+ulg
+ 
+max_block_size
+ = 0xffff;
+
+1709 
+ulg
+ 
+max_t
+;
+
+1711 i(
+max_block_size
+ > 
+s
+->
+ndg_buf_size
+ - 5) {
+
+1712 
+max_block_size
+ = 
+s
+->
+ndg_buf_size
+ - 5;
+
+1718 i(
+s
+->
+lookahd
+ <= 1) {
+
+1720 
+	`As
+(
+s
+->
+rt
+ < s->
+w_size
++
+	`MAX_DIST
+(s) ||
+
+1721 
+s
+->
+block_t
+ >()s->
+w_size
+, "slideooate");
+
+1723 
+	`fl_wdow
+(
+s
+);
+
+1724 i(
+s
+->
+lookahd
+ =0 && 
+ush
+ =
+Z_NO_FLUSH
+ 
+ed_me
+;
+
+1726 i(
+s
+->
+lookahd
+ == 0) ;
+
+1728 
+	`As
+(
+s
+->
+block_t
+ >= 0L, "block gone");
+
+1730 
+s
+->
+rt
+ +s->
+lookahd
+;
+
+1731 
+s
+->
+lookahd
+ = 0;
+
+1734 
+max_t
+ = 
+s
+->
+block_t
+ + 
+max_block_size
+;
+
+1735 i(
+s
+->
+rt
+ =0 || (
+ulg
+)s->r>
+max_t
+) {
+
+1737 
+s
+->
+lookahd
+ = (
+uI
+)(s->
+rt
+ - 
+max_t
+);
+
+1738 
+s
+->
+rt
+ = (
+uI
+)
+max_t
+;
+
+1739 
+	`FLUSH_BLOCK
+(
+s
+, 0);
+
+1744 i(
+s
+->
+rt
+ - (
+uI
+)s->
+block_t
+ >
+	`MAX_DIST
+(s)) {
+
+1745 
+	`FLUSH_BLOCK
+(
+s
+, 0);
+
+1748 
+	`FLUSH_BLOCK
+(
+s
+, 
+ush
+ =
+Z_FINISH
+);
+
+1749  
+ush
+ =
+Z_FINISH
+ ? 
+fish_de
+ : 
+block_de
+;
+
+1750 
+	}
+}
+
+1759 
+lol
+ 
+block_e
+ 
+	$dee_
+(
+dee_e
+ *
+s
+, 
+ush
+)
+
+1761 
+IPos
+ 
+hash_hd
+ = 
+NIL
+;
+
+1762 
+bush
+;
+
+1770 i(
+s
+->
+lookahd
+ < 
+MIN_LOOKAHEAD
+) {
+
+1771 
+	`fl_wdow
+(
+s
+);
+
+1772 i(
+s
+->
+lookahd
+ < 
+MIN_LOOKAHEAD
+ && 
+ush
+ =
+Z_NO_FLUSH
+) {
+
+1773  
+ed_me
+;
+
+1775 i(
+s
+->
+lookahd
+ == 0) ;
+
+1781 i(
+s
+->
+lookahd
+ >
+MIN_MATCH
+) {
+
+1782 
+	`INSERT_STRING
+(
+s
+, s->
+rt
+, 
+hash_hd
+);
+
+1788 i(
+hash_hd
+ !
+NIL
+ && 
+s
+->
+rt
+ - hash_hd <
+	`MAX_DIST
+(s)) {
+
+1793 i(
+s
+->
+gy
+ !
+Z_HUFFMAN_ONLY
+) {
+
+1794 
+s
+->
+mch_ngth
+ = 
+	`lge_mch
+ (s, 
+hash_hd
+);
+
+1798 i(
+s
+->
+mch_ngth
+ >
+MIN_MATCH
+) {
+
+1799 
+	`check_mch
+(
+s
+, s->
+rt
+, s->
+mch_t
+, s->
+mch_ngth
+);
+
+1801 
+	`__y_di
+(
+s
+, s->
+rt
+ - s->
+mch_t
+,
+
+1802 
+s
+->
+mch_ngth
+ - 
+MIN_MATCH
+, 
+bush
+);
+
+1804 
+s
+->
+lookahd
+ -s->
+mch_ngth
+;
+
+1809 #ide
+FASTEST
+
+
+1810 i(
+s
+->
+mch_ngth
+ <s->
+max__ngth
+ &&
+
+1811 
+s
+->
+lookahd
+ >
+MIN_MATCH
+) {
+
+1812 
+s
+->
+mch_ngth
+--;
+
+1814 
+s
+->
+rt
+++;
+
+1815 
+	`INSERT_STRING
+(
+s
+, s->
+rt
+, 
+hash_hd
+);
+
+1819 } --
+s
+->
+mch_ngth
+ != 0);
+
+1820 
+s
+->
+rt
+++;
+
+1824 
+s
+->
+rt
+ +s->
+mch_ngth
+;
+
+1825 
+s
+->
+mch_ngth
+ = 0;
+
+1826 
+s
+->
+s_h
+ = s->
+wdow
+[s->
+rt
+];
+
+1827 
+	`UPDATE_HASH
+(
+s
+, s->
+s_h
+, s->
+wdow
+[s->
+rt
++1]);
+
+1828 #i
+MIN_MATCH
+ != 3
+
+1829 
+Cl
+ 
+	`UPDATE_HASH
+(
+MIN_MATCH
+-3 
+me
+ 
+times
+
+
+1837 
+	`Tvv
+((
+dr
+,"%c", 
+s
+->
+wdow
+[s->
+rt
+]));
+
+1838 
+	`__y_l
+ (
+s
+, s->
+wdow
+[s->
+rt
+], 
+bush
+);
+
+1839 
+s
+->
+lookahd
+--;
+
+1840 
+s
+->
+rt
+++;
+
+1842 i(
+bush
+
+	`FLUSH_BLOCK
+(
+s
+, 0);
+
+1844 
+	`FLUSH_BLOCK
+(
+s
+, 
+ush
+ =
+Z_FINISH
+);
+
+1845  
+ush
+ =
+Z_FINISH
+ ? 
+fish_de
+ : 
+block_de
+;
+
+1846 
+	}
+}
+
+1853 
+lol
+ 
+block_e
+ 
+	$dee_ow
+(
+dee_e
+ *
+s
+, 
+ush
+)
+
+1855 
+IPos
+ 
+hash_hd
+ = 
+NIL
+;
+
+1856 
+bush
+;
+
+1865 i(
+s
+->
+lookahd
+ < 
+MIN_LOOKAHEAD
+) {
+
+1866 
+	`fl_wdow
+(
+s
+);
+
+1867 i(
+s
+->
+lookahd
+ < 
+MIN_LOOKAHEAD
+ && 
+ush
+ =
+Z_NO_FLUSH
+) {
+
+1868  
+ed_me
+;
+
+1870 i(
+s
+->
+lookahd
+ == 0) ;
+
+1876 i(
+s
+->
+lookahd
+ >
+MIN_MATCH
+) {
+
+1877 
+	`INSERT_STRING
+(
+s
+, s->
+rt
+, 
+hash_hd
+);
+
+1882 
+s
+->
+ev_ngth
+ = s->
+mch_ngth
+, s->
+ev_mch
+ = s->
+mch_t
+;
+
+1883 
+s
+->
+mch_ngth
+ = 
+MIN_MATCH
+-1;
+
+1885 i(
+hash_hd
+ !
+NIL
+ && 
+s
+->
+ev_ngth
+ < s->
+max_zy_mch
+ &&
+
+1886 
+s
+->
+rt
+ - 
+hash_hd
+ <
+	`MAX_DIST
+(s)) {
+
+1891 i(
+s
+->
+gy
+ !
+Z_HUFFMAN_ONLY
+) {
+
+1892 
+s
+->
+mch_ngth
+ = 
+	`lge_mch
+ (s, 
+hash_hd
+);
+
+1896 i(
+s
+->
+mch_ngth
+ <5 && (s->
+gy
+ =
+Z_FILTERED
+ ||
+
+1897 (
+s
+->
+mch_ngth
+ =
+MIN_MATCH
+ &&
+
+1898 
+s
+->
+rt
+ - s->
+mch_t
+ > 
+TOO_FAR
+))) {
+
+1903 
+s
+->
+mch_ngth
+ = 
+MIN_MATCH
+-1;
+
+1909 i(
+s
+->
+ev_ngth
+ >
+MIN_MATCH
+ && s->
+mch_ngth
+ <= s->prev_length) {
+
+1910 
+uI
+ 
+max_
+ = 
+s
+->
+rt
+ + s->
+lookahd
+ - 
+MIN_MATCH
+;
+
+1913 
+	`check_mch
+(
+s
+, s->
+rt
+-1, s->
+ev_mch
+, s->
+ev_ngth
+);
+
+1915 
+	`__y_di
+(
+s
+, s->
+rt
+ -1 - s->
+ev_mch
+,
+
+1916 
+s
+->
+ev_ngth
+ - 
+MIN_MATCH
+, 
+bush
+);
+
+1923 
+s
+->
+lookahd
+ -s->
+ev_ngth
+-1;
+
+1924 
+s
+->
+ev_ngth
+ -= 2;
+
+1926 i(++
+s
+->
+rt
+ <
+max_
+) {
+
+1927 
+	`INSERT_STRING
+(
+s
+, s->
+rt
+, 
+hash_hd
+);
+
+1929 } --
+s
+->
+ev_ngth
+ != 0);
+
+1930 
+s
+->
+mch_avaab
+ = 0;
+
+1931 
+s
+->
+mch_ngth
+ = 
+MIN_MATCH
+-1;
+
+1932 
+s
+->
+rt
+++;
+
+1934 i(
+bush
+
+	`FLUSH_BLOCK
+(
+s
+, 0);
+
+1936 } i(
+s
+->
+mch_avaab
+) {
+
+1941 
+	`Tvv
+((
+dr
+,"%c", 
+s
+->
+wdow
+[s->
+rt
+-1]));
+
+1942 
+	`__y_l
+(
+s
+, s->
+wdow
+[s->
+rt
+-1], 
+bush
+);
+
+1943 i(
+bush
+) {
+
+1944 
+	`FLUSH_BLOCK_ONLY
+(
+s
+, 0);
+
+1946 
+s
+->
+rt
+++;
+
+1947 
+s
+->
+lookahd
+--;
+
+1948 i(
+s
+->
+rm
+->
+ava_out
+ =0 
+ed_me
+;
+
+1953 
+s
+->
+mch_avaab
+ = 1;
+
+1954 
+s
+->
+rt
+++;
+
+1955 
+s
+->
+lookahd
+--;
+
+1958 
+	`As
+ (
+ush
+ !
+Z_NO_FLUSH
+, "no flush?");
+
+1959 i(
+s
+->
+mch_avaab
+) {
+
+1960 
+	`Tvv
+((
+dr
+,"%c", 
+s
+->
+wdow
+[s->
+rt
+-1]));
+
+1961 
+	`__y_l
+(
+s
+, s->
+wdow
+[s->
+rt
+-1], 
+bush
+);
+
+1962 
+s
+->
+mch_avaab
+ = 0;
+
+1964 
+	`FLUSH_BLOCK
+(
+s
+, 
+ush
+ =
+Z_FINISH
+);
+
+1965  
+ush
+ =
+Z_FINISH
+ ? 
+fish_de
+ : 
+block_de
+;
+
+1966 
+	}
+}
+
+2008 #ifde
+DEBUG_ZLIB
+
+
+2009 
+	~<y.h
+>
+
+2016 
+	#MAX_BL_BITS
+ 7
+
+	)
+
+2019 
+	#END_BLOCK
+ 256
+
+	)
+
+2022 
+	#REP_3_6
+ 16
+
+	)
+
+2025 
+	#REPZ_3_10
+ 17
+
+	)
+
+2028 
+	#REPZ_11_138
+ 18
+
+	)
+
+2031 
+lol
+ c 
+	gexa_lbs
+[
+LENGTH_CODES
+]
+
+2034 
+lol
+ c 
+	gexa_dbs
+[
+D_CODES
+]
+
+2037 
+lol
+ c 
+	gexa_blbs
+[
+BL_CODES
+]
+
+2040 
+lol
+ c 
+uch
+ 
+	gbl_d
+[
+BL_CODES
+]
+
+2046 
+	#Buf_size
+ (8 * 2*())
+
+	)
+
+2055 
+	#DIST_CODE_LEN
+ 512
+
+	)
+
+2057 #i
+defed
+(
+GEN_TREES_H
+|| !defed(
+STDC
+)
+
+2060 
+lol
+ 
+_da
+ 
+	gic_e
+[
+L_CODES
++2];
+
+2067 
+lol
+ 
+_da
+ 
+	gic_d
+[
+D_CODES
+];
+
+2072 
+uch
+ 
+	g_di_code
+[
+DIST_CODE_LEN
+];
+
+2078 
+uch
+ 
+	g_ngth_code
+[
+MAX_MATCH
+-
+MIN_MATCH
++1];
+
+2081 
+lol
+ 
+	gba_ngth
+[
+LENGTH_CODES
+];
+
+2084 
+lol
+ 
+	gba_di
+[
+D_CODES
+];
+
+2092 
+lol
+ c 
+_da
+ 
+	gic_e
+[
+L_CODES
++2] = {
+
+2153 
+lol
+ c 
+_da
+ 
+	gic_d
+[
+D_CODES
+] = {
+
+2162 c 
+uch
+ 
+	g_di_code
+[
+DIST_CODE_LEN
+] = {
+
+2191 c 
+uch
+ 
+	g_ngth_code
+[
+MAX_MATCH
+-
+MIN_MATCH
++1]= {
+
+2207 
+lol
+ c 
+	gba_ngth
+[
+LENGTH_CODES
+] = {
+
+2212 
+lol
+ c 
+	gba_di
+[
+D_CODES
+] = {
+
+2221 
+	sic__desc_s
+ {
+
+2222 c 
+_da
+ *
+	mic_
+;
+
+2223 c 
+tf
+ *
+	mexa_bs
+;
+
+2224 
+	mexa_ba
+;
+
+2225 
+	mems
+;
+
+2226 
+	mmax_ngth
+;
+
+2229 
+lol
+ 
+ic__desc
+ 
+	gic_l_desc
+ =
+
+2230 {
+ic_e
+, 
+exa_lbs
+, 
+LITERALS
++1, 
+L_CODES
+, 
+MAX_BITS
+};
+
+2232 
+lol
+ 
+ic__desc
+ 
+	gic_d_desc
+ =
+
+2233 {
+ic_d
+, 
+exa_dbs
+, 0, 
+D_CODES
+, 
+MAX_BITS
+};
+
+2235 
+lol
+ 
+ic__desc
+ 
+	gic_bl_desc
+ =
+
+2236 {(c 
+_da
+ *)0, 
+exa_blbs
+, 0, 
+BL_CODES
+, 
+MAX_BL_BITS
+};
+
+2242 
+lol
+ 
+_ic_
+();
+
+2243 
+lol
+ 
+_block
+(
+dee_e
+ *
+s
+);
+
+2244 
+lol
+ 
+pqdownhp
+(
+dee_e
+ *
+s
+, 
+_da
+ *
+
+, 
+k
+);
+
+2245 
+lol
+ 
+g_bn
+(
+dee_e
+ *
+s
+, 
+_desc
+ *
+desc
+);
+
+2246 
+lol
+ 
+g_codes
+(
+_da
+ *
+
+, 
+max_code
+, 
+ushf
+ *
+bl_cou
+);
+
+2247 
+lol
+ 
+bud_
+(
+dee_e
+ *
+s
+, 
+_desc
+ *
+desc
+);
+
+2248 
+lol
+ 
+sn_
+(
+dee_e
+ *
+s
+, 
+_da
+ *
+
+, 
+max_code
+);
+
+2249 
+lol
+ 
+nd_
+(
+dee_e
+ *
+s
+, 
+_da
+ *
+
+, 
+max_code
+);
+
+2250 
+lol
+ 
+bud_bl_
+(
+dee_e
+ *
+s
+);
+
+2251 
+lol
+ 
+nd_l_s
+(
+dee_e
+ *
+s
+, 
+lcodes
+, 
+dcodes
+,
+
+2252 
+blcodes
+);
+
+2253 
+lol
+ 
+comess_block
+(
+dee_e
+ *
+s
+, c 
+_da
+ *
+e
+,
+
+2254 c 
+_da
+ *
+d
+);
+
+2255 
+lol
+ 
+t_da_ty
+(
+dee_e
+ *
+s
+);
+
+2256 
+lol
+ 
+bi_v
+(
+vue
+, 
+ngth
+);
+
+2257 
+lol
+ 
+bi_wdup
+(
+dee_e
+ *
+s
+);
+
+2258 
+lol
+ 
+bi_ush
+(
+dee_e
+ *
+s
+);
+
+2259 
+lol
+ 
+cy_block
+(
+dee_e
+ *
+s
+, 
+chf
+ *
+buf
+, 
+n
+,
+
+2260 
+hd
+);
+
+2262 #ifde
+GEN_TREES_H
+
+
+2263 
+lol
+ 
+g_s_hd
+();
+
+2266 #ide
+DEBUG_ZLIB
+
+
+2267 
+	#nd_code
+(
+s
+, 
+c
+, 
+
+
+	`nd_bs
+(s,e[c].
+Code
+,e[c].
+L
+)
+
+	)
+
+2271 
+	#nd_code
+(
+s
+, 
+c
+, 
+
+) \
+
+2272 { i(
+z_vbo
+>2
+	`rtf
+(
+dr
+,"\ncd %3d ",(
+c
+)); \
+
+2273 
+	`nd_bs
+(
+s
+, 
+
+[
+c
+].
+Code
+,e[c].
+L
+); }
+
+	)
+
+2280 
+	#put_sht
+(
+s
+, 
+w
+) { \
+
+2281 
+	`put_by
+(
+s
+, (
+uch
+)((
+w
+) & 0xff)); \
+
+2282 
+	`put_by
+(
+s
+, (
+uch
+)((
+ush
+)(
+w
+) >> 8)); \
+
+2283 }
+
+	)
+
+2289 #ifde
+DEBUG_ZLIB
+
+
+2290 
+lol
+ 
+nd_bs
+(
+dee_e
+ *
+s
+, 
+vue
+, 
+ngth
+);
+
+2292 
+lol
+ 
+	$nd_bs
+(
+s
+, 
+vue
+, 
+ngth
+)
+
+2293 
+dee_e
+ *
+s
+;
+
+2294 
+vue
+;
+
+2295 
+ngth
+;
+
+2297 
+	`Tvv
+((
+dr
+," %2d v %4x ", 
+ngth
+, 
+vue
+));
+
+2298 
+	`As
+(
+ngth
+ > 0 &&ength <= 15, "invalidength");
+
+2299 
+s
+->
+bs_
+ +(
+ulg
+)
+ngth
+;
+
+2305 i(
+s
+->
+bi_vid
+ > ()
+Buf_size
+ - 
+ngth
+) {
+
+2306 
+s
+->
+bi_buf
+ |(
+vue
+ << s->
+bi_vid
+);
+
+2307 
+	`put_sht
+(
+s
+, s->
+bi_buf
+);
+
+2308 
+s
+->
+bi_buf
+ = (
+ush
+)
+vue
+ >> (
+Buf_size
+ - s->
+bi_vid
+);
+
+2309 
+s
+->
+bi_vid
+ +
+ngth
+ - 
+Buf_size
+;
+
+2311 
+s
+->
+bi_buf
+ |
+vue
+ << s->
+bi_vid
+;
+
+2312 
+s
+->
+bi_vid
+ +
+ngth
+;
+
+2314 
+	}
+}
+
+2317 
+	#nd_bs
+(
+s
+, 
+vue
+, 
+ngth
+) \
+
+2318 { 
+n
+ = 
+ngth
+;\
+
+2319 i(
+s
+->
+bi_vid
+ > ()
+Buf_size
+ - 
+n
+) {\
+
+2320 
+v
+ = 
+vue
+;\
+
+2321 
+s
+->
+bi_buf
+ |(
+v
+ << s->
+bi_vid
+);\
+
+2322 
+	`put_sht
+(
+s
+, s->
+bi_buf
+);\
+
+2323 
+s
+->
+bi_buf
+ = (
+ush
+)
+v
+ >> (
+Buf_size
+ - s->
+bi_vid
+);\
+
+2324 
+s
+->
+bi_vid
+ +
+n
+ - 
+Buf_size
+;\
+
+2326 
+s
+->
+bi_buf
+ |(
+vue
+<< s->
+bi_vid
+;\
+
+2327 
+s
+->
+bi_vid
+ +
+n
+;\
+
+2329 }
+
+	)
+
+2336 
+lol
+ 
+	$_ic_
+()
+
+2338 #i
+	`defed
+(
+GEN_TREES_H
+|| !defed(
+STDC
+)
+
+2339 
+ic__de
+ = 0;
+
+2340 
+n
+;
+
+2341 
+bs
+;
+
+2342 
+ngth
+;
+
+2343 
+code
+;
+
+2344 
+di
+;
+
+2345 
+ush
+ 
+bl_cou
+[
+MAX_BITS
++1];
+
+2348 i(
+ic__de
+) ;
+
+2351 
+ic_l_desc
+.
+ic_
+ = 
+ic_e
+;
+
+2352 
+ic_l_desc
+.
+exa_bs
+ = 
+exa_lbs
+;
+
+2353 
+ic_d_desc
+.
+ic_
+ = 
+ic_d
+;
+
+2354 
+ic_d_desc
+.
+exa_bs
+ = 
+exa_dbs
+;
+
+2355 
+ic_bl_desc
+.
+exa_bs
+ = 
+exa_blbs
+;
+
+2358 
+ngth
+ = 0;
+
+2359 
+code
+ = 0; cod< 
+LENGTH_CODES
+-1; code++) {
+
+2360 
+ba_ngth
+[
+code
+] = 
+ngth
+;
+
+2361 
+n
+ = 0; < (1<<
+exa_lbs
+[
+code
+]);++) {
+
+2362 
+_ngth_code
+[
+ngth
+++] = (
+uch
+)
+code
+;
+
+2365 
+	`As
+ (
+ngth
+ == 256, "tr_static_init:ength != 256");
+
+2370 
+_ngth_code
+[
+ngth
+-1] = (
+uch
+)
+code
+;
+
+2373 
+di
+ = 0;
+
+2374 
+code
+ = 0 ; code < 16; code++) {
+
+2375 
+ba_di
+[
+code
+] = 
+di
+;
+
+2376 
+n
+ = 0; < (1<<
+exa_dbs
+[
+code
+]);++) {
+
+2377 
+_di_code
+[
+di
+++] = (
+uch
+)
+code
+;
+
+2380 
+	`As
+ (
+di
+ == 256, "tr_static_init: dist != 256");
+
+2381 
+di
+ >>= 7;
+
+2382  ; 
+code
+ < 
+D_CODES
+; code++) {
+
+2383 
+ba_di
+[
+code
+] = 
+di
+ << 7;
+
+2384 
+n
+ = 0; < (1<<(
+exa_dbs
+[
+code
+]-7));++) {
+
+2385 
+_di_code
+[256 + 
+di
+++] = (
+uch
+)
+code
+;
+
+2388 
+	`As
+ (
+di
+ == 256, "tr_static_init: 256+dist != 512");
+
+2391 
+bs
+ = 0; b<
+MAX_BITS
+; bs++
+bl_cou
+[bits] = 0;
+
+2392 
+n
+ = 0;
+
+2393 
+n
+ <143
+ic_e
+[n++].
+L
+ = 8, 
+bl_cou
+[8]++;
+
+2394 
+n
+ <255
+ic_e
+[n++].
+L
+ = 9, 
+bl_cou
+[9]++;
+
+2395 
+n
+ <279
+ic_e
+[n++].
+L
+ = 7, 
+bl_cou
+[7]++;
+
+2396 
+n
+ <287
+ic_e
+[n++].
+L
+ = 8, 
+bl_cou
+[8]++;
+
+2401 
+	`g_codes
+((
+_da
+ *)
+ic_e
+, 
+L_CODES
++1, 
+bl_cou
+);
+
+2404 
+n
+ = 0; < 
+D_CODES
+;++) {
+
+2405 
+ic_d
+[
+n
+].
+L
+ = 5;
+
+2406 
+ic_d
+[
+n
+].
+Code
+ = 
+	`bi_v
+(()n, 5);
+
+2408 
+ic__de
+ = 1;
+
+2410 #ifde
+GEN_TREES_H
+
+
+2411 
+	`g_s_hd
+();
+
+2414 
+	}
+}
+
+2419 #ifde
+GEN_TREES_H
+
+
+2420 #ide
+DEBUG_ZLIB
+
+
+2421 
+	~<dio.h
+>
+
+2424 
+	#SEPARATOR
+(
+i
+, 
+
+, 
+width
+) \
+
+2425 ((
+i
+=(
+
+)? "\n};\n\n" : \
+
+2426 ((
+i
+% (
+width
+=(width)-1 ? ",\n" : ", "))
+
+	)
+
+2428 
+	$g_s_hd
+()
+
+2430 
+FILE
+ *
+hd
+ = 
+	`f
+("trees.h", "w");
+
+2431 
+i
+;
+
+2433 
+	`As
+ (
+hd
+ !
+NULL
+, "Can't openrees.h");
+
+2434 
+	`rtf
+(
+hd
+,
+
+2437 
+	`rtf
+(
+hd
+, "local const ct_data static_ltree[L_CODES+2] = {\n");
+
+2438 
+i
+ = 0; i < 
+L_CODES
++2; i++) {
+
+2439 
+	`rtf
+(
+hd
+, "{{%3u},{%3u}}%s", 
+ic_e
+[
+i
+].
+Code
+,
+
+2440 
+ic_e
+[
+i
+].
+L
+, 
+	`SEPARATOR
+(i, 
+L_CODES
++1, 5));
+
+2443 
+	`rtf
+(
+hd
+, "local const ct_data static_dtree[D_CODES] = {\n");
+
+2444 
+i
+ = 0; i < 
+D_CODES
+; i++) {
+
+2445 
+	`rtf
+(
+hd
+, "{{%2u},{%2u}}%s", 
+ic_d
+[
+i
+].
+Code
+,
+
+2446 
+ic_d
+[
+i
+].
+L
+, 
+	`SEPARATOR
+(i, 
+D_CODES
+-1, 5));
+
+2449 
+	`rtf
+(
+hd
+, "const uch _dist_code[DIST_CODE_LEN] = {\n");
+
+2450 
+i
+ = 0; i < 
+DIST_CODE_LEN
+; i++) {
+
+2451 
+	`rtf
+(
+hd
+, "%2u%s", 
+_di_code
+[
+i
+],
+
+2452 
+	`SEPARATOR
+(
+i
+, 
+DIST_CODE_LEN
+-1, 20));
+
+2455 
+	`rtf
+(
+hd
+, "const uch _length_code[MAX_MATCH-MIN_MATCH+1]= {\n");
+
+2456 
+i
+ = 0; i < 
+MAX_MATCH
+-
+MIN_MATCH
++1; i++) {
+
+2457 
+	`rtf
+(
+hd
+, "%2u%s", 
+_ngth_code
+[
+i
+],
+
+2458 
+	`SEPARATOR
+(
+i
+, 
+MAX_MATCH
+-
+MIN_MATCH
+, 20));
+
+2461 
+	`rtf
+(
+hd
+, "local const int base_length[LENGTH_CODES] = {\n");
+
+2462 
+i
+ = 0; i < 
+LENGTH_CODES
+; i++) {
+
+2463 
+	`rtf
+(
+hd
+, "%1u%s", 
+ba_ngth
+[
+i
+],
+
+2464 
+	`SEPARATOR
+(
+i
+, 
+LENGTH_CODES
+-1, 20));
+
+2467 
+	`rtf
+(
+hd
+, "local const int base_dist[D_CODES] = {\n");
+
+2468 
+i
+ = 0; i < 
+D_CODES
+; i++) {
+
+2469 
+	`rtf
+(
+hd
+, "%5u%s", 
+ba_di
+[
+i
+],
+
+2470 
+	`SEPARATOR
+(
+i
+, 
+D_CODES
+-1, 10));
+
+2473 
+	`fo
+(
+hd
+);
+
+2474 
+	}
+}
+
+2480 
+	$__
+(
+dee_e
+ *
+s
+)
+
+2482 
+	`_ic_
+();
+
+2484 
+s
+->
+l_desc
+.
+dyn_
+ = s->
+dyn_e
+;
+
+2485 
+s
+->
+l_desc
+.
+_desc
+ = &
+ic_l_desc
+;
+
+2487 
+s
+->
+d_desc
+.
+dyn_
+ = s->
+dyn_d
+;
+
+2488 
+s
+->
+d_desc
+.
+_desc
+ = &
+ic_d_desc
+;
+
+2490 
+s
+->
+bl_desc
+.
+dyn_
+ = s->
+bl_
+;
+
+2491 
+s
+->
+bl_desc
+.
+_desc
+ = &
+ic_bl_desc
+;
+
+2493 
+s
+->
+bi_buf
+ = 0;
+
+2494 
+s
+->
+bi_vid
+ = 0;
+
+2495 
+s
+->
+_eob_n
+ = 8;
+
+2496 #ifde
+DEBUG_ZLIB
+
+
+2497 
+s
+->
+comesd_n
+ = 0L;
+
+2498 
+s
+->
+bs_
+ = 0L;
+
+2502 
+	`_block
+(
+s
+);
+
+2503 
+	}
+}
+
+2508 
+lol
+ 
+	$_block
+(
+dee_e
+ *
+s
+)
+
+2510 
+n
+;
+
+2513 
+n
+ = 0; < 
+L_CODES
+;++
+s
+->
+dyn_e
+[n].
+Fq
+ = 0;
+
+2514 
+n
+ = 0; < 
+D_CODES
+;++
+s
+->
+dyn_d
+[n].
+Fq
+ = 0;
+
+2515 
+n
+ = 0; < 
+BL_CODES
+;++
+s
+->
+bl_
+[n].
+Fq
+ = 0;
+
+2517 
+s
+->
+dyn_e
+[
+END_BLOCK
+].
+Fq
+ = 1;
+
+2518 
+s
+->
+t_n
+ = s->
+ic_n
+ = 0L;
+
+2519 
+s
+->
+_l
+ = s->
+mches
+ = 0;
+
+2520 
+	}
+}
+
+2522 
+	#SMALLEST
+ 1
+
+	)
+
+2530 
+	#pqmove
+(
+s
+, 
+
+, 
+t
+) \
+
+2532 
+t
+ = 
+s
+->
+hp
+[
+SMALLEST
+]; \
+
+2533 
+s
+->
+hp
+[
+SMALLEST
+] = s->hp[s->
+hp_n
+--]; \
+
+2534 
+	`pqdownhp
+(
+s
+, 
+
+, 
+SMALLEST
+); \
+
+2535 }
+
+	)
+
+2541 
+	#smr
+(
+
+, 
+n
+, 
+m
+, 
+dth
+) \
+
+2542 (
+
+[
+n
+].
+Fq
+ <e[
+m
+].Freq || \
+
+2543 (
+
+[
+n
+].
+Fq
+ =[
+m
+].Fq && 
+dth
+[n] <dth[m]))
+
+	)
+
+2551 
+lol
+ 
+	$pqdownhp
+(
+dee_e
+ *
+s
+,
+
+2552 
+_da
+ *
+
+,
+
+2553 
+k
+)
+
+2555 
+v
+ = 
+s
+->
+hp
+[
+k
+];
+
+2556 
+j
+ = 
+k
+ << 1;
+
+2557 
+j
+ <
+s
+->
+hp_n
+) {
+
+2559 i(
+j
+ < 
+s
+->
+hp_n
+ &&
+
+2560 
+	`smr
+(
+
+, 
+s
+->
+hp
+[
+j
++1], s->hp[j], s->
+dth
+)) {
+
+2561 
+j
+++;
+
+2564 i(
+	`smr
+(
+
+, 
+v
+, 
+s
+->
+hp
+[
+j
+], s->
+dth
+)) ;
+
+2567 
+s
+->
+hp
+[
+k
+] = s->hp[
+j
+]; k = j;
+
+2570 
+j
+ <<= 1;
+
+2572 
+s
+->
+hp
+[
+k
+] = 
+v
+;
+
+2573 
+	}
+}
+
+2585 
+lol
+ 
+	$g_bn
+(
+dee_e
+ *
+s
+,
+
+2586 
+_desc
+ *
+desc
+)
+
+2588 
+_da
+ *
+
+ = 
+desc
+->
+dyn_
+;
+
+2589 
+max_code
+ = 
+desc
+->max_code;
+
+2590 c 
+_da
+ *
+e
+ = 
+desc
+->
+_desc
+->
+ic_
+;
+
+2591 c 
+tf
+ *
+exa
+ = 
+desc
+->
+_desc
+->
+exa_bs
+;
+
+2592 
+ba
+ = 
+desc
+->
+_desc
+->
+exa_ba
+;
+
+2593 
+max_ngth
+ = 
+desc
+->
+_desc
+->max_length;
+
+2594 
+h
+;
+
+2595 
+n
+, 
+m
+;
+
+2596 
+bs
+;
+
+2597 
+xbs
+;
+
+2598 
+ush
+ 
+f
+;
+
+2599 
+ovow
+ = 0;
+
+2601 
+bs
+ = 0; b<
+MAX_BITS
+; bs++
+s
+->
+bl_cou
+[bits] = 0;
+
+2606 
+
+[
+s
+->
+hp
+[s->
+hp_max
+]].
+L
+ = 0;
+
+2608 
+h
+ = 
+s
+->
+hp_max
++1; h < 
+HEAP_SIZE
+; h++) {
+
+2609 
+n
+ = 
+s
+->
+hp
+[
+h
+];
+
+2610 
+bs
+ = 
+
+[[
+n
+].
+Dad
+].
+L
+ + 1;
+
+2611 i(
+bs
+ > 
+max_ngth
+bmax_ngth, 
+ovow
+++;
+
+2612 
+
+[
+n
+].
+L
+ = (
+ush
+)
+bs
+;
+
+2615 i(
+n
+ > 
+max_code
+) ;
+
+2617 
+s
+->
+bl_cou
+[
+bs
+]++;
+
+2618 
+xbs
+ = 0;
+
+2619 i(
+n
+ >
+ba
+
+xbs
+ = 
+exa
+[n-base];
+
+2620 
+f
+ = 
+
+[
+n
+].
+Fq
+;
+
+2621 
+s
+->
+t_n
+ +(
+ulg
+)
+f
+ * (
+bs
+ + 
+xbs
+);
+
+2622 i(
+e
+
+s
+->
+ic_n
+ +(
+ulg
+)
+f
+ * (e[
+n
+].
+L
+ + 
+xbs
+);
+
+2624 i(
+ovow
+ == 0) ;
+
+2626 
+	`T
+((
+dr
+,"\nbitength overflow\n"));
+
+2631 
+bs
+ = 
+max_ngth
+-1;
+
+2632 
+s
+->
+bl_cou
+[
+bs
+] == 0) bits--;
+
+2633 
+s
+->
+bl_cou
+[
+bs
+]--;
+
+2634 
+s
+->
+bl_cou
+[
+bs
++1] += 2;
+
+2635 
+s
+->
+bl_cou
+[
+max_ngth
+]--;
+
+2639 
+ovow
+ -= 2;
+
+2640 } 
+ovow
+ > 0);
+
+2647 
+bs
+ = 
+max_ngth
+; bits != 0; bits--) {
+
+2648 
+n
+ = 
+s
+->
+bl_cou
+[
+bs
+];
+
+2649 
+n
+ != 0) {
+
+2650 
+m
+ = 
+s
+->
+hp
+[--
+h
+];
+
+2651 i(
+m
+ > 
+max_code
+) ;
+
+2652 i(
+
+[
+m
+].
+L
+ !(
+bs
+) {
+
+2653 
+	`T
+((
+dr
+,"cod%d b%d->%d\n", 
+m
+, 
+
+[m].
+L
+, 
+bs
+));
+
+2654 
+s
+->
+t_n
+ +(()
+bs
+ - ()
+
+[
+m
+].
+L
+)
+
+2655 *()
+
+[
+m
+].
+Fq
+;
+
+2656 
+
+[
+m
+].
+L
+ = (
+ush
+)
+bs
+;
+
+2658 
+n
+--;
+
+2661 
+	}
+}
+
+2671 
+lol
+ 
+	$g_codes
+ (
+_da
+ *
+
+,
+
+2672 
+max_code
+,
+
+2673 
+ushf
+ *
+bl_cou
+)
+
+2675 
+ush
+ 
+xt_code
+[
+MAX_BITS
++1];
+
+2676 
+ush
+ 
+code
+ = 0;
+
+2677 
+bs
+;
+
+2678 
+n
+;
+
+2683 
+bs
+ = 1; b<
+MAX_BITS
+; bits++) {
+
+2684 
+xt_code
+[
+bs
+] = 
+code
+ = (cod+ 
+bl_cou
+[bits-1]) << 1;
+
+2689 
+	`As
+ (
+code
+ + 
+bl_cou
+[
+MAX_BITS
+]-1 == (1<<MAX_BITS)-1,
+
+2691 
+	`Tv
+((
+dr
+,"\ng_codes: max_cod%d ", 
+max_code
+));
+
+2693 
+n
+ = 0; <
+max_code
+;++) {
+
+2694 
+n
+ = 
+
+[
+n
+].
+L
+;
+
+2695 i(
+n
+ == 0) ;
+
+2697 
+
+[
+n
+].
+Code
+ = 
+	`bi_v
+(
+xt_code
+[
+n
+]++,en);
+
+2699 
+	`Tcv
+(
+
+ !
+ic_e
+, (
+dr
+,"\nn %3d %c %2d c %4x (%x) ",
+
+2700 
+n
+, (
+	`isgph
+? : ' '), 
+n
+, 
+
+[n].
+Code
+, 
+xt_code
+[len]-1));
+
+2702 
+	}
+}
+
+2712 
+lol
+ 
+	$bud_
+(
+dee_e
+ *
+s
+,
+
+2713 
+_desc
+ *
+desc
+)
+
+2715 
+_da
+ *
+
+ = 
+desc
+->
+dyn_
+;
+
+2716 c 
+_da
+ *
+e
+ = 
+desc
+->
+_desc
+->
+ic_
+;
+
+2717 
+ems
+ = 
+desc
+->
+_desc
+->elems;
+
+2718 
+n
+, 
+m
+;
+
+2719 
+max_code
+ = -1;
+
+2720 
+node
+;
+
+2726 
+s
+->
+hp_n
+ = 0, s->
+hp_max
+ = 
+HEAP_SIZE
+;
+
+2728 
+n
+ = 0; < 
+ems
+;++) {
+
+2729 i(
+
+[
+n
+].
+Fq
+ != 0) {
+
+2730 
+s
+->
+hp
+[++(s->
+hp_n
+)] = 
+max_code
+ = 
+n
+;
+
+2731 
+s
+->
+dth
+[
+n
+] = 0;
+
+2733 
+
+[
+n
+].
+L
+ = 0;
+
+2742 
+s
+->
+hp_n
+ < 2) {
+
+2743 
+node
+ = 
+s
+->
+hp
+[++(s->
+hp_n
+)] = (
+max_code
+ < 2 ? ++max_code : 0);
+
+2744 
+
+[
+node
+].
+Fq
+ = 1;
+
+2745 
+s
+->
+dth
+[
+node
+] = 0;
+
+2746 
+s
+->
+t_n
+--; i(
+e
+s->
+ic_n
+ -e[
+node
+].
+L
+;
+
+2749 
+desc
+->
+max_code
+ = max_code;
+
+2754 
+n
+ = 
+s
+->
+hp_n
+/2; >1;--
+	`pqdownhp
+(s, 
+
+,);
+
+2759 
+node
+ = 
+ems
+;
+
+2761 
+	`pqmove
+(
+s
+, 
+
+, 
+n
+);
+
+2762 
+m
+ = 
+s
+->
+hp
+[
+SMALLEST
+];
+
+2764 
+s
+->
+hp
+[--(s->
+hp_max
+)] = 
+n
+;
+
+2765 
+s
+->
+hp
+[--(s->
+hp_max
+)] = 
+m
+;
+
+2768 
+
+[
+node
+].
+Fq
+ =e[
+n
+].Fq +e[
+m
+].Freq;
+
+2769 
+s
+->
+dth
+[
+node
+] = (
+uch
+(
+	`MAX
+(s->dth[
+n
+], s->dth[
+m
+]) + 1);
+
+2770 
+
+[
+n
+].
+Dad
+ =e[
+m
+].Dad = (
+ush
+)
+node
+;
+
+2771 #ifde
+DUMP_BL_TREE
+
+
+2772 i(
+
+ =
+s
+->
+bl_
+) {
+
+2773 
+	`rtf
+(
+dr
+,"\nnode %d(%d), sons %d(%d) %d(%d)",
+
+2774 
+node
+, 
+
+[node].
+Fq
+, 
+n
+,e[n].Fq, 
+m
+,ree[m].Freq);
+
+2778 
+s
+->
+hp
+[
+SMALLEST
+] = 
+node
+++;
+
+2779 
+	`pqdownhp
+(
+s
+, 
+
+, 
+SMALLEST
+);
+
+2781 } 
+s
+->
+hp_n
+ >= 2);
+
+2783 
+s
+->
+hp
+[--(s->
+hp_max
+)] = s->hp[
+SMALLEST
+];
+
+2788 
+	`g_bn
+(
+s
+, (
+_desc
+ *)
+desc
+);
+
+2791 
+	`g_codes
+ ((
+_da
+ *)
+
+, 
+max_code
+, 
+s
+->
+bl_cou
+);
+
+2792 
+	}
+}
+
+2798 
+lol
+ 
+	$sn_
+ (
+dee_e
+ *
+s
+,
+
+2799 
+_da
+ *
+
+,
+
+2800 
+max_code
+)
+
+2802 
+n
+;
+
+2803 
+evn
+ = -1;
+
+2804 
+cu
+;
+
+2805 
+x
+ = 
+
+[0].
+L
+;
+
+2806 
+cou
+ = 0;
+
+2807 
+max_cou
+ = 7;
+
+2808 
+m_cou
+ = 4;
+
+2810 i(
+x
+ =0
+max_cou
+ = 138, 
+m_cou
+ = 3;
+
+2811 
+
+[
+max_code
++1].
+L
+ = (
+ush
+)0xffff;
+
+2813 
+n
+ = 0; <
+max_code
+;++) {
+
+2814 
+cu
+ = 
+x
+;ex = 
+
+[
+n
++1].
+L
+;
+
+2815 i(++
+cou
+ < 
+max_cou
+ && 
+cu
+ =
+x
+) {
+
+2817 } i(
+cou
+ < 
+m_cou
+) {
+
+2818 
+s
+->
+bl_
+[
+cu
+].
+Fq
+ +
+cou
+;
+
+2819 } i(
+cu
+ != 0) {
+
+2820 i(
+cu
+ !
+evn
+
+s
+->
+bl_
+[cu].
+Fq
+++;
+
+2821 
+s
+->
+bl_
+[
+REP_3_6
+].
+Fq
+++;
+
+2822 } i(
+cou
+ <= 10) {
+
+2823 
+s
+->
+bl_
+[
+REPZ_3_10
+].
+Fq
+++;
+
+2825 
+s
+->
+bl_
+[
+REPZ_11_138
+].
+Fq
+++;
+
+2827 
+cou
+ = 0; 
+evn
+ = 
+cu
+;
+
+2828 i(
+x
+ == 0) {
+
+2829 
+max_cou
+ = 138, 
+m_cou
+ = 3;
+
+2830 } i(
+cu
+ =
+x
+) {
+
+2831 
+max_cou
+ = 6, 
+m_cou
+ = 3;
+
+2833 
+max_cou
+ = 7, 
+m_cou
+ = 4;
+
+2836 
+	}
+}
+
+2842 
+lol
+ 
+	$nd_
+ (
+dee_e
+ *
+s
+,
+
+2843 
+_da
+ *
+
+,
+
+2844 
+max_code
+)
+
+2846 
+n
+;
+
+2847 
+evn
+ = -1;
+
+2848 
+cu
+;
+
+2849 
+x
+ = 
+
+[0].
+L
+;
+
+2850 
+cou
+ = 0;
+
+2851 
+max_cou
+ = 7;
+
+2852 
+m_cou
+ = 4;
+
+2855 i(
+x
+ =0
+max_cou
+ = 138, 
+m_cou
+ = 3;
+
+2857 
+n
+ = 0; <
+max_code
+;++) {
+
+2858 
+cu
+ = 
+x
+;ex = 
+
+[
+n
++1].
+L
+;
+
+2859 i(++
+cou
+ < 
+max_cou
+ && 
+cu
+ =
+x
+) {
+
+2861 } i(
+cou
+ < 
+m_cou
+) {
+
+2862 d{ 
+	`nd_code
+(
+s
+, 
+cu
+, s->
+bl_
+); } --
+cou
+ != 0);
+
+2864 } i(
+cu
+ != 0) {
+
+2865 i(
+cu
+ !
+evn
+) {
+
+2866 
+	`nd_code
+(
+s
+, 
+cu
+, s->
+bl_
+); 
+cou
+--;
+
+2868 
+	`As
+(
+cou
+ >= 3 && count <= 6, " 3_6?");
+
+2869 
+	`nd_code
+(
+s
+, 
+REP_3_6
+, s->
+bl_
+); 
+	`nd_bs
+(s, 
+cou
+-3, 2);
+
+2871 } i(
+cou
+ <= 10) {
+
+2872 
+	`nd_code
+(
+s
+, 
+REPZ_3_10
+, s->
+bl_
+); 
+	`nd_bs
+(s, 
+cou
+-3, 3);
+
+2875 
+	`nd_code
+(
+s
+, 
+REPZ_11_138
+, s->
+bl_
+); 
+	`nd_bs
+(s, 
+cou
+-11, 7);
+
+2877 
+cou
+ = 0; 
+evn
+ = 
+cu
+;
+
+2878 i(
+x
+ == 0) {
+
+2879 
+max_cou
+ = 138, 
+m_cou
+ = 3;
+
+2880 } i(
+cu
+ =
+x
+) {
+
+2881 
+max_cou
+ = 6, 
+m_cou
+ = 3;
+
+2883 
+max_cou
+ = 7, 
+m_cou
+ = 4;
+
+2886 
+	}
+}
+
+2892 
+lol
+ 
+	$bud_bl_
+(
+dee_e
+ *
+s
+)
+
+2894 
+max_bldex
+;
+
+2897 
+	`sn_
+(
+s
+, (
+_da
+ *)s->
+dyn_e
+, s->
+l_desc
+.
+max_code
+);
+
+2898 
+	`sn_
+(
+s
+, (
+_da
+ *)s->
+dyn_d
+, s->
+d_desc
+.
+max_code
+);
+
+2901 
+	`bud_
+(
+s
+, (
+_desc
+ *)(&(s->
+bl_desc
+)));
+
+2910 
+max_bldex
+ = 
+BL_CODES
+-1; max_blindex >= 3; max_blindex--) {
+
+2911 i(
+s
+->
+bl_
+[
+bl_d
+[
+max_bldex
+]].
+L
+ != 0) ;
+
+2914 
+s
+->
+t_n
+ +3*(
+max_bldex
++1) + 5+5+4;
+
+2915 
+	`Tv
+((
+dr
+, "\ndynrees: dyn %ld, stat %ld",
+
+2916 
+s
+->
+t_n
+, s->
+ic_n
+));
+
+2918  
+max_bldex
+;
+
+2919 
+	}
+}
+
+2926 
+lol
+ 
+	$nd_l_s
+(
+dee_e
+ *
+s
+,
+
+2927 
+lcodes
+, 
+dcodes
+, 
+blcodes
+)
+
+2929 
+nk
+;
+
+2931 
+	`As
+ (
+lcodes
+ >257 && 
+dcodes
+ >1 && 
+blcodes
+ >= 4, "notnough codes");
+
+2932 
+	`As
+ (
+lcodes
+ <
+L_CODES
+ && 
+dcodes
+ <
+D_CODES
+ && 
+blcodes
+ <
+BL_CODES
+,
+
+2934 
+	`Tv
+((
+dr
+, "\nbl counts: "));
+
+2935 
+	`nd_bs
+(
+s
+, 
+lcodes
+-257, 5);
+
+2936 
+	`nd_bs
+(
+s
+, 
+dcodes
+-1, 5);
+
+2937 
+	`nd_bs
+(
+s
+, 
+blcodes
+-4, 4);
+
+2938 
+nk
+ = 0;k < 
+blcodes
+;ank++) {
+
+2939 
+	`Tv
+((
+dr
+, "\nbcod%2d ", 
+bl_d
+[
+nk
+]));
+
+2940 
+	`nd_bs
+(
+s
+, s->
+bl_
+[
+bl_d
+[
+nk
+]].
+L
+, 3);
+
+2942 
+	`Tv
+((
+dr
+, "\nb: s%ld", 
+s
+->
+bs_
+));
+
+2944 
+	`nd_
+(
+s
+, (
+_da
+ *)s->
+dyn_e
+, 
+lcodes
+-1);
+
+2945 
+	`Tv
+((
+dr
+, "\e: s%ld", 
+s
+->
+bs_
+));
+
+2947 
+	`nd_
+(
+s
+, (
+_da
+ *)s->
+dyn_d
+, 
+dcodes
+-1);
+
+2948 
+	`Tv
+((
+dr
+, "\ndie: s%ld", 
+s
+->
+bs_
+));
+
+2949 
+	}
+}
+
+2954 
+	$__ed_block
+(
+dee_e
+ *
+s
+,
+
+2955 
+chf
+ *
+buf
+,
+
+2956 
+ulg
+ 
+ed_n
+,
+
+2957 
+eof
+)
+
+2959 
+	`nd_bs
+(
+s
+, (
+STORED_BLOCK
+<<1)+
+eof
+, 3);
+
+2960 #ifde
+DEBUG_ZLIB
+
+
+2961 
+s
+->
+comesd_n
+ = (s->comesd_+ 3 + 7& (
+ulg
+)~7L;
+
+2962 
+s
+->
+comesd_n
+ +(
+ed_n
+ + 4) << 3;
+
+2964 
+	`cy_block
+(
+s
+, 
+buf
+, ()
+ed_n
+, 1);
+
+2965 
+	}
+}
+
+2969 
+	$__ed_ty_ly
+(
+dee_e
+ *
+s
+)
+
+2971 
+	`nd_bs
+(
+s
+, (
+STORED_BLOCK
+ << 1), 3);
+
+2972 
+	`bi_wdup
+(
+s
+);
+
+2973 #ifde
+DEBUG_ZLIB
+
+
+2974 
+s
+->
+comesd_n
+ = (s->compressed_len + 3) & ~7L;
+
+2976 
+	}
+}
+
+2989 
+	$__ign
+(
+dee_e
+ *
+s
+)
+
+2991 
+	`nd_bs
+(
+s
+, 
+STATIC_TREES
+<<1, 3);
+
+2992 
+	`nd_code
+(
+s
+, 
+END_BLOCK
+, 
+ic_e
+);
+
+2993 #ifde
+DEBUG_ZLIB
+
+
+2994 
+s
+->
+comesd_n
+ += 10L;
+
+2996 
+	`bi_ush
+(
+s
+);
+
+3002 i(1 + 
+s
+->
+_eob_n
+ + 10 - s->
+bi_vid
+ < 9) {
+
+3003 
+	`nd_bs
+(
+s
+, 
+STATIC_TREES
+<<1, 3);
+
+3004 
+	`nd_code
+(
+s
+, 
+END_BLOCK
+, 
+ic_e
+);
+
+3005 #ifde
+DEBUG_ZLIB
+
+
+3006 
+s
+->
+comesd_n
+ += 10L;
+
+3008 
+	`bi_ush
+(
+s
+);
+
+3010 
+s
+->
+_eob_n
+ = 7;
+
+3011 
+	}
+}
+
+3017 
+	$__ush_block
+(
+dee_e
+ *
+s
+,
+
+3018 
+chf
+ *
+buf
+,
+
+3019 
+ulg
+ 
+ed_n
+,
+
+3020 
+eof
+)
+
+3022 
+ulg
+ 
+t_nb
+, 
+ic_nb
+;
+
+3023 
+max_bldex
+ = 0;
+
+3026 i(
+s
+->
+v
+ > 0) {
+
+3029 i(
+s
+->
+da_ty
+ =
+Z_UNKNOWN
+
+	`t_da_ty
+(s);
+
+3032 
+	`bud_
+(
+s
+, (
+_desc
+ *)(&(s->
+l_desc
+)));
+
+3033 
+	`Tv
+((
+dr
+, "\ da: dy%ld, s%ld", 
+s
+->
+t_n
+,
+
+3034 
+s
+->
+ic_n
+));
+
+3036 
+	`bud_
+(
+s
+, (
+_desc
+ *)(&(s->
+d_desc
+)));
+
+3037 
+	`Tv
+((
+dr
+, "\ndi da: dy%ld, s%ld", 
+s
+->
+t_n
+,
+
+3038 
+s
+->
+ic_n
+));
+
+3046 
+max_bldex
+ = 
+	`bud_bl_
+(
+s
+);
+
+3049 
+t_nb
+ = (
+s
+->
+t_n
++3+7)>>3;
+
+3050 
+ic_nb
+ = (
+s
+->
+ic_n
++3+7)>>3;
+
+3052 
+	`Tv
+((
+dr
+, "\nopt %lu(%lu) stat %lu(%lu) stored %luit %u ",
+
+3053 
+t_nb
+, 
+s
+->
+t_n
+, 
+ic_nb
+, s->
+ic_n
+, 
+ed_n
+,
+
+3054 
+s
+->
+_l
+));
+
+3056 i(
+ic_nb
+ <
+t_nb
+) opt_lenb = static_lenb;
+
+3059 
+	`As
+(
+buf
+ != (*)0, "lost buf");
+
+3060 
+t_nb
+ = 
+ic_nb
+ = 
+ed_n
+ + 5;
+
+3063 #ifde
+FORCE_STORED
+
+
+3064 i(
+buf
+ != (*)0) {
+
+3066 i(
+ed_n
++4 <
+t_nb
+ && 
+buf
+ != (*)0) {
+
+3075 
+	`__ed_block
+(
+s
+, 
+buf
+, 
+ed_n
+, 
+eof
+);
+
+3077 #ifde
+FORCE_STATIC
+
+
+3078 } i(
+ic_nb
+ >= 0) {
+
+3080 } i(
+ic_nb
+ =
+t_nb
+) {
+
+3082 
+	`nd_bs
+(
+s
+, (
+STATIC_TREES
+<<1)+
+eof
+, 3);
+
+3083 
+	`comess_block
+(
+s
+, (c 
+_da
+ *)
+ic_e
+, (c ct_d*)
+ic_d
+);
+
+3084 #ifde
+DEBUG_ZLIB
+
+
+3085 
+s
+->
+comesd_n
+ +3 + s->
+ic_n
+;
+
+3088 
+	`nd_bs
+(
+s
+, (
+DYN_TREES
+<<1)+
+eof
+, 3);
+
+3089 
+	`nd_l_s
+(
+s
+, s->
+l_desc
+.
+max_code
++1, s->
+d_desc
+.max_code+1,
+
+3090 
+max_bldex
++1);
+
+3091 
+	`comess_block
+(
+s
+, (c 
+_da
+ *)s->
+dyn_e
+, (c ct_d*)s->
+dyn_d
+);
+
+3092 #ifde
+DEBUG_ZLIB
+
+
+3093 
+s
+->
+comesd_n
+ +3 + s->
+t_n
+;
+
+3096 
+	`As
+ (
+s
+->
+comesd_n
+ =s->
+bs_
+, "bad compressed size");
+
+3100 
+	`_block
+(
+s
+);
+
+3102 i(
+eof
+) {
+
+3103 
+	`bi_wdup
+(
+s
+);
+
+3104 #ifde
+DEBUG_ZLIB
+
+
+3105 
+s
+->
+comesd_n
+ += 7;
+
+3108 
+	`Tv
+((
+dr
+,"\ncom%lu(%lu", 
+s
+->
+comesd_n
+>>3,
+
+3109 
+s
+->
+comesd_n
+-7*
+eof
+));
+
+3110 
+	}
+}
+
+3117 
+	$__y
+ (
+dee_e
+ *
+s
+,
+
+3118 
+di
+,
+
+3119 
+lc
+)
+
+3121 
+s
+->
+d_buf
+[s->
+_l
+] = (
+ush
+)
+di
+;
+
+3122 
+s
+->
+l_buf
+[s->
+_l
+++] = (
+uch
+)
+lc
+;
+
+3123 i(
+di
+ == 0) {
+
+3125 
+s
+->
+dyn_e
+[
+lc
+].
+Fq
+++;
+
+3127 
+s
+->
+mches
+++;
+
+3129 
+di
+--;
+
+3130 
+	`As
+((
+ush
+)
+di
+ < (ush)
+	`MAX_DIST
+(
+s
+) &&
+
+3131 (
+ush
+)
+lc
+ <(ush)(
+MAX_MATCH
+-
+MIN_MATCH
+) &&
+
+3132 (
+ush
+)
+	`d_code
+(
+di
+< (ush)
+D_CODES
+, "_tr_tally: bad match");
+
+3134 
+s
+->
+dyn_e
+[
+_ngth_code
+[
+lc
+]+
+LITERALS
++1].
+Fq
+++;
+
+3135 
+s
+->
+dyn_d
+[
+	`d_code
+(
+di
+)].
+Fq
+++;
+
+3138 #ifde
+TRUNCATE_BLOCK
+
+
+3140 i((
+s
+->
+_l
+ & 0x1fff=0 && s->
+v
+ > 2) {
+
+3142 
+ulg
+ 
+out_ngth
+ = (ulg)
+s
+->
+_l
+*8L;
+
+3143 
+ulg
+ 
+_ngth
+ = (ulg)(()
+s
+->
+rt
+ - s->
+block_t
+);
+
+3144 
+dcode
+;
+
+3145 
+dcode
+ = 0; dcod< 
+D_CODES
+; dcode++) {
+
+3146 
+out_ngth
+ +(
+ulg
+)
+s
+->
+dyn_d
+[
+dcode
+].
+Fq
+ *
+
+3147 (5L+
+exa_dbs
+[
+dcode
+]);
+
+3149 
+out_ngth
+ >>= 3;
+
+3150 
+	`Tv
+((
+dr
+,"\nlast_lit %u, in %ld, out ~%ld(%ld%%) ",
+
+3151 
+s
+->
+_l
+, 
+_ngth
+, 
+out_ngth
+,
+
+3152 100L - 
+out_ngth
+*100L/
+_ngth
+));
+
+3153 i(
+s
+->
+mches
+ < s->
+_l
+/2 && 
+out_ngth
+ < 
+_ngth
+/2)  1;
+
+3156  (
+s
+->
+_l
+ =s->
+l_bufsize
+-1);
+
+3161 
+	}
+}
+
+3167 
+lol
+ 
+	$comess_block
+(
+dee_e
+ *
+s
+,
+
+3168 c 
+_da
+ *
+e
+,
+
+3169 c 
+_da
+ *
+d
+)
+
+3171 
+di
+;
+
+3172 
+lc
+;
+
+3173 
+lx
+ = 0;
+
+3174 
+code
+;
+
+3175 
+exa
+;
+
+3177 i(
+s
+->
+_l
+ != 0) do {
+
+3178 
+di
+ = 
+s
+->
+d_buf
+[
+lx
+];
+
+3179 
+lc
+ = 
+s
+->
+l_buf
+[
+lx
+++];
+
+3180 i(
+di
+ == 0) {
+
+3181 
+	`nd_code
+(
+s
+, 
+lc
+, 
+e
+);
+
+3182 
+	`Tcv
+(
+	`isgph
+(
+lc
+), (
+dr
+," '%c' ",c));
+
+3185 
+code
+ = 
+_ngth_code
+[
+lc
+];
+
+3186 
+	`nd_code
+(
+s
+, 
+code
++
+LITERALS
++1, 
+e
+);
+
+3187 
+exa
+ = 
+exa_lbs
+[
+code
+];
+
+3188 i(
+exa
+ != 0) {
+
+3189 
+lc
+ -
+ba_ngth
+[
+code
+];
+
+3190 
+	`nd_bs
+(
+s
+, 
+lc
+, 
+exa
+);
+
+3192 
+di
+--;
+
+3193 
+code
+ = 
+	`d_code
+(
+di
+);
+
+3194 
+	`As
+ (
+code
+ < 
+D_CODES
+, "bad d_code");
+
+3196 
+	`nd_code
+(
+s
+, 
+code
+, 
+d
+);
+
+3197 
+exa
+ = 
+exa_dbs
+[
+code
+];
+
+3198 i(
+exa
+ != 0) {
+
+3199 
+di
+ -
+ba_di
+[
+code
+];
+
+3200 
+	`nd_bs
+(
+s
+, 
+di
+, 
+exa
+);
+
+3205 
+	`As
+(
+s
+->
+ndg
+ < s->
+l_bufsize
+ + 2*
+lx
+, "pendingBuf overflow");
+
+3207 } 
+lx
+ < 
+s
+->
+_l
+);
+
+3209 
+	`nd_code
+(
+s
+, 
+END_BLOCK
+, 
+e
+);
+
+3210 
+s
+->
+_eob_n
+ = 
+e
+[
+END_BLOCK
+].
+L
+;
+
+3211 
+	}
+}
+
+3219 
+lol
+ 
+	$t_da_ty
+(
+dee_e
+ *
+s
+)
+
+3221 
+n
+ = 0;
+
+3222 
+ascii_eq
+ = 0;
+
+3223 
+b_eq
+ = 0;
+
+3224 
+n
+ < 7
+b_eq
+ +
+s
+->
+dyn_e
+[n++].
+Fq
+;
+
+3225 
+n
+ < 128
+ascii_eq
+ +
+s
+->
+dyn_e
+[n++].
+Fq
+;
+
+3226 
+n
+ < 
+LITERALS
+
+b_eq
+ +
+s
+->
+dyn_e
+[n++].
+Fq
+;
+
+3227 
+s
+->
+da_ty
+ = (
+By
+)(
+b_eq
+ > (
+ascii_eq
+ >> 2? 
+Z_BINARY
+ : 
+Z_ASCII
+);
+
+3228 
+	}
+}
+
+3235 
+lol
+ 
+	$bi_v
+(
+code
+,
+
+3236 
+n
+)
+
+3238 
+s
+ = 0;
+
+3240 
+s
+ |
+code
+ & 1;
+
+3241 
+code
+ >>1, 
+s
+ <<= 1;
+
+3242 } --
+n
+ > 0);
+
+3243  
+s
+ >> 1;
+
+3244 
+	}
+}
+
+3249 
+lol
+ 
+	$bi_ush
+(
+dee_e
+ *
+s
+)
+
+3251 i(
+s
+->
+bi_vid
+ == 16) {
+
+3252 
+	`put_sht
+(
+s
+, s->
+bi_buf
+);
+
+3253 
+s
+->
+bi_buf
+ = 0;
+
+3254 
+s
+->
+bi_vid
+ = 0;
+
+3255 } i(
+s
+->
+bi_vid
+ >= 8) {
+
+3256 
+	`put_by
+(
+s
+, (
+By
+)s->
+bi_buf
+);
+
+3257 
+s
+->
+bi_buf
+ >>= 8;
+
+3258 
+s
+->
+bi_vid
+ -= 8;
+
+3260 
+	}
+}
+
+3265 
+lol
+ 
+	$bi_wdup
+(
+dee_e
+ *
+s
+)
+
+3267 i(
+s
+->
+bi_vid
+ > 8) {
+
+3268 
+	`put_sht
+(
+s
+, s->
+bi_buf
+);
+
+3269 } i(
+s
+->
+bi_vid
+ > 0) {
+
+3270 
+	`put_by
+(
+s
+, (
+By
+)s->
+bi_buf
+);
+
+3272 
+s
+->
+bi_buf
+ = 0;
+
+3273 
+s
+->
+bi_vid
+ = 0;
+
+3274 #ifde
+DEBUG_ZLIB
+
+
+3275 
+s
+->
+bs_
+ = (s->bits_sent+7) & ~7;
+
+3277 
+	}
+}
+
+3283 
+lol
+ 
+	$cy_block
+(
+dee_e
+ *
+s
+,
+
+3284 
+chf
+ *
+buf
+,
+
+3285 
+n
+,
+
+3286 
+hd
+)
+
+3288 
+	`bi_wdup
+(
+s
+);
+
+3289 
+s
+->
+_eob_n
+ = 8;
+
+3291 i(
+hd
+) {
+
+3292 
+	`put_sht
+(
+s
+, (
+ush
+)
+n
+);
+
+3293 
+	`put_sht
+(
+s
+, (
+ush
+)~
+n
+);
+
+3294 #ifde
+DEBUG_ZLIB
+
+
+3295 
+s
+->
+bs_
+ += 2*16;
+
+3298 #ifde
+DEBUG_ZLIB
+
+
+3299 
+s
+->
+bs_
+ +(
+ulg
+)
+n
+<<3;
+
+3302 
+	`zmemy
+(&
+s
+->
+ndg_buf
+[s->
+ndg
+], 
+buf
+, 
+n
+);
+
+3303 
+s
+->
+ndg
+ +
+n
+;
+
+3304 
+	}
+}
+
+3328 
+	ge_blocks_e
+;
+
+3329 
+e_blocks_e
+ 
+	tFAR
+ 
+	te_blocks_ef
+;
+
+3331 
+e_blocks_ef
+ * 
+e_blocks_w
+(
+
+3332 
+z_amp
+ 
+z
+,
+
+3333 
+check_func
+ 
+c
+,
+
+3334 
+uI
+ 
+w
+);
+
+3336 
+e_blocks
+(
+
+3337 
+e_blocks_ef
+ *,
+
+3338 
+z_amp
+ ,
+
+3341 
+e_blocks_t
+(
+
+3342 
+e_blocks_ef
+ *,
+
+3343 
+z_amp
+ ,
+
+3344 
+uLgf
+ *);
+
+3346 
+e_blocks_
+(
+
+3347 
+e_blocks_ef
+ *,
+
+3348 
+z_amp
+);
+
+3350 
+e_t_diiy
+(
+
+3351 
+e_blocks_ef
+ *
+s
+,
+
+3352 c 
+Byf
+ *
+d
+,
+
+3353 
+uI
+ 
+n
+);
+
+3355 
+e_blocks_sync_pot
+(
+
+3356 
+e_blocks_ef
+ *
+s
+);
+
+3357 
+e_addhiy
+(
+
+3358 
+e_blocks_ef
+ *,
+
+3359 
+z_amp
+);
+
+3361 
+e_ck_ush
+(
+
+3362 
+e_blocks_ef
+ *);
+
+3366 #ide
+NO_DUMMY_DECL
+
+
+3367 
+	se_blocks_e
+ {
+	mdummy
+;};
+
+3371 
+	mMETHOD
+,
+
+3372 
+	mFLAG
+,
+
+3373 
+	mDICT4
+,
+
+3374 
+	mDICT3
+,
+
+3375 
+	mDICT2
+,
+
+3376 
+	mDICT1
+,
+
+3377 
+	mDICT0
+,
+
+3378 
+	mBLOCKS
+,
+
+3379 
+	mCHECK4
+,
+
+3380 
+	mCHECK3
+,
+
+3381 
+	mCHECK2
+,
+
+3382 
+	mCHECK1
+,
+
+3383 
+	mDONE
+,
+
+3384 
+	mBAD
+}
+
+3385 
+	te_mode
+;
+
+3388 
+	s_e
+ {
+
+3391 
+e_mode
+ 
+	mmode
+;
+
+3395 
+uI
+ 
+	mmhod
+;
+
+3397 
+uLg
+ 
+	mwas
+;
+
+3398 
+uLg
+ 
+	med
+;
+
+3399 } 
+	mcheck
+;
+
+3400 
+uI
+ 
+	mmk
+;
+
+3401 } 
+	msub
+;
+
+3404 
+	mnowp
+;
+
+3405 
+uI
+ 
+	mwbs
+;
+
+3406 
+e_blocks_ef
+
+
+3407 *
+	mblocks
+;
+
+3412 
+ZEXPORT
+ 
+	$eRet
+(
+z_amp
+ 
+z
+)
+
+3414 i(
+z
+ =
+Z_NULL
+ || z->
+e
+ == Z_NULL)
+
+3415  
+Z_STREAM_ERROR
+;
+
+3416 
+z
+->
+t_
+ = z->
+t_out
+ = 0;
+
+3417 
+z
+->
+msg
+ = 
+Z_NULL
+;
+
+3418 
+z
+->
+e
+->
+mode
+ = z->e->
+nowp
+ ? 
+BLOCKS
+ : 
+METHOD
+;
+
+3419 
+	`e_blocks_t
+(
+z
+->
+e
+->
+blocks
+, z, 
+Z_NULL
+);
+
+3420 
+	`Tv
+((
+dr
+, "inflate:eset\n"));
+
+3421  
+Z_OK
+;
+
+3422 
+	}
+}
+
+3425 
+ZEXPORT
+ 
+	$eEnd
+(
+z_amp
+ 
+z
+)
+
+3427 i(
+z
+ =
+Z_NULL
+ || z->
+e
+ =Z_NULL || z->
+z
+ == Z_NULL)
+
+3428  
+Z_STREAM_ERROR
+;
+
+3429 i(
+z
+->
+e
+->
+blocks
+ !
+Z_NULL
+)
+
+3430 
+	`e_blocks_
+(
+z
+->
+e
+->
+blocks
+, z);
+
+3431 
+	`ZFREE
+(
+z
+, z->
+e
+);
+
+3432 
+z
+->
+e
+ = 
+Z_NULL
+;
+
+3433 
+	`Tv
+((
+dr
+, "inflate:nd\n"));
+
+3434  
+Z_OK
+;
+
+3435 
+	}
+}
+
+3438 
+ZEXPORT
+ 
+	$eIn2_
+(
+z_amp
+ 
+z
+, 
+w
+, c *
+vs
+, 
+am_size
+)
+
+3440 i(
+vs
+ =
+Z_NULL
+ || vs[0] !
+ZLIB_VERSION
+[0] ||
+
+3441 
+am_size
+ !(
+z_am
+))
+
+3442  
+Z_VERSION_ERROR
+;
+
+3445 i(
+z
+ =
+Z_NULL
+)
+
+3446  
+Z_STREAM_ERROR
+;
+
+3447 
+z
+->
+msg
+ = 
+Z_NULL
+;
+
+3448 #ide
+NO_ZCFUNCS
+
+
+3449 i(
+z
+->
+zloc
+ =
+Z_NULL
+)
+
+3451 
+z
+->
+zloc
+ = 
+zoc
+;
+
+3452 
+z
+->
+aque
+ = (
+voidpf
+)0;
+
+3454 i(
+z
+->
+z
+ =
+Z_NULL
+z->z = 
+zc
+;
+
+3456 i((
+z
+->
+e
+ = (
+_e
+ 
+FAR
+ *)
+
+3457 
+	`ZALLOC
+(
+z
+,1,(
+_e
+))=
+Z_NULL
+)
+
+3458  
+Z_MEM_ERROR
+;
+
+3459 
+z
+->
+e
+->
+blocks
+ = 
+Z_NULL
+;
+
+3462 
+z
+->
+e
+->
+nowp
+ = 0;
+
+3463 i(
+w
+ < 0)
+
+3465 
+w
+ = - w;
+
+3466 
+z
+->
+e
+->
+nowp
+ = 1;
+
+3470 i(
+w
+ < 8 || w > 15)
+
+3472 
+	`eEnd
+(
+z
+);
+
+3473  
+Z_STREAM_ERROR
+;
+
+3475 
+z
+->
+e
+->
+wbs
+ = (
+uI
+)
+w
+;
+
+3478 i((
+z
+->
+e
+->
+blocks
+ =
+
+3479 
+	`e_blocks_w
+(
+z
+, z->
+e
+->
+nowp
+ ? 
+Z_NULL
+ : 
+adr32
+, (
+uI
+)1 << 
+w
+))
+
+3480 =
+Z_NULL
+)
+
+3482 
+	`eEnd
+(
+z
+);
+
+3483  
+Z_MEM_ERROR
+;
+
+3485 
+	`Tv
+((
+dr
+, "inflate:llocated\n"));
+
+3488 
+	`eRet
+(
+z
+);
+
+3489  
+Z_OK
+;
+
+3490 
+	}
+}
+
+3494 
+ZEXPORT
+ 
+	$eIn_
+(
+z_amp
+ 
+z
+, c *
+vs
+, 
+am_size
+)
+
+3496  
+	`eIn2_
+(
+z
+, 
+DEF_WBITS
+, 
+vs
+, 
+am_size
+);
+
+3497 
+	}
+}
+
+3501 
+	#NEEDBYTE
+ {if(
+z
+->
+ava_
+==0)
+emy
+;
+r
+=
+Z_OK
+;}
+
+	)
+
+3502 
+	#NEXTBYTE
+ (
+z
+->
+ava_
+--,z->
+t_
+++,*z->
+xt_
+++)
+
+	)
+
+3504 
+ZEXPORT
+ 
+	$e
+(
+z_amp
+ 
+z
+, 
+f
+)
+
+3506 
+r
+, 
+r2
+;
+
+3507 
+uI
+ 
+b
+;
+
+3509 i(
+z
+ =
+Z_NULL
+ || z->
+e
+ =Z_NULL || z->
+xt_
+ == Z_NULL)
+
+3510  
+Z_STREAM_ERROR
+;
+
+3511 
+r2
+ = 
+f
+ =
+Z_FINISH
+ ? 
+Z_BUF_ERROR
+ : 
+Z_OK
+;
+
+3512 
+r
+ = 
+Z_BUF_ERROR
+;
+
+3513 1
+z
+->
+e
+->
+mode
+)
+
+3515 
+METHOD
+:
+
+3516 
+NEEDBYTE
+
+
+3517 i(((
+z
+->
+e
+->
+sub
+.
+mhod
+ = 
+NEXTBYTE
+& 0xf!
+Z_DEFLATED
+)
+
+3519 
+z
+->
+e
+->
+mode
+ = 
+BAD
+;
+
+3520 
+z
+->
+msg
+ = "unknown compression method";
+
+3521 
+z
+->
+e
+->
+sub
+.
+mk
+ = 5;
+
+3524 i((
+z
+->
+e
+->
+sub
+.
+mhod
+ >> 4+ 8 > z->e->
+wbs
+)
+
+3526 
+z
+->
+e
+->
+mode
+ = 
+BAD
+;
+
+3527 
+z
+->
+msg
+ = "invalid window size";
+
+3528 
+z
+->
+e
+->
+sub
+.
+mk
+ = 5;
+
+3531 
+z
+->
+e
+->
+mode
+ = 
+FLAG
+;
+
+3532 
+FLAG
+:
+
+3533 
+NEEDBYTE
+
+
+3534 
+b
+ = 
+NEXTBYTE
+;
+
+3535 i(((
+z
+->
+e
+->
+sub
+.
+mhod
+ << 8+ 
+b
+) % 31)
+
+3537 
+z
+->
+e
+->
+mode
+ = 
+BAD
+;
+
+3538 
+z
+->
+msg
+ = "incorrect header check";
+
+3539 
+z
+->
+e
+->
+sub
+.
+mk
+ = 5;
+
+3542 
+	`Tv
+((
+dr
+, "inflate: zlib header ok\n"));
+
+3543 i(!(
+b
+ & 
+PRESET_DICT
+))
+
+3545 
+z
+->
+e
+->
+mode
+ = 
+BLOCKS
+;
+
+3548 
+z
+->
+e
+->
+mode
+ = 
+DICT4
+;
+
+3549 
+DICT4
+:
+
+3550 
+NEEDBYTE
+
+
+3551 
+z
+->
+e
+->
+sub
+.
+check
+.
+ed
+ = (
+uLg
+)
+NEXTBYTE
+ << 24;
+
+3552 
+z
+->
+e
+->
+mode
+ = 
+DICT3
+;
+
+3553 
+DICT3
+:
+
+3554 
+NEEDBYTE
+
+
+3555 
+z
+->
+e
+->
+sub
+.
+check
+.
+ed
+ +(
+uLg
+)
+NEXTBYTE
+ << 16;
+
+3556 
+z
+->
+e
+->
+mode
+ = 
+DICT2
+;
+
+3557 
+DICT2
+:
+
+3558 
+NEEDBYTE
+
+
+3559 
+z
+->
+e
+->
+sub
+.
+check
+.
+ed
+ +(
+uLg
+)
+NEXTBYTE
+ << 8;
+
+3560 
+z
+->
+e
+->
+mode
+ = 
+DICT1
+;
+
+3561 
+DICT1
+:
+
+3562 
+NEEDBYTE
+
+
+3563 
+z
+->
+e
+->
+sub
+.
+check
+.
+ed
+ +(
+uLg
+)
+NEXTBYTE
+;
+
+3564 
+z
+->
+adr
+ = z->
+e
+->
+sub
+.
+check
+.
+ed
+;
+
+3565 
+z
+->
+e
+->
+mode
+ = 
+DICT0
+;
+
+3566  
+Z_NEED_DICT
+;
+
+3567 
+DICT0
+:
+
+3568 
+z
+->
+e
+->
+mode
+ = 
+BAD
+;
+
+3569 
+z
+->
+msg
+ = "need dictionary";
+
+3570 
+z
+->
+e
+->
+sub
+.
+mk
+ = 0;
+
+3571  
+Z_STREAM_ERROR
+;
+
+3572 
+BLOCKS
+:
+
+3573 
+r
+ = 
+	`e_blocks
+(
+z
+->
+e
+->
+blocks
+, z,);
+
+3574 i(
+f
+ =
+Z_PACKET_FLUSH
+ && 
+z
+->
+ava_
+ =0 && z->
+ava_out
+ != 0)
+
+3575 
+r
+ = 
+	`e_ck_ush
+(
+z
+->
+e
+->
+blocks
+);
+
+3576 i(
+r
+ =
+Z_DATA_ERROR
+)
+
+3578 
+z
+->
+e
+->
+mode
+ = 
+BAD
+;
+
+3579 
+z
+->
+e
+->
+sub
+.
+mk
+ = 0;
+
+3582 i(
+r
+ =
+Z_OK
+)
+
+3583 
+r
+ = 
+r2
+;
+
+3584 i(
+r
+ !
+Z_STREAM_END
+)
+
+3585  
+r
+;
+
+3586 
+r
+ = 
+r2
+;
+
+3587 
+	`e_blocks_t
+(
+z
+->
+e
+->
+blocks
+, z, &z->e->
+sub
+.
+check
+.
+was
+);
+
+3588 i(
+z
+->
+e
+->
+nowp
+)
+
+3590 
+z
+->
+e
+->
+mode
+ = 
+DONE
+;
+
+3593 
+z
+->
+e
+->
+mode
+ = 
+CHECK4
+;
+
+3594 
+CHECK4
+:
+
+3595 
+NEEDBYTE
+
+
+3596 
+z
+->
+e
+->
+sub
+.
+check
+.
+ed
+ = (
+uLg
+)
+NEXTBYTE
+ << 24;
+
+3597 
+z
+->
+e
+->
+mode
+ = 
+CHECK3
+;
+
+3598 
+CHECK3
+:
+
+3599 
+NEEDBYTE
+
+
+3600 
+z
+->
+e
+->
+sub
+.
+check
+.
+ed
+ +(
+uLg
+)
+NEXTBYTE
+ << 16;
+
+3601 
+z
+->
+e
+->
+mode
+ = 
+CHECK2
+;
+
+3602 
+CHECK2
+:
+
+3603 
+NEEDBYTE
+
+
+3604 
+z
+->
+e
+->
+sub
+.
+check
+.
+ed
+ +(
+uLg
+)
+NEXTBYTE
+ << 8;
+
+3605 
+z
+->
+e
+->
+mode
+ = 
+CHECK1
+;
+
+3606 
+CHECK1
+:
+
+3607 
+NEEDBYTE
+
+
+3608 
+z
+->
+e
+->
+sub
+.
+check
+.
+ed
+ +(
+uLg
+)
+NEXTBYTE
+;
+
+3610 i(
+z
+->
+e
+->
+sub
+.
+check
+.
+was
+ !z->e->sub.check.
+ed
+)
+
+3612 
+z
+->
+e
+->
+mode
+ = 
+BAD
+;
+
+3613 
+z
+->
+msg
+ = "incorrect data check";
+
+3614 
+z
+->
+e
+->
+sub
+.
+mk
+ = 5;
+
+3617 
+	`Tv
+((
+dr
+, "inflate: zlib check ok\n"));
+
+3618 
+z
+->
+e
+->
+mode
+ = 
+DONE
+;
+
+3619 
+DONE
+:
+
+3620  
+Z_STREAM_END
+;
+
+3621 
+BAD
+:
+
+3622  
+Z_DATA_ERROR
+;
+
+3624  
+Z_STREAM_ERROR
+;
+
+3626 
+emy
+:
+
+3627 i(
+f
+ !
+Z_PACKET_FLUSH
+)
+
+3628  
+r
+;
+
+3629 
+z
+->
+e
+->
+mode
+ = 
+BAD
+;
+
+3630 
+z
+->
+msg
+ = "need more foracket flush";
+
+3631 
+z
+->
+e
+->
+sub
+.
+mk
+ = 0;
+
+3632  
+Z_DATA_ERROR
+;
+
+3633 
+	}
+}
+
+3637 
+ZEXPORT
+ 
+	$eSDiiy
+(
+z_amp
+ 
+z
+,
+
+3638 c 
+Byf
+ *
+diiy
+,
+
+3639 
+uI
+ 
+diLgth
+)
+
+3641 
+uI
+ 
+ngth
+ = 
+diLgth
+;
+
+3643 i(
+z
+ =
+Z_NULL
+ || z->
+e
+ =Z_NULL || z->e->
+mode
+ !
+DICT0
+)
+
+3644  
+Z_STREAM_ERROR
+;
+
+3646 i(
+	`adr32
+(1L, 
+diiy
+, 
+diLgth
+!
+z
+->
+adr
+ 
+Z_DATA_ERROR
+;
+
+3647 
+z
+->
+adr
+ = 1L;
+
+3649 i(
+ngth
+ >((
+uI
+)1<<
+z
+->
+e
+->
+wbs
+))
+
+3651 
+ngth
+ = (1<<
+z
+->
+e
+->
+wbs
+)-1;
+
+3652 
+diiy
+ +
+diLgth
+ - 
+ngth
+;
+
+3654 
+	`e_t_diiy
+(
+z
+->
+e
+->
+blocks
+, 
+diiy
+, 
+ngth
+);
+
+3655 
+z
+->
+e
+->
+mode
+ = 
+BLOCKS
+;
+
+3656  
+Z_OK
+;
+
+3657 
+	}
+}
+
+3669 
+	$eIncomp
+(
+z_am
+ *
+z
+)
+
+3671 i(
+z
+->
+e
+->
+mode
+ !
+BLOCKS
+)
+
+3672  
+Z_DATA_ERROR
+;
+
+3673  
+	`e_addhiy
+(
+z
+->
+e
+->
+blocks
+, z);
+
+3674 
+	}
+}
+
+3677 
+ZEXPORT
+ 
+	$eSync
+(
+z
+)
+
+3678 
+z_amp
+ 
+z
+;
+
+3680 
+uI
+ 
+n
+;
+
+3681 
+Byf
+ *
+p
+;
+
+3682 
+uI
+ 
+m
+;
+
+3683 
+uLg
+ 
+r
+, 
+w
+;
+
+3686 i(
+z
+ =
+Z_NULL
+ || z->
+e
+ == Z_NULL)
+
+3687  
+Z_STREAM_ERROR
+;
+
+3688 i(
+z
+->
+e
+->
+mode
+ !
+BAD
+)
+
+3690 
+z
+->
+e
+->
+mode
+ = 
+BAD
+;
+
+3691 
+z
+->
+e
+->
+sub
+.
+mk
+ = 0;
+
+3693 i((
+n
+ = 
+z
+->
+ava_
+) == 0)
+
+3694  
+Z_BUF_ERROR
+;
+
+3695 
+p
+ = 
+z
+->
+xt_
+;
+
+3696 
+m
+ = 
+z
+->
+e
+->
+sub
+.
+mk
+;
+
+3699 
+n
+ && 
+m
+ < 4)
+
+3701 c 
+By
+ 
+mk
+[4] = {0, 0, 0xff, 0xff};
+
+3702 i(*
+p
+ =
+mk
+[
+m
+])
+
+3703 
+m
+++;
+
+3704 i(*
+p
+)
+
+3705 
+m
+ = 0;
+
+3707 
+m
+ = 4 - m;
+
+3708 
+p
+++, 
+n
+--;
+
+3712 
+z
+->
+t_
+ +
+p
+ - z->
+xt_
+;
+
+3713 
+z
+->
+xt_
+ = 
+p
+;
+
+3714 
+z
+->
+ava_
+ = 
+n
+;
+
+3715 
+z
+->
+e
+->
+sub
+.
+mk
+ = 
+m
+;
+
+3718 i(
+m
+ != 4)
+
+3719  
+Z_DATA_ERROR
+;
+
+3720 
+r
+ = 
+z
+->
+t_
+; 
+w
+ = z->
+t_out
+;
+
+3721 
+	`eRet
+(
+z
+);
+
+3722 
+z
+->
+t_
+ = 
+r
+; z->
+t_out
+ = 
+w
+;
+
+3723 
+z
+->
+e
+->
+mode
+ = 
+BLOCKS
+;
+
+3724  
+Z_OK
+;
+
+3725 
+	}
+}
+
+3737 
+ZEXPORT
+ 
+	$eSyncPot
+(
+z
+)
+
+3738 
+z_amp
+ 
+z
+;
+
+3740 i(
+z
+ =
+Z_NULL
+ || z->
+e
+ =Z_NULL || z->e->
+blocks
+ == Z_NULL)
+
+3741  
+Z_STREAM_ERROR
+;
+
+3742  
+	`e_blocks_sync_pot
+(
+z
+->
+e
+->
+blocks
+);
+
+3743 
+	}
+}
+
+3745 #unde
+NEEDBYTE
+
+
+3746 #unde
+NEXTBYTE
+
+
+3774 
+e_hu_s
+ 
+	tFAR
+ 
+	te_hu
+;
+
+3776 
+	se_hu_s
+ {
+
+3779 
+By
+ 
+	mEx
+;
+
+3780 
+By
+ 
+	mBs
+;
+
+3781 } 
+	mwh
+;
+
+3782 
+uI
+ 
+	md
+;
+
+3783 } 
+	mwd
+;
+
+3784 
+uI
+ 
+	mba
+;
+
+3793 
+	#MANY
+ 1440
+
+	)
+
+3795 
+e_s_bs
+(
+
+3796 
+uIf
+ *,
+
+3797 
+uIf
+ *,
+
+3798 
+e_hu
+ * 
+FAR
+ *,
+
+3799 
+e_hu
+ *,
+
+3800 
+z_amp
+);
+
+3802 
+e_s_dymic
+(
+
+3803 
+uI
+,
+
+3804 
+uI
+,
+
+3805 
+uIf
+ *,
+
+3806 
+uIf
+ *,
+
+3807 
+uIf
+ *,
+
+3808 
+e_hu
+ * 
+FAR
+ *,
+
+3809 
+e_hu
+ * 
+FAR
+ *,
+
+3810 
+e_hu
+ *,
+
+3811 
+z_amp
+);
+
+3813 
+e_s_fixed
+(
+
+3814 
+uIf
+ *,
+
+3815 
+uIf
+ *,
+
+3816 
+e_hu
+ * 
+FAR
+ *,
+
+3817 
+e_hu
+ * 
+FAR
+ *,
+
+3818 
+z_amp
+);
+
+3833 
+	ge_codes_e
+;
+
+3834 
+e_codes_e
+ 
+	tFAR
+ 
+	te_codes_ef
+;
+
+3836 
+e_codes_ef
+ *
+e_codes_w
+(
+
+3837 
+uI
+, uInt,
+
+3838 
+e_hu
+ *, inflate_huft *,
+
+3839 
+z_amp
+ );
+
+3841 
+e_codes
+(
+
+3842 
+e_blocks_ef
+ *,
+
+3843 
+z_amp
+ ,
+
+3846 
+e_codes_
+(
+
+3847 
+e_codes_ef
+ *,
+
+3848 
+z_amp
+ );
+
+3864 #ide
+_INFUTIL_H
+
+
+3865 
+	#_INFUTIL_H
+
+
+	)
+
+3868 
+	mTYPE
+,
+
+3869 
+	mLENS
+,
+
+3870 
+	mSTORED
+,
+
+3871 
+	mTABLE
+,
+
+3872 
+	mBTREE
+,
+
+3873 
+	mDTREE
+,
+
+3874 
+	mCODES
+,
+
+3875 
+	mDRY
+,
+
+3876 
+	mDONEB
+,
+
+3877 
+	mBADB
+}
+
+3878 
+	te_block_mode
+;
+
+3881 
+	se_blocks_e
+ {
+
+3884 
+e_block_mode
+ 
+	mmode
+;
+
+3888 
+uI
+ 
+	m
+;
+
+3890 
+uI
+ 
+	mb
+;
+
+3891 
+uI
+ 
+	mdex
+;
+
+3892 
+uIf
+ *
+	mbns
+;
+
+3893 
+uI
+ 
+	mbb
+;
+
+3894 
+e_hu
+ *
+	mtb
+;
+
+3895 } 
+	ms
+;
+
+3897 
+e_codes_ef
+
+
+3898 *
+	mcodes
+;
+
+3899 } 
+	mdecode
+;
+
+3900 } 
+	msub
+;
+
+3901 
+uI
+ 
+	m
+;
+
+3904 
+uI
+ 
+	mbk
+;
+
+3905 
+uLg
+ 
+	mbb
+;
+
+3906 
+e_hu
+ *
+	mhus
+;
+
+3907 
+Byf
+ *
+	mwdow
+;
+
+3908 
+Byf
+ *
+	md
+;
+
+3909 
+Byf
+ *
+	mad
+;
+
+3910 
+Byf
+ *
+	mwre
+;
+
+3911 
+check_func
+ 
+	mcheck
+;
+
+3912 
+uLg
+ 
+	mcheck
+;
+
+3919 
+	#UPDBITS
+ {
+s
+->
+bb
+=
+b
+;s->
+bk
+=
+k
+;}
+
+	)
+
+3920 
+	#UPDIN
+ {
+z
+->
+ava_
+=
+n
+;z->
+t_
++=
+p
+-z->
+xt_
+;z->xt_;}
+
+	)
+
+3921 
+	#UPDOUT
+ {
+s
+->
+wre
+=
+q
+;}
+
+	)
+
+3922 
+	#UPDATE
+ {
+UPDBITS
+ 
+UPDIN
+ 
+UPDOUT
+}
+
+	)
+
+3923 
+	#LEAVE
+ {
+UPDATE
+  
+	`e_ush
+(
+s
+,
+z
+,
+r
+);}
+
+	)
+
+3925 
+	#LOADIN
+ {
+p
+=
+z
+->
+xt_
+;
+n
+=z->
+ava_
+;
+b
+=
+s
+->
+bb
+;
+k
+=s->
+bk
+;}
+
+	)
+
+3926 
+	#NEEDBYTE
+ {if(
+n
+)
+r
+=
+Z_OK
+;
+LEAVE
+}
+
+	)
+
+3927 
+	#NEXTBYTE
+ (
+n
+--,*
+p
+++)
+
+	)
+
+3928 
+	#NEEDBITS
+(
+j
+{
+k
+<(j)){
+NEEDBYTE
+;
+b
+|=((
+uLg
+)
+NEXTBYTE
+)<<k;k+=8;}}
+
+	)
+
+3929 
+	#DUMPBITS
+(
+j
+{
+b
+>>=(j);
+k
+-=(j);}
+
+	)
+
+3931 
+	#WAVAIL
+ (
+uI
+)(
+q
+<
+s
+->
+ad
+?s->ad-q-1:s->
+d
+-q)
+
+	)
+
+3932 
+	#LOADOUT
+ {
+q
+=
+s
+->
+wre
+;
+m
+=(
+uI
+)
+WAVAIL
+;}
+
+	)
+
+3933 
+	#WRAP
+ {if(
+q
+==
+s
+->
+d
+&&s->
+ad
+!=s->
+wdow
+){q=s->wdow;
+m
+=(
+uI
+)
+WAVAIL
+;}}
+
+	)
+
+3934 
+	#FLUSH
+ {
+UPDOUT
+ 
+r
+=
+	`e_ush
+(
+s
+,
+z
+,r); 
+LOADOUT
+}
+
+	)
+
+3935 
+	#NEEDOUT
+ {if(
+m
+==0){
+WRAP
+ if(m==0){
+FLUSH
+ WRAP if(m==0
+LEAVE
+}}
+r
+=
+Z_OK
+;}
+
+	)
+
+3936 
+	#OUTBYTE
+(
+a
+{*
+q
+++=(
+By
+));
+m
+--;}
+
+	)
+
+3938 
+	#LOAD
+ {
+LOADIN
+ 
+LOADOUT
+}
+
+	)
+
+3941 
+uI
+ 
+e_mask
+[17];
+
+3944 
+e_ush
+(
+
+3945 
+e_blocks_ef
+ *,
+
+3946 
+z_amp
+ ,
+
+3949 #ide
+NO_DUMMY_DECL
+
+
+3950 
+	s_e
+ {
+	mdummy
+;};
+
+3956 #ide
+NO_DUMMY_DECL
+
+
+3957 
+	se_codes_e
+ {
+	mdummy
+;};
+
+3961 
+	#ex
+ 
+wd
+.
+wh
+.
+Ex
+
+
+	)
+
+3962 
+	#bs
+ 
+wd
+.
+wh
+.
+Bs
+
+
+	)
+
+3965 
+lol
+ c 
+uI
+ 
+	gbd
+[] = {
+
+4014 
+	$e_blocks_t
+(
+e_blocks_ef
+ *
+s
+, 
+z_amp
+ 
+z
+, 
+uLgf
+ *
+c
+)
+
+4016 i(
+c
+ !
+Z_NULL
+)
+
+4017 *
+c
+ = 
+s
+->
+check
+;
+
+4018 i(
+s
+->
+mode
+ =
+BTREE
+ || s->mod=
+DTREE
+)
+
+4019 
+	`ZFREE
+(
+z
+, 
+s
+->
+sub
+.
+s
+.
+bns
+);
+
+4020 i(
+s
+->
+mode
+ =
+CODES
+)
+
+4021 
+	`e_codes_
+(
+s
+->
+sub
+.
+decode
+.
+codes
+, 
+z
+);
+
+4022 
+s
+->
+mode
+ = 
+TYPE
+;
+
+4023 
+s
+->
+bk
+ = 0;
+
+4024 
+s
+->
+bb
+ = 0;
+
+4025 
+s
+->
+ad
+ = s->
+wre
+ = s->
+wdow
+;
+
+4026 i(
+s
+->
+check
+ !
+Z_NULL
+)
+
+4027 
+z
+->
+adr
+ = 
+s
+->
+check
+ = (*s->
+check
+)(0L, (c 
+Byf
+ *)
+Z_NULL
+, 0);
+
+4028 
+	`Tv
+((
+dr
+, "inflate: blockseset\n"));
+
+4029 
+	}
+}
+
+4032 
+e_blocks_ef
+ *
+	$e_blocks_w
+(
+z_amp
+ 
+z
+, 
+check_func
+ 
+c
+, 
+uI
+ 
+w
+)
+
+4034 
+e_blocks_ef
+ *
+s
+;
+
+4036 i((
+s
+ = (
+e_blocks_ef
+ *)
+ZALLOC
+
+
+4037 (
+z
+,1,(
+e_blocks_e
+))=
+Z_NULL
+)
+
+4038  
+s
+;
+
+4039 i((
+s
+->
+hus
+ =
+
+4040 (
+e_hu
+ *)
+	`ZALLOC
+(
+z
+, (e_hu), 
+MANY
+)=
+Z_NULL
+)
+
+4042 
+	`ZFREE
+(
+z
+, 
+s
+);
+
+4043  
+Z_NULL
+;
+
+4045 i((
+s
+->
+wdow
+ = (
+Byf
+ *)
+	`ZALLOC
+(
+z
+, 1, 
+w
+)=
+Z_NULL
+)
+
+4047 
+	`ZFREE
+(
+z
+, 
+s
+->
+hus
+);
+
+4048 
+	`ZFREE
+(
+z
+, 
+s
+);
+
+4049  
+Z_NULL
+;
+
+4051 
+s
+->
+d
+ = s->
+wdow
+ + 
+w
+;
+
+4052 
+s
+->
+check
+ = 
+c
+;
+
+4053 
+s
+->
+mode
+ = 
+TYPE
+;
+
+4054 
+	`Tv
+((
+dr
+, "inflate: blocksllocated\n"));
+
+4055 
+	`e_blocks_t
+(
+s
+, 
+z
+, 
+Z_NULL
+);
+
+4056  
+s
+;
+
+4057 
+	}
+}
+
+4060 
+	$e_blocks
+(
+e_blocks_ef
+ *
+s
+, 
+z_amp
+ 
+z
+, 
+r
+)
+
+4062 
+uI
+ 
+t
+;
+
+4063 
+uLg
+ 
+b
+;
+
+4064 
+uI
+ 
+k
+;
+
+4065 
+Byf
+ *
+p
+;
+
+4066 
+uI
+ 
+n
+;
+
+4067 
+Byf
+ *
+q
+;
+
+4068 
+uI
+ 
+m
+;
+
+4071 
+LOAD
+
+
+4074 1
+s
+->
+mode
+)
+
+4076 
+TYPE
+:
+
+4077 
+	`NEEDBITS
+(3)
+
+4078 
+t
+ = (
+uI
+)
+b
+ & 7;
+
+4079 
+s
+->
+
+ = 
+t
+ & 1;
+
+4080 
+t
+ >> 1)
+
+4083 
+	`Tv
+((
+dr
+, "inflate: stored block%s\n",
+
+4084 
+s
+->
+
+ ? " (last)" : ""));
+
+4085 
+	`DUMPBITS
+(3)
+
+4086 
+t
+ = 
+k
+ & 7;
+
+4087 
+	`DUMPBITS
+(
+t
+)
+
+4088 
+s
+->
+mode
+ = 
+LENS
+;
+
+4091 
+	`Tv
+((
+dr
+, "inflate: fixed codes block%s\n",
+
+4092 
+s
+->
+
+ ? " (last)" : ""));
+
+4094 
+uI
+ 
+bl
+, 
+bd
+;
+
+4095 
+e_hu
+ *
+
+, *
+td
+;
+
+4097 
+	`e_s_fixed
+(&
+bl
+, &
+bd
+, &
+
+, &
+td
+, 
+z
+);
+
+4098 
+s
+->
+sub
+.
+decode
+.
+codes
+ = 
+	`e_codes_w
+(
+bl
+, 
+bd
+, 
+
+, 
+td
+, 
+z
+);
+
+4099 i(
+s
+->
+sub
+.
+decode
+.
+codes
+ =
+Z_NULL
+)
+
+4101 
+r
+ = 
+Z_MEM_ERROR
+;
+
+4102 
+LEAVE
+
+
+4105 
+	`DUMPBITS
+(3)
+
+4106 
+s
+->
+mode
+ = 
+CODES
+;
+
+4109 
+	`Tv
+((
+dr
+, "inflate: dynamic codes block%s\n",
+
+4110 
+s
+->
+
+ ? " (last)" : ""));
+
+4111 
+	`DUMPBITS
+(3)
+
+4112 
+s
+->
+mode
+ = 
+TABLE
+;
+
+4115 
+	`DUMPBITS
+(3)
+
+4116 
+s
+->
+mode
+ = 
+BADB
+;
+
+4117 
+z
+->
+msg
+ = "invalid blockype";
+
+4118 
+r
+ = 
+Z_DATA_ERROR
+;
+
+4119 
+LEAVE
+
+
+4122 
+LENS
+:
+
+4123 
+	`NEEDBITS
+(32)
+
+4124 i((((~
+b
+) >> 16) & 0xffff) != (b & 0xffff))
+
+4126 
+s
+->
+mode
+ = 
+BADB
+;
+
+4127 
+z
+->
+msg
+ = "invalid stored blockengths";
+
+4128 
+r
+ = 
+Z_DATA_ERROR
+;
+
+4129 
+LEAVE
+
+
+4131 
+s
+->
+sub
+.
+
+ = (
+uI
+)
+b
+ & 0xffff;
+
+4132 
+b
+ = 
+k
+ = 0;
+
+4133 
+	`Tv
+((
+dr
+, "e: stedgth %u\n", 
+s
+->
+sub
+.
+
+));
+
+4134 
+s
+->
+mode
+ = s->
+sub
+.
+
+ ? 
+STORED
+ : (s->
+
+ ? 
+DRY
+ : 
+TYPE
+);
+
+4136 
+STORED
+:
+
+4137 i(
+n
+ == 0)
+
+4138 
+LEAVE
+
+
+4139 
+NEEDOUT
+
+
+4140 
+t
+ = 
+s
+->
+sub
+.
+
+;
+
+4141 i(
+t
+ > 
+n
+) =;
+
+4142 i(
+t
+ > 
+m
+) = m;
+
+4143 
+	`zmemy
+(
+q
+, 
+p
+, 
+t
+);
+
+4144 
+p
+ +
+t
+; 
+n
+ -=;
+
+4145 
+q
+ +
+t
+; 
+m
+ -=;
+
+4146 i((
+s
+->
+sub
+.
+
+ -
+t
+) != 0)
+
+4148 
+	`Tv
+((
+dr
+, "inflate: storednd, %luotal out\n",
+
+4149 
+z
+->
+t_out
+ + (
+q
+ >
+s
+->
+ad
+ ? q - s->read :
+
+4150 (
+s
+->
+d
+ - s->
+ad
++ (
+q
+ - s->
+wdow
+))));
+
+4151 
+s
+->
+mode
+ = s->
+
+ ? 
+DRY
+ : 
+TYPE
+;
+
+4153 
+TABLE
+:
+
+4154 
+	`NEEDBITS
+(14)
+
+4155 
+s
+->
+sub
+.
+s
+.
+b
+ = 
+t
+ = (
+uI
+)
+b
+ & 0x3fff;
+
+4156 #ide
+PKZIP_BUG_WORKAROUND
+
+
+4157 i((
+t
+ & 0x1f) > 29 || ((t >> 5) & 0x1f) > 29)
+
+4159 
+s
+->
+mode
+ = 
+BADB
+;
+
+4160 
+z
+->
+msg
+ = "too manyength or distance symbols";
+
+4161 
+r
+ = 
+Z_DATA_ERROR
+;
+
+4162 
+LEAVE
+
+
+4165 
+t
+ = 258 + (t & 0x1f) + ((t >> 5) & 0x1f);
+
+4166 i((
+s
+->
+sub
+.
+s
+.
+bns
+ = (
+uIf
+*)
+	`ZALLOC
+(
+z
+, 
+t
+, (
+uI
+))=
+Z_NULL
+)
+
+4168 
+r
+ = 
+Z_MEM_ERROR
+;
+
+4169 
+LEAVE
+
+
+4171 
+	`DUMPBITS
+(14)
+
+4172 
+s
+->
+sub
+.
+s
+.
+dex
+ = 0;
+
+4173 
+	`Tv
+((
+dr
+, "inflate:able sizes ok\n"));
+
+4174 
+s
+->
+mode
+ = 
+BTREE
+;
+
+4175 
+BTREE
+:
+
+4176 
+s
+->
+sub
+.
+s
+.
+dex
+ < 4 + (s->sub.s.
+b
+ >> 10))
+
+4178 
+	`NEEDBITS
+(3)
+
+4179 
+s
+->
+sub
+.
+s
+.
+bns
+[
+bd
+[s->sub.s.
+dex
+++]] = (
+uI
+)
+b
+ & 7;
+
+4180 
+	`DUMPBITS
+(3)
+
+4182 
+s
+->
+sub
+.
+s
+.
+dex
+ < 19)
+
+4183 
+s
+->
+sub
+.
+s
+.
+bns
+[
+bd
+[s->sub.s.
+dex
+++]] = 0;
+
+4184 
+s
+->
+sub
+.
+s
+.
+bb
+ = 7;
+
+4185 
+t
+ = 
+	`e_s_bs
+(
+s
+->
+sub
+.
+s
+.
+bns
+, &s->sub.s.
+bb
+,
+
+4186 &
+s
+->
+sub
+.
+s
+.
+tb
+, s->
+hus
+, 
+z
+);
+
+4187 i(
+t
+ !
+Z_OK
+)
+
+4189 
+r
+ = 
+t
+;
+
+4190 i(
+r
+ =
+Z_DATA_ERROR
+)
+
+4192 
+	`ZFREE
+(
+z
+, 
+s
+->
+sub
+.
+s
+.
+bns
+);
+
+4193 
+s
+->
+mode
+ = 
+BADB
+;
+
+4195 
+LEAVE
+
+
+4197 
+s
+->
+sub
+.
+s
+.
+dex
+ = 0;
+
+4198 
+	`Tv
+((
+dr
+, "inflate: bitsree ok\n"));
+
+4199 
+s
+->
+mode
+ = 
+DTREE
+;
+
+4200 
+DTREE
+:
+
+4201 
+t
+ = 
+s
+->
+sub
+.
+s
+.
+b
+,
+
+4202 
+s
+->
+sub
+.
+s
+.
+dex
+ < 258 + (
+t
+ & 0x1f) + ((t >> 5) & 0x1f))
+
+4204 
+e_hu
+ *
+h
+;
+
+4205 
+uI
+ 
+i
+, 
+j
+, 
+c
+;
+
+4207 
+t
+ = 
+s
+->
+sub
+.
+s
+.
+bb
+;
+
+4208 
+	`NEEDBITS
+(
+t
+)
+
+4209 
+h
+ = 
+s
+->
+sub
+.
+s
+.
+tb
+ + ((
+uI
+)
+b
+ & 
+e_mask
+[
+t
+]);
+
+4210 
+t
+ = 
+h
+->
+bs
+;
+
+4211 
+c
+ = 
+h
+->
+ba
+;
+
+4212 i(
+c
+ < 16)
+
+4214 
+	`DUMPBITS
+(
+t
+)
+
+4215 
+s
+->
+sub
+.
+s
+.
+bns
+[s->sub.s.
+dex
+++] = 
+c
+;
+
+4219 
+i
+ = 
+c
+ == 18 ? 7 : c - 14;
+
+4220 
+j
+ = 
+c
+ == 18 ? 11 : 3;
+
+4221 
+	`NEEDBITS
+(
+t
+ + 
+i
+)
+
+4222 
+	`DUMPBITS
+(
+t
+)
+
+4223 
+j
+ +(
+uI
+)
+b
+ & 
+e_mask
+[
+i
+];
+
+4224 
+	`DUMPBITS
+(
+i
+)
+
+4225 
+i
+ = 
+s
+->
+sub
+.
+s
+.
+dex
+;
+
+4226 
+t
+ = 
+s
+->
+sub
+.
+s
+.
+b
+;
+
+4227 i(
+i
+ + 
+j
+ > 258 + (
+t
+ & 0x1f) + ((t >> 5) & 0x1f) ||
+
+4228 (
+c
+ =16 && 
+i
+ < 1))
+
+4230 
+	`ZFREE
+(
+z
+, 
+s
+->
+sub
+.
+s
+.
+bns
+);
+
+4231 
+s
+->
+mode
+ = 
+BADB
+;
+
+4232 
+z
+->
+msg
+ = "invalid bitengthepeat";
+
+4233 
+r
+ = 
+Z_DATA_ERROR
+;
+
+4234 
+LEAVE
+
+
+4236 
+c
+ = c =16 ? 
+s
+->
+sub
+.
+s
+.
+bns
+[
+i
+ - 1] : 0;
+
+4238 
+s
+->
+sub
+.
+s
+.
+bns
+[
+i
+++] = 
+c
+;
+
+4239 } --
+j
+);
+
+4240 
+s
+->
+sub
+.
+s
+.
+dex
+ = 
+i
+;
+
+4243 
+s
+->
+sub
+.
+s
+.
+tb
+ = 
+Z_NULL
+;
+
+4245 
+uI
+ 
+bl
+, 
+bd
+;
+
+4246 
+e_hu
+ *
+
+, *
+td
+;
+
+4247 
+e_codes_ef
+ *
+c
+;
+
+4249 
+bl
+ = 9;
+
+4250 
+bd
+ = 6;
+
+4251 
+t
+ = 
+s
+->
+sub
+.
+s
+.
+b
+;
+
+4252 
+t
+ = 
+	`e_s_dymic
+(257 + (t & 0x1f), 1 + ((t >> 5) & 0x1f),
+
+4253 
+s
+->
+sub
+.
+s
+.
+bns
+, &
+bl
+, &
+bd
+, &
+
+, &
+td
+,
+
+4254 
+s
+->
+hus
+, 
+z
+);
+
+4255 i(
+t
+ !
+Z_OK
+)
+
+4257 i(
+t
+ =(
+uI
+)
+Z_DATA_ERROR
+)
+
+4259 
+	`ZFREE
+(
+z
+, 
+s
+->
+sub
+.
+s
+.
+bns
+);
+
+4260 
+s
+->
+mode
+ = 
+BADB
+;
+
+4262 
+r
+ = 
+t
+;
+
+4263 
+LEAVE
+
+
+4265 
+	`Tv
+((
+dr
+, "inflate:rees ok\n"));
+
+4266 i((
+c
+ = 
+	`e_codes_w
+(
+bl
+, 
+bd
+, 
+
+, 
+td
+, 
+z
+)=
+Z_NULL
+)
+
+4268 
+r
+ = 
+Z_MEM_ERROR
+;
+
+4269 
+LEAVE
+
+
+4271 
+s
+->
+sub
+.
+decode
+.
+codes
+ = 
+c
+;
+
+4273 
+	`ZFREE
+(
+z
+, 
+s
+->
+sub
+.
+s
+.
+bns
+);
+
+4274 
+s
+->
+mode
+ = 
+CODES
+;
+
+4275 
+CODES
+:
+
+4276 
+UPDATE
+
+
+4277 i((
+r
+ = 
+	`e_codes
+(
+s
+, 
+z
+,)!
+Z_STREAM_END
+)
+
+4278  
+	`e_ush
+(
+s
+, 
+z
+, 
+r
+);
+
+4279 
+r
+ = 
+Z_OK
+;
+
+4280 
+	`e_codes_
+(
+s
+->
+sub
+.
+decode
+.
+codes
+, 
+z
+);
+
+4281 
+LOAD
+
+
+4282 
+	`Tv
+((
+dr
+, "inflate: codesnd, %luotal out\n",
+
+4283 
+z
+->
+t_out
+ + (
+q
+ >
+s
+->
+ad
+ ? q - s->read :
+
+4284 (
+s
+->
+d
+ - s->
+ad
++ (
+q
+ - s->
+wdow
+))));
+
+4285 i(!
+s
+->
+
+)
+
+4287 
+s
+->
+mode
+ = 
+TYPE
+;
+
+4290 
+s
+->
+mode
+ = 
+DRY
+;
+
+4291 
+DRY
+:
+
+4292 
+FLUSH
+
+
+4293 i(
+s
+->
+ad
+ !s->
+wre
+)
+
+4294 
+LEAVE
+
+
+4295 
+s
+->
+mode
+ = 
+DONEB
+;
+
+4296 
+DONEB
+:
+
+4297 
+r
+ = 
+Z_STREAM_END
+;
+
+4298 
+LEAVE
+
+
+4299 
+BADB
+:
+
+4300 
+r
+ = 
+Z_DATA_ERROR
+;
+
+4301 
+LEAVE
+
+
+4303 
+r
+ = 
+Z_STREAM_ERROR
+;
+
+4304 
+LEAVE
+
+
+4306 
+	}
+}
+
+4309 
+	$e_blocks_
+(
+e_blocks_ef
+ *
+s
+, 
+z_amp
+ 
+z
+)
+
+4311 
+	`e_blocks_t
+(
+s
+, 
+z
+, 
+Z_NULL
+);
+
+4312 
+	`ZFREE
+(
+z
+, 
+s
+->
+wdow
+);
+
+4313 
+	`ZFREE
+(
+z
+, 
+s
+->
+hus
+);
+
+4314 
+	`ZFREE
+(
+z
+, 
+s
+);
+
+4315 
+	`Tv
+((
+dr
+, "inflate: blocks freed\n"));
+
+4316  
+Z_OK
+;
+
+4317 
+	}
+}
+
+4321 
+	$e_t_diiy
+(
+e_blocks_ef
+ *
+s
+, c 
+Byf
+ *
+d
+, 
+uI
+ 
+n
+)
+
+4323 
+	`zmemy
+(
+s
+->
+wdow
+, 
+d
+, 
+n
+);
+
+4324 
+s
+->
+ad
+ = s->
+wre
+ = s->
+wdow
+ + 
+n
+;
+
+4325 
+	}
+}
+
+4336 
+	$e_addhiy
+(
+e_blocks_ef
+ *
+s
+, 
+z_am
+ *
+z
+)
+
+4338 
+uLg
+ 
+b
+;
+
+4339 
+uI
+ 
+k
+;
+
+4340 
+uI
+ 
+t
+;
+
+4341 
+Byf
+ *
+p
+;
+
+4342 
+uI
+ 
+n
+;
+
+4343 
+Byf
+ *
+q
+;
+
+4344 
+uI
+ 
+m
+;
+
+4346 i(
+s
+->
+ad
+ !s->
+wre
+)
+
+4347  
+Z_STREAM_ERROR
+;
+
+4348 i(
+s
+->
+mode
+ !
+TYPE
+)
+
+4349  
+Z_DATA_ERROR
+;
+
+4352 
+LOAD
+
+
+4356 
+n
+) {
+
+4357 
+t
+ = 
+n
+;
+
+4359 i(
+t
+ > 
+m
+) = m;
+
+4361 i(
+s
+->
+check
+ !
+Z_NULL
+)
+
+4362 
+s
+->
+check
+ = (*s->
+check
+)(s->check, 
+q
+, 
+t
+);
+
+4363 
+	`zmemy
+(
+q
+, 
+p
+, 
+t
+);
+
+4364 
+q
+ +
+t
+;
+
+4365 
+p
+ +
+t
+;
+
+4366 
+n
+ -
+t
+;
+
+4367 
+z
+->
+t_out
+ +
+t
+;
+
+4368 
+s
+->
+ad
+ = 
+q
+;
+
+4370 i(
+q
+ =
+s
+->
+d
+) {
+
+4371 
+s
+->
+ad
+ = 
+q
+ = s->
+wdow
+;
+
+4372 
+m
+ = 
+WAVAIL
+;
+
+4375 
+UPDATE
+
+
+4376  
+Z_OK
+;
+
+4377 
+	}
+}
+
+4384 
+	$e_ck_ush
+(
+e_blocks_ef
+ *
+s
+)
+
+4386 i(
+s
+->
+mode
+ !
+LENS
+)
+
+4387  
+Z_DATA_ERROR
+;
+
+4388 
+s
+->
+mode
+ = 
+TYPE
+;
+
+4389  
+Z_OK
+;
+
+4390 
+	}
+}
+
+4397 
+	$e_blocks_sync_pot
+(
+s
+)
+
+4398 
+e_blocks_ef
+ *
+s
+;
+
+4400  
+s
+->
+mode
+ =
+LENS
+;
+
+4401 
+	}
+}
+
+4416 #i!
+defed
+(
+BUILDFIXED
+&& !defed(
+STDC
+)
+
+4417 
+	#BUILDFIXED
+
+
+	)
+
+4420 c 
+	ge_cyright
+[] =
+
+4429 #ide
+NO_DUMMY_DECL
+
+
+4430 
+	s_e
+ {
+	mdummy
+;};
+
+4434 
+	#ex
+ 
+wd
+.
+wh
+.
+Ex
+
+
+	)
+
+4435 
+	#bs
+ 
+wd
+.
+wh
+.
+Bs
+
+
+	)
+
+4438 
+lol
+ 
+hu_bud
+(
+
+4439 
+uIf
+ *,
+
+4440 
+uI
+,
+
+4441 
+uI
+,
+
+4442 c 
+uIf
+ *,
+
+4443 c 
+uIf
+ *,
+
+4444 
+e_hu
+ * 
+FAR
+*,
+
+4445 
+uIf
+ *,
+
+4446 
+e_hu
+ *,
+
+4447 
+uI
+ *,
+
+4448 
+uIf
+ * );
+
+4451 
+lol
+ c 
+uI
+ 
+	gns
+[31] = {
+
+4455 
+lol
+ c 
+uI
+ 
+	gxt
+[31] = {
+
+4458 
+lol
+ c 
+uI
+ 
+	gdi
+[30] = {
+
+4462 
+lol
+ c 
+uI
+ 
+	gdext
+[30] = {
+
+4501 
+	#BMAX
+ 15
+
+	)
+
+4503 
+lol
+ 
+	$hu_bud
+(
+uIf
+ *
+b
+,
+
+4504 
+uI
+ 
+n
+,
+
+4505 
+uI
+ 
+s
+,
+
+4506 c 
+uIf
+ *
+d
+,
+
+4507 c 
+uIf
+ *
+e
+,
+
+4508 
+e_hu
+ * 
+FAR
+ *
+t
+,
+
+4509 
+uIf
+ *
+m
+,
+
+4510 
+e_hu
+ *
+hp
+,
+
+4511 
+uI
+ *
+hn
+,
+
+4512 
+uIf
+ *
+v
+)
+
+4520 
+uI
+ 
+a
+;
+
+4521 
+uI
+ 
+c
+[
+BMAX
++1];
+
+4522 
+uI
+ 
+f
+;
+
+4523 
+g
+;
+
+4524 
+h
+;
+
+4525 
+uI
+ 
+i
+;
+
+4526 
+uI
+ 
+j
+;
+
+4527 
+k
+;
+
+4528 
+l
+;
+
+4529 
+uI
+ 
+mask
+;
+
+4530 
+uIf
+ *
+p
+;
+
+4531 
+e_hu
+ *
+q
+;
+
+4532 
+e_hu_s
+ 
+r
+;
+
+4533 
+e_hu
+ *
+u
+[
+BMAX
+];
+
+4534 
+w
+;
+
+4535 
+uI
+ 
+x
+[
+BMAX
++1];
+
+4536 
+uIf
+ *
+xp
+;
+
+4537 
+y
+;
+
+4538 
+uI
+ 
+z
+;
+
+4540 
+r
+.
+ba
+ = 0;
+
+4543 
+p
+ = 
+c
+;
+
+4544 
+	#C0
+ *
+p
+++ = 0;
+
+	)
+
+4545 
+	#C2
+ 
+C0
+ C0 C0 
+	)
+C0
+
+4546 
+	#C4
+ 
+C2
+ C2 C2 
+	)
+C2
+
+4547 
+C4
+
+
+4548 
+p
+ = 
+b
+; 
+i
+ = 
+n
+;
+
+4550 
+c
+[*
+p
+++]++;
+
+4551 } --
+i
+);
+
+4552 i(
+c
+[0] =
+n
+)
+
+4554 *
+t
+ = (
+e_hu
+ *)
+Z_NULL
+;
+
+4555 *
+m
+ = 0;
+
+4556  
+Z_OK
+;
+
+4561 
+l
+ = *
+m
+;
+
+4562 
+j
+ = 1; j <
+BMAX
+; j++)
+
+4563 i(
+c
+[
+j
+])
+
+4565 
+k
+ = 
+j
+;
+
+4566 i((
+uI
+)
+l
+ < 
+j
+)
+
+4567 
+l
+ = 
+j
+;
+
+4568 
+i
+ = 
+BMAX
+; i; i--)
+
+4569 i(
+c
+[
+i
+])
+
+4571 
+g
+ = 
+i
+;
+
+4572 i((
+uI
+)
+l
+ > 
+i
+)
+
+4573 
+l
+ = 
+i
+;
+
+4574 *
+m
+ = 
+l
+;
+
+4578 
+y
+ = 1 << 
+j
+; j < 
+i
+; j++, y <<= 1)
+
+4579 i((
+y
+ -
+c
+[
+j
+]) < 0)
+
+4580  
+Z_DATA_ERROR
+;
+
+4581 i((
+y
+ -
+c
+[
+i
+]) < 0)
+
+4582  
+Z_DATA_ERROR
+;
+
+4583 
+c
+[
+i
+] +
+y
+;
+
+4587 
+x
+[1] = 
+j
+ = 0;
+
+4588 
+p
+ = 
+c
+ + 1; 
+xp
+ = 
+x
+ + 2;
+
+4589 --
+i
+) {
+
+4590 *
+xp
+++ = (
+j
+ +*
+p
+++);
+
+4595 
+p
+ = 
+b
+; 
+i
+ = 0;
+
+4597 i((
+j
+ = *
+p
+++) != 0)
+
+4598 
+v
+[
+x
+[
+j
+]++] = 
+i
+;
+
+4599 } ++
+i
+ < 
+n
+);
+
+4600 
+n
+ = 
+x
+[
+g
+];
+
+4604 
+x
+[0] = 
+i
+ = 0;
+
+4605 
+p
+ = 
+v
+;
+
+4606 
+h
+ = -1;
+
+4607 
+w
+ = -
+l
+;
+
+4608 
+u
+[0] = (
+e_hu
+ *)
+Z_NULL
+;
+
+4609 
+q
+ = (
+e_hu
+ *)
+Z_NULL
+;
+
+4610 
+z
+ = 0;
+
+4613 ; 
+k
+ <
+g
+; k++)
+
+4615 
+a
+ = 
+c
+[
+k
+];
+
+4616 
+a
+--)
+
+4620 
+k
+ > 
+w
+ + 
+l
+)
+
+4622 
+h
+++;
+
+4623 
+w
+ +
+l
+;
+
+4626 
+z
+ = 
+g
+ - 
+w
+;
+
+4627 
+z
+ = z > (
+uI
+)
+l
+ ? : z;
+
+4628 i((
+f
+ = 1 << (
+j
+ = 
+k
+ - 
+w
+)> 
+a
+ + 1)
+
+4630 
+f
+ -
+a
+ + 1;
+
+4631 
+xp
+ = 
+c
+ + 
+k
+;
+
+4632 i(
+j
+ < 
+z
+)
+
+4633 ++
+j
+ < 
+z
+)
+
+4635 i((
+f
+ <<1<*++
+xp
+)
+
+4637 
+f
+ -*
+xp
+;
+
+4640 
+z
+ = 1 << 
+j
+;
+
+4643 i(*
+hn
+ + 
+z
+ > 
+MANY
+)
+
+4644  
+Z_DATA_ERROR
+;
+
+4645 
+u
+[
+h
+] = 
+q
+ = 
+hp
+ + *
+hn
+;
+
+4646 *
+hn
+ +
+z
+;
+
+4649 i(
+h
+)
+
+4651 
+x
+[
+h
+] = 
+i
+;
+
+4652 
+r
+.
+bs
+ = (
+By
+)
+l
+;
+
+4653 
+r
+.
+ex
+ = (
+By
+)
+j
+;
+
+4654 
+j
+ = 
+i
+ >> (
+w
+ - 
+l
+);
+
+4655 
+r
+.
+ba
+ = (
+uI
+)(
+q
+ - 
+u
+[
+h
+-1] - 
+j
+);
+
+4656 
+u
+[
+h
+-1][
+j
+] = 
+r
+;
+
+4659 *
+t
+ = 
+q
+;
+
+4663 
+r
+.
+bs
+ = (
+By
+)(
+k
+ - 
+w
+);
+
+4664 i(
+p
+ >
+v
+ + 
+n
+)
+
+4665 
+r
+.
+ex
+ = 128 + 64;
+
+4666 i(*
+p
+ < 
+s
+)
+
+4668 
+r
+.
+ex
+ = (
+By
+)(*
+p
+ < 256 ? 0 : 32 + 64);
+
+4669 
+r
+.
+ba
+ = *
+p
+++;
+
+4673 
+r
+.
+ex
+ = (
+By
+)(
+e
+[*
+p
+ - 
+s
+] + 16 + 64);
+
+4674 
+r
+.
+ba
+ = 
+d
+[*
+p
+++ - 
+s
+];
+
+4678 
+f
+ = 1 << (
+k
+ - 
+w
+);
+
+4679 
+j
+ = 
+i
+ >> 
+w
+; j < 
+z
+; j +
+f
+)
+
+4680 
+q
+[
+j
+] = 
+r
+;
+
+4683 
+j
+ = 1 << (
+k
+ - 1); 
+i
+ & j; j >>= 1)
+
+4684 
+i
+ ^
+j
+;
+
+4685 
+i
+ ^
+j
+;
+
+4688 
+mask
+ = (1 << 
+w
+) - 1;
+
+4689 i(
+h
+ == -1)
+
+4690  
+Z_BUF_ERROR
+;
+
+4691 (
+i
+ & 
+mask
+!
+x
+[
+h
+])
+
+4693 
+h
+--;
+
+4694 
+w
+ -
+l
+;
+
+4695 
+mask
+ = (1 << 
+w
+) - 1;
+
+4702  
+y
+ !0 && 
+g
+ !1 ? 
+Z_BUF_ERROR
+ : 
+Z_OK
+;
+
+4703 
+	}
+}
+
+4706 
+	$e_s_bs
+(
+uIf
+ *
+c
+,
+
+4707 
+uIf
+ *
+bb
+,
+
+4708 
+e_hu
+ * 
+FAR
+ *
+tb
+,
+
+4709 
+e_hu
+ *
+hp
+,
+
+4710 
+z_amp
+ 
+z
+)
+
+4712 
+r
+;
+
+4713 
+uI
+ 
+hn
+ = 0;
+
+4714 
+uIf
+ *
+v
+;
+
+4716 i((
+v
+ = (
+uIf
+*)
+	`ZALLOC
+(
+z
+, 19, (
+uI
+))=
+Z_NULL
+)
+
+4717  
+Z_MEM_ERROR
+;
+
+4718 
+r
+ = 
+	`hu_bud
+(
+c
+, 19, 19, (
+uIf
+*)
+Z_NULL
+, (uIntf*)Z_NULL,
+
+4719 
+tb
+, 
+bb
+, 
+hp
+, &
+hn
+, 
+v
+);
+
+4720 i(
+r
+ =
+Z_DATA_ERROR
+)
+
+4721 
+z
+->
+msg
+ = "oversubscribed dynamic bitengthsree";
+
+4722 i(
+r
+ =
+Z_BUF_ERROR
+ || *
+bb
+ == 0)
+
+4724 
+z
+->
+msg
+ = "incomplete dynamic bitengthsree";
+
+4725 
+r
+ = 
+Z_DATA_ERROR
+;
+
+4727 
+	`ZFREE
+(
+z
+, 
+v
+);
+
+4728  
+r
+;
+
+4729 
+	}
+}
+
+4732 
+	$e_s_dymic
+(
+uI
+ 
+
+,
+
+4733 
+uI
+ 
+nd
+,
+
+4734 
+uIf
+ *
+c
+,
+
+4735 
+uIf
+ *
+bl
+,
+
+4736 
+uIf
+ *
+bd
+,
+
+4737 
+e_hu
+ * 
+FAR
+ *
+
+,
+
+4738 
+e_hu
+ * 
+FAR
+ *
+td
+,
+
+4739 
+e_hu
+ *
+hp
+,
+
+4740 
+z_amp
+ 
+z
+)
+
+4742 
+r
+;
+
+4743 
+uI
+ 
+hn
+ = 0;
+
+4744 
+uIf
+ *
+v
+;
+
+4747 i((
+v
+ = (
+uIf
+*)
+	`ZALLOC
+(
+z
+, 288, (
+uI
+))=
+Z_NULL
+)
+
+4748  
+Z_MEM_ERROR
+;
+
+4751 
+r
+ = 
+	`hu_bud
+(
+c
+, 
+
+, 257, 
+ns
+, 
+xt
+, 
+
+, 
+bl
+, 
+hp
+, &
+hn
+, 
+v
+);
+
+4752 i(
+r
+ !
+Z_OK
+ || *
+bl
+ == 0)
+
+4754 i(
+r
+ =
+Z_DATA_ERROR
+)
+
+4755 
+z
+->
+msg
+ = "oversubscribediteral/lengthree";
+
+4756 i(
+r
+ !
+Z_MEM_ERROR
+)
+
+4758 
+z
+->
+msg
+ = "incompleteiteral/lengthree";
+
+4759 
+r
+ = 
+Z_DATA_ERROR
+;
+
+4761 
+	`ZFREE
+(
+z
+, 
+v
+);
+
+4762  
+r
+;
+
+4766 
+r
+ = 
+	`hu_bud
+(
+c
+ + 
+
+, 
+nd
+, 0, 
+di
+, 
+dext
+, 
+td
+, 
+bd
+, 
+hp
+, &
+hn
+, 
+v
+);
+
+4767 i(
+r
+ !
+Z_OK
+ || (*
+bd
+ =0 && 
+
+ > 257))
+
+4769 i(
+r
+ =
+Z_DATA_ERROR
+)
+
+4770 
+z
+->
+msg
+ = "oversubscribed distanceree";
+
+4771 i(
+r
+ =
+Z_BUF_ERROR
+) {
+
+4772 #ifde
+PKZIP_BUG_WORKAROUND
+
+
+4773 
+r
+ = 
+Z_OK
+;
+
+4776 
+z
+->
+msg
+ = "incomplete distanceree";
+
+4777 
+r
+ = 
+Z_DATA_ERROR
+;
+
+4779 i(
+r
+ !
+Z_MEM_ERROR
+)
+
+4781 
+z
+->
+msg
+ = "empty distanceree withengths";
+
+4782 
+r
+ = 
+Z_DATA_ERROR
+;
+
+4784 
+	`ZFREE
+(
+z
+, 
+v
+);
+
+4785  
+r
+;
+
+4790 
+	`ZFREE
+(
+z
+, 
+v
+);
+
+4791  
+Z_OK
+;
+
+4792 
+	}
+}
+
+4796 #ifde
+BUILDFIXED
+
+
+4797 
+lol
+ 
+	gfixed_but
+ = 0;
+
+4798 
+	#FIXEDH
+ 544
+
+	)
+
+4799 
+lol
+ 
+e_hu
+ 
+	gfixed_mem
+[
+FIXEDH
+];
+
+4800 
+lol
+ 
+uI
+ 
+	gfixed_bl
+;
+
+4801 
+lol
+ 
+uI
+ 
+	gfixed_bd
+;
+
+4802 
+lol
+ 
+e_hu
+ *
+	gfixed_
+;
+
+4803 
+lol
+ 
+e_hu
+ *
+	gfixed_td
+;
+
+4816 
+lol
+ 
+uI
+ 
+	gfixed_bl
+ = 9;
+
+4817 
+lol
+ 
+uI
+ 
+	gfixed_bd
+ = 5;
+
+4818 
+lol
+ 
+e_hu
+ 
+	gfixed_
+[] = {
+
+4948 
+lol
+ 
+e_hu
+ 
+	gfixed_td
+[] = {
+
+4963 
+	$e_s_fixed
+(
+
+4964 
+uIf
+ *
+bl
+,
+
+4965 
+uIf
+ *
+bd
+,
+
+4966 
+e_hu
+ * 
+FAR
+ *
+
+,
+
+4967 
+e_hu
+ * 
+FAR
+ *
+td
+,
+
+4968 
+z_amp
+ 
+z
+)
+
+4970 #ifde
+BUILDFIXED
+
+
+4972 i(!
+fixed_but
+)
+
+4974 
+k
+;
+
+4975 
+uI
+ 
+f
+ = 0;
+
+4976 
+uIf
+ *
+c
+;
+
+4977 
+uIf
+ *
+v
+;
+
+4980 i((
+c
+ = (
+uIf
+*)
+	`ZALLOC
+(
+z
+, 288, (
+uI
+))=
+Z_NULL
+)
+
+4981  
+Z_MEM_ERROR
+;
+
+4982 i((
+v
+ = (
+uIf
+*)
+	`ZALLOC
+(
+z
+, 288, (
+uI
+))=
+Z_NULL
+)
+
+4984 
+	`ZFREE
+(
+z
+, 
+c
+);
+
+4985  
+Z_MEM_ERROR
+;
+
+4989 
+k
+ = 0; k < 144; k++)
+
+4990 
+c
+[
+k
+] = 8;
+
+4991 ; 
+k
+ < 256; k++)
+
+4992 
+c
+[
+k
+] = 9;
+
+4993 ; 
+k
+ < 280; k++)
+
+4994 
+c
+[
+k
+] = 7;
+
+4995 ; 
+k
+ < 288; k++)
+
+4996 
+c
+[
+k
+] = 8;
+
+4997 
+fixed_bl
+ = 9;
+
+4998 
+	`hu_bud
+(
+c
+, 288, 257, 
+ns
+, 
+xt
+, &
+fixed_
+, &
+fixed_bl
+,
+
+4999 
+fixed_mem
+, &
+f
+, 
+v
+);
+
+5002 
+k
+ = 0; k < 30; k++)
+
+5003 
+c
+[
+k
+] = 5;
+
+5004 
+fixed_bd
+ = 5;
+
+5005 
+	`hu_bud
+(
+c
+, 30, 0, 
+di
+, 
+dext
+, &
+fixed_td
+, &
+fixed_bd
+,
+
+5006 
+fixed_mem
+, &
+f
+, 
+v
+);
+
+5009 
+	`ZFREE
+(
+z
+, 
+v
+);
+
+5010 
+	`ZFREE
+(
+z
+, 
+c
+);
+
+5011 
+fixed_but
+ = 1;
+
+5014 *
+bl
+ = 
+fixed_bl
+;
+
+5015 *
+bd
+ = 
+fixed_bd
+;
+
+5016 *
+
+ = 
+fixed_
+;
+
+5017 *
+td
+ = 
+fixed_td
+;
+
+5018  
+Z_OK
+;
+
+5019 
+	}
+}
+
+5047 
+e_
+(
+
+5048 
+uI
+,
+
+5049 
+uI
+,
+
+5050 
+e_hu
+ *,
+
+5051 
+e_hu
+ *,
+
+5052 
+e_blocks_ef
+ *,
+
+5053 
+z_amp
+ );
+
+5057 
+	#ex
+ 
+wd
+.
+wh
+.
+Ex
+
+
+	)
+
+5058 
+	#bs
+ 
+wd
+.
+wh
+.
+Bs
+
+
+	)
+
+5061 
+	mSTART
+,
+
+5062 
+	mLEN
+,
+
+5063 
+	mLENEXT
+,
+
+5064 
+	mDIST
+,
+
+5065 
+	mDISTEXT
+,
+
+5066 
+	mCOPY
+,
+
+5067 
+	mLIT
+,
+
+5068 
+	mWASH
+,
+
+5069 
+	mEND
+,
+
+5070 
+	mBADCODE
+}
+
+5071 
+	te_codes_mode
+;
+
+5074 
+	se_codes_e
+ {
+
+5077 
+e_codes_mode
+ 
+	mmode
+;
+
+5080 
+uI
+ 
+	mn
+;
+
+5083 
+e_hu
+ *
+	m
+;
+
+5084 
+uI
+ 
+	med
+;
+
+5085 } 
+	mcode
+;
+
+5086 
+uI
+ 
+	ml
+;
+
+5088 
+uI
+ 
+	mg
+;
+
+5089 
+uI
+ 
+	mdi
+;
+
+5090 } 
+	mcy
+;
+
+5091 } 
+	msub
+;
+
+5094 
+By
+ 
+	mlbs
+;
+
+5095 
+By
+ 
+	mdbs
+;
+
+5096 
+e_hu
+ *
+	me
+;
+
+5097 
+e_hu
+ *
+	md
+;
+
+5102 
+e_codes_ef
+ *
+	$e_codes_w
+(
+uI
+ 
+bl
+, uI 
+bd
+,
+
+5103 
+e_hu
+ *
+
+, ine_hu *
+td
+, 
+z_amp
+ 
+z
+)
+
+5105 
+e_codes_ef
+ *
+c
+;
+
+5107 i((
+c
+ = (
+e_codes_ef
+ *)
+
+5108 
+	`ZALLOC
+(
+z
+,1,(
+e_codes_e
+))!
+Z_NULL
+)
+
+5110 
+c
+->
+mode
+ = 
+START
+;
+
+5111 
+c
+->
+lbs
+ = (
+By
+)
+bl
+;
+
+5112 
+c
+->
+dbs
+ = (
+By
+)
+bd
+;
+
+5113 
+c
+->
+e
+ = 
+
+;
+
+5114 
+c
+->
+d
+ = 
+td
+;
+
+5115 
+	`Tv
+((
+dr
+, "inflate: codesew\n"));
+
+5117  
+c
+;
+
+5118 
+	}
+}
+
+5121 
+	$e_codes
+(
+e_blocks_ef
+ *
+s
+, 
+z_amp
+ 
+z
+, 
+r
+)
+
+5123 
+uI
+ 
+j
+;
+
+5124 
+e_hu
+ *
+t
+;
+
+5125 
+uI
+ 
+e
+;
+
+5126 
+uLg
+ 
+b
+;
+
+5127 
+uI
+ 
+k
+;
+
+5128 
+Byf
+ *
+p
+;
+
+5129 
+uI
+ 
+n
+;
+
+5130 
+Byf
+ *
+q
+;
+
+5131 
+uI
+ 
+m
+;
+
+5132 
+Byf
+ *
+f
+;
+
+5133 
+e_codes_ef
+ *
+c
+ = 
+s
+->
+sub
+.
+decode
+.
+codes
+;
+
+5136 
+LOAD
+
+
+5139 1
+c
+->
+mode
+)
+
+5141 
+START
+:
+
+5142 #ide
+SLOW
+
+
+5143 i(
+m
+ >258 && 
+n
+ >= 10)
+
+5145 
+UPDATE
+
+
+5146 
+r
+ = 
+	`e_
+(
+c
+->
+lbs
+, c->
+dbs
+, c->
+e
+, c->
+d
+, 
+s
+, 
+z
+);
+
+5147 
+LOAD
+
+
+5148 i(
+r
+ !
+Z_OK
+)
+
+5150 
+c
+->
+mode
+ = 
+r
+ =
+Z_STREAM_END
+ ? 
+WASH
+ : 
+BADCODE
+;
+
+5155 
+c
+->
+sub
+.
+code
+.
+ed
+ = c->
+lbs
+;
+
+5156 
+c
+->
+sub
+.
+code
+.
+
+ = c->
+e
+;
+
+5157 
+c
+->
+mode
+ = 
+LEN
+;
+
+5158 
+LEN
+:
+
+5159 
+j
+ = 
+c
+->
+sub
+.
+code
+.
+ed
+;
+
+5160 
+	`NEEDBITS
+(
+j
+)
+
+5161 
+t
+ = 
+c
+->
+sub
+.
+code
+.
+
+ + ((
+uI
+)
+b
+ & 
+e_mask
+[
+j
+]);
+
+5162 
+	`DUMPBITS
+(
+t
+->
+bs
+)
+
+5163 
+e
+ = (
+uI
+)(
+t
+->
+ex
+);
+
+5164 i(
+e
+ == 0)
+
+5166 
+c
+->
+sub
+.
+l
+ = 
+t
+->
+ba
+;
+
+5167 
+	`Tvv
+((
+dr
+, 
+t
+->
+ba
+ >= 0x20 &&->base < 0x7f ?
+
+5169 "e: 0x%02x\n", 
+t
+->
+ba
+));
+
+5170 
+c
+->
+mode
+ = 
+LIT
+;
+
+5173 i(
+e
+ & 16)
+
+5175 
+c
+->
+sub
+.
+cy
+.
+g
+ = 
+e
+ & 15;
+
+5176 
+c
+->
+n
+ = 
+t
+->
+ba
+;
+
+5177 
+c
+->
+mode
+ = 
+LENEXT
+;
+
+5180 i((
+e
+ & 64) == 0)
+
+5182 
+c
+->
+sub
+.
+code
+.
+ed
+ = 
+e
+;
+
+5183 
+c
+->
+sub
+.
+code
+.
+
+ = 
+t
+ +->
+ba
+;
+
+5186 i(
+e
+ & 32)
+
+5188 
+	`Tvv
+((
+dr
+, "inflate:nd of block\n"));
+
+5189 
+c
+->
+mode
+ = 
+WASH
+;
+
+5192 
+c
+->
+mode
+ = 
+BADCODE
+;
+
+5193 
+z
+->
+msg
+ = "invaliditeral/length code";
+
+5194 
+r
+ = 
+Z_DATA_ERROR
+;
+
+5195 
+LEAVE
+
+
+5196 
+LENEXT
+:
+
+5197 
+j
+ = 
+c
+->
+sub
+.
+cy
+.
+g
+;
+
+5198 
+	`NEEDBITS
+(
+j
+)
+
+5199 
+c
+->
+n
+ +(
+uI
+)
+b
+ & 
+e_mask
+[
+j
+];
+
+5200 
+	`DUMPBITS
+(
+j
+)
+
+5201 
+c
+->
+sub
+.
+code
+.
+ed
+ = c->
+dbs
+;
+
+5202 
+c
+->
+sub
+.
+code
+.
+
+ = c->
+d
+;
+
+5203 
+	`Tvv
+((
+dr
+, "e:gth %u\n", 
+c
+->
+n
+));
+
+5204 
+c
+->
+mode
+ = 
+DIST
+;
+
+5205 
+DIST
+:
+
+5206 
+j
+ = 
+c
+->
+sub
+.
+code
+.
+ed
+;
+
+5207 
+	`NEEDBITS
+(
+j
+)
+
+5208 
+t
+ = 
+c
+->
+sub
+.
+code
+.
+
+ + ((
+uI
+)
+b
+ & 
+e_mask
+[
+j
+]);
+
+5209 
+	`DUMPBITS
+(
+t
+->
+bs
+)
+
+5210 
+e
+ = (
+uI
+)(
+t
+->
+ex
+);
+
+5211 i(
+e
+ & 16)
+
+5213 
+c
+->
+sub
+.
+cy
+.
+g
+ = 
+e
+ & 15;
+
+5214 
+c
+->
+sub
+.
+cy
+.
+di
+ = 
+t
+->
+ba
+;
+
+5215 
+c
+->
+mode
+ = 
+DISTEXT
+;
+
+5218 i((
+e
+ & 64) == 0)
+
+5220 
+c
+->
+sub
+.
+code
+.
+ed
+ = 
+e
+;
+
+5221 
+c
+->
+sub
+.
+code
+.
+
+ = 
+t
+ +->
+ba
+;
+
+5224 
+c
+->
+mode
+ = 
+BADCODE
+;
+
+5225 
+z
+->
+msg
+ = "invalid distance code";
+
+5226 
+r
+ = 
+Z_DATA_ERROR
+;
+
+5227 
+LEAVE
+
+
+5228 
+DISTEXT
+:
+
+5229 
+j
+ = 
+c
+->
+sub
+.
+cy
+.
+g
+;
+
+5230 
+	`NEEDBITS
+(
+j
+)
+
+5231 
+c
+->
+sub
+.
+cy
+.
+di
+ +(
+uI
+)
+b
+ & 
+e_mask
+[
+j
+];
+
+5232 
+	`DUMPBITS
+(
+j
+)
+
+5233 
+	`Tvv
+((
+dr
+, "e: di %u\n", 
+c
+->
+sub
+.
+cy
+.
+di
+));
+
+5234 
+c
+->
+mode
+ = 
+COPY
+;
+
+5235 
+COPY
+:
+
+5236 
+f
+ = 
+q
+ - 
+c
+->
+sub
+.
+cy
+.
+di
+;
+
+5237 
+f
+ < 
+s
+->
+wdow
+)
+
+5238 
+f
+ +
+s
+->
+d
+ - s->
+wdow
+;
+
+5239 
+c
+->
+n
+)
+
+5241 
+NEEDOUT
+
+
+5242 
+	`OUTBYTE
+(*
+f
+++)
+
+5243 i(
+f
+ =
+s
+->
+d
+)
+
+5244 
+f
+ = 
+s
+->
+wdow
+;
+
+5245 
+c
+->
+n
+--;
+
+5247 
+c
+->
+mode
+ = 
+START
+;
+
+5249 
+LIT
+:
+
+5250 
+NEEDOUT
+
+
+5251 
+	`OUTBYTE
+(
+c
+->
+sub
+.
+l
+)
+
+5252 
+c
+->
+mode
+ = 
+START
+;
+
+5254 
+WASH
+:
+
+5255 i(
+k
+ > 7)
+
+5257 
+	`As
+(
+k
+ < 16, "inflate_codes grabbedoo many bytes")
+
+5258 
+k
+ -= 8;
+
+5259 
+n
+++;
+
+5260 
+p
+--;
+
+5262 
+FLUSH
+
+
+5263 i(
+s
+->
+ad
+ !s->
+wre
+)
+
+5264 
+LEAVE
+
+
+5265 
+c
+->
+mode
+ = 
+END
+;
+
+5266 
+END
+:
+
+5267 
+r
+ = 
+Z_STREAM_END
+;
+
+5268 
+LEAVE
+
+
+5269 
+BADCODE
+:
+
+5270 
+r
+ = 
+Z_DATA_ERROR
+;
+
+5271 
+LEAVE
+
+
+5273 
+r
+ = 
+Z_STREAM_ERROR
+;
+
+5274 
+LEAVE
+
+
+5276 #ifde
+NEED_DUMMY_RETURN
+
+
+5277  
+Z_STREAM_ERROR
+;
+
+5279 
+	}
+}
+
+5282 
+	$e_codes_
+(
+e_codes_ef
+ *
+c
+, 
+z_amp
+ 
+z
+)
+
+5284 
+	`ZFREE
+(
+z
+, 
+c
+);
+
+5285 
+	`Tv
+((
+dr
+, "inflate: codes free\n"));
+
+5286 
+	}
+}
+
+5302 #ide
+NO_DUMMY_DECL
+
+
+5303 
+	se_codes_e
+ {
+	mdummy
+;};
+
+5307 
+uI
+ 
+	ge_mask
+[17] = {
+
+5315 
+	$e_ush
+(
+e_blocks_ef
+ *
+s
+, 
+z_amp
+ 
+z
+, 
+r
+)
+
+5317 
+uI
+ 
+n
+;
+
+5318 
+Byf
+ *
+p
+;
+
+5319 
+Byf
+ *
+q
+;
+
+5322 
+p
+ = 
+z
+->
+xt_out
+;
+
+5323 
+q
+ = 
+s
+->
+ad
+;
+
+5326 
+n
+ = (
+uI
+)((
+q
+ <
+s
+->
+wre
+ ? s->wr: s->
+d
+) - q);
+
+5327 i(
+n
+ > 
+z
+->
+ava_out
+) = z->avail_out;
+
+5328 i(
+n
+ && 
+r
+ =
+Z_BUF_ERROR
+
+Z_OK
+;
+
+5331 
+z
+->
+ava_out
+ -
+n
+;
+
+5332 
+z
+->
+t_out
+ +
+n
+;
+
+5335 i(
+s
+->
+check
+ !
+Z_NULL
+)
+
+5336 
+z
+->
+adr
+ = 
+s
+->
+check
+ = (*s->
+check
+)(s->check, 
+q
+, 
+n
+);
+
+5339 i(
+p
+ !
+Z_NULL
+) {
+
+5340 
+	`zmemy
+(
+p
+, 
+q
+, 
+n
+);
+
+5341 
+p
+ +
+n
+;
+
+5343 
+q
+ +
+n
+;
+
+5346 i(
+q
+ =
+s
+->
+d
+)
+
+5349 
+q
+ = 
+s
+->
+wdow
+;
+
+5350 i(
+s
+->
+wre
+ =s->
+d
+)
+
+5351 
+s
+->
+wre
+ = s->
+wdow
+;
+
+5354 
+n
+ = (
+uI
+)(
+s
+->
+wre
+ - 
+q
+);
+
+5355 i(
+n
+ > 
+z
+->
+ava_out
+) = z->avail_out;
+
+5356 i(
+n
+ && 
+r
+ =
+Z_BUF_ERROR
+
+Z_OK
+;
+
+5359 
+z
+->
+ava_out
+ -
+n
+;
+
+5360 
+z
+->
+t_out
+ +
+n
+;
+
+5363 i(
+s
+->
+check
+ !
+Z_NULL
+)
+
+5364 
+z
+->
+adr
+ = 
+s
+->
+check
+ = (*s->
+check
+)(s->check, 
+q
+, 
+n
+);
+
+5367 i(
+p
+ !
+NULL
+) {
+
+5368 
+	`zmemy
+(
+p
+, 
+q
+, 
+n
+);
+
+5369 
+p
+ +
+n
+;
+
+5371 
+q
+ +
+n
+;
+
+5375 
+z
+->
+xt_out
+ = 
+p
+;
+
+5376 
+s
+->
+ad
+ = 
+q
+;
+
+5379  
+r
+;
+
+5380 
+	}
+}
+
+5397 #ide
+NO_DUMMY_DECL
+
+
+5398 
+	se_codes_e
+ {
+	mdummy
+;};
+
+5402 
+	#ex
+ 
+wd
+.
+wh
+.
+Ex
+
+
+	)
+
+5403 
+	#bs
+ 
+wd
+.
+wh
+.
+Bs
+
+
+	)
+
+5406 
+	#GRABBITS
+(
+j
+{
+k
+<(j)){
+b
+|=((
+uLg
+)
+NEXTBYTE
+)<<k;k+=8;}}
+
+	)
+
+5407 
+	#UNGRAB
+ {
+c
+=
+z
+->
+ava_
+-
+n
+;c=(
+k
+>>3)<c?k>>3:c;n+=c;
+p
+-=c;k-=c<<3;}
+
+	)
+
+5414 
+	$e_
+(
+uI
+ 
+bl
+, uI 
+bd
+,
+
+5415 
+e_hu
+ *
+
+,
+
+5416 
+e_hu
+ *
+td
+,
+
+5417 
+e_blocks_ef
+ *
+s
+,
+
+5418 
+z_amp
+ 
+z
+)
+
+5420 
+e_hu
+ *
+t
+;
+
+5421 
+uI
+ 
+e
+;
+
+5422 
+uLg
+ 
+b
+;
+
+5423 
+uI
+ 
+k
+;
+
+5424 
+Byf
+ *
+p
+;
+
+5425 
+uI
+ 
+n
+;
+
+5426 
+Byf
+ *
+q
+;
+
+5427 
+uI
+ 
+m
+;
+
+5428 
+uI
+ 
+ml
+;
+
+5429 
+uI
+ 
+md
+;
+
+5430 
+uI
+ 
+c
+;
+
+5431 
+uI
+ 
+d
+;
+
+5432 
+Byf
+ *
+r
+;
+
+5435 
+LOAD
+
+
+5438 
+ml
+ = 
+e_mask
+[
+bl
+];
+
+5439 
+md
+ = 
+e_mask
+[
+bd
+];
+
+5444 
+	`GRABBITS
+(20)
+
+5445 i((
+e
+ = (
+t
+ = 
+
+ + ((
+uI
+)
+b
+ & 
+ml
+))->
+ex
+) == 0)
+
+5447 
+	`DUMPBITS
+(
+t
+->
+bs
+)
+
+5448 
+	`Tvv
+((
+dr
+, 
+t
+->
+ba
+ >= 0x20 &&->base < 0x7f ?
+
+5450 "e: * 0x%02x\n", 
+t
+->
+ba
+));
+
+5451 *
+q
+++ = (
+By
+)
+t
+->
+ba
+;
+
+5452 
+m
+--;
+
+5456 
+	`DUMPBITS
+(
+t
+->
+bs
+)
+
+5457 i(
+e
+ & 16)
+
+5460 
+e
+ &= 15;
+
+5461 
+c
+ = 
+t
+->
+ba
+ + ((
+uI
+)
+b
+ & 
+e_mask
+[
+e
+]);
+
+5462 
+	`DUMPBITS
+(
+e
+)
+
+5463 
+	`Tvv
+((
+dr
+, "e: *gth %u\n", 
+c
+));
+
+5466 
+	`GRABBITS
+(15);
+
+5467 
+e
+ = (
+t
+ = 
+td
+ + ((
+uI
+)
+b
+ & 
+md
+))->
+ex
+;
+
+5469 
+	`DUMPBITS
+(
+t
+->
+bs
+)
+
+5470 i(
+e
+ & 16)
+
+5473 
+e
+ &= 15;
+
+5474 
+	`GRABBITS
+(
+e
+)
+
+5475 
+d
+ = 
+t
+->
+ba
+ + ((
+uI
+)
+b
+ & 
+e_mask
+[
+e
+]);
+
+5476 
+	`DUMPBITS
+(
+e
+)
+
+5477 
+	`Tvv
+((
+dr
+, "e: * di %u\n", 
+d
+));
+
+5480 
+m
+ -
+c
+;
+
+5481 
+r
+ = 
+q
+ - 
+d
+;
+
+5482 i(
+r
+ < 
+s
+->
+wdow
+)
+
+5485 
+r
+ +
+s
+->
+d
+ - s->
+wdow
+;
+
+5486 } 
+r
+ < 
+s
+->
+wdow
+);
+
+5487 
+e
+ = 
+s
+->
+d
+ - 
+r
+;
+
+5488 i(
+c
+ > 
+e
+)
+
+5490 
+c
+ -
+e
+;
+
+5492 *
+q
+++ = *
+r
+++;
+
+5493 } --
+e
+);
+
+5494 
+r
+ = 
+s
+->
+wdow
+;
+
+5496 *
+q
+++ = *
+r
+++;
+
+5497 } --
+c
+);
+
+5501 *
+q
+++ = *
+r
+++; 
+c
+--;
+
+5502 *
+q
+++ = *
+r
+++; 
+c
+--;
+
+5504 *
+q
+++ = *
+r
+++;
+
+5505 } --
+c
+);
+
+5510 *
+q
+++ = *
+r
+++; 
+c
+--;
+
+5511 *
+q
+++ = *
+r
+++; 
+c
+--;
+
+5513 *
+q
+++ = *
+r
+++;
+
+5514 } --
+c
+);
+
+5518 i((
+e
+ & 64) == 0)
+
+5520 
+t
+ +t->
+ba
+;
+
+5521 
+e
+ = (
+t
+ +((
+uI
+)
+b
+ & 
+e_mask
+[e]))->
+ex
+;
+
+5525 
+z
+->
+msg
+ = "invalid distance code";
+
+5526 
+UNGRAB
+
+
+5527 
+UPDATE
+
+
+5528  
+Z_DATA_ERROR
+;
+
+5533 i((
+e
+ & 64) == 0)
+
+5535 
+t
+ +t->
+ba
+;
+
+5536 i((
+e
+ = (
+t
+ +((
+uI
+)
+b
+ & 
+e_mask
+[e]))->
+ex
+) == 0)
+
+5538 
+	`DUMPBITS
+(
+t
+->
+bs
+)
+
+5539 
+	`Tvv
+((
+dr
+, 
+t
+->
+ba
+ >= 0x20 &&->base < 0x7f ?
+
+5541 "e: * 0x%02x\n", 
+t
+->
+ba
+));
+
+5542 *
+q
+++ = (
+By
+)
+t
+->
+ba
+;
+
+5543 
+m
+--;
+
+5547 i(
+e
+ & 32)
+
+5549 
+	`Tvv
+((
+dr
+, "inflate: *nd of block\n"));
+
+5550 
+UNGRAB
+
+
+5551 
+UPDATE
+
+
+5552  
+Z_STREAM_END
+;
+
+5556 
+z
+->
+msg
+ = "invaliditeral/length code";
+
+5557 
+UNGRAB
+
+
+5558 
+UPDATE
+
+
+5559  
+Z_DATA_ERROR
+;
+
+5562 } 
+m
+ >258 && 
+n
+ >= 10);
+
+5565 
+UNGRAB
+
+
+5566 
+UPDATE
+
+
+5567  
+Z_OK
+;
+
+5568 
+	}
+}
+
+5580 #ifde
+DEBUG_ZLIB
+
+
+5581 
+	~<dio.h
+>
+
+5586 #ide
+NO_DUMMY_DECL
+
+
+5587 
+	s_e
+ {
+	mdummy
+;};
+
+5590 #ide
+STDC
+
+
+5591 
+ex
+();
+
+5594 c *
+	gz_rmsg
+[10] = {
+
+5608 c * 
+ZEXPORT
+ 
+	$zlibVsi
+()
+
+5610  
+ZLIB_VERSION
+;
+
+5611 
+	}
+}
+
+5614 #ifde
+DEBUG_ZLIB
+
+
+5616 #ide
+vbo
+
+
+5617 
+	#vbo
+ 0
+
+	)
+
+5619 
+	gz_vbo
+ = 
+vbo
+;
+
+5621 
+	$z_r
+ (
+m
+)
+
+5622 *
+m
+;
+
+5624 
+	`rtf
+(
+dr
+, "%s\n", 
+m
+);
+
+5625 
+	`ex
+(1);
+
+5626 
+	}
+}
+
+5633 c * 
+ZEXPORT
+ 
+	$zE
+(
+r
+)
+
+5634 
+r
+;
+
+5636  
+	`ERR_MSG
+(
+r
+);
+
+5637 
+	}
+}
+
+5641 #ide
+HAVE_MEMCPY
+
+
+5643 
+	$zmemy
+(
+de
+, 
+sour
+, 
+n
+)
+
+5644 
+Byf
+* 
+de
+;
+
+5645 c 
+Byf
+* 
+sour
+;
+
+5646 
+uI
+ 
+n
+;
+
+5648 i(
+n
+ == 0) ;
+
+5650 *
+de
+++ = *
+sour
+++;
+
+5651 } --
+n
+ != 0);
+
+5652 
+	}
+}
+
+5654 
+	$zmemcmp
+(
+s1
+, 
+s2
+, 
+n
+)
+
+5655 c 
+Byf
+* 
+s1
+;
+
+5656 c 
+Byf
+* 
+s2
+;
+
+5657 
+uI
+ 
+n
+;
+
+5659 
+uI
+ 
+j
+;
+
+5661 
+j
+ = 0; j < 
+n
+; j++) {
+
+5662 i(
+s1
+[
+j
+] !
+s2
+[j])  2*(s1[j] > s2[j])-1;
+
+5665 
+	}
+}
+
+5667 
+	$zmemzo
+(
+de
+, 
+n
+)
+
+5668 
+Byf
+* 
+de
+;
+
+5669 
+uI
+ 
+n
+;
+
+5671 i(
+n
+ == 0) ;
+
+5673 *
+de
+++ = 0;
+
+5674 } --
+n
+ != 0);
+
+5675 
+	}
+}
+
+5678 #ifde
+__TURBOC__
+
+
+5679 #i(
+defed
+
+__BORLANDC__
+|| !defed(
+SMALL_MEDIUM
+)&& !defed(
+__32BIT__
+)
+
+5683 
+	#MY_ZCALLOC
+
+
+	)
+
+5691 
+	#MAX_PTR
+ 10
+
+	)
+
+5694 
+lol
+ 
+	gxt_r
+ = 0;
+
+5696 
+	sr_b_s
+ {
+
+5697 
+voidpf
+ 
+	mg_r
+;
+
+5698 
+voidpf
+ 
+	mw_r
+;
+
+5699 } 
+	tr_b
+;
+
+5701 
+lol
+ 
+r_b
+ 
+	gb
+[
+MAX_PTR
+];
+
+5709 
+voidpf
+ 
+	$zoc
+ (
+voidpf
+ 
+aque
+, 
+ems
+, 
+size
+)
+
+5711 
+voidpf
+ 
+buf
+ = 
+aque
+;
+
+5712 
+ulg
+ 
+bsize
+ = (ulg)
+ems
+*
+size
+;
+
+5717 i(
+bsize
+ < 65520L) {
+
+5718 
+buf
+ = 
+	`rmloc
+(
+bsize
+);
+
+5719 i(*(
+ush
+*)&
+buf
+ != 0)  buf;
+
+5721 
+buf
+ = 
+	`rmloc
+(
+bsize
+ + 16L);
+
+5723 i(
+buf
+ =
+NULL
+ || 
+xt_r
+ >
+MAX_PTR
+)  NULL;
+
+5724 
+b
+[
+xt_r
+].
+g_r
+ = 
+buf
+;
+
+5727 *((
+ush
+*)&
+buf
++1+((ush)((
+uch
+*)buf-0) + 15) >> 4;
+
+5728 *(
+ush
+*)&
+buf
+ = 0;
+
+5729 
+b
+[
+xt_r
+++].
+w_r
+ = 
+buf
+;
+
+5730  
+buf
+;
+
+5731 
+	}
+}
+
+5733 
+	$zc
+ (
+voidpf
+ 
+aque
+, voidp
+r
+)
+
+5735 
+n
+;
+
+5736 i(*(
+ush
+*)&
+r
+ != 0) {
+
+5737 
+	`r
+(
+r
+);
+
+5741 
+n
+ = 0; < 
+xt_r
+;++) {
+
+5742 i(
+r
+ !
+b
+[
+n
+].
+w_r
+) ;
+
+5744 
+	`r
+(
+b
+[
+n
+].
+g_r
+);
+
+5745 ++
+n
+ < 
+xt_r
+) {
+
+5746 
+b
+[
+n
+-1] =able[n];
+
+5748 
+xt_r
+--;
+
+5751 
+r
+ = 
+aque
+;
+
+5752 
+	`As
+(0, "zcfree:trot found");
+
+5753 
+	}
+}
+
+5758 #i
+defed
+(
+M_I86
+&& !defed(
+__32BIT__
+)
+
+5761 
+	#MY_ZCALLOC
+
+
+	)
+
+5763 #i(!
+defed
+(
+_MSC_VER
+) || (_MSC_VER <= 600))
+
+5764 
+	#_hloc
+ 
+hloc
+
+
+	)
+
+5765 
+	#_h
+ 
+h
+
+
+	)
+
+5768 
+voidpf
+ 
+	$zoc
+ (
+voidpf
+ 
+aque
+, 
+ems
+, 
+size
+)
+
+5770 i(
+aque
+) opaque = 0;
+
+5771  
+	`_hloc
+(()
+ems
+, 
+size
+);
+
+5772 
+	}
+}
+
+5774 
+	$zc
+ (
+voidpf
+ 
+aque
+, voidp
+r
+)
+
+5776 i(
+aque
+) opaque = 0;
+
+5777 
+	`_h
+(
+r
+);
+
+5778 
+	}
+}
+
+5783 #ide
+MY_ZCALLOC
+
+
+5785 #ide
+STDC
+
+
+5786 
+voidp
+ 
+oc
+(
+uI
+ 
+ems
+, uI 
+size
+);
+
+5787 
+
+(
+voidpf
+ 
+r
+);
+
+5790 
+voidpf
+ 
+	$zoc
+ (
+aque
+, 
+ems
+, 
+size
+)
+
+5791 
+voidpf
+ 
+aque
+;
+
+5792 
+ems
+;
+
+5793 
+size
+;
+
+5795 i(
+aque
+
+ems
+ +
+size
+ - size;
+
+5796  (
+voidpf
+)
+	`oc
+(
+ems
+, 
+size
+);
+
+5797 
+	}
+}
+
+5799 
+	$zc
+ (
+aque
+, 
+r
+)
+
+5800 
+voidpf
+ 
+aque
+;
+
+5801 
+voidpf
+ 
+r
+;
+
+5803 
+	`
+(
+r
+);
+
+5804 i(
+aque
+) ;
+
+5805 
+	}
+}
+
+5820 
+	#BASE
+ 65521L
+
+	)
+
+5821 
+	#NMAX
+ 5552
+
+	)
+
+5824 
+	#DO1
+(
+buf
+,
+i
+{
+s1
+ +buf[i]; 
+s2
+ +s1;}
+
+	)
+
+5825 
+	#DO2
+(
+buf
+,
+i
+
+	`DO1
+(buf,i); DO1(buf,i+1);
+
+	)
+
+5826 
+	#DO4
+(
+buf
+,
+i
+
+	`DO2
+(buf,i); DO2(buf,i+2);
+
+	)
+
+5827 
+	#DO8
+(
+buf
+,
+i
+
+	`DO4
+(buf,i); DO4(buf,i+4);
+
+	)
+
+5828 
+	#DO16
+(
+buf
+
+	`DO8
+(buf,0); DO8(buf,8);
+
+	)
+
+5831 
+uLg
+ 
+ZEXPORT
+ 
+	$adr32
+(
+uLg
+ 
+adr
+, c 
+Byf
+ *
+buf
+, 
+uI
+ 
+n
+)
+
+5833 
+s1
+ = 
+adr
+ & 0xffff;
+
+5834 
+s2
+ = (
+adr
+ >> 16) & 0xffff;
+
+5835 
+k
+;
+
+5837 i(
+buf
+ =
+Z_NULL
+)  1L;
+
+5839 
+n
+ > 0) {
+
+5840 
+k
+ = 
+n
+ < 
+NMAX
+ ?en : NMAX;
+
+5841 
+n
+ -
+k
+;
+
+5842 
+k
+ >= 16) {
+
+5843 
+	`DO16
+(
+buf
+);
+
+5844 
+buf
+ += 16;
+
+5845 
+k
+ -= 16;
+
+5847 i(
+k
+ != 0) do {
+
+5848 
+s1
+ +*
+buf
+++;
+
+5849 
+s2
+ +
+s1
+;
+
+5850 } --
+k
+);
+
+5851 
+s1
+ %
+BASE
+;
+
+5852 
+s2
+ %
+BASE
+;
+
+5854  (
+s2
+ << 16| 
+s1
+;
+
+5855 
+	}
+}
+
+5858 #i
+defed
+(
+_KERNEL
+)
+
+5864 
+	~<sys/modu.h
+>
+
+5866 
+zlib_modcmd
+(
+modcmd_t
+, *);
+
+5868 
+MODULE
+(
+MODULE_CLASS_MISC
+, 
+zlib
+, 
+NULL
+);
+
+5871 
+	$zlib_modcmd
+(
+modcmd_t
+ 
+cmd
+, *
+g
+)
+
+5874 
+cmd
+) {
+
+5875 
+MODULE_CMD_INIT
+:
+
+5876 
+MODULE_CMD_FINI
+:
+
+5878 
+MODULE_CMD_STAT
+:
+
+5879 
+MODULE_CMD_AUTOUNLOAD
+:
+
+5881  
+ENOTTY
+;
+
+5883 
+	}
+}
+
+	@zlib.h
+
+33 #ide
+_NET_ZLIB_H_
+
+
+34 
+	#_NET_ZLIB_H_
+
+
+	)
+
+36 #ifde
+__NBSD__
+
+
+37 
+	~<sys/cdefs.h
+>
+
+48 #ide
+ZCONF_H
+
+
+49 
+	#ZCONF_H
+
+
+	)
+
+58 
+	~<sys/tys.h
+>
+
+64 #ifde
+Z_PREFIX
+
+
+65 
+	#deeIn_
+ 
+z_deeIn_
+
+
+	)
+
+66 
+	#dee
+ 
+z_dee
+
+
+	)
+
+67 
+	#deeEnd
+ 
+z_deeEnd
+
+
+	)
+
+68 
+	#eIn_
+ 
+z_eIn_
+
+
+	)
+
+69 
+	#e
+ 
+z_e
+
+
+	)
+
+70 
+	#eEnd
+ 
+z_eEnd
+
+
+	)
+
+71 
+	#deeIn2_
+ 
+z_deeIn2_
+
+
+	)
+
+72 
+	#deeSDiiy
+ 
+z_deeSDiiy
+
+
+	)
+
+73 
+	#deeCy
+ 
+z_deeCy
+
+
+	)
+
+74 
+	#deeRet
+ 
+z_deeRet
+
+
+	)
+
+75 
+	#deePams
+ 
+z_deePams
+
+
+	)
+
+76 
+	#eIn2_
+ 
+z_eIn2_
+
+
+	)
+
+77 
+	#eSDiiy
+ 
+z_eSDiiy
+
+
+	)
+
+78 
+	#eSync
+ 
+z_eSync
+
+
+	)
+
+79 
+	#eSyncPot
+ 
+z_eSyncPot
+
+
+	)
+
+80 
+	#eRet
+ 
+z_eRet
+
+
+	)
+
+81 
+	#comess
+ 
+z_comess
+
+
+	)
+
+82 
+	#comess2
+ 
+z_comess2
+
+
+	)
+
+83 
+	#uncomess
+ 
+z_uncomess
+
+
+	)
+
+84 
+	#adr32
+ 
+z_adr32
+
+
+	)
+
+85 
+	#c32
+ 
+z_c32
+
+
+	)
+
+86 
+	#g_c_b
+ 
+z_g_c_b
+
+
+	)
+
+88 
+	#By
+ 
+z_By
+
+
+	)
+
+89 
+	#uI
+ 
+z_uI
+
+
+	)
+
+90 
+	#uLg
+ 
+z_uLg
+
+
+	)
+
+91 
+	#Byf
+ 
+z_Byf
+
+
+	)
+
+92 
+	#chf
+ 
+z_chf
+
+
+	)
+
+93 
+	#tf
+ 
+z_tf
+
+
+	)
+
+94 
+	#uIf
+ 
+z_uIf
+
+
+	)
+
+95 
+	#uLgf
+ 
+z_uLgf
+
+
+	)
+
+96 
+	#voidpf
+ 
+z_voidpf
+
+
+	)
+
+97 
+	#voidp
+ 
+z_voidp
+
+
+	)
+
+100 #ide
+__32BIT__
+
+
+102 
+	#__32BIT__
+
+
+	)
+
+109 #i
+defed
+(
+MSDOS
+&& !defed(
+__32BIT__
+)
+
+110 
+	#MAXSEG_64K
+
+
+	)
+
+115 
+	#UNALIGNED_OK
+
+
+	)
+
+118 #i(
+defed
+(
+__STDC__
+|| defed(
+__lulus
+)&& !defed(
+STDC
+)
+
+120 
+	#STDC
+
+
+	)
+
+122 #i
+defed
+(
+__STDC__
+|| defed(
+__lulus
+|| defed(
+__OS2__
+)
+
+123 #ide
+STDC
+
+
+124 
+	#STDC
+
+
+	)
+
+128 #ide
+STDC
+
+
+130 c
+
+	)
+
+135 #i
+defed
+(
+__MWERKS__
+|| defed(
+ec
+||defed(
+THINK_C
+||defed(
+__SC__
+)
+
+136 
+	#NO_DUMMY_DECL
+
+
+	)
+
+140 #i
+defed
+(
+__BORLANDC__
+) && (__BORLANDC__ < 0x500)
+
+141 
+	#NEED_DUMMY_RETURN
+
+
+	)
+
+146 #ide
+MAX_MEM_LEVEL
+
+
+147 #ifde
+MAXSEG_64K
+
+
+148 
+	#MAX_MEM_LEVEL
+ 8
+
+	)
+
+150 
+	#MAX_MEM_LEVEL
+ 9
+
+	)
+
+159 #ide
+MAX_WBITS
+
+
+160 
+	#MAX_WBITS
+ 15
+
+	)
+
+178 #ide
+__P
+
+
+179 #ifde
+STDC
+
+
+180 
+	#__P
+(
+gs
+
+	)
+args
+
+182 
+	#__P
+(
+gs
+()
+
+	)
+
+192 #i(
+defed
+(
+M_I86SM
+|| defed(
+M_I86MM
+)&& !defed(
+__32BIT__
+)
+
+194 
+	#SMALL_MEDIUM
+
+
+	)
+
+195 #ifde
+_MSC_VER
+
+
+196 
+	#FAR
+ 
+_r
+
+
+	)
+
+198 
+	#FAR
+ 
+r
+
+
+	)
+
+201 #i
+defed
+(
+__BORLANDC__
+&& (defed(
+__SMALL__
+|| defed(
+__MEDIUM__
+))
+
+202 #ide
+__32BIT__
+
+
+203 
+	#SMALL_MEDIUM
+
+
+	)
+
+204 
+	#FAR
+ 
+_r
+
+
+	)
+
+209 #i
+defed
+(
+ZLIB_DLL
+)
+
+210 #i
+defed
+(
+_WINDOWS
+|| defed(
+WINDOWS
+)
+
+211 #ifde
+FAR
+
+
+212 #unde
+FAR
+
+
+214 
+	~<wdows.h
+>
+
+215 
+	#ZEXPORT
+ 
+WINAPI
+
+
+	)
+
+216 #ifde
+WIN32
+
+
+217 
+	#ZEXPORTVA
+ 
+WINAPIV
+
+
+	)
+
+219 
+	#ZEXPORTVA
+ 
+FAR
+ 
+_cde
+ 
+_expt
+
+
+	)
+
+222 #i
+defed
+ (
+__BORLANDC__
+)
+
+223 #i(
+__BORLANDC__
+ >0x0500&& 
+defed
+ (
+WIN32
+)
+
+224 
+	~<wdows.h
+>
+
+225 
+	#ZEXPORT
+ 
+	`__deec
+(
+dexpt
+
+WINAPI
+
+
+	)
+
+226 
+	#ZEXPORTRVA
+ 
+	`__deec
+(
+dexpt
+
+WINAPIV
+
+
+	)
+
+228 #i
+defed
+ (
+_Wdows
+&& defed (
+__DLL__
+)
+
+229 
+	#ZEXPORT
+ 
+_expt
+
+
+	)
+
+230 
+	#ZEXPORTVA
+ 
+_expt
+
+
+	)
+
+236 #i
+defed
+ (
+__BEOS__
+)
+
+237 #i
+defed
+ (
+ZLIB_DLL
+)
+
+238 
+	#ZEXTERN
+ 
+	`__deec
+(
+dexpt
+)
+
+	)
+
+240 
+	#ZEXTERN
+ 
+	`__deec
+(
+dimpt
+)
+
+	)
+
+244 #ide
+ZEXPORT
+
+
+245 
+	#ZEXPORT
+
+
+	)
+
+247 #ide
+ZEXPORTVA
+
+
+248 
+	#ZEXPORTVA
+
+
+	)
+
+250 #ide
+ZEXTERN
+
+
+251 
+	#ZEXTERN
+ 
+
+	)
+
+254 #ide
+FAR
+
+
+255 
+	#FAR
+
+
+	)
+
+258 #i!
+defed
+(
+MACOS
+&& !defed(
+TARGET_OS_MAC
+)
+
+259 
+	tBy
+;
+
+261 
+	tuI
+;
+
+262 
+	tuLg
+;
+
+264 #ifde
+SMALL_MEDIUM
+
+
+266 
+	#Byf
+ 
+By
+ 
+FAR
+
+
+	)
+
+268 
+By
+ 
+	tFAR
+ 
+	tByf
+;
+
+270 
+	tFAR
+ 
+	tchf
+;
+
+271 
+	tFAR
+ 
+	ttf
+;
+
+272 
+uI
+ 
+	tFAR
+ 
+	tuIf
+;
+
+273 
+uLg
+ 
+	tFAR
+ 
+	tuLgf
+;
+
+275 #ifde
+STDC
+
+
+276 
+	tFAR
+ *
+	tvoidpf
+;
+
+277 *
+	tvoidp
+;
+
+279 
+By
+ 
+	tFAR
+ *
+	tvoidpf
+;
+
+280 
+By
+ *
+	tvoidp
+;
+
+283 #i(
+defed
+(
+HAVE_UNISTD_H
+|| defed(
+__NBSD__
+)&& !defed(
+_KERNEL
+)
+
+284 
+	~<sys/tys.h
+>
+
+285 
+	~<unid.h
+>
+
+286 
+	#z_off_t
+ 
+off_t
+
+
+	)
+
+288 #ide
+SEEK_SET
+
+
+289 
+	#SEEK_SET
+ 0
+
+	)
+
+290 
+	#SEEK_CUR
+ 1
+
+	)
+
+291 
+	#SEEK_END
+ 2
+
+	)
+
+293 #ide
+z_off_t
+
+
+294 
+	#z_off_t
+ 
+
+	)
+
+298 #i
+defed
+(
+__MVS__
+)
+
+299 #agm
+m
+(
+deeIn_
+,"DEIN")
+
+300 #agm
+m
+(
+deeIn2_
+,"DEIN2")
+
+301 #agm
+m
+(
+deeEnd
+,"DEEND")
+
+302 #agm
+m
+(
+eIn_
+,"ININ")
+
+303 #agm
+m
+(
+eIn2_
+,"ININ2")
+
+304 #agm
+m
+(
+eEnd
+,"INEND")
+
+305 #agm
+m
+(
+eSync
+,"INSY")
+
+306 #agm
+m
+(
+eSDiiy
+,"INSEDI")
+
+307 #agm
+m
+(
+e_blocks
+,"INBL")
+
+308 #agm
+m
+(
+e_blocks_w
+,"INBLNE")
+
+309 #agm
+m
+(
+e_blocks_
+,"INBLFR")
+
+310 #agm
+m
+(
+e_blocks_t
+,"INBLRE")
+
+311 #agm
+m
+(
+e_codes_
+,"INCOFR")
+
+312 #agm
+m
+(
+e_codes
+,"INCO")
+
+313 #agm
+m
+(
+e_
+,"INFA")
+
+314 #agm
+m
+(
+e_ush
+,"INFLU")
+
+315 #agm
+m
+(
+e_mask
+,"INMA")
+
+316 #agm
+m
+(
+e_t_diiy
+,"INSEDI2")
+
+317 #agm
+m
+(
+e_cyright
+,"INCOPY")
+
+318 #agm
+m
+(
+e_s_bs
+,"INTRBI")
+
+319 #agm
+m
+(
+e_s_dymic
+,"INTRDY")
+
+320 #agm
+m
+(
+e_s_fixed
+,"INTRFI")
+
+321 #agm
+m
+(
+e_s_
+,"INTRFR")
+
+327 #ide
+ZLIB_H
+
+
+328 
+	#ZLIB_H
+
+
+	)
+
+329 #ifde
+__lulus
+
+
+333 
+	#ZLIB_VERSION
+ "1.1.4"
+
+	)
+
+356 
+voidpf
+ (*
+	tloc_func
+)(
+	tvoidpf
+, 
+	tuI
+, uInt);
+
+357 (*
+_func
+)(
+	tvoidpf
+, voidpf);
+
+359 
+_e
+;
+
+361 
+	sz_am_s
+ {
+
+362 
+Byf
+ *
+xt_
+;
+
+363 
+uI
+ 
+ava_
+;
+
+364 
+uLg
+ 
+t_
+;
+
+366 
+Byf
+ *
+xt_out
+;
+
+367 
+uI
+ 
+ava_out
+;
+
+368 
+uLg
+ 
+t_out
+;
+
+370 c *
+msg
+;
+
+371 
+_e
+ 
+FAR
+ *
+e
+;
+
+373 
+loc_func
+ 
+zloc
+;
+
+374 
+_func
+ 
+z
+;
+
+375 
+voidpf
+ 
+aque
+;
+
+377 
+da_ty
+;
+
+378 
+uLg
+ 
+adr
+;
+
+379 
+uLg
+ 
+rved
+;
+
+380 } 
+	tz_am
+;
+
+382 
+z_am
+ 
+	tFAR
+ *
+	tz_amp
+;
+
+418 
+	#Z_NO_FLUSH
+ 0
+
+	)
+
+419 
+	#Z_PARTIAL_FLUSH
+ 1
+
+	)
+
+420 
+	#Z_PACKET_FLUSH
+ 2
+
+	)
+
+421 
+	#Z_SYNC_FLUSH
+ 3
+
+	)
+
+422 
+	#Z_FULL_FLUSH
+ 4
+
+	)
+
+423 
+	#Z_FINISH
+ 5
+
+	)
+
+426 
+	#Z_OK
+ 0
+
+	)
+
+427 
+	#Z_STREAM_END
+ 1
+
+	)
+
+428 
+	#Z_NEED_DICT
+ 2
+
+	)
+
+429 
+	#Z_ERRNO
+ (-1)
+
+	)
+
+430 
+	#Z_STREAM_ERROR
+ (-2)
+
+	)
+
+431 
+	#Z_DATA_ERROR
+ (-3)
+
+	)
+
+432 
+	#Z_MEM_ERROR
+ (-4)
+
+	)
+
+433 
+	#Z_BUF_ERROR
+ (-5)
+
+	)
+
+434 
+	#Z_VERSION_ERROR
+ (-6)
+
+	)
+
+439 
+	#Z_NO_COMPRESSION
+ 0
+
+	)
+
+440 
+	#Z_BEST_SPEED
+ 1
+
+	)
+
+441 
+	#Z_BEST_COMPRESSION
+ 9
+
+	)
+
+442 
+	#Z_DEFAULT_COMPRESSION
+ (-1)
+
+	)
+
+445 
+	#Z_FILTERED
+ 1
+
+	)
+
+446 
+	#Z_HUFFMAN_ONLY
+ 2
+
+	)
+
+447 
+	#Z_DEFAULT_STRATEGY
+ 0
+
+	)
+
+450 
+	#Z_BINARY
+ 0
+
+	)
+
+451 
+	#Z_ASCII
+ 1
+
+	)
+
+452 
+	#Z_UNKNOWN
+ 2
+
+	)
+
+455 
+	#Z_DEFLATED
+ 8
+
+	)
+
+458 
+	#Z_NULL
+ 0
+
+	)
+
+460 
+	#zlib_vsi
+ 
+	`zlibVsi
+()
+
+	)
+
+465 
+ZEXTERN
+ c * 
+ZEXPORT
+ 
+zlibVsi
+();
+
+495 
+ZEXTERN
+ 
+ZEXPORT
+ 
+dee
+(
+z_amp
+, );
+
+580 
+ZEXTERN
+ 
+ZEXPORT
+ 
+deeEnd
+(
+z_amp
+);
+
+615 
+ZEXTERN
+ 
+ZEXPORT
+ 
+e
+(
+z_amp
+, );
+
+687 
+ZEXTERN
+ 
+ZEXPORT
+ 
+eEnd
+(
+z_amp
+);
+
+743 
+ZEXTERN
+ 
+ZEXPORT
+ 
+deeSDiiy
+(
+z_amp
+, c 
+Byf
+ *, 
+uI
+);
+
+777 
+ZEXTERN
+ 
+ZEXPORT
+ 
+deeCy
+(
+z_amp
+, z_streamp);
+
+794 
+eIncomp
+(
+z_am
+ *);
+
+803 
+ZEXTERN
+ 
+ZEXPORT
+ 
+deeRet
+(
+z_amp
+);
+
+814 
+ZEXTERN
+ 
+ZEXPORT
+ 
+deePams
+(
+z_amp
+, , );
+
+833 
+ZEXTERN
+ 
+ZEXPORT
+ 
+deeOuutPdg
+(
+z_amp
+);
+
+862 
+ZEXTERN
+ 
+ZEXPORT
+ 
+eSDiiy
+(
+z_amp
+, c 
+Byf
+ *, 
+uI
+);
+
+879 
+ZEXTERN
+ 
+ZEXPORT
+ 
+eSync
+(
+z_amp
+);
+
+894 
+ZEXTERN
+ 
+ZEXPORT
+ 
+eRet
+(
+z_amp
+);
+
+915 
+ZEXTERN
+ 
+ZEXPORT
+ 
+comess
+(
+Byf
+ *, 
+uLgf
+ *, c By*, 
+uLg
+);
+
+929 
+ZEXTERN
+ 
+ZEXPORT
+ 
+comess2
+(
+Byf
+ *, 
+uLgf
+ *, const Bytef *,
+
+930 
+uLg
+, );
+
+943 
+ZEXTERN
+ 
+ZEXPORT
+ 
+uncomess
+(
+Byf
+ *, 
+uLgf
+ *, c By*, 
+uLg
+);
+
+961 
+voidp
+ 
+	tgzFe
+;
+
+963 
+ZEXTERN
+ 
+gzFe
+ 
+ZEXPORT
+ 
+gz
+(const *, const *);
+
+979 
+ZEXTERN
+ 
+gzFe
+ 
+ZEXPORT
+ 
+gzd
+(, const *);
+
+992 
+ZEXTERN
+ 
+ZEXPORT
+ 
+gzams
+(
+gzFe
+, , );
+
+1000 
+ZEXTERN
+ 
+ZEXPORT
+ 
+gzad
+(
+gzFe
+, 
+voidp
+, );
+
+1008 
+ZEXTERN
+ 
+ZEXPORT
+ 
+gzwre
+(
+gzFe
+, c 
+voidp
+, );
+
+1015 
+ZEXTERN
+ 
+ZEXPORTVA
+ 
+gztf
+(
+gzFe
+, const *, ...)
+
+1016 
+__ibu__
+((
+__fm__
+(
+__tf__
+, 2, 3)));
+
+1023 
+ZEXTERN
+ 
+ZEXPORT
+ 
+gzputs
+(
+gzFe
+, const *);
+
+1030 
+ZEXTERN
+ * 
+ZEXPORT
+ 
+gzgs
+(
+gzFe
+, *, );
+
+1039 
+ZEXTERN
+ 
+ZEXPORT
+ 
+gzputc
+(
+gzFe
+, );
+
+1045 
+ZEXTERN
+ 
+ZEXPORT
+ 
+gzgc
+(
+gzFe
+);
+
+1051 
+ZEXTERN
+ 
+ZEXPORT
+ 
+gzush
+(
+gzFe
+, );
+
+1066 
+ZEXTERN
+ 
+z_off_t
+ 
+ZEXPORT
+ 
+gzek
+(
+gzFe
+, z_off_t, );
+
+1083 
+ZEXTERN
+ 
+ZEXPORT
+ 
+gzwd
+(
+gzFe
+);
+
+1094 
+ZEXTERN
+ 
+z_off_t
+ 
+ZEXPORT
+ 
+gz
+(
+gzFe
+);
+
+1103 
+ZEXTERN
+ 
+ZEXPORT
+ 
+gzeof
+(
+gzFe
+);
+
+1109 
+ZEXTERN
+ 
+ZEXPORT
+ 
+gzo
+(
+gzFe
+);
+
+1116 
+ZEXTERN
+ c * 
+ZEXPORT
+ 
+gzr
+(
+gzFe
+, *);
+
+1133 
+ZEXTERN
+ 
+uLg
+ 
+ZEXPORT
+ 
+adr32
+(uLg, c 
+Byf
+ *, 
+uI
+);
+
+1150 #ifde
+STANDALONE
+
+
+1151 
+ZEXTERN
+ 
+uLg
+ 
+ZEXPORT
+ 
+c32
+(uLg, c 
+Byf
+ *, 
+uI
+);
+
+1174 
+ZEXTERN
+ 
+ZEXPORT
+ 
+deeIn_
+(
+z_amp
+, , const *, );
+
+1175 
+ZEXTERN
+ 
+ZEXPORT
+ 
+eIn_
+(
+z_amp
+, const *, );
+
+1176 
+ZEXTERN
+ 
+ZEXPORT
+ 
+deeIn2_
+(
+z_amp
+, , , , ,
+
+1178 
+ZEXTERN
+ 
+ZEXPORT
+ 
+eIn2_
+(
+z_amp
+, , const *, );
+
+1179 
+	#deeIn
+(
+rm
+, 
+v
+) \
+
+1180 
+	`deeIn_
+((
+rm
+), (
+v
+), 
+ZLIB_VERSION
+, (
+z_am
+))
+
+	)
+
+1181 
+	#eIn
+(
+rm
+) \
+
+1182 
+	`eIn_
+((
+rm
+), 
+ZLIB_VERSION
+, (
+z_am
+))
+
+	)
+
+1183 
+	#deeIn2
+(
+rm
+, 
+v
+, 
+mhod
+, 
+wdowBs
+, 
+memLev
+, 
+gy
+) \
+
+1184 
+	`deeIn2_
+((
+rm
+),(
+v
+),(
+mhod
+),(
+wdowBs
+),(
+memLev
+),\
+
+1185 (
+gy
+), 
+ZLIB_VERSION
+, (
+z_am
+))
+
+	)
+
+1186 
+	#eIn2
+(
+rm
+, 
+wdowBs
+) \
+
+1187 
+	`eIn2_
+((
+rm
+), (
+wdowBs
+), 
+ZLIB_VERSION
+, (
+z_am
+))
+
+	)
+
+1190 #i!
+defed
+(
+Z_UTIL_H
+&& !defed(
+NO_DUMMY_DECL
+)
+
+1191 
+	s_e
+ {
+	gdummy
+;};
+
+1194 
+ZEXTERN
+ c * 
+ZEXPORT
+ 
+zE
+();
+
+1195 
+ZEXTERN
+ 
+ZEXPORT
+ 
+eSyncPot
+(
+z_amp
+);
+
+1196 
+ZEXTERN
+ c 
+uLgf
+ * 
+ZEXPORT
+ 
+g_c_b
+();
+
+1198 #ifde
+__lulus
+
+
+	@../../../platform/cos/cosrun.h
+
+1 
+rump_shmem_wre
+(*
+buff
+, 
+size
+, 
+cvm
+, 
+dvm
+);
+
+2 * 
+rump_shmem_ad
+(*
+buff
+, 
+cvm
+, 
+dvm
+);
+
+	@/usr/include/assert.h
+
+22 #ifdef 
+_ASSERT_H
+
+
+24 #unde
+_ASSERT_H
+
+
+25 #unde
+as
+
+
+26 #unde
+__ASSERT_VOID_CAST
+
+
+28 #ifdef 
+__USE_GNU
+
+
+29 #unde
+as_
+
+
+34 
+	#_ASSERT_H
+ 1
+
+	)
+
+35 
+	~<us.h
+>
+
+37 #i
+defed
+ 
+__lulus
+ && 
+__GNUC_PREREQ
+ (2,95)
+
+38 
+	#__ASSERT_VOID_CAST
+ 
+ic_
+<>
+
+	)
+
+40 
+	#__ASSERT_VOID_CAST
+ ()
+
+	)
+
+48 #ifdef 
+NDEBUG
+
+
+50 
+	#as
+(
+ex
+(
+	`__ASSERT_VOID_CAST
+ (0))
+
+	)
+
+58 #ifdef 
+__USE_GNU
+
+
+59 
+	#as_
+(
+um
+(
+	`__ASSERT_VOID_CAST
+ (0))
+
+	)
+
+64 #ide
+_ASSERT_H_DECLS
+
+
+65 
+	#_ASSERT_H_DECLS
+
+
+	)
+
+66 
+__BEGIN_DECLS
+
+
+69 
+	$__as_
+ (c *
+__asi
+, c *
+__fe
+,
+
+70 
+__le
+, c *
+__funi
+)
+
+71 
+__THROW
+ 
+	`__ibu__
+ ((
+__nu__
+));
+
+74 
+	$__as__
+ (
+__um
+, c *
+__fe
+,
+
+75 
+__le
+, c *
+__funi
+)
+
+76 
+__THROW
+ 
+	`__ibu__
+ ((
+__nu__
+));
+
+81 
+	$__as
+ (c *
+__asi
+, c *
+__fe
+, 
+__le
+)
+
+82 
+__THROW
+ 
+	`__ibu__
+ ((
+__nu__
+));
+
+85 
+__END_DECLS
+
+
+88 
+	#as
+(
+ex
+) \
+
+89 ((
+ex
+) \
+
+90 ? 
+	`__ASSERT_VOID_CAST
+ (0) \
+
+91 : 
+	`__as_
+ (
+	`__STRING
+(
+ex
+), 
+__FILE__
+, 
+__LINE__
+, 
+__ASSERT_FUNCTION
+))
+
+	)
+
+93 #ifdef 
+__USE_GNU
+
+
+94 
+	#as_
+(
+um
+) \
+
+95 (!(
+um
+) \
+
+96 ? 
+	`__ASSERT_VOID_CAST
+ (0) \
+
+97 : 
+	`__as__
+ ((
+um
+), 
+__FILE__
+, 
+__LINE__
+, 
+__ASSERT_FUNCTION
+))
+
+	)
+
+105 #i
+defed
+ 
+__lulus
+ ? 
+	`__GNUC_PREREQ
+ (2, 6) : __GNUC_PREREQ (2, 4)
+
+106 
+	#__ASSERT_FUNCTION
+ 
+__PRETTY_FUNCTION__
+
+
+	)
+
+108 #i
+defed
+ 
+__STDC_VERSION__
+ && __STDC_VERSION__ >= 199901L
+
+109 
+	#__ASSERT_FUNCTION
+ 
+__func__
+
+
+	)
+
+111 
+	#__ASSERT_FUNCTION
+ ((c *0)
+
+	)
+
+118 #i
+defed
+ 
+__USE_ISOC11
+ && !defed 
+__lulus
+
+
+120 #unde
+ic_as
+
+
+121 
+	#ic_as
+ 
+_Stic_as
+
+
+	)
+
+	@/usr/include/ctype.h
+
+22 #idef 
+_CTYPE_H
+
+
+23 
+	#_CTYPE_H
+ 1
+
+	)
+
+25 
+	~<us.h
+>
+
+26 
+	~<bs/tys.h
+>
+
+28 
+	g__BEGIN_DECLS
+
+
+30 #ide
+_ISb
+
+
+39 
+	~<dn.h
+>
+
+40 #i
+__BYTE_ORDER
+ =
+__BIG_ENDIAN
+
+
+41 
+	#_ISb
+(
+b
+(1 << (b))
+
+	)
+
+43 
+	#_ISb
+(
+b
+((b< 8 ? ((1 << (b)<< 8: ((1 << (b)>> 8))
+
+	)
+
+48 
+	m_ISu
+ = 
+_ISb
+ (0),
+
+49 
+	m_ISlow
+ = 
+_ISb
+ (1),
+
+50 
+	m_ISpha
+ = 
+_ISb
+ (2),
+
+51 
+	m_ISdig
+ = 
+_ISb
+ (3),
+
+52 
+	m_ISxdig
+ = 
+_ISb
+ (4),
+
+53 
+	m_ISa
+ = 
+_ISb
+ (5),
+
+54 
+	m_ISt
+ = 
+_ISb
+ (6),
+
+55 
+	m_ISgph
+ = 
+_ISb
+ (7),
+
+56 
+	m_ISbnk
+ = 
+_ISb
+ (8),
+
+57 
+	m_ISl
+ = 
+_ISb
+ (9),
+
+58 
+	m_ISpun
+ = 
+_ISb
+ (10),
+
+59 
+	m_ISnum
+ = 
+_ISb
+ (11)
+
+79 c **
+	$__y_b_loc
+ ()
+
+80 
+__THROW
+ 
+	`__ibu__
+ ((
+__c__
+));
+
+81 c 
+__t32_t
+ **
+	$__y_tow_loc
+ ()
+
+82 
+__THROW
+ 
+	`__ibu__
+ ((
+__c__
+));
+
+83 c 
+__t32_t
+ **
+	$__y_tou_loc
+ ()
+
+84 
+__THROW
+ 
+	`__ibu__
+ ((
+__c__
+));
+
+87 #ide
+__lulus
+
+
+88 
+	#__isy
+(
+c
+, 
+ty
+) \
+
+89 ((*
+	`__y_b_loc
+ ())[((
+c
+)] & (
+ty
+)
+
+	)
+
+90 #i
+defed
+ 
+__USE_EXTERN_INLINES
+
+
+91 
+	#__isy_f
+(
+ty
+) \
+
+92 
+__ex_le
+ \
+
+93 
+is
+##
+	`ty
+ (
+__c
+
+__THROW
+ \
+
+95  (*
+	`__y_b_loc
+ ())[((
+__c
+)] & (
+_IS
+##
+ty
+; \
+
+96 
+	}
+
+	)
+}
+
+99 
+	#__iscii
+(
+c
+(((c& ~0x7f=0
+
+	)
+
+100 
+	#__tscii
+(
+c
+((c& 0x7f
+
+	)
+
+102 
+	#__exy
+(
+me
+
+	`me
+ (
+__THROW
+
+
+	)
+
+104 
+__BEGIN_NAMESPACE_STD
+
+
+110 
+__exy
+ (
+ium
+);
+
+111 
+__exy
+ (
+iha
+);
+
+112 
+__exy
+ (
+isl
+);
+
+113 
+__exy
+ (
+isdig
+);
+
+114 
+__exy
+ (
+iow
+);
+
+115 
+__exy
+ (
+isgph
+);
+
+116 
+__exy
+ (
+irt
+);
+
+117 
+__exy
+ (
+iun
+);
+
+118 
+__exy
+ (
+isa
+);
+
+119 
+__exy
+ (
+isu
+);
+
+120 
+__exy
+ (
+isxdig
+);
+
+124 
+	$tow
+ (
+__c
+
+__THROW
+;
+
+127 
+	$tou
+ (
+__c
+
+__THROW
+;
+
+129 
+__END_NAMESPACE_STD
+
+
+133 #ifdef 
+__USE_ISOC99
+
+
+134 
+__BEGIN_NAMESPACE_C99
+
+
+136 
+	`__exy
+ (
+isbnk
+);
+
+138 
+__END_NAMESPACE_C99
+
+
+141 #ifde
+__USE_GNU
+
+
+143 
+	$isy
+ (
+__c
+, 
+__mask
+
+__THROW
+;
+
+146 #i
+defed
+ 
+__USE_SVID
+ || defed 
+__USE_MISC
+ || defed 
+__USE_XOPEN
+
+
+150 
+	$iscii
+ (
+__c
+
+__THROW
+;
+
+154 
+	$tscii
+ (
+__c
+
+__THROW
+;
+
+158 
+	`__exy
+ (
+_tou
+);
+
+159 
+	`__exy
+ (
+_tow
+);
+
+163 
+	#__tobody
+(
+c
+, 
+f
+, 
+a
+, 
+gs
+) \
+
+164 (
+__exnsi__
+ \
+
+165 ({ 
+__s
+; \
+
+166 i( (
+c
+) > 1) \
+
+168 i(
+	`__but_ct_p
+ (
+c
+)) \
+
+170 
+__c
+ = (
+c
+); \
+
+171 
+__s
+ = 
+__c
+ < -128 || __> 255 ? __: (
+a
+)[__c]; \
+
+174 
+__s
+ = 
+f
+ 
+gs
+; \
+
+177 
+__s
+ = (
+a
+)[((
+c
+)]; \
+
+178 
+__s
+; 
+	}
+}))
+
+	)
+
+180 #i!
+defed
+ 
+__NO_CTYPE
+
+
+181 #ifde
+__isy_f
+
+
+182 
+	$__isy_f
+ (
+num
+)
+
+183 
+	$__isy_f
+ (
+pha
+)
+
+184 
+	$__isy_f
+ (
+l
+)
+
+185 
+	$__isy_f
+ (
+dig
+)
+
+186 
+	$__isy_f
+ (
+low
+)
+
+187 
+	$__isy_f
+ (
+gph
+)
+
+188 
+	$__isy_f
+ (
+t
+)
+
+189 
+	$__isy_f
+ (
+pun
+)
+
+190 
+	$__isy_f
+ (
+a
+)
+
+191 
+	$__isy_f
+ (
+u
+)
+
+192 
+	$__isy_f
+ (
+xdig
+)
+
+193 #ifde
+__USE_ISOC99
+
+
+194 
+	$__isy_f
+ (
+bnk
+)
+
+196 #i
+defed
+ 
+__isy
+
+
+197 
+	#ium
+(
+c
+
+	`__isy
+((c), 
+_ISnum
+)
+
+	)
+
+198 
+	#iha
+(
+c
+
+	`__isy
+((c), 
+_ISpha
+)
+
+	)
+
+199 
+	#isl
+(
+c
+
+	`__isy
+((c), 
+_ISl
+)
+
+	)
+
+200 
+	#isdig
+(
+c
+
+	`__isy
+((c), 
+_ISdig
+)
+
+	)
+
+201 
+	#iow
+(
+c
+
+	`__isy
+((c), 
+_ISlow
+)
+
+	)
+
+202 
+	#isgph
+(
+c
+
+	`__isy
+((c), 
+_ISgph
+)
+
+	)
+
+203 
+	#irt
+(
+c
+
+	`__isy
+((c), 
+_ISt
+)
+
+	)
+
+204 
+	#iun
+(
+c
+
+	`__isy
+((c), 
+_ISpun
+)
+
+	)
+
+205 
+	#isa
+(
+c
+
+	`__isy
+((c), 
+_ISa
+)
+
+	)
+
+206 
+	#isu
+(
+c
+
+	`__isy
+((c), 
+_ISu
+)
+
+	)
+
+207 
+	#isxdig
+(
+c
+
+	`__isy
+((c), 
+_ISxdig
+)
+
+	)
+
+208 #ifde
+__USE_ISOC99
+
+
+209 
+	#isbnk
+(
+c
+
+	`__isy
+((c), 
+_ISbnk
+)
+
+	)
+
+213 #ifde
+__USE_EXTERN_INLINES
+
+
+214 
+__ex_le
+ 
+
+215 
+	`__NTH
+ (
+	$tow
+ (
+__c
+))
+
+217  
+__c
+ >-128 && __< 256 ? (*
+	`__y_tow_loc
+ ())[__c] : __c;
+
+218 
+	}
+}
+
+220 
+__ex_le
+ 
+
+221 
+__NTH
+ (
+	$tou
+ (
+__c
+))
+
+223  
+__c
+ >-128 && __< 256 ? (*
+	`__y_tou_loc
+ ())[__c] : __c;
+
+224 
+	}
+}
+
+227 #i
+__GNUC__
+ >2 && 
+defed
+ 
+__OPTIMIZE__
+ && !defed 
+__lulus
+
+
+228 
+	#tow
+(
+c
+
+	`__tobody
+ (c, 
+tow
+, *
+	`__y_tow_loc
+ (), (c))
+
+	)
+
+229 
+	#tou
+(
+c
+
+	`__tobody
+ (c, 
+tou
+, *
+	`__y_tou_loc
+ (), (c))
+
+	)
+
+232 #i
+defed
+ 
+__USE_SVID
+ || defed 
+__USE_MISC
+ || defed 
+__USE_XOPEN
+
+
+233 
+	#iscii
+(
+c
+
+	`__iscii
+ (c)
+
+	)
+
+234 
+	#tscii
+(
+c
+
+	`__tscii
+ (c)
+
+	)
+
+236 
+	#_tow
+(
+c
+(((*
+	`__y_tow_loc
+ ())[((c)])
+
+	)
+
+237 
+	#_tou
+(
+c
+(((*
+	`__y_tou_loc
+ ())[((c)])
+
+	)
+
+243 #ifde
+__USE_XOPEN2K8
+
+
+257 
+	~<xlo.h
+>
+
+261 
+	#__isy_l
+(
+c
+, 
+ty
+, 
+lo
+) \
+
+262 ((
+lo
+)->
+__y_b
+[((
+c
+)] & (
+ty
+)
+
+	)
+
+264 
+	#__exy_l
+(
+me
+) \
+
+265 
+	`me
+ (, 
+__lo_t
+
+__THROW
+
+
+	)
+
+271 
+__exy_l
+ (
+ium_l
+);
+
+272 
+__exy_l
+ (
+iha_l
+);
+
+273 
+__exy_l
+ (
+isl_l
+);
+
+274 
+__exy_l
+ (
+isdig_l
+);
+
+275 
+__exy_l
+ (
+iow_l
+);
+
+276 
+__exy_l
+ (
+isgph_l
+);
+
+277 
+__exy_l
+ (
+irt_l
+);
+
+278 
+__exy_l
+ (
+iun_l
+);
+
+279 
+__exy_l
+ (
+isa_l
+);
+
+280 
+__exy_l
+ (
+isu_l
+);
+
+281 
+__exy_l
+ (
+isxdig_l
+);
+
+283 
+__exy_l
+ (
+isbnk_l
+);
+
+287 
+	$__tow_l
+ (
+__c
+, 
+__lo_t
+ 
+__l
+
+__THROW
+;
+
+288 
+	$tow_l
+ (
+__c
+, 
+__lo_t
+ 
+__l
+
+__THROW
+;
+
+291 
+	$__tou_l
+ (
+__c
+, 
+__lo_t
+ 
+__l
+
+__THROW
+;
+
+292 
+	$tou_l
+ (
+__c
+, 
+__lo_t
+ 
+__l
+
+__THROW
+;
+
+294 #i
+__GNUC__
+ >2 && 
+defed
+ 
+__OPTIMIZE__
+ && !defed 
+__lulus
+
+
+295 
+	#__tow_l
+(
+c
+, 
+lo
+) \
+
+296 
+	`__tobody
+ (
+c
+, 
+__tow_l
+, (
+lo
+)->
+__y_tow
+, (c,o))
+
+	)
+
+297 
+	#__tou_l
+(
+c
+, 
+lo
+) \
+
+298 
+	`__tobody
+ (
+c
+, 
+__tou_l
+, (
+lo
+)->
+__y_tou
+, (c,o))
+
+	)
+
+299 
+	#tow_l
+(
+c
+, 
+lo
+
+	`__tow_l
+ ((c), (lo))
+
+	)
+
+300 
+	#tou_l
+(
+c
+, 
+lo
+
+	`__tou_l
+ ((c), (lo))
+
+	)
+
+304 #ide
+__NO_CTYPE
+
+
+305 
+	#__ium_l
+(
+c
+,
+l
+
+	`__isy_l
+((c), 
+_ISnum
+, (l))
+
+	)
+
+306 
+	#__iha_l
+(
+c
+,
+l
+
+	`__isy_l
+((c), 
+_ISpha
+, (l))
+
+	)
+
+307 
+	#__isl_l
+(
+c
+,
+l
+
+	`__isy_l
+((c), 
+_ISl
+, (l))
+
+	)
+
+308 
+	#__isdig_l
+(
+c
+,
+l
+
+	`__isy_l
+((c), 
+_ISdig
+, (l))
+
+	)
+
+309 
+	#__iow_l
+(
+c
+,
+l
+
+	`__isy_l
+((c), 
+_ISlow
+, (l))
+
+	)
+
+310 
+	#__isgph_l
+(
+c
+,
+l
+
+	`__isy_l
+((c), 
+_ISgph
+, (l))
+
+	)
+
+311 
+	#__irt_l
+(
+c
+,
+l
+
+	`__isy_l
+((c), 
+_ISt
+, (l))
+
+	)
+
+312 
+	#__iun_l
+(
+c
+,
+l
+
+	`__isy_l
+((c), 
+_ISpun
+, (l))
+
+	)
+
+313 
+	#__isa_l
+(
+c
+,
+l
+
+	`__isy_l
+((c), 
+_ISa
+, (l))
+
+	)
+
+314 
+	#__isu_l
+(
+c
+,
+l
+
+	`__isy_l
+((c), 
+_ISu
+, (l))
+
+	)
+
+315 
+	#__isxdig_l
+(
+c
+,
+l
+
+	`__isy_l
+((c), 
+_ISxdig
+, (l))
+
+	)
+
+317 
+	#__isbnk_l
+(
+c
+,
+l
+
+	`__isy_l
+((c), 
+_ISbnk
+, (l))
+
+	)
+
+319 #i
+defed
+ 
+__USE_SVID
+ || defed 
+__USE_MISC
+
+
+320 
+	#__iscii_l
+(
+c
+,
+l
+(), 
+	`__iscii
+ (c))
+
+	)
+
+321 
+	#__tscii_l
+(
+c
+,
+l
+(), 
+	`__tscii
+ (c))
+
+	)
+
+324 
+	#ium_l
+(
+c
+,
+l
+
+	`__ium_l
+ ((c), (l))
+
+	)
+
+325 
+	#iha_l
+(
+c
+,
+l
+
+	`__iha_l
+ ((c), (l))
+
+	)
+
+326 
+	#isl_l
+(
+c
+,
+l
+
+	`__isl_l
+ ((c), (l))
+
+	)
+
+327 
+	#isdig_l
+(
+c
+,
+l
+
+	`__isdig_l
+ ((c), (l))
+
+	)
+
+328 
+	#iow_l
+(
+c
+,
+l
+
+	`__iow_l
+ ((c), (l))
+
+	)
+
+329 
+	#isgph_l
+(
+c
+,
+l
+
+	`__isgph_l
+ ((c), (l))
+
+	)
+
+330 
+	#irt_l
+(
+c
+,
+l
+
+	`__irt_l
+ ((c), (l))
+
+	)
+
+331 
+	#iun_l
+(
+c
+,
+l
+
+	`__iun_l
+ ((c), (l))
+
+	)
+
+332 
+	#isa_l
+(
+c
+,
+l
+
+	`__isa_l
+ ((c), (l))
+
+	)
+
+333 
+	#isu_l
+(
+c
+,
+l
+
+	`__isu_l
+ ((c), (l))
+
+	)
+
+334 
+	#isxdig_l
+(
+c
+,
+l
+
+	`__isxdig_l
+ ((c), (l))
+
+	)
+
+336 
+	#isbnk_l
+(
+c
+,
+l
+
+	`__isbnk_l
+ ((c), (l))
+
+	)
+
+338 #i
+defed
+ 
+__USE_SVID
+ || defed 
+__USE_MISC
+
+
+339 
+	#iscii_l
+(
+c
+,
+l
+
+	`__iscii_l
+ ((c), (l))
+
+	)
+
+340 
+	#tscii_l
+(
+c
+,
+l
+
+	`__tscii_l
+ ((c), (l))
+
+	)
+
+347 
+__END_DECLS
+
+
+	@/usr/include/errno.h
+
+22 #idef 
+_ERRNO_H
+
+
+26 #idef 
+__ed_Emh
+
+
+27 
+	#_ERRNO_H
+ 1
+
+	)
+
+28 
+	~<us.h
+>
+
+31 
+	g__BEGIN_DECLS
+
+
+35 
+	~<bs/o.h
+>
+
+36 #unde
+__ed_Emh
+
+
+38 #ifdef 
+_ERRNO_H
+
+
+45 #idef 
+o
+
+
+46 
+o
+;
+
+49 #ifde
+__USE_GNU
+
+
+54 *
+ogm_voti_me
+, *
+ogm_voti_sht_me
+;
+
+58 
+	g__END_DECLS
+
+
+66 #i
+defed
+ 
+__USE_GNU
+ || defed 
+__ed_r_t
+
+
+67 #ide
+__r_t_defed
+
+
+68 
+	tr_t
+;
+
+69 
+	#__r_t_defed
+ 1
+
+	)
+
+71 #unde
+__ed_r_t
+
+
+	@/usr/include/limits.h
+
+22 #ide
+_LIBC_LIMITS_H_
+
+
+23 
+	#_LIBC_LIMITS_H_
+ 1
+
+	)
+
+25 
+	~<us.h
+>
+
+31 
+	#MB_LEN_MAX
+ 16
+
+	)
+
+36 #i!
+defed
+ 
+__GNUC__
+ || __GNUC__ < 2
+
+41 #ide
+_LIMITS_H
+
+
+42 
+	#_LIMITS_H
+ 1
+
+	)
+
+44 
+	~<bs/wdsize.h
+>
+
+53 
+	#CHAR_BIT
+ 8
+
+	)
+
+56 
+	#SCHAR_MIN
+ (-128)
+
+	)
+
+57 
+	#SCHAR_MAX
+ 127
+
+	)
+
+60 
+	#UCHAR_MAX
+ 255
+
+	)
+
+63 #ifde
+__CHAR_UNSIGNED__
+
+
+64 
+	#CHAR_MIN
+ 0
+
+	)
+
+65 
+	#CHAR_MAX
+ 
+UCHAR_MAX
+
+
+	)
+
+67 
+	#CHAR_MIN
+ 
+SCHAR_MIN
+
+
+	)
+
+68 
+	#CHAR_MAX
+ 
+SCHAR_MAX
+
+
+	)
+
+72 
+	#SHRT_MIN
+ (-32768)
+
+	)
+
+73 
+	#SHRT_MAX
+ 32767
+
+	)
+
+76 
+	#USHRT_MAX
+ 65535
+
+	)
+
+79 
+	#INT_MIN
+ (-
+INT_MAX
+ - 1)
+
+	)
+
+80 
+	#INT_MAX
+ 2147483647
+
+	)
+
+83 
+	#UINT_MAX
+ 4294967295U
+
+	)
+
+86 #i
+__WORDSIZE
+ == 64
+
+87 
+	#LONG_MAX
+ 9223372036854775807L
+
+	)
+
+89 
+	#LONG_MAX
+ 2147483647L
+
+	)
+
+91 
+	#LONG_MIN
+ (-
+LONG_MAX
+ - 1L)
+
+	)
+
+94 #i
+__WORDSIZE
+ == 64
+
+95 
+	#ULONG_MAX
+ 18446744073709551615UL
+
+	)
+
+97 
+	#ULONG_MAX
+ 4294967295UL
+
+	)
+
+100 #ifde
+__USE_ISOC99
+
+
+103 
+	#LLONG_MAX
+ 9223372036854775807LL
+
+	)
+
+104 
+	#LLONG_MIN
+ (-
+LLONG_MAX
+ - 1LL)
+
+	)
+
+107 
+	#ULLONG_MAX
+ 18446744073709551615ULL
+
+	)
+
+121 #i
+defed
+ 
+__GNUC__
+ && !defed 
+_GCC_LIMITS_H_
+
+
+123 #ude_x<
+lims
+.
+h
+>
+
+129 #i
+defed
+ 
+__USE_ISOC99
+ && defed 
+__GNUC__
+
+
+130 #ide
+LLONG_MIN
+
+
+131 
+	#LLONG_MIN
+ (-
+LLONG_MAX
+-1)
+
+	)
+
+133 #ide
+LLONG_MAX
+
+
+134 
+	#LLONG_MAX
+ 
+__LONG_LONG_MAX__
+
+
+	)
+
+136 #ide
+ULLONG_MAX
+
+
+137 
+	#ULLONG_MAX
+ (
+LLONG_MAX
+ * 2ULL + 1)
+
+	)
+
+141 #ifdef 
+__USE_POSIX
+
+
+143 
+	~<bs/posix1_lim.h
+>
+
+146 #ifdef 
+__USE_POSIX2
+
+
+147 
+	~<bs/posix2_lim.h
+>
+
+150 #ifdef 
+__USE_XOPEN
+
+
+151 
+	~<bs/x_lim.h
+>
+
+	@/usr/include/linux/string.h
+
+1 #ide
+_LINUX_STRING_H_
+
+
+2 
+	#_LINUX_STRING_H_
+
+
+	)
+
+6 
+	~<rg.h
+>
+
+	@/usr/include/malloc.h
+
+19 #ide
+_MALLOC_H
+
+
+20 
+	#_MALLOC_H
+ 1
+
+	)
+
+22 
+	~<us.h
+>
+
+23 
+	~<ddef.h
+>
+
+24 
+	~<dio.h
+>
+
+26 #ifde
+_LIBC
+
+
+27 
+	#__MALLOC_HOOK_VOLATILE
+
+
+	)
+
+28 
+	#__MALLOC_DEPRECATED
+
+
+	)
+
+30 
+	#__MALLOC_HOOK_VOLATILE
+ ve
+
+	)
+
+31 
+	#__MALLOC_DEPRECATED
+ 
+__ibu_dd__
+
+
+	)
+
+35 
+__BEGIN_DECLS
+
+
+38 *
+	$mloc
+ (
+size_t
+ 
+__size
+
+__THROW
+ 
+__ibu_mloc__
+ 
+__wur
+;
+
+41 *
+	$oc
+ (
+size_t
+ 
+__nmemb
+, size_
+__size
+)
+
+42 
+__THROW
+ 
+__ibu_mloc__
+ 
+__wur
+;
+
+49 *
+	$loc
+ (*
+__r
+, 
+size_t
+ 
+__size
+)
+
+50 
+__THROW
+ 
+__ibu_wn_unud_su__
+;
+
+53 
+	$
+ (*
+__r
+
+__THROW
+;
+
+56 
+	$c
+ (*
+__r
+
+__THROW
+;
+
+59 *
+	$memign
+ (
+size_t
+ 
+__ignmt
+, size_
+__size
+)
+
+60 
+__THROW
+ 
+__ibu_mloc__
+ 
+__wur
+;
+
+63 *
+	$vloc
+ (
+size_t
+ 
+__size
+
+__THROW
+ 
+__ibu_mloc__
+ 
+__wur
+;
+
+67 *
+	$pvloc
+ (
+size_t
+ 
+__size
+
+__THROW
+ 
+__ibu_mloc__
+ 
+__wur
+;
+
+71 *(*
+__mece
+(
+rdiff_t
+ 
+__size
+);
+
+74 *
+	$__deu_mece
+ (
+rdiff_t
+ 
+__size
+)
+
+75 
+__THROW
+ 
+__ibu_mloc__
+;
+
+79 
+	smlfo
+
+
+81 
+a
+;
+
+82 
+dblks
+;
+
+83 
+smblks
+;
+
+84 
+hblks
+;
+
+85 
+hblkhd
+;
+
+86 
+usmblks
+;
+
+87 
+fsmblks
+;
+
+88 
+udblks
+;
+
+89 
+fdblks
+;
+
+90 
+kpco
+;
+
+94 
+mlfo
+ 
+	$mlfo
+ (
+__THROW
+;
+
+97 #ide
+M_MXFAST
+
+
+98 
+	#M_MXFAST
+ 1
+
+	)
+
+100 #ide
+M_NLBLKS
+
+
+101 
+	#M_NLBLKS
+ 2
+
+	)
+
+103 #ide
+M_GRAIN
+
+
+104 
+	#M_GRAIN
+ 3
+
+	)
+
+106 #ide
+M_KEEP
+
+
+107 
+	#M_KEEP
+ 4
+
+	)
+
+111 
+	#M_TRIM_THRESHOLD
+ -1
+
+	)
+
+112 
+	#M_TOP_PAD
+ -2
+
+	)
+
+113 
+	#M_MMAP_THRESHOLD
+ -3
+
+	)
+
+114 
+	#M_MMAP_MAX
+ -4
+
+	)
+
+115 
+	#M_CHECK_ACTION
+ -5
+
+	)
+
+116 
+	#M_PERTURB
+ -6
+
+	)
+
+117 
+	#M_ARENA_TEST
+ -7
+
+	)
+
+118 
+	#M_ARENA_MAX
+ -8
+
+	)
+
+121 
+	$mlt
+ (
+__m
+, 
+__v
+
+__THROW
+;
+
+125 
+	$mloc_im
+ (
+size_t
+ 
+__d
+
+__THROW
+;
+
+129 
+size_t
+ 
+	$mloc_ub_size
+ (*
+__r
+
+__THROW
+;
+
+132 
+	$mloc_s
+ (
+__THROW
+;
+
+135 
+	$mloc_fo
+ (
+__tis
+, 
+FILE
+ *
+__
+
+__THROW
+;
+
+138 *
+	$mloc_g_e
+ (
+__THROW
+;
+
+142 
+	$mloc_t_e
+ (*
+__r
+
+__THROW
+;
+
+147 (*
+__MALLOC_HOOK_VOLATILE
+ 
+__mloc_lize_hook
+) ()
+
+148 
+__MALLOC_DEPRECATED
+;
+
+150 (*
+__MALLOC_HOOK_VOLATILE
+ 
+___hook
+(*
+__r
+,
+
+152 
+__MALLOC_DEPRECATED
+;
+
+153 *(*
+__MALLOC_HOOK_VOLATILE
+ 
+__mloc_hook
+)(
+size_t
+ 
+__size
+,
+
+155 
+__MALLOC_DEPRECATED
+;
+
+156 *(*
+__MALLOC_HOOK_VOLATILE
+ 
+__loc_hook
+)(*
+__r
+,
+
+157 
+size_t
+ 
+__size
+,
+
+159 
+__MALLOC_DEPRECATED
+;
+
+160 *(*
+__MALLOC_HOOK_VOLATILE
+ 
+__memign_hook
+)(
+size_t
+ 
+__ignmt
+,
+
+161 
+size_t
+ 
+__size
+,
+
+163 
+__MALLOC_DEPRECATED
+;
+
+164 (*
+__MALLOC_HOOK_VOLATILE
+ 
+__a_mece_hook
+) ();
+
+167 
+	$__mloc_check_
+ (
+__THROW
+ 
+__MALLOC_DEPRECATED
+;
+
+170 
+__END_DECLS
+
+
+	@/usr/include/net/if.h
+
+19 #ide
+_NET_IF_H
+
+
+20 
+	#_NET_IF_H
+ 1
+
+	)
+
+22 
+	~<us.h
+>
+
+24 #ifde
+__USE_MISC
+
+
+25 
+	~<sys/tys.h
+>
+
+26 
+	~<sys/sock.h
+>
+
+31 
+	#IF_NAMESIZE
+ 16
+
+	)
+
+33 
+	sif_medex
+
+
+35 
+	mif_dex
+;
+
+36 *
+	mif_me
+;
+
+40 #ifde
+__USE_MISC
+
+
+44 
+	mIFF_UP
+ = 0x1,
+
+45 
+	#IFF_UP
+ 
+IFF_UP
+
+
+	)
+
+46 
+	mIFF_BROADCAST
+ = 0x2,
+
+47 
+	#IFF_BROADCAST
+ 
+IFF_BROADCAST
+
+
+	)
+
+48 
+	mIFF_DEBUG
+ = 0x4,
+
+49 
+	#IFF_DEBUG
+ 
+IFF_DEBUG
+
+
+	)
+
+50 
+	mIFF_LOOPBACK
+ = 0x8,
+
+51 
+	#IFF_LOOPBACK
+ 
+IFF_LOOPBACK
+
+
+	)
+
+52 
+	mIFF_POINTOPOINT
+ = 0x10,
+
+53 
+	#IFF_POINTOPOINT
+ 
+IFF_POINTOPOINT
+
+
+	)
+
+54 
+	mIFF_NOTRAILERS
+ = 0x20,
+
+55 
+	#IFF_NOTRAILERS
+ 
+IFF_NOTRAILERS
+
+
+	)
+
+56 
+	mIFF_RUNNING
+ = 0x40,
+
+57 
+	#IFF_RUNNING
+ 
+IFF_RUNNING
+
+
+	)
+
+58 
+	mIFF_NOARP
+ = 0x80,
+
+59 
+	#IFF_NOARP
+ 
+IFF_NOARP
+
+
+	)
+
+60 
+	mIFF_PROMISC
+ = 0x100,
+
+61 
+	#IFF_PROMISC
+ 
+IFF_PROMISC
+
+
+	)
+
+64 
+	mIFF_ALLMULTI
+ = 0x200,
+
+65 
+	#IFF_ALLMULTI
+ 
+IFF_ALLMULTI
+
+
+	)
+
+67 
+	mIFF_MASTER
+ = 0x400,
+
+68 
+	#IFF_MASTER
+ 
+IFF_MASTER
+
+
+	)
+
+69 
+	mIFF_SLAVE
+ = 0x800,
+
+70 
+	#IFF_SLAVE
+ 
+IFF_SLAVE
+
+
+	)
+
+72 
+	mIFF_MULTICAST
+ = 0x1000,
+
+73 
+	#IFF_MULTICAST
+ 
+IFF_MULTICAST
+
+
+	)
+
+75 
+	mIFF_PORTSEL
+ = 0x2000,
+
+76 
+	#IFF_PORTSEL
+ 
+IFF_PORTSEL
+
+
+	)
+
+77 
+	mIFF_AUTOMEDIA
+ = 0x4000,
+
+78 
+	#IFF_AUTOMEDIA
+ 
+IFF_AUTOMEDIA
+
+
+	)
+
+79 
+	mIFF_DYNAMIC
+ = 0x8000
+
+80 
+	#IFF_DYNAMIC
+ 
+IFF_DYNAMIC
+
+
+	)
+
+88 
+	siddr
+
+
+90 
+sockaddr
+ 
+	mi_addr
+;
+
+93 
+sockaddr
+ 
+	mifu_brdaddr
+;
+
+94 
+sockaddr
+ 
+	mifu_daddr
+;
+
+95 } 
+	mi_ifu
+;
+
+96 
+i
+ *
+	mi_i
+;
+
+97 
+iddr
+ *
+	mi_xt
+;
+
+100 
+	#i_brdaddr
+ 
+i_ifu
+.
+ifu_brdaddr
+
+
+	)
+
+101 
+	#i_daddr
+ 
+i_ifu
+.
+ifu_daddr
+
+
+	)
+
+111 
+	sifm
+
+
+113 
+	mmem_t
+;
+
+114 
+	mmem_d
+;
+
+115 
+	mba_addr
+;
+
+116 
+	mq
+;
+
+117 
+	mdma
+;
+
+118 
+	mpt
+;
+
+126 
+	sieq
+
+
+128 
+	#IFHWADDRLEN
+ 6
+
+	)
+
+129 
+	#IFNAMSIZ
+ 
+IF_NAMESIZE
+
+
+	)
+
+132 
+	min_me
+[
+IFNAMSIZ
+];
+
+133 } 
+	mi_in
+;
+
+137 
+sockaddr
+ 
+	miu_addr
+;
+
+138 
+sockaddr
+ 
+	miu_daddr
+;
+
+139 
+sockaddr
+ 
+	miu_brdaddr
+;
+
+140 
+sockaddr
+ 
+	miu_tmask
+;
+
+141 
+sockaddr
+ 
+	miu_hwaddr
+;
+
+142 
+	miu_ags
+;
+
+143 
+	miu_ivue
+;
+
+144 
+	miu_mtu
+;
+
+145 
+ifm
+ 
+	miu_m
+;
+
+146 
+	miu_ave
+[
+IFNAMSIZ
+];
+
+147 
+	miu_wme
+[
+IFNAMSIZ
+];
+
+148 
+__ddr_t
+ 
+	miu_da
+;
+
+149 } 
+	mi_iu
+;
+
+151 
+	#i_me
+ 
+i_in
+.
+in_me
+
+
+	)
+
+152 
+	#i_hwaddr
+ 
+i_iu
+.
+iu_hwaddr
+
+
+	)
+
+153 
+	#i_addr
+ 
+i_iu
+.
+iu_addr
+
+
+	)
+
+154 
+	#i_daddr
+ 
+i_iu
+.
+iu_daddr
+
+
+	)
+
+155 
+	#i_brdaddr
+ 
+i_iu
+.
+iu_brdaddr
+
+
+	)
+
+156 
+	#i_tmask
+ 
+i_iu
+.
+iu_tmask
+
+
+	)
+
+157 
+	#i_ags
+ 
+i_iu
+.
+iu_ags
+
+
+	)
+
+158 
+	#i_mric
+ 
+i_iu
+.
+iu_ivue
+
+
+	)
+
+159 
+	#i_mtu
+ 
+i_iu
+.
+iu_mtu
+
+
+	)
+
+160 
+	#i_m
+ 
+i_iu
+.
+iu_m
+
+
+	)
+
+161 
+	#i_ave
+ 
+i_iu
+.
+iu_ave
+
+
+	)
+
+162 
+	#i_da
+ 
+i_iu
+.
+iu_da
+
+
+	)
+
+163 
+	#i_ifdex
+ 
+i_iu
+.
+iu_ivue
+
+
+	)
+
+164 
+	#i_bdwidth
+ 
+i_iu
+.
+iu_ivue
+
+
+	)
+
+165 
+	#i_qn
+ 
+i_iu
+.
+iu_ivue
+
+
+	)
+
+166 
+	#i_wme
+ 
+i_iu
+.
+iu_wme
+
+
+	)
+
+167 
+	#_IOT_ieq
+ 
+	`_IOT
+(
+	`_IOTS
+(),
+IFNAMSIZ
+,_IOTS(),16,0,0)
+
+	)
+
+168 
+	#_IOT_ieq_sht
+ 
+	`_IOT
+(
+	`_IOTS
+(),
+IFNAMSIZ
+,_IOTS(),1,0,0)
+
+	)
+
+169 
+	#_IOT_ieq_t
+ 
+	`_IOT
+(
+	`_IOTS
+(),
+IFNAMSIZ
+,_IOTS(),1,0,0)
+
+	)
+
+176 
+	sifcf
+
+
+178 
+	mifc_n
+;
+
+181 
+__ddr_t
+ 
+	mifcu_buf
+;
+
+182 
+ieq
+ *
+	mifcu_q
+;
+
+183 } 
+	mifc_ifcu
+;
+
+185 
+	#ifc_buf
+ 
+ifc_ifcu
+.
+ifcu_buf
+
+
+	)
+
+186 
+	#ifc_q
+ 
+ifc_ifcu
+.
+ifcu_q
+
+
+	)
+
+187 
+	#_IOT_ifcf
+ 
+	`_IOT
+(
+	`_IOTS
+(
+ifcf
+),1,0,0,0,0
+
+	)
+
+190 
+__BEGIN_DECLS
+
+
+193 
+	$if_modex
+ (c *
+__iame
+
+__THROW
+;
+
+194 *
+	$if_dextame
+ (
+__ifdex
+, *
+__iame
+
+__THROW
+;
+
+197 
+if_medex
+ *
+	$if_medex
+ (
+__THROW
+;
+
+200 
+	$if_medex
+ (
+if_medex
+ *
+__r
+
+__THROW
+;
+
+202 
+__END_DECLS
+
+
+	@/usr/include/net/if_arp.h
+
+22 #ide
+_NET_IF_ARP_H
+
+
+24 
+	#_NET_IF_ARP_H
+ 1
+
+	)
+
+25 
+	~<sys/cdefs.h
+>
+
+27 
+	~<sys/tys.h
+>
+
+28 
+	~<sys/sock.h
+>
+
+30 
+	g__BEGIN_DECLS
+
+
+33 
+	#MAX_ADDR_LEN
+ 7
+
+	)
+
+39 
+	#ARPOP_REQUEST
+ 1
+
+	)
+
+40 
+	#ARPOP_REPLY
+ 2
+
+	)
+
+41 
+	#ARPOP_RREQUEST
+ 3
+
+	)
+
+42 
+	#ARPOP_RREPLY
+ 4
+
+	)
+
+43 
+	#ARPOP_InREQUEST
+ 8
+
+	)
+
+44 
+	#ARPOP_InREPLY
+ 9
+
+	)
+
+45 
+	#ARPOP_NAK
+ 10
+
+	)
+
+54 
+	sphdr
+
+
+56 
+	m_hrd
+;
+
+57 
+	m_o
+;
+
+58 
+	m_h
+;
+
+59 
+	m_n
+;
+
+60 
+	m_
+;
+
+64 
+	m___sha
+[
+ETH_ALEN
+];
+
+65 
+	m___s
+[4];
+
+66 
+	m___tha
+[
+ETH_ALEN
+];
+
+67 
+	m___t
+[4];
+
+73 
+	#ARPHRD_NETROM
+ 0
+
+	)
+
+74 
+	#ARPHRD_ETHER
+ 1
+
+	)
+
+75 
+	#ARPHRD_EETHER
+ 2
+
+	)
+
+76 
+	#ARPHRD_AX25
+ 3
+
+	)
+
+77 
+	#ARPHRD_PRONET
+ 4
+
+	)
+
+78 
+	#ARPHRD_CHAOS
+ 5
+
+	)
+
+79 
+	#ARPHRD_IEEE802
+ 6
+
+	)
+
+80 
+	#ARPHRD_ARCNET
+ 7
+
+	)
+
+81 
+	#ARPHRD_APPLETLK
+ 8
+
+	)
+
+82 
+	#ARPHRD_DLCI
+ 15
+
+	)
+
+83 
+	#ARPHRD_ATM
+ 19
+
+	)
+
+84 
+	#ARPHRD_METRICOM
+ 23
+
+	)
+
+85 
+	#ARPHRD_IEEE1394
+ 24
+
+	)
+
+86 
+	#ARPHRD_EUI64
+ 27
+
+	)
+
+87 
+	#ARPHRD_INFINIBAND
+ 32
+
+	)
+
+90 
+	#ARPHRD_SLIP
+ 256
+
+	)
+
+91 
+	#ARPHRD_CSLIP
+ 257
+
+	)
+
+92 
+	#ARPHRD_SLIP6
+ 258
+
+	)
+
+93 
+	#ARPHRD_CSLIP6
+ 259
+
+	)
+
+94 
+	#ARPHRD_RSRVD
+ 260
+
+	)
+
+95 
+	#ARPHRD_ADAPT
+ 264
+
+	)
+
+96 
+	#ARPHRD_ROSE
+ 270
+
+	)
+
+97 
+	#ARPHRD_X25
+ 271
+
+	)
+
+98 
+	#ARPHRD_HWX25
+ 272
+
+	)
+
+99 
+	#ARPHRD_PPP
+ 512
+
+	)
+
+100 
+	#ARPHRD_CISCO
+ 513
+
+	)
+
+101 
+	#ARPHRD_HDLC
+ 
+ARPHRD_CISCO
+
+
+	)
+
+102 
+	#ARPHRD_LAPB
+ 516
+
+	)
+
+103 
+	#ARPHRD_DDCMP
+ 517
+
+	)
+
+104 
+	#ARPHRD_RAWHDLC
+ 518
+
+	)
+
+106 
+	#ARPHRD_TUNNEL
+ 768
+
+	)
+
+107 
+	#ARPHRD_TUNNEL6
+ 769
+
+	)
+
+108 
+	#ARPHRD_FRAD
+ 770
+
+	)
+
+109 
+	#ARPHRD_SKIP
+ 771
+
+	)
+
+110 
+	#ARPHRD_LOOPBACK
+ 772
+
+	)
+
+111 
+	#ARPHRD_LOCALTLK
+ 773
+
+	)
+
+112 
+	#ARPHRD_FDDI
+ 774
+
+	)
+
+113 
+	#ARPHRD_BIF
+ 775
+
+	)
+
+114 
+	#ARPHRD_SIT
+ 776
+
+	)
+
+115 
+	#ARPHRD_IPDDP
+ 777
+
+	)
+
+116 
+	#ARPHRD_IPGRE
+ 778
+
+	)
+
+117 
+	#ARPHRD_PIMREG
+ 779
+
+	)
+
+118 
+	#ARPHRD_HIPPI
+ 780
+
+	)
+
+119 
+	#ARPHRD_ASH
+ 781
+
+	)
+
+120 
+	#ARPHRD_ECONET
+ 782
+
+	)
+
+121 
+	#ARPHRD_IRDA
+ 783
+
+	)
+
+122 
+	#ARPHRD_FCPP
+ 784
+
+	)
+
+123 
+	#ARPHRD_FCAL
+ 785
+
+	)
+
+124 
+	#ARPHRD_FCPL
+ 786
+
+	)
+
+125 
+	#ARPHRD_FCFABRIC
+ 787
+
+	)
+
+126 
+	#ARPHRD_IEEE802_TR
+ 800
+
+	)
+
+127 
+	#ARPHRD_IEEE80211
+ 801
+
+	)
+
+128 
+	#ARPHRD_IEEE80211_PRISM
+ 802
+
+	)
+
+129 
+	#ARPHRD_IEEE80211_RADIOTAP
+ 803
+
+	)
+
+130 
+	#ARPHRD_IEEE802154
+ 804
+
+	)
+
+131 
+	#ARPHRD_IEEE802154_PHY
+ 805
+
+	)
+
+133 
+	#ARPHRD_VOID
+ 0xFFFF
+
+	)
+
+134 
+	#ARPHRD_NONE
+ 0xFFFE
+
+	)
+
+138 
+	seq
+
+
+140 
+sockaddr
+ 
+	mp_
+;
+
+141 
+sockaddr
+ 
+	mp_ha
+;
+
+142 
+	mp_ags
+;
+
+143 
+sockaddr
+ 
+	mp_tmask
+;
+
+144 
+	mp_dev
+[16];
+
+147 
+	seq_d
+
+
+149 
+sockaddr
+ 
+	mp_
+;
+
+150 
+sockaddr
+ 
+	mp_ha
+;
+
+151 
+	mp_ags
+;
+
+152 
+sockaddr
+ 
+	mp_tmask
+;
+
+156 
+	#ATF_COM
+ 0x02
+
+	)
+
+157 
+	#ATF_PERM
+ 0x04
+
+	)
+
+158 
+	#ATF_PUBL
+ 0x08
+
+	)
+
+159 
+	#ATF_USETRAILERS
+ 0x10
+
+	)
+
+160 
+	#ATF_NETMASK
+ 0x20
+
+	)
+
+162 
+	#ATF_DONTPUB
+ 0x40
+
+	)
+
+163 
+	#ATF_MAGIC
+ 0x80
+
+	)
+
+167 
+	#ARPD_UPDATE
+ 0x01
+
+	)
+
+168 
+	#ARPD_LOOKUP
+ 0x02
+
+	)
+
+169 
+	#ARPD_FLUSH
+ 0x03
+
+	)
+
+171 
+	spd_que
+
+
+173 
+	mq
+;
+
+174 
+u_t32_t
+ 
+	m
+;
+
+175 
+	mdev
+;
+
+176 
+	mamp
+;
+
+177 
+	mupded
+;
+
+178 
+	mha
+[
+MAX_ADDR_LEN
+];
+
+181 
+	g__END_DECLS
+
+
+	@/usr/include/net/if_ppp.h
+
+48 #ide
+__NET_IF_PPP_H
+
+
+49 
+	#__NET_IF_PPP_H
+ 1
+
+	)
+
+51 
+	~<sys/tys.h
+>
+
+52 
+	~<sys/cdefs.h
+>
+
+54 
+	~<t/if.h
+>
+
+55 
+	~<sys/iol.h
+>
+
+56 
+	~<t/p_defs.h
+>
+
+58 
+	g__BEGIN_DECLS
+
+
+64 
+	#PPP_MTU
+ 1500
+
+	)
+
+65 
+	#PPP_MAXMRU
+ 65000
+
+	)
+
+66 
+	#PPP_VERSION
+ "2.2.0"
+
+	)
+
+67 
+	#PPP_MAGIC
+ 0x5002
+
+	)
+
+68 
+	#PROTO_IPX
+ 0x002b
+
+	)
+
+69 
+	#PROTO_DNA_RT
+ 0x0027
+
+	)
+
+76 
+	#SC_COMP_PROT
+ 0x00000001
+
+	)
+
+77 
+	#SC_COMP_AC
+ 0x00000002
+
+	)
+
+78 
+	#SC_COMP_TCP
+ 0x00000004
+
+	)
+
+79 
+	#SC_NO_TCP_CCID
+ 0x00000008
+
+	)
+
+80 
+	#SC_REJ_COMP_AC
+ 0x00000010
+
+	)
+
+81 
+	#SC_REJ_COMP_TCP
+ 0x00000020
+
+	)
+
+82 
+	#SC_CCP_OPEN
+ 0x00000040
+
+	)
+
+83 
+	#SC_CCP_UP
+ 0x00000080
+
+	)
+
+84 
+	#SC_ENABLE_IP
+ 0x00000100
+
+	)
+
+85 
+	#SC_COMP_RUN
+ 0x00001000
+
+	)
+
+86 
+	#SC_DECOMP_RUN
+ 0x00002000
+
+	)
+
+87 
+	#SC_DEBUG
+ 0x00010000
+
+	)
+
+88 
+	#SC_LOG_INPKT
+ 0x00020000
+
+	)
+
+89 
+	#SC_LOG_OUTPKT
+ 0x00040000
+
+	)
+
+90 
+	#SC_LOG_RAWIN
+ 0x00080000
+
+	)
+
+91 
+	#SC_LOG_FLUSH
+ 0x00100000
+
+	)
+
+92 
+	#SC_MASK
+ 0x0fE0fff
+
+	)
+
+95 
+	#SC_ESCAPED
+ 0x80000000
+
+	)
+
+96 
+	#SC_FLUSH
+ 0x40000000
+
+	)
+
+97 
+	#SC_VJ_RESET
+ 0x20000000
+
+	)
+
+98 
+	#SC_XMIT_BUSY
+ 0x10000000
+
+	)
+
+99 
+	#SC_RCV_ODDP
+ 0x08000000
+
+	)
+
+100 
+	#SC_RCV_EVNP
+ 0x04000000
+
+	)
+
+101 
+	#SC_RCV_B7_1
+ 0x02000000
+
+	)
+
+102 
+	#SC_RCV_B7_0
+ 0x01000000
+
+	)
+
+103 
+	#SC_DC_FERROR
+ 0x00800000
+
+	)
+
+104 
+	#SC_DC_ERROR
+ 0x00400000
+
+	)
+
+110 
+	siol
+ {
+
+111 
+	moc
+;
+
+112 
+NPmode
+ 
+	mmode
+;
+
+116 
+	sp_ti_da
+ {
+
+117 
+u_t8_t
+ *
+	mr
+;
+
+118 
+u_t32_t
+ 
+	mngth
+;
+
+119 
+	msm
+;
+
+122 
+	sieq
+ {
+
+123 
+ieq
+ 
+	mb
+;
+
+124 
+p_s
+ 
+	ms
+;
+
+127 
+	siceq
+ {
+
+128 
+ieq
+ 
+	mb
+;
+
+129 
+p_comp_s
+ 
+	ms
+;
+
+132 
+	#i__me
+ 
+b
+.
+i_in
+.
+in_me
+
+
+	)
+
+133 
+	#s_r
+ 
+b
+.
+i_iu
+.
+iu_da
+
+
+	)
+
+139 
+	#PPPIOCGFLAGS
+ 
+	`_IOR
+('t', 90, 
+
+	)
+
+140 
+	#PPPIOCSFLAGS
+ 
+	`_IOW
+('t', 89, 
+
+	)
+
+141 
+	#PPPIOCGASYNCMAP
+ 
+	`_IOR
+('t', 88, 
+
+	)
+
+142 
+	#PPPIOCSASYNCMAP
+ 
+	`_IOW
+('t', 87, 
+
+	)
+
+143 
+	#PPPIOCGUNIT
+ 
+	`_IOR
+('t', 86, 
+
+	)
+
+144 
+	#PPPIOCGRASYNCMAP
+ 
+	`_IOR
+('t', 85, 
+
+	)
+
+145 
+	#PPPIOCSRASYNCMAP
+ 
+	`_IOW
+('t', 84, 
+
+	)
+
+146 
+	#PPPIOCGMRU
+ 
+	`_IOR
+('t', 83, 
+
+	)
+
+147 
+	#PPPIOCSMRU
+ 
+	`_IOW
+('t', 82, 
+
+	)
+
+148 
+	#PPPIOCSMAXCID
+ 
+	`_IOW
+('t', 81, 
+
+	)
+
+149 
+	#PPPIOCGXASYNCMAP
+ 
+	`_IOR
+('t', 80, 
+ext_accm
+
+
+	)
+
+150 
+	#PPPIOCSXASYNCMAP
+ 
+	`_IOW
+('t', 79, 
+ext_accm
+
+
+	)
+
+151 
+	#PPPIOCXFERUNIT
+ 
+	`_IO
+('t', 78
+
+	)
+
+152 
+	#PPPIOCSCOMPRESS
+ 
+	`_IOW
+('t', 77, 
+p_ti_da
+)
+
+	)
+
+153 
+	#PPPIOCGNPMODE
+ 
+	`_IOWR
+('t', 76, 
+iol
+
+
+	)
+
+154 
+	#PPPIOCSNPMODE
+ 
+	`_IOW
+('t', 75, 
+iol
+
+
+	)
+
+155 
+	#PPPIOCGDEBUG
+ 
+	`_IOR
+('t', 65, 
+
+	)
+
+156 
+	#PPPIOCSDEBUG
+ 
+	`_IOW
+('t', 64, 
+
+	)
+
+157 
+	#PPPIOCGIDLE
+ 
+	`_IOR
+('t', 63, 
+p_id
+
+
+	)
+
+159 
+	#SIOCGPPPSTATS
+ (
+SIOCDEVPRIVATE
+ + 0)
+
+	)
+
+160 
+	#SIOCGPPPVER
+ (
+SIOCDEVPRIVATE
+ + 1
+
+	)
+
+161 
+	#SIOCGPPPCSTATS
+ (
+SIOCDEVPRIVATE
+ + 2)
+
+	)
+
+163 #i!
+defed
+(
+i_mtu
+)
+
+164 
+	#i_mtu
+ 
+i_iu
+.
+iu_mric
+
+
+	)
+
+167 
+	g__END_DECLS
+
+
+	@/usr/include/net/ppp-comp.h
+
+1 
+	~<lux/p-comp.h
+>
+
+	@/usr/include/net/ppp_defs.h
+
+1 #ide
+_NET_PPP_DEFS_H
+
+
+2 
+	#_NET_PPP_DEFS_H
+ 1
+
+	)
+
+4 
+	#__ed_time_t
+
+
+	)
+
+5 
+	~<time.h
+>
+
+7 
+	~<asm/tys.h
+>
+
+8 
+	~<lux/p_defs.h
+>
+
+	@/usr/include/net/route.h
+
+20 #ide
+_NET_ROUTE_H
+
+
+21 
+	#_NET_ROUTE_H
+ 1
+
+	)
+
+23 
+	~<us.h
+>
+
+24 
+	~<sys/sock.h
+>
+
+25 
+	~<sys/tys.h
+>
+
+26 
+	~<t/.h
+>
+
+27 
+	~<bs/wdsize.h
+>
+
+31 
+	sy
+
+
+33 
+	m_d1
+;
+
+34 
+sockaddr
+ 
+	m_d
+;
+
+35 
+sockaddr
+ 
+	m_geway
+;
+
+36 
+sockaddr
+ 
+	m_gmask
+;
+
+37 
+	m_ags
+;
+
+38 
+	m_d2
+;
+
+39 
+	m_d3
+;
+
+40 
+	m_tos
+;
+
+41 
+	m_ass
+;
+
+42 #i
+__WORDSIZE
+ == 64
+
+43 
+	m_d4
+[3];
+
+45 
+	m_d4
+;
+
+47 
+	m_mric
+;
+
+48 *
+	m_dev
+;
+
+49 
+	m_mtu
+;
+
+50 
+	m_wdow
+;
+
+51 
+	m_
+;
+
+54 
+	#_mss
+ 
+_mtu
+
+
+	)
+
+57 
+	s6_msg
+
+
+59 
+6_addr
+ 
+	mmsg_d
+;
+
+60 
+6_addr
+ 
+	mmsg_c
+;
+
+61 
+6_addr
+ 
+	mmsg_geway
+;
+
+62 
+u_t32_t
+ 
+	mmsg_ty
+;
+
+63 
+u_t16_t
+ 
+	mmsg_d_n
+;
+
+64 
+u_t16_t
+ 
+	mmsg_c_n
+;
+
+65 
+u_t32_t
+ 
+	mmsg_mric
+;
+
+66 
+	mmsg_fo
+;
+
+67 
+u_t32_t
+ 
+	mmsg_ags
+;
+
+68 
+	mmsg_ifdex
+;
+
+72 
+	#RTF_UP
+ 0x0001
+
+	)
+
+73 
+	#RTF_GATEWAY
+ 0x0002
+
+	)
+
+75 
+	#RTF_HOST
+ 0x0004
+
+	)
+
+76 
+	#RTF_REINSTATE
+ 0x0008
+
+	)
+
+77 
+	#RTF_DYNAMIC
+ 0x0010
+
+	)
+
+78 
+	#RTF_MODIFIED
+ 0x0020
+
+	)
+
+79 
+	#RTF_MTU
+ 0x0040
+
+	)
+
+80 
+	#RTF_MSS
+ 
+RTF_MTU
+
+
+	)
+
+81 
+	#RTF_WINDOW
+ 0x0080
+
+	)
+
+82 
+	#RTF_IRTT
+ 0x0100
+
+	)
+
+83 
+	#RTF_REJECT
+ 0x0200
+
+	)
+
+84 
+	#RTF_STATIC
+ 0x0400
+
+	)
+
+85 
+	#RTF_XRESOLVE
+ 0x0800
+
+	)
+
+86 
+	#RTF_NOFORWARD
+ 0x1000
+
+	)
+
+87 
+	#RTF_THROW
+ 0x2000
+
+	)
+
+88 
+	#RTF_NOPMTUDISC
+ 0x4000
+
+	)
+
+91 
+	#RTF_DEFAULT
+ 0x00010000
+
+	)
+
+92 
+	#RTF_ALLONLINK
+ 0x00020000
+
+	)
+
+93 
+	#RTF_ADDRCONF
+ 0x00040000
+
+	)
+
+95 
+	#RTF_LINKRT
+ 0x00100000
+
+	)
+
+96 
+	#RTF_NONEXTHOP
+ 0x00200000
+
+	)
+
+98 
+	#RTF_CACHE
+ 0x01000000
+
+	)
+
+99 
+	#RTF_FLOW
+ 0x02000000
+
+	)
+
+100 
+	#RTF_POLICY
+ 0x04000000
+
+	)
+
+102 
+	#RTCF_VALVE
+ 0x00200000
+
+	)
+
+103 
+	#RTCF_MASQ
+ 0x00400000
+
+	)
+
+104 
+	#RTCF_NAT
+ 0x00800000
+
+	)
+
+105 
+	#RTCF_DOREDIRECT
+ 0x01000000
+
+	)
+
+106 
+	#RTCF_LOG
+ 0x02000000
+
+	)
+
+107 
+	#RTCF_DIRECTSRC
+ 0x04000000
+
+	)
+
+109 
+	#RTF_LOCAL
+ 0x80000000
+
+	)
+
+110 
+	#RTF_INTERFACE
+ 0x40000000
+
+	)
+
+111 
+	#RTF_MULTICAST
+ 0x20000000
+
+	)
+
+112 
+	#RTF_BROADCAST
+ 0x10000000
+
+	)
+
+113 
+	#RTF_NAT
+ 0x08000000
+
+	)
+
+115 
+	#RTF_ADDRCLASSMASK
+ 0xF8000000
+
+	)
+
+116 
+	#RT_ADDRCLASS
+(
+ags
+((
+__u_t32_t
+ag>> 23)
+
+	)
+
+118 
+	#RT_TOS
+(
+tos
+(os& 
+IPTOS_TOS_MASK
+)
+
+	)
+
+120 
+	#RT_LOCALADDR
+(
+ags
+((ag& 
+RTF_ADDRCLASSMASK
+) \
+
+121 =(
+RTF_LOCAL
+|
+RTF_INTERFACE
+))
+
+	)
+
+123 
+	#RT_CLASS_UNSPEC
+ 0
+
+	)
+
+124 
+	#RT_CLASS_DEFAULT
+ 253
+
+	)
+
+126 
+	#RT_CLASS_MAIN
+ 254
+
+	)
+
+127 
+	#RT_CLASS_LOCAL
+ 255
+
+	)
+
+128 
+	#RT_CLASS_MAX
+ 255
+
+	)
+
+131 
+	#RTMSG_ACK
+ 
+NLMSG_ACK
+
+
+	)
+
+132 
+	#RTMSG_OVERRUN
+ 
+NLMSG_OVERRUN
+
+
+	)
+
+134 
+	#RTMSG_NEWDEVICE
+ 0x11
+
+	)
+
+135 
+	#RTMSG_DELDEVICE
+ 0x12
+
+	)
+
+136 
+	#RTMSG_NEWROUTE
+ 0x21
+
+	)
+
+137 
+	#RTMSG_DELROUTE
+ 0x22
+
+	)
+
+138 
+	#RTMSG_NEWRULE
+ 0x31
+
+	)
+
+139 
+	#RTMSG_DELRULE
+ 0x32
+
+	)
+
+140 
+	#RTMSG_CONTROL
+ 0x40
+
+	)
+
+142 
+	#RTMSG_AR_FAILED
+ 0x51
+
+	)
+
+	@/usr/include/netatalk/at.h
+
+18 #ide
+_NETATALK_AT_H
+
+
+19 
+	#_NETATALK_AT_H
+ 1
+
+	)
+
+21 
+	~<asm/tys.h
+>
+
+22 
+	~<bs/sockaddr.h
+>
+
+23 
+	~<lux/k.h
+>
+
+24 
+	~<sys/sock.h
+>
+
+26 
+	#SOL_ATALK
+ 258
+
+	)
+
+	@/usr/include/netinet/icmp6.h
+
+18 #ide
+_NETINET_ICMP6_H
+
+
+19 
+	#_NETINET_ICMP6_H
+ 1
+
+	)
+
+21 
+	~<ys.h
+>
+
+22 
+	~<rg.h
+>
+
+23 
+	~<sys/tys.h
+>
+
+24 
+	~<t/.h
+>
+
+26 
+	#ICMP6_FILTER
+ 1
+
+	)
+
+28 
+	#ICMP6_FILTER_BLOCK
+ 1
+
+	)
+
+29 
+	#ICMP6_FILTER_PASS
+ 2
+
+	)
+
+30 
+	#ICMP6_FILTER_BLOCKOTHERS
+ 3
+
+	)
+
+31 
+	#ICMP6_FILTER_PASSONLY
+ 4
+
+	)
+
+33 
+	sicmp6_fr
+
+
+35 
+ut32_t
+ 
+	micmp6_ft
+[8];
+
+38 
+	sicmp6_hdr
+
+
+40 
+ut8_t
+ 
+	micmp6_ty
+;
+
+41 
+ut8_t
+ 
+	micmp6_code
+;
+
+42 
+ut16_t
+ 
+	micmp6_cksum
+;
+
+45 
+ut32_t
+ 
+	micmp6_un_da32
+[1];
+
+46 
+ut16_t
+ 
+	micmp6_un_da16
+[2];
+
+47 
+ut8_t
+ 
+	micmp6_un_da8
+[4];
+
+48 } 
+	micmp6_daun
+;
+
+51 
+	#icmp6_da32
+ 
+icmp6_daun
+.
+icmp6_un_da32
+
+
+	)
+
+52 
+	#icmp6_da16
+ 
+icmp6_daun
+.
+icmp6_un_da16
+
+
+	)
+
+53 
+	#icmp6_da8
+ 
+icmp6_daun
+.
+icmp6_un_da8
+
+
+	)
+
+54 
+	#icmp6_
+ 
+icmp6_da32
+[0]
+
+	)
+
+55 
+	#icmp6_mtu
+ 
+icmp6_da32
+[0]
+
+	)
+
+56 
+	#icmp6_id
+ 
+icmp6_da16
+[0]
+
+	)
+
+57 
+	#icmp6_q
+ 
+icmp6_da16
+[1]
+
+	)
+
+58 
+	#icmp6_maxday
+ 
+icmp6_da16
+[0]
+
+	)
+
+60 
+	#ICMP6_DST_UNREACH
+ 1
+
+	)
+
+61 
+	#ICMP6_PACKET_TOO_BIG
+ 2
+
+	)
+
+62 
+	#ICMP6_TIME_EXCEEDED
+ 3
+
+	)
+
+63 
+	#ICMP6_PARAM_PROB
+ 4
+
+	)
+
+65 
+	#ICMP6_INFOMSG_MASK
+ 0x80
+
+	)
+
+67 
+	#ICMP6_ECHO_REQUEST
+ 128
+
+	)
+
+68 
+	#ICMP6_ECHO_REPLY
+ 129
+
+	)
+
+69 
+	#MLD_LISTENER_QUERY
+ 130
+
+	)
+
+70 
+	#MLD_LISTENER_REPORT
+ 131
+
+	)
+
+71 
+	#MLD_LISTENER_REDUCTION
+ 132
+
+	)
+
+73 
+	#ICMP6_DST_UNREACH_NOROUTE
+ 0
+
+	)
+
+74 
+	#ICMP6_DST_UNREACH_ADMIN
+ 1
+
+	)
+
+76 
+	#ICMP6_DST_UNREACH_BEYONDSCOPE
+ 2
+
+	)
+
+77 
+	#ICMP6_DST_UNREACH_ADDR
+ 3
+
+	)
+
+78 
+	#ICMP6_DST_UNREACH_NOPORT
+ 4
+
+	)
+
+80 
+	#ICMP6_TIME_EXCEED_TRANSIT
+ 0
+
+	)
+
+81 
+	#ICMP6_TIME_EXCEED_REASSEMBLY
+ 1
+
+	)
+
+83 
+	#ICMP6_PARAMPROB_HEADER
+ 0
+
+	)
+
+84 
+	#ICMP6_PARAMPROB_NEXTHEADER
+ 1
+
+	)
+
+85 
+	#ICMP6_PARAMPROB_OPTION
+ 2
+
+	)
+
+87 
+	#ICMP6_FILTER_WILLPASS
+(
+ty
+, 
+f
+) \
+
+88 ((((
+f
+)->
+icmp6_ft
+[(
+ty
+>> 5]& (1 << (y& 31))=0)
+
+	)
+
+90 
+	#ICMP6_FILTER_WILLBLOCK
+(
+ty
+, 
+f
+) \
+
+91 ((((
+f
+)->
+icmp6_ft
+[(
+ty
+>> 5]& (1 << (y& 31))!0)
+
+	)
+
+93 
+	#ICMP6_FILTER_SETPASS
+(
+ty
+, 
+f
+) \
+
+94 ((((
+f
+)->
+icmp6_ft
+[(
+ty
+>> 5]&~(1 << (y& 31))))
+
+	)
+
+96 
+	#ICMP6_FILTER_SETBLOCK
+(
+ty
+, 
+f
+) \
+
+97 ((((
+f
+)->
+icmp6_ft
+[(
+ty
+>> 5]|(1 << (y& 31))))
+
+	)
+
+99 
+	#ICMP6_FILTER_SETPASSALL
+(
+f
+) \
+
+100 
+	`memt
+ (
+f
+, 0,  (
+icmp6_fr
+));
+
+	)
+
+102 
+	#ICMP6_FILTER_SETBLOCKALL
+(
+f
+) \
+
+103 
+	`memt
+ (
+f
+, 0xFF,  (
+icmp6_fr
+));
+
+	)
+
+105 
+	#ND_ROUTER_SOLICIT
+ 133
+
+	)
+
+106 
+	#ND_ROUTER_ADVERT
+ 134
+
+	)
+
+107 
+	#ND_NEIGHBOR_SOLICIT
+ 135
+
+	)
+
+108 
+	#ND_NEIGHBOR_ADVERT
+ 136
+
+	)
+
+109 
+	#ND_REDIRECT
+ 137
+
+	)
+
+111 
+	snd_rour_sic
+
+
+113 
+icmp6_hdr
+ 
+	mnd_rs_hdr
+;
+
+117 
+	#nd_rs_ty
+ 
+nd_rs_hdr
+.
+icmp6_ty
+
+
+	)
+
+118 
+	#nd_rs_code
+ 
+nd_rs_hdr
+.
+icmp6_code
+
+
+	)
+
+119 
+	#nd_rs_cksum
+ 
+nd_rs_hdr
+.
+icmp6_cksum
+
+
+	)
+
+120 
+	#nd_rs_rved
+ 
+nd_rs_hdr
+.
+icmp6_da32
+[0]
+
+	)
+
+122 
+	snd_rour_advt
+
+
+124 
+icmp6_hdr
+ 
+	mnd__hdr
+;
+
+125 
+ut32_t
+ 
+	mnd__achab
+;
+
+126 
+ut32_t
+ 
+	mnd__sm
+;
+
+130 
+	#nd__ty
+ 
+nd__hdr
+.
+icmp6_ty
+
+
+	)
+
+131 
+	#nd__code
+ 
+nd__hdr
+.
+icmp6_code
+
+
+	)
+
+132 
+	#nd__cksum
+ 
+nd__hdr
+.
+icmp6_cksum
+
+
+	)
+
+133 
+	#nd__curhlim
+ 
+nd__hdr
+.
+icmp6_da8
+[0]
+
+	)
+
+134 
+	#nd__ags_rved
+ 
+nd__hdr
+.
+icmp6_da8
+[1]
+
+	)
+
+135 
+	#ND_RA_FLAG_MANAGED
+ 0x80
+
+	)
+
+136 
+	#ND_RA_FLAG_OTHER
+ 0x40
+
+	)
+
+137 
+	#ND_RA_FLAG_HOME_AGENT
+ 0x20
+
+	)
+
+138 
+	#nd__rour_litime
+ 
+nd__hdr
+.
+icmp6_da16
+[1]
+
+	)
+
+140 
+	snd_ighb_sic
+
+
+142 
+icmp6_hdr
+ 
+	mnd_ns_hdr
+;
+
+143 
+6_addr
+ 
+	mnd_ns_rg
+;
+
+147 
+	#nd_ns_ty
+ 
+nd_ns_hdr
+.
+icmp6_ty
+
+
+	)
+
+148 
+	#nd_ns_code
+ 
+nd_ns_hdr
+.
+icmp6_code
+
+
+	)
+
+149 
+	#nd_ns_cksum
+ 
+nd_ns_hdr
+.
+icmp6_cksum
+
+
+	)
+
+150 
+	#nd_ns_rved
+ 
+nd_ns_hdr
+.
+icmp6_da32
+[0]
+
+	)
+
+152 
+	snd_ighb_advt
+
+
+154 
+icmp6_hdr
+ 
+	mnd__hdr
+;
+
+155 
+6_addr
+ 
+	mnd__rg
+;
+
+159 
+	#nd__ty
+ 
+nd__hdr
+.
+icmp6_ty
+
+
+	)
+
+160 
+	#nd__code
+ 
+nd__hdr
+.
+icmp6_code
+
+
+	)
+
+161 
+	#nd__cksum
+ 
+nd__hdr
+.
+icmp6_cksum
+
+
+	)
+
+162 
+	#nd__ags_rved
+ 
+nd__hdr
+.
+icmp6_da32
+[0]
+
+	)
+
+163 #i 
+BYTE_ORDER
+ =
+BIG_ENDIAN
+
+
+164 
+	#ND_NA_FLAG_ROUTER
+ 0x80000000
+
+	)
+
+165 
+	#ND_NA_FLAG_SOLICITED
+ 0x40000000
+
+	)
+
+166 
+	#ND_NA_FLAG_OVERRIDE
+ 0x20000000
+
+	)
+
+168 
+	#ND_NA_FLAG_ROUTER
+ 0x00000080
+
+	)
+
+169 
+	#ND_NA_FLAG_SOLICITED
+ 0x00000040
+
+	)
+
+170 
+	#ND_NA_FLAG_OVERRIDE
+ 0x00000020
+
+	)
+
+173 
+	snd_de
+
+
+175 
+icmp6_hdr
+ 
+	mnd_rd_hdr
+;
+
+176 
+6_addr
+ 
+	mnd_rd_rg
+;
+
+177 
+6_addr
+ 
+	mnd_rd_d
+;
+
+181 
+	#nd_rd_ty
+ 
+nd_rd_hdr
+.
+icmp6_ty
+
+
+	)
+
+182 
+	#nd_rd_code
+ 
+nd_rd_hdr
+.
+icmp6_code
+
+
+	)
+
+183 
+	#nd_rd_cksum
+ 
+nd_rd_hdr
+.
+icmp6_cksum
+
+
+	)
+
+184 
+	#nd_rd_rved
+ 
+nd_rd_hdr
+.
+icmp6_da32
+[0]
+
+	)
+
+186 
+	snd_t_hdr
+
+
+188 
+ut8_t
+ 
+	mnd_t_ty
+;
+
+189 
+ut8_t
+ 
+	mnd_t_n
+;
+
+193 
+	#ND_OPT_SOURCE_LINKADDR
+ 1
+
+	)
+
+194 
+	#ND_OPT_TARGET_LINKADDR
+ 2
+
+	)
+
+195 
+	#ND_OPT_PREFIX_INFORMATION
+ 3
+
+	)
+
+196 
+	#ND_OPT_REDIRECTED_HEADER
+ 4
+
+	)
+
+197 
+	#ND_OPT_MTU
+ 5
+
+	)
+
+198 
+	#ND_OPT_RTR_ADV_INTERVAL
+ 7
+
+	)
+
+199 
+	#ND_OPT_HOME_AGENT_INFO
+ 8
+
+	)
+
+201 
+	snd_t_efix_fo
+
+
+203 
+ut8_t
+ 
+	mnd_t_pi_ty
+;
+
+204 
+ut8_t
+ 
+	mnd_t_pi_n
+;
+
+205 
+ut8_t
+ 
+	mnd_t_pi_efix_n
+;
+
+206 
+ut8_t
+ 
+	mnd_t_pi_ags_rved
+;
+
+207 
+ut32_t
+ 
+	mnd_t_pi_vid_time
+;
+
+208 
+ut32_t
+ 
+	mnd_t_pi_eed_time
+;
+
+209 
+ut32_t
+ 
+	mnd_t_pi_rved2
+;
+
+210 
+6_addr
+ 
+	mnd_t_pi_efix
+;
+
+213 
+	#ND_OPT_PI_FLAG_ONLINK
+ 0x80
+
+	)
+
+214 
+	#ND_OPT_PI_FLAG_AUTO
+ 0x40
+
+	)
+
+215 
+	#ND_OPT_PI_FLAG_RADDR
+ 0x20
+
+	)
+
+217 
+	snd_t_rd_hdr
+
+
+219 
+ut8_t
+ 
+	mnd_t_rh_ty
+;
+
+220 
+ut8_t
+ 
+	mnd_t_rh_n
+;
+
+221 
+ut16_t
+ 
+	mnd_t_rh_rved1
+;
+
+222 
+ut32_t
+ 
+	mnd_t_rh_rved2
+;
+
+226 
+	snd_t_mtu
+
+
+228 
+ut8_t
+ 
+	mnd_t_mtu_ty
+;
+
+229 
+ut8_t
+ 
+	mnd_t_mtu_n
+;
+
+230 
+ut16_t
+ 
+	mnd_t_mtu_rved
+;
+
+231 
+ut32_t
+ 
+	mnd_t_mtu_mtu
+;
+
+234 
+	smld_hdr
+
+
+236 
+icmp6_hdr
+ 
+	mmld_icmp6_hdr
+;
+
+237 
+6_addr
+ 
+	mmld_addr
+;
+
+240 
+	#mld_ty
+ 
+mld_icmp6_hdr
+.
+icmp6_ty
+
+
+	)
+
+241 
+	#mld_code
+ 
+mld_icmp6_hdr
+.
+icmp6_code
+
+
+	)
+
+242 
+	#mld_cksum
+ 
+mld_icmp6_hdr
+.
+icmp6_cksum
+
+
+	)
+
+243 
+	#mld_maxday
+ 
+mld_icmp6_hdr
+.
+icmp6_da16
+[0]
+
+	)
+
+244 
+	#mld_rved
+ 
+mld_icmp6_hdr
+.
+icmp6_da16
+[1]
+
+	)
+
+246 
+	#ICMP6_ROUTER_RENUMBERING
+ 138
+
+	)
+
+248 
+	sicmp6_rour_num
+
+
+250 
+icmp6_hdr
+ 
+	m_hdr
+;
+
+251 
+ut8_t
+ 
+	m_gnum
+;
+
+252 
+ut8_t
+ 
+	m_ags
+;
+
+253 
+ut16_t
+ 
+	m_maxday
+;
+
+254 
+ut32_t
+ 
+	m_rved
+;
+
+257 
+	#_ty
+ 
+_hdr
+.
+icmp6_ty
+
+
+	)
+
+258 
+	#_code
+ 
+_hdr
+.
+icmp6_code
+
+
+	)
+
+259 
+	#_cksum
+ 
+_hdr
+.
+icmp6_cksum
+
+
+	)
+
+260 
+	#_qnum
+ 
+_hdr
+.
+icmp6_da32
+[0]
+
+	)
+
+263 
+	#ICMP6_RR_FLAGS_TEST
+ 0x80
+
+	)
+
+264 
+	#ICMP6_RR_FLAGS_REQRESULT
+ 0x40
+
+	)
+
+265 
+	#ICMP6_RR_FLAGS_FORCEAPPLY
+ 0x20
+
+	)
+
+266 
+	#ICMP6_RR_FLAGS_SPECSITE
+ 0x10
+
+	)
+
+267 
+	#ICMP6_RR_FLAGS_PREVDONE
+ 0x08
+
+	)
+
+269 
+	s_pco_mch
+
+
+271 
+ut8_t
+ 
+	mm_code
+;
+
+272 
+ut8_t
+ 
+	mm_n
+;
+
+273 
+ut8_t
+ 
+	mm_d
+;
+
+274 
+ut8_t
+ 
+	mm_mchn
+;
+
+275 
+ut8_t
+ 
+	mm_mn
+;
+
+276 
+ut8_t
+ 
+	mm_maxn
+;
+
+277 
+ut16_t
+ 
+	mm_rved
+;
+
+278 
+6_addr
+ 
+	mm_efix
+;
+
+282 
+	#RPM_PCO_ADD
+ 1
+
+	)
+
+283 
+	#RPM_PCO_CHANGE
+ 2
+
+	)
+
+284 
+	#RPM_PCO_SETGLOBAL
+ 3
+
+	)
+
+286 
+	s_pco_u
+
+
+288 
+ut8_t
+ 
+	mu_un
+;
+
+289 
+ut8_t
+ 
+	mu_k
+;
+
+290 
+ut8_t
+ 
+	mu_mask
+;
+
+291 
+ut8_t
+ 
+	mu_ags
+;
+
+292 
+ut32_t
+ 
+	mu_vime
+;
+
+293 
+ut32_t
+ 
+	mu_time
+;
+
+294 
+ut32_t
+ 
+	mu_ags
+;
+
+295 
+6_addr
+ 
+	mu_efix
+;
+
+298 
+	#ICMP6_RR_PCOUSE_RAFLAGS_ONLINK
+ 0x20
+
+	)
+
+299 
+	#ICMP6_RR_PCOUSE_RAFLAGS_AUTO
+ 0x10
+
+	)
+
+301 #i
+BYTE_ORDER
+ =
+BIG_ENDIAN
+
+
+302 
+	#ICMP6_RR_PCOUSE_FLAGS_DECRVLTIME
+ 0x80000000
+
+	)
+
+303 
+	#ICMP6_RR_PCOUSE_FLAGS_DECRPLTIME
+ 0x40000000
+
+	)
+
+304 #i
+BYTE_ORDER
+ =
+LITTLE_ENDIAN
+
+
+305 
+	#ICMP6_RR_PCOUSE_FLAGS_DECRVLTIME
+ 0x80
+
+	)
+
+306 
+	#ICMP6_RR_PCOUSE_FLAGS_DECRPLTIME
+ 0x40
+
+	)
+
+309 
+	s_su
+
+
+311 
+ut16_t
+ 
+	mr_ags
+;
+
+312 
+ut8_t
+ 
+	mr_d
+;
+
+313 
+ut8_t
+ 
+	mr_mchedn
+;
+
+314 
+ut32_t
+ 
+	mr_ifid
+;
+
+315 
+6_addr
+ 
+	mr_efix
+;
+
+318 #i
+BYTE_ORDER
+ =
+BIG_ENDIAN
+
+
+319 
+	#ICMP6_RR_RESULT_FLAGS_OOB
+ 0x0002
+
+	)
+
+320 
+	#ICMP6_RR_RESULT_FLAGS_FORBIDDEN
+ 0x0001
+
+	)
+
+321 #i
+BYTE_ORDER
+ =
+LITTLE_ENDIAN
+
+
+322 
+	#ICMP6_RR_RESULT_FLAGS_OOB
+ 0x0200
+
+	)
+
+323 
+	#ICMP6_RR_RESULT_FLAGS_FORBIDDEN
+ 0x0100
+
+	)
+
+327 
+	snd_t_adv_rv
+
+
+329 
+ut8_t
+ 
+	mnd_t_adv_rv_ty
+;
+
+330 
+ut8_t
+ 
+	mnd_t_adv_rv_n
+;
+
+331 
+ut16_t
+ 
+	mnd_t_adv_rv_rved
+;
+
+332 
+ut32_t
+ 
+	mnd_t_adv_rv_iv
+;
+
+336 
+	snd_t_home_agt_fo
+
+
+338 
+ut8_t
+ 
+	mnd_t_home_agt_fo_ty
+;
+
+339 
+ut8_t
+ 
+	mnd_t_home_agt_fo_n
+;
+
+340 
+ut16_t
+ 
+	mnd_t_home_agt_fo_rved
+;
+
+341 
+ut16_t
+ 
+	mnd_t_home_agt_fo_en
+;
+
+342 
+ut16_t
+ 
+	mnd_t_home_agt_fo_litime
+;
+
+	@/usr/include/netinet/in.h
+
+18 #idef 
+_NETINET_IN_H
+
+
+19 
+	#_NETINET_IN_H
+ 1
+
+	)
+
+21 
+	~<us.h
+>
+
+22 
+	~<dt.h
+>
+
+23 
+	~<sys/sock.h
+>
+
+24 
+	~<bs/tys.h
+>
+
+27 
+__BEGIN_DECLS
+
+
+30 
+ut32_t
+ 
+	t_addr_t
+;
+
+31 
+	s_addr
+
+
+33 
+_addr_t
+ 
+	ms_addr
+;
+
+37 
+	~<bs/.h
+>
+
+42 
+	mIPPROTO_IP
+ = 0,
+
+43 
+	#IPPROTO_IP
+ 
+IPPROTO_IP
+
+
+	)
+
+44 
+	mIPPROTO_ICMP
+ = 1,
+
+45 
+	#IPPROTO_ICMP
+ 
+IPPROTO_ICMP
+
+
+	)
+
+46 
+	mIPPROTO_IGMP
+ = 2,
+
+47 
+	#IPPROTO_IGMP
+ 
+IPPROTO_IGMP
+
+
+	)
+
+48 
+	mIPPROTO_IPIP
+ = 4,
+
+49 
+	#IPPROTO_IPIP
+ 
+IPPROTO_IPIP
+
+
+	)
+
+50 
+	mIPPROTO_TCP
+ = 6,
+
+51 
+	#IPPROTO_TCP
+ 
+IPPROTO_TCP
+
+
+	)
+
+52 
+	mIPPROTO_EGP
+ = 8,
+
+53 
+	#IPPROTO_EGP
+ 
+IPPROTO_EGP
+
+
+	)
+
+54 
+	mIPPROTO_PUP
+ = 12,
+
+55 
+	#IPPROTO_PUP
+ 
+IPPROTO_PUP
+
+
+	)
+
+56 
+	mIPPROTO_UDP
+ = 17,
+
+57 
+	#IPPROTO_UDP
+ 
+IPPROTO_UDP
+
+
+	)
+
+58 
+	mIPPROTO_IDP
+ = 22,
+
+59 
+	#IPPROTO_IDP
+ 
+IPPROTO_IDP
+
+
+	)
+
+60 
+	mIPPROTO_TP
+ = 29,
+
+61 
+	#IPPROTO_TP
+ 
+IPPROTO_TP
+
+
+	)
+
+62 
+	mIPPROTO_DCCP
+ = 33,
+
+63 
+	#IPPROTO_DCCP
+ 
+IPPROTO_DCCP
+
+
+	)
+
+64 
+	mIPPROTO_IPV6
+ = 41,
+
+65 
+	#IPPROTO_IPV6
+ 
+IPPROTO_IPV6
+
+
+	)
+
+66 
+	mIPPROTO_RSVP
+ = 46,
+
+67 
+	#IPPROTO_RSVP
+ 
+IPPROTO_RSVP
+
+
+	)
+
+68 
+	mIPPROTO_GRE
+ = 47,
+
+69 
+	#IPPROTO_GRE
+ 
+IPPROTO_GRE
+
+
+	)
+
+70 
+	mIPPROTO_ESP
+ = 50,
+
+71 
+	#IPPROTO_ESP
+ 
+IPPROTO_ESP
+
+
+	)
+
+72 
+	mIPPROTO_AH
+ = 51,
+
+73 
+	#IPPROTO_AH
+ 
+IPPROTO_AH
+
+
+	)
+
+74 
+	mIPPROTO_MTP
+ = 92,
+
+75 
+	#IPPROTO_MTP
+ 
+IPPROTO_MTP
+
+
+	)
+
+76 
+	mIPPROTO_BEETPH
+ = 94,
+
+77 
+	#IPPROTO_BEETPH
+ 
+IPPROTO_BEETPH
+
+
+	)
+
+78 
+	mIPPROTO_ENCAP
+ = 98,
+
+79 
+	#IPPROTO_ENCAP
+ 
+IPPROTO_ENCAP
+
+
+	)
+
+80 
+	mIPPROTO_PIM
+ = 103,
+
+81 
+	#IPPROTO_PIM
+ 
+IPPROTO_PIM
+
+
+	)
+
+82 
+	mIPPROTO_COMP
+ = 108,
+
+83 
+	#IPPROTO_COMP
+ 
+IPPROTO_COMP
+
+
+	)
+
+84 
+	mIPPROTO_SCTP
+ = 132,
+
+85 
+	#IPPROTO_SCTP
+ 
+IPPROTO_SCTP
+
+
+	)
+
+86 
+	mIPPROTO_UDPLITE
+ = 136,
+
+87 
+	#IPPROTO_UDPLITE
+ 
+IPPROTO_UDPLITE
+
+
+	)
+
+88 
+	mIPPROTO_RAW
+ = 255,
+
+89 
+	#IPPROTO_RAW
+ 
+IPPROTO_RAW
+
+
+	)
+
+90 
+	mIPPROTO_MAX
+
+
+96 #ide
+__USE_KERNEL_IPV6_DEFS
+
+
+99 
+	mIPPROTO_HOPOPTS
+ = 0,
+
+100 
+	#IPPROTO_HOPOPTS
+ 
+IPPROTO_HOPOPTS
+
+
+	)
+
+101 
+	mIPPROTO_ROUTING
+ = 43,
+
+102 
+	#IPPROTO_ROUTING
+ 
+IPPROTO_ROUTING
+
+
+	)
+
+103 
+	mIPPROTO_FRAGMENT
+ = 44,
+
+104 
+	#IPPROTO_FRAGMENT
+ 
+IPPROTO_FRAGMENT
+
+
+	)
+
+105 
+	mIPPROTO_ICMPV6
+ = 58,
+
+106 
+	#IPPROTO_ICMPV6
+ 
+IPPROTO_ICMPV6
+
+
+	)
+
+107 
+	mIPPROTO_NONE
+ = 59,
+
+108 
+	#IPPROTO_NONE
+ 
+IPPROTO_NONE
+
+
+	)
+
+109 
+	mIPPROTO_DSTOPTS
+ = 60,
+
+110 
+	#IPPROTO_DSTOPTS
+ 
+IPPROTO_DSTOPTS
+
+
+	)
+
+111 
+	mIPPROTO_MH
+ = 135
+
+112 
+	#IPPROTO_MH
+ 
+IPPROTO_MH
+
+
+	)
+
+117 
+ut16_t
+ 
+	t_pt_t
+;
+
+122 
+	mIPPORT_ECHO
+ = 7,
+
+123 
+	mIPPORT_DISCARD
+ = 9,
+
+124 
+	mIPPORT_SYSTAT
+ = 11,
+
+125 
+	mIPPORT_DAYTIME
+ = 13,
+
+126 
+	mIPPORT_NETSTAT
+ = 15,
+
+127 
+	mIPPORT_FTP
+ = 21,
+
+128 
+	mIPPORT_TELNET
+ = 23,
+
+129 
+	mIPPORT_SMTP
+ = 25,
+
+130 
+	mIPPORT_TIMESERVER
+ = 37,
+
+131 
+	mIPPORT_NAMESERVER
+ = 42,
+
+132 
+	mIPPORT_WHOIS
+ = 43,
+
+133 
+	mIPPORT_MTP
+ = 57,
+
+135 
+	mIPPORT_TFTP
+ = 69,
+
+136 
+	mIPPORT_RJE
+ = 77,
+
+137 
+	mIPPORT_FINGER
+ = 79,
+
+138 
+	mIPPORT_TTYLINK
+ = 87,
+
+139 
+	mIPPORT_SUPDUP
+ = 95,
+
+142 
+	mIPPORT_EXECSERVER
+ = 512,
+
+143 
+	mIPPORT_LOGINSERVER
+ = 513,
+
+144 
+	mIPPORT_CMDSERVER
+ = 514,
+
+145 
+	mIPPORT_EFSSERVER
+ = 520,
+
+148 
+	mIPPORT_BIFFUDP
+ = 512,
+
+149 
+	mIPPORT_WHOSERVER
+ = 513,
+
+150 
+	mIPPORT_ROUTESERVER
+ = 520,
+
+153 
+	mIPPORT_RESERVED
+ = 1024,
+
+156 
+	mIPPORT_USERRESERVED
+ = 5000
+
+164 
+	#IN_CLASSA
+(
+a
+((((
+_addr_t
+))& 0x80000000=0)
+
+	)
+
+165 
+	#IN_CLASSA_NET
+ 0xff000000
+
+	)
+
+166 
+	#IN_CLASSA_NSHIFT
+ 24
+
+	)
+
+167 
+	#IN_CLASSA_HOST
+ (0xfffffff& ~
+IN_CLASSA_NET
+)
+
+	)
+
+168 
+	#IN_CLASSA_MAX
+ 128
+
+	)
+
+170 
+	#IN_CLASSB
+(
+a
+((((
+_addr_t
+))& 0xc0000000=0x80000000)
+
+	)
+
+171 
+	#IN_CLASSB_NET
+ 0xffff0000
+
+	)
+
+172 
+	#IN_CLASSB_NSHIFT
+ 16
+
+	)
+
+173 
+	#IN_CLASSB_HOST
+ (0xfffffff& ~
+IN_CLASSB_NET
+)
+
+	)
+
+174 
+	#IN_CLASSB_MAX
+ 65536
+
+	)
+
+176 
+	#IN_CLASSC
+(
+a
+((((
+_addr_t
+))& 0xe0000000=0xc0000000)
+
+	)
+
+177 
+	#IN_CLASSC_NET
+ 0xffffff00
+
+	)
+
+178 
+	#IN_CLASSC_NSHIFT
+ 8
+
+	)
+
+179 
+	#IN_CLASSC_HOST
+ (0xfffffff& ~
+IN_CLASSC_NET
+)
+
+	)
+
+181 
+	#IN_CLASSD
+(
+a
+((((
+_addr_t
+))& 0xf0000000=0xe0000000)
+
+	)
+
+182 
+	#IN_MULTICAST
+(
+a
+
+	`IN_CLASSD
+)
+
+	)
+
+184 
+	#IN_EXPERIMENTAL
+(
+a
+((((
+_addr_t
+))& 0xe0000000=0xe0000000)
+
+	)
+
+185 
+	#IN_BADCLASS
+(
+a
+((((
+_addr_t
+))& 0xf0000000=0xf0000000)
+
+	)
+
+188 
+	#INADDR_ANY
+ ((
+_addr_t
+0x00000000)
+
+	)
+
+190 
+	#INADDR_BROADCAST
+ ((
+_addr_t
+0xffffffff)
+
+	)
+
+192 
+	#INADDR_NONE
+ ((
+_addr_t
+0xffffffff)
+
+	)
+
+195 
+	#IN_LOOPBACKNET
+ 127
+
+	)
+
+197 #ide
+INADDR_LOOPBACK
+
+
+198 
+	#INADDR_LOOPBACK
+ ((
+_addr_t
+0x7f000001
+
+	)
+
+202 
+	#INADDR_UNSPEC_GROUP
+ ((
+_addr_t
+0xe0000000
+
+	)
+
+203 
+	#INADDR_ALLHOSTS_GROUP
+ ((
+_addr_t
+0xe0000001
+
+	)
+
+204 
+	#INADDR_ALLRTRS_GROUP
+ ((
+_addr_t
+0xe0000002
+
+	)
+
+205 
+	#INADDR_MAX_LOCAL_GROUP
+ ((
+_addr_t
+0xe00000ff
+
+	)
+
+207 #ide
+__USE_KERNEL_IPV6_DEFS
+
+
+209 
+	s6_addr
+
+
+213 
+ut8_t
+ 
+	m__u6_addr8
+[16];
+
+214 #i
+defed
+ 
+__USE_MISC
+ || defed 
+__USE_GNU
+
+
+215 
+ut16_t
+ 
+	m__u6_addr16
+[8];
+
+216 
+ut32_t
+ 
+	m__u6_addr32
+[4];
+
+218 } 
+	m__6_u
+;
+
+219 
+	#s6_addr
+ 
+__6_u
+.
+__u6_addr8
+
+
+	)
+
+220 #i
+defed
+ 
+__USE_MISC
+ || defed 
+__USE_GNU
+
+
+221 
+	#s6_addr16
+ 
+__6_u
+.
+__u6_addr16
+
+
+	)
+
+222 
+	#s6_addr32
+ 
+__6_u
+.
+__u6_addr32
+
+
+	)
+
+227 c 
+6_addr
+ 
+6addr_y
+;
+
+228 c 
+6_addr
+ 
+6addr_loback
+;
+
+229 
+	#IN6ADDR_ANY_INIT
+ { { { 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 } } }
+
+	)
+
+230 
+	#IN6ADDR_LOOPBACK_INIT
+ { { { 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1 } } }
+
+	)
+
+232 
+	#INET_ADDRSTRLEN
+ 16
+
+	)
+
+233 
+	#INET6_ADDRSTRLEN
+ 46
+
+	)
+
+237 
+	ssockaddr_
+
+
+239 
+__SOCKADDR_COMMON
+ (
+s_
+);
+
+240 
+_pt_t
+ 
+	ms_pt
+;
+
+241 
+_addr
+ 
+	ms_addr
+;
+
+244 
+	ms_zo
+[ (
+sockaddr
+) -
+
+245 
+__SOCKADDR_COMMON_SIZE
+ -
+
+246  (
+_pt_t
+) -
+
+247  (
+_addr
+)];
+
+250 #ide
+__USE_KERNEL_IPV6_DEFS
+
+
+252 
+	ssockaddr_6
+
+
+254 
+__SOCKADDR_COMMON
+ (
+s6_
+);
+
+255 
+_pt_t
+ 
+	ms6_pt
+;
+
+256 
+ut32_t
+ 
+	ms6_owfo
+;
+
+257 
+6_addr
+ 
+	ms6_addr
+;
+
+258 
+ut32_t
+ 
+	ms6_sce_id
+;
+
+262 #i
+defed
+ 
+__USE_MISC
+ || defed 
+__USE_GNU
+
+
+264 
+	s_mq
+
+
+267 
+_addr
+ 
+	mimr_muddr
+;
+
+270 
+_addr
+ 
+	mimr_r
+;
+
+273 
+	s_mq_sour
+
+
+276 
+_addr
+ 
+	mimr_muddr
+;
+
+279 
+_addr
+ 
+	mimr_r
+;
+
+282 
+_addr
+ 
+	mimr_souraddr
+;
+
+286 #ide
+__USE_KERNEL_IPV6_DEFS
+
+
+288 
+	sv6_mq
+
+
+291 
+6_addr
+ 
+	mv6mr_muddr
+;
+
+294 
+	mv6mr_r
+;
+
+298 #i
+defed
+ 
+__USE_MISC
+ || defed 
+__USE_GNU
+
+
+300 
+	sgroup_q
+
+
+303 
+ut32_t
+ 
+	mgr_r
+;
+
+306 
+sockaddr_age
+ 
+	mgr_group
+;
+
+309 
+	sgroup_sour_q
+
+
+312 
+ut32_t
+ 
+	mg_r
+;
+
+315 
+sockaddr_age
+ 
+	mg_group
+;
+
+318 
+sockaddr_age
+ 
+	mg_sour
+;
+
+323 
+	s_msfr
+
+
+326 
+_addr
+ 
+	mimsf_muddr
+;
+
+329 
+_addr
+ 
+	mimsf_r
+;
+
+332 
+ut32_t
+ 
+	mimsf_fmode
+;
+
+335 
+ut32_t
+ 
+	mimsf_numc
+;
+
+337 
+_addr
+ 
+	mimsf_i
+[1];
+
+340 
+	#IP_MSFILTER_SIZE
+(
+numc
+( (
+_msfr
+) \
+
+341 -  (
+_addr
+) \
+
+342 + (
+numc
+*  (
+_addr
+))
+
+	)
+
+344 
+	sgroup_fr
+
+
+347 
+ut32_t
+ 
+	mgf_r
+;
+
+350 
+sockaddr_age
+ 
+	mgf_group
+;
+
+353 
+ut32_t
+ 
+	mgf_fmode
+;
+
+356 
+ut32_t
+ 
+	mgf_numc
+;
+
+358 
+sockaddr_age
+ 
+	mgf_i
+[1];
+
+361 
+	#GROUP_FILTER_SIZE
+(
+numc
+( (
+group_fr
+) \
+
+362 -  (
+sockaddr_age
+) \
+
+363 + ((
+numc
+) \
+
+364 *  (
+sockaddr_age
+)))
+
+	)
+
+374 
+ut32_t
+ 
+	$ohl
+ (
+ut32_t
+ 
+__g
+
+__THROW
+ 
+	`__ibu__
+ ((
+__c__
+));
+
+375 
+ut16_t
+ 
+	$ohs
+ (
+ut16_t
+ 
+__tsht
+)
+
+376 
+__THROW
+ 
+	`__ibu__
+ ((
+__c__
+));
+
+377 
+ut32_t
+ 
+	$htl
+ (
+ut32_t
+ 
+__holg
+)
+
+378 
+__THROW
+ 
+	`__ibu__
+ ((
+__c__
+));
+
+379 
+ut16_t
+ 
+	$hts
+ (
+ut16_t
+ 
+__hosht
+)
+
+380 
+__THROW
+ 
+	`__ibu__
+ ((
+__c__
+));
+
+382 
+	~<dn.h
+>
+
+385 
+	~<bs/bysw.h
+>
+
+387 #ifde
+__OPTIMIZE__
+
+
+391 #i
+__BYTE_ORDER
+ =
+__BIG_ENDIAN
+
+
+394 
+	#ohl
+(
+x
+(x)
+
+	)
+
+395 
+	#ohs
+(
+x
+(x)
+
+	)
+
+396 
+	#htl
+(
+x
+(x)
+
+	)
+
+397 
+	#hts
+(
+x
+(x)
+
+	)
+
+399 #i
+__BYTE_ORDER
+ =
+__LITTLE_ENDIAN
+
+
+400 
+	#ohl
+(
+x
+
+	`__bsw_32
+ (x)
+
+	)
+
+401 
+	#ohs
+(
+x
+
+	`__bsw_16
+ (x)
+
+	)
+
+402 
+	#htl
+(
+x
+
+	`__bsw_32
+ (x)
+
+	)
+
+403 
+	#hts
+(
+x
+
+	`__bsw_16
+ (x)
+
+	)
+
+408 #ifde
+__GNUC__
+
+
+409 
+	#IN6_IS_ADDR_UNSPECIFIED
+(
+a
+) \
+
+410 (
+__exnsi__
+ \
+
+411 ({ c 
+6_addr
+ *
+__a
+ = (c 6_add*(
+a
+); \
+
+412 
+__a
+->
+s6_addr32
+[0] == 0 \
+
+413 && 
+__a
+->
+s6_addr32
+[1] == 0 \
+
+414 && 
+__a
+->
+s6_addr32
+[2] == 0 \
+
+415 && 
+__a
+->
+s6_addr32
+[3] =0; 
+	}
+}))
+
+	)
+
+417 
+	#IN6_IS_ADDR_LOOPBACK
+(
+a
+) \
+
+418 (
+__exnsi__
+ \
+
+419 ({ c 
+6_addr
+ *
+__a
+ = (c 6_add*(
+a
+); \
+
+420 
+__a
+->
+s6_addr32
+[0] == 0 \
+
+421 && 
+__a
+->
+s6_addr32
+[1] == 0 \
+
+422 && 
+__a
+->
+s6_addr32
+[2] == 0 \
+
+423 && 
+__a
+->
+s6_addr32
+[3] =
+	`htl
+ (1); }))
+
+	)
+
+425 
+	#IN6_IS_ADDR_LINKLOCAL
+(
+a
+) \
+
+426 (
+__exnsi__
+ \
+
+427 ({ c 
+6_addr
+ *
+__a
+ = (c 6_add*(
+a
+); \
+
+428 (
+__a
+->
+s6_addr32
+[0] & 
+	`htl
+ (0xffc00000)=ht(0x800000); }))
+
+	)
+
+430 
+	#IN6_IS_ADDR_SITELOCAL
+(
+a
+) \
+
+431 (
+__exnsi__
+ \
+
+432 ({ c 
+6_addr
+ *
+__a
+ = (c 6_add*(
+a
+); \
+
+433 (
+__a
+->
+s6_addr32
+[0] & 
+	`htl
+ (0xffc00000)=ht(0xc00000); }))
+
+	)
+
+435 
+	#IN6_IS_ADDR_V4MAPPED
+(
+a
+) \
+
+436 (
+__exnsi__
+ \
+
+437 ({ c 
+6_addr
+ *
+__a
+ = (c 6_add*(
+a
+); \
+
+438 
+__a
+->
+s6_addr32
+[0] == 0 \
+
+439 && 
+__a
+->
+s6_addr32
+[1] == 0 \
+
+440 && 
+__a
+->
+s6_addr32
+[2] =
+	`htl
+ (0xffff); }))
+
+	)
+
+442 
+	#IN6_IS_ADDR_V4COMPAT
+(
+a
+) \
+
+443 (
+__exnsi__
+ \
+
+444 ({ c 
+6_addr
+ *
+__a
+ = (c 6_add*(
+a
+); \
+
+445 
+__a
+->
+s6_addr32
+[0] == 0 \
+
+446 && 
+__a
+->
+s6_addr32
+[1] == 0 \
+
+447 && 
+__a
+->
+s6_addr32
+[2] == 0 \
+
+448 && 
+	`ohl
+ (
+__a
+->
+s6_addr32
+[3]> 1; }))
+
+	)
+
+450 
+	#IN6_ARE_ADDR_EQUAL
+(
+a
+,
+b
+) \
+
+451 (
+__exnsi__
+ \
+
+452 ({ c 
+6_addr
+ *
+__a
+ = (c 6_add*(
+a
+); \
+
+453 c 
+6_addr
+ *
+__b
+ = (c 6_add*(
+b
+); \
+
+454 
+__a
+->
+s6_addr32
+[0] =
+__b
+->s6_addr32[0] \
+
+455 && 
+__a
+->
+s6_addr32
+[1] =
+__b
+->s6_addr32[1] \
+
+456 && 
+__a
+->
+s6_addr32
+[2] =
+__b
+->s6_addr32[2] \
+
+457 && 
+__a
+->
+s6_addr32
+[3] =
+__b
+->s6_addr32[3]; }))
+
+	)
+
+459 
+	#IN6_IS_ADDR_UNSPECIFIED
+(
+a
+) \
+
+460 (((c 
+ut32_t
+ *(
+a
+))[0] == 0 \
+
+461 && ((c 
+ut32_t
+ *(
+a
+))[1] == 0 \
+
+462 && ((c 
+ut32_t
+ *(
+a
+))[2] == 0 \
+
+463 && ((c 
+ut32_t
+ *(
+a
+))[3] =0)
+
+	)
+
+465 
+	#IN6_IS_ADDR_LOOPBACK
+(
+a
+) \
+
+466 (((c 
+ut32_t
+ *(
+a
+))[0] == 0 \
+
+467 && ((c 
+ut32_t
+ *(
+a
+))[1] == 0 \
+
+468 && ((c 
+ut32_t
+ *(
+a
+))[2] == 0 \
+
+469 && ((c 
+ut32_t
+ *(
+a
+))[3] =
+	`htl
+ (1))
+
+	)
+
+471 
+	#IN6_IS_ADDR_LINKLOCAL
+(
+a
+) \
+
+472 ((((c 
+ut32_t
+ *(
+a
+))[0] & 
+	`htl
+ (0xffc00000)) \
+
+473 =
+	`htl
+ (0x800000))
+
+	)
+
+475 
+	#IN6_IS_ADDR_SITELOCAL
+(
+a
+) \
+
+476 ((((c 
+ut32_t
+ *(
+a
+))[0] & 
+	`htl
+ (0xffc00000)) \
+
+477 =
+	`htl
+ (0xc00000))
+
+	)
+
+479 
+	#IN6_IS_ADDR_V4MAPPED
+(
+a
+) \
+
+480 ((((c 
+ut32_t
+ *(
+a
+))[0] == 0) \
+
+481 && (((c 
+ut32_t
+ *(
+a
+))[1] == 0) \
+
+482 && (((c 
+ut32_t
+ *(
+a
+))[2] =
+	`htl
+ (0xffff)))
+
+	)
+
+484 
+	#IN6_IS_ADDR_V4COMPAT
+(
+a
+) \
+
+485 ((((c 
+ut32_t
+ *(
+a
+))[0] == 0) \
+
+486 && (((c 
+ut32_t
+ *(
+a
+))[1] == 0) \
+
+487 && (((c 
+ut32_t
+ *(
+a
+))[2] == 0) \
+
+488 && (
+	`ohl
+ (((c 
+ut32_t
+ *(
+a
+))[3]> 1))
+
+	)
+
+490 
+	#IN6_ARE_ADDR_EQUAL
+(
+a
+,
+b
+) \
+
+491 ((((c 
+ut32_t
+ *(
+a
+))[0] =((c ut32_*(
+b
+))[0]) \
+
+492 && (((c 
+ut32_t
+ *(
+a
+))[1] =((c ut32_*(
+b
+))[1]) \
+
+493 && (((c 
+ut32_t
+ *(
+a
+))[2] =((c ut32_*(
+b
+))[2]) \
+
+494 && (((c 
+ut32_t
+ *(
+a
+))[3] =((c ut32_*(
+b
+))[3]))
+
+	)
+
+497 
+	#IN6_IS_ADDR_MULTICAST
+(
+a
+(((c 
+ut8_t
+ *))[0] =0xff)
+
+	)
+
+499 #i
+defed
+ 
+__USE_MISC
+ || defed 
+__USE_GNU
+
+
+501 
+	$bdsvpt
+ (
+__sockfd
+, 
+sockaddr_
+ *
+__sock_
+
+__THROW
+;
+
+504 
+	$bdsvpt6
+ (
+__sockfd
+, 
+sockaddr_6
+ *
+__sock_
+)
+
+505 
+__THROW
+;
+
+509 
+	#IN6_IS_ADDR_MC_NODELOCAL
+(
+a
+) \
+
+510 (
+	`IN6_IS_ADDR_MULTICAST
+(
+a
+) \
+
+511 && ((((c 
+ut8_t
+ *(
+a
+))[1] & 0xf=0x1))
+
+	)
+
+513 
+	#IN6_IS_ADDR_MC_LINKLOCAL
+(
+a
+) \
+
+514 (
+	`IN6_IS_ADDR_MULTICAST
+(
+a
+) \
+
+515 && ((((c 
+ut8_t
+ *(
+a
+))[1] & 0xf=0x2))
+
+	)
+
+517 
+	#IN6_IS_ADDR_MC_SITELOCAL
+(
+a
+) \
+
+518 (
+	`IN6_IS_ADDR_MULTICAST
+(
+a
+) \
+
+519 && ((((c 
+ut8_t
+ *(
+a
+))[1] & 0xf=0x5))
+
+	)
+
+521 
+	#IN6_IS_ADDR_MC_ORGLOCAL
+(
+a
+) \
+
+522 (
+	`IN6_IS_ADDR_MULTICAST
+(
+a
+) \
+
+523 && ((((c 
+ut8_t
+ *(
+a
+))[1] & 0xf=0x8))
+
+	)
+
+525 
+	#IN6_IS_ADDR_MC_GLOBAL
+(
+a
+) \
+
+526 (
+	`IN6_IS_ADDR_MULTICAST
+(
+a
+) \
+
+527 && ((((c 
+ut8_t
+ *(
+a
+))[1] & 0xf=0xe))
+
+	)
+
+530 #ifde
+__USE_GNU
+
+
+531 
+cmsghdr
+;
+
+534 
+	s6_pktfo
+
+
+536 
+6_addr
+ 
+i6_addr
+;
+
+537 
+i6_ifdex
+;
+
+541 
+	s6_mtufo
+
+
+543 
+sockaddr_6
+ 
+6m_addr
+;
+
+544 
+ut32_t
+ 
+6m_mtu
+;
+
+549 
+	$6_ti_a
+ (
+__nbys
+)
+
+550 
+__THROW
+ 
+__ibu_dd__
+;
+
+551 
+	$6_ti_
+ (*
+__bp
+, 
+cmsghdr
+ **
+__cmsgp
+,
+
+552 
+__ty
+
+__THROW
+ 
+__ibu_dd__
+;
+
+553 
+	$6_ti_nd
+ (
+cmsghdr
+ *
+__cmsg
+,
+
+554 c 
+ut8_t
+ *
+__typ
+, 
+__mux
+,
+
+555 
+__usy
+
+__THROW
+ 
+__ibu_dd__
+;
+
+556 
+ut8_t
+ *
+	$6_ti_loc
+ (
+cmsghdr
+ *
+__cmsg
+, 
+__d
+,
+
+557 
+__mux
+, 
+__usy
+)
+
+558 
+__THROW
+ 
+__ibu_dd__
+;
+
+559 
+	$6_ti_xt
+ (c 
+cmsghdr
+ *
+__cmsg
+,
+
+560 
+ut8_t
+ **
+__p
+)
+
+561 
+__THROW
+ 
+__ibu_dd__
+;
+
+562 
+	$6_ti_fd
+ (c 
+cmsghdr
+ *
+__cmsg
+,
+
+563 
+ut8_t
+ **
+__p
+, 
+__ty
+)
+
+564 
+__THROW
+ 
+__ibu_dd__
+;
+
+568 
+	$6_t_
+ (*
+__extbuf
+, 
+sockn_t
+ 
+__ex
+
+__THROW
+;
+
+569 
+	$6_t_nd
+ (*
+__extbuf
+, 
+sockn_t
+ 
+__ex
+, 
+__offt
+,
+
+570 
+ut8_t
+ 
+__ty
+, 
+sockn_t
+ 
+__n
+, ut8_
+__ign
+,
+
+571 **
+__dabu
+
+__THROW
+;
+
+572 
+	$6_t_fish
+ (*
+__extbuf
+, 
+sockn_t
+ 
+__ex
+, 
+__offt
+)
+
+573 
+__THROW
+;
+
+574 
+	$6_t_t_v
+ (*
+__dabuf
+, 
+__offt
+, *
+__v
+,
+
+575 
+sockn_t
+ 
+__vn
+
+__THROW
+;
+
+576 
+	$6_t_xt
+ (*
+__extbuf
+, 
+sockn_t
+ 
+__ex
+, 
+__offt
+,
+
+577 
+ut8_t
+ *
+__typ
+, 
+sockn_t
+ *
+__
+,
+
+578 **
+__dabu
+
+__THROW
+;
+
+579 
+	$6_t_fd
+ (*
+__extbuf
+, 
+sockn_t
+ 
+__ex
+, 
+__offt
+,
+
+580 
+ut8_t
+ 
+__ty
+, 
+sockn_t
+ *
+__
+,
+
+581 **
+__dabu
+
+__THROW
+;
+
+582 
+	$6_t_g_v
+ (*
+__dabuf
+, 
+__offt
+, *
+__v
+,
+
+583 
+sockn_t
+ 
+__vn
+
+__THROW
+;
+
+587 
+sockn_t
+ 
+	$6_h_a
+ (
+__ty
+, 
+__gmts
+
+__THROW
+;
+
+588 *
+	$6_h_
+ (*
+__bp
+, 
+sockn_t
+ 
+__bp_n
+, 
+__ty
+,
+
+589 
+__gmts
+
+__THROW
+;
+
+590 
+	$6_h_add
+ (*
+__bp
+, c 
+6_addr
+ *
+__addr
+
+__THROW
+;
+
+591 
+	$6_h_v
+ (c *
+__
+, *
+__out
+
+__THROW
+;
+
+592 
+	$6_h_gmts
+ (c *
+__bp
+
+__THROW
+;
+
+593 
+6_addr
+ *
+	$6_h_gaddr
+ (c *
+__bp
+, 
+__dex
+)
+
+594 
+__THROW
+;
+
+600 
+	$gv4sourfr
+ (
+__s
+, 
+_addr
+ 
+__r_addr
+,
+
+601 
+_addr
+ 
+__group
+, 
+ut32_t
+ *
+__fmode
+,
+
+602 
+ut32_t
+ *
+__numc
+, 
+_addr
+ *
+__i
+)
+
+603 
+__THROW
+;
+
+606 
+	$tv4sourfr
+ (
+__s
+, 
+_addr
+ 
+__r_addr
+,
+
+607 
+_addr
+ 
+__group
+, 
+ut32_t
+ 
+__fmode
+,
+
+608 
+ut32_t
+ 
+__numc
+,
+
+609 c 
+_addr
+ *
+__i
+)
+
+610 
+__THROW
+;
+
+614 
+	$gsourfr
+ (
+__s
+, 
+ut32_t
+ 
+__r_addr
+,
+
+615 c 
+sockaddr
+ *
+__group
+,
+
+616 
+sockn_t
+ 
+__grou
+, 
+ut32_t
+ *
+__fmode
+,
+
+617 
+ut32_t
+ *
+__numc
+,
+
+618 
+sockaddr_age
+ *
+__i
+
+__THROW
+;
+
+621 
+	$tsourfr
+ (
+__s
+, 
+ut32_t
+ 
+__r_addr
+,
+
+622 c 
+sockaddr
+ *
+__group
+,
+
+623 
+sockn_t
+ 
+__grou
+, 
+ut32_t
+ 
+__fmode
+,
+
+624 
+ut32_t
+ 
+__numc
+,
+
+625 c 
+sockaddr_age
+ *
+__i
+
+__THROW
+;
+
+628 
+__END_DECLS
+
+
+	@/usr/include/netinet/in_systm.h
+
+19 #ide
+_NETINET_IN_SYSTM_H
+
+
+20 
+	#_NETINET_IN_SYSTM_H
+ 1
+
+	)
+
+22 
+	~<sys/cdefs.h
+>
+
+23 
+	~<sys/tys.h
+>
+
+25 
+__BEGIN_DECLS
+
+
+34 
+u_t16_t
+ 
+	tn_sht
+;
+
+35 
+u_t32_t
+ 
+	tn_lg
+;
+
+36 
+u_t32_t
+ 
+	tn_time
+;
+
+38 
+	g__END_DECLS
+
+
+	@/usr/include/netinet/ip.h
+
+18 #ide
+__NETINET_IP_H
+
+
+19 
+	#__NETINET_IP_H
+ 1
+
+	)
+
+21 
+	~<us.h
+>
+
+22 
+	~<sys/tys.h
+>
+
+24 
+	~<t/.h
+>
+
+26 
+__BEGIN_DECLS
+
+
+28 
+	stimeamp
+
+
+30 
+u_t8_t
+ 
+	mn
+;
+
+31 
+u_t8_t
+ 
+	mr
+;
+
+32 #i
+__BYTE_ORDER
+ =
+__LITTLE_ENDIAN
+
+
+33 
+	mags
+:4;
+
+34 
+	movow
+:4;
+
+35 #i
+__BYTE_ORDER
+ =
+__BIG_ENDIAN
+
+
+36 
+	movow
+:4;
+
+37 
+	mags
+:4;
+
+41 
+u_t32_t
+ 
+	mda
+[9];
+
+44 
+	shdr
+
+
+46 #i
+__BYTE_ORDER
+ =
+__LITTLE_ENDIAN
+
+
+47 
+	mihl
+:4;
+
+48 
+	mvsi
+:4;
+
+49 #i
+__BYTE_ORDER
+ =
+__BIG_ENDIAN
+
+
+50 
+	mvsi
+:4;
+
+51 
+	mihl
+:4;
+
+55 
+u_t8_t
+ 
+	mtos
+;
+
+56 
+u_t16_t
+ 
+	mt_n
+;
+
+57 
+u_t16_t
+ 
+	mid
+;
+
+58 
+u_t16_t
+ 
+	mag_off
+;
+
+59 
+u_t8_t
+ 
+	ml
+;
+
+60 
+u_t8_t
+ 
+	moc
+;
+
+61 
+u_t16_t
+ 
+	mcheck
+;
+
+62 
+u_t32_t
+ 
+	mddr
+;
+
+63 
+u_t32_t
+ 
+	mdaddr
+;
+
+67 #ifde
+__USE_BSD
+
+
+107 
+	s
+
+
+109 #i
+__BYTE_ORDER
+ =
+__LITTLE_ENDIAN
+
+
+110 
+	m_hl
+:4;
+
+111 
+	m_v
+:4;
+
+113 #i
+__BYTE_ORDER
+ =
+__BIG_ENDIAN
+
+
+114 
+	m_v
+:4;
+
+115 
+	m_hl
+:4;
+
+117 
+u_t8_t
+ 
+	m_tos
+;
+
+118 
+u_sht
+ 
+	m_n
+;
+
+119 
+u_sht
+ 
+	m_id
+;
+
+120 
+u_sht
+ 
+	m_off
+;
+
+121 
+	#IP_RF
+ 0x8000
+
+	)
+
+122 
+	#IP_DF
+ 0x4000
+
+	)
+
+123 
+	#IP_MF
+ 0x2000
+
+	)
+
+124 
+	#IP_OFFMASK
+ 0x1ff
+
+	)
+
+125 
+u_t8_t
+ 
+	m_l
+;
+
+126 
+u_t8_t
+ 
+	m_p
+;
+
+127 
+u_sht
+ 
+	m_sum
+;
+
+128 
+_addr
+ 
+	m_c
+, 
+	m_d
+;
+
+134 
+	s_timeamp
+
+
+136 
+u_t8_t
+ 
+	mt_code
+;
+
+137 
+u_t8_t
+ 
+	mt_n
+;
+
+138 
+u_t8_t
+ 
+	mt_r
+;
+
+139 #i
+__BYTE_ORDER
+ =
+__LITTLE_ENDIAN
+
+
+140 
+	mt_g
+:4;
+
+141 
+	mt_ow
+:4;
+
+143 #i
+__BYTE_ORDER
+ =
+__BIG_ENDIAN
+
+
+144 
+	mt_ow
+:4;
+
+145 
+	mt_g
+:4;
+
+147 
+u_t32_t
+ 
+	mda
+[9];
+
+151 
+	#IPVERSION
+ 4
+
+	)
+
+152 
+	#IP_MAXPACKET
+ 65535
+
+	)
+
+160 
+	#IPTOS_ECN_MASK
+ 0x03
+
+	)
+
+161 
+	#IPTOS_ECN
+(
+x
+((x& 
+IPTOS_ECN_MASK
+)
+
+	)
+
+162 
+	#IPTOS_ECN_NOT_ECT
+ 0x00
+
+	)
+
+163 
+	#IPTOS_ECN_ECT1
+ 0x01
+
+	)
+
+164 
+	#IPTOS_ECN_ECT0
+ 0x02
+
+	)
+
+165 
+	#IPTOS_ECN_CE
+ 0x03
+
+	)
+
+173 
+	#IPTOS_DSCP_MASK
+ 0xfc
+
+	)
+
+174 
+	#IPTOS_DSCP
+(
+x
+((x& 
+IPTOS_DSCP_MASK
+)
+
+	)
+
+175 
+	#IPTOS_DSCP_AF11
+ 0x28
+
+	)
+
+176 
+	#IPTOS_DSCP_AF12
+ 0x30
+
+	)
+
+177 
+	#IPTOS_DSCP_AF13
+ 0x38
+
+	)
+
+178 
+	#IPTOS_DSCP_AF21
+ 0x48
+
+	)
+
+179 
+	#IPTOS_DSCP_AF22
+ 0x50
+
+	)
+
+180 
+	#IPTOS_DSCP_AF23
+ 0x58
+
+	)
+
+181 
+	#IPTOS_DSCP_AF31
+ 0x68
+
+	)
+
+182 
+	#IPTOS_DSCP_AF32
+ 0x70
+
+	)
+
+183 
+	#IPTOS_DSCP_AF33
+ 0x78
+
+	)
+
+184 
+	#IPTOS_DSCP_AF41
+ 0x88
+
+	)
+
+185 
+	#IPTOS_DSCP_AF42
+ 0x90
+
+	)
+
+186 
+	#IPTOS_DSCP_AF43
+ 0x98
+
+	)
+
+187 
+	#IPTOS_DSCP_EF
+ 0xb8
+
+	)
+
+194 
+	#IPTOS_CLASS_MASK
+ 0xe0
+
+	)
+
+195 
+	#IPTOS_CLASS
+(
+ass
+((ass& 
+IPTOS_CLASS_MASK
+)
+
+	)
+
+196 
+	#IPTOS_CLASS_CS0
+ 0x00
+
+	)
+
+197 
+	#IPTOS_CLASS_CS1
+ 0x20
+
+	)
+
+198 
+	#IPTOS_CLASS_CS2
+ 0x40
+
+	)
+
+199 
+	#IPTOS_CLASS_CS3
+ 0x60
+
+	)
+
+200 
+	#IPTOS_CLASS_CS4
+ 0x80
+
+	)
+
+201 
+	#IPTOS_CLASS_CS5
+ 0xa0
+
+	)
+
+202 
+	#IPTOS_CLASS_CS6
+ 0xc0
+
+	)
+
+203 
+	#IPTOS_CLASS_CS7
+ 0xe0
+
+	)
+
+205 
+	#IPTOS_CLASS_DEFAULT
+ 
+IPTOS_CLASS_CS0
+
+
+	)
+
+211 
+	#IPTOS_TOS_MASK
+ 0x1E
+
+	)
+
+212 
+	#IPTOS_TOS
+(
+tos
+(os& 
+IPTOS_TOS_MASK
+)
+
+	)
+
+213 
+	#IPTOS_LOWDELAY
+ 0x10
+
+	)
+
+214 
+	#IPTOS_THROUGHPUT
+ 0x08
+
+	)
+
+215 
+	#IPTOS_RELIABILITY
+ 0x04
+
+	)
+
+216 
+	#IPTOS_LOWCOST
+ 0x02
+
+	)
+
+217 
+	#IPTOS_MINCOST
+ 
+IPTOS_LOWCOST
+
+
+	)
+
+222 
+	#IPTOS_PREC_MASK
+ 
+IPTOS_CLASS_MASK
+
+
+	)
+
+223 
+	#IPTOS_PREC
+(
+tos
+
+	`IPTOS_CLASS
+os)
+
+	)
+
+224 
+	#IPTOS_PREC_NETCONTROL
+ 
+IPTOS_CLASS_CS7
+
+
+	)
+
+225 
+	#IPTOS_PREC_INTERNETCONTROL
+ 
+IPTOS_CLASS_CS6
+
+
+	)
+
+226 
+	#IPTOS_PREC_CRITIC_ECP
+ 
+IPTOS_CLASS_CS5
+
+
+	)
+
+227 
+	#IPTOS_PREC_FLASHOVERRIDE
+ 
+IPTOS_CLASS_CS4
+
+
+	)
+
+228 
+	#IPTOS_PREC_FLASH
+ 
+IPTOS_CLASS_CS3
+
+
+	)
+
+229 
+	#IPTOS_PREC_IMMEDIATE
+ 
+IPTOS_CLASS_CS2
+
+
+	)
+
+230 
+	#IPTOS_PREC_PRIORITY
+ 
+IPTOS_CLASS_CS1
+
+
+	)
+
+231 
+	#IPTOS_PREC_ROUTINE
+ 
+IPTOS_CLASS_CS0
+
+
+	)
+
+236 
+	#IPOPT_COPY
+ 0x80
+
+	)
+
+237 
+	#IPOPT_CLASS_MASK
+ 0x60
+
+	)
+
+238 
+	#IPOPT_NUMBER_MASK
+ 0x1f
+
+	)
+
+240 
+	#IPOPT_COPIED
+(
+o
+((o& 
+IPOPT_COPY
+)
+
+	)
+
+241 
+	#IPOPT_CLASS
+(
+o
+((o& 
+IPOPT_CLASS_MASK
+)
+
+	)
+
+242 
+	#IPOPT_NUMBER
+(
+o
+((o& 
+IPOPT_NUMBER_MASK
+)
+
+	)
+
+244 
+	#IPOPT_CONTROL
+ 0x00
+
+	)
+
+245 
+	#IPOPT_RESERVED1
+ 0x20
+
+	)
+
+246 
+	#IPOPT_DEBMEAS
+ 0x40
+
+	)
+
+247 
+	#IPOPT_MEASUREMENT
+ 
+IPOPT_DEBMEAS
+
+
+	)
+
+248 
+	#IPOPT_RESERVED2
+ 0x60
+
+	)
+
+250 
+	#IPOPT_EOL
+ 0
+
+	)
+
+251 
+	#IPOPT_END
+ 
+IPOPT_EOL
+
+
+	)
+
+252 
+	#IPOPT_NOP
+ 1
+
+	)
+
+253 
+	#IPOPT_NOOP
+ 
+IPOPT_NOP
+
+
+	)
+
+255 
+	#IPOPT_RR
+ 7
+
+	)
+
+256 
+	#IPOPT_TS
+ 68
+
+	)
+
+257 
+	#IPOPT_TIMESTAMP
+ 
+IPOPT_TS
+
+
+	)
+
+258 
+	#IPOPT_SECURITY
+ 130
+
+	)
+
+259 
+	#IPOPT_SEC
+ 
+IPOPT_SECURITY
+
+
+	)
+
+260 
+	#IPOPT_LSRR
+ 131
+
+	)
+
+261 
+	#IPOPT_SATID
+ 136
+
+	)
+
+262 
+	#IPOPT_SID
+ 
+IPOPT_SATID
+
+
+	)
+
+263 
+	#IPOPT_SSRR
+ 137
+
+	)
+
+264 
+	#IPOPT_RA
+ 148
+
+	)
+
+269 
+	#IPOPT_OPTVAL
+ 0
+
+	)
+
+270 
+	#IPOPT_OLEN
+ 1
+
+	)
+
+271 
+	#IPOPT_OFFSET
+ 2
+
+	)
+
+272 
+	#IPOPT_MINOFF
+ 4
+
+	)
+
+274 
+	#MAX_IPOPTLEN
+ 40
+
+	)
+
+277 
+	#IPOPT_TS_TSONLY
+ 0
+
+	)
+
+278 
+	#IPOPT_TS_TSANDADDR
+ 1
+
+	)
+
+279 
+	#IPOPT_TS_PRESPEC
+ 3
+
+	)
+
+282 
+	#IPOPT_SECUR_UNCLASS
+ 0x0000
+
+	)
+
+283 
+	#IPOPT_SECUR_CONFID
+ 0xf135
+
+	)
+
+284 
+	#IPOPT_SECUR_EFTO
+ 0x789a
+
+	)
+
+285 
+	#IPOPT_SECUR_MMMM
+ 0xbc4d
+
+	)
+
+286 
+	#IPOPT_SECUR_RESTR
+ 0xaf13
+
+	)
+
+287 
+	#IPOPT_SECUR_SECRET
+ 0xd788
+
+	)
+
+288 
+	#IPOPT_SECUR_TOPSECRET
+ 0x6bc5
+
+	)
+
+293 
+	#MAXTTL
+ 255
+
+	)
+
+294 
+	#IPDEFTTL
+ 64
+
+	)
+
+295 
+	#IPFRAGTTL
+ 60
+
+	)
+
+296 
+	#IPTTLDEC
+ 1
+
+	)
+
+298 
+	#IP_MSS
+ 576
+
+	)
+
+300 
+	g__END_DECLS
+
+
+	@/usr/include/netinet/ip6.h
+
+18 #ide
+_NETINET_IP6_H
+
+
+19 
+	#_NETINET_IP6_H
+ 1
+
+	)
+
+21 
+	~<ys.h
+>
+
+22 
+	~<t/.h
+>
+
+24 
+	s6_hdr
+
+
+28 
+	s6_hdrl
+
+
+30 
+ut32_t
+ 
+	m6_un1_ow
+;
+
+32 
+ut16_t
+ 
+	m6_un1_
+;
+
+33 
+ut8_t
+ 
+	m6_un1_nxt
+;
+
+34 
+ut8_t
+ 
+	m6_un1_hlim
+;
+
+35 } 
+	m6_un1
+;
+
+36 
+ut8_t
+ 
+	m6_un2_vfc
+;
+
+37 } 
+	m6_lun
+;
+
+38 
+6_addr
+ 
+	m6_c
+;
+
+39 
+6_addr
+ 
+	m6_d
+;
+
+42 
+	#6_vfc
+ 
+6_lun
+.
+6_un2_vfc
+
+
+	)
+
+43 
+	#6_ow
+ 
+6_lun
+.
+6_un1
+.
+6_un1_ow
+
+
+	)
+
+44 
+	#6_
+ 
+6_lun
+.
+6_un1
+.
+6_un1_
+
+
+	)
+
+45 
+	#6_nxt
+ 
+6_lun
+.
+6_un1
+.
+6_un1_nxt
+
+
+	)
+
+46 
+	#6_hlim
+ 
+6_lun
+.
+6_un1
+.
+6_un1_hlim
+
+
+	)
+
+47 
+	#6_hs
+ 
+6_lun
+.
+6_un1
+.
+6_un1_hlim
+
+
+	)
+
+50 
+	s6_ext
+
+
+52 
+ut8_t
+ 
+	m6e_nxt
+;
+
+53 
+ut8_t
+ 
+	m6e_n
+;
+
+57 
+	s6_hbh
+
+
+59 
+ut8_t
+ 
+	m6h_nxt
+;
+
+60 
+ut8_t
+ 
+	m6h_n
+;
+
+65 
+	s6_de
+
+
+67 
+ut8_t
+ 
+	m6d_nxt
+;
+
+68 
+ut8_t
+ 
+	m6d_n
+;
+
+73 
+	s6_hdr
+
+
+75 
+ut8_t
+ 
+	m6r_nxt
+;
+
+76 
+ut8_t
+ 
+	m6r_n
+;
+
+77 
+ut8_t
+ 
+	m6r_ty
+;
+
+78 
+ut8_t
+ 
+	m6r_g
+;
+
+83 
+	s6_hdr0
+
+
+85 
+ut8_t
+ 
+	m6r0_nxt
+;
+
+86 
+ut8_t
+ 
+	m6r0_n
+;
+
+87 
+ut8_t
+ 
+	m6r0_ty
+;
+
+88 
+ut8_t
+ 
+	m6r0_g
+;
+
+89 
+ut8_t
+ 
+	m6r0_rved
+;
+
+90 
+ut8_t
+ 
+	m6r0_m
+[3];
+
+92 
+6_addr
+ 
+	m6r0_addr
+[0];
+
+96 
+	s6_ag
+
+
+98 
+ut8_t
+ 
+	m6f_nxt
+;
+
+99 
+ut8_t
+ 
+	m6f_rved
+;
+
+100 
+ut16_t
+ 
+	m6f_ofg
+;
+
+101 
+ut32_t
+ 
+	m6f_idt
+;
+
+104 #i
+BYTE_ORDER
+ =
+BIG_ENDIAN
+
+
+105 
+	#IP6F_OFF_MASK
+ 0xfff8
+
+	)
+
+106 
+	#IP6F_RESERVED_MASK
+ 0x0006
+
+	)
+
+107 
+	#IP6F_MORE_FRAG
+ 0x0001
+
+	)
+
+109 
+	#IP6F_OFF_MASK
+ 0xf8f
+
+	)
+
+110 
+	#IP6F_RESERVED_MASK
+ 0x0600
+
+	)
+
+111 
+	#IP6F_MORE_FRAG
+ 0x0100
+
+	)
+
+115 
+	s6_t
+
+
+117 
+ut8_t
+ 
+	m6o_ty
+;
+
+118 
+ut8_t
+ 
+	m6o_n
+;
+
+125 
+	#IP6OPT_TYPE
+(
+o
+((o& 0xc0)
+
+	)
+
+126 
+	#IP6OPT_TYPE_SKIP
+ 0x00
+
+	)
+
+127 
+	#IP6OPT_TYPE_DISCARD
+ 0x40
+
+	)
+
+128 
+	#IP6OPT_TYPE_FORCEICMP
+ 0x80
+
+	)
+
+129 
+	#IP6OPT_TYPE_ICMP
+ 0xc0
+
+	)
+
+130 
+	#IP6OPT_TYPE_MUTABLE
+ 0x20
+
+	)
+
+133 
+	#IP6OPT_PAD1
+ 0
+
+	)
+
+134 
+	#IP6OPT_PADN
+ 1
+
+	)
+
+136 
+	#IP6OPT_JUMBO
+ 0xc2
+
+	)
+
+137 
+	#IP6OPT_NSAP_ADDR
+ 0xc3
+
+	)
+
+138 
+	#IP6OPT_TUNNEL_LIMIT
+ 0x04
+
+	)
+
+139 
+	#IP6OPT_ROUTER_ALERT
+ 0x05
+
+	)
+
+142 
+	s6_t_jumbo
+
+
+144 
+ut8_t
+ 
+	m6oj_ty
+;
+
+145 
+ut8_t
+ 
+	m6oj_n
+;
+
+146 
+ut8_t
+ 
+	m6oj_jumbo_n
+[4];
+
+148 
+	#IP6OPT_JUMBO_LEN
+ 6
+
+	)
+
+151 
+	s6_t_np
+
+
+153 
+ut8_t
+ 
+	m6_ty
+;
+
+154 
+ut8_t
+ 
+	m6_n
+;
+
+155 
+ut8_t
+ 
+	m6_c_np_n
+;
+
+156 
+ut8_t
+ 
+	m6_d_np_n
+;
+
+162 
+	s6_t_tu
+
+
+164 
+ut8_t
+ 
+	m6_ty
+;
+
+165 
+ut8_t
+ 
+	m6_n
+;
+
+166 
+ut8_t
+ 
+	m6_p_lim
+;
+
+170 
+	s6_t_rour
+
+
+172 
+ut8_t
+ 
+	m6_ty
+;
+
+173 
+ut8_t
+ 
+	m6_n
+;
+
+174 
+ut8_t
+ 
+	m6_vue
+[2];
+
+178 #i
+BYTE_ORDER
+ =
+BIG_ENDIAN
+
+
+179 
+	#IP6_ALERT_MLD
+ 0x0000
+
+	)
+
+180 
+	#IP6_ALERT_RSVP
+ 0x0001
+
+	)
+
+181 
+	#IP6_ALERT_AN
+ 0x0002
+
+	)
+
+183 
+	#IP6_ALERT_MLD
+ 0x0000
+
+	)
+
+184 
+	#IP6_ALERT_RSVP
+ 0x0100
+
+	)
+
+185 
+	#IP6_ALERT_AN
+ 0x0200
+
+	)
+
+	@/usr/include/netinet/ip_icmp.h
+
+18 #ide
+__NETINET_IP_ICMP_H
+
+
+19 
+	#__NETINET_IP_ICMP_H
+ 1
+
+	)
+
+21 
+	~<sys/cdefs.h
+>
+
+22 
+	~<sys/tys.h
+>
+
+24 
+__BEGIN_DECLS
+
+
+26 
+	sicmphdr
+
+
+28 
+u_t8_t
+ 
+	mty
+;
+
+29 
+u_t8_t
+ 
+	mcode
+;
+
+30 
+u_t16_t
+ 
+	mchecksum
+;
+
+35 
+u_t16_t
+ 
+	mid
+;
+
+36 
+u_t16_t
+ 
+	mqu
+;
+
+37 } 
+	mecho
+;
+
+38 
+u_t32_t
+ 
+	mgeway
+;
+
+41 
+u_t16_t
+ 
+	m__glibc_rved
+;
+
+42 
+u_t16_t
+ 
+	mmtu
+;
+
+43 } 
+	mag
+;
+
+44 } 
+	mun
+;
+
+47 
+	#ICMP_ECHOREPLY
+ 0
+
+	)
+
+48 
+	#ICMP_DEST_UNREACH
+ 3
+
+	)
+
+49 
+	#ICMP_SOURCE_QUENCH
+ 4
+
+	)
+
+50 
+	#ICMP_REDIRECT
+ 5
+
+	)
+
+51 
+	#ICMP_ECHO
+ 8
+
+	)
+
+52 
+	#ICMP_TIME_EXCEEDED
+ 11
+
+	)
+
+53 
+	#ICMP_PARAMETERPROB
+ 12
+
+	)
+
+54 
+	#ICMP_TIMESTAMP
+ 13
+
+	)
+
+55 
+	#ICMP_TIMESTAMPREPLY
+ 14
+
+	)
+
+56 
+	#ICMP_INFO_REQUEST
+ 15
+
+	)
+
+57 
+	#ICMP_INFO_REPLY
+ 16
+
+	)
+
+58 
+	#ICMP_ADDRESS
+ 17
+
+	)
+
+59 
+	#ICMP_ADDRESSREPLY
+ 18
+
+	)
+
+60 
+	#NR_ICMP_TYPES
+ 18
+
+	)
+
+64 
+	#ICMP_NET_UNREACH
+ 0
+
+	)
+
+65 
+	#ICMP_HOST_UNREACH
+ 1
+
+	)
+
+66 
+	#ICMP_PROT_UNREACH
+ 2
+
+	)
+
+67 
+	#ICMP_PORT_UNREACH
+ 3
+
+	)
+
+68 
+	#ICMP_FRAG_NEEDED
+ 4
+
+	)
+
+69 
+	#ICMP_SR_FAILED
+ 5
+
+	)
+
+70 
+	#ICMP_NET_UNKNOWN
+ 6
+
+	)
+
+71 
+	#ICMP_HOST_UNKNOWN
+ 7
+
+	)
+
+72 
+	#ICMP_HOST_ISOLATED
+ 8
+
+	)
+
+73 
+	#ICMP_NET_ANO
+ 9
+
+	)
+
+74 
+	#ICMP_HOST_ANO
+ 10
+
+	)
+
+75 
+	#ICMP_NET_UNR_TOS
+ 11
+
+	)
+
+76 
+	#ICMP_HOST_UNR_TOS
+ 12
+
+	)
+
+77 
+	#ICMP_PKT_FILTERED
+ 13
+
+	)
+
+78 
+	#ICMP_PREC_VIOLATION
+ 14
+
+	)
+
+79 
+	#ICMP_PREC_CUTOFF
+ 15
+
+	)
+
+80 
+	#NR_ICMP_UNREACH
+ 15
+
+	)
+
+83 
+	#ICMP_REDIR_NET
+ 0
+
+	)
+
+84 
+	#ICMP_REDIR_HOST
+ 1
+
+	)
+
+85 
+	#ICMP_REDIR_NETTOS
+ 2
+
+	)
+
+86 
+	#ICMP_REDIR_HOSTTOS
+ 3
+
+	)
+
+89 
+	#ICMP_EXC_TTL
+ 0
+
+	)
+
+90 
+	#ICMP_EXC_FRAGTIME
+ 1
+
+	)
+
+93 #ifde
+__USE_BSD
+
+
+125 
+	~<t/.h
+>
+
+126 
+	~<t/.h
+>
+
+131 
+	sicmp__addr
+
+
+133 
+u_t32_t
+ 
+	ma_addr
+;
+
+134 
+u_t32_t
+ 
+	ma_en
+;
+
+137 
+	sicmp
+
+
+139 
+u_t8_t
+ 
+	micmp_ty
+;
+
+140 
+u_t8_t
+ 
+	micmp_code
+;
+
+141 
+u_t16_t
+ 
+	micmp_cksum
+;
+
+144 
+u_ch
+ 
+	mih_
+;
+
+145 
+_addr
+ 
+	mih_gwaddr
+;
+
+146 
+	sih_idq
+
+
+148 
+u_t16_t
+ 
+	micd_id
+;
+
+149 
+u_t16_t
+ 
+	micd_q
+;
+
+150 } 
+	mih_idq
+;
+
+151 
+u_t32_t
+ 
+	mih_void
+;
+
+154 
+	sih_pmtu
+
+
+156 
+u_t16_t
+ 
+	mm_void
+;
+
+157 
+u_t16_t
+ 
+	mm_xtmtu
+;
+
+158 } 
+	mih_pmtu
+;
+
+160 
+	sih_dv
+
+
+162 
+u_t8_t
+ 
+	mt_num_addrs
+;
+
+163 
+u_t8_t
+ 
+	mt_w
+;
+
+164 
+u_t16_t
+ 
+	mt_litime
+;
+
+165 } 
+	mih_dv
+;
+
+166 } 
+	micmp_hun
+;
+
+167 
+	#icmp_
+ 
+icmp_hun
+.
+ih_
+
+
+	)
+
+168 
+	#icmp_gwaddr
+ 
+icmp_hun
+.
+ih_gwaddr
+
+
+	)
+
+169 
+	#icmp_id
+ 
+icmp_hun
+.
+ih_idq
+.
+icd_id
+
+
+	)
+
+170 
+	#icmp_q
+ 
+icmp_hun
+.
+ih_idq
+.
+icd_q
+
+
+	)
+
+171 
+	#icmp_void
+ 
+icmp_hun
+.
+ih_void
+
+
+	)
+
+172 
+	#icmp_pmvoid
+ 
+icmp_hun
+.
+ih_pmtu
+.
+m_void
+
+
+	)
+
+173 
+	#icmp_xtmtu
+ 
+icmp_hun
+.
+ih_pmtu
+.
+m_xtmtu
+
+
+	)
+
+174 
+	#icmp_num_addrs
+ 
+icmp_hun
+.
+ih_dv
+.
+t_num_addrs
+
+
+	)
+
+175 
+	#icmp_w
+ 
+icmp_hun
+.
+ih_dv
+.
+t_w
+
+
+	)
+
+176 
+	#icmp_litime
+ 
+icmp_hun
+.
+ih_dv
+.
+t_litime
+
+
+	)
+
+181 
+u_t32_t
+ 
+	ms_ime
+;
+
+182 
+u_t32_t
+ 
+	ms_ime
+;
+
+183 
+u_t32_t
+ 
+	ms_ime
+;
+
+184 } 
+	mid_ts
+;
+
+187 
+
+ 
+	midi_
+;
+
+189 } 
+	mid_
+;
+
+190 
+icmp__addr
+ 
+	mid_dv
+;
+
+191 
+u_t32_t
+ 
+	mid_mask
+;
+
+192 
+u_t8_t
+ 
+	mid_da
+[1];
+
+193 } 
+	micmp_dun
+;
+
+194 
+	#icmp_ime
+ 
+icmp_dun
+.
+id_ts
+.
+s_ime
+
+
+	)
+
+195 
+	#icmp_ime
+ 
+icmp_dun
+.
+id_ts
+.
+s_ime
+
+
+	)
+
+196 
+	#icmp_ime
+ 
+icmp_dun
+.
+id_ts
+.
+s_ime
+
+
+	)
+
+197 
+	#icmp_
+ 
+icmp_dun
+.
+id_
+.
+idi_
+
+
+	)
+
+198 
+	#icmp_dv
+ 
+icmp_dun
+.
+id_dv
+
+
+	)
+
+199 
+	#icmp_mask
+ 
+icmp_dun
+.
+id_mask
+
+
+	)
+
+200 
+	#icmp_da
+ 
+icmp_dun
+.
+id_da
+
+
+	)
+
+211 
+	#ICMP_MINLEN
+ 8
+
+	)
+
+212 
+	#ICMP_TSLEN
+ (8 + 3 *  (
+n_time
+)
+
+	)
+
+213 
+	#ICMP_MASKLEN
+ 12
+
+	)
+
+214 
+	#ICMP_ADVLENMIN
+ (8 +  (
+
++ 8
+
+	)
+
+215 #ide
+_IP_VHL
+
+
+216 
+	#ICMP_ADVLEN
+(
+p
+(8 + ()->
+icmp_
+.
+_hl
+ << 2+ 8)
+
+	)
+
+219 
+	#ICMP_ADVLEN
+(
+p
+(8 + (
+	`IP_VHL_HL
+()->
+icmp_
+.
+_vhl
+<< 2+ 8)
+
+	)
+
+225 
+	#ICMP_UNREACH
+ 3
+
+	)
+
+226 
+	#ICMP_SOURCEQUENCH
+ 4
+
+	)
+
+227 
+	#ICMP_ROUTERADVERT
+ 9
+
+	)
+
+228 
+	#ICMP_ROUTERSOLICIT
+ 10
+
+	)
+
+229 
+	#ICMP_TIMXCEED
+ 11
+
+	)
+
+230 
+	#ICMP_PARAMPROB
+ 12
+
+	)
+
+231 
+	#ICMP_TSTAMP
+ 13
+
+	)
+
+232 
+	#ICMP_TSTAMPREPLY
+ 14
+
+	)
+
+233 
+	#ICMP_IREQ
+ 15
+
+	)
+
+234 
+	#ICMP_IREQREPLY
+ 16
+
+	)
+
+235 
+	#ICMP_MASKREQ
+ 17
+
+	)
+
+236 
+	#ICMP_MASKREPLY
+ 18
+
+	)
+
+238 
+	#ICMP_MAXTYPE
+ 18
+
+	)
+
+241 
+	#ICMP_UNREACH_NET
+ 0
+
+	)
+
+242 
+	#ICMP_UNREACH_HOST
+ 1
+
+	)
+
+243 
+	#ICMP_UNREACH_PROTOCOL
+ 2
+
+	)
+
+244 
+	#ICMP_UNREACH_PORT
+ 3
+
+	)
+
+245 
+	#ICMP_UNREACH_NEEDFRAG
+ 4
+
+	)
+
+246 
+	#ICMP_UNREACH_SRCFAIL
+ 5
+
+	)
+
+247 
+	#ICMP_UNREACH_NET_UNKNOWN
+ 6
+
+	)
+
+248 
+	#ICMP_UNREACH_HOST_UNKNOWN
+ 7
+
+	)
+
+249 
+	#ICMP_UNREACH_ISOLATED
+ 8
+
+	)
+
+250 
+	#ICMP_UNREACH_NET_PROHIB
+ 9
+
+	)
+
+251 
+	#ICMP_UNREACH_HOST_PROHIB
+ 10
+
+	)
+
+252 
+	#ICMP_UNREACH_TOSNET
+ 11
+
+	)
+
+253 
+	#ICMP_UNREACH_TOSHOST
+ 12
+
+	)
+
+254 
+	#ICMP_UNREACH_FILTER_PROHIB
+ 13
+
+	)
+
+255 
+	#ICMP_UNREACH_HOST_PRECEDENCE
+ 14
+
+	)
+
+256 
+	#ICMP_UNREACH_PRECEDENCE_CUTOFF
+ 15
+
+	)
+
+259 
+	#ICMP_REDIRECT_NET
+ 0
+
+	)
+
+260 
+	#ICMP_REDIRECT_HOST
+ 1
+
+	)
+
+261 
+	#ICMP_REDIRECT_TOSNET
+ 2
+
+	)
+
+262 
+	#ICMP_REDIRECT_TOSHOST
+ 3
+
+	)
+
+265 
+	#ICMP_TIMXCEED_INTRANS
+ 0
+
+	)
+
+266 
+	#ICMP_TIMXCEED_REASS
+ 1
+
+	)
+
+269 
+	#ICMP_PARAMPROB_OPTABSENT
+ 1
+
+	)
+
+271 
+	#ICMP_INFOTYPE
+(
+ty
+) \
+
+272 ((
+ty
+=
+ICMP_ECHOREPLY
+ || (ty=
+ICMP_ECHO
+ || \
+
+273 (
+ty
+=
+ICMP_ROUTERADVERT
+ || (ty=
+ICMP_ROUTERSOLICIT
+ || \
+
+274 (
+ty
+=
+ICMP_TSTAMP
+ || (ty=
+ICMP_TSTAMPREPLY
+ || \
+
+275 (
+ty
+=
+ICMP_IREQ
+ || (ty=
+ICMP_IREQREPLY
+ || \
+
+276 (
+ty
+=
+ICMP_MASKREQ
+ || (ty=
+ICMP_MASKREPLY
+)
+
+	)
+
+280 
+	g__END_DECLS
+
+
+	@/usr/include/netinet/tcp.h
+
+32 #ide
+_NETINET_TCP_H
+
+
+33 
+	#_NETINET_TCP_H
+ 1
+
+	)
+
+35 
+	~<us.h
+>
+
+40 
+	#TCP_NODELAY
+ 1
+
+	)
+
+41 
+	#TCP_MAXSEG
+ 2
+
+	)
+
+42 
+	#TCP_CORK
+ 3
+
+	)
+
+43 
+	#TCP_KEEPIDLE
+ 4
+
+	)
+
+44 
+	#TCP_KEEPINTVL
+ 5
+
+	)
+
+45 
+	#TCP_KEEPCNT
+ 6
+
+	)
+
+46 
+	#TCP_SYNCNT
+ 7
+
+	)
+
+47 
+	#TCP_LINGER2
+ 8
+
+	)
+
+48 
+	#TCP_DEFER_ACCEPT
+ 9
+
+	)
+
+49 
+	#TCP_WINDOW_CLAMP
+ 10
+
+	)
+
+50 
+	#TCP_INFO
+ 11
+
+	)
+
+51 
+	#TCP_QUICKACK
+ 12
+
+	)
+
+52 
+	#TCP_CONGESTION
+ 13
+
+	)
+
+53 
+	#TCP_MD5SIG
+ 14
+
+	)
+
+54 
+	#TCP_COOKIE_TRANSACTIONS
+ 15
+
+	)
+
+55 
+	#TCP_THIN_LINEAR_TIMEOUTS
+ 16
+
+	)
+
+56 
+	#TCP_THIN_DUPACK
+ 17
+
+	)
+
+57 
+	#TCP_USER_TIMEOUT
+ 18
+
+	)
+
+58 
+	#TCP_REPAIR
+ 19
+
+	)
+
+59 
+	#TCP_REPAIR_QUEUE
+ 20
+
+	)
+
+60 
+	#TCP_QUEUE_SEQ
+ 21
+
+	)
+
+61 
+	#TCP_REPAIR_OPTIONS
+ 22
+
+	)
+
+62 
+	#TCP_FASTOPEN
+ 23
+
+	)
+
+63 
+	#TCP_TIMESTAMP
+ 24
+
+	)
+
+65 #ifde
+__USE_MISC
+
+
+66 
+	~<sys/tys.h
+>
+
+67 
+	~<sys/sock.h
+>
+
+69 
+u_t32_t
+ 
+	tt_q
+;
+
+74 
+	sthdr
+
+
+76 
+__exnsi__
+ union
+
+80 
+u_t16_t
+ 
+	mth_t
+;
+
+81 
+u_t16_t
+ 
+	mth_dpt
+;
+
+82 
+t_q
+ 
+	mth_q
+;
+
+83 
+t_q
+ 
+	mth_ack
+;
+
+84 #i
+__BYTE_ORDER
+ =
+__LITTLE_ENDIAN
+
+
+85 
+u_t8_t
+ 
+	mth_x2
+:4;
+
+86 
+u_t8_t
+ 
+	mth_off
+:4;
+
+88 #i
+__BYTE_ORDER
+ =
+__BIG_ENDIAN
+
+
+89 
+u_t8_t
+ 
+	mth_off
+:4;
+
+90 
+u_t8_t
+ 
+	mth_x2
+:4;
+
+92 
+u_t8_t
+ 
+	mth_ags
+;
+
+93 
+	#TH_FIN
+ 0x01
+
+	)
+
+94 
+	#TH_SYN
+ 0x02
+
+	)
+
+95 
+	#TH_RST
+ 0x04
+
+	)
+
+96 
+	#TH_PUSH
+ 0x08
+
+	)
+
+97 
+	#TH_ACK
+ 0x10
+
+	)
+
+98 
+	#TH_URG
+ 0x20
+
+	)
+
+99 
+u_t16_t
+ 
+	mth_w
+;
+
+100 
+u_t16_t
+ 
+	mth_sum
+;
+
+101 
+u_t16_t
+ 
+	mth_u
+;
+
+105 
+u_t16_t
+ 
+	msour
+;
+
+106 
+u_t16_t
+ 
+	mde
+;
+
+107 
+u_t32_t
+ 
+	mq
+;
+
+108 
+u_t32_t
+ 
+	mack_q
+;
+
+109 #i
+__BYTE_ORDER
+ =
+__LITTLE_ENDIAN
+
+
+110 
+u_t16_t
+ 
+	ms1
+:4;
+
+111 
+u_t16_t
+ 
+	mdoff
+:4;
+
+112 
+u_t16_t
+ 
+	mf
+:1;
+
+113 
+u_t16_t
+ 
+	msyn
+:1;
+
+114 
+u_t16_t
+ 
+	mr
+:1;
+
+115 
+u_t16_t
+ 
+	mpsh
+:1;
+
+116 
+u_t16_t
+ 
+	mack
+:1;
+
+117 
+u_t16_t
+ 
+	murg
+:1;
+
+118 
+u_t16_t
+ 
+	ms2
+:2;
+
+119 #i
+__BYTE_ORDER
+ =
+__BIG_ENDIAN
+
+
+120 
+u_t16_t
+ 
+	mdoff
+:4;
+
+121 
+u_t16_t
+ 
+	ms1
+:4;
+
+122 
+u_t16_t
+ 
+	ms2
+:2;
+
+123 
+u_t16_t
+ 
+	murg
+:1;
+
+124 
+u_t16_t
+ 
+	mack
+:1;
+
+125 
+u_t16_t
+ 
+	mpsh
+:1;
+
+126 
+u_t16_t
+ 
+	mr
+:1;
+
+127 
+u_t16_t
+ 
+	msyn
+:1;
+
+128 
+u_t16_t
+ 
+	mf
+:1;
+
+132 
+u_t16_t
+ 
+	mwdow
+;
+
+133 
+u_t16_t
+ 
+	mcheck
+;
+
+134 
+u_t16_t
+ 
+	murg_r
+;
+
+141 
+	mTCP_ESTABLISHED
+ = 1,
+
+142 
+	mTCP_SYN_SENT
+,
+
+143 
+	mTCP_SYN_RECV
+,
+
+144 
+	mTCP_FIN_WAIT1
+,
+
+145 
+	mTCP_FIN_WAIT2
+,
+
+146 
+	mTCP_TIME_WAIT
+,
+
+147 
+	mTCP_CLOSE
+,
+
+148 
+	mTCP_CLOSE_WAIT
+,
+
+149 
+	mTCP_LAST_ACK
+,
+
+150 
+	mTCP_LISTEN
+,
+
+151 
+	mTCP_CLOSING
+
+
+154 
+	#TCPOPT_EOL
+ 0
+
+	)
+
+155 
+	#TCPOPT_NOP
+ 1
+
+	)
+
+156 
+	#TCPOPT_MAXSEG
+ 2
+
+	)
+
+157 
+	#TCPOLEN_MAXSEG
+ 4
+
+	)
+
+158 
+	#TCPOPT_WINDOW
+ 3
+
+	)
+
+159 
+	#TCPOLEN_WINDOW
+ 3
+
+	)
+
+160 
+	#TCPOPT_SACK_PERMITTED
+ 4
+
+	)
+
+161 
+	#TCPOLEN_SACK_PERMITTED
+ 2
+
+	)
+
+162 
+	#TCPOPT_SACK
+ 5
+
+	)
+
+163 
+	#TCPOPT_TIMESTAMP
+ 8
+
+	)
+
+164 
+	#TCPOLEN_TIMESTAMP
+ 10
+
+	)
+
+165 
+	#TCPOLEN_TSTAMP_APPA
+ (
+TCPOLEN_TIMESTAMP
++2
+
+	)
+
+167 
+	#TCPOPT_TSTAMP_HDR
+ \
+
+168 (
+TCPOPT_NOP
+<<24|TCPOPT_NOP<<16|
+TCPOPT_TIMESTAMP
+<<8|
+TCPOLEN_TIMESTAMP
+)
+
+	)
+
+176 
+	#TCP_MSS
+ 512
+
+	)
+
+178 
+	#TCP_MAXWIN
+ 65535
+
+	)
+
+180 
+	#TCP_MAX_WINSHIFT
+ 14
+
+	)
+
+182 
+	#SOL_TCP
+ 6
+
+	)
+
+185 
+	#TCPI_OPT_TIMESTAMPS
+ 1
+
+	)
+
+186 
+	#TCPI_OPT_SACK
+ 2
+
+	)
+
+187 
+	#TCPI_OPT_WSCALE
+ 4
+
+	)
+
+188 
+	#TCPI_OPT_ECN
+ 8
+
+	)
+
+189 
+	#TCPI_OPT_ECN_SEEN
+ 16
+
+	)
+
+190 
+	#TCPI_OPT_SYN_DATA
+ 32
+
+	)
+
+193 
+	et__e
+
+
+195 
+	mTCP_CA_On
+ = 0,
+
+196 
+	mTCP_CA_Disd
+ = 1,
+
+197 
+	mTCP_CA_CWR
+ = 2,
+
+198 
+	mTCP_CA_Recovy
+ = 3,
+
+199 
+	mTCP_CA_Loss
+ = 4
+
+202 
+	st_fo
+
+
+204 
+u_t8_t
+ 
+	mti_e
+;
+
+205 
+u_t8_t
+ 
+	mti__e
+;
+
+206 
+u_t8_t
+ 
+	mti_sms
+;
+
+207 
+u_t8_t
+ 
+	mti_obes
+;
+
+208 
+u_t8_t
+ 
+	mti_backoff
+;
+
+209 
+u_t8_t
+ 
+	mti_tis
+;
+
+210 
+u_t8_t
+ 
+	mti_d_ws
+ : 4, 
+	mti_rcv_ws
+ : 4;
+
+212 
+u_t32_t
+ 
+	mti_o
+;
+
+213 
+u_t32_t
+ 
+	mti_o
+;
+
+214 
+u_t32_t
+ 
+	mti_d_mss
+;
+
+215 
+u_t32_t
+ 
+	mti_rcv_mss
+;
+
+217 
+u_t32_t
+ 
+	mti_ucked
+;
+
+218 
+u_t32_t
+ 
+	mti_cked
+;
+
+219 
+u_t32_t
+ 
+	mti_lo
+;
+
+220 
+u_t32_t
+ 
+	mti_s
+;
+
+221 
+u_t32_t
+ 
+	mti_cks
+;
+
+224 
+u_t32_t
+ 
+	mti__da_
+;
+
+225 
+u_t32_t
+ 
+	mti__ack_
+;
+
+226 
+u_t32_t
+ 
+	mti__da_cv
+;
+
+227 
+u_t32_t
+ 
+	mti__ack_cv
+;
+
+230 
+u_t32_t
+ 
+	mti_pmtu
+;
+
+231 
+u_t32_t
+ 
+	mti_rcv_shsh
+;
+
+232 
+u_t32_t
+ 
+	mti_t
+;
+
+233 
+u_t32_t
+ 
+	mti_tv
+;
+
+234 
+u_t32_t
+ 
+	mti_d_shsh
+;
+
+235 
+u_t32_t
+ 
+	mti_d_cwnd
+;
+
+236 
+u_t32_t
+ 
+	mti_advmss
+;
+
+237 
+u_t32_t
+ 
+	mti_dg
+;
+
+239 
+u_t32_t
+ 
+	mti_rcv_t
+;
+
+240 
+u_t32_t
+ 
+	mti_rcv_a
+;
+
+242 
+u_t32_t
+ 
+	mti_t_s
+;
+
+247 
+	#TCP_MD5SIG_MAXKEYLEN
+ 80
+
+	)
+
+249 
+	st_md5sig
+
+
+251 
+sockaddr_age
+ 
+	mtm_addr
+;
+
+252 
+u_t16_t
+ 
+	m__tm_d1
+;
+
+253 
+u_t16_t
+ 
+	mtm_keyn
+;
+
+254 
+u_t32_t
+ 
+	m__tm_d2
+;
+
+255 
+u_t8_t
+ 
+	mtm_key
+[
+TCP_MD5SIG_MAXKEYLEN
+];
+
+259 
+	st__t
+
+
+261 
+u_t32_t
+ 
+	mt_code
+;
+
+262 
+u_t32_t
+ 
+	mt_v
+;
+
+268 
+	mTCP_NO_QUEUE
+,
+
+269 
+	mTCP_RECV_QUEUE
+,
+
+270 
+	mTCP_SEND_QUEUE
+,
+
+271 
+	mTCP_QUEUES_NR
+,
+
+275 
+	#TCP_COOKIE_MIN
+ 8
+
+	)
+
+276 
+	#TCP_COOKIE_MAX
+ 16
+
+	)
+
+277 
+	#TCP_COOKIE_PAIR_SIZE
+ (2*
+TCP_COOKIE_MAX
+)
+
+	)
+
+280 
+	#TCP_COOKIE_IN_ALWAYS
+ (1 << 0
+
+	)
+
+281 
+	#TCP_COOKIE_OUT_NEVER
+ (1 << 1
+
+	)
+
+285 
+	#TCP_S_DATA_IN
+ (1 << 2
+
+	)
+
+286 
+	#TCP_S_DATA_OUT
+ (1 << 3
+
+	)
+
+288 
+	#TCP_MSS_DEFAULT
+ 536U
+
+	)
+
+289 
+	#TCP_MSS_DESIRED
+ 1220U
+
+	)
+
+291 
+	st_cook_is
+
+
+293 
+u_t16_t
+ 
+	mt_ags
+;
+
+294 
+u_t8_t
+ 
+	m__t_d1
+;
+
+295 
+u_t8_t
+ 
+	mt_cook_desed
+;
+
+296 
+u_t16_t
+ 
+	mt_s_da_desed
+;
+
+297 
+u_t16_t
+ 
+	mt_ud
+;
+
+298 
+u_t8_t
+ 
+	mt_vue
+[
+TCP_MSS_DEFAULT
+];
+
+	@/usr/include/netinet/udp.h
+
+47 #ide
+__NETINET_UDP_H
+
+
+48 
+	#__NETINET_UDP_H
+ 1
+
+	)
+
+50 
+	~<us.h
+>
+
+51 
+	~<sys/tys.h
+>
+
+56 
+	sudphdr
+
+
+58 
+__exnsi__
+ union
+
+62 
+u_t16_t
+ 
+	muh_t
+;
+
+63 
+u_t16_t
+ 
+	muh_dpt
+;
+
+64 
+u_t16_t
+ 
+	muh_un
+;
+
+65 
+u_t16_t
+ 
+	muh_sum
+;
+
+69 
+u_t16_t
+ 
+	msour
+;
+
+70 
+u_t16_t
+ 
+	mde
+;
+
+71 
+u_t16_t
+ 
+	mn
+;
+
+72 
+u_t16_t
+ 
+	mcheck
+;
+
+78 
+	#UDP_CORK
+ 1
+
+	)
+
+79 
+	#UDP_ENCAP
+ 100
+
+	)
+
+83 
+	#UDP_ENCAP_ESPINUDP_NON_IKE
+ 1
+
+	)
+
+84 
+	#UDP_ENCAP_ESPINUDP
+ 2
+
+	)
+
+85 
+	#UDP_ENCAP_L2TPINUDP
+ 3
+
+	)
+
+87 
+	#SOL_UDP
+ 17
+
+	)
+
+	@/usr/include/netipx/ipx.h
+
+18 #ide
+__NETIPX_IPX_H
+
+
+19 
+	#__NETIPX_IPX_H
+ 1
+
+	)
+
+21 
+	~<us.h
+>
+
+23 
+	~<sys/tys.h
+>
+
+24 
+	~<bs/sockaddr.h
+>
+
+26 
+	g__BEGIN_DECLS
+
+
+28 
+	#SOL_IPX
+ 256
+
+	)
+
+30 
+	#IPX_TYPE
+ 1
+
+	)
+
+31 
+	#IPX_NODE_LEN
+ 6
+
+	)
+
+32 
+	#IPX_MTU
+ 576
+
+	)
+
+34 
+	ssockaddr_x
+
+
+36 
+_my_t
+ 
+	msx_my
+;
+
+37 
+u_t16_t
+ 
+	msx_pt
+;
+
+38 
+u_t32_t
+ 
+	msx_twk
+;
+
+39 
+	msx_node
+[
+IPX_NODE_LEN
+];
+
+40 
+u_t8_t
+ 
+	msx_ty
+;
+
+41 
+	msx_zo
+;
+
+48 
+	#sx_ecl
+ 
+sx_pt
+
+
+	)
+
+49 
+	#sx_ai
+ 
+sx_zo
+
+
+	)
+
+50 
+	#IPX_DLTITF
+ 0
+
+	)
+
+51 
+	#IPX_CRTITF
+ 1
+
+	)
+
+53 
+	sx_rou_defi
+
+
+55 
+	mx_twk
+;
+
+56 
+	mx_rour_twk
+;
+
+57 
+	mx_rour_node
+[
+IPX_NODE_LEN
+];
+
+59 
+	tx_rou_defi
+;
+
+61 
+	sx_r_defi
+
+
+63 
+	mx_twk
+;
+
+64 
+	mx_devi
+[16];
+
+65 
+	mx_dlk_ty
+;
+
+66 
+	#IPX_FRAME_NONE
+ 0
+
+	)
+
+67 
+	#IPX_FRAME_SNAP
+ 1
+
+	)
+
+68 
+	#IPX_FRAME_8022
+ 2
+
+	)
+
+69 
+	#IPX_FRAME_ETHERII
+ 3
+
+	)
+
+70 
+	#IPX_FRAME_8023
+ 4
+
+	)
+
+71 
+	#IPX_FRAME_TR_8022
+ 5
+
+	)
+
+72 
+	mx_ecl
+;
+
+73 
+	#IPX_SPECIAL_NONE
+ 0
+
+	)
+
+74 
+	#IPX_PRIMARY
+ 1
+
+	)
+
+75 
+	#IPX_INTERNAL
+ 2
+
+	)
+
+76 
+	mx_node
+[
+IPX_NODE_LEN
+];
+
+78 
+	tx_r_defi
+;
+
+80 
+	sx_cfig_da
+
+
+82 
+	mxcfg_auto__imy
+;
+
+83 
+	mxcfg_auto__rs
+;
+
+85 
+	tx_cfig_da
+;
+
+91 
+	sx_rou_def
+
+
+93 
+	mx_twk
+;
+
+94 
+	mx_rour_twk
+;
+
+95 
+	#IPX_ROUTE_NO_ROUTER
+ 0
+
+	)
+
+96 
+	mx_rour_node
+[
+IPX_NODE_LEN
+];
+
+97 
+	mx_devi
+[16];
+
+98 
+	mx_ags
+;
+
+99 
+	#IPX_RT_SNAP
+ 8
+
+	)
+
+100 
+	#IPX_RT_8022
+ 4
+
+	)
+
+101 
+	#IPX_RT_BLUEBOOK
+ 2
+
+	)
+
+102 
+	#IPX_RT_ROUTED
+ 1
+
+	)
+
+105 
+	#SIOCAIPXITFCRT
+ (
+SIOCPROTOPRIVATE
+)
+
+	)
+
+106 
+	#SIOCAIPXPRISLT
+ (
+SIOCPROTOPRIVATE
+ + 1)
+
+	)
+
+107 
+	#SIOCIPXCFGDATA
+ (
+SIOCPROTOPRIVATE
+ + 2)
+
+	)
+
+108 
+	#SIOCIPXNCPCONN
+ (
+SIOCPROTOPRIVATE
+ + 3)
+
+	)
+
+110 
+	g__END_DECLS
+
+
+	@/usr/include/stdint.h
+
+22 #ide
+_STDINT_H
+
+
+23 
+	#_STDINT_H
+ 1
+
+	)
+
+25 
+	~<us.h
+>
+
+26 
+	~<bs/wch.h
+>
+
+27 
+	~<bs/wdsize.h
+>
+
+34 #ide
+__t8_t_defed
+
+
+35 
+	#__t8_t_defed
+
+
+	)
+
+36 sigd 
+	tt8_t
+;
+
+37 
+	tt16_t
+;
+
+38 
+	tt32_t
+;
+
+39 #i
+__WORDSIZE
+ == 64
+
+40 
+	tt64_t
+;
+
+42 
+__exnsi__
+
+
+43 
+	tt64_t
+;
+
+48 
+	tut8_t
+;
+
+49 
+	tut16_t
+;
+
+50 #ide
+__ut32_t_defed
+
+
+51 
+	tut32_t
+;
+
+52 
+	#__ut32_t_defed
+
+
+	)
+
+54 #i
+__WORDSIZE
+ == 64
+
+55 
+	tut64_t
+;
+
+57 
+__exnsi__
+
+
+58 
+	tut64_t
+;
+
+65 sigd 
+	tt_a8_t
+;
+
+66 
+	tt_a16_t
+;
+
+67 
+	tt_a32_t
+;
+
+68 #i
+__WORDSIZE
+ == 64
+
+69 
+	tt_a64_t
+;
+
+71 
+__exnsi__
+
+
+72 
+	tt_a64_t
+;
+
+76 
+	tut_a8_t
+;
+
+77 
+	tut_a16_t
+;
+
+78 
+	tut_a32_t
+;
+
+79 #i
+__WORDSIZE
+ == 64
+
+80 
+	tut_a64_t
+;
+
+82 
+__exnsi__
+
+
+83 
+	tut_a64_t
+;
+
+90 sigd 
+	tt_8_t
+;
+
+91 #i
+__WORDSIZE
+ == 64
+
+92 
+	tt_16_t
+;
+
+93 
+	tt_32_t
+;
+
+94 
+	tt_64_t
+;
+
+96 
+	tt_16_t
+;
+
+97 
+	tt_32_t
+;
+
+98 
+__exnsi__
+
+
+99 
+	tt_64_t
+;
+
+103 
+	tut_8_t
+;
+
+104 #i
+__WORDSIZE
+ == 64
+
+105 
+	tut_16_t
+;
+
+106 
+	tut_32_t
+;
+
+107 
+	tut_64_t
+;
+
+109 
+	tut_16_t
+;
+
+110 
+	tut_32_t
+;
+
+111 
+__exnsi__
+
+
+112 
+	tut_64_t
+;
+
+117 #i
+__WORDSIZE
+ == 64
+
+118 #ide
+___t_defed
+
+
+119 
+	t_t
+;
+
+120 
+	#___t_defed
+
+
+	)
+
+122 
+	tu_t
+;
+
+124 #ide
+___t_defed
+
+
+125 
+	t_t
+;
+
+126 
+	#___t_defed
+
+
+	)
+
+128 
+	tu_t
+;
+
+133 #i
+__WORDSIZE
+ == 64
+
+134 
+	ttmax_t
+;
+
+135 
+	tutmax_t
+;
+
+137 
+__exnsi__
+
+
+138 
+	ttmax_t
+;
+
+139 
+__exnsi__
+
+
+140 
+	tutmax_t
+;
+
+144 #i
+__WORDSIZE
+ == 64
+
+145 
+	#__INT64_C
+(
+c
+## 
+L
+
+
+	)
+
+146 
+	#__UINT64_C
+(
+c
+## 
+UL
+
+
+	)
+
+148 
+	#__INT64_C
+(
+c
+## 
+LL
+
+
+	)
+
+149 
+	#__UINT64_C
+(
+c
+## 
+ULL
+
+
+	)
+
+155 
+	#INT8_MIN
+ (-128)
+
+	)
+
+156 
+	#INT16_MIN
+ (-32767-1)
+
+	)
+
+157 
+	#INT32_MIN
+ (-2147483647-1)
+
+	)
+
+158 
+	#INT64_MIN
+ (-
+	`__INT64_C
+(9223372036854775807)-1)
+
+	)
+
+160 
+	#INT8_MAX
+ (127)
+
+	)
+
+161 
+	#INT16_MAX
+ (32767)
+
+	)
+
+162 
+	#INT32_MAX
+ (2147483647)
+
+	)
+
+163 
+	#INT64_MAX
+ (
+	`__INT64_C
+(9223372036854775807))
+
+	)
+
+166 
+	#UINT8_MAX
+ (255)
+
+	)
+
+167 
+	#UINT16_MAX
+ (65535)
+
+	)
+
+168 
+	#UINT32_MAX
+ (4294967295U)
+
+	)
+
+169 
+	#UINT64_MAX
+ (
+	`__UINT64_C
+(18446744073709551615))
+
+	)
+
+173 
+	#INT_LEAST8_MIN
+ (-128)
+
+	)
+
+174 
+	#INT_LEAST16_MIN
+ (-32767-1)
+
+	)
+
+175 
+	#INT_LEAST32_MIN
+ (-2147483647-1)
+
+	)
+
+176 
+	#INT_LEAST64_MIN
+ (-
+	`__INT64_C
+(9223372036854775807)-1)
+
+	)
+
+178 
+	#INT_LEAST8_MAX
+ (127)
+
+	)
+
+179 
+	#INT_LEAST16_MAX
+ (32767)
+
+	)
+
+180 
+	#INT_LEAST32_MAX
+ (2147483647)
+
+	)
+
+181 
+	#INT_LEAST64_MAX
+ (
+	`__INT64_C
+(9223372036854775807))
+
+	)
+
+184 
+	#UINT_LEAST8_MAX
+ (255)
+
+	)
+
+185 
+	#UINT_LEAST16_MAX
+ (65535)
+
+	)
+
+186 
+	#UINT_LEAST32_MAX
+ (4294967295U)
+
+	)
+
+187 
+	#UINT_LEAST64_MAX
+ (
+	`__UINT64_C
+(18446744073709551615))
+
+	)
+
+191 
+	#INT_FAST8_MIN
+ (-128)
+
+	)
+
+192 #i
+__WORDSIZE
+ == 64
+
+193 
+	#INT_FAST16_MIN
+ (-9223372036854775807L-1)
+
+	)
+
+194 
+	#INT_FAST32_MIN
+ (-9223372036854775807L-1)
+
+	)
+
+196 
+	#INT_FAST16_MIN
+ (-2147483647-1)
+
+	)
+
+197 
+	#INT_FAST32_MIN
+ (-2147483647-1)
+
+	)
+
+199 
+	#INT_FAST64_MIN
+ (-
+	`__INT64_C
+(9223372036854775807)-1)
+
+	)
+
+201 
+	#INT_FAST8_MAX
+ (127)
+
+	)
+
+202 #i
+__WORDSIZE
+ == 64
+
+203 
+	#INT_FAST16_MAX
+ (9223372036854775807L)
+
+	)
+
+204 
+	#INT_FAST32_MAX
+ (9223372036854775807L)
+
+	)
+
+206 
+	#INT_FAST16_MAX
+ (2147483647)
+
+	)
+
+207 
+	#INT_FAST32_MAX
+ (2147483647)
+
+	)
+
+209 
+	#INT_FAST64_MAX
+ (
+	`__INT64_C
+(9223372036854775807))
+
+	)
+
+212 
+	#UINT_FAST8_MAX
+ (255)
+
+	)
+
+213 #i
+__WORDSIZE
+ == 64
+
+214 
+	#UINT_FAST16_MAX
+ (18446744073709551615UL)
+
+	)
+
+215 
+	#UINT_FAST32_MAX
+ (18446744073709551615UL)
+
+	)
+
+217 
+	#UINT_FAST16_MAX
+ (4294967295U)
+
+	)
+
+218 
+	#UINT_FAST32_MAX
+ (4294967295U)
+
+	)
+
+220 
+	#UINT_FAST64_MAX
+ (
+	`__UINT64_C
+(18446744073709551615))
+
+	)
+
+224 #i
+__WORDSIZE
+ == 64
+
+225 
+	#INTPTR_MIN
+ (-9223372036854775807L-1)
+
+	)
+
+226 
+	#INTPTR_MAX
+ (9223372036854775807L)
+
+	)
+
+227 
+	#UINTPTR_MAX
+ (18446744073709551615UL)
+
+	)
+
+229 
+	#INTPTR_MIN
+ (-2147483647-1)
+
+	)
+
+230 
+	#INTPTR_MAX
+ (2147483647)
+
+	)
+
+231 
+	#UINTPTR_MAX
+ (4294967295U)
+
+	)
+
+236 
+	#INTMAX_MIN
+ (-
+	`__INT64_C
+(9223372036854775807)-1)
+
+	)
+
+238 
+	#INTMAX_MAX
+ (
+	`__INT64_C
+(9223372036854775807))
+
+	)
+
+241 
+	#UINTMAX_MAX
+ (
+	`__UINT64_C
+(18446744073709551615))
+
+	)
+
+247 #i
+__WORDSIZE
+ == 64
+
+248 
+	#PTRDIFF_MIN
+ (-9223372036854775807L-1)
+
+	)
+
+249 
+	#PTRDIFF_MAX
+ (9223372036854775807L)
+
+	)
+
+251 
+	#PTRDIFF_MIN
+ (-2147483647-1)
+
+	)
+
+252 
+	#PTRDIFF_MAX
+ (2147483647)
+
+	)
+
+256 
+	#SIG_ATOMIC_MIN
+ (-2147483647-1)
+
+	)
+
+257 
+	#SIG_ATOMIC_MAX
+ (2147483647)
+
+	)
+
+260 #i
+__WORDSIZE
+ == 64
+
+261 
+	#SIZE_MAX
+ (18446744073709551615UL)
+
+	)
+
+263 
+	#SIZE_MAX
+ (4294967295U)
+
+	)
+
+267 #ide
+WCHAR_MIN
+
+
+269 
+	#WCHAR_MIN
+ 
+__WCHAR_MIN
+
+
+	)
+
+270 
+	#WCHAR_MAX
+ 
+__WCHAR_MAX
+
+
+	)
+
+274 
+	#WINT_MIN
+ (0u)
+
+	)
+
+275 
+	#WINT_MAX
+ (4294967295u)
+
+	)
+
+278 
+	#INT8_C
+(
+c
+
+	)
+c
+
+279 
+	#INT16_C
+(
+c
+
+	)
+c
+
+280 
+	#INT32_C
+(
+c
+
+	)
+c
+
+281 #i
+__WORDSIZE
+ == 64
+
+282 
+	#INT64_C
+(
+c
+## 
+L
+
+
+	)
+
+284 
+	#INT64_C
+(
+c
+## 
+LL
+
+
+	)
+
+288 
+	#UINT8_C
+(
+c
+
+	)
+c
+
+289 
+	#UINT16_C
+(
+c
+
+	)
+c
+
+290 
+	#UINT32_C
+(
+c
+## 
+U
+
+
+	)
+
+291 #i
+__WORDSIZE
+ == 64
+
+292 
+	#UINT64_C
+(
+c
+## 
+UL
+
+
+	)
+
+294 
+	#UINT64_C
+(
+c
+## 
+ULL
+
+
+	)
+
+298 #i
+__WORDSIZE
+ == 64
+
+299 
+	#INTMAX_C
+(
+c
+## 
+L
+
+
+	)
+
+300 
+	#UINTMAX_C
+(
+c
+## 
+UL
+
+
+	)
+
+302 
+	#INTMAX_C
+(
+c
+## 
+LL
+
+
+	)
+
+303 
+	#UINTMAX_C
+(
+c
+## 
+ULL
+
+
+	)
+
+	@/usr/include/stdio.h
+
+23 #ide
+_STDIO_H
+
+
+25 #i!
+defed
+ 
+__ed_FILE
+ && !defed 
+__ed___FILE
+
+
+26 
+	#_STDIO_H
+ 1
+
+	)
+
+27 
+	~<us.h
+>
+
+29 
+	g__BEGIN_DECLS
+
+
+31 
+	#__ed_size_t
+
+
+	)
+
+32 
+	#__ed_NULL
+
+
+	)
+
+33 
+	~<ddef.h
+>
+
+35 
+	~<bs/tys.h
+>
+
+36 
+	#__ed_FILE
+
+
+	)
+
+37 
+	#__ed___FILE
+
+
+	)
+
+41 #i!
+defed
+ 
+__FILE_defed
+ && defed 
+__ed_FILE
+
+
+44 
+	g_IO_FILE
+;
+
+46 
+__BEGIN_NAMESPACE_STD
+
+
+48 
+_IO_FILE
+ 
+	tFILE
+;
+
+49 
+	g__END_NAMESPACE_STD
+
+
+50 #i
+defed
+ 
+__USE_LARGEFILE64
+ || defed 
+__USE_SVID
+ || defed 
+__USE_POSIX
+ \
+
+51 || 
+defed
+ 
+	g__USE_BSD
+ || defed 
+	g__USE_ISOC99
+ || defed 
+	g__USE_XOPEN
+ \
+
+52 || 
+defed
+ 
+__USE_POSIX2
+
+
+53 
+	$__USING_NAMESPACE_STD
+(
+FILE
+)
+
+56 
+	#__FILE_defed
+ 1
+
+	)
+
+58 #unde
+__ed_FILE
+
+
+61 #i!
+defed
+ 
+____FILE_defed
+ && defed 
+__ed___FILE
+
+
+64 
+_IO_FILE
+ 
+	t__FILE
+;
+
+66 
+	#____FILE_defed
+ 1
+
+	)
+
+68 #unde
+__ed___FILE
+
+
+71 #ifdef 
+_STDIO_H
+
+
+72 
+	#_STDIO_USES_IOSTREAM
+
+
+	)
+
+74 
+	~<libio.h
+>
+
+76 #i
+defed
+ 
+__USE_XOPEN
+ || defed 
+__USE_XOPEN2K8
+
+
+77 #ifde
+__GNUC__
+
+
+78 #ide
+_VA_LIST_DEFINED
+
+
+79 
+_G_va_li
+ 
+	tva_li
+;
+
+80 
+	#_VA_LIST_DEFINED
+
+
+	)
+
+83 
+	~<dg.h
+>
+
+87 #ifde
+__USE_XOPEN2K8
+
+
+88 #ide
+__off_t_defed
+
+
+89 #ide
+__USE_FILE_OFFSET64
+
+
+90 
+__off_t
+ 
+	toff_t
+;
+
+92 
+__off64_t
+ 
+	toff_t
+;
+
+94 
+	#__off_t_defed
+
+
+	)
+
+96 #i
+defed
+ 
+__USE_LARGEFILE64
+ && !defed 
+__off64_t_defed
+
+
+97 
+__off64_t
+ 
+	toff64_t
+;
+
+98 
+	#__off64_t_defed
+
+
+	)
+
+101 #ide
+__ssize_t_defed
+
+
+102 
+__ssize_t
+ 
+	tssize_t
+;
+
+103 
+	#__ssize_t_defed
+
+
+	)
+
+108 
+__BEGIN_NAMESPACE_STD
+
+
+109 #ide
+__USE_FILE_OFFSET64
+
+
+110 
+_G_os_t
+ 
+	tos_t
+;
+
+112 
+_G_os64_t
+ 
+	tos_t
+;
+
+114 
+__END_NAMESPACE_STD
+
+
+115 #ifde
+__USE_LARGEFILE64
+
+
+116 
+_G_os64_t
+ 
+	tos64_t
+;
+
+120 
+	#_IOFBF
+ 0
+
+	)
+
+121 
+	#_IOLBF
+ 1
+
+	)
+
+122 
+	#_IONBF
+ 2
+
+	)
+
+126 #ide
+BUFSIZ
+
+
+127 
+	#BUFSIZ
+ 
+_IO_BUFSIZ
+
+
+	)
+
+133 #ide
+EOF
+
+
+134 
+	#EOF
+ (-1)
+
+	)
+
+140 
+	#SEEK_SET
+ 0
+
+	)
+
+141 
+	#SEEK_CUR
+ 1
+
+	)
+
+142 
+	#SEEK_END
+ 2
+
+	)
+
+143 #ifde
+__USE_GNU
+
+
+144 
+	#SEEK_DATA
+ 3
+
+	)
+
+145 
+	#SEEK_HOLE
+ 4
+
+	)
+
+149 #i
+defed
+ 
+__USE_SVID
+ || defed 
+__USE_XOPEN
+
+
+151 
+	#P_tmpd
+ "/tmp"
+
+	)
+
+164 
+	~<bs/dio_lim.h
+>
+
+168 
+_IO_FILE
+ *
+d
+;
+
+169 
+_IO_FILE
+ *
+dout
+;
+
+170 
+_IO_FILE
+ *
+dr
+;
+
+172 
+	#d
+ 
+d
+
+
+	)
+
+173 
+	#dout
+ 
+dout
+
+
+	)
+
+174 
+	#dr
+ 
+dr
+
+
+	)
+
+176 
+__BEGIN_NAMESPACE_STD
+
+
+178 
+	$move
+ (c *
+__fame
+
+__THROW
+;
+
+180 
+	$me
+ (c *
+__d
+, c *
+__w
+
+__THROW
+;
+
+181 
+__END_NAMESPACE_STD
+
+
+183 #ifde
+__USE_ATFILE
+
+
+185 
+	$mt
+ (
+__dfd
+, c *
+__d
+, 
+__wfd
+,
+
+186 c *
+__w
+
+__THROW
+;
+
+189 
+__BEGIN_NAMESPACE_STD
+
+
+194 #ide
+__USE_FILE_OFFSET64
+
+
+195 
+FILE
+ *
+	$tmpfe
+ (
+__wur
+;
+
+197 #ifde
+__REDIRECT
+
+
+198 
+FILE
+ *
+	`__REDIRECT
+ (
+tmpfe
+, (), 
+tmpfe64
+
+__wur
+;
+
+200 
+	#tmpfe
+ 
+tmpfe64
+
+
+	)
+
+204 #ifde
+__USE_LARGEFILE64
+
+
+205 
+FILE
+ *
+	$tmpfe64
+ (
+__wur
+;
+
+209 *
+	$tmam
+ (*
+__s
+
+__THROW
+ 
+__wur
+;
+
+210 
+__END_NAMESPACE_STD
+
+
+212 #ifde
+__USE_MISC
+
+
+215 *
+	$tmam_r
+ (*
+__s
+
+__THROW
+ 
+__wur
+;
+
+219 #i
+defed
+ 
+__USE_SVID
+ || defed 
+__USE_XOPEN
+
+
+227 *
+	$mam
+ (c *
+__d
+, c *
+__pfx
+)
+
+228 
+__THROW
+ 
+__ibu_mloc__
+ 
+__wur
+;
+
+232 
+__BEGIN_NAMESPACE_STD
+
+
+237 
+	`fo
+ (
+FILE
+ *
+__am
+);
+
+242 
+	`fush
+ (
+FILE
+ *
+__am
+);
+
+243 
+__END_NAMESPACE_STD
+
+
+245 #ifde
+__USE_MISC
+
+
+252 
+	`fush_uocked
+ (
+FILE
+ *
+__am
+);
+
+255 #ifde
+__USE_GNU
+
+
+262 
+	`fol
+ ();
+
+266 
+__BEGIN_NAMESPACE_STD
+
+
+267 #ide
+__USE_FILE_OFFSET64
+
+
+272 
+FILE
+ *
+	$f
+ (c *
+__ri
+ 
+__fame
+,
+
+273 c *
+__ri
+ 
+__modes
+
+__wur
+;
+
+278 
+FILE
+ *
+	$e
+ (c *
+__ri
+ 
+__fame
+,
+
+279 c *
+__ri
+ 
+__modes
+,
+
+280 
+FILE
+ *
+__ri
+ 
+__am
+
+__wur
+;
+
+282 #ifde
+__REDIRECT
+
+
+283 
+FILE
+ *
+	`__REDIRECT
+ (
+f
+, (c *
+__ri
+ 
+__fame
+,
+
+284 c *
+__ri
+ 
+__modes
+), 
+f64
+)
+
+285 
+__wur
+;
+
+286 
+FILE
+ *
+	`__REDIRECT
+ (
+e
+, (c *
+__ri
+ 
+__fame
+,
+
+287 c *
+__ri
+ 
+__modes
+,
+
+288 
+FILE
+ *
+__ri
+ 
+__am
+), 
+e64
+)
+
+289 
+__wur
+;
+
+291 
+	#f
+ 
+f64
+
+
+	)
+
+292 
+	#e
+ 
+e64
+
+
+	)
+
+295 
+__END_NAMESPACE_STD
+
+
+296 #ifde
+__USE_LARGEFILE64
+
+
+297 
+FILE
+ *
+	$f64
+ (c *
+__ri
+ 
+__fame
+,
+
+298 c *
+__ri
+ 
+__modes
+
+__wur
+;
+
+299 
+FILE
+ *
+	$e64
+ (c *
+__ri
+ 
+__fame
+,
+
+300 c *
+__ri
+ 
+__modes
+,
+
+301 
+FILE
+ *
+__ri
+ 
+__am
+
+__wur
+;
+
+304 #ifdef 
+__USE_POSIX
+
+
+306 
+FILE
+ *
+	$fd
+ (
+__fd
+, c *
+__modes
+
+__THROW
+ 
+__wur
+;
+
+309 #ifdef 
+__USE_GNU
+
+
+312 
+FILE
+ *
+	$fcook
+ (*
+__ri
+ 
+__magic_cook
+,
+
+313 c *
+__ri
+ 
+__modes
+,
+
+314 
+_IO_cook_io_funis_t
+ 
+__io_funcs
+
+__THROW
+ 
+__wur
+;
+
+317 #ifde
+__USE_XOPEN2K8
+
+
+319 
+FILE
+ *
+	$fmem
+ (*
+__s
+, 
+size_t
+ 
+__n
+, c *
+__modes
+)
+
+320 
+__THROW
+ 
+__wur
+;
+
+325 
+FILE
+ *
+	$_memam
+ (**
+__buoc
+, 
+size_t
+ *
+__sizoc
+
+__THROW
+ 
+__wur
+;
+
+329 
+__BEGIN_NAMESPACE_STD
+
+
+332 
+	$tbuf
+ (
+FILE
+ *
+__ri
+ 
+__am
+, *__ri 
+__buf
+
+__THROW
+;
+
+336 
+	$tvbuf
+ (
+FILE
+ *
+__ri
+ 
+__am
+, *__ri 
+__buf
+,
+
+337 
+__modes
+, 
+size_t
+ 
+__n
+
+__THROW
+;
+
+338 
+__END_NAMESPACE_STD
+
+
+340 #ifdef 
+__USE_BSD
+
+
+343 
+	$tbufr
+ (
+FILE
+ *
+__ri
+ 
+__am
+, *__ri 
+__buf
+,
+
+344 
+size_t
+ 
+__size
+
+__THROW
+;
+
+347 
+	$ebuf
+ (
+FILE
+ *
+__am
+
+__THROW
+;
+
+351 
+__BEGIN_NAMESPACE_STD
+
+
+356 
+	`rtf
+ (
+FILE
+ *
+__ri
+ 
+__am
+,
+
+357 c *
+__ri
+ 
+__fm
+, ...);
+
+362 
+	`tf
+ (c *
+__ri
+ 
+__fm
+, ...);
+
+364 
+	$rtf
+ (*
+__ri
+ 
+__s
+,
+
+365 c *
+__ri
+ 
+__fm
+, ...
+__THROWNL
+;
+
+371 
+	`vrtf
+ (
+FILE
+ *
+__ri
+ 
+__s
+, c *__ri 
+__fm
+,
+
+372 
+_G_va_li
+ 
+__g
+);
+
+377 
+	`vtf
+ (c *
+__ri
+ 
+__fm
+, 
+_G_va_li
+ 
+__g
+);
+
+379 
+	$vrtf
+ (*
+__ri
+ 
+__s
+, c *__ri 
+__fm
+,
+
+380 
+_G_va_li
+ 
+__g
+
+__THROWNL
+;
+
+381 
+__END_NAMESPACE_STD
+
+
+383 #i
+defed
+ 
+__USE_BSD
+ || defed 
+__USE_ISOC99
+ || defed 
+__USE_UNIX98
+
+
+384 
+__BEGIN_NAMESPACE_C99
+
+
+386 
+	$tf
+ (*
+__ri
+ 
+__s
+, 
+size_t
+ 
+__maxn
+,
+
+387 c *
+__ri
+ 
+__fm
+, ...)
+
+388 
+__THROWNL
+ 
+	`__ibu__
+ ((
+	`__fm__
+ (
+__tf__
+, 3, 4)));
+
+390 
+	$vtf
+ (*
+__ri
+ 
+__s
+, 
+size_t
+ 
+__maxn
+,
+
+391 c *
+__ri
+ 
+__fm
+, 
+_G_va_li
+ 
+__g
+)
+
+392 
+__THROWNL
+ 
+	`__ibu__
+ ((
+	`__fm__
+ (
+__tf__
+, 3, 0)));
+
+393 
+__END_NAMESPACE_C99
+
+
+396 #ifde
+__USE_GNU
+
+
+399 
+	$vartf
+ (**
+__ri
+ 
+__r
+, c *__ri 
+__f
+,
+
+400 
+_G_va_li
+ 
+__g
+)
+
+401 
+__THROWNL
+ 
+	`__ibu__
+ ((
+	$__fm__
+ (
+__tf__
+, 2, 0))
+__wur
+;
+
+402 
+	$__artf
+ (**
+__ri
+ 
+__r
+,
+
+403 c *
+__ri
+ 
+__fmt
+, ...)
+
+404 
+__THROWNL
+ 
+	`__ibu__
+ ((
+	$__fm__
+ (
+__tf__
+, 2, 3))
+__wur
+;
+
+405 
+	$artf
+ (**
+__ri
+ 
+__r
+,
+
+406 c *
+__ri
+ 
+__fmt
+, ...)
+
+407 
+__THROWNL
+ 
+	`__ibu__
+ ((
+	$__fm__
+ (
+__tf__
+, 2, 3))
+__wur
+;
+
+410 #ifde
+__USE_XOPEN2K8
+
+
+412 
+	$vdtf
+ (
+__fd
+, c *
+__ri
+ 
+__fmt
+,
+
+413 
+_G_va_li
+ 
+__g
+)
+
+414 
+	`__ibu__
+ ((
+	`__fm__
+ (
+__tf__
+, 2, 0)));
+
+415 
+	$dtf
+ (
+__fd
+, c *
+__ri
+ 
+__fmt
+, ...)
+
+416 
+	`__ibu__
+ ((
+	`__fm__
+ (
+__tf__
+, 2, 3)));
+
+420 
+__BEGIN_NAMESPACE_STD
+
+
+425 
+	$fsnf
+ (
+FILE
+ *
+__ri
+ 
+__am
+,
+
+426 c *
+__ri
+ 
+__fm
+, ...
+__wur
+;
+
+431 
+	$snf
+ (c *
+__ri
+ 
+__fm
+, ...
+__wur
+;
+
+433 
+	$ssnf
+ (c *
+__ri
+ 
+__s
+,
+
+434 c *
+__ri
+ 
+__fm
+, ...
+__THROW
+;
+
+436 #i
+defed
+ 
+__USE_ISOC99
+ && !defed 
+__USE_GNU
+ \
+
+437 && (!
+defed
+ 
+__LDBL_COMPAT
+ || !defed 
+__REDIRECT
+) \
+
+438 && (
+defed
+ 
+__STRICT_ANSI__
+ || defed 
+__USE_XOPEN2K
+)
+
+439 #ifde
+__REDIRECT
+
+
+443 
+	`__REDIRECT
+ (
+fsnf
+, (
+FILE
+ *
+__ri
+ 
+__am
+,
+
+444 c *
+__ri
+ 
+__fm
+, ...),
+
+445 
+__isoc99_fsnf
+
+__wur
+;
+
+446 
+	`__REDIRECT
+ (
+snf
+, (c *
+__ri
+ 
+__fm
+, ...),
+
+447 
+__isoc99_snf
+
+__wur
+;
+
+448 
+	`__REDIRECT_NTH
+ (
+ssnf
+, (c *
+__ri
+ 
+__s
+,
+
+449 c *
+__ri
+ 
+__fm
+, ...),
+
+450 
+__isoc99_ssnf
+);
+
+452 
+	$__isoc99_fsnf
+ (
+FILE
+ *
+__ri
+ 
+__am
+,
+
+453 c *
+__ri
+ 
+__fm
+, ...
+__wur
+;
+
+454 
+	$__isoc99_snf
+ (c *
+__ri
+ 
+__fm
+, ...
+__wur
+;
+
+455 
+	$__isoc99_ssnf
+ (c *
+__ri
+ 
+__s
+,
+
+456 c *
+__ri
+ 
+__fm
+, ...
+__THROW
+;
+
+457 
+	#fsnf
+ 
+__isoc99_fsnf
+
+
+	)
+
+458 
+	#snf
+ 
+__isoc99_snf
+
+
+	)
+
+459 
+	#ssnf
+ 
+__isoc99_ssnf
+
+
+	)
+
+463 
+__END_NAMESPACE_STD
+
+
+465 #ifdef 
+__USE_ISOC99
+
+
+466 
+__BEGIN_NAMESPACE_C99
+
+
+471 
+	$vfsnf
+ (
+FILE
+ *
+__ri
+ 
+__s
+, c *__ri 
+__fm
+,
+
+472 
+_G_va_li
+ 
+__g
+)
+
+473 
+	`__ibu__
+ ((
+	$__fm__
+ (
+__snf__
+, 2, 0))
+__wur
+;
+
+479 
+	$vsnf
+ (c *
+__ri
+ 
+__fm
+, 
+_G_va_li
+ 
+__g
+)
+
+480 
+	`__ibu__
+ ((
+	$__fm__
+ (
+__snf__
+, 1, 0))
+__wur
+;
+
+483 
+	$vssnf
+ (c *
+__ri
+ 
+__s
+,
+
+484 c *
+__ri
+ 
+__fm
+, 
+_G_va_li
+ 
+__g
+)
+
+485 
+__THROW
+ 
+	`__ibu__
+ ((
+	`__fm__
+ (
+__snf__
+, 2, 0)));
+
+487 #i!
+defed
+ 
+__USE_GNU
+ \
+
+488 && (!
+defed
+ 
+__LDBL_COMPAT
+ || !defed 
+__REDIRECT
+) \
+
+489 && (
+defed
+ 
+__STRICT_ANSI__
+ || defed 
+__USE_XOPEN2K
+)
+
+490 #ifde
+__REDIRECT
+
+
+494 
+	`__REDIRECT
+ (
+vfsnf
+,
+
+495 (
+FILE
+ *
+__ri
+ 
+__s
+,
+
+496 c *
+__ri
+ 
+__fm
+, 
+_G_va_li
+ 
+__g
+),
+
+497 
+__isoc99_vfsnf
+)
+
+498 
+	`__ibu__
+ ((
+	$__fm__
+ (
+__snf__
+, 2, 0))
+__wur
+;
+
+499 
+	`__REDIRECT
+ (
+vsnf
+, (c *
+__ri
+ 
+__fm
+,
+
+500 
+_G_va_li
+ 
+__g
+), 
+__isoc99_vsnf
+)
+
+501 
+	`__ibu__
+ ((
+	$__fm__
+ (
+__snf__
+, 1, 0))
+__wur
+;
+
+502 
+	`__REDIRECT_NTH
+ (
+vssnf
+,
+
+503 (c *
+__ri
+ 
+__s
+,
+
+504 c *
+__ri
+ 
+__fm
+,
+
+505 
+_G_va_li
+ 
+__g
+), 
+__isoc99_vssnf
+)
+
+506 
+	`__ibu__
+ ((
+	`__fm__
+ (
+__snf__
+, 2, 0)));
+
+508 
+	$__isoc99_vfsnf
+ (
+FILE
+ *
+__ri
+ 
+__s
+,
+
+509 c *
+__ri
+ 
+__fm
+,
+
+510 
+_G_va_li
+ 
+__g
+
+__wur
+;
+
+511 
+	$__isoc99_vsnf
+ (c *
+__ri
+ 
+__fm
+,
+
+512 
+_G_va_li
+ 
+__g
+
+__wur
+;
+
+513 
+	$__isoc99_vssnf
+ (c *
+__ri
+ 
+__s
+,
+
+514 c *
+__ri
+ 
+__fm
+,
+
+515 
+_G_va_li
+ 
+__g
+
+__THROW
+;
+
+516 
+	#vfsnf
+ 
+__isoc99_vfsnf
+
+
+	)
+
+517 
+	#vsnf
+ 
+__isoc99_vsnf
+
+
+	)
+
+518 
+	#vssnf
+ 
+__isoc99_vssnf
+
+
+	)
+
+522 
+__END_NAMESPACE_C99
+
+
+526 
+__BEGIN_NAMESPACE_STD
+
+
+531 
+	`fgc
+ (
+FILE
+ *
+__am
+);
+
+532 
+	`gc
+ (
+FILE
+ *
+__am
+);
+
+538 
+	`gch
+ ();
+
+539 
+__END_NAMESPACE_STD
+
+
+543 
+	#gc
+(
+_
+
+	`_IO_gc
+ (_)
+
+	)
+
+545 #i
+defed
+ 
+__USE_POSIX
+ || defed 
+__USE_MISC
+
+
+550 
+	`gc_uocked
+ (
+FILE
+ *
+__am
+);
+
+551 
+	`gch_uocked
+ ();
+
+554 #ifde
+__USE_MISC
+
+
+561 
+	`fgc_uocked
+ (
+FILE
+ *
+__am
+);
+
+565 
+__BEGIN_NAMESPACE_STD
+
+
+573 
+	`utc
+ (
+__c
+, 
+FILE
+ *
+__am
+);
+
+574 
+	`putc
+ (
+__c
+, 
+FILE
+ *
+__am
+);
+
+580 
+	`putch
+ (
+__c
+);
+
+581 
+__END_NAMESPACE_STD
+
+
+585 
+	#putc
+(
+_ch
+, 
+_
+
+	`_IO_putc
+ (_ch, _)
+
+	)
+
+587 #ifde
+__USE_MISC
+
+
+594 
+	`utc_uocked
+ (
+__c
+, 
+FILE
+ *
+__am
+);
+
+597 #i
+defed
+ 
+__USE_POSIX
+ || defed 
+__USE_MISC
+
+
+602 
+	`putc_uocked
+ (
+__c
+, 
+FILE
+ *
+__am
+);
+
+603 
+	`putch_uocked
+ (
+__c
+);
+
+607 #i
+defed
+ 
+__USE_SVID
+ || defed 
+__USE_MISC
+ \
+
+608 || (
+defed
+ 
+__USE_XOPEN
+ && !defed 
+__USE_XOPEN2K
+)
+
+610 
+	`gw
+ (
+FILE
+ *
+__am
+);
+
+613 
+	`putw
+ (
+__w
+, 
+FILE
+ *
+__am
+);
+
+617 
+__BEGIN_NAMESPACE_STD
+
+
+622 *
+	$fgs
+ (*
+__ri
+ 
+__s
+, 
+__n
+, 
+FILE
+ *__ri 
+__am
+)
+
+623 
+__wur
+;
+
+625 #i!
+defed
+ 
+__USE_ISOC11
+ \
+
+626 || (
+defed
+ 
+__lulus
+ && __cplusplus <= 201103L)
+
+638 *
+	$gs
+ (*
+__s
+
+__wur
+ 
+__ibu_dd__
+;
+
+640 
+__END_NAMESPACE_STD
+
+
+642 #ifde
+__USE_GNU
+
+
+649 *
+	$fgs_uocked
+ (*
+__ri
+ 
+__s
+, 
+__n
+,
+
+650 
+FILE
+ *
+__ri
+ 
+__am
+
+__wur
+;
+
+654 #ifdef 
+__USE_XOPEN2K8
+
+
+665 
+_IO_ssize_t
+ 
+	$__gdim
+ (**
+__ri
+ 
+__l
+,
+
+666 
+size_t
+ *
+__ri
+ 
+__n
+, 
+__dim
+,
+
+667 
+FILE
+ *
+__ri
+ 
+__am
+
+__wur
+;
+
+668 
+_IO_ssize_t
+ 
+	$gdim
+ (**
+__ri
+ 
+__l
+,
+
+669 
+size_t
+ *
+__ri
+ 
+__n
+, 
+__dim
+,
+
+670 
+FILE
+ *
+__ri
+ 
+__am
+
+__wur
+;
+
+678 
+_IO_ssize_t
+ 
+	$gle
+ (**
+__ri
+ 
+__l
+,
+
+679 
+size_t
+ *
+__ri
+ 
+__n
+,
+
+680 
+FILE
+ *
+__ri
+ 
+__am
+
+__wur
+;
+
+684 
+__BEGIN_NAMESPACE_STD
+
+
+689 
+	`uts
+ (c *
+__ri
+ 
+__s
+, 
+FILE
+ *__ri 
+__am
+);
+
+695 
+	`puts
+ (c *
+__s
+);
+
+702 
+	`ungc
+ (
+__c
+, 
+FILE
+ *
+__am
+);
+
+709 
+size_t
+ 
+	$d
+ (*
+__ri
+ 
+__r
+, 
+size_t
+ 
+__size
+,
+
+710 
+size_t
+ 
+__n
+, 
+FILE
+ *
+__ri
+ 
+__am
+
+__wur
+;
+
+715 
+size_t
+ 
+	`fwre
+ (c *
+__ri
+ 
+__r
+, size_
+__size
+,
+
+716 
+size_t
+ 
+__n
+, 
+FILE
+ *
+__ri
+ 
+__s
+);
+
+717 
+__END_NAMESPACE_STD
+
+
+719 #ifde
+__USE_GNU
+
+
+726 
+	`uts_uocked
+ (c *
+__ri
+ 
+__s
+,
+
+727 
+FILE
+ *
+__ri
+ 
+__am
+);
+
+730 #ifde
+__USE_MISC
+
+
+737 
+size_t
+ 
+	$d_uocked
+ (*
+__ri
+ 
+__r
+, 
+size_t
+ 
+__size
+,
+
+738 
+size_t
+ 
+__n
+, 
+FILE
+ *
+__ri
+ 
+__am
+
+__wur
+;
+
+739 
+size_t
+ 
+	`fwre_uocked
+ (c *
+__ri
+ 
+__r
+, size_
+__size
+,
+
+740 
+size_t
+ 
+__n
+, 
+FILE
+ *
+__ri
+ 
+__am
+);
+
+744 
+__BEGIN_NAMESPACE_STD
+
+
+749 
+	`fek
+ (
+FILE
+ *
+__am
+, 
+__off
+, 
+__wh
+);
+
+754 
+	$l
+ (
+FILE
+ *
+__am
+
+__wur
+;
+
+759 
+	`wd
+ (
+FILE
+ *
+__am
+);
+
+760 
+__END_NAMESPACE_STD
+
+
+767 #i
+defed
+ 
+__USE_LARGEFILE
+ || defed 
+__USE_XOPEN2K
+
+
+768 #ide
+__USE_FILE_OFFSET64
+
+
+773 
+	`feko
+ (
+FILE
+ *
+__am
+, 
+__off_t
+ 
+__off
+, 
+__wh
+);
+
+778 
+__off_t
+ 
+	$lo
+ (
+FILE
+ *
+__am
+
+__wur
+;
+
+780 #ifde
+__REDIRECT
+
+
+781 
+	`__REDIRECT
+ (
+feko
+,
+
+782 (
+FILE
+ *
+__am
+, 
+__off64_t
+ 
+__off
+, 
+__wh
+),
+
+783 
+feko64
+);
+
+784 
+__off64_t
+ 
+	`__REDIRECT
+ (
+lo
+, (
+FILE
+ *
+__am
+), 
+lo64
+);
+
+786 
+	#feko
+ 
+feko64
+
+
+	)
+
+787 
+	#lo
+ 
+lo64
+
+
+	)
+
+792 
+__BEGIN_NAMESPACE_STD
+
+
+793 #ide
+__USE_FILE_OFFSET64
+
+
+798 
+	`fgpos
+ (
+FILE
+ *
+__ri
+ 
+__am
+, 
+os_t
+ *__ri 
+__pos
+);
+
+803 
+	`fos
+ (
+FILE
+ *
+__am
+, c 
+os_t
+ *
+__pos
+);
+
+805 #ifde
+__REDIRECT
+
+
+806 
+	`__REDIRECT
+ (
+fgpos
+, (
+FILE
+ *
+__ri
+ 
+__am
+,
+
+807 
+os_t
+ *
+__ri
+ 
+__pos
+), 
+fgpos64
+);
+
+808 
+	`__REDIRECT
+ (
+fos
+,
+
+809 (
+FILE
+ *
+__am
+, c 
+os_t
+ *
+__pos
+), 
+fos64
+);
+
+811 
+	#fgpos
+ 
+fgpos64
+
+
+	)
+
+812 
+	#fos
+ 
+fos64
+
+
+	)
+
+815 
+__END_NAMESPACE_STD
+
+
+817 #ifde
+__USE_LARGEFILE64
+
+
+818 
+	`feko64
+ (
+FILE
+ *
+__am
+, 
+__off64_t
+ 
+__off
+, 
+__wh
+);
+
+819 
+__off64_t
+ 
+	$lo64
+ (
+FILE
+ *
+__am
+
+__wur
+;
+
+820 
+	`fgpos64
+ (
+FILE
+ *
+__ri
+ 
+__am
+, 
+os64_t
+ *__ri 
+__pos
+);
+
+821 
+	`fos64
+ (
+FILE
+ *
+__am
+, c 
+os64_t
+ *
+__pos
+);
+
+824 
+__BEGIN_NAMESPACE_STD
+
+
+826 
+	$
+ (
+FILE
+ *
+__am
+
+__THROW
+;
+
+828 
+	$of
+ (
+FILE
+ *
+__am
+
+__THROW
+ 
+__wur
+;
+
+830 
+	$
+ (
+FILE
+ *
+__am
+
+__THROW
+ 
+__wur
+;
+
+831 
+__END_NAMESPACE_STD
+
+
+833 #ifde
+__USE_MISC
+
+
+835 
+	$_uocked
+ (
+FILE
+ *
+__am
+
+__THROW
+;
+
+836 
+	$of_uocked
+ (
+FILE
+ *
+__am
+
+__THROW
+ 
+__wur
+;
+
+837 
+	$_uocked
+ (
+FILE
+ *
+__am
+
+__THROW
+ 
+__wur
+;
+
+841 
+__BEGIN_NAMESPACE_STD
+
+
+846 
+	`
+ (c *
+__s
+);
+
+847 
+__END_NAMESPACE_STD
+
+
+853 
+	~<bs/sys_i.h
+>
+
+856 #ifdef 
+__USE_POSIX
+
+
+858 
+	$fo
+ (
+FILE
+ *
+__am
+
+__THROW
+ 
+__wur
+;
+
+861 #ifde
+__USE_MISC
+
+
+863 
+	$fo_uocked
+ (
+FILE
+ *
+__am
+
+__THROW
+ 
+__wur
+;
+
+867 #i(
+defed
+ 
+__USE_POSIX2
+ || defed 
+__USE_SVID
+ || defed 
+__USE_BSD
+ || \
+
+868 
+defed
+ 
+__USE_MISC
+)
+
+873 
+FILE
+ *
+	$p
+ (c *
+__commd
+, c *
+__modes
+
+__wur
+;
+
+879 
+	`po
+ (
+FILE
+ *
+__am
+);
+
+883 #ifdef 
+__USE_POSIX
+
+
+885 *
+	$mid
+ (*
+__s
+
+__THROW
+;
+
+889 #ifde
+__USE_XOPEN
+
+
+891 *
+	`curid
+ (*
+__s
+);
+
+895 #ifdef 
+__USE_GNU
+
+
+896 
+oback
+;
+
+899 
+	$oback_tf
+ (
+oback
+ *
+__ri
+ 
+__oback
+,
+
+900 c *
+__ri
+ 
+__fm
+, ...)
+
+901 
+__THROWNL
+ 
+	`__ibu__
+ ((
+	`__fm__
+ (
+__tf__
+, 2, 3)));
+
+902 
+	$oback_vtf
+ (
+oback
+ *
+__ri
+ 
+__oback
+,
+
+903 c *
+__ri
+ 
+__fm
+,
+
+904 
+_G_va_li
+ 
+__gs
+)
+
+905 
+__THROWNL
+ 
+	`__ibu__
+ ((
+	`__fm__
+ (
+__tf__
+, 2, 0)));
+
+909 #i
+defed
+ 
+__USE_POSIX
+ || defed 
+__USE_MISC
+
+
+913 
+	$ockfe
+ (
+FILE
+ *
+__am
+
+__THROW
+;
+
+917 
+	$rylockfe
+ (
+FILE
+ *
+__am
+
+__THROW
+ 
+__wur
+;
+
+920 
+	$fuockfe
+ (
+FILE
+ *
+__am
+
+__THROW
+;
+
+923 #i
+defed
+ 
+__USE_XOPEN
+ && !defed 
+__USE_XOPEN2K
+ && !defed 
+__USE_GNU
+
+
+927 
+	#__ed_gt
+
+
+	)
+
+928 
+	~<gt.h
+>
+
+933 #ifde
+__USE_EXTERN_INLINES
+
+
+934 
+	~<bs/dio.h
+>
+
+936 #i
+__USE_FORTIFY_LEVEL
+ > 0 && 
+defed
+ 
+__ex_ways_le
+
+
+937 
+	~<bs/dio2.h
+>
+
+939 #ifde
+__LDBL_COMPAT
+
+
+940 
+	~<bs/dio-ldbl.h
+>
+
+943 
+__END_DECLS
+
+
+	@/usr/include/stdlib.h
+
+22 #idef 
+_STDLIB_H
+
+
+24 
+	~<us.h
+>
+
+27 
+	#__ed_size_t
+
+
+	)
+
+28 #ide
+__ed_mloc_d_oc
+
+
+29 
+	#__ed_wch_t
+
+
+	)
+
+30 
+	#__ed_NULL
+
+
+	)
+
+32 
+	~<ddef.h
+>
+
+34 
+	g__BEGIN_DECLS
+
+
+36 #ide
+__ed_mloc_d_oc
+
+
+37 
+	#_STDLIB_H
+ 1
+
+	)
+
+39 #i(
+defed
+ 
+__USE_XOPEN
+ || defed 
+__USE_XOPEN2K8
+&& !defed 
+_SYS_WAIT_H
+
+
+41 
+	~<bs/waags.h
+>
+
+42 
+	~<bs/waus.h
+>
+
+44 #ifde
+__USE_BSD
+
+
+49 #i
+defed
+ 
+__GNUC__
+ && !defed 
+__lulus
+
+
+50 
+	#__WAIT_INT
+(
+us
+) \
+
+51 (
+	`__exnsi__
+ (((uni { 
+	`__tyof
+(
+us
+
+__
+; 
+__i
+; }) \
+
+52 { .
+__
+ = (
+us
+}).
+__i
+))
+
+	)
+
+54 
+	#__WAIT_INT
+(
+us
+(*(*&(us))
+
+	)
+
+62 #i!
+defed
+ 
+__GNUC__
+ || __GNUC__ < 2 || defed 
+__lulus
+
+
+63 
+	#__WAIT_STATUS
+ *
+
+	)
+
+64 
+	#__WAIT_STATUS_DEFN
+ *
+
+	)
+
+69 
+wa
+ *
+	m__ur
+;
+
+70 *
+	m__
+;
+
+71 } 
+	t__WAIT_STATUS
+ 
+	t__ibu__
+ ((
+	t__t_uni__
+));
+
+72 
+	#__WAIT_STATUS_DEFN
+ *
+
+	)
+
+77 
+	#__WAIT_INT
+(
+us
+(us)
+
+	)
+
+78 
+	#__WAIT_STATUS
+ *
+
+	)
+
+79 
+	#__WAIT_STATUS_DEFN
+ *
+
+	)
+
+84 
+	#WEXITSTATUS
+(
+us
+
+	`__WEXITSTATUS
+ (
+	`__WAIT_INT
+ (us))
+
+	)
+
+85 
+	#WTERMSIG
+(
+us
+
+	`__WTERMSIG
+ (
+	`__WAIT_INT
+ (us))
+
+	)
+
+86 
+	#WSTOPSIG
+(
+us
+
+	`__WSTOPSIG
+ (
+	`__WAIT_INT
+ (us))
+
+	)
+
+87 
+	#WIFEXITED
+(
+us
+
+	`__WIFEXITED
+ (
+	`__WAIT_INT
+ (us))
+
+	)
+
+88 
+	#WIFSIGNALED
+(
+us
+
+	`__WIFSIGNALED
+ (
+	`__WAIT_INT
+ (us))
+
+	)
+
+89 
+	#WIFSTOPPED
+(
+us
+
+	`__WIFSTOPPED
+ (
+	`__WAIT_INT
+ (us))
+
+	)
+
+90 #ifde
+__WIFCONTINUED
+
+
+91 
+	#WIFCONTINUED
+(
+us
+
+	`__WIFCONTINUED
+ (
+	`__WAIT_INT
+ (us))
+
+	)
+
+95 
+__BEGIN_NAMESPACE_STD
+
+
+99 
+	mqu
+;
+
+100 
+	mm
+;
+
+101 } 
+	tdiv_t
+;
+
+104 #ide
+__ldiv_t_defed
+
+
+107 
+	mqu
+;
+
+108 
+	mm
+;
+
+109 } 
+	tldiv_t
+;
+
+110 
+	#__ldiv_t_defed
+ 1
+
+	)
+
+112 
+	g__END_NAMESPACE_STD
+
+
+114 #i
+defed
+ 
+__USE_ISOC99
+ && !defed 
+__div_t_defed
+
+
+115 
+__BEGIN_NAMESPACE_C99
+
+
+117 
+__exnsi__
+ struct
+
+119 
+	mqu
+;
+
+120 
+	mm
+;
+
+121 } 
+	tdiv_t
+;
+
+122 
+	#__div_t_defed
+ 1
+
+	)
+
+123 
+	g__END_NAMESPACE_C99
+
+
+128 
+	#RAND_MAX
+ 2147483647
+
+	)
+
+133 
+	#EXIT_FAILURE
+ 1
+
+	)
+
+134 
+	#EXIT_SUCCESS
+ 0
+
+	)
+
+138 
+	#MB_CUR_MAX
+ (
+	`__y_g_mb_cur_max
+ ())
+
+	)
+
+139 
+size_t
+ 
+	$__y_g_mb_cur_max
+ (
+__THROW
+ 
+__wur
+;
+
+142 
+__BEGIN_NAMESPACE_STD
+
+
+144 
+	$of
+ (c *
+__
+)
+
+145 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+147 
+	$oi
+ (c *
+__
+)
+
+148 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+150 
+	$
+ (c *
+__
+)
+
+151 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+152 
+__END_NAMESPACE_STD
+
+
+154 #i
+defed
+ 
+__USE_ISOC99
+ || defed 
+__USE_MISC
+
+
+155 
+__BEGIN_NAMESPACE_C99
+
+
+157 
+__exnsi__
+ 
+	$l
+ (c *
+__
+)
+
+158 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+159 
+__END_NAMESPACE_C99
+
+
+162 
+__BEGIN_NAMESPACE_STD
+
+
+164 
+	$od
+ (c *
+__ri
+ 
+__
+,
+
+165 **
+__ri
+ 
+__dr
+)
+
+166 
+__THROW
+ 
+	`__nnu
+ ((1));
+
+167 
+__END_NAMESPACE_STD
+
+
+169 #ifdef 
+__USE_ISOC99
+
+
+170 
+__BEGIN_NAMESPACE_C99
+
+
+172 
+	$of
+ (c *
+__ri
+ 
+__
+,
+
+173 **
+__ri
+ 
+__dr
+
+__THROW
+ 
+	`__nnu
+ ((1));
+
+175 
+	$d
+ (c *
+__ri
+ 
+__
+,
+
+176 **
+__ri
+ 
+__dr
+)
+
+177 
+__THROW
+ 
+	`__nnu
+ ((1));
+
+178 
+__END_NAMESPACE_C99
+
+
+181 
+__BEGIN_NAMESPACE_STD
+
+
+183 
+	$
+ (c *
+__ri
+ 
+__
+,
+
+184 **
+__ri
+ 
+__dr
+, 
+__ba
+)
+
+185 
+__THROW
+ 
+	`__nnu
+ ((1));
+
+187 
+	$oul
+ (c *
+__ri
+ 
+__
+,
+
+188 **
+__ri
+ 
+__dr
+, 
+__ba
+)
+
+189 
+__THROW
+ 
+	`__nnu
+ ((1));
+
+190 
+__END_NAMESPACE_STD
+
+
+192 #ifde
+__USE_BSD
+
+
+194 
+__exnsi__
+
+
+195 
+	$oq
+ (c *
+__ri
+ 
+__
+,
+
+196 **
+__ri
+ 
+__dr
+, 
+__ba
+)
+
+197 
+__THROW
+ 
+	`__nnu
+ ((1));
+
+199 
+__exnsi__
+
+
+200 
+	$ouq
+ (c *
+__ri
+ 
+__
+,
+
+201 **
+__ri
+ 
+__dr
+, 
+__ba
+)
+
+202 
+__THROW
+ 
+	`__nnu
+ ((1));
+
+205 #i
+defed
+ 
+__USE_ISOC99
+ || defed 
+__USE_MISC
+
+
+206 
+__BEGIN_NAMESPACE_C99
+
+
+208 
+__exnsi__
+
+
+209 
+	$l
+ (c *
+__ri
+ 
+__
+,
+
+210 **
+__ri
+ 
+__dr
+, 
+__ba
+)
+
+211 
+__THROW
+ 
+	`__nnu
+ ((1));
+
+213 
+__exnsi__
+
+
+214 
+	$ou
+ (c *
+__ri
+ 
+__
+,
+
+215 **
+__ri
+ 
+__dr
+, 
+__ba
+)
+
+216 
+__THROW
+ 
+	`__nnu
+ ((1));
+
+217 
+__END_NAMESPACE_C99
+
+
+221 #ifde
+__USE_GNU
+
+
+235 
+	~<xlo.h
+>
+
+239 
+	$_l
+ (c *
+__ri
+ 
+__
+,
+
+240 **
+__ri
+ 
+__dr
+, 
+__ba
+,
+
+241 
+__lo_t
+ 
+__loc
+
+__THROW
+ 
+	`__nnu
+ ((1, 4));
+
+243 
+	$oul_l
+ (c *
+__ri
+ 
+__
+,
+
+244 **
+__ri
+ 
+__dr
+,
+
+245 
+__ba
+, 
+__lo_t
+ 
+__loc
+)
+
+246 
+__THROW
+ 
+	`__nnu
+ ((1, 4));
+
+248 
+__exnsi__
+
+
+249 
+	$l_l
+ (c *
+__ri
+ 
+__
+,
+
+250 **
+__ri
+ 
+__dr
+, 
+__ba
+,
+
+251 
+__lo_t
+ 
+__loc
+)
+
+252 
+__THROW
+ 
+	`__nnu
+ ((1, 4));
+
+254 
+__exnsi__
+
+
+255 
+	$ou_l
+ (c *
+__ri
+ 
+__
+,
+
+256 **
+__ri
+ 
+__dr
+,
+
+257 
+__ba
+, 
+__lo_t
+ 
+__loc
+)
+
+258 
+__THROW
+ 
+	`__nnu
+ ((1, 4));
+
+260 
+	$od_l
+ (c *
+__ri
+ 
+__
+,
+
+261 **
+__ri
+ 
+__dr
+, 
+__lo_t
+ 
+__loc
+)
+
+262 
+__THROW
+ 
+	`__nnu
+ ((1, 3));
+
+264 
+	$of_l
+ (c *
+__ri
+ 
+__
+,
+
+265 **
+__ri
+ 
+__dr
+, 
+__lo_t
+ 
+__loc
+)
+
+266 
+__THROW
+ 
+	`__nnu
+ ((1, 3));
+
+268 
+	$d_l
+ (c *
+__ri
+ 
+__
+,
+
+269 **
+__ri
+ 
+__dr
+,
+
+270 
+__lo_t
+ 
+__loc
+)
+
+271 
+__THROW
+ 
+	`__nnu
+ ((1, 3));
+
+275 #ifde
+__USE_EXTERN_INLINES
+
+
+276 
+__BEGIN_NAMESPACE_STD
+
+
+277 
+__ex_le
+ 
+
+278 
+	`__NTH
+ (
+	$oi
+ (c *
+__
+))
+
+280  (
+	`
+ (
+__
+, (**
+NULL
+, 10);
+
+281 
+	}
+}
+
+282 
+__ex_le
+ 
+
+283 
+__NTH
+ (
+	$
+ (c *
+__
+))
+
+285  
+	`
+ (
+__
+, (**
+NULL
+, 10);
+
+286 
+	}
+}
+
+287 
+	g__END_NAMESPACE_STD
+
+
+289 #i
+defed
+ 
+__USE_MISC
+ || defed 
+__USE_ISOC99
+
+
+290 
+__BEGIN_NAMESPACE_C99
+
+
+291 
+__exnsi__
+ 
+__ex_le
+ 
+
+292 
+__NTH
+ (
+	$l
+ (c *
+__
+))
+
+294  
+	`l
+ (
+__
+, (**
+NULL
+, 10);
+
+295 
+	}
+}
+
+296 
+	g__END_NAMESPACE_C99
+
+
+301 #i
+defed
+ 
+__USE_SVID
+ || defed 
+__USE_XOPEN_EXTENDED
+
+
+305 *
+	$l64a
+ (
+__n
+
+__THROW
+ 
+__wur
+;
+
+308 
+	$a64l
+ (c *
+__s
+)
+
+309 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+313 #i
+defed
+ 
+__USE_SVID
+ || defed 
+__USE_XOPEN_EXTENDED
+ || defed 
+__USE_BSD
+
+
+314 
+	~<sys/tys.h
+>
+
+321 
+	$ndom
+ (
+__THROW
+;
+
+324 
+	$dom
+ (
+__ed
+
+__THROW
+;
+
+330 *
+	$e
+ (
+__ed
+, *
+__ebuf
+,
+
+331 
+size_t
+ 
+__
+
+__THROW
+ 
+	`__nnu
+ ((2));
+
+335 *
+	$te
+ (*
+__ebuf
+
+__THROW
+ 
+	`__nnu
+ ((1));
+
+338 #ifde
+__USE_MISC
+
+
+343 
+	sndom_da
+
+
+345 
+t32_t
+ *
+
+;
+
+346 
+t32_t
+ *
+
+;
+
+347 
+t32_t
+ *
+e
+;
+
+348 
+nd_ty
+;
+
+349 
+nd_deg
+;
+
+350 
+nd_p
+;
+
+351 
+t32_t
+ *
+d_r
+;
+
+354 
+	$ndom_r
+ (
+ndom_da
+ *
+__ri
+ 
+__buf
+,
+
+355 
+t32_t
+ *
+__ri
+ 
+__su
+
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+357 
+	$dom_r
+ (
+__ed
+, 
+ndom_da
+ *
+__buf
+)
+
+358 
+__THROW
+ 
+	`__nnu
+ ((2));
+
+360 
+	$e_r
+ (
+__ed
+, *
+__ri
+ 
+__ebuf
+,
+
+361 
+size_t
+ 
+__
+,
+
+362 
+ndom_da
+ *
+__ri
+ 
+__buf
+)
+
+363 
+__THROW
+ 
+	`__nnu
+ ((2, 4));
+
+365 
+	$te_r
+ (*
+__ri
+ 
+__ebuf
+,
+
+366 
+ndom_da
+ *
+__ri
+ 
+__buf
+)
+
+367 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+372 
+__BEGIN_NAMESPACE_STD
+
+
+374 
+	$nd
+ (
+__THROW
+;
+
+376 
+	$d
+ (
+__ed
+
+__THROW
+;
+
+377 
+__END_NAMESPACE_STD
+
+
+379 #ifde
+__USE_POSIX
+
+
+381 
+	$nd_r
+ (*
+__ed
+
+__THROW
+;
+
+385 #i
+defed
+ 
+__USE_SVID
+ || defed 
+__USE_XOPEN
+
+
+389 
+	$dnd48
+ (
+__THROW
+;
+
+390 
+	$d48
+ (
+__xsubi
+[3]
+__THROW
+ 
+	`__nnu
+ ((1));
+
+393 
+	$d48
+ (
+__THROW
+;
+
+394 
+	$d48
+ (
+__xsubi
+[3])
+
+395 
+__THROW
+ 
+	`__nnu
+ ((1));
+
+398 
+	$mnd48
+ (
+__THROW
+;
+
+399 
+	$jnd48
+ (
+__xsubi
+[3])
+
+400 
+__THROW
+ 
+	`__nnu
+ ((1));
+
+403 
+	$d48
+ (
+__edv
+
+__THROW
+;
+
+404 *
+	$ed48
+ (
+__ed16v
+[3])
+
+405 
+__THROW
+ 
+	`__nnu
+ ((1));
+
+406 
+	$lcg48
+ (
+__m
+[7]
+__THROW
+ 
+	`__nnu
+ ((1));
+
+408 #ifde
+__USE_MISC
+
+
+412 
+	sdnd48_da
+
+
+414 
+__x
+[3];
+
+415 
+__d_x
+[3];
+
+416 
+__c
+;
+
+417 
+__
+;
+
+418 
+__exnsi__
+ 
+__a
+;
+
+423 
+	$dnd48_r
+ (
+dnd48_da
+ *
+__ri
+ 
+__bufr
+,
+
+424 *
+__ri
+ 
+__su
+
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+425 
+	$d48_r
+ (
+__xsubi
+[3],
+
+426 
+dnd48_da
+ *
+__ri
+ 
+__bufr
+,
+
+427 *
+__ri
+ 
+__su
+
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+430 
+	$d48_r
+ (
+dnd48_da
+ *
+__ri
+ 
+__bufr
+,
+
+431 *
+__ri
+ 
+__su
+)
+
+432 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+433 
+	$d48_r
+ (
+__xsubi
+[3],
+
+434 
+dnd48_da
+ *
+__ri
+ 
+__bufr
+,
+
+435 *
+__ri
+ 
+__su
+)
+
+436 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+439 
+	$mnd48_r
+ (
+dnd48_da
+ *
+__ri
+ 
+__bufr
+,
+
+440 *
+__ri
+ 
+__su
+)
+
+441 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+442 
+	$jnd48_r
+ (
+__xsubi
+[3],
+
+443 
+dnd48_da
+ *
+__ri
+ 
+__bufr
+,
+
+444 *
+__ri
+ 
+__su
+)
+
+445 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+448 
+	$d48_r
+ (
+__edv
+, 
+dnd48_da
+ *
+__bufr
+)
+
+449 
+__THROW
+ 
+	`__nnu
+ ((2));
+
+451 
+	$ed48_r
+ (
+__ed16v
+[3],
+
+452 
+dnd48_da
+ *
+__bufr
+
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+454 
+	$lcg48_r
+ (
+__m
+[7],
+
+455 
+dnd48_da
+ *
+__bufr
+)
+
+456 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+462 #ide
+__mloc_d_oc_defed
+
+
+463 
+	#__mloc_d_oc_defed
+
+
+	)
+
+464 
+__BEGIN_NAMESPACE_STD
+
+
+466 *
+	$mloc
+ (
+size_t
+ 
+__size
+
+__THROW
+ 
+__ibu_mloc__
+ 
+__wur
+;
+
+468 *
+	$oc
+ (
+size_t
+ 
+__nmemb
+, size_
+__size
+)
+
+469 
+__THROW
+ 
+__ibu_mloc__
+ 
+__wur
+;
+
+470 
+__END_NAMESPACE_STD
+
+
+473 #ide
+__ed_mloc_d_oc
+
+
+474 
+__BEGIN_NAMESPACE_STD
+
+
+480 *
+	$loc
+ (*
+__r
+, 
+size_t
+ 
+__size
+)
+
+481 
+__THROW
+ 
+__ibu_wn_unud_su__
+;
+
+483 
+	$
+ (*
+__r
+
+__THROW
+;
+
+484 
+__END_NAMESPACE_STD
+
+
+486 #ifdef 
+__USE_MISC
+
+
+488 
+	$c
+ (*
+__r
+
+__THROW
+;
+
+491 #i
+defed
+ 
+__USE_GNU
+ || defed 
+__USE_BSD
+ || defed 
+__USE_MISC
+
+
+492 
+	~<lo.h
+>
+
+495 #i(
+defed
+ 
+__USE_XOPEN_EXTENDED
+ && !defed 
+__USE_XOPEN2K
+) \
+
+496 || 
+defed
+ 
+__USE_BSD
+
+
+498 *
+	$vloc
+ (
+size_t
+ 
+__size
+
+__THROW
+ 
+__ibu_mloc__
+ 
+__wur
+;
+
+501 #ifde
+__USE_XOPEN2K
+
+
+503 
+	$posix_memign
+ (**
+__memr
+, 
+size_t
+ 
+__ignmt
+, size_
+__size
+)
+
+504 
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+507 #ifde
+__USE_ISOC11
+
+
+509 *
+	$igd_loc
+ (
+size_t
+ 
+__ignmt
+, size_
+__size
+)
+
+510 
+__THROW
+ 
+__ibu_mloc__
+ 
+	`__ibu_loc_size__
+ ((2)
+__wur
+;
+
+513 
+__BEGIN_NAMESPACE_STD
+
+
+515 
+	$abt
+ (
+__THROW
+ 
+	`__ibu__
+ ((
+__nu__
+));
+
+519 
+	`ex
+ ((*
+__func
+()
+__THROW
+ 
+	`__nnu
+ ((1));
+
+521 #i
+defed
+ 
+__USE_ISOC11
+ || defed 
+__USE_ISOCXX11
+
+
+523 #ifde
+__lulus
+
+
+524 "C++" 
+	`_quick_ex
+ ((*
+__func
+) ())
+
+525 
+__THROW
+ 
+	`__asm
+ ("_quick_ex"
+	`__nnu
+ ((1));
+
+527 
+	`_quick_ex
+ ((*
+__func
+()
+__THROW
+ 
+	`__nnu
+ ((1));
+
+530 
+__END_NAMESPACE_STD
+
+
+532 #ifdef 
+__USE_MISC
+
+
+535 
+	`_ex
+ ((*
+__func
+(
+__us
+, *
+__g
+), *__arg)
+
+536 
+__THROW
+ 
+	`__nnu
+ ((1));
+
+539 
+__BEGIN_NAMESPACE_STD
+
+
+543 
+	$ex
+ (
+__us
+
+__THROW
+ 
+	`__ibu__
+ ((
+__nu__
+));
+
+545 #i
+defed
+ 
+__USE_ISOC11
+ || defed 
+__USE_ISOCXX11
+
+
+549 
+	$quick_ex
+ (
+__us
+
+__THROW
+ 
+	`__ibu__
+ ((
+__nu__
+));
+
+551 
+__END_NAMESPACE_STD
+
+
+553 #ifde
+__USE_ISOC99
+
+
+554 
+__BEGIN_NAMESPACE_C99
+
+
+557 
+	$_Ex
+ (
+__us
+
+__THROW
+ 
+	`__ibu__
+ ((
+__nu__
+));
+
+558 
+__END_NAMESPACE_C99
+
+
+562 
+__BEGIN_NAMESPACE_STD
+
+
+564 *
+	$gv
+ (c *
+__me
+
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+565 
+__END_NAMESPACE_STD
+
+
+567 #ifde
+__USE_GNU
+
+
+570 *
+	$cu_gv
+ (c *
+__me
+)
+
+571 
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+574 #i
+defed
+ 
+__USE_SVID
+ || defed 
+__USE_XOPEN
+
+
+578 
+	$punv
+ (*
+__rg
+
+__THROW
+ 
+	`__nnu
+ ((1));
+
+581 #i
+defed
+ 
+__USE_BSD
+ || defed 
+__USE_XOPEN2K
+
+
+584 
+	$nv
+ (c *
+__me
+, c *
+__vue
+, 
+__a
+)
+
+585 
+__THROW
+ 
+	`__nnu
+ ((2));
+
+588 
+	$unnv
+ (c *
+__me
+
+__THROW
+ 
+	`__nnu
+ ((1));
+
+591 #ifdef 
+__USE_MISC
+
+
+595 
+	$nv
+ (
+__THROW
+;
+
+599 #i
+defed
+ 
+__USE_MISC
+ \
+
+600 || (
+defed
+ 
+__USE_XOPEN_EXTENDED
+ && !defed 
+__USE_XOPEN2K8
+)
+
+606 *
+	$mkmp
+ (*
+__me
+
+__THROW
+ 
+	`__nnu
+ ((1));
+
+609 #i
+defed
+ 
+__USE_MISC
+ || defed 
+__USE_XOPEN_EXTENDED
+ \
+
+610 || 
+defed
+ 
+__USE_XOPEN2K8
+
+
+619 #ide
+__USE_FILE_OFFSET64
+
+
+620 
+	$mkemp
+ (*
+__me
+
+	`__nnu
+ ((1)
+__wur
+;
+
+622 #ifde
+__REDIRECT
+
+
+623 
+	`__REDIRECT
+ (
+mkemp
+, (*
+__me
+), 
+mkemp64
+)
+
+624 
+	`__nnu
+ ((1)
+__wur
+;
+
+626 
+	#mkemp
+ 
+mkemp64
+
+
+	)
+
+629 #ifde
+__USE_LARGEFILE64
+
+
+630 
+	$mkemp64
+ (*
+__me
+
+	`__nnu
+ ((1)
+__wur
+;
+
+634 #ifde
+__USE_MISC
+
+
+641 #ide
+__USE_FILE_OFFSET64
+
+
+642 
+	$mkemps
+ (*
+__me
+, 
+__suffixn
+
+	`__nnu
+ ((1)
+__wur
+;
+
+644 #ifde
+__REDIRECT
+
+
+645 
+	`__REDIRECT
+ (
+mkemps
+, (*
+__me
+, 
+__suffixn
+),
+
+646 
+mkemps64
+
+	`__nnu
+ ((1)
+__wur
+;
+
+648 
+	#mkemps
+ 
+mkemps64
+
+
+	)
+
+651 #ifde
+__USE_LARGEFILE64
+
+
+652 
+	$mkemps64
+ (*
+__me
+, 
+__suffixn
+)
+
+653 
+	`__nnu
+ ((1)
+__wur
+;
+
+657 #i
+defed
+ 
+__USE_BSD
+ || defed 
+__USE_XOPEN2K8
+
+
+663 *
+	$mkdmp
+ (*
+__me
+
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+666 #ifde
+__USE_GNU
+
+
+673 #ide
+__USE_FILE_OFFSET64
+
+
+674 
+	$mkoemp
+ (*
+__me
+, 
+__ags
+
+	`__nnu
+ ((1)
+__wur
+;
+
+676 #ifde
+__REDIRECT
+
+
+677 
+	`__REDIRECT
+ (
+mkoemp
+, (*
+__me
+, 
+__ags
+), 
+mkoemp64
+)
+
+678 
+	`__nnu
+ ((1)
+__wur
+;
+
+680 
+	#mkoemp
+ 
+mkoemp64
+
+
+	)
+
+683 #ifde
+__USE_LARGEFILE64
+
+
+684 
+	$mkoemp64
+ (*
+__me
+, 
+__ags
+
+	`__nnu
+ ((1)
+__wur
+;
+
+693 #ide
+__USE_FILE_OFFSET64
+
+
+694 
+	$mkoemps
+ (*
+__me
+, 
+__suffixn
+, 
+__ags
+)
+
+695 
+	`__nnu
+ ((1)
+__wur
+;
+
+697 #ifde
+__REDIRECT
+
+
+698 
+	`__REDIRECT
+ (
+mkoemps
+, (*
+__me
+, 
+__suffixn
+,
+
+699 
+__ags
+), 
+mkoemps64
+)
+
+700 
+	`__nnu
+ ((1)
+__wur
+;
+
+702 
+	#mkoemps
+ 
+mkoemps64
+
+
+	)
+
+705 #ifde
+__USE_LARGEFILE64
+
+
+706 
+	$mkoemps64
+ (*
+__me
+, 
+__suffixn
+, 
+__ags
+)
+
+707 
+	`__nnu
+ ((1)
+__wur
+;
+
+712 
+__BEGIN_NAMESPACE_STD
+
+
+717 
+	$syem
+ (c *
+__commd
+
+__wur
+;
+
+718 
+__END_NAMESPACE_STD
+
+
+721 #ifdef 
+__USE_GNU
+
+
+724 *
+	$nilize_fe_me
+ (c *
+__me
+)
+
+725 
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+728 #i
+defed
+ 
+__USE_BSD
+ || defed 
+__USE_XOPEN_EXTENDED
+
+
+734 *
+	$th
+ (c *
+__ri
+ 
+__me
+,
+
+735 *
+__ri
+ 
+__sved
+
+__THROW
+ 
+__wur
+;
+
+740 #ide
+__COMPAR_FN_T
+
+
+741 
+	#__COMPAR_FN_T
+
+
+	)
+
+742 (*
+	t__comr__t
+) (const *, const *);
+
+744 #ifdef 
+__USE_GNU
+
+
+745 
+__comr__t
+ 
+	tcomris__t
+;
+
+748 #ifde
+__USE_GNU
+
+
+749 (*
+	t__comr_d__t
+) (const *, const *, *);
+
+752 
+__BEGIN_NAMESPACE_STD
+
+
+755 *
+	$bch
+ (c *
+__key
+, c *
+__ba
+,
+
+756 
+size_t
+ 
+__nmemb
+, size_
+__size
+, 
+__comr__t
+ 
+__comr
+)
+
+757 
+	`__nnu
+ ((1, 2, 5)
+__wur
+;
+
+759 #ifde
+__USE_EXTERN_INLINES
+
+
+760 
+	~<bs/dlib-bch.h
+>
+
+765 
+	$qst
+ (*
+__ba
+, 
+size_t
+ 
+__nmemb
+, size_
+__size
+,
+
+766 
+__comr__t
+ 
+__comr
+
+	`__nnu
+ ((1, 4));
+
+767 #ifde
+__USE_GNU
+
+
+768 
+	$qst_r
+ (*
+__ba
+, 
+size_t
+ 
+__nmemb
+, size_
+__size
+,
+
+769 
+__comr_d__t
+ 
+__comr
+, *
+__g
+)
+
+770 
+	`__nnu
+ ((1, 4));
+
+775 
+	$abs
+ (
+__x
+
+__THROW
+ 
+	`__ibu__
+ ((
+__c__
+)
+__wur
+;
+
+776 
+	$bs
+ (
+__x
+
+__THROW
+ 
+	`__ibu__
+ ((
+__c__
+)
+__wur
+;
+
+777 
+__END_NAMESPACE_STD
+
+
+779 #ifde
+__USE_ISOC99
+
+
+780 
+__exnsi__
+ 
+	$abs
+ (
+__x
+)
+
+781 
+__THROW
+ 
+	`__ibu__
+ ((
+__c__
+)
+__wur
+;
+
+785 
+__BEGIN_NAMESPACE_STD
+
+
+789 
+div_t
+ 
+	$div
+ (
+__num
+, 
+__dom
+)
+
+790 
+__THROW
+ 
+	`__ibu__
+ ((
+__c__
+)
+__wur
+;
+
+791 
+ldiv_t
+ 
+	$ldiv
+ (
+__num
+, 
+__dom
+)
+
+792 
+__THROW
+ 
+	`__ibu__
+ ((
+__c__
+)
+__wur
+;
+
+793 
+__END_NAMESPACE_STD
+
+
+795 #ifde
+__USE_ISOC99
+
+
+796 
+__BEGIN_NAMESPACE_C99
+
+
+797 
+__exnsi__
+ 
+div_t
+ 
+	$div
+ (
+__num
+,
+
+798 
+__dom
+)
+
+799 
+__THROW
+ 
+	`__ibu__
+ ((
+__c__
+)
+__wur
+;
+
+800 
+__END_NAMESPACE_C99
+
+
+804 #i(
+defed
+ 
+__USE_XOPEN_EXTENDED
+ && !defed 
+__USE_XOPEN2K8
+) \
+
+805 || 
+defed
+ 
+__USE_SVID
+
+
+812 *
+	$ecvt
+ (
+__vue
+, 
+__ndig
+, *
+__ri
+ 
+__det
+,
+
+813 *
+__ri
+ 
+__sign
+
+__THROW
+ 
+	`__nnu
+ ((3, 4)
+__wur
+;
+
+818 *
+	$fcvt
+ (
+__vue
+, 
+__ndig
+, *
+__ri
+ 
+__det
+,
+
+819 *
+__ri
+ 
+__sign
+
+__THROW
+ 
+	`__nnu
+ ((3, 4)
+__wur
+;
+
+824 *
+	$gcvt
+ (
+__vue
+, 
+__ndig
+, *
+__buf
+)
+
+825 
+__THROW
+ 
+	`__nnu
+ ((3)
+__wur
+;
+
+828 #ifde
+__USE_MISC
+
+
+830 *
+	$qecvt
+ (
+__vue
+, 
+__ndig
+,
+
+831 *
+__ri
+ 
+__det
+, *__ri 
+__sign
+)
+
+832 
+__THROW
+ 
+	`__nnu
+ ((3, 4)
+__wur
+;
+
+833 *
+	$qfcvt
+ (
+__vue
+, 
+__ndig
+,
+
+834 *
+__ri
+ 
+__det
+, *__ri 
+__sign
+)
+
+835 
+__THROW
+ 
+	`__nnu
+ ((3, 4)
+__wur
+;
+
+836 *
+	$qgcvt
+ (
+__vue
+, 
+__ndig
+, *
+__buf
+)
+
+837 
+__THROW
+ 
+	`__nnu
+ ((3)
+__wur
+;
+
+842 
+	$ecvt_r
+ (
+__vue
+, 
+__ndig
+, *
+__ri
+ 
+__det
+,
+
+843 *
+__ri
+ 
+__sign
+, *__ri 
+__buf
+,
+
+844 
+size_t
+ 
+__n
+
+__THROW
+ 
+	`__nnu
+ ((3, 4, 5));
+
+845 
+	$fcvt_r
+ (
+__vue
+, 
+__ndig
+, *
+__ri
+ 
+__det
+,
+
+846 *
+__ri
+ 
+__sign
+, *__ri 
+__buf
+,
+
+847 
+size_t
+ 
+__n
+
+__THROW
+ 
+	`__nnu
+ ((3, 4, 5));
+
+849 
+	$qecvt_r
+ (
+__vue
+, 
+__ndig
+,
+
+850 *
+__ri
+ 
+__det
+, *__ri 
+__sign
+,
+
+851 *
+__ri
+ 
+__buf
+, 
+size_t
+ 
+__n
+)
+
+852 
+__THROW
+ 
+	`__nnu
+ ((3, 4, 5));
+
+853 
+	$qfcvt_r
+ (
+__vue
+, 
+__ndig
+,
+
+854 *
+__ri
+ 
+__det
+, *__ri 
+__sign
+,
+
+855 *
+__ri
+ 
+__buf
+, 
+size_t
+ 
+__n
+)
+
+856 
+__THROW
+ 
+	`__nnu
+ ((3, 4, 5));
+
+860 
+__BEGIN_NAMESPACE_STD
+
+
+863 
+	$mbn
+ (c *
+__s
+, 
+size_t
+ 
+__n
+
+__THROW
+;
+
+866 
+	$mbtowc
+ (
+wch_t
+ *
+__ri
+ 
+__pwc
+,
+
+867 c *
+__ri
+ 
+__s
+, 
+size_t
+ 
+__n
+
+__THROW
+;
+
+870 
+	$womb
+ (*
+__s
+, 
+wch_t
+ 
+__wch
+
+__THROW
+;
+
+874 
+size_t
+ 
+	$mbowcs
+ (
+wch_t
+ *
+__ri
+ 
+__pwcs
+,
+
+875 c *
+__ri
+ 
+__s
+, 
+size_t
+ 
+__n
+
+__THROW
+;
+
+877 
+size_t
+ 
+	$wcombs
+ (*
+__ri
+ 
+__s
+,
+
+878 c 
+wch_t
+ *
+__ri
+ 
+__pwcs
+, 
+size_t
+ 
+__n
+)
+
+879 
+__THROW
+;
+
+880 
+__END_NAMESPACE_STD
+
+
+883 #ifde
+__USE_SVID
+
+
+888 
+	$mch
+ (c *
+__
+
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+892 #i
+defed
+ 
+__USE_XOPEN_EXTENDED
+ || defed 
+__USE_XOPEN2K8
+
+
+899 
+	$gsubt
+ (**
+__ri
+ 
+__tip
+,
+
+900 *c *
+__ri
+ 
+__toks
+,
+
+901 **
+__ri
+ 
+__vu
+)
+
+902 
+__THROW
+ 
+	`__nnu
+ ((1, 2, 3)
+__wur
+;
+
+906 #ifde
+__USE_XOPEN
+
+
+908 
+	$tkey
+ (c *
+__key
+
+__THROW
+ 
+	`__nnu
+ ((1));
+
+914 #ifde
+__USE_XOPEN2KXSI
+
+
+916 
+	$posix_
+ (
+__oag
+
+__wur
+;
+
+919 #ifde
+__USE_XOPEN
+
+
+924 
+	$g
+ (
+__fd
+
+__THROW
+;
+
+928 
+	$uock
+ (
+__fd
+
+__THROW
+;
+
+933 *
+	$ame
+ (
+__fd
+
+__THROW
+ 
+__wur
+;
+
+936 #ifde
+__USE_GNU
+
+
+940 
+	$ame_r
+ (
+__fd
+, *
+__buf
+, 
+size_t
+ 
+__bu
+)
+
+941 
+__THROW
+ 
+	`__nnu
+ ((2));
+
+944 
+	`g
+ ();
+
+947 #ifde
+__USE_BSD
+
+
+951 
+	$gldavg
+ (
+__ldavg
+[], 
+__m
+)
+
+952 
+__THROW
+ 
+	`__nnu
+ ((1));
+
+955 
+	~<bs/dlib-t.h
+>
+
+958 #i
+__USE_FORTIFY_LEVEL
+ > 0 && 
+defed
+ 
+__ftify_funi
+
+
+959 
+	~<bs/dlib.h
+>
+
+961 #ifde
+__LDBL_COMPAT
+
+
+962 
+	~<bs/dlib-ldbl.h
+>
+
+966 #unde
+__ed_mloc_d_oc
+
+
+968 
+__END_DECLS
+
+
+	@/usr/include/string.h
+
+22 #idef 
+_STRING_H
+
+
+23 
+	#_STRING_H
+ 1
+
+	)
+
+25 
+	~<us.h
+>
+
+27 
+	g__BEGIN_DECLS
+
+
+30 
+	#__ed_size_t
+
+
+	)
+
+31 
+	#__ed_NULL
+
+
+	)
+
+32 
+	~<ddef.h
+>
+
+39 #i
+defed
+ 
+__lulus
+ && (__lulu>199711L || 
+__GNUC_PREREQ
+ (4, 4))
+
+40 
+	#__CORRECT_ISO_CPP_STRING_H_PROTO
+
+
+	)
+
+44 
+__BEGIN_NAMESPACE_STD
+
+
+46 *
+	$memy
+ (*
+__ri
+ 
+__de
+, c *__ri 
+__c
+,
+
+47 
+size_t
+ 
+__n
+
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+50 *
+	$memmove
+ (*
+__de
+, c *
+__c
+, 
+size_t
+ 
+__n
+)
+
+51 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+52 
+__END_NAMESPACE_STD
+
+
+57 #i
+defed
+ 
+__USE_SVID
+ || defed 
+__USE_BSD
+ || defed 
+__USE_XOPEN
+
+
+58 *
+	$memcy
+ (*
+__ri
+ 
+__de
+, c *__ri 
+__c
+,
+
+59 
+__c
+, 
+size_t
+ 
+__n
+)
+
+60 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+64 
+__BEGIN_NAMESPACE_STD
+
+
+66 *
+	$memt
+ (*
+__s
+, 
+__c
+, 
+size_t
+ 
+__n
+
+__THROW
+ 
+	`__nnu
+ ((1));
+
+69 
+	$memcmp
+ (c *
+__s1
+, c *
+__s2
+, 
+size_t
+ 
+__n
+)
+
+70 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2));
+
+73 #ifde
+__CORRECT_ISO_CPP_STRING_H_PROTO
+
+
+76 *
+	`memchr
+ (*
+__s
+, 
+__c
+, 
+size_t
+ 
+__n
+)
+
+77 
+__THROW
+ 
+	`__asm
+ ("memchr"
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+78 c *
+	`memchr
+ (c *
+__s
+, 
+__c
+, 
+size_t
+ 
+__n
+)
+
+79 
+__THROW
+ 
+	`__asm
+ ("memchr"
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+81 #ifde
+__OPTIMIZE__
+
+
+82 
+__ex_ways_le
+ *
+
+83 
+	`memchr
+ (*
+__s
+, 
+__c
+, 
+size_t
+ 
+__n
+
+__THROW
+
+
+85  
+	`__but_memchr
+ (
+__s
+, 
+__c
+, 
+__n
+);
+
+88 
+__ex_ways_le
+ const *
+
+89 
+	`memchr
+ (c *
+__s
+, 
+__c
+, 
+size_t
+ 
+__n
+
+__THROW
+
+
+91  
+	`__but_memchr
+ (
+__s
+, 
+__c
+, 
+__n
+);
+
+94 
+	}
+}
+
+96 *
+	$memchr
+ (c *
+__s
+, 
+__c
+, 
+size_t
+ 
+__n
+)
+
+97 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+99 
+__END_NAMESPACE_STD
+
+
+101 #ifde
+__USE_GNU
+
+
+104 #ifde
+__CORRECT_ISO_CPP_STRING_H_PROTO
+
+
+105 "C++" *
+	$wmemchr
+ (*
+__s
+, 
+__c
+)
+
+106 
+__THROW
+ 
+	`__asm
+ ("wmemchr"
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+107 "C++" c *
+	$wmemchr
+ (c *
+__s
+, 
+__c
+)
+
+108 
+__THROW
+ 
+	`__asm
+ ("wmemchr"
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+110 *
+	$wmemchr
+ (c *
+__s
+, 
+__c
+)
+
+111 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+115 #ifde
+__CORRECT_ISO_CPP_STRING_H_PROTO
+
+
+116 "C++" *
+	$memrchr
+ (*
+__s
+, 
+__c
+, 
+size_t
+ 
+__n
+)
+
+117 
+__THROW
+ 
+	`__asm
+ ("memrchr"
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+118 "C++" c *
+	$memrchr
+ (c *
+__s
+, 
+__c
+, 
+size_t
+ 
+__n
+)
+
+119 
+__THROW
+ 
+	`__asm
+ ("memrchr"
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+121 *
+	$memrchr
+ (c *
+__s
+, 
+__c
+, 
+size_t
+ 
+__n
+)
+
+122 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+127 
+__BEGIN_NAMESPACE_STD
+
+
+129 *
+	$ry
+ (*
+__ri
+ 
+__de
+, c *__ri 
+__c
+)
+
+130 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+132 *
+	$y
+ (*
+__ri
+ 
+__de
+,
+
+133 c *
+__ri
+ 
+__c
+, 
+size_t
+ 
+__n
+)
+
+134 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+137 *
+	$rt
+ (*
+__ri
+ 
+__de
+, c *__ri 
+__c
+)
+
+138 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+140 *
+	$t
+ (*
+__ri
+ 
+__de
+, c *__ri 
+__c
+,
+
+141 
+size_t
+ 
+__n
+
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+144 
+	$rcmp
+ (c *
+__s1
+, c *
+__s2
+)
+
+145 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2));
+
+147 
+	$cmp
+ (c *
+__s1
+, c *
+__s2
+, 
+size_t
+ 
+__n
+)
+
+148 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2));
+
+151 
+	$rcl
+ (c *
+__s1
+, c *
+__s2
+)
+
+152 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2));
+
+154 
+size_t
+ 
+	$rxm
+ (*
+__ri
+ 
+__de
+,
+
+155 c *
+__ri
+ 
+__c
+, 
+size_t
+ 
+__n
+)
+
+156 
+__THROW
+ 
+	`__nnu
+ ((2));
+
+157 
+__END_NAMESPACE_STD
+
+
+159 #ifde
+__USE_XOPEN2K8
+
+
+163 
+	~<xlo.h
+>
+
+166 
+	$rcl_l
+ (c *
+__s1
+, c *
+__s2
+, 
+__lo_t
+ 
+__l
+)
+
+167 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2, 3));
+
+169 
+size_t
+ 
+	$rxm_l
+ (*
+__de
+, c *
+__c
+, 
+size_t
+ 
+__n
+,
+
+170 
+__lo_t
+ 
+__l
+
+__THROW
+ 
+	`__nnu
+ ((2, 4));
+
+173 #i
+defed
+ 
+__USE_SVID
+ || defed 
+__USE_BSD
+ || defed 
+__USE_XOPEN_EXTENDED
+ \
+
+174 || 
+defed
+ 
+__USE_XOPEN2K8
+
+
+176 *
+	$rdup
+ (c *
+__s
+)
+
+177 
+__THROW
+ 
+__ibu_mloc__
+ 
+	`__nnu
+ ((1));
+
+183 #i
+defed
+ 
+__USE_XOPEN2K8
+
+
+184 *
+	$dup
+ (c *
+__rg
+, 
+size_t
+ 
+__n
+)
+
+185 
+__THROW
+ 
+__ibu_mloc__
+ 
+	`__nnu
+ ((1));
+
+188 #i
+defed
+ 
+__USE_GNU
+ && defed 
+__GNUC__
+
+
+190 
+	#rdu
+(
+s
+) \
+
+191 (
+__exnsi__
+ \
+
+193 c *
+__d
+ = (
+s
+); \
+
+194 
+size_t
+ 
+__n
+ = 
+	`
+ (
+__d
+) + 1; \
+
+195 *
+__w
+ = (*
+	`__but_lo
+ (
+__n
+); \
+
+196 (*
+	`memy
+ (
+__w
+, 
+__d
+, 
+__n
+); \
+
+197 
+	}
+}))
+
+	)
+
+200 
+	#du
+(
+s
+, 
+n
+) \
+
+201 (
+__exnsi__
+ \
+
+203 c *
+__d
+ = (
+s
+); \
+
+204 
+size_t
+ 
+__n
+ = 
+	`n
+ (
+__d
+, (
+n
+)); \
+
+205 *
+__w
+ = (*
+	`__but_lo
+ (
+__n
+ + 1); \
+
+206 
+__w
+[
+__n
+] = '\0'; \
+
+207 (*
+	`memy
+ (
+__w
+, 
+__d
+, 
+__n
+); \
+
+208 }))
+
+	)
+
+211 
+	g__BEGIN_NAMESPACE_STD
+
+
+213 #ifde
+__CORRECT_ISO_CPP_STRING_H_PROTO
+
+
+216 *
+rchr
+ (*
+__s
+, 
+__c
+)
+
+217 
+__THROW
+ 
+__asm
+ ("rchr"
+__ibu_pu__
+ 
+__nnu
+ ((1));
+
+218 c *
+rchr
+ (c *
+__s
+, 
+__c
+)
+
+219 
+__THROW
+ 
+__asm
+ ("rchr"
+__ibu_pu__
+ 
+__nnu
+ ((1));
+
+221 #ifde
+__OPTIMIZE__
+
+
+222 
+__ex_ways_le
+ *
+
+223 
+rchr
+ (*
+__s
+, 
+__c
+
+	g__THROW
+
+
+225  
+__but_rchr
+ (
+__s
+, 
+__c
+);
+
+228 
+__ex_ways_le
+ const *
+
+229 
+rchr
+ (c *
+__s
+, 
+__c
+
+	g__THROW
+
+
+231  
+__but_rchr
+ (
+__s
+, 
+__c
+);
+
+236 *
+	$rchr
+ (c *
+__s
+, 
+__c
+)
+
+237 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+240 #ifde
+__CORRECT_ISO_CPP_STRING_H_PROTO
+
+
+243 *
+	`chr
+ (*
+__s
+, 
+__c
+)
+
+244 
+__THROW
+ 
+	`__asm
+ ("chr"
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+245 c *
+	`chr
+ (c *
+__s
+, 
+__c
+)
+
+246 
+__THROW
+ 
+	`__asm
+ ("chr"
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+248 #ifde
+__OPTIMIZE__
+
+
+249 
+__ex_ways_le
+ *
+
+250 
+	`chr
+ (*
+__s
+, 
+__c
+
+__THROW
+
+
+252  
+	`__but_chr
+ (
+__s
+, 
+__c
+);
+
+255 
+__ex_ways_le
+ const *
+
+256 
+	`chr
+ (c *
+__s
+, 
+__c
+
+__THROW
+
+
+258  
+	`__but_chr
+ (
+__s
+, 
+__c
+);
+
+261 
+	}
+}
+
+263 *
+	$chr
+ (c *
+__s
+, 
+__c
+)
+
+264 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+266 
+__END_NAMESPACE_STD
+
+
+268 #ifde
+__USE_GNU
+
+
+271 #ifde
+__CORRECT_ISO_CPP_STRING_H_PROTO
+
+
+272 "C++" *
+	$rchul
+ (*
+__s
+, 
+__c
+)
+
+273 
+__THROW
+ 
+	`__asm
+ ("rchul"
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+274 "C++" c *
+	$rchul
+ (c *
+__s
+, 
+__c
+)
+
+275 
+__THROW
+ 
+	`__asm
+ ("rchul"
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+277 *
+	$rchul
+ (c *
+__s
+, 
+__c
+)
+
+278 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+282 
+__BEGIN_NAMESPACE_STD
+
+
+285 
+size_t
+ 
+	$rcn
+ (c *
+__s
+, c *
+__je
+)
+
+286 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2));
+
+289 
+size_t
+ 
+	$rn
+ (c *
+__s
+, c *
+__ac
+)
+
+290 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2));
+
+292 #ifde
+__CORRECT_ISO_CPP_STRING_H_PROTO
+
+
+295 *
+	`brk
+ (*
+__s
+, c *
+__ac
+)
+
+296 
+__THROW
+ 
+	`__asm
+ ("brk"
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2));
+
+297 c *
+	`brk
+ (c *
+__s
+, c *
+__ac
+)
+
+298 
+__THROW
+ 
+	`__asm
+ ("brk"
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2));
+
+300 #ifde
+__OPTIMIZE__
+
+
+301 
+__ex_ways_le
+ *
+
+302 
+	`brk
+ (*
+__s
+, c *
+__ac
+
+__THROW
+
+
+304  
+	`__but_brk
+ (
+__s
+, 
+__ac
+);
+
+307 
+__ex_ways_le
+ const *
+
+308 
+	`brk
+ (c *
+__s
+, c *
+__ac
+
+__THROW
+
+
+310  
+	`__but_brk
+ (
+__s
+, 
+__ac
+);
+
+313 
+	}
+}
+
+315 *
+	$brk
+ (c *
+__s
+, c *
+__ac
+)
+
+316 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2));
+
+319 #ifde
+__CORRECT_ISO_CPP_STRING_H_PROTO
+
+
+322 *
+	`rr
+ (*
+__hayack
+, c *
+__ed
+)
+
+323 
+__THROW
+ 
+	`__asm
+ ("rr"
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2));
+
+324 c *
+	`rr
+ (c *
+__hayack
+, c *
+__ed
+)
+
+325 
+__THROW
+ 
+	`__asm
+ ("rr"
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2));
+
+327 #ifde
+__OPTIMIZE__
+
+
+328 
+__ex_ways_le
+ *
+
+329 
+	`rr
+ (*
+__hayack
+, c *
+__ed
+
+__THROW
+
+
+331  
+	`__but_rr
+ (
+__hayack
+, 
+__ed
+);
+
+334 
+__ex_ways_le
+ const *
+
+335 
+	`rr
+ (c *
+__hayack
+, c *
+__ed
+
+__THROW
+
+
+337  
+	`__but_rr
+ (
+__hayack
+, 
+__ed
+);
+
+340 
+	}
+}
+
+342 *
+	$rr
+ (c *
+__hayack
+, c *
+__ed
+)
+
+343 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2));
+
+348 *
+	$ok
+ (*
+__ri
+ 
+__s
+, c *__ri 
+__dim
+)
+
+349 
+__THROW
+ 
+	`__nnu
+ ((2));
+
+350 
+__END_NAMESPACE_STD
+
+
+354 *
+	$__ok_r
+ (*
+__ri
+ 
+__s
+,
+
+355 c *
+__ri
+ 
+__dim
+,
+
+356 **
+__ri
+ 
+__ve_r
+)
+
+357 
+__THROW
+ 
+	`__nnu
+ ((2, 3));
+
+358 #i
+defed
+ 
+__USE_POSIX
+ || defed 
+__USE_MISC
+
+
+359 *
+	$ok_r
+ (*
+__ri
+ 
+__s
+, c *__ri 
+__dim
+,
+
+360 **
+__ri
+ 
+__ve_r
+)
+
+361 
+__THROW
+ 
+	`__nnu
+ ((2, 3));
+
+364 #ifde
+__USE_GNU
+
+
+366 #ifde
+__CORRECT_ISO_CPP_STRING_H_PROTO
+
+
+367 "C++" *
+	$rr
+ (*
+__hayack
+, c *
+__ed
+)
+
+368 
+__THROW
+ 
+	`__asm
+ ("rr"
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2));
+
+369 "C++" c *
+	$rr
+ (c *
+__hayack
+,
+
+370 c *
+__ed
+)
+
+371 
+__THROW
+ 
+	`__asm
+ ("rr"
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2));
+
+373 *
+	$rr
+ (c *
+__hayack
+, c *
+__ed
+)
+
+374 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2));
+
+378 #ifde
+__USE_GNU
+
+
+382 *
+	$memmem
+ (c *
+__hayack
+, 
+size_t
+ 
+__hayackn
+,
+
+383 c *
+__ed
+, 
+size_t
+ 
+__edn
+)
+
+384 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 3));
+
+388 *
+	$__mempy
+ (*
+__ri
+ 
+__de
+,
+
+389 c *
+__ri
+ 
+__c
+, 
+size_t
+ 
+__n
+)
+
+390 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+391 *
+	$mempy
+ (*
+__ri
+ 
+__de
+,
+
+392 c *
+__ri
+ 
+__c
+, 
+size_t
+ 
+__n
+)
+
+393 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+397 
+__BEGIN_NAMESPACE_STD
+
+
+399 
+size_t
+ 
+	$
+ (c *
+__s
+)
+
+400 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+401 
+__END_NAMESPACE_STD
+
+
+403 #ifdef 
+__USE_XOPEN2K8
+
+
+406 
+size_t
+ 
+	$n
+ (c *
+__rg
+, 
+size_t
+ 
+__maxn
+)
+
+407 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+411 
+__BEGIN_NAMESPACE_STD
+
+
+413 *
+	$
+ (
+__um
+
+__THROW
+;
+
+414 
+__END_NAMESPACE_STD
+
+
+415 #i
+defed
+ 
+__USE_XOPEN2K
+ || defed 
+__USE_MISC
+
+
+423 #i
+defed
+ 
+__USE_XOPEN2K
+ && !defed 
+__USE_GNU
+
+
+426 #ifde
+__REDIRECT_NTH
+
+
+427 
+	`__REDIRECT_NTH
+ (
+_r
+,
+
+428 (
+__um
+, *
+__buf
+, 
+size_t
+ 
+__bu
+),
+
+429 
+__xpg__r
+
+	`__nnu
+ ((2));
+
+431 
+	$__xpg__r
+ (
+__um
+, *
+__buf
+, 
+size_t
+ 
+__bu
+)
+
+432 
+__THROW
+ 
+	`__nnu
+ ((2));
+
+433 
+	#_r
+ 
+__xpg__r
+
+
+	)
+
+438 *
+	$_r
+ (
+__um
+, *
+__buf
+, 
+size_t
+ 
+__bu
+)
+
+439 
+__THROW
+ 
+	`__nnu
+ ((2)
+__wur
+;
+
+443 #ifde
+__USE_XOPEN2K8
+
+
+445 *
+	$_l
+ (
+__um
+, 
+__lo_t
+ 
+__l
+
+__THROW
+;
+
+451 
+	$__bzo
+ (*
+__s
+, 
+size_t
+ 
+__n
+
+__THROW
+ 
+	`__nnu
+ ((1));
+
+453 #ifde
+__USE_BSD
+
+
+455 
+	$bcy
+ (c *
+__c
+, *
+__de
+, 
+size_t
+ 
+__n
+)
+
+456 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+459 
+	$bzo
+ (*
+__s
+, 
+size_t
+ 
+__n
+
+__THROW
+ 
+	`__nnu
+ ((1));
+
+462 
+	$bcmp
+ (c *
+__s1
+, c *
+__s2
+, 
+size_t
+ 
+__n
+)
+
+463 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2));
+
+466 #ifde
+__CORRECT_ISO_CPP_STRING_H_PROTO
+
+
+469 *
+	`dex
+ (*
+__s
+, 
+__c
+)
+
+470 
+__THROW
+ 
+	`__asm
+ ("dex"
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+471 c *
+	`dex
+ (c *
+__s
+, 
+__c
+)
+
+472 
+__THROW
+ 
+	`__asm
+ ("dex"
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+474 #i
+defed
+ 
+__OPTIMIZE__
+ && !defed 
+__CORRECT_ISO_CPP_STRINGS_H_PROTO
+
+
+475 
+__ex_ways_le
+ *
+
+476 
+	`dex
+ (*
+__s
+, 
+__c
+
+__THROW
+
+
+478  
+	`__but_dex
+ (
+__s
+, 
+__c
+);
+
+481 
+__ex_ways_le
+ const *
+
+482 
+	`dex
+ (c *
+__s
+, 
+__c
+
+__THROW
+
+
+484  
+	`__but_dex
+ (
+__s
+, 
+__c
+);
+
+487 
+	}
+}
+
+489 *
+	$dex
+ (c *
+__s
+, 
+__c
+)
+
+490 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+494 #ifde
+__CORRECT_ISO_CPP_STRING_H_PROTO
+
+
+497 *
+	`rdex
+ (*
+__s
+, 
+__c
+)
+
+498 
+__THROW
+ 
+	`__asm
+ ("rdex"
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+499 c *
+	`rdex
+ (c *
+__s
+, 
+__c
+)
+
+500 
+__THROW
+ 
+	`__asm
+ ("rdex"
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+502 #i
+defed
+ 
+__OPTIMIZE__
+ && !defed 
+__CORRECT_ISO_CPP_STRINGS_H_PROTO
+
+
+503 
+__ex_ways_le
+ *
+
+504 
+	`rdex
+ (*
+__s
+, 
+__c
+
+__THROW
+
+
+506  
+	`__but_rdex
+ (
+__s
+, 
+__c
+);
+
+509 
+__ex_ways_le
+ const *
+
+510 
+	`rdex
+ (c *
+__s
+, 
+__c
+
+__THROW
+
+
+512  
+	`__but_rdex
+ (
+__s
+, 
+__c
+);
+
+515 
+	}
+}
+
+517 *
+	$rdex
+ (c *
+__s
+, 
+__c
+)
+
+518 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1));
+
+523 
+	$ffs
+ (
+__i
+
+__THROW
+ 
+	`__ibu__
+ ((
+__c__
+));
+
+527 #ifdef 
+__USE_GNU
+
+
+528 
+	$ff
+ (
+__l
+
+__THROW
+ 
+	`__ibu__
+ ((
+__c__
+));
+
+529 
+__exnsi__
+ 
+	$ffl
+ (
+__
+)
+
+530 
+__THROW
+ 
+	`__ibu__
+ ((
+__c__
+));
+
+534 
+	$rcmp
+ (c *
+__s1
+, c *
+__s2
+)
+
+535 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2));
+
+538 
+	$cmp
+ (c *
+__s1
+, c *
+__s2
+, 
+size_t
+ 
+__n
+)
+
+539 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2));
+
+542 #ifdef 
+__USE_GNU
+
+
+545 
+	$rcmp_l
+ (c *
+__s1
+, c *
+__s2
+,
+
+546 
+__lo_t
+ 
+__loc
+)
+
+547 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2, 3));
+
+549 
+	$cmp_l
+ (c *
+__s1
+, c *
+__s2
+,
+
+550 
+size_t
+ 
+__n
+, 
+__lo_t
+ 
+__loc
+)
+
+551 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2, 4));
+
+554 #ifdef 
+__USE_BSD
+
+
+557 *
+	$rp
+ (**
+__ri
+ 
+__rgp
+,
+
+558 c *
+__ri
+ 
+__dim
+)
+
+559 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+562 #ifdef 
+__USE_XOPEN2K8
+
+
+564 *
+	$rsigl
+ (
+__sig
+
+__THROW
+;
+
+567 *
+	$__py
+ (*
+__ri
+ 
+__de
+, c *__ri 
+__c
+)
+
+568 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+569 *
+	$py
+ (*
+__ri
+ 
+__de
+, c *__ri 
+__c
+)
+
+570 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+574 *
+	$__y
+ (*
+__ri
+ 
+__de
+,
+
+575 c *
+__ri
+ 
+__c
+, 
+size_t
+ 
+__n
+)
+
+576 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+577 *
+	$y
+ (*
+__ri
+ 
+__de
+,
+
+578 c *
+__ri
+ 
+__c
+, 
+size_t
+ 
+__n
+)
+
+579 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+582 #ifdef 
+__USE_GNU
+
+
+584 
+	$rvscmp
+ (c *
+__s1
+, c *
+__s2
+)
+
+585 
+__THROW
+ 
+__ibu_pu__
+ 
+	`__nnu
+ ((1, 2));
+
+588 *
+	$ry
+ (*
+__rg
+
+__THROW
+ 
+	`__nnu
+ ((1));
+
+591 *
+	$memob
+ (*
+__s
+, 
+size_t
+ 
+__n
+
+__THROW
+ 
+	`__nnu
+ ((1));
+
+593 #ide
+bame
+
+
+598 #ifde
+__CORRECT_ISO_CPP_STRING_H_PROTO
+
+
+599 "C++" *
+	$bame
+ (*
+__fame
+)
+
+600 
+__THROW
+ 
+	`__asm
+ ("bame"
+	`__nnu
+ ((1));
+
+601 "C++" c *
+	$bame
+ (c *
+__fame
+)
+
+602 
+__THROW
+ 
+	`__asm
+ ("bame"
+	`__nnu
+ ((1));
+
+604 *
+	$bame
+ (c *
+__fame
+
+__THROW
+ 
+	`__nnu
+ ((1));
+
+610 #i
+defed
+ 
+__GNUC__
+ && __GNUC__ >= 2
+
+611 #i
+defed
+ 
+__OPTIMIZE__
+ && !defed 
+__OPTIMIZE_SIZE__
+ \
+
+612 && !
+defed
+ 
+__NO_INLINE__
+ && !defed 
+__lulus
+
+
+632 
+	~<bs/rg.h
+>
+
+635 
+	~<bs/rg2.h
+>
+
+638 #i
+__USE_FORTIFY_LEVEL
+ > 0 && 
+defed
+ 
+__ftify_funi
+
+
+640 
+	~<bs/rg3.h
+>
+
+644 
+__END_DECLS
+
+
+	@/usr/include/unistd.h
+
+22 #idef 
+_UNISTD_H
+
+
+23 
+	#_UNISTD_H
+ 1
+
+	)
+
+25 
+	~<us.h
+>
+
+27 
+	g__BEGIN_DECLS
+
+
+32 #ifde
+__USE_XOPEN2K8
+
+
+34 
+	#_POSIX_VERSION
+ 200809L
+
+	)
+
+35 #i
+defed
+ 
+__USE_XOPEN2K
+
+
+37 
+	#_POSIX_VERSION
+ 200112L
+
+	)
+
+38 #i
+defed
+ 
+__USE_POSIX199506
+
+
+40 
+	#_POSIX_VERSION
+ 199506L
+
+	)
+
+41 #i
+defed
+ 
+__USE_POSIX199309
+
+
+43 
+	#_POSIX_VERSION
+ 199309L
+
+	)
+
+46 
+	#_POSIX_VERSION
+ 199009L
+
+	)
+
+52 #ifde
+__USE_XOPEN2K8
+
+
+53 
+	#__POSIX2_THIS_VERSION
+ 200809L
+
+	)
+
+55 #i
+defed
+ 
+__USE_XOPEN2K
+
+
+57 
+	#__POSIX2_THIS_VERSION
+ 200112L
+
+	)
+
+58 #i
+defed
+ 
+__USE_POSIX199506
+
+
+60 
+	#__POSIX2_THIS_VERSION
+ 199506L
+
+	)
+
+63 
+	#__POSIX2_THIS_VERSION
+ 199209L
+
+	)
+
+67 
+	#_POSIX2_VERSION
+ 
+__POSIX2_THIS_VERSION
+
+
+	)
+
+71 
+	#_POSIX2_C_BIND
+ 
+__POSIX2_THIS_VERSION
+
+
+	)
+
+75 
+	#_POSIX2_C_DEV
+ 
+__POSIX2_THIS_VERSION
+
+
+	)
+
+79 
+	#_POSIX2_SW_DEV
+ 
+__POSIX2_THIS_VERSION
+
+
+	)
+
+83 
+	#_POSIX2_LOCALEDEF
+ 
+__POSIX2_THIS_VERSION
+
+
+	)
+
+86 #ifde
+__USE_XOPEN2K8
+
+
+87 
+	#_XOPEN_VERSION
+ 700
+
+	)
+
+88 #i
+defed
+ 
+__USE_XOPEN2K
+
+
+89 
+	#_XOPEN_VERSION
+ 600
+
+	)
+
+90 #i
+defed
+ 
+__USE_UNIX98
+
+
+91 
+	#_XOPEN_VERSION
+ 500
+
+	)
+
+93 
+	#_XOPEN_VERSION
+ 4
+
+	)
+
+97 
+	#_XOPEN_XCU_VERSION
+ 4
+
+	)
+
+100 
+	#_XOPEN_XPG2
+ 1
+
+	)
+
+101 
+	#_XOPEN_XPG3
+ 1
+
+	)
+
+102 
+	#_XOPEN_XPG4
+ 1
+
+	)
+
+105 
+	#_XOPEN_UNIX
+ 1
+
+	)
+
+108 
+	#_XOPEN_CRYPT
+ 1
+
+	)
+
+112 
+	#_XOPEN_ENH_I18N
+ 1
+
+	)
+
+115 
+	#_XOPEN_LEGACY
+ 1
+
+	)
+
+202 
+	~<bs/posix_t.h
+>
+
+205 #i
+defed
+ 
+__USE_UNIX98
+ || defed 
+__USE_XOPEN2K
+
+
+206 
+	~<bs/vmts.h
+>
+
+210 
+	#STDIN_FILENO
+ 0
+
+	)
+
+211 
+	#STDOUT_FILENO
+ 1
+
+	)
+
+212 
+	#STDERR_FILENO
+ 2
+
+	)
+
+217 
+	~<bs/tys.h
+>
+
+219 #idef 
+__ssize_t_defed
+
+
+220 
+__ssize_t
+ 
+	tssize_t
+;
+
+221 
+	#__ssize_t_defed
+
+
+	)
+
+224 
+	#__ed_size_t
+
+
+	)
+
+225 
+	#__ed_NULL
+
+
+	)
+
+226 
+	~<ddef.h
+>
+
+228 #i
+defed
+ 
+__USE_XOPEN
+ || defed 
+__USE_XOPEN2K
+
+
+231 #ide
+__gid_t_defed
+
+
+232 
+__gid_t
+ 
+	tgid_t
+;
+
+233 
+	#__gid_t_defed
+
+
+	)
+
+236 #ide
+__uid_t_defed
+
+
+237 
+__uid_t
+ 
+	tuid_t
+;
+
+238 
+	#__uid_t_defed
+
+
+	)
+
+241 #ide
+__off_t_defed
+
+
+242 #ide
+__USE_FILE_OFFSET64
+
+
+243 
+__off_t
+ 
+	toff_t
+;
+
+245 
+__off64_t
+ 
+	toff_t
+;
+
+247 
+	#__off_t_defed
+
+
+	)
+
+249 #i
+defed
+ 
+__USE_LARGEFILE64
+ && !defed 
+__off64_t_defed
+
+
+250 
+__off64_t
+ 
+	toff64_t
+;
+
+251 
+	#__off64_t_defed
+
+
+	)
+
+254 #ide
+__ucds_t_defed
+
+
+255 
+__ucds_t
+ 
+	tucds_t
+;
+
+256 
+	#__ucds_t_defed
+
+
+	)
+
+259 #ide
+__pid_t_defed
+
+
+260 
+__pid_t
+ 
+	tpid_t
+;
+
+261 
+	#__pid_t_defed
+
+
+	)
+
+265 #i
+defed
+ 
+__USE_MISC
+ || defed 
+__USE_XOPEN_EXTENDED
+ || defed 
+__USE_XOPEN2K
+
+
+266 #ide
+___t_defed
+
+
+267 
+___t
+ 
+	t_t
+;
+
+268 
+	#___t_defed
+
+
+	)
+
+272 #i
+defed
+ 
+__USE_BSD
+ || defed 
+__USE_XOPEN
+
+
+273 #ide
+__sockn_t_defed
+
+
+274 
+__sockn_t
+ 
+	tsockn_t
+;
+
+275 
+	#__sockn_t_defed
+
+
+	)
+
+281 
+	#R_OK
+ 4
+
+	)
+
+282 
+	#W_OK
+ 2
+
+	)
+
+283 
+	#X_OK
+ 1
+
+	)
+
+284 
+	#F_OK
+ 0
+
+	)
+
+287 
+	$acss
+ (c *
+__me
+, 
+__ty
+
+__THROW
+ 
+	`__nnu
+ ((1));
+
+289 #ifde
+__USE_GNU
+
+
+292 
+	$euidacss
+ (c *
+__me
+, 
+__ty
+)
+
+293 
+__THROW
+ 
+	`__nnu
+ ((1));
+
+296 
+	$css
+ (c *
+__me
+, 
+__ty
+)
+
+297 
+__THROW
+ 
+	`__nnu
+ ((1));
+
+300 #ifde
+__USE_ATFILE
+
+
+304 
+	$cst
+ (
+__fd
+, c *
+__fe
+, 
+__ty
+, 
+__ag
+)
+
+305 
+__THROW
+ 
+	`__nnu
+ ((2)
+__wur
+;
+
+310 #idef 
+_STDIO_H
+
+
+311 
+	#SEEK_SET
+ 0
+
+	)
+
+312 
+	#SEEK_CUR
+ 1
+
+	)
+
+313 
+	#SEEK_END
+ 2
+
+	)
+
+314 #ifde
+__USE_GNU
+
+
+315 
+	#SEEK_DATA
+ 3
+
+	)
+
+316 
+	#SEEK_HOLE
+ 4
+
+	)
+
+320 #i
+defed
+ 
+__USE_BSD
+ && !defed 
+L_SET
+
+
+322 
+	#L_SET
+ 
+SEEK_SET
+
+
+	)
+
+323 
+	#L_INCR
+ 
+SEEK_CUR
+
+
+	)
+
+324 
+	#L_XTND
+ 
+SEEK_END
+
+
+	)
+
+333 #ide
+__USE_FILE_OFFSET64
+
+
+334 
+__off_t
+ 
+	$lek
+ (
+__fd
+, 
+__off_t
+ 
+__offt
+, 
+__wh
+
+__THROW
+;
+
+336 #ifde
+__REDIRECT_NTH
+
+
+337 
+__off64_t
+ 
+	`__REDIRECT_NTH
+ (
+lek
+,
+
+338 (
+__fd
+, 
+__off64_t
+ 
+__offt
+, 
+__wh
+),
+
+339 
+lek64
+);
+
+341 
+	#lek
+ 
+lek64
+
+
+	)
+
+344 #ifde
+__USE_LARGEFILE64
+
+
+345 
+__off64_t
+ 
+	$lek64
+ (
+__fd
+, 
+__off64_t
+ 
+__offt
+, 
+__wh
+)
+
+346 
+__THROW
+;
+
+353 
+	`o
+ (
+__fd
+);
+
+360 
+ssize_t
+ 
+	$ad
+ (
+__fd
+, *
+__buf
+, 
+size_t
+ 
+__nbys
+
+__wur
+;
+
+366 
+ssize_t
+ 
+	$wre
+ (
+__fd
+, c *
+__buf
+, 
+size_t
+ 
+__n
+
+__wur
+;
+
+368 #i
+defed
+ 
+__USE_UNIX98
+ || defed 
+__USE_XOPEN2K8
+
+
+369 #ide
+__USE_FILE_OFFSET64
+
+
+376 
+ssize_t
+ 
+	$d
+ (
+__fd
+, *
+__buf
+, 
+size_t
+ 
+__nbys
+,
+
+377 
+__off_t
+ 
+__offt
+
+__wur
+;
+
+384 
+ssize_t
+ 
+	$pwre
+ (
+__fd
+, c *
+__buf
+, 
+size_t
+ 
+__n
+,
+
+385 
+__off_t
+ 
+__offt
+
+__wur
+;
+
+387 #ifde
+__REDIRECT
+
+
+388 
+ssize_t
+ 
+	`__REDIRECT
+ (
+d
+, (
+__fd
+, *
+__buf
+, 
+size_t
+ 
+__nbys
+,
+
+389 
+__off64_t
+ 
+__offt
+),
+
+390 
+d64
+
+__wur
+;
+
+391 
+ssize_t
+ 
+	`__REDIRECT
+ (
+pwre
+, (
+__fd
+, c *
+__buf
+,
+
+392 
+size_t
+ 
+__nbys
+, 
+__off64_t
+ 
+__offt
+),
+
+393 
+pwre64
+
+__wur
+;
+
+395 
+	#d
+ 
+d64
+
+
+	)
+
+396 
+	#pwre
+ 
+pwre64
+
+
+	)
+
+400 #ifde
+__USE_LARGEFILE64
+
+
+404 
+ssize_t
+ 
+	$d64
+ (
+__fd
+, *
+__buf
+, 
+size_t
+ 
+__nbys
+,
+
+405 
+__off64_t
+ 
+__offt
+
+__wur
+;
+
+408 
+ssize_t
+ 
+	$pwre64
+ (
+__fd
+, c *
+__buf
+, 
+size_t
+ 
+__n
+,
+
+409 
+__off64_t
+ 
+__offt
+
+__wur
+;
+
+417 
+	$pe
+ (
+__pedes
+[2]
+__THROW
+ 
+__wur
+;
+
+419 #ifde
+__USE_GNU
+
+
+422 
+	$pe2
+ (
+__pedes
+[2], 
+__ags
+
+__THROW
+ 
+__wur
+;
+
+432 
+	$m
+ (
+__cds
+
+__THROW
+;
+
+444 
+	`p
+ (
+__cds
+);
+
+446 #i(
+defed
+ 
+__USE_XOPEN_EXTENDED
+ && !defed 
+__USE_XOPEN2K8
+) \
+
+447 || 
+defed
+ 
+__USE_BSD
+
+
+452 
+__ucds_t
+ 
+	$um
+ (
+__ucds_t
+ 
+__vue
+, __ucds_
+__rv
+)
+
+453 
+__THROW
+;
+
+460 
+	`up
+ (
+__ucds_t
+ 
+__ucds
+);
+
+469 
+	`u
+ ();
+
+473 
+	$chown
+ (c *
+__fe
+, 
+__uid_t
+ 
+__owr
+, 
+__gid_t
+ 
+__group
+)
+
+474 
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+476 #i
+defed
+ 
+__USE_BSD
+ || defed 
+__USE_XOPEN_EXTENDED
+ || defed 
+__USE_XOPEN2K8
+
+
+478 
+	$fchown
+ (
+__fd
+, 
+__uid_t
+ 
+__owr
+, 
+__gid_t
+ 
+__group
+
+__THROW
+ 
+__wur
+;
+
+483 
+	$lchown
+ (c *
+__fe
+, 
+__uid_t
+ 
+__owr
+, 
+__gid_t
+ 
+__group
+)
+
+484 
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+488 #ifde
+__USE_ATFILE
+
+
+491 
+	$fchowt
+ (
+__fd
+, c *
+__fe
+, 
+__uid_t
+ 
+__owr
+,
+
+492 
+__gid_t
+ 
+__group
+, 
+__ag
+)
+
+493 
+__THROW
+ 
+	`__nnu
+ ((2)
+__wur
+;
+
+497 
+	$chd
+ (c *
+__th
+
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+499 #i
+defed
+ 
+__USE_BSD
+ || defed 
+__USE_XOPEN_EXTENDED
+ || defed 
+__USE_XOPEN2K8
+
+
+501 
+	$fchd
+ (
+__fd
+
+__THROW
+ 
+__wur
+;
+
+511 *
+	$gcwd
+ (*
+__buf
+, 
+size_t
+ 
+__size
+
+__THROW
+ 
+__wur
+;
+
+513 #ifdef 
+__USE_GNU
+
+
+517 *
+	$g_cut_d_me
+ (
+__THROW
+;
+
+520 #i(
+defed
+ 
+__USE_XOPEN_EXTENDED
+ && !defed 
+__USE_XOPEN2K8
+) \
+
+521 || 
+defed
+ 
+__USE_BSD
+
+
+525 *
+	$gwd
+ (*
+__buf
+)
+
+526 
+__THROW
+ 
+	`__nnu
+ ((1)
+__ibu_dd__
+ 
+__wur
+;
+
+531 
+	$dup
+ (
+__fd
+
+__THROW
+ 
+__wur
+;
+
+534 
+	$dup2
+ (
+__fd
+, 
+__fd2
+
+__THROW
+;
+
+536 #ifde
+__USE_GNU
+
+
+539 
+	$dup3
+ (
+__fd
+, 
+__fd2
+, 
+__ags
+
+__THROW
+;
+
+543 **
+__v
+;
+
+544 #ifde
+__USE_GNU
+
+
+545 **
+v
+;
+
+551 
+	$execve
+ (c *
+__th
+, *c 
+__gv
+[],
+
+552 *c 
+__vp
+[]
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+554 #ifde
+__USE_XOPEN2K8
+
+
+557 
+	$xecve
+ (
+__fd
+, *c 
+__gv
+[], *c 
+__vp
+[])
+
+558 
+__THROW
+ 
+	`__nnu
+ ((2));
+
+563 
+	$execv
+ (c *
+__th
+, *c 
+__gv
+[])
+
+564 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+568 
+	$exee
+ (c *
+__th
+, c *
+__g
+, ...)
+
+569 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+573 
+	$exe
+ (c *
+__th
+, c *
+__g
+, ...)
+
+574 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+578 
+	$execvp
+ (c *
+__fe
+, *c 
+__gv
+[])
+
+579 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+584 
+	$exep
+ (c *
+__fe
+, c *
+__g
+, ...)
+
+585 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+587 #ifde
+__USE_GNU
+
+
+590 
+	$execv
+ (c *
+__fe
+, *c 
+__gv
+[],
+
+591 *c 
+__vp
+[])
+
+592 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+596 #i
+defed
+ 
+__USE_MISC
+ || defed 
+__USE_XOPEN
+
+
+598 
+	$ni
+ (
+__c
+
+__THROW
+ 
+__wur
+;
+
+603 
+	$_ex
+ (
+__us
+
+	`__ibu__
+ ((
+__nu__
+));
+
+609 
+	~<bs/came.h
+>
+
+612 
+	$thcf
+ (c *
+__th
+, 
+__me
+)
+
+613 
+__THROW
+ 
+	`__nnu
+ ((1));
+
+616 
+	$hcf
+ (
+__fd
+, 
+__me
+
+__THROW
+;
+
+619 
+	$syscf
+ (
+__me
+
+__THROW
+;
+
+621 #ifdef 
+__USE_POSIX2
+
+
+623 
+size_t
+ 
+	$cfr
+ (
+__me
+, *
+__buf
+, 
+size_t
+ 
+__n
+
+__THROW
+;
+
+628 
+__pid_t
+ 
+	$gpid
+ (
+__THROW
+;
+
+631 
+__pid_t
+ 
+	$gid
+ (
+__THROW
+;
+
+634 
+__pid_t
+ 
+	$gpg
+ (
+__THROW
+;
+
+637 
+__pid_t
+ 
+	$__gpgid
+ (
+__pid_t
+ 
+__pid
+
+__THROW
+;
+
+638 #i
+defed
+ 
+__USE_XOPEN_EXTENDED
+ || defed 
+__USE_XOPEN2K8
+
+
+639 
+__pid_t
+ 
+	$gpgid
+ (
+__pid_t
+ 
+__pid
+
+__THROW
+;
+
+646 
+	$gid
+ (
+__pid_t
+ 
+__pid
+, __pid_
+__pgid
+
+__THROW
+;
+
+648 #i
+defed
+ 
+__USE_SVID
+ || defed 
+__USE_BSD
+ || defed 
+__USE_XOPEN_EXTENDED
+
+
+660 
+	$g
+ (
+__THROW
+;
+
+667 
+__pid_t
+ 
+	$tsid
+ (
+__THROW
+;
+
+669 #i
+defed
+ 
+__USE_XOPEN_EXTENDED
+ || defed 
+__USE_XOPEN2K8
+
+
+671 
+__pid_t
+ 
+	$gsid
+ (
+__pid_t
+ 
+__pid
+
+__THROW
+;
+
+675 
+__uid_t
+ 
+	$guid
+ (
+__THROW
+;
+
+678 
+__uid_t
+ 
+	$geuid
+ (
+__THROW
+;
+
+681 
+__gid_t
+ 
+	$ggid
+ (
+__THROW
+;
+
+684 
+__gid_t
+ 
+	$gegid
+ (
+__THROW
+;
+
+689 
+	$ggroups
+ (
+__size
+, 
+__gid_t
+ 
+__li
+[]
+__THROW
+ 
+__wur
+;
+
+691 #ifdef 
+__USE_GNU
+
+
+693 
+	$group_memb
+ (
+__gid_t
+ 
+__gid
+
+__THROW
+;
+
+700 
+	$tuid
+ (
+__uid_t
+ 
+__uid
+
+__THROW
+ 
+__wur
+;
+
+702 #i
+defed
+ 
+__USE_BSD
+ || defed 
+__USE_XOPEN_EXTENDED
+
+
+705 
+	$euid
+ (
+__uid_t
+ 
+__ruid
+, __uid_
+__euid
+
+__THROW
+ 
+__wur
+;
+
+708 #i
+defed
+ 
+__USE_BSD
+ || defed 
+__USE_XOPEN2K
+
+
+710 
+	$uid
+ (
+__uid_t
+ 
+__uid
+
+__THROW
+ 
+__wur
+;
+
+717 
+	$tgid
+ (
+__gid_t
+ 
+__gid
+
+__THROW
+ 
+__wur
+;
+
+719 #i
+defed
+ 
+__USE_BSD
+ || defed 
+__USE_XOPEN_EXTENDED
+
+
+722 
+	$egid
+ (
+__gid_t
+ 
+__rgid
+, __gid_
+__egid
+
+__THROW
+ 
+__wur
+;
+
+725 #i
+defed
+ 
+__USE_BSD
+ || defed 
+__USE_XOPEN2K
+
+
+727 
+	$gid
+ (
+__gid_t
+ 
+__gid
+
+__THROW
+ 
+__wur
+;
+
+730 #ifde
+__USE_GNU
+
+
+733 
+	$gsuid
+ (
+__uid_t
+ *
+__ruid
+, __uid_*
+__euid
+, __uid_*
+__suid
+)
+
+734 
+__THROW
+;
+
+738 
+	$gsgid
+ (
+__gid_t
+ *
+__rgid
+, __gid_*
+__egid
+, __gid_*
+__sgid
+)
+
+739 
+__THROW
+;
+
+743 
+	$esuid
+ (
+__uid_t
+ 
+__ruid
+, __uid_
+__euid
+, __uid_
+__suid
+)
+
+744 
+__THROW
+ 
+__wur
+;
+
+748 
+	$esgid
+ (
+__gid_t
+ 
+__rgid
+, __gid_
+__egid
+, __gid_
+__sgid
+)
+
+749 
+__THROW
+ 
+__wur
+;
+
+756 
+__pid_t
+ 
+	$fk
+ (
+__THROWNL
+;
+
+758 #i(
+defed
+ 
+__USE_XOPEN_EXTENDED
+ && !defed 
+__USE_XOPEN2K8
+) \
+
+759 || 
+defed
+ 
+__USE_BSD
+
+
+764 
+__pid_t
+ 
+	$vfk
+ (
+__THROW
+;
+
+770 *
+	$yme
+ (
+__fd
+
+__THROW
+;
+
+774 
+	$yme_r
+ (
+__fd
+, *
+__buf
+, 
+size_t
+ 
+__bu
+)
+
+775 
+__THROW
+ 
+	`__nnu
+ ((2)
+__wur
+;
+
+779 
+	$iy
+ (
+__fd
+
+__THROW
+;
+
+781 #i
+defed
+ 
+__USE_BSD
+ \
+
+782 || (
+defed
+ 
+__USE_XOPEN_EXTENDED
+ && !defed 
+__USE_UNIX98
+)
+
+785 
+	$y
+ (
+__THROW
+;
+
+790 
+	$lk
+ (c *
+__om
+, c *
+__to
+)
+
+791 
+__THROW
+ 
+	`__nnu
+ ((1, 2)
+__wur
+;
+
+793 #ifde
+__USE_ATFILE
+
+
+796 
+	$lk
+ (
+__omfd
+, c *
+__om
+, 
+__tofd
+,
+
+797 c *
+__to
+, 
+__ags
+)
+
+798 
+__THROW
+ 
+	`__nnu
+ ((2, 4)
+__wur
+;
+
+801 #i
+defed
+ 
+__USE_BSD
+ || defed 
+__USE_XOPEN_EXTENDED
+ || defed 
+__USE_XOPEN2K
+
+
+803 
+	$symlk
+ (c *
+__om
+, c *
+__to
+)
+
+804 
+__THROW
+ 
+	`__nnu
+ ((1, 2)
+__wur
+;
+
+809 
+ssize_t
+ 
+	$adlk
+ (c *
+__ri
+ 
+__th
+,
+
+810 *
+__ri
+ 
+__buf
+, 
+size_t
+ 
+__n
+)
+
+811 
+__THROW
+ 
+	`__nnu
+ ((1, 2)
+__wur
+;
+
+814 #ifde
+__USE_ATFILE
+
+
+816 
+	$symlk
+ (c *
+__om
+, 
+__tofd
+,
+
+817 c *
+__to
+
+__THROW
+ 
+	`__nnu
+ ((1, 3)
+__wur
+;
+
+820 
+ssize_t
+ 
+	$adlk
+ (
+__fd
+, c *
+__ri
+ 
+__th
+,
+
+821 *
+__ri
+ 
+__buf
+, 
+size_t
+ 
+__n
+)
+
+822 
+__THROW
+ 
+	`__nnu
+ ((2, 3)
+__wur
+;
+
+826 
+	$uk
+ (c *
+__me
+
+__THROW
+ 
+	`__nnu
+ ((1));
+
+828 #ifde
+__USE_ATFILE
+
+
+830 
+	$uk
+ (
+__fd
+, c *
+__me
+, 
+__ag
+)
+
+831 
+__THROW
+ 
+	`__nnu
+ ((2));
+
+835 
+	$rmd
+ (c *
+__th
+
+__THROW
+ 
+	`__nnu
+ ((1));
+
+839 
+__pid_t
+ 
+	$tcgpg
+ (
+__fd
+
+__THROW
+;
+
+842 
+	$tcg
+ (
+__fd
+, 
+__pid_t
+ 
+__pg_id
+
+__THROW
+;
+
+849 *
+	`glog
+ ();
+
+850 #i
+defed
+ 
+__USE_REENTRANT
+ || defed 
+__USE_POSIX199506
+
+
+857 
+	$glog_r
+ (*
+__me
+, 
+size_t
+ 
+__me_n
+
+	`__nnu
+ ((1));
+
+860 #ifdef 
+__USE_BSD
+
+
+862 
+	$og
+ (c *
+__me
+
+__THROW
+ 
+	`__nnu
+ ((1));
+
+866 #ifdef 
+__USE_POSIX2
+
+
+870 
+	#__ed_gt
+
+
+	)
+
+871 
+	~<gt.h
+>
+
+875 #i
+defed
+ 
+__USE_BSD
+ || defed 
+__USE_UNIX98
+ || defed 
+__USE_XOPEN2K
+
+
+879 
+	$ghome
+ (*
+__me
+, 
+size_t
+ 
+__n
+
+__THROW
+ 
+	`__nnu
+ ((1));
+
+883 #i
+defed
+ 
+__USE_BSD
+ || (defed 
+__USE_XOPEN
+ && !defed 
+__USE_UNIX98
+)
+
+886 
+	$thome
+ (c *
+__me
+, 
+size_t
+ 
+__n
+)
+
+887 
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+891 
+	$thoid
+ (
+__id
+
+__THROW
+ 
+__wur
+;
+
+897 
+	$gdomame
+ (*
+__me
+, 
+size_t
+ 
+__n
+)
+
+898 
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+899 
+	$tdomame
+ (c *
+__me
+, 
+size_t
+ 
+__n
+)
+
+900 
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+906 
+	$vhgup
+ (
+__THROW
+;
+
+909 
+	$voke
+ (c *
+__fe
+
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+917 
+	$of
+ (*
+__me_bufr
+, 
+size_t
+ 
+__size
+,
+
+918 
+size_t
+ 
+__offt
+, 
+__s
+)
+
+919 
+__THROW
+ 
+	`__nnu
+ ((1));
+
+925 
+	$ac
+ (c *
+__me
+
+__THROW
+;
+
+929 *
+	$gurshl
+ (
+__THROW
+;
+
+930 
+	$durshl
+ (
+__THROW
+;
+
+931 
+	$turshl
+ (
+__THROW
+;
+
+937 
+	$dm
+ (
+__nochd
+, 
+__noo
+
+__THROW
+ 
+__wur
+;
+
+941 #i
+defed
+ 
+__USE_BSD
+ || (defed 
+__USE_XOPEN
+ && !defed 
+__USE_XOPEN2K
+)
+
+944 
+	$chro
+ (c *
+__th
+
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+948 *
+	$gss
+ (c *
+__om
+
+	`__nnu
+ ((1));
+
+956 
+	`fsync
+ (
+__fd
+);
+
+959 #ifde
+__USE_GNU
+
+
+962 
+	$syncfs
+ (
+__fd
+
+__THROW
+;
+
+966 #i
+defed
+ 
+__USE_BSD
+ || defed 
+__USE_XOPEN_EXTENDED
+
+
+969 
+	`ghoid
+ ();
+
+972 
+	$sync
+ (
+__THROW
+;
+
+975 #i
+defed
+ 
+__USE_BSD
+ || !defed 
+__USE_XOPEN2K
+
+
+978 
+	$ggesize
+ (
+__THROW
+ 
+	`__ibu__
+ ((
+__c__
+));
+
+983 
+	$gdbsize
+ (
+__THROW
+;
+
+989 #i
+defed
+ 
+__USE_BSD
+ || defed 
+__USE_XOPEN_EXTENDED
+ || defed 
+__USE_XOPEN2K8
+
+
+992 #ide
+__USE_FILE_OFFSET64
+
+
+993 
+	$un
+ (c *
+__fe
+, 
+__off_t
+ 
+__ngth
+)
+
+994 
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+996 #ifde
+__REDIRECT_NTH
+
+
+997 
+	`__REDIRECT_NTH
+ (
+un
+,
+
+998 (c *
+__fe
+, 
+__off64_t
+ 
+__ngth
+),
+
+999 
+un64
+
+	`__nnu
+ ((1)
+__wur
+;
+
+1001 
+	#un
+ 
+un64
+
+
+	)
+
+1004 #ifde
+__USE_LARGEFILE64
+
+
+1005 
+	$un64
+ (c *
+__fe
+, 
+__off64_t
+ 
+__ngth
+)
+
+1006 
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+1011 #i
+defed
+ 
+__USE_BSD
+ || defed 
+__USE_POSIX199309
+ \
+
+1012 || 
+defed
+ 
+__USE_XOPEN_EXTENDED
+ || defed 
+__USE_XOPEN2K
+
+
+1015 #ide
+__USE_FILE_OFFSET64
+
+
+1016 
+	$run
+ (
+__fd
+, 
+__off_t
+ 
+__ngth
+
+__THROW
+ 
+__wur
+;
+
+1018 #ifde
+__REDIRECT_NTH
+
+
+1019 
+	`__REDIRECT_NTH
+ (
+run
+, (
+__fd
+, 
+__off64_t
+ 
+__ngth
+),
+
+1020 
+run64
+
+__wur
+;
+
+1022 
+	#run
+ 
+run64
+
+
+	)
+
+1025 #ifde
+__USE_LARGEFILE64
+
+
+1026 
+	$run64
+ (
+__fd
+, 
+__off64_t
+ 
+__ngth
+
+__THROW
+ 
+__wur
+;
+
+1032 #i(
+defed
+ 
+__USE_XOPEN_EXTENDED
+ && !defed 
+__USE_XOPEN2K
+) \
+
+1033 || 
+defed
+ 
+__USE_MISC
+
+
+1037 
+	$brk
+ (*
+__addr
+
+__THROW
+ 
+__wur
+;
+
+1043 *
+	$sbrk
+ (
+_t
+ 
+__d
+
+__THROW
+;
+
+1047 #ifde
+__USE_MISC
+
+
+1058 
+	$sys
+ (
+__syo
+, ...
+__THROW
+;
+
+1063 #i(
+defed
+ 
+__USE_MISC
+ || defed 
+__USE_XOPEN_EXTENDED
+&& !defed 
+F_LOCK
+
+
+1075 
+	#F_ULOCK
+ 0
+
+	)
+
+1076 
+	#F_LOCK
+ 1
+
+	)
+
+1077 
+	#F_TLOCK
+ 2
+
+	)
+
+1078 
+	#F_TEST
+ 3
+
+	)
+
+1080 #ide
+__USE_FILE_OFFSET64
+
+
+1081 
+	$lockf
+ (
+__fd
+, 
+__cmd
+, 
+__off_t
+ 
+__n
+
+__wur
+;
+
+1083 #ifde
+__REDIRECT
+
+
+1084 
+	`__REDIRECT
+ (
+lockf
+, (
+__fd
+, 
+__cmd
+, 
+__off64_t
+ 
+__n
+),
+
+1085 
+lockf64
+
+__wur
+;
+
+1087 
+	#lockf
+ 
+lockf64
+
+
+	)
+
+1090 #ifde
+__USE_LARGEFILE64
+
+
+1091 
+	$lockf64
+ (
+__fd
+, 
+__cmd
+, 
+__off64_t
+ 
+__n
+
+__wur
+;
+
+1096 #ifde
+__USE_GNU
+
+
+1101 
+	#TEMP_FAILURE_RETRY
+(
+exessi
+) \
+
+1102 (
+__exnsi__
+ \
+
+1103 ({ 
+__su
+; \
+
+1104 d
+__su
+ = ((
+exessi
+); \
+
+1105 
+__su
+ =-1L && 
+o
+ =
+EINTR
+); \
+
+1106 
+__su
+; 
+	}
+}))
+
+	)
+
+1109 #i
+defed
+ 
+__USE_POSIX199309
+ || defed 
+__USE_UNIX98
+
+
+1112 
+fdasync
+ (
+__fdes
+);
+
+1118 #ifdef 
+__USE_XOPEN
+
+
+1120 *
+	$y
+ (c *
+__key
+, c *
+__
+)
+
+1121 
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+1125 
+	$y
+ (*
+__glibc_block
+, 
+__edag
+)
+
+1126 
+__THROW
+ 
+	`__nnu
+ ((1));
+
+1133 
+	$swab
+ (c *
+__ri
+ 
+__om
+, *__ri 
+__to
+,
+
+1134 
+ssize_t
+ 
+__n
+
+__THROW
+ 
+	`__nnu
+ ((1, 2));
+
+1140 #i
+defed
+ 
+__USE_XOPEN
+ && !defed 
+__USE_XOPEN2K
+
+
+1142 *
+	$mid
+ (*
+__s
+
+__THROW
+;
+
+1147 #i
+__USE_FORTIFY_LEVEL
+ > 0 && 
+defed
+ 
+__ftify_funi
+
+
+1148 
+	~<bs/unid.h
+>
+
+1151 
+__END_DECLS
+
+
+	@/usr/include/alloca.h
+
+18 #idef 
+_ALLOCA_H
+
+
+19 
+	#_ALLOCA_H
+ 1
+
+	)
+
+21 
+	~<us.h
+>
+
+23 
+	#__ed_size_t
+
+
+	)
+
+24 
+	~<ddef.h
+>
+
+26 
+	g__BEGIN_DECLS
+
+
+29 #unde
+lo
+
+
+32 *
+	$lo
+ (
+size_t
+ 
+__size
+
+__THROW
+;
+
+34 #ifdef 
+__GNUC__
+
+
+35 
+	#lo
+(
+size
+
+	`__but_lo
+ (size)
+
+	)
+
+38 
+__END_DECLS
+
+
+	@/usr/include/endian.h
+
+18 #idef 
+_ENDIAN_H
+
+
+19 
+	#_ENDIAN_H
+ 1
+
+	)
+
+21 
+	~<us.h
+>
+
+31 
+	#__LITTLE_ENDIAN
+ 1234
+
+	)
+
+32 
+	#__BIG_ENDIAN
+ 4321
+
+	)
+
+33 
+	#__PDP_ENDIAN
+ 3412
+
+	)
+
+36 
+	~<bs/dn.h
+>
+
+40 #ide
+__FLOAT_WORD_ORDER
+
+
+41 
+	#__FLOAT_WORD_ORDER
+ 
+__BYTE_ORDER
+
+
+	)
+
+44 #ifdef 
+__USE_BSD
+
+
+45 
+	#LITTLE_ENDIAN
+ 
+__LITTLE_ENDIAN
+
+
+	)
+
+46 
+	#BIG_ENDIAN
+ 
+__BIG_ENDIAN
+
+
+	)
+
+47 
+	#PDP_ENDIAN
+ 
+__PDP_ENDIAN
+
+
+	)
+
+48 
+	#BYTE_ORDER
+ 
+__BYTE_ORDER
+
+
+	)
+
+51 #i
+__BYTE_ORDER
+ =
+__LITTLE_ENDIAN
+
+
+52 
+	#__LONG_LONG_PAIR
+(
+HI
+, 
+LO
+LO, 
+	)
+HI
+
+53 #i
+__BYTE_ORDER
+ =
+__BIG_ENDIAN
+
+
+54 
+	#__LONG_LONG_PAIR
+(
+HI
+, 
+LO
+HI, 
+	)
+LO
+
+58 #i
+defed
+ 
+__USE_BSD
+ && !defed 
+__ASSEMBLER__
+
+
+60 
+	~<bs/bysw.h
+>
+
+62 #i
+__BYTE_ORDER
+ =
+__LITTLE_ENDIAN
+
+
+63 
+	#htobe16
+(
+x
+
+	`__bsw_16
+ (x)
+
+	)
+
+64 
+	#hte16
+(
+x
+(x)
+
+	)
+
+65 
+	#be16toh
+(
+x
+
+	`__bsw_16
+ (x)
+
+	)
+
+66 
+	#16toh
+(
+x
+(x)
+
+	)
+
+68 
+	#htobe32
+(
+x
+
+	`__bsw_32
+ (x)
+
+	)
+
+69 
+	#hte32
+(
+x
+(x)
+
+	)
+
+70 
+	#be32toh
+(
+x
+
+	`__bsw_32
+ (x)
+
+	)
+
+71 
+	#32toh
+(
+x
+(x)
+
+	)
+
+73 
+	#htobe64
+(
+x
+
+	`__bsw_64
+ (x)
+
+	)
+
+74 
+	#hte64
+(
+x
+(x)
+
+	)
+
+75 
+	#be64toh
+(
+x
+
+	`__bsw_64
+ (x)
+
+	)
+
+76 
+	#64toh
+(
+x
+(x)
+
+	)
+
+79 
+	#htobe16
+(
+x
+(x)
+
+	)
+
+80 
+	#hte16
+(
+x
+
+	`__bsw_16
+ (x)
+
+	)
+
+81 
+	#be16toh
+(
+x
+(x)
+
+	)
+
+82 
+	#16toh
+(
+x
+
+	`__bsw_16
+ (x)
+
+	)
+
+84 
+	#htobe32
+(
+x
+(x)
+
+	)
+
+85 
+	#hte32
+(
+x
+
+	`__bsw_32
+ (x)
+
+	)
+
+86 
+	#be32toh
+(
+x
+(x)
+
+	)
+
+87 
+	#32toh
+(
+x
+
+	`__bsw_32
+ (x)
+
+	)
+
+89 
+	#htobe64
+(
+x
+(x)
+
+	)
+
+90 
+	#hte64
+(
+x
+
+	`__bsw_64
+ (x)
+
+	)
+
+91 
+	#be64toh
+(
+x
+(x)
+
+	)
+
+92 
+	#64toh
+(
+x
+
+	`__bsw_64
+ (x)
+
+	)
+
+	@/usr/include/features.h
+
+18 #idef 
+_FEATURES_H
+
+
+19 
+	#_FEATURES_H
+ 1
+
+	)
+
+101 #unde
+__USE_ISOC11
+
+
+102 #unde
+__USE_ISOC99
+
+
+103 #unde
+__USE_ISOC95
+
+
+104 #unde
+__USE_ISOCXX11
+
+
+105 #unde
+__USE_POSIX
+
+
+106 #unde
+__USE_POSIX2
+
+
+107 #unde
+__USE_POSIX199309
+
+
+108 #unde
+__USE_POSIX199506
+
+
+109 #unde
+__USE_XOPEN
+
+
+110 #unde
+__USE_XOPEN_EXTENDED
+
+
+111 #unde
+__USE_UNIX98
+
+
+112 #unde
+__USE_XOPEN2K
+
+
+113 #unde
+__USE_XOPEN2KXSI
+
+
+114 #unde
+__USE_XOPEN2K8
+
+
+115 #unde
+__USE_XOPEN2K8XSI
+
+
+116 #unde
+__USE_LARGEFILE
+
+
+117 #unde
+__USE_LARGEFILE64
+
+
+118 #unde
+__USE_FILE_OFFSET64
+
+
+119 #unde
+__USE_BSD
+
+
+120 #unde
+__USE_SVID
+
+
+121 #unde
+__USE_MISC
+
+
+122 #unde
+__USE_ATFILE
+
+
+123 #unde
+__USE_GNU
+
+
+124 #unde
+__USE_REENTRANT
+
+
+125 #unde
+__USE_FORTIFY_LEVEL
+
+
+126 #unde
+__KERNEL_STRICT_NAMES
+
+
+130 #ide
+_LOOSE_KERNEL_NAMES
+
+
+131 
+	#__KERNEL_STRICT_NAMES
+
+
+	)
+
+141 #i
+defed
+ 
+__GNUC__
+ && defed 
+__GNUC_MINOR__
+
+
+142 
+	#__GNUC_PREREQ
+(
+maj
+, 
+m
+) \
+
+143 ((
+__GNUC__
+ << 16+ 
+__GNUC_MINOR__
+ >((
+maj
+<< 16+ (
+m
+))
+
+	)
+
+145 
+	#__GNUC_PREREQ
+(
+maj
+, 
+m
+0
+
+	)
+
+150 #ifde
+_GNU_SOURCE
+
+
+151 #unde
+_ISOC95_SOURCE
+
+
+152 
+	#_ISOC95_SOURCE
+ 1
+
+	)
+
+153 #unde
+_ISOC99_SOURCE
+
+
+154 
+	#_ISOC99_SOURCE
+ 1
+
+	)
+
+155 #unde
+_ISOC11_SOURCE
+
+
+156 
+	#_ISOC11_SOURCE
+ 1
+
+	)
+
+157 #unde
+_POSIX_SOURCE
+
+
+158 
+	#_POSIX_SOURCE
+ 1
+
+	)
+
+159 #unde
+_POSIX_C_SOURCE
+
+
+160 
+	#_POSIX_C_SOURCE
+ 200809L
+
+	)
+
+161 #unde
+_XOPEN_SOURCE
+
+
+162 
+	#_XOPEN_SOURCE
+ 700
+
+	)
+
+163 #unde
+_XOPEN_SOURCE_EXTENDED
+
+
+164 
+	#_XOPEN_SOURCE_EXTENDED
+ 1
+
+	)
+
+165 #unde
+_LARGEFILE64_SOURCE
+
+
+166 
+	#_LARGEFILE64_SOURCE
+ 1
+
+	)
+
+167 #unde
+_DEFAULT_SOURCE
+
+
+168 
+	#_DEFAULT_SOURCE
+ 1
+
+	)
+
+169 #unde
+_BSD_SOURCE
+
+
+170 
+	#_BSD_SOURCE
+ 1
+
+	)
+
+171 #unde
+_SVID_SOURCE
+
+
+172 
+	#_SVID_SOURCE
+ 1
+
+	)
+
+173 #unde
+_ATFILE_SOURCE
+
+
+174 
+	#_ATFILE_SOURCE
+ 1
+
+	)
+
+179 #i(
+defed
+ 
+_DEFAULT_SOURCE
+ \
+
+180 || (!
+defed
+ 
+	g__STRICT_ANSI__
+ \
+
+181 && !
+defed
+ 
+	g_ISOC99_SOURCE
+ \
+
+182 && !
+defed
+ 
+	g_POSIX_SOURCE
+ && !defed 
+	g_POSIX_C_SOURCE
+ \
+
+183 && !
+defed
+ 
+	g_XOPEN_SOURCE
+ \
+
+184 && !
+defed
+ 
+	g_BSD_SOURCE
+ && !defed 
+	g_SVID_SOURCE
+))
+
+185 #unde
+_DEFAULT_SOURCE
+
+
+186 
+	#_DEFAULT_SOURCE
+ 1
+
+	)
+
+187 #unde
+_BSD_SOURCE
+
+
+188 
+	#_BSD_SOURCE
+ 1
+
+	)
+
+189 #unde
+_SVID_SOURCE
+
+
+190 
+	#_SVID_SOURCE
+ 1
+
+	)
+
+194 #i(
+defed
+ 
+_ISOC11_SOURCE
+ \
+
+195 || (
+defed
+ 
+	g__STDC_VERSION__
+ && __STDC_VERSION__ >= 201112L))
+
+196 
+	#__USE_ISOC11
+ 1
+
+	)
+
+200 #i(
+defed
+ 
+_ISOC99_SOURCE
+ || defed 
+_ISOC11_SOURCE
+ \
+
+201 || (
+defed
+ 
+__STDC_VERSION__
+ && __STDC_VERSION__ >= 199901L))
+
+202 
+	#__USE_ISOC99
+ 1
+
+	)
+
+206 #i(
+defed
+ 
+_ISOC99_SOURCE
+ || defed 
+_ISOC11_SOURCE
+ \
+
+207 || (
+defed
+ 
+__STDC_VERSION__
+ && __STDC_VERSION__ >= 199409L))
+
+208 
+	#__USE_ISOC95
+ 1
+
+	)
+
+215 #i((
+defed
+ 
+__lulus
+ && __cplusplus >= 201103L) \
+
+216 || 
+defed
+ 
+__GXX_EXPERIMENTAL_CXX0X__
+)
+
+217 
+	#__USE_ISOCXX11
+ 1
+
+	)
+
+223 #ifde
+_DEFAULT_SOURCE
+
+
+224 #i!
+defed
+ 
+_POSIX_SOURCE
+ && !defed 
+_POSIX_C_SOURCE
+
+
+225 
+	#__USE_POSIX_IMPLICITLY
+ 1
+
+	)
+
+227 #unde
+_POSIX_SOURCE
+
+
+228 
+	#_POSIX_SOURCE
+ 1
+
+	)
+
+229 #unde
+_POSIX_C_SOURCE
+
+
+230 
+	#_POSIX_C_SOURCE
+ 200809L
+
+	)
+
+232 #i((!
+defed
+ 
+__STRICT_ANSI__
+ || (
+_XOPEN_SOURCE
+ - 0) >= 500) && \
+
+233 !
+defed
+ 
+_POSIX_SOURCE
+ && !defed 
+_POSIX_C_SOURCE
+)
+
+234 
+	#_POSIX_SOURCE
+ 1
+
+	)
+
+235 #i
+defed
+ 
+_XOPEN_SOURCE
+ && (_XOPEN_SOURCE - 0) < 500
+
+236 
+	#_POSIX_C_SOURCE
+ 2
+
+	)
+
+237 #i
+defed
+ 
+_XOPEN_SOURCE
+ && (_XOPEN_SOURCE - 0) < 600
+
+238 
+	#_POSIX_C_SOURCE
+ 199506L
+
+	)
+
+239 #i
+defed
+ 
+_XOPEN_SOURCE
+ && (_XOPEN_SOURCE - 0) < 700
+
+240 
+	#_POSIX_C_SOURCE
+ 200112L
+
+	)
+
+242 
+	#_POSIX_C_SOURCE
+ 200809L
+
+	)
+
+244 
+	#__USE_POSIX_IMPLICITLY
+ 1
+
+	)
+
+247 #i
+defed
+ 
+_POSIX_SOURCE
+ || 
+_POSIX_C_SOURCE
+ >1 || defed 
+_XOPEN_SOURCE
+
+
+248 
+	#__USE_POSIX
+ 1
+
+	)
+
+251 #i
+defed
+ 
+_POSIX_C_SOURCE
+ && _POSIX_C_SOURCE >2 || defed 
+_XOPEN_SOURCE
+
+
+252 
+	#__USE_POSIX2
+ 1
+
+	)
+
+255 #i(
+_POSIX_C_SOURCE
+ - 0) >= 199309L
+
+256 
+	#__USE_POSIX199309
+ 1
+
+	)
+
+259 #i(
+_POSIX_C_SOURCE
+ - 0) >= 199506L
+
+260 
+	#__USE_POSIX199506
+ 1
+
+	)
+
+263 #i(
+_POSIX_C_SOURCE
+ - 0) >= 200112L
+
+264 
+	#__USE_XOPEN2K
+ 1
+
+	)
+
+265 #unde
+__USE_ISOC95
+
+
+266 
+	#__USE_ISOC95
+ 1
+
+	)
+
+267 #unde
+__USE_ISOC99
+
+
+268 
+	#__USE_ISOC99
+ 1
+
+	)
+
+271 #i(
+_POSIX_C_SOURCE
+ - 0) >= 200809L
+
+272 
+	#__USE_XOPEN2K8
+ 1
+
+	)
+
+273 #unde
+_ATFILE_SOURCE
+
+
+274 
+	#_ATFILE_SOURCE
+ 1
+
+	)
+
+277 #ifdef 
+_XOPEN_SOURCE
+
+
+278 
+	#__USE_XOPEN
+ 1
+
+	)
+
+279 #i(
+_XOPEN_SOURCE
+ - 0) >= 500
+
+280 
+	#__USE_XOPEN_EXTENDED
+ 1
+
+	)
+
+281 
+	#__USE_UNIX98
+ 1
+
+	)
+
+282 #unde
+_LARGEFILE_SOURCE
+
+
+283 
+	#_LARGEFILE_SOURCE
+ 1
+
+	)
+
+284 #i(
+_XOPEN_SOURCE
+ - 0) >= 600
+
+285 #i(
+_XOPEN_SOURCE
+ - 0) >= 700
+
+286 
+	#__USE_XOPEN2K8
+ 1
+
+	)
+
+287 
+	#__USE_XOPEN2K8XSI
+ 1
+
+	)
+
+289 
+	#__USE_XOPEN2K
+ 1
+
+	)
+
+290 
+	#__USE_XOPEN2KXSI
+ 1
+
+	)
+
+291 #unde
+__USE_ISOC95
+
+
+292 
+	#__USE_ISOC95
+ 1
+
+	)
+
+293 #unde
+__USE_ISOC99
+
+
+294 
+	#__USE_ISOC99
+ 1
+
+	)
+
+297 #ifde
+_XOPEN_SOURCE_EXTENDED
+
+
+298 
+	#__USE_XOPEN_EXTENDED
+ 1
+
+	)
+
+303 #ifde
+_LARGEFILE_SOURCE
+
+
+304 
+	#__USE_LARGEFILE
+ 1
+
+	)
+
+307 #ifde
+_LARGEFILE64_SOURCE
+
+
+308 
+	#__USE_LARGEFILE64
+ 1
+
+	)
+
+311 #i
+defed
+ 
+_FILE_OFFSET_BITS
+ && _FILE_OFFSET_BITS == 64
+
+312 
+	#__USE_FILE_OFFSET64
+ 1
+
+	)
+
+315 #i
+defed
+ 
+_BSD_SOURCE
+ || defed 
+_SVID_SOURCE
+
+
+316 
+	#__USE_MISC
+ 1
+
+	)
+
+319 #ifdef 
+_BSD_SOURCE
+
+
+320 
+	#__USE_BSD
+ 1
+
+	)
+
+323 #ifdef 
+_SVID_SOURCE
+
+
+324 
+	#__USE_SVID
+ 1
+
+	)
+
+327 #ifdef 
+_ATFILE_SOURCE
+
+
+328 
+	#__USE_ATFILE
+ 1
+
+	)
+
+331 #ifdef 
+_GNU_SOURCE
+
+
+332 
+	#__USE_GNU
+ 1
+
+	)
+
+335 #i
+defed
+ 
+_REENTRANT
+ || defed 
+_THREAD_SAFE
+
+
+336 
+	#__USE_REENTRANT
+ 1
+
+	)
+
+339 #i
+defed
+ 
+_FORTIFY_SOURCE
+ && _FORTIFY_SOURCE > 0 \
+
+340 && 
+__GNUC_PREREQ
+ (4, 1&& 
+defed
+ 
+	g__OPTIMIZE__
+ && __OPTIMIZE__ > 0
+
+341 #i
+_FORTIFY_SOURCE
+ > 1
+
+342 
+	#__USE_FORTIFY_LEVEL
+ 2
+
+	)
+
+344 
+	#__USE_FORTIFY_LEVEL
+ 1
+
+	)
+
+347 
+	#__USE_FORTIFY_LEVEL
+ 0
+
+	)
+
+352 
+	~<dc-edef.h
+>
+
+360 #unde
+__GNU_LIBRARY__
+
+
+361 
+	#__GNU_LIBRARY__
+ 6
+
+	)
+
+365 
+	#__GLIBC__
+ 2
+
+	)
+
+366 
+	#__GLIBC_MINOR__
+ 19
+
+	)
+
+368 
+	#__GLIBC_PREREQ
+(
+maj
+, 
+m
+) \
+
+369 ((
+__GLIBC__
+ << 16+ 
+__GLIBC_MINOR__
+ >((
+maj
+<< 16+ (
+m
+))
+
+	)
+
+372 #ide
+__ASSEMBLER__
+
+
+373 #ide
+_SYS_CDEFS_H
+
+
+374 
+	~<sys/cdefs.h
+>
+
+379 #i
+defed
+ 
+__USE_FILE_OFFSET64
+ && !defed 
+__REDIRECT
+
+
+380 
+	#__USE_LARGEFILE
+ 1
+
+	)
+
+381 
+	#__USE_LARGEFILE64
+ 1
+
+	)
+
+387 #i
+__GNUC_PREREQ
+ (2, 7&& 
+defed
+ 
+__OPTIMIZE__
+ \
+
+388 && !
+defed
+ 
+	g__OPTIMIZE_SIZE__
+ && !defed 
+	g__NO_INLINE__
+ \
+
+389 && 
+defed
+ 
+	g__ex_le
+
+
+390 
+	#__USE_EXTERN_INLINES
+ 1
+
+	)
+
+398 
+	~<gnu/ubs.h
+>
+
+	@/usr/include/getopt.h
+
+19 #ide
+_GETOPT_H
+
+
+21 #ide
+__ed_gt
+
+
+22 
+	#_GETOPT_H
+ 1
+
+	)
+
+32 #i!
+defed
+ 
+__GNU_LIBRARY__
+
+
+33 
+	~<y.h
+>
+
+36 #ide
+__THROW
+
+
+37 #ide
+__GNUC_PREREQ
+
+
+38 
+	#__GNUC_PREREQ
+(
+maj
+, 
+m
+(0)
+
+	)
+
+40 #i
+defed
+ 
+__lulus
+ && 
+__GNUC_PREREQ
+ (2,8)
+
+41 
+	#__THROW
+ 
+	`throw
+ ()
+
+	)
+
+43 
+	#__THROW
+
+
+	)
+
+47 #ifdef 
+__lulus
+
+
+57 *
+rg
+;
+
+71 
+td
+;
+
+76 
+
+;
+
+80 
+tt
+;
+
+82 #ide
+__ed_gt
+
+
+104 
+	sti
+
+
+106 c *
+	gme
+;
+
+109 
+	ghas_g
+;
+
+110 *
+	gag
+;
+
+111 
+	gv
+;
+
+116 
+	#no_gumt
+ 0
+
+	)
+
+117 
+	#qued_gumt
+ 1
+
+	)
+
+118 
+	#ti_gumt
+ 2
+
+	)
+
+146 #ifde
+__GNU_LIBRARY__
+
+
+150 
+gt
+ (
+___gc
+, *c *
+___gv
+, c *
+__shtts
+)
+
+151 
+__THROW
+;
+
+153 #i
+defed
+ 
+__ed_gt
+ && defed 
+__USE_POSIX2
+ \
+
+154 && !
+defed
+ 
+	g__USE_POSIX_IMPLICITLY
+ && !defed 
+	g__USE_GNU
+
+
+158 #ifde
+__REDIRECT
+
+
+159 
+__REDIRECT_NTH
+ (
+gt
+, (
+___gc
+, *c *
+___gv
+,
+
+160 c *
+__shtts
+),
+
+161 
+__posix_gt
+);
+
+163 
+__posix_gt
+ (
+___gc
+, *c *
+___gv
+,
+
+164 c *
+__shtts
+
+__THROW
+;
+
+165 
+	#gt
+ 
+__posix_gt
+
+
+	)
+
+169 
+gt
+ ();
+
+172 #ide
+__ed_gt
+
+
+173 
+gt_lg
+ (
+___gc
+, *c *
+___gv
+,
+
+174 c *
+__shtts
+,
+
+175 c 
+ti
+ *
+__lgts
+, *
+__lgd
+)
+
+176 
+__THROW
+;
+
+177 
+gt_lg_ly
+ (
+___gc
+, *c *
+___gv
+,
+
+178 c *
+__shtts
+,
+
+179 c 
+ti
+ *
+__lgts
+, *
+__lgd
+)
+
+180 
+__THROW
+;
+
+184 #ifdef 
+__lulus
+
+
+189 #unde
+__ed_gt
+
+
+	@/usr/include/inttypes.h
+
+22 #ide
+_INTTYPES_H
+
+
+23 
+	#_INTTYPES_H
+ 1
+
+	)
+
+25 
+	~<us.h
+>
+
+27 
+	~<dt.h
+>
+
+30 #ide
+____gwch_t_defed
+
+
+31 #ifde
+__lulus
+
+
+32 
+	#__gwch_t
+ 
+wch_t
+
+
+	)
+
+33 #i
+defed
+ 
+__WCHAR_TYPE__
+
+
+34 
+__WCHAR_TYPE__
+ 
+	t__gwch_t
+;
+
+36 
+	#__ed_wch_t
+
+
+	)
+
+37 
+	~<ddef.h
+>
+
+38 
+wch_t
+ 
+	t__gwch_t
+;
+
+40 
+	#____gwch_t_defed
+ 1
+
+	)
+
+43 #i
+__WORDSIZE
+ == 64
+
+44 
+	#__PRI64_PREFIX
+ "l"
+
+	)
+
+45 
+	#__PRIPTR_PREFIX
+ "l"
+
+	)
+
+47 
+	#__PRI64_PREFIX
+ ""
+
+	)
+
+48 
+	#__PRIPTR_PREFIX
+
+
+	)
+
+54 
+	#PRId8
+ "d"
+
+	)
+
+55 
+	#PRId16
+ "d"
+
+	)
+
+56 
+	#PRId32
+ "d"
+
+	)
+
+57 
+	#PRId64
+ 
+__PRI64_PREFIX
+ "d"
+
+	)
+
+59 
+	#PRIdLEAST8
+ "d"
+
+	)
+
+60 
+	#PRIdLEAST16
+ "d"
+
+	)
+
+61 
+	#PRIdLEAST32
+ "d"
+
+	)
+
+62 
+	#PRIdLEAST64
+ 
+__PRI64_PREFIX
+ "d"
+
+	)
+
+64 
+	#PRIdFAST8
+ "d"
+
+	)
+
+65 
+	#PRIdFAST16
+ 
+__PRIPTR_PREFIX
+ "d"
+
+	)
+
+66 
+	#PRIdFAST32
+ 
+__PRIPTR_PREFIX
+ "d"
+
+	)
+
+67 
+	#PRIdFAST64
+ 
+__PRI64_PREFIX
+ "d"
+
+	)
+
+70 
+	#PRIi8
+ "i"
+
+	)
+
+71 
+	#PRIi16
+ "i"
+
+	)
+
+72 
+	#PRIi32
+ "i"
+
+	)
+
+73 
+	#PRIi64
+ 
+__PRI64_PREFIX
+ "i"
+
+	)
+
+75 
+	#PRIiLEAST8
+ "i"
+
+	)
+
+76 
+	#PRIiLEAST16
+ "i"
+
+	)
+
+77 
+	#PRIiLEAST32
+ "i"
+
+	)
+
+78 
+	#PRIiLEAST64
+ 
+__PRI64_PREFIX
+ "i"
+
+	)
+
+80 
+	#PRIiFAST8
+ "i"
+
+	)
+
+81 
+	#PRIiFAST16
+ 
+__PRIPTR_PREFIX
+ "i"
+
+	)
+
+82 
+	#PRIiFAST32
+ 
+__PRIPTR_PREFIX
+ "i"
+
+	)
+
+83 
+	#PRIiFAST64
+ 
+__PRI64_PREFIX
+ "i"
+
+	)
+
+86 
+	#PRIo8
+ "o"
+
+	)
+
+87 
+	#PRIo16
+ "o"
+
+	)
+
+88 
+	#PRIo32
+ "o"
+
+	)
+
+89 
+	#PRIo64
+ 
+__PRI64_PREFIX
+ "o"
+
+	)
+
+91 
+	#PRIoLEAST8
+ "o"
+
+	)
+
+92 
+	#PRIoLEAST16
+ "o"
+
+	)
+
+93 
+	#PRIoLEAST32
+ "o"
+
+	)
+
+94 
+	#PRIoLEAST64
+ 
+__PRI64_PREFIX
+ "o"
+
+	)
+
+96 
+	#PRIoFAST8
+ "o"
+
+	)
+
+97 
+	#PRIoFAST16
+ 
+__PRIPTR_PREFIX
+ "o"
+
+	)
+
+98 
+	#PRIoFAST32
+ 
+__PRIPTR_PREFIX
+ "o"
+
+	)
+
+99 
+	#PRIoFAST64
+ 
+__PRI64_PREFIX
+ "o"
+
+	)
+
+102 
+	#PRIu8
+ "u"
+
+	)
+
+103 
+	#PRIu16
+ "u"
+
+	)
+
+104 
+	#PRIu32
+ "u"
+
+	)
+
+105 
+	#PRIu64
+ 
+__PRI64_PREFIX
+ "u"
+
+	)
+
+107 
+	#PRIuLEAST8
+ "u"
+
+	)
+
+108 
+	#PRIuLEAST16
+ "u"
+
+	)
+
+109 
+	#PRIuLEAST32
+ "u"
+
+	)
+
+110 
+	#PRIuLEAST64
+ 
+__PRI64_PREFIX
+ "u"
+
+	)
+
+112 
+	#PRIuFAST8
+ "u"
+
+	)
+
+113 
+	#PRIuFAST16
+ 
+__PRIPTR_PREFIX
+ "u"
+
+	)
+
+114 
+	#PRIuFAST32
+ 
+__PRIPTR_PREFIX
+ "u"
+
+	)
+
+115 
+	#PRIuFAST64
+ 
+__PRI64_PREFIX
+ "u"
+
+	)
+
+118 
+	#PRIx8
+ "x"
+
+	)
+
+119 
+	#PRIx16
+ "x"
+
+	)
+
+120 
+	#PRIx32
+ "x"
+
+	)
+
+121 
+	#PRIx64
+ 
+__PRI64_PREFIX
+ "x"
+
+	)
+
+123 
+	#PRIxLEAST8
+ "x"
+
+	)
+
+124 
+	#PRIxLEAST16
+ "x"
+
+	)
+
+125 
+	#PRIxLEAST32
+ "x"
+
+	)
+
+126 
+	#PRIxLEAST64
+ 
+__PRI64_PREFIX
+ "x"
+
+	)
+
+128 
+	#PRIxFAST8
+ "x"
+
+	)
+
+129 
+	#PRIxFAST16
+ 
+__PRIPTR_PREFIX
+ "x"
+
+	)
+
+130 
+	#PRIxFAST32
+ 
+__PRIPTR_PREFIX
+ "x"
+
+	)
+
+131 
+	#PRIxFAST64
+ 
+__PRI64_PREFIX
+ "x"
+
+	)
+
+134 
+	#PRIX8
+ "X"
+
+	)
+
+135 
+	#PRIX16
+ "X"
+
+	)
+
+136 
+	#PRIX32
+ "X"
+
+	)
+
+137 
+	#PRIX64
+ 
+__PRI64_PREFIX
+ "X"
+
+	)
+
+139 
+	#PRIXLEAST8
+ "X"
+
+	)
+
+140 
+	#PRIXLEAST16
+ "X"
+
+	)
+
+141 
+	#PRIXLEAST32
+ "X"
+
+	)
+
+142 
+	#PRIXLEAST64
+ 
+__PRI64_PREFIX
+ "X"
+
+	)
+
+144 
+	#PRIXFAST8
+ "X"
+
+	)
+
+145 
+	#PRIXFAST16
+ 
+__PRIPTR_PREFIX
+ "X"
+
+	)
+
+146 
+	#PRIXFAST32
+ 
+__PRIPTR_PREFIX
+ "X"
+
+	)
+
+147 
+	#PRIXFAST64
+ 
+__PRI64_PREFIX
+ "X"
+
+	)
+
+151 
+	#PRIdMAX
+ 
+__PRI64_PREFIX
+ "d"
+
+	)
+
+152 
+	#PRIiMAX
+ 
+__PRI64_PREFIX
+ "i"
+
+	)
+
+153 
+	#PRIoMAX
+ 
+__PRI64_PREFIX
+ "o"
+
+	)
+
+154 
+	#PRIuMAX
+ 
+__PRI64_PREFIX
+ "u"
+
+	)
+
+155 
+	#PRIxMAX
+ 
+__PRI64_PREFIX
+ "x"
+
+	)
+
+156 
+	#PRIXMAX
+ 
+__PRI64_PREFIX
+ "X"
+
+	)
+
+160 
+	#PRIdPTR
+ 
+__PRIPTR_PREFIX
+ "d"
+
+	)
+
+161 
+	#PRIiPTR
+ 
+__PRIPTR_PREFIX
+ "i"
+
+	)
+
+162 
+	#PRIoPTR
+ 
+__PRIPTR_PREFIX
+ "o"
+
+	)
+
+163 
+	#PRIuPTR
+ 
+__PRIPTR_PREFIX
+ "u"
+
+	)
+
+164 
+	#PRIxPTR
+ 
+__PRIPTR_PREFIX
+ "x"
+
+	)
+
+165 
+	#PRIXPTR
+ 
+__PRIPTR_PREFIX
+ "X"
+
+	)
+
+171 
+	#SCNd8
+ "hhd"
+
+	)
+
+172 
+	#SCNd16
+ "hd"
+
+	)
+
+173 
+	#SCNd32
+ "d"
+
+	)
+
+174 
+	#SCNd64
+ 
+__PRI64_PREFIX
+ "d"
+
+	)
+
+176 
+	#SCNdLEAST8
+ "hhd"
+
+	)
+
+177 
+	#SCNdLEAST16
+ "hd"
+
+	)
+
+178 
+	#SCNdLEAST32
+ "d"
+
+	)
+
+179 
+	#SCNdLEAST64
+ 
+__PRI64_PREFIX
+ "d"
+
+	)
+
+181 
+	#SCNdFAST8
+ "hhd"
+
+	)
+
+182 
+	#SCNdFAST16
+ 
+__PRIPTR_PREFIX
+ "d"
+
+	)
+
+183 
+	#SCNdFAST32
+ 
+__PRIPTR_PREFIX
+ "d"
+
+	)
+
+184 
+	#SCNdFAST64
+ 
+__PRI64_PREFIX
+ "d"
+
+	)
+
+187 
+	#SCNi8
+ "hhi"
+
+	)
+
+188 
+	#SCNi16
+ "hi"
+
+	)
+
+189 
+	#SCNi32
+ "i"
+
+	)
+
+190 
+	#SCNi64
+ 
+__PRI64_PREFIX
+ "i"
+
+	)
+
+192 
+	#SCNiLEAST8
+ "hhi"
+
+	)
+
+193 
+	#SCNiLEAST16
+ "hi"
+
+	)
+
+194 
+	#SCNiLEAST32
+ "i"
+
+	)
+
+195 
+	#SCNiLEAST64
+ 
+__PRI64_PREFIX
+ "i"
+
+	)
+
+197 
+	#SCNiFAST8
+ "hhi"
+
+	)
+
+198 
+	#SCNiFAST16
+ 
+__PRIPTR_PREFIX
+ "i"
+
+	)
+
+199 
+	#SCNiFAST32
+ 
+__PRIPTR_PREFIX
+ "i"
+
+	)
+
+200 
+	#SCNiFAST64
+ 
+__PRI64_PREFIX
+ "i"
+
+	)
+
+203 
+	#SCNu8
+ "hhu"
+
+	)
+
+204 
+	#SCNu16
+ "hu"
+
+	)
+
+205 
+	#SCNu32
+ "u"
+
+	)
+
+206 
+	#SCNu64
+ 
+__PRI64_PREFIX
+ "u"
+
+	)
+
+208 
+	#SCNuLEAST8
+ "hhu"
+
+	)
+
+209 
+	#SCNuLEAST16
+ "hu"
+
+	)
+
+210 
+	#SCNuLEAST32
+ "u"
+
+	)
+
+211 
+	#SCNuLEAST64
+ 
+__PRI64_PREFIX
+ "u"
+
+	)
+
+213 
+	#SCNuFAST8
+ "hhu"
+
+	)
+
+214 
+	#SCNuFAST16
+ 
+__PRIPTR_PREFIX
+ "u"
+
+	)
+
+215 
+	#SCNuFAST32
+ 
+__PRIPTR_PREFIX
+ "u"
+
+	)
+
+216 
+	#SCNuFAST64
+ 
+__PRI64_PREFIX
+ "u"
+
+	)
+
+219 
+	#SCNo8
+ "hho"
+
+	)
+
+220 
+	#SCNo16
+ "ho"
+
+	)
+
+221 
+	#SCNo32
+ "o"
+
+	)
+
+222 
+	#SCNo64
+ 
+__PRI64_PREFIX
+ "o"
+
+	)
+
+224 
+	#SCNoLEAST8
+ "hho"
+
+	)
+
+225 
+	#SCNoLEAST16
+ "ho"
+
+	)
+
+226 
+	#SCNoLEAST32
+ "o"
+
+	)
+
+227 
+	#SCNoLEAST64
+ 
+__PRI64_PREFIX
+ "o"
+
+	)
+
+229 
+	#SCNoFAST8
+ "hho"
+
+	)
+
+230 
+	#SCNoFAST16
+ 
+__PRIPTR_PREFIX
+ "o"
+
+	)
+
+231 
+	#SCNoFAST32
+ 
+__PRIPTR_PREFIX
+ "o"
+
+	)
+
+232 
+	#SCNoFAST64
+ 
+__PRI64_PREFIX
+ "o"
+
+	)
+
+235 
+	#SCNx8
+ "hhx"
+
+	)
+
+236 
+	#SCNx16
+ "hx"
+
+	)
+
+237 
+	#SCNx32
+ "x"
+
+	)
+
+238 
+	#SCNx64
+ 
+__PRI64_PREFIX
+ "x"
+
+	)
+
+240 
+	#SCNxLEAST8
+ "hhx"
+
+	)
+
+241 
+	#SCNxLEAST16
+ "hx"
+
+	)
+
+242 
+	#SCNxLEAST32
+ "x"
+
+	)
+
+243 
+	#SCNxLEAST64
+ 
+__PRI64_PREFIX
+ "x"
+
+	)
+
+245 
+	#SCNxFAST8
+ "hhx"
+
+	)
+
+246 
+	#SCNxFAST16
+ 
+__PRIPTR_PREFIX
+ "x"
+
+	)
+
+247 
+	#SCNxFAST32
+ 
+__PRIPTR_PREFIX
+ "x"
+
+	)
+
+248 
+	#SCNxFAST64
+ 
+__PRI64_PREFIX
+ "x"
+
+	)
+
+252 
+	#SCNdMAX
+ 
+__PRI64_PREFIX
+ "d"
+
+	)
+
+253 
+	#SCNiMAX
+ 
+__PRI64_PREFIX
+ "i"
+
+	)
+
+254 
+	#SCNoMAX
+ 
+__PRI64_PREFIX
+ "o"
+
+	)
+
+255 
+	#SCNuMAX
+ 
+__PRI64_PREFIX
+ "u"
+
+	)
+
+256 
+	#SCNxMAX
+ 
+__PRI64_PREFIX
+ "x"
+
+	)
+
+259 
+	#SCNdPTR
+ 
+__PRIPTR_PREFIX
+ "d"
+
+	)
+
+260 
+	#SCNiPTR
+ 
+__PRIPTR_PREFIX
+ "i"
+
+	)
+
+261 
+	#SCNoPTR
+ 
+__PRIPTR_PREFIX
+ "o"
+
+	)
+
+262 
+	#SCNuPTR
+ 
+__PRIPTR_PREFIX
+ "u"
+
+	)
+
+263 
+	#SCNxPTR
+ 
+__PRIPTR_PREFIX
+ "x"
+
+	)
+
+266 
+	g__BEGIN_DECLS
+
+
+268 #i
+__WORDSIZE
+ == 64
+
+273 
+	mqu
+;
+
+274 
+	mm
+;
+
+275 } 
+	timaxdiv_t
+;
+
+282 
+__exnsi__
+ 
+	mqu
+;
+
+283 
+__exnsi__
+ 
+	mm
+;
+
+284 } 
+	timaxdiv_t
+;
+
+290 
+tmax_t
+ 
+	$imaxabs
+ (
+tmax_t
+ 
+__n
+
+__THROW
+ 
+	`__ibu__
+ ((
+__c__
+));
+
+293 
+imaxdiv_t
+ 
+	$imaxdiv
+ (
+tmax_t
+ 
+__num
+, imax_
+__dom
+)
+
+294 
+__THROW
+ 
+	`__ibu__
+ ((
+__c__
+));
+
+297 
+tmax_t
+ 
+	$oimax
+ (c *
+__ri
+ 
+__
+,
+
+298 **
+__ri
+ 
+__dr
+, 
+__ba
+
+__THROW
+;
+
+301 
+utmax_t
+ 
+	$oumax
+ (c *
+__ri
+ 
+__
+,
+
+302 ** 
+__ri
+ 
+__dr
+, 
+__ba
+
+__THROW
+;
+
+305 
+tmax_t
+ 
+	$wcoimax
+ (c 
+__gwch_t
+ *
+__ri
+ 
+__
+,
+
+306 
+__gwch_t
+ **
+__ri
+ 
+__dr
+, 
+__ba
+)
+
+307 
+__THROW
+;
+
+310 
+utmax_t
+ 
+	$wcoumax
+ (c 
+__gwch_t
+ *
+__ri
+ 
+__
+,
+
+311 
+__gwch_t
+ ** 
+__ri
+ 
+__dr
+, 
+__ba
+)
+
+312 
+__THROW
+;
+
+314 #ifde
+__USE_EXTERN_INLINES
+
+
+316 #i
+__WORDSIZE
+ == 64
+
+318 
+	$___
+ (c *
+__ri
+ 
+__
+,
+
+319 **
+__ri
+ 
+__dr
+,
+
+320 
+__ba
+, 
+__group
+)
+
+321 
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+323 
+__ex_le
+ 
+tmax_t
+
+
+324 
+	`__NTH
+ (
+	$oimax
+ (c *
+__ri
+ 
+
+, **__ri 
+dr
+,
+
+325 
+ba
+))
+
+327  
+	`___
+ (
+
+, 
+dr
+, 
+ba
+, 0);
+
+328 
+	}
+}
+
+330 
+	$__oul_
+ (c *
+__ri
+ 
+__
+,
+
+331 ** 
+__ri
+ 
+__dr
+,
+
+332 
+__ba
+, 
+__group
+)
+
+333 
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+335 
+__ex_le
+ 
+utmax_t
+
+
+336 
+	`__NTH
+ (
+	$oumax
+ (c *
+__ri
+ 
+
+, **__ri 
+dr
+,
+
+337 
+ba
+))
+
+339  
+	`__oul_
+ (
+
+, 
+dr
+, 
+ba
+, 0);
+
+340 
+	}
+}
+
+342 
+	$__wc_
+ (c 
+__gwch_t
+ * 
+__ri
+ 
+__
+,
+
+343 
+__gwch_t
+ **
+__ri
+ 
+__dr
+,
+
+344 
+__ba
+, 
+__group
+)
+
+345 
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+347 
+__ex_le
+ 
+tmax_t
+
+
+348 
+	`__NTH
+ (
+	$wcoimax
+ (c 
+__gwch_t
+ *
+__ri
+ 
+
+,
+
+349 
+__gwch_t
+ **
+__ri
+ 
+dr
+, 
+ba
+))
+
+351  
+	`__wc_
+ (
+
+, 
+dr
+, 
+ba
+, 0);
+
+352 
+	}
+}
+
+354 
+	$__wcoul_
+ (c 
+__gwch_t
+ *
+
+355 
+__ri
+ 
+__
+,
+
+356 
+__gwch_t
+ **
+
+357 
+__ri
+ 
+__dr
+,
+
+358 
+__ba
+, 
+__group
+)
+
+359 
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+361 
+__ex_le
+ 
+utmax_t
+
+
+362 
+	`__NTH
+ (
+	$wcoumax
+ (c 
+__gwch_t
+ *
+__ri
+ 
+
+,
+
+363 
+__gwch_t
+ **
+__ri
+ 
+dr
+, 
+ba
+))
+
+365  
+	`__wcoul_
+ (
+
+, 
+dr
+, 
+ba
+, 0);
+
+366 
+	}
+}
+
+370 
+__exnsi__
+
+
+371 
+	$__l_
+ (c *
+__ri
+ 
+__
+,
+
+372 **
+__ri
+ 
+__dr
+,
+
+373 
+__ba
+, 
+__group
+)
+
+374 
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+376 
+__ex_le
+ 
+tmax_t
+
+
+377 
+	`__NTH
+ (
+	$oimax
+ (c *
+__ri
+ 
+
+, **__ri 
+dr
+,
+
+378 
+ba
+))
+
+380  
+	`__l_
+ (
+
+, 
+dr
+, 
+ba
+, 0);
+
+381 
+	}
+}
+
+383 
+__exnsi__
+
+
+384 
+	$__ou_
+ (const *
+
+385 
+__ri
+ 
+__
+,
+
+387 
+__ri
+ 
+__dr
+,
+
+388 
+__ba
+,
+
+389 
+__group
+)
+
+390 
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+392 
+__ex_le
+ 
+utmax_t
+
+
+393 
+	`__NTH
+ (
+	$oumax
+ (c *
+__ri
+ 
+
+, **__ri 
+dr
+,
+
+394 
+ba
+))
+
+396  
+	`__ou_
+ (
+
+, 
+dr
+, 
+ba
+, 0);
+
+397 
+	}
+}
+
+399 
+__exnsi__
+
+
+400 
+	$__wcl_
+ (c 
+__gwch_t
+ *
+__ri
+ 
+__
+,
+
+401 
+__gwch_t
+ **
+__ri
+ 
+__dr
+,
+
+402 
+__ba
+, 
+__group
+)
+
+403 
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+405 
+__ex_le
+ 
+tmax_t
+
+
+406 
+	`__NTH
+ (
+	$wcoimax
+ (c 
+__gwch_t
+ *
+__ri
+ 
+
+,
+
+407 
+__gwch_t
+ **
+__ri
+ 
+dr
+, 
+ba
+))
+
+409  
+	`__wcl_
+ (
+
+, 
+dr
+, 
+ba
+, 0);
+
+410 
+	}
+}
+
+413 
+__exnsi__
+
+
+414 
+	$__wcou_
+ (c 
+__gwch_t
+ *
+
+415 
+__ri
+ 
+__
+,
+
+416 
+__gwch_t
+ **
+
+417 
+__ri
+ 
+__dr
+,
+
+418 
+__ba
+,
+
+419 
+__group
+)
+
+420 
+__THROW
+ 
+	`__nnu
+ ((1)
+__wur
+;
+
+422 
+__ex_le
+ 
+utmax_t
+
+
+423 
+	`__NTH
+ (
+	$wcoumax
+ (c 
+__gwch_t
+ *
+__ri
+ 
+
+,
+
+424 
+__gwch_t
+ **
+__ri
+ 
+dr
+, 
+ba
+))
+
+426  
+	`__wcou_
+ (
+
+, 
+dr
+, 
+ba
+, 0);
+
+427 
+	}
+}
+
+432 
+	g__END_DECLS
+
+
+	@/usr/include/libio.h
+
+28 #ide
+_IO_STDIO_H
+
+
+29 
+	#_IO_STDIO_H
+
+
+	)
+
+31 
+	~<_G_cfig.h
+>
+
+33 
+	#_IO_os_t
+ 
+_G_os_t
+
+
+	)
+
+34 
+	#_IO_os64_t
+ 
+_G_os64_t
+
+
+	)
+
+35 
+	#_IO_size_t
+ 
+size_t
+
+
+	)
+
+36 
+	#_IO_ssize_t
+ 
+__ssize_t
+
+
+	)
+
+37 
+	#_IO_off_t
+ 
+__off_t
+
+
+	)
+
+38 
+	#_IO_off64_t
+ 
+__off64_t
+
+
+	)
+
+39 
+	#_IO_pid_t
+ 
+__pid_t
+
+
+	)
+
+40 
+	#_IO_uid_t
+ 
+__uid_t
+
+
+	)
+
+41 
+	#_IO_icv_t
+ 
+_G_icv_t
+
+
+	)
+
+42 
+	#_IO_HAVE_ST_BLKSIZE
+ 
+_G_HAVE_ST_BLKSIZE
+
+
+	)
+
+43 
+	#_IO_BUFSIZ
+ 
+_G_BUFSIZ
+
+
+	)
+
+44 
+	#_IO_va_li
+ 
+_G_va_li
+
+
+	)
+
+45 
+	#_IO_wt_t
+ 
+wt_t
+
+
+	)
+
+48 
+	#__ed___va_li
+
+
+	)
+
+49 
+	~<dg.h
+>
+
+50 #ifde
+__GNUC_VA_LIST
+
+
+51 #unde
+_IO_va_li
+
+
+52 
+	#_IO_va_li
+ 
+__gnuc_va_li
+
+
+	)
+
+55 #ide
+__P
+
+
+56 
+	~<sys/cdefs.h
+>
+
+59 
+	#_IO_UNIFIED_JUMPTABLES
+ 1
+
+	)
+
+61 #ide
+EOF
+
+
+62 
+	#EOF
+ (-1)
+
+	)
+
+64 #ide
+NULL
+
+
+65 #i
+defed
+ 
+__GNUG__
+ && \
+
+66 (
+	g__GNUC__
+ > 2 || (__GNUC__ =2 && 
+__GNUC_MINOR__
+ >= 8))
+
+67 
+	#NULL
+ (
+__nu
+)
+
+	)
+
+69 #i!
+defed
+(
+__lulus
+)
+
+70 
+	#NULL
+ ((*)0)
+
+	)
+
+72 
+	#NULL
+ (0)
+
+	)
+
+77 
+	#_IOS_INPUT
+ 1
+
+	)
+
+78 
+	#_IOS_OUTPUT
+ 2
+
+	)
+
+79 
+	#_IOS_ATEND
+ 4
+
+	)
+
+80 
+	#_IOS_APPEND
+ 8
+
+	)
+
+81 
+	#_IOS_TRUNC
+ 16
+
+	)
+
+82 
+	#_IOS_NOCREATE
+ 32
+
+	)
+
+83 
+	#_IOS_NOREPLACE
+ 64
+
+	)
+
+84 
+	#_IOS_BIN
+ 128
+
+	)
+
+92 
+	#_IO_MAGIC
+ 0xFBAD0000
+
+	)
+
+93 
+	#_OLD_STDIO_MAGIC
+ 0xFABC0000
+
+	)
+
+94 
+	#_IO_MAGIC_MASK
+ 0xFFFF0000
+
+	)
+
+95 
+	#_IO_USER_BUF
+ 1
+
+	)
+
+96 
+	#_IO_UNBUFFERED
+ 2
+
+	)
+
+97 
+	#_IO_NO_READS
+ 4
+
+	)
+
+98 
+	#_IO_NO_WRITES
+ 8
+
+	)
+
+99 
+	#_IO_EOF_SEEN
+ 0x10
+
+	)
+
+100 
+	#_IO_ERR_SEEN
+ 0x20
+
+	)
+
+101 
+	#_IO_DELETE_DONT_CLOSE
+ 0x40
+
+	)
+
+102 
+	#_IO_LINKED
+ 0x80
+
+	)
+
+103 
+	#_IO_IN_BACKUP
+ 0x100
+
+	)
+
+104 
+	#_IO_LINE_BUF
+ 0x200
+
+	)
+
+105 
+	#_IO_TIED_PUT_GET
+ 0x400
+
+	)
+
+106 
+	#_IO_CURRENTLY_PUTTING
+ 0x800
+
+	)
+
+107 
+	#_IO_IS_APPENDING
+ 0x1000
+
+	)
+
+108 
+	#_IO_IS_FILEBUF
+ 0x2000
+
+	)
+
+109 
+	#_IO_BAD_SEEN
+ 0x4000
+
+	)
+
+110 
+	#_IO_USER_LOCK
+ 0x8000
+
+	)
+
+112 
+	#_IO_FLAGS2_MMAP
+ 1
+
+	)
+
+113 
+	#_IO_FLAGS2_NOTCANCEL
+ 2
+
+	)
+
+114 #ifde
+_LIBC
+
+
+115 
+	#_IO_FLAGS2_FORTIFY
+ 4
+
+	)
+
+117 
+	#_IO_FLAGS2_USER_WBUF
+ 8
+
+	)
+
+118 #ifde
+_LIBC
+
+
+119 
+	#_IO_FLAGS2_SCANF_STD
+ 16
+
+	)
+
+120 
+	#_IO_FLAGS2_NOCLOSE
+ 32
+
+	)
+
+121 
+	#_IO_FLAGS2_CLOEXEC
+ 64
+
+	)
+
+125 
+	#_IO_SKIPWS
+ 01
+
+	)
+
+126 
+	#_IO_LEFT
+ 02
+
+	)
+
+127 
+	#_IO_RIGHT
+ 04
+
+	)
+
+128 
+	#_IO_INTERNAL
+ 010
+
+	)
+
+129 
+	#_IO_DEC
+ 020
+
+	)
+
+130 
+	#_IO_OCT
+ 040
+
+	)
+
+131 
+	#_IO_HEX
+ 0100
+
+	)
+
+132 
+	#_IO_SHOWBASE
+ 0200
+
+	)
+
+133 
+	#_IO_SHOWPOINT
+ 0400
+
+	)
+
+134 
+	#_IO_UPPERCASE
+ 01000
+
+	)
+
+135 
+	#_IO_SHOWPOS
+ 02000
+
+	)
+
+136 
+	#_IO_SCIENTIFIC
+ 04000
+
+	)
+
+137 
+	#_IO_FIXED
+ 010000
+
+	)
+
+138 
+	#_IO_UNITBUF
+ 020000
+
+	)
+
+139 
+	#_IO_STDIO
+ 040000
+
+	)
+
+140 
+	#_IO_DONT_CLOSE
+ 0100000
+
+	)
+
+141 
+	#_IO_BOOLALPHA
+ 0200000
+
+	)
+
+144 
+_IO_jump_t
+; 
+	g_IO_FILE
+;
+
+147 #ifde
+_IO_MTSAFE_IO
+
+
+148 #i
+defed
+ 
+__GLIBC__
+ && __GLIBC__ >= 2
+
+149 
+	~<bs/dio-lock.h
+>
+
+154 
+	t_IO_lock_t
+;
+
+160 
+	s_IO_mk
+ {
+
+161 
+_IO_mk
+ *
+	m_xt
+;
+
+162 
+_IO_FILE
+ *
+	m_sbuf
+;
+
+166 
+	m_pos
+;
+
+168 
+t_ampos
+(
+ampos
+ 
+
+{ 
+	m_os
+ = sp; }
+
+169 
+t_offt
+(
+offt
+{ 
+	m_pos
+ = offt; 
+	m_os
+ = (
+ampos
+)(-2); }
+
+170 
+	mpublic
+:
+
+171 
+ammk
+(
+ambuf
+ *
+sb
+);
+
+172 ~
+ammk
+();
+
+173 
+vg
+({  
+	m_os
+ == -2; }
+
+174 
+d
+(
+ammk
+&);
+
+175 
+d
+();
+
+180 
+	e__codecvt_su
+
+
+182 
+	m__codecvt_ok
+,
+
+183 
+	m__codecvt_l
+,
+
+184 
+	m__codecvt_r
+,
+
+185 
+	m__codecvt_nocv
+
+
+188 #i
+defed
+ 
+_LIBC
+ || defed 
+_GLIBCPP_USE_WCHAR_T
+
+
+191 
+	s_IO_codecvt
+
+
+193 (*
+	m__codecvt_der
+(
+	m_IO_codecvt
+ *);
+
+194 
+__codecvt_su
+ (*
+__codecvt_do_out
+(
+	m_IO_codecvt
+ *,
+
+195 
+	m__mbe_t
+ *,
+
+196 c 
+	mwch_t
+ *,
+
+197 c 
+	mwch_t
+ *,
+
+198 c 
+	mwch_t
+ **, *,
+
+200 
+__codecvt_su
+ (*
+__codecvt_do_unshi
+(
+	m_IO_codecvt
+ *,
+
+201 
+	m__mbe_t
+ *, *,
+
+203 
+__codecvt_su
+ (*
+__codecvt_do_
+(
+	m_IO_codecvt
+ *,
+
+204 
+	m__mbe_t
+ *,
+
+206 c **, 
+	mwch_t
+ *,
+
+207 
+	mwch_t
+ *, wchar_t **);
+
+208 (*
+	m__codecvt_do_codg
+(
+	m_IO_codecvt
+ *);
+
+209 (*
+	m__codecvt_do_ways_nocv
+(
+	m_IO_codecvt
+ *);
+
+210 (*
+	m__codecvt_do_ngth
+(
+	m_IO_codecvt
+ *, 
+	m__mbe_t
+ *,
+
+211 c *, c *, 
+	m_IO_size_t
+);
+
+212 (*
+	m__codecvt_do_max_ngth
+(
+	m_IO_codecvt
+ *);
+
+214 
+_IO_icv_t
+ 
+	m__cd_
+;
+
+215 
+_IO_icv_t
+ 
+	m__cd_out
+;
+
+219 
+	s_IO_wide_da
+
+
+221 
+wch_t
+ *
+	m_IO_ad_r
+;
+
+222 
+wch_t
+ *
+	m_IO_ad_d
+;
+
+223 
+wch_t
+ *
+	m_IO_ad_ba
+;
+
+224 
+wch_t
+ *
+	m_IO_wre_ba
+;
+
+225 
+wch_t
+ *
+	m_IO_wre_r
+;
+
+226 
+wch_t
+ *
+	m_IO_wre_d
+;
+
+227 
+wch_t
+ *
+	m_IO_buf_ba
+;
+
+228 
+wch_t
+ *
+	m_IO_buf_d
+;
+
+230 
+wch_t
+ *
+	m_IO_ve_ba
+;
+
+231 
+wch_t
+ *
+	m_IO_backup_ba
+;
+
+233 
+wch_t
+ *
+	m_IO_ve_d
+;
+
+235 
+__mbe_t
+ 
+	m_IO_e
+;
+
+236 
+__mbe_t
+ 
+	m_IO__e
+;
+
+237 
+_IO_codecvt
+ 
+	m_codecvt
+;
+
+239 
+wch_t
+ 
+	m_shtbuf
+[1];
+
+241 c 
+_IO_jump_t
+ *
+	m_wide_vb
+;
+
+245 
+	s_IO_FILE
+ {
+
+246 
+	m_ags
+;
+
+247 
+	#_IO_fe_ags
+ 
+_ags
+
+
+	)
+
+251 * 
+	m_IO_ad_r
+;
+
+252 * 
+	m_IO_ad_d
+;
+
+253 * 
+	m_IO_ad_ba
+;
+
+254 * 
+	m_IO_wre_ba
+;
+
+255 * 
+	m_IO_wre_r
+;
+
+256 * 
+	m_IO_wre_d
+;
+
+257 * 
+	m_IO_buf_ba
+;
+
+258 * 
+	m_IO_buf_d
+;
+
+260 *
+	m_IO_ve_ba
+;
+
+261 *
+	m_IO_backup_ba
+;
+
+262 *
+	m_IO_ve_d
+;
+
+264 
+_IO_mk
+ *
+	m_mks
+;
+
+266 
+_IO_FILE
+ *
+	m_cha
+;
+
+268 
+	m_fo
+;
+
+270 
+	m_blksize
+;
+
+272 
+	m_ags2
+;
+
+274 
+_IO_off_t
+ 
+	m_d_offt
+;
+
+276 
+	#__HAVE_COLUMN
+
+
+	)
+
+278 
+	m_cur_cumn
+;
+
+279 sigd 
+	m_vb_offt
+;
+
+280 
+	m_shtbuf
+[1];
+
+284 
+_IO_lock_t
+ *
+	m_lock
+;
+
+285 #ifde
+_IO_USE_OLD_IO_FILE
+
+
+288 
+	s_IO_FILE_come
+
+
+290 
+_IO_FILE
+ 
+	m_fe
+;
+
+292 #i
+defed
+ 
+_G_IO_IO_FILE_VERSION
+ && _G_IO_IO_FILE_VERSION == 0x20001
+
+293 
+_IO_off64_t
+ 
+	m_offt
+;
+
+294 #i
+defed
+ 
+_LIBC
+ || defed 
+_GLIBCPP_USE_WCHAR_T
+
+
+296 
+_IO_codecvt
+ *
+	m_codecvt
+;
+
+297 
+_IO_wide_da
+ *
+	m_wide_da
+;
+
+298 
+_IO_FILE
+ *
+	m_s_li
+;
+
+299 *
+	m_s_buf
+;
+
+300 
+size_t
+ 
+	m_s_size
+;
+
+302 *
+	m__d1
+;
+
+303 *
+	m__d2
+;
+
+304 *
+	m__d3
+;
+
+305 *
+	m__d4
+;
+
+306 
+size_t
+ 
+	m__d5
+;
+
+308 
+	m_mode
+;
+
+310 
+	m_unud2
+[15 *  (- 4 *  (*-  (
+size_t
+)];
+
+314 #ide
+__lulus
+
+
+315 
+_IO_FILE
+ 
+	t_IO_FILE
+;
+
+318 
+	g_IO_FILE_us
+;
+
+320 
+_IO_FILE_us
+ 
+_IO_2_1_d_
+;
+
+321 
+_IO_FILE_us
+ 
+_IO_2_1_dout_
+;
+
+322 
+_IO_FILE_us
+ 
+_IO_2_1_dr_
+;
+
+323 #ide
+_LIBC
+
+
+324 
+	#_IO_d
+ ((
+_IO_FILE
+*)(&
+_IO_2_1_d_
+))
+
+	)
+
+325 
+	#_IO_dout
+ ((
+_IO_FILE
+*)(&
+_IO_2_1_dout_
+))
+
+	)
+
+326 
+	#_IO_dr
+ ((
+_IO_FILE
+*)(&
+_IO_2_1_dr_
+))
+
+	)
+
+328 
+_IO_FILE
+ *
+_IO_d
+ 
+ibu_hidd
+;
+
+329 
+_IO_FILE
+ *
+_IO_dout
+ 
+ibu_hidd
+;
+
+330 
+_IO_FILE
+ *
+_IO_dr
+ 
+ibu_hidd
+;
+
+338 
+__ssize_t
+ 
+	t__io_ad_
+ (*
+	t__cook
+, *
+	t__buf
+, 
+	tsize_t
+ 
+	t__nbys
+);
+
+346 
+__ssize_t
+ 
+	t__io_wre_
+ (*
+	t__cook
+, c *
+	t__buf
+,
+
+347 
+	tsize_t
+ 
+	t__n
+);
+
+355 
+	t__io_ek_
+ (*
+	t__cook
+, 
+	t_IO_off64_t
+ *
+	t__pos
+, 
+	t__w
+);
+
+358 
+	t__io_o_
+ (*
+	t__cook
+);
+
+361 #ifde
+_GNU_SOURCE
+
+
+363 
+__io_ad_
+ 
+	tcook_ad_funi_t
+;
+
+364 
+__io_wre_
+ 
+	tcook_wre_funi_t
+;
+
+365 
+__io_ek_
+ 
+	tcook_ek_funi_t
+;
+
+366 
+__io_o_
+ 
+	tcook_o_funi_t
+;
+
+371 
+__io_ad_
+ *
+	mad
+;
+
+372 
+__io_wre_
+ *
+	mwre
+;
+
+373 
+__io_ek_
+ *
+	mek
+;
+
+374 
+__io_o_
+ *
+	mo
+;
+
+375 } 
+	t_IO_cook_io_funis_t
+;
+
+376 
+_IO_cook_io_funis_t
+ 
+	tcook_io_funis_t
+;
+
+378 
+	g_IO_cook_fe
+;
+
+381 
+_IO_cook_
+ (
+_IO_cook_fe
+ *
+__cfe
+, 
+__ad_wre
+,
+
+382 *
+__cook
+, 
+_IO_cook_io_funis_t
+ 
+__s
+);
+
+386 #ifde
+__lulus
+
+
+390 
+__undow
+ (
+_IO_FILE
+ *);
+
+391 
+__uow
+ (
+_IO_FILE
+ *);
+
+392 
+__ovow
+ (
+_IO_FILE
+ *, );
+
+393 #i
+defed
+ 
+_LIBC
+ || defed 
+_GLIBCPP_USE_WCHAR_T
+
+
+394 
+_IO_wt_t
+ 
+__wundow
+ (
+_IO_FILE
+ *);
+
+395 
+_IO_wt_t
+ 
+__wuow
+ (
+_IO_FILE
+ *);
+
+396 
+_IO_wt_t
+ 
+__wovow
+ (
+_IO_FILE
+ *, _IO_wint_t);
+
+399 #i 
+__GNUC__
+ >= 3
+
+400 
+	#_IO_BE
+(
+ex
+, 
+s
+
+	`__but_ex
+ (x),es)
+
+	)
+
+402 
+	#_IO_BE
+(
+ex
+, 
+s
+x)
+
+	)
+
+405 
+	#_IO_gc_uocked
+(
+_
+) \
+
+406 (
+	`_IO_BE
+ ((
+_
+)->
+_IO_ad_r
+ >(_)->
+_IO_ad_d
+, 0) \
+
+407 ? 
+	`__uow
+ (
+_
+: *(*(_)->
+_IO_ad_r
+++)
+
+	)
+
+408 
+	#_IO_ekc_uocked
+(
+_
+) \
+
+409 (
+	`_IO_BE
+ ((
+_
+)->
+_IO_ad_r
+ >(_)->
+_IO_ad_d
+, 0) \
+
+410 && 
+	`__undow
+ (
+_
+=
+EOF
+ ? EOF \
+
+411 : *(*(
+_
+)->
+_IO_ad_r
+)
+
+	)
+
+412 
+	#_IO_putc_uocked
+(
+_ch
+, 
+_
+) \
+
+413 (
+	`_IO_BE
+ ((
+_
+)->
+_IO_wre_r
+ >(_)->
+_IO_wre_d
+, 0) \
+
+414 ? 
+	`__ovow
+ (
+_
+, ((
+_ch
+)) \
+
+415 : ((*(
+_
+)->
+_IO_wre_r
+++ = (
+_ch
+)))
+
+	)
+
+417 #i
+defed
+ 
+_LIBC
+ || defed 
+_GLIBCPP_USE_WCHAR_T
+
+
+418 
+	#_IO_gwc_uocked
+(
+_
+) \
+
+419 (
+	`_IO_BE
+ ((
+_
+)->
+_wide_da
+ =
+NULL
+ \
+
+420 || ((
+_
+)->
+_wide_da
+->
+_IO_ad_r
+ \
+
+421 >(
+_
+)->
+_wide_da
+->
+_IO_ad_d
+), 0) \
+
+422 ? 
+	`__wuow
+ (
+_
+: (
+_IO_wt_t
+*(_)->
+_wide_da
+->
+_IO_ad_r
+++)
+
+	)
+
+423 
+	#_IO_putwc_uocked
+(
+_wch
+, 
+_
+) \
+
+424 (
+	`_IO_BE
+ ((
+_
+)->
+_wide_da
+ =
+NULL
+ \
+
+425 || ((
+_
+)->
+_wide_da
+->
+_IO_wre_r
+ \
+
+426 >(
+_
+)->
+_wide_da
+->
+_IO_wre_d
+), 0) \
+
+427 ? 
+	`__wovow
+ (
+_
+, 
+_wch
+) \
+
+428 : (
+_IO_wt_t
+(*(
+_
+)->
+_wide_da
+->
+_IO_wre_r
+++ = (
+_wch
+)))
+
+	)
+
+431 
+	#_IO_of_uocked
+(
+__
+(((__)->
+_ags
+ & 
+_IO_EOF_SEEN
+!0)
+
+	)
+
+432 
+	#_IO__uocked
+(
+__
+(((__)->
+_ags
+ & 
+_IO_ERR_SEEN
+!0)
+
+	)
+
+434 
+_IO_gc
+ (
+_IO_FILE
+ *
+__
+);
+
+435 
+_IO_putc
+ (
+__c
+, 
+_IO_FILE
+ *
+__
+);
+
+436 
+_IO_of
+ (
+_IO_FILE
+ *
+__
+
+__THROW
+;
+
+437 
+_IO_
+ (
+_IO_FILE
+ *
+__
+
+__THROW
+;
+
+439 
+_IO_ekc_locked
+ (
+_IO_FILE
+ *
+__
+);
+
+442 
+	#_IO_PENDING_OUTPUT_COUNT
+(
+_
+) \
+
+443 ((
+_
+)->
+_IO_wre_r
+ - (_)->
+_IO_wre_ba
+)
+
+	)
+
+445 
+_IO_ockfe
+ (
+_IO_FILE
+ *
+__THROW
+;
+
+446 
+_IO_fuockfe
+ (
+_IO_FILE
+ *
+__THROW
+;
+
+447 
+_IO_rylockfe
+ (
+_IO_FILE
+ *
+__THROW
+;
+
+449 #ifde
+_IO_MTSAFE_IO
+
+
+450 
+	#_IO_ekc
+(
+_
+
+	`_IO_ekc_locked
+ (_)
+
+	)
+
+451 
+	#_IO_ockfe
+(
+_
+) \
+
+452 i(((
+_
+)->
+_ags
+ & 
+_IO_USER_LOCK
+=0
+	`_IO_ockfe
+ (_)
+
+	)
+
+453 
+	#_IO_fuockfe
+(
+_
+) \
+
+454 i(((
+_
+)->
+_ags
+ & 
+_IO_USER_LOCK
+=0
+	`_IO_fuockfe
+ (_)
+
+	)
+
+456 
+	#_IO_ekc
+(
+_
+
+	`_IO_ekc_uocked
+ (_)
+
+	)
+
+457 
+	#_IO_ockfe
+(
+_
+
+
+	)
+
+458 
+	#_IO_fuockfe
+(
+_
+
+
+	)
+
+459 
+	#_IO_rylockfe
+(
+_
+
+
+	)
+
+460 
+	#_IO_nup_gi_t
+(
+_f
+, 
+_
+
+
+	)
+
+461 
+	#_IO_nup_gi_d
+(
+_Do
+
+
+	)
+
+464 
+_IO_vfsnf
+ (
+_IO_FILE
+ * 
+__ri
+, const * __restrict,
+
+465 
+_IO_va_li
+, *
+__ri
+);
+
+466 
+_IO_vrtf
+ (
+_IO_FILE
+ *
+__ri
+, const *__restrict,
+
+467 
+_IO_va_li
+);
+
+468 
+_IO_ssize_t
+ 
+_IO_dn
+ (
+_IO_FILE
+ *, , _IO_ssize_t);
+
+469 
+_IO_size_t
+ 
+_IO_sgn
+ (
+_IO_FILE
+ *, *, _IO_size_t);
+
+471 
+_IO_off64_t
+ 
+_IO_ekoff
+ (
+_IO_FILE
+ *, _IO_off64_t, , );
+
+472 
+_IO_off64_t
+ 
+_IO_ekpos
+ (
+_IO_FILE
+ *, _IO_off64_t, );
+
+474 
+_IO__backup_
+ (
+_IO_FILE
+ *
+__THROW
+;
+
+476 #i
+defed
+ 
+_LIBC
+ || defed 
+_GLIBCPP_USE_WCHAR_T
+
+
+477 
+_IO_wt_t
+ 
+_IO_gwc
+ (
+_IO_FILE
+ *
+__
+);
+
+478 
+_IO_wt_t
+ 
+_IO_putwc
+ (
+wch_t
+ 
+__wc
+, 
+_IO_FILE
+ *
+__
+);
+
+479 
+_IO_fwide
+ (
+_IO_FILE
+ *
+__
+, 
+__mode
+
+__THROW
+;
+
+480 #i
+__GNUC__
+ >= 2
+
+483 #i
+defed
+ 
+_LIBC
+ && defed 
+SHARED
+
+
+484 
+	~<shlib-comt.h
+>
+
+485 #i
+SHLIB_COMPAT
+ (
+libc
+, 
+GLIBC_2_0
+, 
+GLIBC_2_1
+)
+
+486 
+	#_IO_fwide_maybe_comtib
+ \
+
+487 (
+	`__but_ex
+ (&
+_IO_d_ud
+ =
+NULL
+, 0))
+
+	)
+
+488 c 
+_IO_d_ud
+;
+
+489 
+wk_ex
+ (
+_IO_d_ud
+);
+
+492 #ide
+_IO_fwide_maybe_comtib
+
+
+493 
+	#_IO_fwide_maybe_comtib
+ (0)
+
+	)
+
+497 
+	#_IO_fwide
+(
+__
+, 
+__mode
+) \
+
+498 ({ 
+__su
+ = (
+__mode
+); \
+
+499 i(
+__su
+ < 0 && ! 
+_IO_fwide_maybe_comtib
+) \
+
+501 i((
+__
+)->
+_mode
+ == 0) \
+
+503 (
+__
+)->
+_mode
+ = -1; \
+
+504 
+__su
+ = (
+__
+)->
+_mode
+; \
+
+506 i(
+	`__but_ct_p
+ (
+__mode
+) && (__mode) == 0) \
+
+507 
+__su
+ = 
+_IO_fwide_maybe_comtib
+ ? -1 : (
+__
+)->
+_mode
+; \
+
+509 
+__su
+ = 
+	`_IO_fwide
+ (
+__
+, __result); \
+
+510 
+__su
+; })
+
+	)
+
+513 
+_IO_vfwsnf
+ (
+_IO_FILE
+ * 
+__ri
+, c 
+wch_t
+ * __restrict,
+
+514 
+_IO_va_li
+, *
+__ri
+);
+
+515 
+_IO_vfwtf
+ (
+_IO_FILE
+ *
+__ri
+, c 
+wch_t
+ *__restrict,
+
+516 
+_IO_va_li
+);
+
+517 
+_IO_ssize_t
+ 
+_IO_wdn
+ (
+_IO_FILE
+ *, 
+wt_t
+, _IO_ssize_t);
+
+518 
+_IO__wbackup_
+ (
+_IO_FILE
+ *
+__THROW
+;
+
+521 #ifde
+__LDBL_COMPAT
+
+
+522 
+	~<bs/libio-ldbl.h
+>
+
+525 #ifde
+__lulus
+
+
+	@/usr/include/linux/atalk.h
+
+1 #ide
+__LINUX_ATALK_H__
+
+
+2 
+	#__LINUX_ATALK_H__
+
+
+	)
+
+4 
+	~<lux/tys.h
+>
+
+5 
+	~<asm/byd.h
+>
+
+6 
+	~<lux/sock.h
+>
+
+14 
+	#ATPORT_FIRST
+ 1
+
+	)
+
+15 
+	#ATPORT_RESERVED
+ 128
+
+	)
+
+16 
+	#ATPORT_LAST
+ 254
+
+	)
+
+17 
+	#ATADDR_ANYNET
+ (
+__u16
+)0
+
+	)
+
+18 
+	#ATADDR_ANYNODE
+ (
+__u8
+)0
+
+	)
+
+19 
+	#ATADDR_ANYPORT
+ (
+__u8
+)0
+
+	)
+
+20 
+	#ATADDR_BCAST
+ (
+__u8
+)255
+
+	)
+
+21 
+	#DDP_MAXSZ
+ 587
+
+	)
+
+22 
+	#DDP_MAXHOPS
+ 15
+
+	)
+
+24 
+	#SIOCATALKDIFADDR
+ (
+SIOCPROTOPRIVATE
+ + 0)
+
+	)
+
+26 
+	sk_addr
+ {
+
+27 
+__be16
+ 
+	ms_t
+;
+
+28 
+__u8
+ 
+	ms_node
+;
+
+31 
+	ssockaddr_
+ {
+
+32 
+__kl__my_t
+ 
+	mt_my
+;
+
+33 
+__u8
+ 
+	mt_pt
+;
+
+34 
+k_addr
+ 
+	mt_addr
+;
+
+35 
+	mt_zo
+[8];
+
+38 
+	sk_ge
+ {
+
+39 
+__u8
+ 
+	m_pha
+;
+
+40 
+__be16
+ 
+	m_ft
+;
+
+41 
+__be16
+ 
+	m_t
+;
+
+	@/usr/include/linux/ppp-comp.h
+
+10 #ide
+_NET_PPP_COMP_H
+
+
+11 
+	#_NET_PPP_COMP_H
+
+
+	)
+
+18 
+	#CCP_CONFREQ
+ 1
+
+	)
+
+19 
+	#CCP_CONFACK
+ 2
+
+	)
+
+20 
+	#CCP_TERMREQ
+ 5
+
+	)
+
+21 
+	#CCP_TERMACK
+ 6
+
+	)
+
+22 
+	#CCP_RESETREQ
+ 14
+
+	)
+
+23 
+	#CCP_RESETACK
+ 15
+
+	)
+
+29 
+	#CCP_MAX_OPTION_LENGTH
+ 32
+
+	)
+
+35 
+	#CCP_CODE
+(
+dp
+((dp)[0])
+
+	)
+
+36 
+	#CCP_ID
+(
+dp
+((dp)[1])
+
+	)
+
+37 
+	#CCP_LENGTH
+(
+dp
+(((dp)[2] << 8+ (dp)[3])
+
+	)
+
+38 
+	#CCP_HDRLEN
+ 4
+
+	)
+
+40 
+	#CCP_OPT_CODE
+(
+dp
+((dp)[0])
+
+	)
+
+41 
+	#CCP_OPT_LENGTH
+(
+dp
+((dp)[1])
+
+	)
+
+42 
+	#CCP_OPT_MINLEN
+ 2
+
+	)
+
+48 
+	#CI_BSD_COMPRESS
+ 21
+
+	)
+
+49 
+	#CILEN_BSD_COMPRESS
+ 3
+
+	)
+
+52 
+	#BSD_NBITS
+(
+x
+((x& 0x1F
+
+	)
+
+53 
+	#BSD_VERSION
+(
+x
+((x>> 5
+
+	)
+
+54 
+	#BSD_CURRENT_VERSION
+ 1
+
+	)
+
+55 
+	#BSD_MAKE_OPT
+(
+v
+, 
+n
+(((v<< 5| (n))
+
+	)
+
+57 
+	#BSD_MIN_BITS
+ 9
+
+	)
+
+58 
+	#BSD_MAX_BITS
+ 15
+
+	)
+
+64 
+	#CI_DEFLATE
+ 26
+
+	)
+
+65 
+	#CI_DEFLATE_DRAFT
+ 24
+
+	)
+
+66 
+	#CILEN_DEFLATE
+ 4
+
+	)
+
+68 
+	#DEFLATE_MIN_SIZE
+ 9
+
+	)
+
+69 
+	#DEFLATE_MAX_SIZE
+ 15
+
+	)
+
+70 
+	#DEFLATE_METHOD_VAL
+ 8
+
+	)
+
+71 
+	#DEFLATE_SIZE
+(
+x
+(((x>> 4+ 8)
+
+	)
+
+72 
+	#DEFLATE_METHOD
+(
+x
+((x& 0x0F)
+
+	)
+
+73 
+	#DEFLATE_MAKE_OPT
+(
+w
+((((w- 8<< 4+ 
+DEFLATE_METHOD_VAL
+)
+
+	)
+
+74 
+	#DEFLATE_CHK_SEQUENCE
+ 0
+
+	)
+
+80 
+	#CI_MPPE
+ 18
+
+	)
+
+81 
+	#CILEN_MPPE
+ 6
+
+	)
+
+87 
+	#CI_PREDICTOR_1
+ 1
+
+	)
+
+88 
+	#CILEN_PREDICTOR_1
+ 2
+
+	)
+
+89 
+	#CI_PREDICTOR_2
+ 2
+
+	)
+
+90 
+	#CILEN_PREDICTOR_2
+ 2
+
+	)
+
+	@/usr/include/linux/ppp_defs.h
+
+10 
+	~<lux/tys.h
+>
+
+12 #ide
+_PPP_DEFS_H_
+
+
+13 
+	#_PPP_DEFS_H_
+
+
+	)
+
+18 
+	#PPP_HDRLEN
+ 4
+
+	)
+
+19 
+	#PPP_FCSLEN
+ 2
+
+	)
+
+20 
+	#PPP_MRU
+ 1500
+
+	)
+
+22 
+	#PPP_ADDRESS
+(
+p
+(((
+__u8
+ *)))[0])
+
+	)
+
+23 
+	#PPP_CONTROL
+(
+p
+(((
+__u8
+ *)))[1])
+
+	)
+
+24 
+	#PPP_PROTOCOL
+(
+p
+((((
+__u8
+ *)))[2] << 8+ ((__u8 *)))[3])
+
+	)
+
+29 
+	#PPP_ALLSTATIONS
+ 0xf
+
+	)
+
+30 
+	#PPP_UI
+ 0x03
+
+	)
+
+31 
+	#PPP_FLAG
+ 0x7
+
+	)
+
+32 
+	#PPP_ESCAPE
+ 0x7d
+
+	)
+
+33 
+	#PPP_TRANS
+ 0x20
+
+	)
+
+38 
+	#PPP_IP
+ 0x21
+
+	)
+
+39 
+	#PPP_AT
+ 0x29
+
+	)
+
+40 
+	#PPP_IPX
+ 0x2b
+
+	)
+
+41 
+	#PPP_VJC_COMP
+ 0x2d
+
+	)
+
+42 
+	#PPP_VJC_UNCOMP
+ 0x2
+
+	)
+
+43 
+	#PPP_MP
+ 0x3d
+
+	)
+
+44 
+	#PPP_IPV6
+ 0x57
+
+	)
+
+45 
+	#PPP_COMPFRAG
+ 0xfb
+
+	)
+
+46 
+	#PPP_COMP
+ 0xfd
+
+	)
+
+47 
+	#PPP_MPLS_UC
+ 0x0281
+
+	)
+
+48 
+	#PPP_MPLS_MC
+ 0x0283
+
+	)
+
+49 
+	#PPP_IPCP
+ 0x8021
+
+	)
+
+50 
+	#PPP_ATCP
+ 0x8029
+
+	)
+
+51 
+	#PPP_IPXCP
+ 0x802b
+
+	)
+
+52 
+	#PPP_IPV6CP
+ 0x8057
+
+	)
+
+53 
+	#PPP_CCPFRAG
+ 0x80fb
+
+	)
+
+54 
+	#PPP_CCP
+ 0x80fd
+
+	)
+
+55 
+	#PPP_MPLSCP
+ 0x80fd
+
+	)
+
+56 
+	#PPP_LCP
+ 0xc021
+
+	)
+
+57 
+	#PPP_PAP
+ 0xc023
+
+	)
+
+58 
+	#PPP_LQR
+ 0xc025
+
+	)
+
+59 
+	#PPP_CHAP
+ 0xc223
+
+	)
+
+60 
+	#PPP_CBCP
+ 0xc029
+
+	)
+
+66 
+	#PPP_INITFCS
+ 0xfff
+
+	)
+
+67 
+	#PPP_GOODFCS
+ 0xf0b8
+
+	)
+
+74 
+__u32
+ 
+	text_accm
+[8];
+
+79 
+	eNPmode
+ {
+
+80 
+	mNPMODE_PASS
+,
+
+81 
+	mNPMODE_DROP
+,
+
+82 
+	mNPMODE_ERROR
+,
+
+83 
+	mNPMODE_QUEUE
+
+
+89 
+	sp
+ {
+
+90 
+__u32
+ 
+	mp_disrds
+;
+
+92 
+__u32
+ 
+	mp_ibys
+;
+
+93 
+__u32
+ 
+	mp_ioes
+;
+
+94 
+__u32
+ 
+	mp_acks
+;
+
+95 
+__u32
+ 
+	mp_s
+;
+
+96 
+__u32
+ 
+	mp_qrs
+;
+
+98 
+__u32
+ 
+	mp_obys
+;
+
+99 
+__u32
+ 
+	mp_ooes
+;
+
+100 
+__u32
+ 
+	mp_acks
+;
+
+101 
+__u32
+ 
+	mp_s
+;
+
+102 
+__u32
+ 
+	mp_qrs
+;
+
+105 
+	svj
+ {
+
+106 
+__u32
+ 
+	mvjs_cks
+;
+
+107 
+__u32
+ 
+	mvjs_comesd
+;
+
+108 
+__u32
+ 
+	mvjs_ches
+;
+
+109 
+__u32
+ 
+	mvjs_miss
+;
+
+110 
+__u32
+ 
+	mvjs_uncomesd
+;
+
+111 
+__u32
+ 
+	mvjs_comesd
+;
+
+112 
+__u32
+ 
+	mvjs_r
+;
+
+113 
+__u32
+ 
+	mvjs_tosd
+;
+
+116 
+	scomp
+ {
+
+117 
+__u32
+ 
+	munc_bys
+;
+
+118 
+__u32
+ 
+	munc_cks
+;
+
+119 
+__u32
+ 
+	mcomp_bys
+;
+
+120 
+__u32
+ 
+	mcomp_cks
+;
+
+121 
+__u32
+ 
+	mc_bys
+;
+
+122 
+__u32
+ 
+	mc_cks
+;
+
+125 
+__u32
+ 
+	m_cou
+;
+
+126 
+__u32
+ 
+	mbys_out
+;
+
+128 
+	mtio
+;
+
+131 
+	sp_s
+ {
+
+132 
+p
+ 
+	mp
+;
+
+133 
+vj
+ 
+	mvj
+;
+
+136 
+	sp_comp_s
+ {
+
+137 
+comp
+ 
+	mc
+;
+
+138 
+comp
+ 
+	md
+;
+
+145 
+	sp_id
+ {
+
+146 
+__kl_time_t
+ 
+	mxm_id
+;
+
+147 
+__kl_time_t
+ 
+	mcv_id
+;
+
+	@/usr/include/time.h
+
+22 #idef 
+_TIME_H
+
+
+24 #i(! 
+defed
+ 
+__ed_time_t
+ && !defed 
+__ed_ock_t
+ && \
+
+25 ! 
+defed
+ 
+	g__ed_timeec
+)
+
+26 
+	#_TIME_H
+ 1
+
+	)
+
+27 
+	~<us.h
+>
+
+29 
+	g__BEGIN_DECLS
+
+
+33 #ifdef 
+_TIME_H
+
+
+35 
+	#__ed_size_t
+
+
+	)
+
+36 
+	#__ed_NULL
+
+
+	)
+
+37 
+	~<ddef.h
+>
+
+41 
+	~<bs/time.h
+>
+
+44 #i!
+defed
+ 
+__STRICT_ANSI__
+ && !defed 
+__USE_XOPEN2K
+
+
+45 #ide
+CLK_TCK
+
+
+46 
+	#CLK_TCK
+ 
+CLOCKS_PER_SEC
+
+
+	)
+
+52 #i!
+defed
+ 
+__ock_t_defed
+ && (defed 
+_TIME_H
+ || defed 
+__ed_ock_t
+)
+
+53 
+	#__ock_t_defed
+ 1
+
+	)
+
+55 
+	~<bs/tys.h
+>
+
+57 
+__BEGIN_NAMESPACE_STD
+
+
+59 
+__ock_t
+ 
+	tock_t
+;
+
+60 
+	g__END_NAMESPACE_STD
+
+
+61 #i
+defed
+ 
+__USE_XOPEN
+ || defed 
+__USE_POSIX
+ || defed 
+__USE_MISC
+
+
+62 
+	$__USING_NAMESPACE_STD
+(
+ock_t
+)
+
+66 #unde
+__ed_ock_t
+
+
+68 #i!
+defed
+ 
+__time_t_defed
+ && (defed 
+_TIME_H
+ || defed 
+__ed_time_t
+)
+
+69 
+	#__time_t_defed
+ 1
+
+	)
+
+71 
+	~<bs/tys.h
+>
+
+73 
+__BEGIN_NAMESPACE_STD
+
+
+75 
+__time_t
+ 
+	ttime_t
+;
+
+76 
+__END_NAMESPACE_STD
+
+
+77 #i
+defed
+ 
+__USE_POSIX
+ || defed 
+__USE_MISC
+ || defed 
+__USE_SVID
+
+
+78 
+	$__USING_NAMESPACE_STD
+(
+time_t
+)
+
+82 #unde
+__ed_time_t
+
+
+84 #i!
+defed
+ 
+__ockid_t_defed
+ && \
+
+85 ((
+defed
+ 
+_TIME_H
+ && defed 
+__USE_POSIX199309
+|| defed 
+__ed_ockid_t
+)
+
+86 
+	#__ockid_t_defed
+ 1
+
+	)
+
+88 
+	~<bs/tys.h
+>
+
+91 
+__ockid_t
+ 
+	tockid_t
+;
+
+94 #unde
+__ockid_time_t
+
+
+96 #i!
+defed
+ 
+__tim_t_defed
+ && \
+
+97 ((
+defed
+ 
+_TIME_H
+ && defed 
+__USE_POSIX199309
+|| defed 
+__ed_tim_t
+)
+
+98 
+	#__tim_t_defed
+ 1
+
+	)
+
+100 
+	~<bs/tys.h
+>
+
+103 
+__tim_t
+ 
+	ttim_t
+;
+
+106 #unde
+__ed_tim_t
+
+
+109 #i(!
+defed
+ 
+__timeec_defed
+ \
+
+110 && ((
+defed
+ 
+_TIME_H
+ \
+
+111 && (
+defed
+ 
+__USE_POSIX199309
+ || defed 
+__USE_MISC
+ \
+
+112 || 
+defed
+ 
+__USE_ISOC11
+)) \
+
+113 || 
+defed
+ 
+__ed_timeec
+))
+
+114 
+	#__timeec_defed
+ 1
+
+	)
+
+116 
+	~<bs/tys.h
+>
+
+120 
+	stimeec
+
+
+122 
+__time_t
+ 
+tv_c
+;
+
+123 
+__sys_g_t
+ 
+tv_nc
+;
+
+127 #unde
+__ed_timeec
+
+
+130 #ifdef 
+_TIME_H
+
+
+131 
+__BEGIN_NAMESPACE_STD
+
+
+133 
+	stm
+
+
+135 
+tm_c
+;
+
+136 
+tm_m
+;
+
+137 
+tm_hour
+;
+
+138 
+tm_mday
+;
+
+139 
+tm_m
+;
+
+140 
+tm_yr
+;
+
+141 
+tm_wday
+;
+
+142 
+tm_yday
+;
+
+143 
+tm_isd
+;
+
+145 #ifdef 
+__USE_BSD
+
+
+146 
+tm_gmtoff
+;
+
+147 c *
+tm_ze
+;
+
+149 
+__tm_gmtoff
+;
+
+150 c *
+__tm_ze
+;
+
+153 
+__END_NAMESPACE_STD
+
+
+154 #i
+defed
+ 
+__USE_XOPEN
+ || defed 
+__USE_POSIX
+ || defed 
+__USE_MISC
+
+
+155 
+	$__USING_NAMESPACE_STD
+(
+tm
+)
+
+159 #ifde
+__USE_POSIX199309
+
+
+161 
+	simec
+
+
+163 
+timeec
+ 
+_rv
+;
+
+164 
+timeec
+ 
+_vue
+;
+
+168 
+sigevt
+;
+
+172 #ifde
+__USE_XOPEN2K
+
+
+173 #ide
+__pid_t_defed
+
+
+174 
+__pid_t
+ 
+	tpid_t
+;
+
+175 
+	#__pid_t_defed
+
+
+	)
+
+180 #ifde
+__USE_ISOC11
+
+
+182 
+	#TIME_UTC
+ 1
+
+	)
+
+186 
+__BEGIN_NAMESPACE_STD
+
+
+189 
+ock_t
+ 
+	$ock
+ (
+__THROW
+;
+
+192 
+time_t
+ 
+	$time
+ (
+time_t
+ *
+__tim
+
+__THROW
+;
+
+195 
+	$difime
+ (
+time_t
+ 
+__time1
+,ime_
+__time0
+)
+
+196 
+__THROW
+ 
+	`__ibu__
+ ((
+__c__
+));
+
+199 
+time_t
+ 
+	$mktime
+ (
+tm
+ *
+__
+
+__THROW
+;
+
+205 
+size_t
+ 
+	$rime
+ (*
+__ri
+ 
+__s
+, 
+size_t
+ 
+__maxsize
+,
+
+206 c *
+__ri
+ 
+__fm
+,
+
+207 c 
+tm
+ *
+__ri
+ 
+__
+
+__THROW
+;
+
+208 
+__END_NAMESPACE_STD
+
+
+210 #ifde
+__USE_XOPEN
+
+
+213 *
+	$time
+ (c *
+__ri
+ 
+__s
+,
+
+214 c *
+__ri
+ 
+__fmt
+, 
+tm
+ *
+__
+)
+
+215 
+__THROW
+;
+
+218 #ifde
+__USE_XOPEN2K8
+
+
+221 
+	~<xlo.h
+>
+
+223 
+size_t
+ 
+	$rime_l
+ (*
+__ri
+ 
+__s
+, 
+size_t
+ 
+__maxsize
+,
+
+224 c *
+__ri
+ 
+__fm
+,
+
+225 c 
+tm
+ *
+__ri
+ 
+__
+,
+
+226 
+__lo_t
+ 
+__loc
+
+__THROW
+;
+
+229 #ifde
+__USE_GNU
+
+
+230 *
+	$time_l
+ (c *
+__ri
+ 
+__s
+,
+
+231 c *
+__ri
+ 
+__fmt
+, 
+tm
+ *
+__
+,
+
+232 
+__lo_t
+ 
+__loc
+
+__THROW
+;
+
+236 
+__BEGIN_NAMESPACE_STD
+
+
+239 
+tm
+ *
+	$gmtime
+ (c 
+time_t
+ *
+__tim
+
+__THROW
+;
+
+243 
+tm
+ *
+	$loime
+ (c 
+time_t
+ *
+__tim
+
+__THROW
+;
+
+244 
+__END_NAMESPACE_STD
+
+
+246 #i
+defed
+ 
+__USE_POSIX
+ || defed 
+__USE_MISC
+
+
+249 
+tm
+ *
+	$gmtime_r
+ (c 
+time_t
+ *
+__ri
+ 
+__tim
+,
+
+250 
+tm
+ *
+__ri
+ 
+__
+
+__THROW
+;
+
+254 
+tm
+ *
+	$loime_r
+ (c 
+time_t
+ *
+__ri
+ 
+__tim
+,
+
+255 
+tm
+ *
+__ri
+ 
+__
+
+__THROW
+;
+
+258 
+__BEGIN_NAMESPACE_STD
+
+
+261 *
+	$asime
+ (c 
+tm
+ *
+__
+
+__THROW
+;
+
+264 *
+	$ime
+ (c 
+time_t
+ *
+__tim
+
+__THROW
+;
+
+265 
+__END_NAMESPACE_STD
+
+
+267 #i
+defed
+ 
+__USE_POSIX
+ || defed 
+__USE_MISC
+
+
+272 *
+	$asime_r
+ (c 
+tm
+ *
+__ri
+ 
+__
+,
+
+273 *
+__ri
+ 
+__buf
+
+__THROW
+;
+
+276 *
+	$ime_r
+ (c 
+time_t
+ *
+__ri
+ 
+__tim
+,
+
+277 *
+__ri
+ 
+__buf
+
+__THROW
+;
+
+282 *
+__tzme
+[2];
+
+283 
+__daylight
+;
+
+284 
+__timeze
+;
+
+287 #ifdef 
+__USE_POSIX
+
+
+289 *
+tzme
+[2];
+
+293 
+	$tzt
+ (
+__THROW
+;
+
+296 #i
+defed
+ 
+__USE_SVID
+ || defed 
+__USE_XOPEN
+
+
+297 
+daylight
+;
+
+298 
+timeze
+;
+
+301 #ifde
+__USE_SVID
+
+
+304 
+	$ime
+ (c 
+time_t
+ *
+__wh
+
+__THROW
+;
+
+310 
+	#__ip
+(
+yr
+) \
+
+311 ((
+yr
+% 4 =0 && ((yr% 100 !0 || (yr% 400 =0))
+
+	)
+
+314 #ifde
+__USE_MISC
+
+
+319 
+time_t
+ 
+	$timegm
+ (
+tm
+ *
+__
+
+__THROW
+;
+
+322 
+time_t
+ 
+	$timol
+ (
+tm
+ *
+__
+
+__THROW
+;
+
+325 
+	$dysize
+ (
+__yr
+
+__THROW
+ 
+	`__ibu__
+ ((
+__c__
+));
+
+329 #ifde
+__USE_POSIX199309
+
+
+334 
+	`nop
+ (c 
+timeec
+ *
+__queed_time
+,
+
+335 
+timeec
+ *
+__mag
+);
+
+339 
+	$ock_gs
+ (
+ockid_t
+ 
+__ock_id
+, 
+timeec
+ *
+__s
+
+__THROW
+;
+
+342 
+	$ock_gtime
+ (
+ockid_t
+ 
+__ock_id
+, 
+timeec
+ *
+__
+
+__THROW
+;
+
+345 
+	$ock_ime
+ (
+ockid_t
+ 
+__ock_id
+, c 
+timeec
+ *
+__
+)
+
+346 
+__THROW
+;
+
+348 #ifde
+__USE_XOPEN2K
+
+
+353 
+	`ock_nop
+ (
+ockid_t
+ 
+__ock_id
+, 
+__ags
+,
+
+354 c 
+timeec
+ *
+__q
+,
+
+355 
+timeec
+ *
+__m
+);
+
+358 
+	$ock_guockid
+ (
+pid_t
+ 
+__pid
+, 
+ockid_t
+ *
+__ock_id
+
+__THROW
+;
+
+363 
+	$tim_
+ (
+ockid_t
+ 
+__ock_id
+,
+
+364 
+sigevt
+ *
+__ri
+ 
+__evp
+,
+
+365 
+tim_t
+ *
+__ri
+ 
+__timid
+
+__THROW
+;
+
+368 
+	$tim_de
+ (
+tim_t
+ 
+__timid
+
+__THROW
+;
+
+371 
+	$tim_ime
+ (
+tim_t
+ 
+__timid
+, 
+__ags
+,
+
+372 c 
+imec
+ *
+__ri
+ 
+__vue
+,
+
+373 
+imec
+ *
+__ri
+ 
+__ovue
+
+__THROW
+;
+
+376 
+	$tim_gtime
+ (
+tim_t
+ 
+__timid
+, 
+imec
+ *
+__vue
+)
+
+377 
+__THROW
+;
+
+380 
+	$tim_govrun
+ (
+tim_t
+ 
+__timid
+
+__THROW
+;
+
+384 #ifde
+__USE_ISOC11
+
+
+386 
+	$timeec_g
+ (
+timeec
+ *
+__ts
+, 
+__ba
+)
+
+387 
+__THROW
+ 
+	`__nnu
+ ((1));
+
+391 #ifde
+__USE_XOPEN_EXTENDED
+
+
+403 
+gde_r
+;
+
+412 
+tm
+ *
+	`gde
+ (c *
+__rg
+);
+
+415 #ifde
+__USE_GNU
+
+
+426 
+	`gde_r
+ (c *
+__ri
+ 
+__rg
+,
+
+427 
+tm
+ *
+__ri
+ 
+__sbu
+);
+
+430 
+__END_DECLS
+
+
+	@/usr/include/xlocale.h
+
+20 #ide
+_XLOCALE_H
+
+
+21 
+	#_XLOCALE_H
+ 1
+
+	)
+
+27 
+	s__lo_ru
+
+
+30 
+__lo_da
+ *
+	m__los
+[13];
+
+33 c *
+	m__y_b
+;
+
+34 c *
+	m__y_tow
+;
+
+35 c *
+	m__y_tou
+;
+
+38 c *
+	m__mes
+[13];
+
+39 } *
+	t__lo_t
+;
+
+42 
+__lo_t
+ 
+	tlo_t
+;
+
+	@/usr/include/_G_config.h
+
+4 #ide
+_G_cfig_h
+
+
+5 
+	#_G_cfig_h
+ 1
+
+	)
+
+9 
+	~<bs/tys.h
+>
+
+10 
+	#__ed_size_t
+
+
+	)
+
+11 #i
+defed
+ 
+_LIBC
+ || defed 
+_GLIBCPP_USE_WCHAR_T
+
+
+12 
+	#__ed_wch_t
+
+
+	)
+
+14 
+	#__ed_NULL
+
+
+	)
+
+15 
+	~<ddef.h
+>
+
+16 
+	#__ed_mbe_t
+
+
+	)
+
+17 #i
+defed
+ 
+_LIBC
+ || defed 
+_GLIBCPP_USE_WCHAR_T
+
+
+18 
+	#__ed_wt_t
+
+
+	)
+
+20 
+	~<wch.h
+>
+
+23 
+__off_t
+ 
+	m__pos
+;
+
+24 
+__mbe_t
+ 
+	m__e
+;
+
+25 } 
+	t_G_os_t
+;
+
+28 
+__off64_t
+ 
+	m__pos
+;
+
+29 
+__mbe_t
+ 
+	m__e
+;
+
+30 } 
+	t_G_os64_t
+;
+
+31 #i
+defed
+ 
+_LIBC
+ || defed 
+_GLIBCPP_USE_WCHAR_T
+
+
+32 
+	~<gcv.h
+>
+
+35 
+__gcv_fo
+ 
+	m__cd
+;
+
+38 
+__gcv_fo
+ 
+	m__cd
+;
+
+39 
+__gcv__da
+ 
+	m__da
+;
+
+40 } 
+	m__combed
+;
+
+41 } 
+	t_G_icv_t
+;
+
+46 
+	#_G_va_li
+ 
+__gnuc_va_li
+
+
+	)
+
+48 
+	#_G_HAVE_MMAP
+ 1
+
+	)
+
+49 
+	#_G_HAVE_MREMAP
+ 1
+
+	)
+
+51 
+	#_G_IO_IO_FILE_VERSION
+ 0x20001
+
+	)
+
+54 
+	#_G_HAVE_ST_BLKSIZE
+ 
+	`defed
+ (
+_STATBUF_ST_BLKSIZE
+)
+
+	)
+
+56 
+	#_G_BUFSIZ
+ 8192
+
+	)
+
+	@/usr/include/linux/socket.h
+
+1 #ide
+_LINUX_SOCKET_H
+
+
+2 
+	#_LINUX_SOCKET_H
+
+
+	)
+
+7 
+	#_K_SS_MAXSIZE
+ 128
+
+	)
+
+8 
+	#_K_SS_ALIGNSIZE
+ (
+	`__ignof__
+ (
+sockaddr
+ *))
+
+	)
+
+11 
+	t__kl__my_t
+;
+
+13 
+	s__kl_sockaddr_age
+ {
+
+14 
+__kl__my_t
+ 
+	mss_my
+;
+
+16 
+	m__da
+[
+_K_SS_MAXSIZE
+ - ()];
+
+19 } 
+__ibu__
+ ((
+igd
+(
+_K_SS_ALIGNSIZE
+)));
+
+	@/usr/include/linux/types.h
+
+1 #ide
+_LINUX_TYPES_H
+
+
+2 
+	#_LINUX_TYPES_H
+
+
+	)
+
+4 
+	~<asm/tys.h
+>
+
+6 #ide
+__ASSEMBLY__
+
+
+8 
+	~<lux/posix_tys.h
+>
+
+16 #ifde
+__CHECKER__
+
+
+17 
+	#__bwi__
+ 
+	`__ibu__
+((
+bwi
+))
+
+	)
+
+19 
+	#__bwi__
+
+
+	)
+
+21 #ifde
+__CHECK_ENDIAN__
+
+
+22 
+	#__bwi
+ 
+__bwi__
+
+
+	)
+
+24 
+	#__bwi
+
+
+	)
+
+27 
+__u16
+ 
+	t__bwi
+ 
+	t__16
+;
+
+28 
+__u16
+ 
+	t__bwi
+ 
+	t__be16
+;
+
+29 
+__u32
+ 
+	t__bwi
+ 
+	t__32
+;
+
+30 
+__u32
+ 
+	t__bwi
+ 
+	t__be32
+;
+
+31 
+__u64
+ 
+	t__bwi
+ 
+	t__64
+;
+
+32 
+__u64
+ 
+	t__bwi
+ 
+	t__be64
+;
+
+34 
+__u16
+ 
+	t__bwi
+ 
+	t__sum16
+;
+
+35 
+__u32
+ 
+	t__bwi
+ 
+	t__wsum
+;
+
+46 
+	#__igd_u64
+ 
+__u64
+ 
+	`__ibu__
+((
+	`igd
+(8)))
+
+	)
+
+47 
+	#__igd_be64
+ 
+__be64
+ 
+	`__ibu__
+((
+	`igd
+(8)))
+
+	)
+
+48 
+	#__igd_64
+ 
+__64
+ 
+	`__ibu__
+((
+	`igd
+(8)))
+
+	)
+
+	@/usr/include/stdc-predef.h
+
+18 #idef 
+_STDC_PREDEF_H
+
+
+19 
+	#_STDC_PREDEF_H
+ 1
+
+	)
+
+36 #ifde
+__GCC_IEC_559
+
+
+37 #i
+__GCC_IEC_559
+ > 0
+
+38 
+	#__STDC_IEC_559__
+ 1
+
+	)
+
+41 
+	#__STDC_IEC_559__
+ 1
+
+	)
+
+44 #ifde
+__GCC_IEC_559_COMPLEX
+
+
+45 #i
+__GCC_IEC_559_COMPLEX
+ > 0
+
+46 
+	#__STDC_IEC_559_COMPLEX__
+ 1
+
+	)
+
+49 
+	#__STDC_IEC_559_COMPLEX__
+ 1
+
+	)
+
+54 
+	#__STDC_ISO_10646__
+ 201103L
+
+	)
+
+57 
+	#__STDC_NO_THREADS__
+ 1
+
+	)
+
+	@/usr/include/gconv.h
+
+22 #ide
+_GCONV_H
+
+
+23 
+	#_GCONV_H
+ 1
+
+	)
+
+25 
+	~<us.h
+>
+
+26 
+	#__ed_mbe_t
+
+
+	)
+
+27 
+	#__ed_wt_t
+
+
+	)
+
+28 
+	~<wch.h
+>
+
+29 
+	#__ed_size_t
+
+
+	)
+
+30 
+	#__ed_wch_t
+
+
+	)
+
+31 
+	~<ddef.h
+>
+
+34 
+	#__UNKNOWN_10646_CHAR
+ ((
+wch_t
+0xfffd)
+
+	)
+
+39 
+	m__GCONV_OK
+ = 0,
+
+40 
+	m__GCONV_NOCONV
+,
+
+41 
+	m__GCONV_NODB
+,
+
+42 
+	m__GCONV_NOMEM
+,
+
+44 
+	m__GCONV_EMPTY_INPUT
+,
+
+45 
+	m__GCONV_FULL_OUTPUT
+,
+
+46 
+	m__GCONV_ILLEGAL_INPUT
+,
+
+47 
+	m__GCONV_INCOMPLETE_INPUT
+,
+
+49 
+	m__GCONV_ILLEGAL_DESCRIPTOR
+,
+
+50 
+	m__GCONV_INTERNAL_ERROR
+
+
+57 
+	m__GCONV_IS_LAST
+ = 0x0001,
+
+58 
+	m__GCONV_IGNORE_ERRORS
+ = 0x0002,
+
+59 
+	m__GCONV_SWAP
+ = 0x0004
+
+64 
+	g__gcv_
+;
+
+65 
+	g__gcv__da
+;
+
+66 
+	g__gcv_lded_obje
+;
+
+67 
+	g__gcv_s_da
+;
+
+71 (*
+	t__gcv_f
+(
+	t__gcv_
+ *, 
+	t__gcv__da
+ *,
+
+73 **, 
+	tsize_t
+ *, , );
+
+76 
+	$wt_t
+ (*
+	t__gcv_btowc_f
+(
+	t__gcv_
+ *, );
+
+79 (*
+	t__gcv__f
+(
+	t__gcv_
+ *);
+
+80 (*
+	t__gcv_d_f
+(
+	t__gcv_
+ *);
+
+84 (*
+	t__gcv_s_f
+(
+	t__gcv_
+ *,
+
+85 
+	t__gcv__da
+ *, *,
+
+89 
+	tsize_t
+ *);
+
+92 (*
+	t__gcv_s_cxt_f
+) (*, const *,
+
+97 (*
+	t__gcv_s_quy_f
+) (const *, const ***,
+
+98 
+	tsize_t
+ *);
+
+101 (*
+	t__gcv_s__f
+) (**, const *);
+
+102 (*
+	t__gcv_s_d_f
+) (*);
+
+104 
+	s__gcv_s_da
+
+
+107 
+__gcv_s_f
+ 
+__s_f
+;
+
+108 
+__gcv_s_cxt_f
+ 
+__s_cxt_f
+;
+
+109 
+__gcv_s_d_f
+ 
+__s_d_f
+;
+
+110 *
+__da
+;
+
+111 
+__gcv_s_da
+ *
+__xt
+;
+
+116 
+	s__gcv_
+
+
+118 
+__gcv_lded_obje
+ *
+__shlib_hd
+;
+
+119 c *
+__modme
+;
+
+121 
+__cou
+;
+
+123 *
+__om_me
+;
+
+124 *
+__to_me
+;
+
+126 
+__gcv_f
+ 
+__f
+;
+
+127 
+__gcv_btowc_f
+ 
+__btowc_f
+;
+
+128 
+__gcv__f
+ 
+___f
+;
+
+129 
+__gcv_d_f
+ 
+__d_f
+;
+
+133 
+__m_eded_om
+;
+
+134 
+__max_eded_om
+;
+
+135 
+__m_eded_to
+;
+
+136 
+__max_eded_to
+;
+
+139 
+__eful
+;
+
+141 *
+__da
+;
+
+146 
+	s__gcv__da
+
+
+148 *
+__outbuf
+;
+
+149 *
+__outbund
+;
+
+153 
+__ags
+;
+
+157 
+__voti_cou
+;
+
+161 
+___u
+;
+
+163 
+__mbe_t
+ *
+__
+;
+
+164 
+__mbe_t
+ 
+__e
+;
+
+168 
+__gcv_s_da
+ *
+__s
+;
+
+173 
+	s__gcv_fo
+
+
+175 
+size_t
+ 
+__ns
+;
+
+176 
+__gcv_
+ *
+__s
+;
+
+177 
+__exnsi__
+ 
+__gcv__da
+ 
+__da
+ 
+__exr
+;
+
+178 } *
+	t__gcv_t
+;
+
+	@/usr/include/linux/posix_types.h
+
+1 #ide
+_LINUX_POSIX_TYPES_H
+
+
+2 
+	#_LINUX_POSIX_TYPES_H
+
+
+	)
+
+4 
+	~<lux/ddef.h
+>
+
+21 #unde
+__FD_SETSIZE
+
+
+22 
+	#__FD_SETSIZE
+ 1024
+
+	)
+
+25 
+	mfds_bs
+[
+__FD_SETSIZE
+ / (8 * ())];
+
+26 } 
+	t__kl_fd_t
+;
+
+29 (*
+	t__kl_sighdr_t
+)();
+
+32 
+	t__kl_key_t
+;
+
+33 
+	t__kl_mqd_t
+;
+
+35 
+	~<asm/posix_tys.h
+>
+
+	@/usr/include/wchar.h
+
+23 #ide
+_WCHAR_H
+
+
+25 #i!
+defed
+ 
+__ed_mbe_t
+ && !defed 
+__ed_wt_t
+
+
+26 
+	#_WCHAR_H
+ 1
+
+	)
+
+27 
+	~<us.h
+>
+
+30 #ifde
+_WCHAR_H
+
+
+32 
+	#__ed___FILE
+
+
+	)
+
+33 #i
+defed
+ 
+__USE_UNIX98
+ || defed 
+__USE_XOPEN2K
+
+
+34 
+	#__ed_FILE
+
+
+	)
+
+36 
+	~<dio.h
+>
+
+38 
+	#__ed___va_li
+
+
+	)
+
+39 
+	~<dg.h
+>
+
+41 
+	~<bs/wch.h
+>
+
+44 
+	#__ed_size_t
+
+
+	)
+
+45 
+	#__ed_wch_t
+
+
+	)
+
+46 
+	#__ed_NULL
+
+
+	)
+
+48 #i
+defed
+ 
+_WCHAR_H
+ || defed 
+__ed_wt_t
+ || !defed 
+__WINT_TYPE__
+
+
+49 #unde
+__ed_wt_t
+
+
+50 
+	#__ed_wt_t
+
+
+	)
+
+51 
+	~<ddef.h
+>
+
+55 #ide
+_WINT_T
+
+
+60 
+	#_WINT_T
+
+
+	)
+
+61 
+	twt_t
+;
+
+65 #i
+defed
+ 
+__lulus
+ && defed 
+_GLIBCPP_USE_NAMESPACES
+ \
+
+66 && 
+defed
+ 
+__WINT_TYPE__
+
+
+67 
+__BEGIN_NAMESPACE_STD
+
+
+68 
+__WINT_TYPE__
+ 
+	twt_t
+;
+
+69 
+	g__END_NAMESPACE_STD
+
+
+74 #i
+defed
+ 
+__lulus
+ && 
+__GNUC_PREREQ
+ (4, 4)
+
+75 
+	#__CORRECT_ISO_CPP_WCHAR_H_PROTO
+
+
+	)
+
+79 #i(
+defed
+ 
+_WCHAR_H
+ || defed 
+__ed_mbe_t
+&& !defed 
+____mbe_t_defed
+
+
+80 
+	#____mbe_t_defed
+ 1
+
+	)
+
+84 
+	m__cou
+;
+
+87 #ifde
+__WINT_TYPE__
+
+
+88 
+__WINT_TYPE__
+ 
+	m__wch
+;
+
+90 
+wt_t
+ 
+	m__wch
+;
+
+92 
+	m__wchb
+[4];
+
+93 } 
+	m__vue
+;
+
+94 } 
+	t__mbe_t
+;
+
+96 #unde
+__ed_mbe_t
+
+
+101 #ifde
+_WCHAR_H
+
+
+103 #ide
+__mbe_t_defed
+
+
+104 
+__BEGIN_NAMESPACE_C99
+
+
+106 
+__mbe_t
+ 
+	tmbe_t
+;
+
+107 
+	g__END_NAMESPACE_C99
+
+
+108 
+	#__mbe_t_defed
+ 1
+
+	)
+
+111 #ifde
+__USE_GNU
+
+
+112 
+	$__USING_NAMESPACE_C99
+(
+mbe_t
+)
+
+115 #ide
+WCHAR_MIN
+
+
+117 
+	#WCHAR_MIN
+ 
+__WCHAR_MIN
+
+
+	)
+
+118 
+	#WCHAR_MAX
+ 
+__WCHAR_MAX
+
+
+	)
+
+121 #ide
+WEOF
+
+
+122 
+	#WEOF
+ (0xffffffffu)
+
+	)
+
+127 #i
+defed
+ 
+__USE_XOPEN
+ && !defed 
+__USE_UNIX98
+
+
+128 
+	~<wy.h
+>
+
+132 
+__BEGIN_DECLS
+
+
+134 
+__BEGIN_NAMESPACE_STD
+
+
+137 
+tm
+;
+
+138 
+__END_NAMESPACE_STD
+
+
+142 
+	$__USING_NAMESPACE_STD
+(
+tm
+)
+
+145 
+__BEGIN_NAMESPACE_STD
+
+
+147 
+wch_t
+ *
+	$wcsy
+ (
+wch_t
+ *
+__ri
+ 
+__de
+,
+
+148 c 
+wch_t
+ *
+__ri
+ 
+__c
+
+__THROW
+;
+
+150 
+wch_t
+ *
+	$wcy
+ (
+wch_t
+ *
+__ri
+ 
+__de
+,
+
+151 c 
+wch_t
+ *
+__ri
+ 
+__c
+, 
+size_t
+ 
+__n
+)
+
+152 
+__THROW
+;
+
+155 
+wch_t
+ *
+	$wcst
+ (
+wch_t
+ *
+__ri
+ 
+__de
+,
+
+156 c 
+wch_t
+ *
+__ri
+ 
+__c
+
+__THROW
+;
+
+158 
+wch_t
+ *
+	$wct
+ (
+wch_t
+ *
+__ri
+ 
+__de
+,
+
+159 c 
+wch_t
+ *
+__ri
+ 
+__c
+, 
+size_t
+ 
+__n
+)
+
+160 
+__THROW
+;
+
+163 
+	$wcscmp
+ (c 
+wch_t
+ *
+__s1
+, c wch_*
+__s2
+)
+
+164 
+__THROW
+ 
+__ibu_pu__
+;
+
+166 
+	$wccmp
+ (c 
+wch_t
+ *
+__s1
+, c wch_*
+__s2
+, 
+size_t
+ 
+__n
+)
+
+167 
+__THROW
+ 
+__ibu_pu__
+;
+
+168 
+__END_NAMESPACE_STD
+
+
+170 #ifde
+__USE_XOPEN2K8
+
+
+172 
+	$wcscmp
+ (c 
+wch_t
+ *
+__s1
+, c wch_*
+__s2
+
+__THROW
+;
+
+175 
+	$wccmp
+ (c 
+wch_t
+ *
+__s1
+, c wch_*
+__s2
+,
+
+176 
+size_t
+ 
+__n
+
+__THROW
+;
+
+180 
+	~<xlo.h
+>
+
+182 
+	$wcscmp_l
+ (c 
+wch_t
+ *
+__s1
+, c wch_*
+__s2
+,
+
+183 
+__lo_t
+ 
+__loc
+
+__THROW
+;
+
+185 
+	$wccmp_l
+ (c 
+wch_t
+ *
+__s1
+, c wch_*
+__s2
+,
+
+186 
+size_t
+ 
+__n
+, 
+__lo_t
+ 
+__loc
+
+__THROW
+;
+
+189 
+__BEGIN_NAMESPACE_STD
+
+
+192 
+	$wcscl
+ (c 
+wch_t
+ *
+__s1
+, c wch_*
+__s2
+
+__THROW
+;
+
+196 
+size_t
+ 
+	$wcsxm
+ (
+wch_t
+ *
+__ri
+ 
+__s1
+,
+
+197 c 
+wch_t
+ *
+__ri
+ 
+__s2
+, 
+size_t
+ 
+__n
+
+__THROW
+;
+
+198 
+__END_NAMESPACE_STD
+
+
+200 #ifde
+__USE_XOPEN2K8
+
+
+206 
+	$wcscl_l
+ (c 
+wch_t
+ *
+__s1
+, c wch_*
+__s2
+,
+
+207 
+__lo_t
+ 
+__loc
+
+__THROW
+;
+
+212 
+size_t
+ 
+	$wcsxm_l
+ (
+wch_t
+ *
+__s1
+, c wch_*
+__s2
+,
+
+213 
+size_t
+ 
+__n
+, 
+__lo_t
+ 
+__loc
+
+__THROW
+;
+
+216 
+wch_t
+ *
+	$wcsdup
+ (c 
+wch_t
+ *
+__s
+
+__THROW
+ 
+__ibu_mloc__
+;
+
+219 
+__BEGIN_NAMESPACE_STD
+
+
+221 #ifde
+__CORRECT_ISO_CPP_WCHAR_H_PROTO
+
+
+222 "C++" 
+wch_t
+ *
+	$wcschr
+ (
+wch_t
+ *
+__wcs
+, wch_
+__wc
+)
+
+223 
+__THROW
+ 
+	`__asm
+ ("wcschr"
+__ibu_pu__
+;
+
+224 "C++" c 
+wch_t
+ *
+	$wcschr
+ (c 
+wch_t
+ *
+__wcs
+, wch_
+__wc
+)
+
+225 
+__THROW
+ 
+	`__asm
+ ("wcschr"
+__ibu_pu__
+;
+
+227 
+wch_t
+ *
+	$wcschr
+ (c 
+wch_t
+ *
+__wcs
+, wch_
+__wc
+)
+
+228 
+__THROW
+ 
+__ibu_pu__
+;
+
+231 #ifde
+__CORRECT_ISO_CPP_WCHAR_H_PROTO
+
+
+232 "C++" 
+wch_t
+ *
+	$wcchr
+ (
+wch_t
+ *
+__wcs
+, wch_
+__wc
+)
+
+233 
+__THROW
+ 
+	`__asm
+ ("wcchr"
+__ibu_pu__
+;
+
+234 "C++" c 
+wch_t
+ *
+	$wcchr
+ (c 
+wch_t
+ *
+__wcs
+, wch_
+__wc
+)
+
+235 
+__THROW
+ 
+	`__asm
+ ("wcchr"
+__ibu_pu__
+;
+
+237 
+wch_t
+ *
+	$wcchr
+ (c 
+wch_t
+ *
+__wcs
+, wch_
+__wc
+)
+
+238 
+__THROW
+ 
+__ibu_pu__
+;
+
+240 
+__END_NAMESPACE_STD
+
+
+242 #ifde
+__USE_GNU
+
+
+245 
+wch_t
+ *
+	$wcschul
+ (c 
+wch_t
+ *
+__s
+, wch_
+__wc
+)
+
+246 
+__THROW
+ 
+__ibu_pu__
+;
+
+249 
+__BEGIN_NAMESPACE_STD
+
+
+252 
+size_t
+ 
+	$wcscn
+ (c 
+wch_t
+ *
+__wcs
+, c wch_*
+__je
+)
+
+253 
+__THROW
+ 
+__ibu_pu__
+;
+
+256 
+size_t
+ 
+	$wcsn
+ (c 
+wch_t
+ *
+__wcs
+, c wch_*
+__ac
+)
+
+257 
+__THROW
+ 
+__ibu_pu__
+;
+
+259 #ifde
+__CORRECT_ISO_CPP_WCHAR_H_PROTO
+
+
+260 "C++" 
+wch_t
+ *
+	$wcbrk
+ (
+wch_t
+ *
+__wcs
+, c wch_*
+__ac
+)
+
+261 
+__THROW
+ 
+	`__asm
+ ("wcbrk"
+__ibu_pu__
+;
+
+262 "C++" c 
+wch_t
+ *
+	$wcbrk
+ (c 
+wch_t
+ *
+__wcs
+,
+
+263 c 
+wch_t
+ *
+__ac
+)
+
+264 
+__THROW
+ 
+	`__asm
+ ("wcbrk"
+__ibu_pu__
+;
+
+266 
+wch_t
+ *
+	$wcbrk
+ (c 
+wch_t
+ *
+__wcs
+, c wch_*
+__ac
+)
+
+267 
+__THROW
+ 
+__ibu_pu__
+;
+
+270 #ifde
+__CORRECT_ISO_CPP_WCHAR_H_PROTO
+
+
+271 "C++" 
+wch_t
+ *
+	$wcsr
+ (
+wch_t
+ *
+__hayack
+, c wch_*
+__ed
+)
+
+272 
+__THROW
+ 
+	`__asm
+ ("wcsr"
+__ibu_pu__
+;
+
+273 "C++" c 
+wch_t
+ *
+	$wcsr
+ (c 
+wch_t
+ *
+__hayack
+,
+
+274 c 
+wch_t
+ *
+__ed
+)
+
+275 
+__THROW
+ 
+	`__asm
+ ("wcsr"
+__ibu_pu__
+;
+
+277 
+wch_t
+ *
+	$wcsr
+ (c 
+wch_t
+ *
+__hayack
+, c wch_*
+__ed
+)
+
+278 
+__THROW
+ 
+__ibu_pu__
+;
+
+282 
+wch_t
+ *
+	$wcok
+ (
+wch_t
+ *
+__ri
+ 
+__s
+,
+
+283 c 
+wch_t
+ *
+__ri
+ 
+__dim
+,
+
+284 
+wch_t
+ **
+__ri
+ 
+__r
+
+__THROW
+;
+
+287 
+size_t
+ 
+	$wc
+ (c 
+wch_t
+ *
+__s
+
+__THROW
+ 
+__ibu_pu__
+;
+
+288 
+__END_NAMESPACE_STD
+
+
+290 #ifde
+__USE_XOPEN
+
+
+292 #ifde
+__CORRECT_ISO_CPP_WCHAR_H_PROTO
+
+
+293 "C++" 
+wch_t
+ *
+	$wcswcs
+ (
+wch_t
+ *
+__hayack
+, c wch_*
+__ed
+)
+
+294 
+__THROW
+ 
+	`__asm
+ ("wcswcs"
+__ibu_pu__
+;
+
+295 "C++" c 
+wch_t
+ *
+	$wcswcs
+ (c 
+wch_t
+ *
+__hayack
+,
+
+296 c 
+wch_t
+ *
+__ed
+)
+
+297 
+__THROW
+ 
+	`__asm
+ ("wcswcs"
+__ibu_pu__
+;
+
+299 
+wch_t
+ *
+	$wcswcs
+ (c 
+wch_t
+ *
+__hayack
+, c wch_*
+__ed
+)
+
+300 
+__THROW
+ 
+__ibu_pu__
+;
+
+304 #ifde
+__USE_XOPEN2K8
+
+
+306 
+size_t
+ 
+	$wcn
+ (c 
+wch_t
+ *
+__s
+, 
+size_t
+ 
+__maxn
+)
+
+307 
+__THROW
+ 
+__ibu_pu__
+;
+
+311 
+__BEGIN_NAMESPACE_STD
+
+
+313 #ifde
+__CORRECT_ISO_CPP_WCHAR_H_PROTO
+
+
+314 "C++" 
+wch_t
+ *
+	$wmemchr
+ (
+wch_t
+ *
+__s
+, wch_
+__c
+, 
+size_t
+ 
+__n
+)
+
+315 
+__THROW
+ 
+	`__asm
+ ("wmemchr"
+__ibu_pu__
+;
+
+316 "C++" c 
+wch_t
+ *
+	$wmemchr
+ (c 
+wch_t
+ *
+__s
+, wch_
+__c
+,
+
+317 
+size_t
+ 
+__n
+)
+
+318 
+__THROW
+ 
+	`__asm
+ ("wmemchr"
+__ibu_pu__
+;
+
+320 
+wch_t
+ *
+	$wmemchr
+ (c 
+wch_t
+ *
+__s
+, wch_
+__c
+, 
+size_t
+ 
+__n
+)
+
+321 
+__THROW
+ 
+__ibu_pu__
+;
+
+325 
+	$wmemcmp
+ (c 
+wch_t
+ *
+__s1
+, c wch_*
+__s2
+, 
+size_t
+ 
+__n
+)
+
+326 
+__THROW
+ 
+__ibu_pu__
+;
+
+329 
+wch_t
+ *
+	$wmemy
+ (
+wch_t
+ *
+__ri
+ 
+__s1
+,
+
+330 c 
+wch_t
+ *
+__ri
+ 
+__s2
+, 
+size_t
+ 
+__n
+
+__THROW
+;
+
+334 
+wch_t
+ *
+	$wmemmove
+ (
+wch_t
+ *
+__s1
+, c wch_*
+__s2
+, 
+size_t
+ 
+__n
+)
+
+335 
+__THROW
+;
+
+338 
+wch_t
+ *
+	$wmemt
+ (
+wch_t
+ *
+__s
+, wch_
+__c
+, 
+size_t
+ 
+__n
+
+__THROW
+;
+
+339 
+__END_NAMESPACE_STD
+
+
+341 #ifde
+__USE_GNU
+
+
+344 
+wch_t
+ *
+	$wmempy
+ (
+wch_t
+ *
+__ri
+ 
+__s1
+,
+
+345 c 
+wch_t
+ *
+__ri
+ 
+__s2
+, 
+size_t
+ 
+__n
+)
+
+346 
+__THROW
+;
+
+350 
+__BEGIN_NAMESPACE_STD
+
+
+353 
+wt_t
+ 
+	$btowc
+ (
+__c
+
+__THROW
+;
+
+357 
+	$wob
+ (
+wt_t
+ 
+__c
+
+__THROW
+;
+
+361 
+	$mbs
+ (c 
+mbe_t
+ *
+__ps
+
+__THROW
+ 
+__ibu_pu__
+;
+
+365 
+size_t
+ 
+	$mbowc
+ (
+wch_t
+ *
+__ri
+ 
+__pwc
+,
+
+366 c *
+__ri
+ 
+__s
+, 
+size_t
+ 
+__n
+,
+
+367 
+mbe_t
+ *
+__ri
+ 
+__p
+
+__THROW
+;
+
+370 
+size_t
+ 
+	$wtomb
+ (*
+__ri
+ 
+__s
+, 
+wch_t
+ 
+__wc
+,
+
+371 
+mbe_t
+ *
+__ri
+ 
+__ps
+
+__THROW
+;
+
+374 
+size_t
+ 
+	$__mb
+ (c *
+__ri
+ 
+__s
+, 
+size_t
+ 
+__n
+,
+
+375 
+mbe_t
+ *
+__ri
+ 
+__ps
+
+__THROW
+;
+
+376 
+size_t
+ 
+	$mb
+ (c *
+__ri
+ 
+__s
+, 
+size_t
+ 
+__n
+,
+
+377 
+mbe_t
+ *
+__ri
+ 
+__ps
+
+__THROW
+;
+
+378 
+__END_NAMESPACE_STD
+
+
+380 #ifde
+__USE_EXTERN_INLINES
+
+
+386 
+wt_t
+ 
+	$__btowc_s
+ (
+__c
+
+	`__asm
+ ("btowc");
+
+387 
+__ex_le
+ 
+wt_t
+
+
+388 
+	`__NTH
+ (
+	$btowc
+ (
+__c
+))
+
+389 {  (
+	`__but_ct_p
+ (
+__c
+) && __c >= '\0' && __c <= '\x7f'
+
+390 ? (
+wt_t
+
+__c
+ : 
+	`__btowc_s
+ (__c)); 
+	}
+}
+
+392 
+	$__wob_s
+ (
+wt_t
+ 
+__c
+
+	`__asm
+ ("wctob");
+
+393 
+__ex_le
+ 
+
+394 
+	`__NTH
+ (
+	$wob
+ (
+wt_t
+ 
+__wc
+))
+
+395 {  (
+	`__but_ct_p
+ (
+__wc
+&& __w>
+L
+'\0' && __wc <= L'\x7f'
+
+396 ? (
+__wc
+ : 
+	`__wob_s
+ (__wc)); 
+	}
+}
+
+398 
+__ex_le
+ 
+size_t
+
+
+399 
+__NTH
+ (
+	$mb
+ (c *
+__ri
+ 
+__s
+, 
+size_t
+ 
+__n
+,
+
+400 
+mbe_t
+ *
+__ri
+ 
+__ps
+))
+
+401 {  (
+__ps
+ !
+NULL
+
+
+402 ? 
+	`mbowc
+ (
+NULL
+, 
+__s
+, 
+__n
+, 
+__ps
+: 
+	`__mb
+ (__s, __n, NULL)); 
+	}
+}
+
+405 
+__BEGIN_NAMESPACE_STD
+
+
+408 
+size_t
+ 
+	$mbtowcs
+ (
+wch_t
+ *
+__ri
+ 
+__d
+,
+
+409 c **
+__ri
+ 
+__c
+, 
+size_t
+ 
+__n
+,
+
+410 
+mbe_t
+ *
+__ri
+ 
+__ps
+
+__THROW
+;
+
+414 
+size_t
+ 
+	$wctombs
+ (*
+__ri
+ 
+__d
+,
+
+415 c 
+wch_t
+ **
+__ri
+ 
+__c
+, 
+size_t
+ 
+__n
+,
+
+416 
+mbe_t
+ *
+__ri
+ 
+__ps
+
+__THROW
+;
+
+417 
+__END_NAMESPACE_STD
+
+
+420 #ifdef 
+__USE_XOPEN2K8
+
+
+423 
+size_t
+ 
+	$mbowcs
+ (
+wch_t
+ *
+__ri
+ 
+__d
+,
+
+424 c **
+__ri
+ 
+__c
+, 
+size_t
+ 
+__nmc
+,
+
+425 
+size_t
+ 
+__n
+, 
+mbe_t
+ *
+__ri
+ 
+__ps
+
+__THROW
+;
+
+429 
+size_t
+ 
+	$wcombs
+ (*
+__ri
+ 
+__d
+,
+
+430 c 
+wch_t
+ **
+__ri
+ 
+__c
+,
+
+431 
+size_t
+ 
+__nwc
+, size_
+__n
+,
+
+432 
+mbe_t
+ *
+__ri
+ 
+__ps
+
+__THROW
+;
+
+437 #ifde
+__USE_XOPEN
+
+
+439 
+	$wcwidth
+ (
+wch_t
+ 
+__c
+
+__THROW
+;
+
+443 
+	$wcswidth
+ (c 
+wch_t
+ *
+__s
+, 
+size_t
+ 
+__n
+
+__THROW
+;
+
+447 
+__BEGIN_NAMESPACE_STD
+
+
+450 
+	$wcod
+ (c 
+wch_t
+ *
+__ri
+ 
+__
+,
+
+451 
+wch_t
+ **
+__ri
+ 
+__dr
+
+__THROW
+;
+
+452 
+__END_NAMESPACE_STD
+
+
+454 #ifde
+__USE_ISOC99
+
+
+455 
+__BEGIN_NAMESPACE_C99
+
+
+457 
+	$wcof
+ (c 
+wch_t
+ *
+__ri
+ 
+__
+,
+
+458 
+wch_t
+ **
+__ri
+ 
+__dr
+
+__THROW
+;
+
+459 
+	$wcd
+ (c 
+wch_t
+ *
+__ri
+ 
+__
+,
+
+460 
+wch_t
+ **
+__ri
+ 
+__dr
+
+__THROW
+;
+
+461 
+__END_NAMESPACE_C99
+
+
+465 
+__BEGIN_NAMESPACE_STD
+
+
+468 
+	$wc
+ (c 
+wch_t
+ *
+__ri
+ 
+__
+,
+
+469 
+wch_t
+ **
+__ri
+ 
+__dr
+, 
+__ba
+
+__THROW
+;
+
+473 
+	$wcoul
+ (c 
+wch_t
+ *
+__ri
+ 
+__
+,
+
+474 
+wch_t
+ **
+__ri
+ 
+__dr
+, 
+__ba
+)
+
+475 
+__THROW
+;
+
+476 
+__END_NAMESPACE_STD
+
+
+478 #ifde
+__USE_ISOC99
+
+
+479 
+__BEGIN_NAMESPACE_C99
+
+
+482 
+__exnsi__
+
+
+483 
+	$wcl
+ (c 
+wch_t
+ *
+__ri
+ 
+__
+,
+
+484 
+wch_t
+ **
+__ri
+ 
+__dr
+, 
+__ba
+)
+
+485 
+__THROW
+;
+
+489 
+__exnsi__
+
+
+490 
+	$wcou
+ (c 
+wch_t
+ *
+__ri
+ 
+__
+,
+
+491 
+wch_t
+ **
+__ri
+ 
+__dr
+,
+
+492 
+__ba
+
+__THROW
+;
+
+493 
+__END_NAMESPACE_C99
+
+
+496 #ifde
+__USE_GNU
+
+
+499 
+__exnsi__
+
+
+500 
+	$wcoq
+ (c 
+wch_t
+ *
+__ri
+ 
+__
+,
+
+501 
+wch_t
+ **
+__ri
+ 
+__dr
+, 
+__ba
+)
+
+502 
+__THROW
+;
+
+506 
+__exnsi__
+
+
+507 
+	$wcouq
+ (c 
+wch_t
+ *
+__ri
+ 
+__
+,
+
+508 
+wch_t
+ **
+__ri
+ 
+__dr
+,
+
+509 
+__ba
+
+__THROW
+;
+
+512 #ifde
+__USE_GNU
+
+
+526 
+	~<xlo.h
+>
+
+530 
+	$wc_l
+ (c 
+wch_t
+ *
+__ri
+ 
+__
+,
+
+531 
+wch_t
+ **
+__ri
+ 
+__dr
+, 
+__ba
+,
+
+532 
+__lo_t
+ 
+__loc
+
+__THROW
+;
+
+534 
+	$wcoul_l
+ (c 
+wch_t
+ *
+__ri
+ 
+__
+,
+
+535 
+wch_t
+ **
+__ri
+ 
+__dr
+,
+
+536 
+__ba
+, 
+__lo_t
+ 
+__loc
+
+__THROW
+;
+
+538 
+__exnsi__
+
+
+539 
+	$wcl_l
+ (c 
+wch_t
+ *
+__ri
+ 
+__
+,
+
+540 
+wch_t
+ **
+__ri
+ 
+__dr
+,
+
+541 
+__ba
+, 
+__lo_t
+ 
+__loc
+
+__THROW
+;
+
+543 
+__exnsi__
+
+
+544 
+	$wcou_l
+ (c 
+wch_t
+ *
+__ri
+ 
+__
+,
+
+545 
+wch_t
+ **
+__ri
+ 
+__dr
+,
+
+546 
+__ba
+, 
+__lo_t
+ 
+__loc
+)
+
+547 
+__THROW
+;
+
+549 
+	$wcod_l
+ (c 
+wch_t
+ *
+__ri
+ 
+__
+,
+
+550 
+wch_t
+ **
+__ri
+ 
+__dr
+, 
+__lo_t
+ 
+__loc
+)
+
+551 
+__THROW
+;
+
+553 
+	$wcof_l
+ (c 
+wch_t
+ *
+__ri
+ 
+__
+,
+
+554 
+wch_t
+ **
+__ri
+ 
+__dr
+, 
+__lo_t
+ 
+__loc
+)
+
+555 
+__THROW
+;
+
+557 
+	$wcd_l
+ (c 
+wch_t
+ *
+__ri
+ 
+__
+,
+
+558 
+wch_t
+ **
+__ri
+ 
+__dr
+,
+
+559 
+__lo_t
+ 
+__loc
+
+__THROW
+;
+
+563 #ifde
+__USE_XOPEN2K8
+
+
+566 
+wch_t
+ *
+	$wy
+ (
+wch_t
+ *
+__ri
+ 
+__de
+,
+
+567 c 
+wch_t
+ *
+__ri
+ 
+__c
+
+__THROW
+;
+
+571 
+wch_t
+ *
+	$wny
+ (
+wch_t
+ *
+__ri
+ 
+__de
+,
+
+572 c 
+wch_t
+ *
+__ri
+ 
+__c
+, 
+size_t
+ 
+__n
+)
+
+573 
+__THROW
+;
+
+580 
+__FILE
+ *
+	$_wmemam
+ (
+wch_t
+ **
+__buoc
+, 
+size_t
+ *
+__sizoc
+
+__THROW
+;
+
+583 #i
+defed
+ 
+__USE_ISOC95
+ || defed 
+__USE_UNIX98
+
+
+584 
+__BEGIN_NAMESPACE_STD
+
+
+587 
+	$fwide
+ (
+__FILE
+ *
+__
+, 
+__mode
+
+__THROW
+;
+
+594 
+	`fwtf
+ (
+__FILE
+ *
+__ri
+ 
+__am
+,
+
+595 c 
+wch_t
+ *
+__ri
+ 
+__fm
+, ...)
+
+601 
+	`wtf
+ (c 
+wch_t
+ *
+__ri
+ 
+__fm
+, ...)
+
+604 
+	$swtf
+ (
+wch_t
+ *
+__ri
+ 
+__s
+, 
+size_t
+ 
+__n
+,
+
+605 c 
+wch_t
+ *
+__ri
+ 
+__fm
+, ...)
+
+606 
+__THROW
+ ;
+
+612 
+	`vfwtf
+ (
+__FILE
+ *
+__ri
+ 
+__s
+,
+
+613 c 
+wch_t
+ *
+__ri
+ 
+__fm
+,
+
+614 
+__gnuc_va_li
+ 
+__g
+)
+
+620 
+	`vwtf
+ (c 
+wch_t
+ *
+__ri
+ 
+__fm
+,
+
+621 
+__gnuc_va_li
+ 
+__g
+)
+
+625 
+	$vswtf
+ (
+wch_t
+ *
+__ri
+ 
+__s
+, 
+size_t
+ 
+__n
+,
+
+626 c 
+wch_t
+ *
+__ri
+ 
+__fm
+,
+
+627 
+__gnuc_va_li
+ 
+__g
+)
+
+628 
+__THROW
+ ;
+
+635 
+	`fwsnf
+ (
+__FILE
+ *
+__ri
+ 
+__am
+,
+
+636 c 
+wch_t
+ *
+__ri
+ 
+__fm
+, ...)
+
+642 
+	`wsnf
+ (c 
+wch_t
+ *
+__ri
+ 
+__fm
+, ...)
+
+645 
+	$swsnf
+ (c 
+wch_t
+ *
+__ri
+ 
+__s
+,
+
+646 c 
+wch_t
+ *
+__ri
+ 
+__fm
+, ...)
+
+647 
+__THROW
+ ;
+
+649 #i
+defed
+ 
+__USE_ISOC99
+ && !defed 
+__USE_GNU
+ \
+
+650 && (!
+defed
+ 
+__LDBL_COMPAT
+ || !defed 
+__REDIRECT
+) \
+
+651 && (
+defed
+ 
+__STRICT_ANSI__
+ || defed 
+__USE_XOPEN2K
+)
+
+652 #ifde
+__REDIRECT
+
+
+656 
+	`__REDIRECT
+ (
+fwsnf
+, (
+__FILE
+ *
+__ri
+ 
+__am
+,
+
+657 c 
+wch_t
+ *
+__ri
+ 
+__fm
+, ...),
+
+658 
+__isoc99_fwsnf
+)
+
+660 
+	`__REDIRECT
+ (
+wsnf
+, (c 
+wch_t
+ *
+__ri
+ 
+__fm
+, ...),
+
+661 
+__isoc99_wsnf
+)
+
+663 
+	`__REDIRECT_NTH
+ (
+swsnf
+, (c 
+wch_t
+ *
+__ri
+ 
+__s
+,
+
+664 c 
+wch_t
+ *
+__ri
+ 
+__fm
+,
+
+665 ...), 
+__isoc99_swsnf
+)
+
+668 
+	`__isoc99_fwsnf
+ (
+__FILE
+ *
+__ri
+ 
+__am
+,
+
+669 c 
+wch_t
+ *
+__ri
+ 
+__fm
+, ...);
+
+670 
+	`__isoc99_wsnf
+ (c 
+wch_t
+ *
+__ri
+ 
+__fm
+, ...);
+
+671 
+	$__isoc99_swsnf
+ (c 
+wch_t
+ *
+__ri
+ 
+__s
+,
+
+672 c 
+wch_t
+ *
+__ri
+ 
+__fm
+, ...)
+
+673 
+__THROW
+;
+
+674 
+	#fwsnf
+ 
+__isoc99_fwsnf
+
+
+	)
+
+675 
+	#wsnf
+ 
+__isoc99_wsnf
+
+
+	)
+
+676 
+	#swsnf
+ 
+__isoc99_swsnf
+
+
+	)
+
+680 
+__END_NAMESPACE_STD
+
+
+683 #ifde
+__USE_ISOC99
+
+
+684 
+__BEGIN_NAMESPACE_C99
+
+
+689 
+	`vfwsnf
+ (
+__FILE
+ *
+__ri
+ 
+__s
+,
+
+690 c 
+wch_t
+ *
+__ri
+ 
+__fm
+,
+
+691 
+__gnuc_va_li
+ 
+__g
+)
+
+697 
+	`vwsnf
+ (c 
+wch_t
+ *
+__ri
+ 
+__fm
+,
+
+698 
+__gnuc_va_li
+ 
+__g
+)
+
+701 
+	$vswsnf
+ (c 
+wch_t
+ *
+__ri
+ 
+__s
+,
+
+702 c 
+wch_t
+ *
+__ri
+ 
+__fm
+,
+
+703 
+__gnuc_va_li
+ 
+__g
+)
+
+704 
+__THROW
+ ;
+
+706 #i!
+defed
+ 
+__USE_GNU
+ \
+
+707 && (!
+defed
+ 
+__LDBL_COMPAT
+ || !defed 
+__REDIRECT
+) \
+
+708 && (
+defed
+ 
+__STRICT_ANSI__
+ || defed 
+__USE_XOPEN2K
+)
+
+709 #ifde
+__REDIRECT
+
+
+710 
+	`__REDIRECT
+ (
+vfwsnf
+, (
+__FILE
+ *
+__ri
+ 
+__s
+,
+
+711 c 
+wch_t
+ *
+__ri
+ 
+__fm
+,
+
+712 
+__gnuc_va_li
+ 
+__g
+), 
+__isoc99_vfwsnf
+)
+
+714 
+	`__REDIRECT
+ (
+vwsnf
+, (c 
+wch_t
+ *
+__ri
+ 
+__fm
+,
+
+715 
+__gnuc_va_li
+ 
+__g
+), 
+__isoc99_vwsnf
+)
+
+717 
+	`__REDIRECT_NTH
+ (
+vswsnf
+, (c 
+wch_t
+ *
+__ri
+ 
+__s
+,
+
+718 c 
+wch_t
+ *
+__ri
+ 
+__fm
+,
+
+719 
+__gnuc_va_li
+ 
+__g
+), 
+__isoc99_vswsnf
+)
+
+722 
+	`__isoc99_vfwsnf
+ (
+__FILE
+ *
+__ri
+ 
+__s
+,
+
+723 c 
+wch_t
+ *
+__ri
+ 
+__fm
+,
+
+724 
+__gnuc_va_li
+ 
+__g
+);
+
+725 
+	`__isoc99_vwsnf
+ (c 
+wch_t
+ *
+__ri
+ 
+__fm
+,
+
+726 
+__gnuc_va_li
+ 
+__g
+);
+
+727 
+	$__isoc99_vswsnf
+ (c 
+wch_t
+ *
+__ri
+ 
+__s
+,
+
+728 c 
+wch_t
+ *
+__ri
+ 
+__fm
+,
+
+729 
+__gnuc_va_li
+ 
+__g
+
+__THROW
+;
+
+730 
+	#vfwsnf
+ 
+__isoc99_vfwsnf
+
+
+	)
+
+731 
+	#vwsnf
+ 
+__isoc99_vwsnf
+
+
+	)
+
+732 
+	#vswsnf
+ 
+__isoc99_vswsnf
+
+
+	)
+
+736 
+__END_NAMESPACE_C99
+
+
+740 
+__BEGIN_NAMESPACE_STD
+
+
+745 
+wt_t
+ 
+	`fgwc
+ (
+__FILE
+ *
+__am
+);
+
+746 
+wt_t
+ 
+	`gwc
+ (
+__FILE
+ *
+__am
+);
+
+752 
+wt_t
+ 
+	`gwch
+ ();
+
+759 
+wt_t
+ 
+	`utwc
+ (
+wch_t
+ 
+__wc
+, 
+__FILE
+ *
+__am
+);
+
+760 
+wt_t
+ 
+	`putwc
+ (
+wch_t
+ 
+__wc
+, 
+__FILE
+ *
+__am
+);
+
+766 
+wt_t
+ 
+	`putwch
+ (
+wch_t
+ 
+__wc
+);
+
+774 
+wch_t
+ *
+	`fgws
+ (wch_*
+__ri
+ 
+__ws
+, 
+__n
+,
+
+775 
+__FILE
+ *
+__ri
+ 
+__am
+);
+
+781 
+	`utws
+ (c 
+wch_t
+ *
+__ri
+ 
+__ws
+,
+
+782 
+__FILE
+ *
+__ri
+ 
+__am
+);
+
+789 
+wt_t
+ 
+	`ungwc
+ (wt_
+__wc
+, 
+__FILE
+ *
+__am
+);
+
+790 
+__END_NAMESPACE_STD
+
+
+793 #ifde
+__USE_GNU
+
+
+801 
+wt_t
+ 
+	`gwc_uocked
+ (
+__FILE
+ *
+__am
+);
+
+802 
+wt_t
+ 
+	`gwch_uocked
+ ();
+
+810 
+wt_t
+ 
+	`fgwc_uocked
+ (
+__FILE
+ *
+__am
+);
+
+818 
+wt_t
+ 
+	`utwc_uocked
+ (
+wch_t
+ 
+__wc
+, 
+__FILE
+ *
+__am
+);
+
+827 
+wt_t
+ 
+	`putwc_uocked
+ (
+wch_t
+ 
+__wc
+, 
+__FILE
+ *
+__am
+);
+
+828 
+wt_t
+ 
+	`putwch_uocked
+ (
+wch_t
+ 
+__wc
+);
+
+837 
+wch_t
+ *
+	`fgws_uocked
+ (wch_*
+__ri
+ 
+__ws
+, 
+__n
+,
+
+838 
+__FILE
+ *
+__ri
+ 
+__am
+);
+
+846 
+	`utws_uocked
+ (c 
+wch_t
+ *
+__ri
+ 
+__ws
+,
+
+847 
+__FILE
+ *
+__ri
+ 
+__am
+);
+
+851 
+__BEGIN_NAMESPACE_C99
+
+
+855 
+size_t
+ 
+	$wcsime
+ (
+wch_t
+ *
+__ri
+ 
+__s
+, 
+size_t
+ 
+__maxsize
+,
+
+856 c 
+wch_t
+ *
+__ri
+ 
+__fm
+,
+
+857 c 
+tm
+ *
+__ri
+ 
+__
+
+__THROW
+;
+
+858 
+__END_NAMESPACE_C99
+
+
+860 #ifde
+__USE_GNU
+
+
+861 
+	~<xlo.h
+>
+
+865 
+size_t
+ 
+	$wcsime_l
+ (
+wch_t
+ *
+__ri
+ 
+__s
+, 
+size_t
+ 
+__maxsize
+,
+
+866 c 
+wch_t
+ *
+__ri
+ 
+__fm
+,
+
+867 c 
+tm
+ *
+__ri
+ 
+__
+,
+
+868 
+__lo_t
+ 
+__loc
+
+__THROW
+;
+
+877 #i
+defed
+ 
+__USE_UNIX98
+ && !defed 
+__USE_GNU
+
+
+878 
+	#__ed_iswxxx
+
+
+	)
+
+879 
+	~<wy.h
+>
+
+883 #i
+__USE_FORTIFY_LEVEL
+ > 0 && 
+defed
+ 
+__ftify_funi
+
+
+884 
+	~<bs/wch2.h
+>
+
+887 #ifde
+__LDBL_COMPAT
+
+
+888 
+	~<bs/wch-ldbl.h
+>
+
+891 
+__END_DECLS
+
+
+899 #unde
+__ed_mbe_t
+
+
+900 #unde
+__ed_wt_t
+
+
+	@/usr/include/linux/stddef.h
+
+	@/usr/include/wctype.h
+
+23 #ide
+_WCTYPE_H
+
+
+25 
+	~<us.h
+>
+
+26 
+	~<bs/tys.h
+>
+
+28 #ide
+__ed_iswxxx
+
+
+29 
+	#_WCTYPE_H
+ 1
+
+	)
+
+32 
+	#__ed_wt_t
+
+
+	)
+
+33 
+	~<wch.h
+>
+
+37 #ide
+WEOF
+
+
+38 
+	#WEOF
+ (0xffffffffu)
+
+	)
+
+41 #unde
+__ed_iswxxx
+
+
+46 #ide
+__iswxxx_defed
+
+
+47 
+	#__iswxxx_defed
+ 1
+
+	)
+
+49 
+__BEGIN_NAMESPACE_C99
+
+
+52 
+	twy_t
+;
+
+53 
+	g__END_NAMESPACE_C99
+
+
+55 #ide
+_ISwb
+
+
+60 
+	~<dn.h
+>
+
+61 #i
+__BYTE_ORDER
+ =
+__BIG_ENDIAN
+
+
+62 
+	#_ISwb
+(
+b
+(1 << (b))
+
+	)
+
+64 
+	#_ISwb
+(
+b
+) \
+
+65 ((
+b
+) < 8 ? () ((1UL << (bit)) << 24) \
+
+66 : ((
+b
+) < 16 ? () ((1UL << (bit)) << 8) \
+
+67 : ((
+b
+) < 24 ? () ((1UL << (bit)) >> 8) \
+
+68 : (((1UL << (
+b
+)>> 24))))
+
+	)
+
+73 
+	m__ISwu
+ = 0,
+
+74 
+	m__ISwlow
+ = 1,
+
+75 
+	m__ISwpha
+ = 2,
+
+76 
+	m__ISwdig
+ = 3,
+
+77 
+	m__ISwxdig
+ = 4,
+
+78 
+	m__ISwa
+ = 5,
+
+79 
+	m__ISwt
+ = 6,
+
+80 
+	m__ISwgph
+ = 7,
+
+81 
+	m__ISwbnk
+ = 8,
+
+82 
+	m__ISwl
+ = 9,
+
+83 
+	m__ISwpun
+ = 10,
+
+84 
+	m__ISwnum
+ = 11,
+
+86 
+	m_ISwu
+ = 
+_ISwb
+ (
+__ISwu
+),
+
+87 
+	m_ISwlow
+ = 
+_ISwb
+ (
+__ISwlow
+),
+
+88 
+	m_ISwpha
+ = 
+_ISwb
+ (
+__ISwpha
+),
+
+89 
+	m_ISwdig
+ = 
+_ISwb
+ (
+__ISwdig
+),
+
+90 
+	m_ISwxdig
+ = 
+_ISwb
+ (
+__ISwxdig
+),
+
+91 
+	m_ISwa
+ = 
+_ISwb
+ (
+__ISwa
+),
+
+92 
+	m_ISwt
+ = 
+_ISwb
+ (
+__ISwt
+),
+
+93 
+	m_ISwgph
+ = 
+_ISwb
+ (
+__ISwgph
+),
+
+94 
+	m_ISwbnk
+ = 
+_ISwb
+ (
+__ISwbnk
+),
+
+95 
+	m_ISwl
+ = 
+_ISwb
+ (
+__ISwl
+),
+
+96 
+	m_ISwpun
+ = 
+_ISwb
+ (
+__ISwpun
+),
+
+97 
+	m_ISwnum
+ = 
+_ISwb
+ (
+__ISwnum
+)
+
+102 
+__BEGIN_DECLS
+
+
+104 
+__BEGIN_NAMESPACE_C99
+
+
+111 
+	$iswnum
+ (
+wt_t
+ 
+__wc
+
+__THROW
+;
+
+117 
+	$iswpha
+ (
+wt_t
+ 
+__wc
+
+__THROW
+;
+
+120 
+	$iswl
+ (
+wt_t
+ 
+__wc
+
+__THROW
+;
+
+124 
+	$iswdig
+ (
+wt_t
+ 
+__wc
+
+__THROW
+;
+
+128 
+	$iswgph
+ (
+wt_t
+ 
+__wc
+
+__THROW
+;
+
+133 
+	$iswlow
+ (
+wt_t
+ 
+__wc
+
+__THROW
+;
+
+136 
+	$iswt
+ (
+wt_t
+ 
+__wc
+
+__THROW
+;
+
+141 
+	$iswpun
+ (
+wt_t
+ 
+__wc
+
+__THROW
+;
+
+146 
+	$iswa
+ (
+wt_t
+ 
+__wc
+
+__THROW
+;
+
+151 
+	$iswu
+ (
+wt_t
+ 
+__wc
+
+__THROW
+;
+
+156 
+	$iswxdig
+ (
+wt_t
+ 
+__wc
+
+__THROW
+;
+
+161 #ifde
+__USE_ISOC99
+
+
+162 
+	$iswbnk
+ (
+wt_t
+ 
+__wc
+
+__THROW
+;
+
+171 
+wy_t
+ 
+	$wy
+ (c *
+__ty
+
+__THROW
+;
+
+175 
+	$iswy
+ (
+wt_t
+ 
+__wc
+, 
+wy_t
+ 
+__desc
+
+__THROW
+;
+
+176 
+__END_NAMESPACE_C99
+
+
+183 
+__BEGIN_NAMESPACE_C99
+
+
+186 c 
+	t__t32_t
+ *
+	twns_t
+;
+
+187 
+__END_NAMESPACE_C99
+
+
+188 #ifde
+__USE_GNU
+
+
+189 
+	$__USING_NAMESPACE_C99
+(
+wns_t
+)
+
+192 
+__BEGIN_NAMESPACE_C99
+
+
+194 
+wt_t
+ 
+	$towlow
+ (
+wt_t
+ 
+__wc
+
+__THROW
+;
+
+197 
+wt_t
+ 
+	$towu
+ (
+wt_t
+ 
+__wc
+
+__THROW
+;
+
+198 
+__END_NAMESPACE_C99
+
+
+200 
+__END_DECLS
+
+
+207 #ifde
+_WCTYPE_H
+
+
+213 
+__BEGIN_DECLS
+
+
+215 
+__BEGIN_NAMESPACE_C99
+
+
+218 
+wns_t
+ 
+	$wns
+ (c *
+__ty
+
+__THROW
+;
+
+221 
+wt_t
+ 
+	$towns
+ (
+wt_t
+ 
+__wc
+, 
+wns_t
+ 
+__desc
+
+__THROW
+;
+
+222 
+__END_NAMESPACE_C99
+
+
+224 #ifde
+__USE_XOPEN2K8
+
+
+226 
+	~<xlo.h
+>
+
+230 
+	$iswnum_l
+ (
+wt_t
+ 
+__wc
+, 
+__lo_t
+ 
+__lo
+
+__THROW
+;
+
+236 
+	$iswpha_l
+ (
+wt_t
+ 
+__wc
+, 
+__lo_t
+ 
+__lo
+
+__THROW
+;
+
+239 
+	$iswl_l
+ (
+wt_t
+ 
+__wc
+, 
+__lo_t
+ 
+__lo
+
+__THROW
+;
+
+243 
+	$iswdig_l
+ (
+wt_t
+ 
+__wc
+, 
+__lo_t
+ 
+__lo
+
+__THROW
+;
+
+247 
+	$iswgph_l
+ (
+wt_t
+ 
+__wc
+, 
+__lo_t
+ 
+__lo
+
+__THROW
+;
+
+252 
+	$iswlow_l
+ (
+wt_t
+ 
+__wc
+, 
+__lo_t
+ 
+__lo
+
+__THROW
+;
+
+255 
+	$iswt_l
+ (
+wt_t
+ 
+__wc
+, 
+__lo_t
+ 
+__lo
+
+__THROW
+;
+
+260 
+	$iswpun_l
+ (
+wt_t
+ 
+__wc
+, 
+__lo_t
+ 
+__lo
+
+__THROW
+;
+
+265 
+	$iswa_l
+ (
+wt_t
+ 
+__wc
+, 
+__lo_t
+ 
+__lo
+
+__THROW
+;
+
+270 
+	$iswu_l
+ (
+wt_t
+ 
+__wc
+, 
+__lo_t
+ 
+__lo
+
+__THROW
+;
+
+275 
+	$iswxdig_l
+ (
+wt_t
+ 
+__wc
+, 
+__lo_t
+ 
+__lo
+
+__THROW
+;
+
+280 
+	$iswbnk_l
+ (
+wt_t
+ 
+__wc
+, 
+__lo_t
+ 
+__lo
+
+__THROW
+;
+
+284 
+wy_t
+ 
+	$wy_l
+ (c *
+__ty
+, 
+__lo_t
+ 
+__lo
+)
+
+285 
+__THROW
+;
+
+289 
+	$iswy_l
+ (
+wt_t
+ 
+__wc
+, 
+wy_t
+ 
+__desc
+, 
+__lo_t
+ 
+__lo
+)
+
+290 
+__THROW
+;
+
+298 
+wt_t
+ 
+	$towlow_l
+ (
+wt_t
+ 
+__wc
+, 
+__lo_t
+ 
+__lo
+
+__THROW
+;
+
+301 
+wt_t
+ 
+	$towu_l
+ (
+wt_t
+ 
+__wc
+, 
+__lo_t
+ 
+__lo
+
+__THROW
+;
+
+305 
+wns_t
+ 
+	$wns_l
+ (c *
+__ty
+, 
+__lo_t
+ 
+__lo
+)
+
+306 
+__THROW
+;
+
+309 
+wt_t
+ 
+	$towns_l
+ (
+wt_t
+ 
+__wc
+, 
+wns_t
+ 
+__desc
+,
+
+310 
+__lo_t
+ 
+__lo
+
+__THROW
+;
+
+314 
+__END_DECLS
+
+
+	@
+1
+.
+1
+/usr/include
+209
+3435
+agr/ieee8023_slowprotocols.h
+agr/ieee8023_tlv.c
+agr/ieee8023_tlv.h
+agr/ieee8023ad.h
+agr/ieee8023ad_impl.h
+agr/ieee8023ad_lacp.c
+agr/ieee8023ad_lacp.h
+agr/ieee8023ad_lacp_debug.c
+agr/ieee8023ad_lacp_debug.h
+agr/ieee8023ad_lacp_impl.h
+agr/ieee8023ad_lacp_select.c
+agr/ieee8023ad_lacp_sm.h
+agr/ieee8023ad_lacp_sm_mux.c
+agr/ieee8023ad_lacp_sm_ptx.c
+agr/ieee8023ad_lacp_sm_rx.c
+agr/ieee8023ad_lacp_sm_tx.c
+agr/ieee8023ad_lacp_timer.c
+agr/ieee8023ad_marker.c
+agr/ieee8023ad_marker.h
+agr/if_agr.c
+agr/if_agrether.c
+agr/if_agrether_hash.c
+agr/if_agrethervar.h
+agr/if_agrioctl.h
+agr/if_agrmonitor.c
+agr/if_agrsoftc.c
+agr/if_agrsubr.c
+agr/if_agrsubr.h
+agr/if_agrtimer.c
+agr/if_agrvar.h
+agr/if_agrvar_impl.h
+bpf.c
+bpf.h
+bpf_filter.c
+bpf_stub.c
+bpfdesc.h
+bpfjit.c
+bpfjit.h
+bridgestp.c
+bsd-comp.c
+dl_print.c
+dlt.h
+ethertypes.h
+if.c
+if.h
+if_arc.h
+if_arcsubr.c
+if_arp.h
+if_atm.h
+if_atmsubr.c
+if_bridge.c
+if_bridgevar.h
+if_cnic.c
+if_cnic.h
+if_dl.h
+if_eco.h
+if_ecosubr.c
+if_ether.h
+if_etherip.c
+if_etherip.h
+if_ethersubr.c
+if_faith.c
+if_faith.h
+if_fddi.h
+if_fddisubr.c
+if_gif.c
+if_gif.h
+if_gre.c
+if_gre.h
+if_hippi.h
+if_hippisubr.c
+if_ieee1394.h
+if_ieee1394subr.c
+if_llc.h
+if_loop.c
+if_media.c
+if_media.h
+if_mpls.c
+if_mpls.h
+if_ppp.c
+if_ppp.h
+if_pppoe.c
+if_pppoe.h
+if_pppvar.h
+if_sl.c
+if_slvar.h
+if_sppp.h
+if_spppsubr.c
+if_spppvar.h
+if_srt.c
+if_srt.h
+if_stf.c
+if_stf.h
+if_strip.c
+if_stripvar.h
+if_tap.c
+if_tap.h
+if_token.h
+if_tokensubr.c
+if_tun.c
+if_tun.h
+if_types.h
+if_vlan.c
+if_vlanvar.h
+link_proto.c
+net_osdep.h
+net_stats.c
+net_stats.h
+netisr.h
+netisr_dispatch.h
+npf/if_npflog.c
+npf/npf.c
+npf/npf.h
+npf/npf_alg.c
+npf/npf_alg_icmp.c
+npf/npf_bpf.c
+npf/npf_conf.c
+npf/npf_conn.c
+npf/npf_conn.h
+npf/npf_conndb.c
+npf/npf_ctl.c
+npf/npf_ext_log.c
+npf/npf_ext_normalize.c
+npf/npf_ext_rndblock.c
+npf/npf_handler.c
+npf/npf_if.c
+npf/npf_impl.h
+npf/npf_inet.c
+npf/npf_mbuf.c
+npf/npf_nat.c
+npf/npf_rproc.c
+npf/npf_ruleset.c
+npf/npf_sendpkt.c
+npf/npf_state.c
+npf/npf_state_tcp.c
+npf/npf_tableset.c
+npf/npf_tableset_ptree.c
+npf/npf_worker.c
+pfil.c
+pfil.h
+pfkeyv2.h
+pktqueue.c
+pktqueue.h
+ppp-comp.h
+ppp-deflate.c
+ppp_defs.h
+ppp_tty.c
+radix.c
+radix.h
+raw_cb.c
+raw_cb.h
+raw_usrreq.c
+route.c
+route.h
+rtbl.c
+rtsock.c
+slcompress.c
+slcompress.h
+slip.h
+zlib.c
+zlib.h
+../../../platform/cos/cosrun.h
+/usr/include/assert.h
+/usr/include/ctype.h
+/usr/include/errno.h
+/usr/include/limits.h
+/usr/include/linux/string.h
+/usr/include/malloc.h
+/usr/include/net/if.h
+/usr/include/net/if_arp.h
+/usr/include/net/if_ppp.h
+/usr/include/net/ppp-comp.h
+/usr/include/net/ppp_defs.h
+/usr/include/net/route.h
+/usr/include/netatalk/at.h
+/usr/include/netinet/icmp6.h
+/usr/include/netinet/in.h
+/usr/include/netinet/in_systm.h
+/usr/include/netinet/ip.h
+/usr/include/netinet/ip6.h
+/usr/include/netinet/ip_icmp.h
+/usr/include/netinet/tcp.h
+/usr/include/netinet/udp.h
+/usr/include/netipx/ipx.h
+/usr/include/stdint.h
+/usr/include/stdio.h
+/usr/include/stdlib.h
+/usr/include/string.h
+/usr/include/unistd.h
+/usr/include/alloca.h
+/usr/include/endian.h
+/usr/include/features.h
+/usr/include/getopt.h
+/usr/include/inttypes.h
+/usr/include/libio.h
+/usr/include/linux/atalk.h
+/usr/include/linux/ppp-comp.h
+/usr/include/linux/ppp_defs.h
+/usr/include/time.h
+/usr/include/xlocale.h
+/usr/include/_G_config.h
+/usr/include/linux/socket.h
+/usr/include/linux/types.h
+/usr/include/stdc-predef.h
+/usr/include/gconv.h
+/usr/include/linux/posix_types.h
+/usr/include/wchar.h
+/usr/include/linux/stddef.h
+/usr/include/wctype.h
diff --git a/sys/net/if_bridge.c b/sys/net/if_bridge.c
index a37777f..c55be91 100644
--- a/sys/net/if_bridge.c
+++ b/sys/net/if_bridge.c
@@ -1677,6 +1677,7 @@ bridge_start(struct ifnet *ifp)
 static void
 bridge_forward(void *v)
 {
+	printf("bridge_forward\n");
 	struct bridge_softc *sc = v;
 	struct mbuf *m;
 	struct bridge_iflist *bif;
diff --git a/sys/net/if_cnic.c b/sys/net/if_cnic.c
index b3344d9..20bb44b 100644
--- a/sys/net/if_cnic.c
+++ b/sys/net/if_cnic.c
@@ -28,7 +28,6 @@
 #include <net/netisr.h>
 #include <net/route.h>
 
-
 #ifdef INET
 #include <netinet/in.h>
 #include <netinet/in_systm.h>
@@ -37,7 +36,6 @@
 #include <netinet/if_inarp.h>
 #endif
 
-
 #include <sys/time.h>
 #include <net/bpf.h>
 
@@ -45,10 +43,9 @@
 
 #define CNICDEBUG	if (cnicdebug) printf
 int	cnicdebug = 0;
-
 extern int ifqmaxlen;
 void	cnicattach(int);
-
+extern int rump_vmid;
 static LIST_HEAD(, cnic_softc) cnic_softc_list;
 static LIST_HEAD(, cnic_softc) cnicz_softc_list;
 static kmutex_t cnic_softc_lock;
@@ -80,6 +77,8 @@ static dev_type_ioctl(cnicioctl);
 static dev_type_poll(cnicpoll);
 static dev_type_kqfilter(cnickqfilter);
 
+extern struct cos_rumpcalls crcalls;
+
 const struct cdevsw cnic_cdevsw = {
 	.d_open = cnicopen,
 	.d_close = cnicclose,
@@ -95,6 +94,7 @@ const struct cdevsw cnic_cdevsw = {
 	.d_flag = D_OTHER
 };
 
+
 void
 cnicattach(int unused)
 {
@@ -478,6 +478,8 @@ static int
 cnic_output(struct ifnet *ifp, struct mbuf *m0, const struct sockaddr *dst,
     struct rtentry *rt)
 {
+	printf("cnic_output: %s\n", ifp->if_xname);
+	
 	struct cnic_softc *tp = ifp->if_softc;
 	int		s;
 	int		error;
@@ -485,11 +487,11 @@ cnic_output(struct ifnet *ifp, struct mbuf *m0, const struct sockaddr *dst,
 	int		mlen;
 	uint32_t	*af;
 #endif
+
 	ALTQ_DECL(struct altq_pktattr pktattr;)
 
 	s = splnet();
 	mutex_enter(&tp->cnic_lock);
-	CNICDEBUG ("%s: cnic_output\n", ifp->if_xname);
 
 	if ((tp->cnic_flags & CNIC_READY) != CNIC_READY) {
 		CNICDEBUG ("%s: not ready 0%o\n", ifp->if_xname,
@@ -546,7 +548,10 @@ cnic_output(struct ifnet *ifp, struct mbuf *m0, const struct sockaddr *dst,
 		}
 		/* FALLTHROUGH */
 	case AF_UNSPEC:
-		IFQ_ENQUEUE(&ifp->if_snd, m0, &pktattr, error);
+		
+		//IFQ_ENQUEUE(&ifp->if_snd, m0, &pktattr, error);
+		error = cos_pktq_enqueue(&m0, !rump_vmid);
+			
 		if (error) {
 			ifp->if_collisions++;
 			error = EAFNOSUPPORT;
@@ -556,6 +561,7 @@ cnic_output(struct ifnet *ifp, struct mbuf *m0, const struct sockaddr *dst,
 		mlen = m0->m_pkthdr.len;
 		ifp->if_opackets++;
 		ifp->if_obytes += mlen;
+		//should probably return.
 		break;
 #endif
 	default:
@@ -715,6 +721,8 @@ out_nolock:
 int
 cnicread(dev_t dev, struct uio *uio, int ioflag)
 {
+	printf("cnic read %d:\n", rump_vmid);
+	
 	struct cnic_softc *tp;
 	struct ifnet	*ifp;
 	struct mbuf	*m, *m0;
@@ -740,7 +748,7 @@ cnicread(dev_t dev, struct uio *uio, int ioflag)
 	}
 
 	tp->cnic_flags &= ~CNIC_RWAIT;
-
+	
 	do {
 		IFQ_DEQUEUE(&ifp->if_snd, m0);
 		if (m0 == 0) {
@@ -772,7 +780,7 @@ cnicread(dev_t dev, struct uio *uio, int ioflag)
 			}
 		}
 	} while (m0 == 0);
-
+	
 	mutex_exit(&tp->cnic_lock);
 	splx(s);
 
@@ -795,6 +803,7 @@ cnicread(dev_t dev, struct uio *uio, int ioflag)
 	return (error);
 
 out:
+	printf("out\n");
 	mutex_exit(&tp->cnic_lock);
 out_nolock:
 	splx(s);
@@ -807,6 +816,11 @@ out_nolock:
 int
 cnicwrite(dev_t dev, struct uio *uio, int ioflag)
 {
+	if(1) {
+		printf("cnicwrite\n");
+//		return 0;
+	}
+	
 	struct cnic_softc *tp;
 	struct ifnet	*ifp;
 	struct mbuf	*top, **mp, *m;
@@ -915,7 +929,7 @@ cnicwrite(dev_t dev, struct uio *uio, int ioflag)
 		ifp->if_ierrors++;
 		goto out0;
 	}
-
+	
 	top->m_pkthdr.len = tlen;
 	top->m_pkthdr.rcvif = ifp;
 
@@ -928,6 +942,7 @@ cnicwrite(dev_t dev, struct uio *uio, int ioflag)
 		error = ENXIO;
 		goto out;
 	}
+
 	if (__predict_false(!pktq_enqueue(pktq, top, 0))) {
 		ifp->if_collisions++;
 		mutex_exit(&tp->cnic_lock);
diff --git a/sys/net/if_ethersubr.c b/sys/net/if_ethersubr.c
index 70c678f..1a3a8a5 100644
--- a/sys/net/if_ethersubr.c
+++ b/sys/net/if_ethersubr.c
@@ -581,6 +581,7 @@ altq_etherclassify(struct ifaltq *ifq, struct mbuf *m,
 void
 ether_input(struct ifnet *ifp, struct mbuf *m)
 {
+	printf("ether_input\n");
 	struct ethercom *ec = (struct ethercom *) ifp;
 	pktqueue_t *pktq = NULL;
 	struct ifqueue *inq = NULL;
diff --git a/sys/net/if_tap.c b/sys/net/if_tap.c
index fd979e8..65a5d4d 100644
--- a/sys/net/if_tap.c
+++ b/sys/net/if_tap.c
@@ -587,6 +587,7 @@ tap_lifaddr(struct ifnet *ifp, u_long cmd, struct ifaliasreq *ifra)
 static int
 tap_init(struct ifnet *ifp)
 {
+	aprint_error("\n\n\n\n\n tap_init \n\n\n\n\n");
 	ifp->if_flags |= IFF_RUNNING;
 
 	tap_start(ifp);
diff --git a/sys/net/pktqueue.c b/sys/net/pktqueue.c
index cf3f96d..64cd6b8 100644
--- a/sys/net/pktqueue.c
+++ b/sys/net/pktqueue.c
@@ -48,9 +48,9 @@ __KERNEL_RCSID(0, "$NetBSD: pktqueue.c,v 1.8 2014/07/04 01:50:22 ozaki-r Exp $")
 #include <sys/mbuf.h>
 #include <sys/proc.h>
 #include <sys/percpu.h>
-
 #include <net/pktqueue.h>
-
+#include "../../../platform/cos/cosrun.h"
+extern int rump_vmid;
 /*
  * WARNING: update this if struct pktqueue changes.
  */
@@ -197,7 +197,6 @@ pktq_rps_hash(const struct mbuf *m __unused)
 	 */
 	return 0;
 }
-
 /*
  * pktq_enqueue: inject the packet into the end of the queue.
  *
@@ -205,15 +204,29 @@ pktq_rps_hash(const struct mbuf *m __unused)
  * => Consumes the packet and returns true on success.
  * => Returns false on failure; caller is responsible to free the packet.
  */
+
+bool
+cos_pktq_enqueue(void *buff, int to_vmid)
+{
+	printf("cos_pktq_enqueue\n");
+	KASSERT(kpreempt_disabled());
+	
+	if(!rump_shmem_write(buff, sizeof(buff), rump_vmid, to_vmid)){
+		return false;
+	}
+	
+	return true;
+}
+
 bool
 pktq_enqueue(pktqueue_t *pq, struct mbuf *m, const u_int hash __unused)
 {
+	printf("pktq_enqueue\n");
 #if defined(_RUMPKERNEL) || defined(_RUMP_NATIVE_ABI)
 	const unsigned cpuid = curcpu()->ci_index;
 #else
 	const unsigned cpuid = hash % ncpu;
 #endif
-
 	KASSERT(kpreempt_disabled());
 
 	if (__predict_false(!pcq_put(pq->pq_queue[cpuid], m))) {
@@ -231,16 +244,34 @@ pktq_enqueue(pktqueue_t *pq, struct mbuf *m, const u_int hash __unused)
  * => Must be called with preemption disabled.
  * => Must ensure there are not concurrent dequeue calls.
  */
+
+struct mbuf *
+cos_pktq_dequeue(pktqueue_t *pq)
+{
+	printf("cos_pktq_enqueue\n");
+	struct mbuf *m;
+	
+	if(!rump_shmem_read(&m, !rump_vmid, rump_vmid)){
+		printf("read failed\n");
+		return NULL;
+	}
+	if (__predict_true(m != NULL)) {
+		pktq_inc_count(pq, PQCNT_DEQUEUE);
+	}
+	return m;	
+}
+
 struct mbuf *
 pktq_dequeue(pktqueue_t *pq)
 {
+	printf("pktq_dequeue\n");
 	const struct cpu_info *ci = curcpu();
 	const unsigned cpuid = cpu_index(ci);
 	struct mbuf *m;
-
+	
 	m = pcq_get(pq->pq_queue[cpuid]);
 	if (__predict_false(m == PKTQ_MARKER)) {
-		/* Note the marker entry. */
+		// Note the marker entry. 
 		atomic_inc_uint(&pq->pq_barrier);
 		return NULL;
 	}
diff --git a/sys/net/pktqueue.h b/sys/net/pktqueue.h
index c50d8c2..23d5da7 100644
--- a/sys/net/pktqueue.h
+++ b/sys/net/pktqueue.h
@@ -48,7 +48,9 @@ pktqueue_t *	pktq_create(size_t, void (*)(void *), void *);
 void		pktq_destroy(pktqueue_t *);
 
 bool		pktq_enqueue(pktqueue_t *, struct mbuf *, const u_int);
+bool		cos_pktq_enqueue(void * buff, int to_vmid);
 struct mbuf *	pktq_dequeue(pktqueue_t *);
+struct mbuf *	cos_pktq_dequeue(pktqueue_t *);
 void		pktq_barrier(pktqueue_t *);
 void		pktq_flush(pktqueue_t *);
 int		pktq_set_maxlen(pktqueue_t *, size_t);
diff --git a/sys/net/route.c b/sys/net/route.c
index ecbc88b..09d1438 100644
--- a/sys/net/route.c
+++ b/sys/net/route.c
@@ -1157,6 +1157,7 @@ rt_ifa_remlocal(struct ifaddr *ifa, struct ifaddr *alt_ifa)
 		rt_newaddrmsg(RTM_DELADDR, ifa, 0, NULL);
 	if (rt != NULL)
 		rt->rt_refcnt--;
+	printf("return here before failing\n");
 	return e;
 }
 
diff --git a/sys/netinet/.ip_input.c.swp b/sys/netinet/.ip_input.c.swp
new file mode 100644
index 0000000000000000000000000000000000000000..7d11b1e7ad1e57e053412f3ec93af65e6a38b9a3
GIT binary patch
literal 20480
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

literal 0
HcmV?d00001

diff --git a/sys/netinet/ip_input.c b/sys/netinet/ip_input.c
index b6200ce..15a620c 100644
--- a/sys/netinet/ip_input.c
+++ b/sys/netinet/ip_input.c
@@ -344,6 +344,7 @@ ip_init(void)
 static void
 ipintr(void *arg __unused)
 {
+	printf("ipintr\n");
 	struct mbuf *m;
 
 	KASSERT(cpu_softintr_p());
@@ -352,6 +353,7 @@ ipintr(void *arg __unused)
 	while ((m = pktq_dequeue(ip_pktq)) != NULL) {
 		ip_input(m);
 	}
+	printf("ipintr exit\n");
 	mutex_exit(softnet_lock);
 }
 
@@ -1269,10 +1271,11 @@ ip_forward(struct mbuf *m, int srcrt)
 			code = ICMP_REDIRECT_HOST;
 		}
 	}
-
+	printf("IP_OUTPUT\n");
 	error = ip_output(m, NULL, &ipforward_rt,
 	    (IP_FORWARDING | (ip_directedbcast ? IP_ALLOWBROADCAST : 0)),
 	    NULL, NULL);
+	printf("post cnicoutput\n");
 
 	if (error) {
 		IP_STATINC(IP_STAT_CANTFORWARD);
diff --git a/sys/rump/net/lib/libtap/tap_component.c b/sys/rump/net/lib/libtap/tap_component.c
index 457e249..f0b4559 100644
--- a/sys/rump/net/lib/libtap/tap_component.c
+++ b/sys/rump/net/lib/libtap/tap_component.c
@@ -46,7 +46,8 @@ void cnicattach(int);
 RUMP_COMPONENT(RUMP_COMPONENT_NET_IF)
 {
 
-
+/*----------------------------------*/
+	/*first tap*/
 	extern const struct cdevsw tap_cdevsw;
 	devmajor_t bmaj_tap, cmaj_tap;
 	int error;
@@ -67,6 +68,11 @@ RUMP_COMPONENT(RUMP_COMPONENT_NET_IF)
 	if (error != 0)
 		panic("cannot create tap[0-4] device node: %d", error);
 
+	
+	
+	
+	
+	
 	/* ----- TUN ----- */
 	/* RG: attepting to add cnic to the tap component for rump */
 	rumpuser_dprintf("----- Hello! Greetings from the tap source code! -----\n");
-- 
1.9.1


From a70d8a946dd6ed487aaece756567820c293bf482 Mon Sep 17 00:00:00 2001
From: lab176 <lbaier176@gmail.com>
Date: Thu, 11 Aug 2016 13:25:10 -0400
Subject: [PATCH 5/7] "temp commmit to merge Robbie's code for correct inter RK
 routing"

---
 sys/net/Makefile        |  4 ++--
 sys/net/if_cnic.c       | 45 +++++++++++++++++++++++++++++----------------
 sys/net/if_ethersubr.c  |  9 ++++++++-
 sys/net/pktqueue.c      | 29 +++++++++++++++--------------
 sys/net/pktqueue.h      |  2 +-
 sys/netinet/ip_input.c  | 45 +++++++++++++++++++++++++++++++--------------
 sys/netinet/ip_output.c |  2 +-
 7 files changed, 87 insertions(+), 49 deletions(-)

diff --git a/sys/net/Makefile b/sys/net/Makefile
index 057f810..b846802 100644
--- a/sys/net/Makefile
+++ b/sys/net/Makefile
@@ -8,12 +8,12 @@ INCS=	bpf.h bpfjit.h bpfdesc.h dlt.h ethertypes.h if.h if_arc.h if_arp.h \
 	if_pflog.h if_ppp.h if_pppoe.h if_sppp.h if_srt.h if_stf.h \
 	if_tap.h if_token.h if_tun.h if_types.h if_vlanvar.h net_stats.h \
 	netisr.h pfil.h pfkeyv2.h pfvar.h ppp-comp.h ppp_defs.h radix.h \
-	raw_cb.h route.h slcompress.h slip.h zlib.h rumpcalls.h  
+	raw_cb.h route.h slcompress.h slip.h zlib.h
 
 
 
 SUBDIR=	agr npf
 
-#include <bsd.kinc.mk>
+.include <bsd.kinc.mk>
 
 .PATH: ${NETBSDSRCDIR}/sys/dist/pf/net
diff --git a/sys/net/if_cnic.c b/sys/net/if_cnic.c
index 20bb44b..c40f23e 100644
--- a/sys/net/if_cnic.c
+++ b/sys/net/if_cnic.c
@@ -77,8 +77,6 @@ static dev_type_ioctl(cnicioctl);
 static dev_type_poll(cnicpoll);
 static dev_type_kqfilter(cnickqfilter);
 
-extern struct cos_rumpcalls crcalls;
-
 const struct cdevsw cnic_cdevsw = {
 	.d_open = cnicopen,
 	.d_close = cnicclose,
@@ -261,6 +259,9 @@ cnic_clone_destroy(struct ifnet *ifp)
  * cnicnel open - must be superuser & the device must be
  * configured in
  */
+
+struct ifnet *global_ifp = 0;
+
 static int
 cnicopen(dev_t dev, int flag, int mode, struct lwp *l)
 {
@@ -290,6 +291,7 @@ cnicopen(dev_t dev, int flag, int mode, struct lwp *l)
 	}
 
 	ifp = &tp->cnic_if;
+	global_ifp = ifp;
 	tp->cnic_flags |= CNIC_OPEN;
 	CNICDEBUG("%s: open\n", ifp->if_xname);
 out:
@@ -478,8 +480,6 @@ static int
 cnic_output(struct ifnet *ifp, struct mbuf *m0, const struct sockaddr *dst,
     struct rtentry *rt)
 {
-	printf("cnic_output: %s\n", ifp->if_xname);
-	
 	struct cnic_softc *tp = ifp->if_softc;
 	int		s;
 	int		error;
@@ -487,7 +487,7 @@ cnic_output(struct ifnet *ifp, struct mbuf *m0, const struct sockaddr *dst,
 	int		mlen;
 	uint32_t	*af;
 #endif
-
+	
 	ALTQ_DECL(struct altq_pktattr pktattr;)
 
 	s = splnet();
@@ -506,6 +506,23 @@ cnic_output(struct ifnet *ifp, struct mbuf *m0, const struct sockaddr *dst,
 	 */
 	IFQ_CLASSIFY(&ifp->if_snd, m0, dst->sa_family, &pktattr);
 
+	//send to corresponding RK	
+	struct ip *ip_send = mtod(m0, struct ip *);
+	printf("VM%d, ip addr in cnic_output: %s\n", rump_vmid, inet_ntoa(ip_send->ip_dst));	
+	
+	printf("sizeof m_len: %d\n", m_length(m0));
+	if(m0->m_next == NULL) printf("no chain\n");	
+	
+	char test[0]; 
+	m_copydata(m0, 0, m_length(m0), test);
+	
+	mutex_exit(&tp->cnic_lock);
+	splx(s);
+	cos_pktq_enqueue(test, 1);
+
+	if(1) return 1;
+	
+	
 	bpf_mtap_af(ifp, dst->sa_family, m0);
 
 	switch(dst->sa_family) {
@@ -549,19 +566,18 @@ cnic_output(struct ifnet *ifp, struct mbuf *m0, const struct sockaddr *dst,
 		/* FALLTHROUGH */
 	case AF_UNSPEC:
 		
-		//IFQ_ENQUEUE(&ifp->if_snd, m0, &pktattr, error);
-		error = cos_pktq_enqueue(&m0, !rump_vmid);
-			
+		IFQ_ENQUEUE(&ifp->if_snd, m0, &pktattr, error);
+		
 		if (error) {
 			ifp->if_collisions++;
 			error = EAFNOSUPPORT;
 			m0 = NULL;
 			goto out;
 		}
+		
 		mlen = m0->m_pkthdr.len;
 		ifp->if_opackets++;
 		ifp->if_obytes += mlen;
-		//should probably return.
 		break;
 #endif
 	default:
@@ -721,8 +737,8 @@ out_nolock:
 int
 cnicread(dev_t dev, struct uio *uio, int ioflag)
 {
-	printf("cnic read %d:\n", rump_vmid);
-	
+	printf("cnic read\n");
+//	if(1) return 0;	
 	struct cnic_softc *tp;
 	struct ifnet	*ifp;
 	struct mbuf	*m, *m0;
@@ -803,7 +819,6 @@ cnicread(dev_t dev, struct uio *uio, int ioflag)
 	return (error);
 
 out:
-	printf("out\n");
 	mutex_exit(&tp->cnic_lock);
 out_nolock:
 	splx(s);
@@ -816,10 +831,8 @@ out_nolock:
 int
 cnicwrite(dev_t dev, struct uio *uio, int ioflag)
 {
-	if(1) {
-		printf("cnicwrite\n");
-//		return 0;
-	}
+	printf("cnicwrite\n");
+	//if(1) return 0;
 	
 	struct cnic_softc *tp;
 	struct ifnet	*ifp;
diff --git a/sys/net/if_ethersubr.c b/sys/net/if_ethersubr.c
index 1a3a8a5..a60eb8b 100644
--- a/sys/net/if_ethersubr.c
+++ b/sys/net/if_ethersubr.c
@@ -581,7 +581,13 @@ altq_etherclassify(struct ifaltq *ifq, struct mbuf *m,
 void
 ether_input(struct ifnet *ifp, struct mbuf *m)
 {
-	printf("ether_input\n");
+	printf("\n\n\nether_input\n");
+	extern int rump_vmid;
+	if(rump_vmid == 1){
+		printf("sending back to DOM0\n");
+		//cos_pktq_enqueue();
+	}
+
 	struct ethercom *ec = (struct ethercom *) ifp;
 	pktqueue_t *pktq = NULL;
 	struct ifqueue *inq = NULL;
@@ -594,6 +600,7 @@ ether_input(struct ifnet *ifp, struct mbuf *m)
 	struct llc *l;
 #endif
 
+
 	if ((ifp->if_flags & IFF_UP) == 0) {
 		m_freem(m);
 		return;
diff --git a/sys/net/pktqueue.c b/sys/net/pktqueue.c
index 64cd6b8..9200742 100644
--- a/sys/net/pktqueue.c
+++ b/sys/net/pktqueue.c
@@ -208,10 +208,12 @@ pktq_rps_hash(const struct mbuf *m __unused)
 bool
 cos_pktq_enqueue(void *buff, int to_vmid)
 {
-	printf("cos_pktq_enqueue\n");
 	KASSERT(kpreempt_disabled());
 	
-	if(!rump_shmem_write(buff, sizeof(buff), rump_vmid, to_vmid)){
+	//assume VMs can only send to/recv from DOM0
+	if(to_vmid != 0) assert(rump_vmid == 0);
+
+	if(!rump_shmem_write(buff, 84, rump_vmid, to_vmid)){
 		return false;
 	}
 	
@@ -221,7 +223,6 @@ cos_pktq_enqueue(void *buff, int to_vmid)
 bool
 pktq_enqueue(pktqueue_t *pq, struct mbuf *m, const u_int hash __unused)
 {
-	printf("pktq_enqueue\n");
 #if defined(_RUMPKERNEL) || defined(_RUMP_NATIVE_ABI)
 	const unsigned cpuid = curcpu()->ci_index;
 #else
@@ -245,26 +246,26 @@ pktq_enqueue(pktqueue_t *pq, struct mbuf *m, const u_int hash __unused)
  * => Must ensure there are not concurrent dequeue calls.
  */
 
-struct mbuf *
-cos_pktq_dequeue(pktqueue_t *pq)
+void *
+cos_pktq_dequeue()
 {
-	printf("cos_pktq_enqueue\n");
-	struct mbuf *m;
-	
-	if(!rump_shmem_read(&m, !rump_vmid, rump_vmid)){
-		printf("read failed\n");
+	printf("cos_pktq_dequeue\n");
+	void * m;
+
+	if(!rump_shmem_read(&m, 0, 1)){
+		printf("cos_pktq_dequeue failed\n");
 		return NULL;
 	}
-	if (__predict_true(m != NULL)) {
-		pktq_inc_count(pq, PQCNT_DEQUEUE);
-	}
+		
+	assert(m != NULL);	
+	//assert(!ip_reass_packet(&m, ip_recv);
+
 	return m;	
 }
 
 struct mbuf *
 pktq_dequeue(pktqueue_t *pq)
 {
-	printf("pktq_dequeue\n");
 	const struct cpu_info *ci = curcpu();
 	const unsigned cpuid = cpu_index(ci);
 	struct mbuf *m;
diff --git a/sys/net/pktqueue.h b/sys/net/pktqueue.h
index 23d5da7..12382d3 100644
--- a/sys/net/pktqueue.h
+++ b/sys/net/pktqueue.h
@@ -50,7 +50,7 @@ void		pktq_destroy(pktqueue_t *);
 bool		pktq_enqueue(pktqueue_t *, struct mbuf *, const u_int);
 bool		cos_pktq_enqueue(void * buff, int to_vmid);
 struct mbuf *	pktq_dequeue(pktqueue_t *);
-struct mbuf *	cos_pktq_dequeue(pktqueue_t *);
+void *	cos_pktq_dequeue(void);
 void		pktq_barrier(pktqueue_t *);
 void		pktq_flush(pktqueue_t *);
 int		pktq_set_maxlen(pktqueue_t *, size_t);
diff --git a/sys/netinet/ip_input.c b/sys/netinet/ip_input.c
index 15a620c..d2aff93 100644
--- a/sys/netinet/ip_input.c
+++ b/sys/netinet/ip_input.c
@@ -297,13 +297,13 @@ void
 ip_init(void)
 {
 	const struct protosw *pr;
-
+	
 	in_init();
 	sysctl_net_inet_ip_setup(NULL);
-
+	
 	pr = pffindproto(PF_INET, IPPROTO_RAW, SOCK_RAW);
 	KASSERT(pr != NULL);
-
+	
 	ip_pktq = pktq_create(IFQ_MAXLEN, ipintr, NULL);
 	KASSERT(ip_pktq != NULL);
 
@@ -338,22 +338,40 @@ ip_init(void)
 	ipstat_percpu = percpu_alloc(sizeof(uint64_t) * IP_NSTATS);
 }
 
+#include "ip_input.h"
+extern int rump_vmid;
+int
+vk_ipintr(void * unused){
+	printf("\nRK:%d, recieved packet.\n", rump_vmid);
+	struct mbuf *m;
+	//struct ip * ip_recv;
+
+	mutex_enter(softnet_lock);
+	if((m = (struct mbuf *)cos_pktq_dequeue()) != NULL) {
+		//printf("ip->recv: %s\n", inet_ntoa(ip_recv->ip_dst));
+		//MGET(m, M_NOWAIT, MT_DATA);
+		assert(m != NULL);
+		ip_input(m);
+	}
+	mutex_exit(softnet_lock);
+	return 1;
+}
+
 /*
  * IP software interrupt routine.
  */
-static void
+void
 ipintr(void *arg __unused)
 {
-	printf("ipintr\n");
 	struct mbuf *m;
 
 	KASSERT(cpu_softintr_p());
 
 	mutex_enter(softnet_lock);
 	while ((m = pktq_dequeue(ip_pktq)) != NULL) {
+		printf("ipintr: %d\n", m->m_type);
 		ip_input(m);
 	}
-	printf("ipintr exit\n");
 	mutex_exit(softnet_lock);
 }
 
@@ -373,13 +391,11 @@ ip_input(struct mbuf *m)
 	int srcrt = 0;
 	ifnet_t *ifp;
 
-	KASSERTMSG(cpu_softintr_p(), "ip_input: not in the software "
-	    "interrupt handler; synchronization assumptions violated");
-
+	//KASSERTMSG(cpu_softintr_p(), "ip_input: not in the software "
+	 //   "interrupt handler; synchronization assumptions violated");
 	MCLAIM(m, &ip_rx_mowner);
 	KASSERT((m->m_flags & M_PKTHDR) != 0);
 	ifp = m->m_pkthdr.rcvif;
-
 	/*
 	 * If no IP addresses have been set yet but the interfaces
 	 * are receiving, can't do anything with incoming packets yet.
@@ -389,7 +405,6 @@ ip_input(struct mbuf *m)
 		goto bad;
 	}
 	IP_STATINC(IP_STAT_TOTAL);
-
 	/*
 	 * If the IP header is not aligned, slurp it up into a new
 	 * mbuf with space for link headers, in the event we forward
@@ -410,8 +425,10 @@ ip_input(struct mbuf *m)
 		}
 	}
 	ip = mtod(m, struct ip *);
+	//printf("VM%d, ip addr in ip_input: %s\n", rump_vmid, inet_ntoa(ip->ip_dst));	
 	if (ip->ip_v != IPVERSION) {
 		IP_STATINC(IP_STAT_BADVERS);
+		printf("ip_input: %d\n", __LINE__);
 		goto bad;
 	}
 	hlen = ip->ip_hl << 2;
@@ -426,7 +443,6 @@ ip_input(struct mbuf *m)
 		}
 		ip = mtod(m, struct ip *);
 	}
-
 	/*
 	 * RFC1122: packets with a multicast source address are
 	 * not allowed.
@@ -597,6 +613,7 @@ ip_input(struct mbuf *m)
 	 * The behavior here is to treat addresses on !IFF_UP interface
 	 * or IN_IFF_NOTREADY addresses as not mine.
 	 */
+	//printf("ip addr perhaps in ip_input: %d\n", ia->ia_addr.sin_addr);
 	downmatch = 0;
 	LIST_FOREACH(ia, &IN_IFADDR_HASH(ip->ip_dst.s_addr), ia_hash) {
 		if (in_hosteq(ia->ia_addr.sin_addr, ip->ip_dst)) {
@@ -1271,11 +1288,11 @@ ip_forward(struct mbuf *m, int srcrt)
 			code = ICMP_REDIRECT_HOST;
 		}
 	}
-	printf("IP_OUTPUT\n");
+	//printf("ip addr: %s\n", inet_ntoa(ip->ip_dst));
+	printf("output packet to wire/net stack\n");
 	error = ip_output(m, NULL, &ipforward_rt,
 	    (IP_FORWARDING | (ip_directedbcast ? IP_ALLOWBROADCAST : 0)),
 	    NULL, NULL);
-	printf("post cnicoutput\n");
 
 	if (error) {
 		IP_STATINC(IP_STAT_CANTFORWARD);
diff --git a/sys/netinet/ip_output.c b/sys/netinet/ip_output.c
index 36f9ad1..0c81162 100644
--- a/sys/netinet/ip_output.c
+++ b/sys/netinet/ip_output.c
@@ -222,7 +222,6 @@ ip_output(struct mbuf *m0, ...)
 	} else {
 		hlen = ip->ip_hl << 2;
 	}
-
 	/*
 	 * Route packet.
 	 */
@@ -230,6 +229,7 @@ ip_output(struct mbuf *m0, ...)
 		memset(&iproute, 0, sizeof(iproute));
 		ro = &iproute;
 	}
+
 	sockaddr_in_init(&u.dst4, &ip->ip_dst, 0);
 	dst = satocsin(rtcache_getdst(ro));
 
-- 
1.9.1


From e3c9630161eeb4be14f3c6e573821789308caa48 Mon Sep 17 00:00:00 2001
From: lab176 <lbaier176@gmail.com>
Date: Thu, 25 Aug 2016 10:43:30 -0400
Subject: [PATCH 6/7] Add inter-VK packet recv/send routine Add hack for
 ether_type bug, in ether_input() Add interrupts per VM in if_cnic.c

---
 sys/net/if_cnic.c      | 136 ++++++++++++++++++++++++++++++++++++++++---------
 sys/net/if_ethersubr.c |  28 +++++++---
 sys/net/pktqueue.c     |  25 +++++----
 sys/net/pktqueue.h     |   4 +-
 sys/netinet/ip_input.c |  46 +++++++----------
 5 files changed, 164 insertions(+), 75 deletions(-)

diff --git a/sys/net/if_cnic.c b/sys/net/if_cnic.c
index c40f23e..9050c54 100644
--- a/sys/net/if_cnic.c
+++ b/sys/net/if_cnic.c
@@ -22,11 +22,13 @@
 #include <sys/kauth.h>
 #include <sys/mutex.h>
 #include <sys/cpu.h>
+#include <rump/dev/lib/libpci/pci_user.h>
 
 #include <net/if.h>
 #include <net/if_types.h>
 #include <net/netisr.h>
 #include <net/route.h>
+#include <net/if_ether.h>
 
 #ifdef INET
 #include <netinet/in.h>
@@ -77,6 +79,13 @@ static dev_type_ioctl(cnicioctl);
 static dev_type_poll(cnicpoll);
 static dev_type_kqfilter(cnickqfilter);
 
+/* VKern functions  */
+int cnic_vk_intr_0(void * arg);
+int cnic_vk_intr_1(void * arg);
+int cnic_vk_intr_2(void * arg);
+int cnic_vk_dequeue(struct cnic_softc * ifp, int srcvm);
+
+
 const struct cdevsw cnic_cdevsw = {
 	.d_open = cnicopen,
 	.d_close = cnicclose,
@@ -155,7 +164,7 @@ cnic_clone_create(struct if_clone *ifc, int unit)
 
 	if ((tp = cnic_find_zunit(unit)) == NULL) {
 		/* Allocate a new instance */
-		tp = malloc(sizeof(*tp), M_DEVBUF, M_WAITOK|M_ZERO);
+		tp = malloc(sizeof(*tp), m_devbuf, M_WAITOK|M_ZERO);
 
 		tp->cnic_unit = unit;
 		mutex_init(&tp->cnic_lock, MUTEX_DEFAULT, IPL_NET);
@@ -189,6 +198,7 @@ cnicattach0(struct cnic_softc *tp)
 	ifp->if_mtu = CNICMTU;
 	ifp->if_ioctl = cnic_ioctl;
 	ifp->if_output = cnic_output;
+	ifp->if_input  = ether_input;
 #ifdef ALTQ
 	ifp->if_start = cnicstart;
 #endif
@@ -206,6 +216,11 @@ cnicattach0(struct cnic_softc *tp)
 	IFQ_SET_READY(&ifp->if_snd);
 	if_attach(ifp);
 	if_alloc_sadl(ifp);
+
+	//establish irq lines for rcving
+	rumpcomp_pci_irq_establish(12, cnic_vk_intr_0, tp);
+	rumpcomp_pci_irq_establish(13, cnic_vk_intr_1, tp);
+	//rumpcomp_pci_irq_establish(15, cnic_vk_intr_0, tp);
 	bpf_attach(ifp, DLT_NULL, sizeof(uint32_t));
 }
 
@@ -480,6 +495,7 @@ static int
 cnic_output(struct ifnet *ifp, struct mbuf *m0, const struct sockaddr *dst,
     struct rtentry *rt)
 {
+	//printf("VM%d- cnic_output\n", rump_vmid);
 	struct cnic_softc *tp = ifp->if_softc;
 	int		s;
 	int		error;
@@ -499,29 +515,12 @@ cnic_output(struct ifnet *ifp, struct mbuf *m0, const struct sockaddr *dst,
 		error = EHOSTDOWN;
 		goto out;
 	}
-
+	
 	/*
 	 * if the queueing discipline needs packet classification,
 	 * do it before prepending link headers.
 	 */
 	IFQ_CLASSIFY(&ifp->if_snd, m0, dst->sa_family, &pktattr);
-
-	//send to corresponding RK	
-	struct ip *ip_send = mtod(m0, struct ip *);
-	printf("VM%d, ip addr in cnic_output: %s\n", rump_vmid, inet_ntoa(ip_send->ip_dst));	
-	
-	printf("sizeof m_len: %d\n", m_length(m0));
-	if(m0->m_next == NULL) printf("no chain\n");	
-	
-	char test[0]; 
-	m_copydata(m0, 0, m_length(m0), test);
-	
-	mutex_exit(&tp->cnic_lock);
-	splx(s);
-	cos_pktq_enqueue(test, 1);
-
-	if(1) return 1;
-	
 	
 	bpf_mtap_af(ifp, dst->sa_family, m0);
 
@@ -563,10 +562,36 @@ cnic_output(struct ifnet *ifp, struct mbuf *m0, const struct sockaddr *dst,
 				goto out;
 			}
 		}
-		/* FALLTHROUGH */
+	/* FALLTHROUGH */
 	case AF_UNSPEC:
 		
-		IFQ_ENQUEUE(&ifp->if_snd, m0, &pktattr, error);
+		//IFQ_ENQUEUE(&ifp->if_snd, m0, &pktattr, error);
+		
+		if(!strcmp(ifp->if_xname, "cnic1")){
+			CNICDEBUG("Sending packet from DOM0 to VM1\n");
+			error = 1;	
+			void * test = malloc(m0->m_len, m_devbuf, M_WAITOK);
+			m_copydata(m0, 0, m0->m_len, test);
+			cos_pktq_enqueue(test, m0->m_len, 1);	
+			m_free(m0);
+			goto out;
+		}else if(!strcmp(ifp->if_xname, "cnic2")){
+			CNICDEBUG("Sending packet from VM to VM2%d\n", rump_vmid);
+			error = 1;	
+			void * test = malloc(m0->m_len, m_devbuf, M_WAITOK);
+			m_copydata(m0, 0, m0->m_len, test);
+			cos_pktq_enqueue(test, m0->m_len, 2);	
+			m_free(m0);
+			goto out;
+		}else{
+			CNICDEBUG("Sending packet from VM%d to DOM0\n", rump_vmid);
+			error = 1;	
+			void * test = malloc(m0->m_len, m_devbuf, M_WAITOK);
+			m_copydata(m0, 0, m0->m_len, test);
+			cos_pktq_enqueue(test, m0->m_len, 0);	
+			m_free(m0);
+			goto out;
+		}
 		
 		if (error) {
 			ifp->if_collisions++;
@@ -589,8 +614,9 @@ cnic_output(struct ifnet *ifp, struct mbuf *m0, const struct sockaddr *dst,
 		tp->cnic_flags &= ~CNIC_RWAIT;
 		wakeup((void *)tp);
 	}
-	if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
+	if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid){
 		softint_schedule(tp->cnic_isih);
+	}
 
 	selnotify(&tp->cnic_rsel, 0, 0);
 out:
@@ -606,6 +632,7 @@ out:
 static void
 cnic_i_softintr(void *cookie)
 {
+	printf("cnic_i_softintr\n");
 	struct cnic_softc *tp = cookie;
 
 	if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
@@ -616,6 +643,7 @@ cnic_i_softintr(void *cookie)
 static void
 cnic_o_softintr(void *cookie)
 {
+	printf("cnic_o_softintr\n");
 	struct cnic_softc *tp = cookie;
 
 	if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
@@ -738,7 +766,7 @@ int
 cnicread(dev_t dev, struct uio *uio, int ioflag)
 {
 	printf("cnic read\n");
-//	if(1) return 0;	
+	if(1) return 0;	
 	struct cnic_softc *tp;
 	struct ifnet	*ifp;
 	struct mbuf	*m, *m0;
@@ -832,7 +860,7 @@ int
 cnicwrite(dev_t dev, struct uio *uio, int ioflag)
 {
 	printf("cnicwrite\n");
-	//if(1) return 0;
+	if(1) return 0;
 	
 	struct cnic_softc *tp;
 	struct ifnet	*ifp;
@@ -1124,3 +1152,63 @@ out_nolock:
 	splx(s);
 	return (rv);
 }
+
+
+
+//For rcving from DOM0
+extern unsigned int rump_dom0_rcv;
+int 
+cnic_vk_intr_0(void * arg)
+{
+	struct cnic_softc* tp = arg;
+	cnic_vk_dequeue(tp, 0);	
+	return 1;
+}
+
+//For rcving from VM1
+int 
+cnic_vk_intr_1(void * arg)
+{
+	printf("VM0- cnic_vk_intr_1\n");
+	struct cnic_softc* tp = arg;
+//	mutex_enter(&tp->cnic_lock);
+	cnic_vk_dequeue(tp, 1);
+//	mutex_exit(&tp->cnic_lock);
+	return 1;
+}
+
+
+//For rcving from VM2
+int 
+cnic_vk_intr_2(void * arg)
+{
+	struct cnic_softc* tp = arg;
+	cnic_vk_dequeue(tp, 2);	
+	return 1;
+}
+
+int
+cnic_vk_dequeue(struct cnic_softc* tp, int srcvm)
+{
+	struct ifnet * ifp = &tp->cnic_if;
+
+	//alloc+dequeue mbuf
+	struct mbuf *m;
+	MGETHDR(m, M_NOWAIT, MT_DATA);
+	MCLGET(m, M_DONTWAIT);
+	m_copyback(m, 0, 84, cos_pktq_dequeue(srcvm));
+	assert(m != NULL);
+
+	//set mbuf ifnet to passed in arg from intr.
+	m->m_pkthdr.rcvif = ifp;
+	m->m_len = m->m_pkthdr.len = 84;
+	ifp->if_ipackets++;
+	bpf_mtap(ifp, m);
+	ifp->if_flags |= IFF_RUNNING;
+	ifp->if_flags |= IFF_UP;
+	
+	//this is ether_input.
+	(*ifp->if_input)(ifp, m);
+	return 1;
+}
+
diff --git a/sys/net/if_ethersubr.c b/sys/net/if_ethersubr.c
index a60eb8b..9da0efe 100644
--- a/sys/net/if_ethersubr.c
+++ b/sys/net/if_ethersubr.c
@@ -573,6 +573,8 @@ altq_etherclassify(struct ifaltq *ifq, struct mbuf *m,
 }
 #endif /* ALTQ */
 
+extern unsigned int rump_dom0_rcv;
+extern int rump_vmid;
 /*
  * Process a received Ethernet packet;
  * the packet is in the mbuf chain m with
@@ -581,13 +583,7 @@ altq_etherclassify(struct ifaltq *ifq, struct mbuf *m,
 void
 ether_input(struct ifnet *ifp, struct mbuf *m)
 {
-	printf("\n\n\nether_input\n");
-	extern int rump_vmid;
-	if(rump_vmid == 1){
-		printf("sending back to DOM0\n");
-		//cos_pktq_enqueue();
-	}
-
+	printf("VM%d- ether_input\n", rump_vmid);
 	struct ethercom *ec = (struct ethercom *) ifp;
 	pktqueue_t *pktq = NULL;
 	struct ifqueue *inq = NULL;
@@ -600,6 +596,21 @@ ether_input(struct ifnet *ifp, struct mbuf *m)
 	struct llc *l;
 #endif
 
+	//HACK HACK HACK HACK.
+	//ether_type gets modified, so just don't check it, and 
+	//decide it's an IP packet. 
+	if(rump_vmid != 0 || rump_dom0_rcv == 1){
+		pktq = ip_pktq;
+		if (__predict_true(pktq)) {
+			const uint32_t h = pktq_rps_hash(m);
+			printf("VM%d- ether_input, queing for ipintr\n", rump_vmid);
+			if (__predict_false(!pktq_enqueue(pktq, m, h))) {
+				m_freem(m);
+			}
+			rump_dom0_rcv = 0;
+			return;
+		}
+	}
 
 	if ((ifp->if_flags & IFF_UP) == 0) {
 		m_freem(m);
@@ -612,7 +623,7 @@ ether_input(struct ifnet *ifp, struct mbuf *m)
 	eh = mtod(m, struct ether_header *);
 	etype = ntohs(eh->ether_type);
 	ehlen = sizeof(*eh);
-
+	
 	if(__predict_false(earlypkts < 100 || !rnd_initial_entropy)) {
 		rnd_add_data(NULL, eh, ehlen, 0);
 		earlypkts++;
@@ -828,6 +839,7 @@ ether_input(struct ifnet *ifp, struct mbuf *m)
 		m->m_flags &= ~M_HASFCS;
 	}
 
+	
 	if (etype > ETHERMTU + sizeof (struct ether_header)) {
 		/* Strip off the Ethernet header. */
 		m_adj(m, ehlen);
diff --git a/sys/net/pktqueue.c b/sys/net/pktqueue.c
index 9200742..6039748 100644
--- a/sys/net/pktqueue.c
+++ b/sys/net/pktqueue.c
@@ -107,6 +107,7 @@ pktq_create(size_t maxlen, void (*intrh)(void *), void *sc)
 	if ((pc = percpu_alloc(sizeof(pktq_counters_t))) == NULL) {
 		return NULL;
 	}
+	
 	if ((sih = softint_establish(sflags, intrh, sc)) == NULL) {
 		percpu_free(pc, sizeof(pktq_counters_t));
 		return NULL;
@@ -206,14 +207,16 @@ pktq_rps_hash(const struct mbuf *m __unused)
  */
 
 bool
-cos_pktq_enqueue(void *buff, int to_vmid)
+cos_pktq_enqueue(void *buff, int size, int to_vmid)
 {
+	//printf("cos_pktq_enqueue\n");
 	KASSERT(kpreempt_disabled());
-	
+
 	//assume VMs can only send to/recv from DOM0
 	if(to_vmid != 0) assert(rump_vmid == 0);
 
-	if(!rump_shmem_write(buff, 84, rump_vmid, to_vmid)){
+
+	if(!rump_shmem_write(buff, size, rump_vmid, to_vmid)){
 		return false;
 	}
 	
@@ -247,20 +250,16 @@ pktq_enqueue(pktqueue_t *pq, struct mbuf *m, const u_int hash __unused)
  */
 
 void *
-cos_pktq_dequeue()
+cos_pktq_dequeue(int srcvm)
 {
-	printf("cos_pktq_dequeue\n");
-	void * m;
-
-	if(!rump_shmem_read(&m, 0, 1)){
+	void *test = malloc(84, 0, M_NOWAIT);
+	
+	if(rump_shmem_read(test, srcvm, rump_vmid) == NULL){
 		printf("cos_pktq_dequeue failed\n");
 		return NULL;
 	}
-		
-	assert(m != NULL);	
-	//assert(!ip_reass_packet(&m, ip_recv);
-
-	return m;	
+	
+	return test;	
 }
 
 struct mbuf *
diff --git a/sys/net/pktqueue.h b/sys/net/pktqueue.h
index 12382d3..c916014 100644
--- a/sys/net/pktqueue.h
+++ b/sys/net/pktqueue.h
@@ -48,9 +48,9 @@ pktqueue_t *	pktq_create(size_t, void (*)(void *), void *);
 void		pktq_destroy(pktqueue_t *);
 
 bool		pktq_enqueue(pktqueue_t *, struct mbuf *, const u_int);
-bool		cos_pktq_enqueue(void * buff, int to_vmid);
+bool		cos_pktq_enqueue(void * buff, int size, int to_vmid);
 struct mbuf *	pktq_dequeue(pktqueue_t *);
-void *	cos_pktq_dequeue(void);
+void *		cos_pktq_dequeue(int srcvm);
 void		pktq_barrier(pktqueue_t *);
 void		pktq_flush(pktqueue_t *);
 int		pktq_set_maxlen(pktqueue_t *, size_t);
diff --git a/sys/netinet/ip_input.c b/sys/netinet/ip_input.c
index d2aff93..6f9d60e 100644
--- a/sys/netinet/ip_input.c
+++ b/sys/netinet/ip_input.c
@@ -338,24 +338,7 @@ ip_init(void)
 	ipstat_percpu = percpu_alloc(sizeof(uint64_t) * IP_NSTATS);
 }
 
-#include "ip_input.h"
 extern int rump_vmid;
-int
-vk_ipintr(void * unused){
-	printf("\nRK:%d, recieved packet.\n", rump_vmid);
-	struct mbuf *m;
-	//struct ip * ip_recv;
-
-	mutex_enter(softnet_lock);
-	if((m = (struct mbuf *)cos_pktq_dequeue()) != NULL) {
-		//printf("ip->recv: %s\n", inet_ntoa(ip_recv->ip_dst));
-		//MGET(m, M_NOWAIT, MT_DATA);
-		assert(m != NULL);
-		ip_input(m);
-	}
-	mutex_exit(softnet_lock);
-	return 1;
-}
 
 /*
  * IP software interrupt routine.
@@ -364,12 +347,10 @@ void
 ipintr(void *arg __unused)
 {
 	struct mbuf *m;
-
 	KASSERT(cpu_softintr_p());
 
 	mutex_enter(softnet_lock);
 	while ((m = pktq_dequeue(ip_pktq)) != NULL) {
-		printf("ipintr: %d\n", m->m_type);
 		ip_input(m);
 	}
 	mutex_exit(softnet_lock);
@@ -382,6 +363,7 @@ ipintr(void *arg __unused)
 static void
 ip_input(struct mbuf *m)
 {
+	printf("VM%d- ip_input\n", rump_vmid);	
 	struct ip *ip = NULL;
 	struct in_ifaddr *ia;
 	struct ifaddr *ifa;
@@ -391,11 +373,12 @@ ip_input(struct mbuf *m)
 	int srcrt = 0;
 	ifnet_t *ifp;
 
-	//KASSERTMSG(cpu_softintr_p(), "ip_input: not in the software "
-	 //   "interrupt handler; synchronization assumptions violated");
+	KASSERTMSG(cpu_softintr_p(), "ip_input: not in the software "
+	    "interrupt handler; synchronization assumptions violated");
 	MCLAIM(m, &ip_rx_mowner);
 	KASSERT((m->m_flags & M_PKTHDR) != 0);
 	ifp = m->m_pkthdr.rcvif;
+	
 	/*
 	 * If no IP addresses have been set yet but the interfaces
 	 * are receiving, can't do anything with incoming packets yet.
@@ -404,6 +387,7 @@ ip_input(struct mbuf *m)
 	if (!TAILQ_FIRST(&in_ifaddrhead)) {
 		goto bad;
 	}
+	
 	IP_STATINC(IP_STAT_TOTAL);
 	/*
 	 * If the IP header is not aligned, slurp it up into a new
@@ -424,13 +408,15 @@ ip_input(struct mbuf *m)
 			return;
 		}
 	}
+	
 	ip = mtod(m, struct ip *);
-	//printf("VM%d, ip addr in ip_input: %s\n", rump_vmid, inet_ntoa(ip->ip_dst));	
+	
+	//printf("VM%d- ip_dst addr: %s\n",rump_vmid, inet_ntoa(ip->ip_dst));	
 	if (ip->ip_v != IPVERSION) {
 		IP_STATINC(IP_STAT_BADVERS);
-		printf("ip_input: %d\n", __LINE__);
 		goto bad;
 	}
+	
 	hlen = ip->ip_hl << 2;
 	if (hlen < sizeof(struct ip)) {	/* minimum header length */
 		IP_STATINC(IP_STAT_BADHLEN);
@@ -460,7 +446,7 @@ ip_input(struct mbuf *m)
 			goto bad;
 		}
 	}
-
+	
 	switch (m->m_pkthdr.csum_flags &
 		((ifp->if_csum_flags_rx & M_CSUM_IPv4) |
 		 M_CSUM_IPv4_BAD)) {
@@ -489,7 +475,7 @@ ip_input(struct mbuf *m)
 
 	/* Retrieve the packet length. */
 	len = ntohs(ip->ip_len);
-
+	
 	/*
 	 * Check for additional length bogosity
 	 */
@@ -613,7 +599,6 @@ ip_input(struct mbuf *m)
 	 * The behavior here is to treat addresses on !IFF_UP interface
 	 * or IN_IFF_NOTREADY addresses as not mine.
 	 */
-	//printf("ip addr perhaps in ip_input: %d\n", ia->ia_addr.sin_addr);
 	downmatch = 0;
 	LIST_FOREACH(ia, &IN_IFADDR_HASH(ip->ip_dst.s_addr), ia_hash) {
 		if (in_hosteq(ia->ia_addr.sin_addr, ip->ip_dst)) {
@@ -627,8 +612,10 @@ ip_input(struct mbuf *m)
 				downmatch++;
 		}
 	}
+	
 	if (ia != NULL)
 		goto ours;
+	
 	if (ifp->if_flags & IFF_BROADCAST) {
 		IFADDR_FOREACH(ifa, ifp) {
 			if (ifa->ifa_addr->sa_family != AF_INET)
@@ -796,10 +783,12 @@ ours:
 	SOFTNET_UNLOCK();
 	return;
 bad:
+	printf("VM%d- ip_input bad packet\n", rump_vmid);
 	m_freem(m);
 	return;
 
 badcsum:
+	printf("bad checksum\n");	
 	IP_STATINC(IP_STAT_BADSUM);
 	m_freem(m);
 }
@@ -1054,6 +1043,7 @@ ip_dooptions(struct mbuf *m)
 			code = ICMP_UNREACH_SRCFAIL;
 			goto bad;
 		}
+		printf("ip_input calling ip_forward %d\n", __LINE__);
 		ip_forward(m, 1);
 		return true;
 	}
@@ -1288,8 +1278,8 @@ ip_forward(struct mbuf *m, int srcrt)
 			code = ICMP_REDIRECT_HOST;
 		}
 	}
-	//printf("ip addr: %s\n", inet_ntoa(ip->ip_dst));
-	printf("output packet to wire/net stack\n");
+
+	if(rump_vmid == 1) printf("VM%d- ip_forward\n", rump_vmid);	
 	error = ip_output(m, NULL, &ipforward_rt,
 	    (IP_FORWARDING | (ip_directedbcast ? IP_ALLOWBROADCAST : 0)),
 	    NULL, NULL);
-- 
1.9.1


From 0b90cefef57e903b96db18ee9f4acceb1379e50e Mon Sep 17 00:00:00 2001
From: lab176 <lbaier176@gmail.com>
Date: Tue, 30 Aug 2016 09:52:15 -0400
Subject: [PATCH 7/7] Cleaned up working tree for patch file

---
 add_tun.patch                      |   94 ---
 cnic.patch                         | 1252 ------------------------------------
 sys/dev/pci/if_lmc.c               |    1 +
 sys/dev/pci/if_vioif.c             |   13 +-
 sys/dev/pci/if_wm.c                |    9 +-
 sys/dev/pci/virtio.c               |   26 +-
 sys/kern/kern_softint.c            |    2 +-
 sys/net/.if_cnic.c.swo             |  Bin 40960 -> 0 bytes
 sys/net/.if_cnic.c.swp             |  Bin 16384 -> 0 bytes
 sys/net/.if_ethersubr.c.swp        |  Bin 53248 -> 0 bytes
 sys/net/if.c                       |    3 +-
 sys/net/if_bridge.c                |    4 +-
 sys/net/if_cnic.c~                 | 1124 ++++++++++++++++++++++++++++++++
 sys/net/pktqueue.c                 |    1 -
 sys/netinet/.ip_input.c.swp        |  Bin 20480 -> 0 bytes
 sys/netinet/Makefile               |    2 +-
 sys/netinet/ip_icmp.c              |   12 +-
 sys/netinet/ip_output.c            |   14 +-
 sys/netinet/ip_reass.c             |    1 +
 sys/netinet/raw_ip.c               |    2 +
 sys/rump/dev/lib/libpci/pci_user.h |    2 +-
 21 files changed, 1184 insertions(+), 1378 deletions(-)
 delete mode 100644 add_tun.patch
 delete mode 100644 cnic.patch
 delete mode 100644 sys/net/.if_cnic.c.swo
 delete mode 100644 sys/net/.if_cnic.c.swp
 delete mode 100644 sys/net/.if_ethersubr.c.swp
 create mode 100644 sys/net/if_cnic.c~
 delete mode 100644 sys/netinet/.ip_input.c.swp

diff --git a/add_tun.patch b/add_tun.patch
deleted file mode 100644
index 1af771a..0000000
--- a/add_tun.patch
+++ /dev/null
@@ -1,94 +0,0 @@
-From f8765d4be9065f7cd3a0760a116b315d2b4ebad9 Mon Sep 17 00:00:00 2001
-From: Robert Gifford <robertgif@gmail.com>
-Date: Fri, 10 Jun 2016 16:45:59 -0400
-Subject: [PATCH] Added tun support
-
----
- sys/rump/net/lib/libtap/Makefile        |  2 ++
- sys/rump/net/lib/libtap/tap_component.c | 39 ++++++++++++++++++++++++++++-----
- 2 files changed, 36 insertions(+), 5 deletions(-)
-
-diff --git a/sys/rump/net/lib/libtap/Makefile b/sys/rump/net/lib/libtap/Makefile
-index c475477..ad91b05 100644
---- a/sys/rump/net/lib/libtap/Makefile
-+++ b/sys/rump/net/lib/libtap/Makefile
-@@ -6,6 +6,8 @@
- LIB=	rumpnet_tap
- 
- SRCS=	if_tap.c
-+#RG addition to support tun devices within tap component
-+SRCS+=  if_tun.c
- 
- SRCS+=	tap_component.c
- 
-diff --git a/sys/rump/net/lib/libtap/tap_component.c b/sys/rump/net/lib/libtap/tap_component.c
-index 6d9a1f5..6672fe6 100644
---- a/sys/rump/net/lib/libtap/tap_component.c
-+++ b/sys/rump/net/lib/libtap/tap_component.c
-@@ -36,29 +36,58 @@ __KERNEL_RCSID(0, "$NetBSD: tap_component.c,v 1.1 2015/05/29 12:32:23 pooka Exp
- #include "rump_net_private.h"
- #include "rump_vfs_private.h"
- 
-+#include <rump/rumpuser.h>
-+
- CFDRIVER_DECL(tap, DV_IFNET, NULL);
- 
- void tapattach(int);
-+void tunattach(int);
- 
- RUMP_COMPONENT(RUMP_COMPONENT_NET_IF)
- {
-+
-+
- 	extern const struct cdevsw tap_cdevsw;
--	devmajor_t bmaj, cmaj;
-+	devmajor_t bmaj_tap, cmaj_tap;
- 	int error;
- 
- 	config_cfdriver_attach(&tap_cd);
- 	tapattach(0);
- 
--	bmaj = cmaj = NODEVMAJOR;
--	error = devsw_attach("tap", NULL, &bmaj, &tap_cdevsw, &cmaj);
-+	bmaj_tap = cmaj_tap = NODEVMAJOR;
-+	error = devsw_attach("tap", NULL, &bmaj_tap, &tap_cdevsw, &cmaj_tap);
- 	if (error != 0)
- 		panic("tap devsw attach failed: %d", error);
- 
--	error = rump_vfs_makeonedevnode(S_IFCHR, "/dev/tap", cmaj, 0xfffff);
-+	error = rump_vfs_makeonedevnode(S_IFCHR, "/dev/tap", cmaj_tap, 0xfffff);
- 	if (error != 0)
- 		panic("cannot create tap device node: %d", error);
- 
--	error = rump_vfs_makedevnodes(S_IFCHR, "/dev/tap", '0', cmaj, 0, 4);
-+	error = rump_vfs_makedevnodes(S_IFCHR, "/dev/tap", '0', cmaj_tap, 0, 4);
- 	if (error != 0)
- 		panic("cannot create tap[0-4] device node: %d", error);
-+
-+	/* ----- TUN ----- */
-+	/* RG: attepting to add tun to the tap component for rump */
-+	rumpuser_dprintf("----- Hello! Greetings from the tap source code! -----\n");
-+	rumpuser_dprintf("----- Attempting to make tun device node /dev/tun -----\n");
-+
-+	extern const struct cdevsw tun_cdevsw;
-+	devmajor_t bmaj_tun, cmaj_tun;
-+
-+	//config_cfdriver_attach(&tap_cd);
-+	tunattach(0);
-+
-+	bmaj_tun = cmaj_tun = NODEVMAJOR;
-+	error = devsw_attach("tun", NULL, &bmaj_tun, &tun_cdevsw, &cmaj_tun);
-+	if (error != 0)
-+		panic("tun devsw attach failed: %d", error);
-+
-+	error = rump_vfs_makeonedevnode(S_IFCHR, "/dev/tun", cmaj_tun, 0xfffff);
-+	if (error != 0)
-+		panic("cannot create tun device node: %d", error);
-+
-+	error = rump_vfs_makedevnodes(S_IFCHR, "/dev/tun", '0', cmaj_tun, 0, 4);
-+	if (error != 0)
-+		panic("cannot create tun[0-4] device node: %d", error);
- }
--- 
-2.5.0
-
diff --git a/cnic.patch b/cnic.patch
deleted file mode 100644
index 56aa728..0000000
--- a/cnic.patch
+++ /dev/null
@@ -1,1252 +0,0 @@
-From 7df87509a6db2c3aceda423ec74d6b25dee2b8a8 Mon Sep 17 00:00:00 2001
-From: Robert Gifford <robertgif@gmail.com>
-Date: Fri, 24 Jun 2016 16:38:04 -0400
-Subject: [PATCH] Added cnic device
-
----
- sys/net/if_cnic.c                       | 1098 +++++++++++++++++++++++++++++++
- sys/net/if_cnic.h                       |   44 ++
- sys/rump/net/lib/libtap/Makefile        |    2 +
- sys/rump/net/lib/libtap/tap_component.c |   39 +-
- 4 files changed, 1178 insertions(+), 5 deletions(-)
- create mode 100644 sys/net/if_cnic.c
- create mode 100644 sys/net/if_cnic.h
-
-diff --git a/sys/net/if_cnic.c b/sys/net/if_cnic.c
-new file mode 100644
-index 0000000..b3344d9
---- /dev/null
-+++ b/sys/net/if_cnic.c
-@@ -0,0 +1,1098 @@
-+/* All rights go the NetBSD, this is simply a copy of if_tun.c with tun namespace replaced with cnic */
-+
-+#include <sys/cdefs.h>
-+
-+#include "opt_inet.h"
-+
-+#include <sys/param.h>
-+#include <sys/proc.h>
-+#include <sys/systm.h>
-+#include <sys/mbuf.h>
-+#include <sys/buf.h>
-+#include <sys/protosw.h>
-+#include <sys/socket.h>
-+#include <sys/ioctl.h>
-+#include <sys/errno.h>
-+#include <sys/syslog.h>
-+#include <sys/select.h>
-+#include <sys/poll.h>
-+#include <sys/file.h>
-+#include <sys/signalvar.h>
-+#include <sys/conf.h>
-+#include <sys/kauth.h>
-+#include <sys/mutex.h>
-+#include <sys/cpu.h>
-+
-+#include <net/if.h>
-+#include <net/if_types.h>
-+#include <net/netisr.h>
-+#include <net/route.h>
-+
-+
-+#ifdef INET
-+#include <netinet/in.h>
-+#include <netinet/in_systm.h>
-+#include <netinet/in_var.h>
-+#include <netinet/ip.h>
-+#include <netinet/if_inarp.h>
-+#endif
-+
-+
-+#include <sys/time.h>
-+#include <net/bpf.h>
-+
-+#include <net/if_cnic.h>
-+
-+#define CNICDEBUG	if (cnicdebug) printf
-+int	cnicdebug = 0;
-+
-+extern int ifqmaxlen;
-+void	cnicattach(int);
-+
-+static LIST_HEAD(, cnic_softc) cnic_softc_list;
-+static LIST_HEAD(, cnic_softc) cnicz_softc_list;
-+static kmutex_t cnic_softc_lock;
-+
-+static int	cnic_ioctl(struct ifnet *, u_long, void *);
-+static int	cnic_output(struct ifnet *, struct mbuf *,
-+			const struct sockaddr *, struct rtentry *rt);
-+static int	cnic_clone_create(struct if_clone *, int);
-+static int	cnic_clone_destroy(struct ifnet *);
-+
-+static struct if_clone cnic_cloner =
-+    IF_CLONE_INITIALIZER("cnic", cnic_clone_create, cnic_clone_destroy);
-+
-+static void cnicattach0(struct cnic_softc *);
-+static void cnicinit(struct cnic_softc *);
-+static void cnic_i_softintr(void *);
-+static void cnic_o_softintr(void *);
-+#ifdef ALTQ
-+static void cnicstart(struct ifnet *);
-+#endif
-+static struct cnic_softc *cnic_find_unit(dev_t);
-+static struct cnic_softc *cnic_find_zunit(int);
-+
-+static dev_type_open(cnicopen);
-+static dev_type_close(cnicclose);
-+static dev_type_read(cnicread);
-+static dev_type_write(cnicwrite);
-+static dev_type_ioctl(cnicioctl);
-+static dev_type_poll(cnicpoll);
-+static dev_type_kqfilter(cnickqfilter);
-+
-+const struct cdevsw cnic_cdevsw = {
-+	.d_open = cnicopen,
-+	.d_close = cnicclose,
-+	.d_read = cnicread,
-+	.d_write = cnicwrite,
-+	.d_ioctl = cnicioctl,
-+	.d_stop = nostop,
-+	.d_tty = notty,
-+	.d_poll = cnicpoll,
-+	.d_mmap = nommap,
-+	.d_kqfilter = cnickqfilter,
-+	.d_discard = nodiscard,
-+	.d_flag = D_OTHER
-+};
-+
-+void
-+cnicattach(int unused)
-+{
-+
-+	mutex_init(&cnic_softc_lock, MUTEX_DEFAULT, IPL_NET);
-+	LIST_INIT(&cnic_softc_list);
-+	LIST_INIT(&cnicz_softc_list);
-+	if_clone_attach(&cnic_cloner);
-+}
-+
-+/*
-+ * Find driver instance from dev_t.
-+ * Returns with tp locked (if found).
-+ */
-+static struct cnic_softc *
-+cnic_find_unit(dev_t dev)
-+{
-+	struct cnic_softc *tp;
-+	int unit = minor(dev);
-+
-+	mutex_enter(&cnic_softc_lock);
-+	LIST_FOREACH(tp, &cnic_softc_list, cnic_list)
-+		if (unit == tp->cnic_unit)
-+			break;
-+	if (tp)
-+		mutex_enter(&tp->cnic_lock);
-+	mutex_exit(&cnic_softc_lock);
-+
-+	return (tp);
-+}
-+
-+/*
-+ * Find zombie driver instance by unit number.
-+ * Remove tp from list and return it unlocked (if found).
-+ */
-+static struct cnic_softc *
-+cnic_find_zunit(int unit)
-+{
-+	struct cnic_softc *tp;
-+
-+	mutex_enter(&cnic_softc_lock);
-+	LIST_FOREACH(tp, &cnicz_softc_list, cnic_list)
-+		if (unit == tp->cnic_unit)
-+			break;
-+	if (tp)
-+		LIST_REMOVE(tp, cnic_list);
-+	mutex_exit(&cnic_softc_lock);
-+#ifdef DIAGNOSTIC
-+	if (tp != NULL && (tp->cnic_flags & (CNIC_INITED|CNIC_OPEN)) != CNIC_OPEN)
-+		printf("cnic%d: inconsistent flags: %x\n", unit, tp->cnic_flags);
-+#endif
-+
-+	return (tp);
-+}
-+
-+static int
-+cnic_clone_create(struct if_clone *ifc, int unit)
-+{
-+	struct cnic_softc *tp;
-+
-+	if ((tp = cnic_find_zunit(unit)) == NULL) {
-+		/* Allocate a new instance */
-+		tp = malloc(sizeof(*tp), M_DEVBUF, M_WAITOK|M_ZERO);
-+
-+		tp->cnic_unit = unit;
-+		mutex_init(&tp->cnic_lock, MUTEX_DEFAULT, IPL_NET);
-+		selinit(&tp->cnic_rsel);
-+		selinit(&tp->cnic_wsel);
-+	} else {
-+		/* Revive cnicnel instance; clear ifp part */
-+		(void)memset(&tp->cnic_if, 0, sizeof(struct ifnet));
-+	}
-+
-+	if_initname(&tp->cnic_if, ifc->ifc_name, unit);
-+	cnicattach0(tp);
-+	tp->cnic_flags |= CNIC_INITED;
-+	tp->cnic_osih = softint_establish(SOFTINT_CLOCK, cnic_o_softintr, tp);
-+	tp->cnic_isih = softint_establish(SOFTINT_CLOCK, cnic_i_softintr, tp);
-+
-+	mutex_enter(&cnic_softc_lock);
-+	LIST_INSERT_HEAD(&cnic_softc_list, tp, cnic_list);
-+	mutex_exit(&cnic_softc_lock);
-+
-+	return (0);
-+}
-+
-+static void
-+cnicattach0(struct cnic_softc *tp)
-+{
-+	struct ifnet *ifp;
-+
-+	ifp = &tp->cnic_if;
-+	ifp->if_softc = tp;
-+	ifp->if_mtu = CNICMTU;
-+	ifp->if_ioctl = cnic_ioctl;
-+	ifp->if_output = cnic_output;
-+#ifdef ALTQ
-+	ifp->if_start = cnicstart;
-+#endif
-+	ifp->if_flags = IFF_POINTOPOINT;
-+	ifp->if_type = IFT_TUNNEL;
-+	ifp->if_snd.ifq_maxlen = ifqmaxlen;
-+	ifp->if_collisions = 0;
-+	ifp->if_ierrors = 0;
-+	ifp->if_oerrors = 0;
-+	ifp->if_ipackets = 0;
-+	ifp->if_opackets = 0;
-+	ifp->if_ibytes   = 0;
-+	ifp->if_obytes   = 0;
-+	ifp->if_dlt = DLT_NULL;
-+	IFQ_SET_READY(&ifp->if_snd);
-+	if_attach(ifp);
-+	if_alloc_sadl(ifp);
-+	bpf_attach(ifp, DLT_NULL, sizeof(uint32_t));
-+}
-+
-+static int
-+cnic_clone_destroy(struct ifnet *ifp)
-+{
-+	struct cnic_softc *tp = (void *)ifp;
-+	int zombie = 0;
-+
-+	IF_PURGE(&ifp->if_snd);
-+	ifp->if_flags &= ~IFF_RUNNING;
-+
-+	mutex_enter(&cnic_softc_lock);
-+	mutex_enter(&tp->cnic_lock);
-+	LIST_REMOVE(tp, cnic_list);
-+	if (tp->cnic_flags & CNIC_OPEN) {
-+		/* Hang on to storage until last close */
-+		zombie = 1;
-+		tp->cnic_flags &= ~CNIC_INITED;
-+		LIST_INSERT_HEAD(&cnicz_softc_list, tp, cnic_list);
-+	}
-+	mutex_exit(&cnic_softc_lock);
-+
-+	if (tp->cnic_flags & CNIC_RWAIT) {
-+		tp->cnic_flags &= ~CNIC_RWAIT;
-+		wakeup((void *)tp);
-+	}
-+	selnotify(&tp->cnic_rsel, 0, 0);
-+
-+	mutex_exit(&tp->cnic_lock);
-+
-+	if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
-+		fownsignal(tp->cnic_pgid, SIGIO, POLL_HUP, 0, NULL);
-+
-+	bpf_detach(ifp);
-+	if_detach(ifp);
-+
-+	if (!zombie) {
-+		seldestroy(&tp->cnic_rsel);
-+		seldestroy(&tp->cnic_wsel);
-+		softint_disestablish(tp->cnic_osih);
-+		softint_disestablish(tp->cnic_isih);
-+		mutex_destroy(&tp->cnic_lock);
-+		free(tp, M_DEVBUF);
-+	}
-+
-+	return (0);
-+}
-+
-+/*
-+ * cnicnel open - must be superuser & the device must be
-+ * configured in
-+ */
-+static int
-+cnicopen(dev_t dev, int flag, int mode, struct lwp *l)
-+{
-+	struct ifnet	*ifp;
-+	struct cnic_softc *tp;
-+	int	error;
-+
-+	error = kauth_authorize_network(l->l_cred, KAUTH_NETWORK_INTERFACE_TUN,
-+	    KAUTH_REQ_NETWORK_INTERFACE_TUN_ADD, NULL, NULL, NULL);
-+	if (error)
-+		return (error);
-+
-+	tp = cnic_find_unit(dev);
-+
-+	if (tp == NULL) {
-+		(void)cnic_clone_create(&cnic_cloner, minor(dev));
-+		tp = cnic_find_unit(dev);
-+		if (tp == NULL) {
-+			error = ENXIO;
-+			goto out_nolock;
-+		}
-+	}
-+
-+	if (tp->cnic_flags & CNIC_OPEN) {
-+		error = EBUSY;
-+		goto out;
-+	}
-+
-+	ifp = &tp->cnic_if;
-+	tp->cnic_flags |= CNIC_OPEN;
-+	CNICDEBUG("%s: open\n", ifp->if_xname);
-+out:
-+	mutex_exit(&tp->cnic_lock);
-+out_nolock:
-+	return (error);
-+}
-+
-+/*
-+ * cnicclose - close the device - mark i/f down & delete
-+ * routing info
-+ */
-+int
-+cnicclose(dev_t dev, int flag, int mode,
-+    struct lwp *l)
-+{
-+	struct cnic_softc *tp;
-+	struct ifnet	*ifp;
-+
-+	if ((tp = cnic_find_zunit(minor(dev))) != NULL) {
-+		/* interface was "destroyed" before the close */
-+		seldestroy(&tp->cnic_rsel);
-+		seldestroy(&tp->cnic_wsel);
-+		softint_disestablish(tp->cnic_osih);
-+		softint_disestablish(tp->cnic_isih);
-+		mutex_destroy(&tp->cnic_lock);
-+		free(tp, M_DEVBUF);
-+		goto out_nolock;
-+	}
-+
-+	if ((tp = cnic_find_unit(dev)) == NULL)
-+		goto out_nolock;
-+
-+	ifp = &tp->cnic_if;
-+
-+	tp->cnic_flags &= ~CNIC_OPEN;
-+
-+	tp->cnic_pgid = 0;
-+	selnotify(&tp->cnic_rsel, 0, 0);
-+
-+	CNICDEBUG ("%s: closed\n", ifp->if_xname);
-+	mutex_exit(&tp->cnic_lock);
-+
-+	/*
-+	 * junk all pending output
-+	 */
-+	IFQ_PURGE(&ifp->if_snd);
-+
-+	if (ifp->if_flags & IFF_UP) {
-+		if_down(ifp);
-+		if (ifp->if_flags & IFF_RUNNING) {
-+			/* find internet addresses and delete routes */
-+			struct ifaddr *ifa;
-+			IFADDR_FOREACH(ifa, ifp) {
-+#if defined(INET) || defined(INET6)
-+				if (ifa->ifa_addr->sa_family == AF_INET ||
-+				    ifa->ifa_addr->sa_family == AF_INET6) {
-+					rtinit(ifa, (int)RTM_DELETE,
-+					       tp->cnic_flags & CNIC_DSTADDR
-+							? RTF_HOST
-+							: 0);
-+				}
-+#endif
-+			}
-+		}
-+	}
-+out_nolock:
-+	return (0);
-+}
-+
-+/*
-+ * Call at splnet().
-+ */
-+static void
-+cnicinit(struct cnic_softc *tp)
-+{
-+	struct ifnet	*ifp = &tp->cnic_if;
-+	struct ifaddr	*ifa;
-+
-+	CNICDEBUG("%s: cnicinit\n", ifp->if_xname);
-+
-+	mutex_enter(&tp->cnic_lock);
-+	ifp->if_flags |= IFF_UP | IFF_RUNNING;
-+
-+	tp->cnic_flags &= ~(CNIC_IASET|CNIC_DSTADDR);
-+	IFADDR_FOREACH(ifa, ifp) {
-+#ifdef INET
-+		if (ifa->ifa_addr->sa_family == AF_INET) {
-+			struct sockaddr_in *sin;
-+
-+			sin = satosin(ifa->ifa_addr);
-+			if (sin && sin->sin_addr.s_addr)
-+				tp->cnic_flags |= CNIC_IASET;
-+
-+			if (ifp->if_flags & IFF_POINTOPOINT) {
-+				sin = satosin(ifa->ifa_dstaddr);
-+				if (sin && sin->sin_addr.s_addr)
-+					tp->cnic_flags |= CNIC_DSTADDR;
-+			}
-+		}
-+#endif
-+#ifdef INET6
-+		if (ifa->ifa_addr->sa_family == AF_INET6) {
-+			struct sockaddr_in6 *sin;
-+
-+			sin = (struct sockaddr_in6 *)ifa->ifa_addr;
-+			if (!IN6_IS_ADDR_UNSPECIFIED(&sin->sin6_addr))
-+				tp->cnic_flags |= CNIC_IASET;
-+
-+			if (ifp->if_flags & IFF_POINTOPOINT) {
-+				sin = (struct sockaddr_in6 *)ifa->ifa_dstaddr;
-+				if (sin &&
-+				    !IN6_IS_ADDR_UNSPECIFIED(&sin->sin6_addr))
-+					tp->cnic_flags |= CNIC_DSTADDR;
-+			} else
-+				tp->cnic_flags &= ~CNIC_DSTADDR;
-+		}
-+#endif /* INET6 */
-+	}
-+	mutex_exit(&tp->cnic_lock);
-+}
-+
-+/*
-+ * Process an ioctl request.
-+ */
-+static int
-+cnic_ioctl(struct ifnet *ifp, u_long cmd, void *data)
-+{
-+	int		error = 0, s;
-+	struct cnic_softc *tp = (struct cnic_softc *)(ifp->if_softc);
-+	struct ifreq *ifr = (struct ifreq *)data;
-+	struct ifaddr *ifa = (struct ifaddr *)data;
-+
-+	s = splnet();
-+
-+	switch (cmd) {
-+	case SIOCINITIFADDR:
-+		cnicinit(tp);
-+		ifa->ifa_rtrequest = p2p_rtrequest;
-+		CNICDEBUG("%s: address set\n", ifp->if_xname);
-+		break;
-+	case SIOCSIFBRDADDR:
-+		CNICDEBUG("%s: broadcast address set\n", ifp->if_xname);
-+		break;
-+	case SIOCSIFMTU:
-+		if (ifr->ifr_mtu > CNICMTU || ifr->ifr_mtu < 576) {
-+			error = EINVAL;
-+			break;
-+		}
-+		CNICDEBUG("%s: interface mtu set\n", ifp->if_xname);
-+		if ((error = ifioctl_common(ifp, cmd, data)) == ENETRESET)
-+			error = 0;
-+		break;
-+	case SIOCADDMULTI:
-+	case SIOCDELMULTI:
-+		if (ifr == NULL) {
-+	        	error = EAFNOSUPPORT;           /* XXX */
-+			break;
-+		}
-+		switch (ifreq_getaddr(cmd, ifr)->sa_family) {
-+#ifdef INET
-+		case AF_INET:
-+			break;
-+#endif
-+#ifdef INET6
-+		case AF_INET6:
-+			break;
-+#endif
-+		default:
-+			error = EAFNOSUPPORT;
-+			break;
-+		}
-+		break;
-+	default:
-+		error = ifioctl_common(ifp, cmd, data);
-+	}
-+
-+	splx(s);
-+	return (error);
-+}
-+
-+/*
-+ * cnic_output - queue packets from higher level ready to put out.
-+ */
-+static int
-+cnic_output(struct ifnet *ifp, struct mbuf *m0, const struct sockaddr *dst,
-+    struct rtentry *rt)
-+{
-+	struct cnic_softc *tp = ifp->if_softc;
-+	int		s;
-+	int		error;
-+#if defined(INET) || defined(INET6)
-+	int		mlen;
-+	uint32_t	*af;
-+#endif
-+	ALTQ_DECL(struct altq_pktattr pktattr;)
-+
-+	s = splnet();
-+	mutex_enter(&tp->cnic_lock);
-+	CNICDEBUG ("%s: cnic_output\n", ifp->if_xname);
-+
-+	if ((tp->cnic_flags & CNIC_READY) != CNIC_READY) {
-+		CNICDEBUG ("%s: not ready 0%o\n", ifp->if_xname,
-+			  tp->cnic_flags);
-+		error = EHOSTDOWN;
-+		goto out;
-+	}
-+
-+	/*
-+	 * if the queueing discipline needs packet classification,
-+	 * do it before prepending link headers.
-+	 */
-+	IFQ_CLASSIFY(&ifp->if_snd, m0, dst->sa_family, &pktattr);
-+
-+	bpf_mtap_af(ifp, dst->sa_family, m0);
-+
-+	switch(dst->sa_family) {
-+#ifdef INET6
-+	case AF_INET6:
-+#endif
-+#ifdef INET
-+	case AF_INET:
-+#endif
-+#if defined(INET) || defined(INET6)
-+		if (tp->cnic_flags & CNIC_PREPADDR) {
-+			/* Simple link-layer header */
-+			M_PREPEND(m0, dst->sa_len, M_DONTWAIT);
-+			if (m0 == NULL) {
-+				IF_DROP(&ifp->if_snd);
-+				error = ENOBUFS;
-+				goto out;
-+			}
-+			bcopy(dst, mtod(m0, char *), dst->sa_len);
-+		}
-+
-+		if (tp->cnic_flags & CNIC_IFHEAD) {
-+			/* Prepend the address family */
-+			M_PREPEND(m0, sizeof(*af), M_DONTWAIT);
-+			if (m0 == NULL) {
-+				IF_DROP(&ifp->if_snd);
-+				error = ENOBUFS;
-+				goto out;
-+			}
-+			af = mtod(m0,uint32_t *);
-+			*af = htonl(dst->sa_family);
-+		} else {
-+#ifdef INET
-+			if (dst->sa_family != AF_INET)
-+#endif
-+			{
-+				error = EAFNOSUPPORT;
-+				goto out;
-+			}
-+		}
-+		/* FALLTHROUGH */
-+	case AF_UNSPEC:
-+		IFQ_ENQUEUE(&ifp->if_snd, m0, &pktattr, error);
-+		if (error) {
-+			ifp->if_collisions++;
-+			error = EAFNOSUPPORT;
-+			m0 = NULL;
-+			goto out;
-+		}
-+		mlen = m0->m_pkthdr.len;
-+		ifp->if_opackets++;
-+		ifp->if_obytes += mlen;
-+		break;
-+#endif
-+	default:
-+		error = EAFNOSUPPORT;
-+		goto out;
-+	}
-+
-+	if (tp->cnic_flags & CNIC_RWAIT) {
-+		tp->cnic_flags &= ~CNIC_RWAIT;
-+		wakeup((void *)tp);
-+	}
-+	if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
-+		softint_schedule(tp->cnic_isih);
-+
-+	selnotify(&tp->cnic_rsel, 0, 0);
-+out:
-+	mutex_exit(&tp->cnic_lock);
-+	splx(s);
-+
-+	if (error && m0) {
-+		m_freem(m0);
-+	}
-+	return 0;
-+}
-+
-+static void
-+cnic_i_softintr(void *cookie)
-+{
-+	struct cnic_softc *tp = cookie;
-+
-+	if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
-+		fownsignal(tp->cnic_pgid, SIGIO, POLL_IN, POLLIN|POLLRDNORM,
-+		    NULL);
-+}
-+
-+static void
-+cnic_o_softintr(void *cookie)
-+{
-+	struct cnic_softc *tp = cookie;
-+
-+	if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
-+		fownsignal(tp->cnic_pgid, SIGIO, POLL_OUT, POLLOUT|POLLWRNORM,
-+		    NULL);
-+}
-+
-+/*
-+ * the cdevsw interface is now pretty minimal.
-+ */
-+int
-+cnicioctl(dev_t dev, u_long cmd, void *data, int flag, struct lwp *l)
-+{
-+	struct cnic_softc *tp;
-+	int s, error = 0;
-+
-+	s = splnet();
-+	tp = cnic_find_unit(dev);
-+
-+	/* interface was "destroyed" already */
-+	if (tp == NULL) {
-+		error = ENXIO;
-+		goto out_nolock;
-+	}
-+
-+	switch (cmd) {
-+	case CNICSDEBUG:
-+		cnicdebug = *(int *)data;
-+		break;
-+
-+	case CNICGDEBUG:
-+		*(int *)data = cnicdebug;
-+		break;
-+
-+	case CNICSIFMODE:
-+		switch (*(int *)data & (IFF_POINTOPOINT|IFF_BROADCAST)) {
-+		case IFF_POINTOPOINT:
-+		case IFF_BROADCAST:
-+			if (tp->cnic_if.if_flags & IFF_UP) {
-+				error = EBUSY;
-+				goto out;
-+			}
-+			tp->cnic_if.if_flags &=
-+				~(IFF_BROADCAST|IFF_POINTOPOINT|IFF_MULTICAST);
-+			tp->cnic_if.if_flags |= *(int *)data;
-+			break;
-+		default:
-+			error = EINVAL;
-+			goto out;
-+		}
-+		break;
-+
-+	case CNICSLMODE:
-+		if (*(int *)data) {
-+			tp->cnic_flags |= CNIC_PREPADDR;
-+			tp->cnic_flags &= ~CNIC_IFHEAD;
-+		} else
-+			tp->cnic_flags &= ~CNIC_PREPADDR;
-+		break;
-+
-+	case CNICSIFHEAD:
-+		if (*(int *)data) {
-+			tp->cnic_flags |= CNIC_IFHEAD;
-+			tp->cnic_flags &= ~CNIC_PREPADDR;
-+		} else
-+			tp->cnic_flags &= ~CNIC_IFHEAD;
-+		break;
-+
-+	case CNICGIFHEAD:
-+		*(int *)data = (tp->cnic_flags & CNIC_IFHEAD);
-+		break;
-+
-+	case FIONBIO:
-+		if (*(int *)data)
-+			tp->cnic_flags |= CNIC_NBIO;
-+		else
-+			tp->cnic_flags &= ~CNIC_NBIO;
-+		break;
-+
-+	case FIOASYNC:
-+		if (*(int *)data)
-+			tp->cnic_flags |= CNIC_ASYNC;
-+		else
-+			tp->cnic_flags &= ~CNIC_ASYNC;
-+		break;
-+
-+	case FIONREAD:
-+		if (tp->cnic_if.if_snd.ifq_head)
-+			*(int *)data = tp->cnic_if.if_snd.ifq_head->m_pkthdr.len;
-+		else
-+			*(int *)data = 0;
-+		break;
-+
-+	case TIOCSPGRP:
-+	case FIOSETOWN:
-+		error = fsetown(&tp->cnic_pgid, cmd, data);
-+		break;
-+
-+	case TIOCGPGRP:
-+	case FIOGETOWN:
-+		error = fgetown(tp->cnic_pgid, cmd, data);
-+		break;
-+
-+	default:
-+		error = ENOTTY;
-+	}
-+
-+out:
-+	mutex_exit(&tp->cnic_lock);
-+out_nolock:
-+	splx(s);
-+	return (error);
-+}
-+
-+/*
-+ * The cdevsw read interface - reads a packet at a time, or at
-+ * least as much of a packet as can be read.
-+ */
-+int
-+cnicread(dev_t dev, struct uio *uio, int ioflag)
-+{
-+	struct cnic_softc *tp;
-+	struct ifnet	*ifp;
-+	struct mbuf	*m, *m0;
-+	int		error = 0, len, s, index;
-+
-+	s = splnet();
-+	tp = cnic_find_unit(dev);
-+
-+	/* interface was "destroyed" already */
-+	if (tp == NULL) {
-+		error = ENXIO;
-+		goto out_nolock;
-+	}
-+
-+	index = tp->cnic_if.if_index;
-+	ifp = &tp->cnic_if;
-+
-+	CNICDEBUG ("%s: read\n", ifp->if_xname);
-+	if ((tp->cnic_flags & CNIC_READY) != CNIC_READY) {
-+		CNICDEBUG ("%s: not ready 0%o\n", ifp->if_xname, tp->cnic_flags);
-+		error = EHOSTDOWN;
-+		goto out;
-+	}
-+
-+	tp->cnic_flags &= ~CNIC_RWAIT;
-+
-+	do {
-+		IFQ_DEQUEUE(&ifp->if_snd, m0);
-+		if (m0 == 0) {
-+			if (tp->cnic_flags & CNIC_NBIO) {
-+				error = EWOULDBLOCK;
-+				goto out;
-+			}
-+			tp->cnic_flags |= CNIC_RWAIT;
-+			if (mtsleep((void *)tp, PZERO|PCATCH|PNORELOCK,
-+					"cnicread", 0, &tp->cnic_lock) != 0) {
-+				error = EINTR;
-+				goto out_nolock;
-+			} else {
-+				/*
-+				 * Maybe the interface was destroyed while
-+				 * we were sleeping, so let's ensure that
-+				 * we're looking at the same (valid) cnic
-+				 * interface before looping.
-+				 */
-+				tp = cnic_find_unit(dev);
-+				if (tp == NULL) {
-+					error = ENXIO;
-+					goto out_nolock;
-+				}
-+				if (tp->cnic_if.if_index != index) {
-+					error = ENXIO;
-+					goto out;
-+				}
-+			}
-+		}
-+	} while (m0 == 0);
-+
-+	mutex_exit(&tp->cnic_lock);
-+	splx(s);
-+
-+	/* Copy the mbuf chain */
-+	while (m0 && uio->uio_resid > 0 && error == 0) {
-+		len = min(uio->uio_resid, m0->m_len);
-+		if (len != 0)
-+			error = uiomove(mtod(m0, void *), len, uio);
-+		MFREE(m0, m);
-+		m0 = m;
-+	}
-+
-+	if (m0) {
-+		CNICDEBUG("Dropping mbuf\n");
-+		m_freem(m0);
-+	}
-+	if (error)
-+		ifp->if_ierrors++;
-+
-+	return (error);
-+
-+out:
-+	mutex_exit(&tp->cnic_lock);
-+out_nolock:
-+	splx(s);
-+	return (error);
-+}
-+
-+/*
-+ * the cdevsw write interface - an atomic write is a packet - or else!
-+ */
-+int
-+cnicwrite(dev_t dev, struct uio *uio, int ioflag)
-+{
-+	struct cnic_softc *tp;
-+	struct ifnet	*ifp;
-+	struct mbuf	*top, **mp, *m;
-+	pktqueue_t	*pktq;
-+	struct sockaddr	dst;
-+	int		error = 0, s, tlen, mlen;
-+	uint32_t	family;
-+
-+	s = splnet();
-+	tp = cnic_find_unit(dev);
-+
-+	/* interface was "destroyed" already */
-+	if (tp == NULL) {
-+		error = ENXIO;
-+		goto out_nolock;
-+	}
-+
-+	/* Unlock until we've got the data */
-+	mutex_exit(&tp->cnic_lock);
-+	splx(s);
-+
-+	ifp = &tp->cnic_if;
-+
-+	CNICDEBUG("%s: cnicwrite\n", ifp->if_xname);
-+
-+	if (tp->cnic_flags & CNIC_PREPADDR) {
-+		if (uio->uio_resid < sizeof(dst)) {
-+			error = EIO;
-+			goto out0;
-+		}
-+		error = uiomove((void *)&dst, sizeof(dst), uio);
-+		if (dst.sa_len > sizeof(dst)) {
-+			/* Duh.. */
-+			char discard;
-+			int n = dst.sa_len - sizeof(dst);
-+			while (n--)
-+				if ((error = uiomove(&discard, 1, uio)) != 0) {
-+					goto out0;
-+				}
-+		}
-+	} else if (tp->cnic_flags & CNIC_IFHEAD) {
-+		if (uio->uio_resid < sizeof(family)){
-+			error = EIO;
-+			goto out0;
-+		}
-+		error = uiomove((void *)&family, sizeof(family), uio);
-+		dst.sa_family = ntohl(family);
-+	} else {
-+#ifdef INET
-+		dst.sa_family = AF_INET;
-+#endif
-+	}
-+
-+	if (uio->uio_resid > CNICMTU) {
-+		CNICDEBUG("%s: len=%lu!\n", ifp->if_xname,
-+		    (unsigned long)uio->uio_resid);
-+		error = EIO;
-+		goto out0;
-+	}
-+
-+	switch (dst.sa_family) {
-+#ifdef INET
-+	case AF_INET:
-+		pktq = ip_pktq;
-+		break;
-+#endif
-+#ifdef INET6
-+	case AF_INET6:
-+		pktq = ip6_pktq;
-+		break;
-+#endif
-+	default:
-+		error = EAFNOSUPPORT;
-+		goto out0;
-+	}
-+
-+	tlen = uio->uio_resid;
-+
-+	/* get a header mbuf */
-+	MGETHDR(m, M_DONTWAIT, MT_DATA);
-+	if (m == NULL) {
-+		error = ENOBUFS;
-+		goto out0;
-+	}
-+	mlen = MHLEN;
-+
-+	top = NULL;
-+	mp = &top;
-+	while (error == 0 && uio->uio_resid > 0) {
-+		m->m_len = min(mlen, uio->uio_resid);
-+		error = uiomove(mtod(m, void *), m->m_len, uio);
-+		*mp = m;
-+		mp = &m->m_next;
-+		if (error == 0 && uio->uio_resid > 0) {
-+			MGET(m, M_DONTWAIT, MT_DATA);
-+			if (m == NULL) {
-+				error = ENOBUFS;
-+				break;
-+			}
-+			mlen = MLEN;
-+		}
-+	}
-+	if (error) {
-+		if (top != NULL)
-+			m_freem (top);
-+		ifp->if_ierrors++;
-+		goto out0;
-+	}
-+
-+	top->m_pkthdr.len = tlen;
-+	top->m_pkthdr.rcvif = ifp;
-+
-+	bpf_mtap_af(ifp, dst.sa_family, top);
-+
-+	s = splnet();
-+	mutex_enter(&tp->cnic_lock);
-+	if ((tp->cnic_flags & CNIC_INITED) == 0) {
-+		/* Interface was destroyed */
-+		error = ENXIO;
-+		goto out;
-+	}
-+	if (__predict_false(!pktq_enqueue(pktq, top, 0))) {
-+		ifp->if_collisions++;
-+		mutex_exit(&tp->cnic_lock);
-+		error = ENOBUFS;
-+		m_freem(top);
-+		goto out_nolock;
-+	}
-+	ifp->if_ipackets++;
-+	ifp->if_ibytes += tlen;
-+out:
-+	mutex_exit(&tp->cnic_lock);
-+out_nolock:
-+	splx(s);
-+out0:
-+	return (error);
-+}
-+
-+#ifdef ALTQ
-+/*
-+ * Start packet transmission on the interface.
-+ * when the interface queue is rate-limited by ALTQ or TBR,
-+ * if_start is needed to drain packets from the queue in order
-+ * to notify readers when outgoing packets become ready.
-+ *
-+ * Should be called at splnet.
-+ */
-+static void
-+cnicstart(struct ifnet *ifp)
-+{
-+	struct cnic_softc *tp = ifp->if_softc;
-+
-+	if (!ALTQ_IS_ENABLED(&ifp->if_snd) && !TBR_IS_ENABLED(&ifp->if_snd))
-+		return;
-+
-+	mutex_enter(&tp->cnic_lock);
-+	if (!IF_IS_EMPTY(&ifp->if_snd)) {
-+		if (tp->cnic_flags & CNIC_RWAIT) {
-+			tp->cnic_flags &= ~CNIC_RWAIT;
-+			wakeup((void *)tp);
-+		}
-+		if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
-+			softint_schedule(tp->cnic_osih);
-+
-+		selnotify(&tp->cnic_rsel, 0, 0);
-+	}
-+	mutex_exit(&tp->cnic_lock);
-+}
-+#endif /* ALTQ */
-+/*
-+ * cnicpoll - the poll interface, this is only useful on reads
-+ * really. The write detect always returns true, write never blocks
-+ * anyway, it either accepts the packet or drops it.
-+ */
-+int
-+cnicpoll(dev_t dev, int events, struct lwp *l)
-+{
-+	struct cnic_softc *tp;
-+	struct ifnet	*ifp;
-+	int		s, revents = 0;
-+
-+	s = splnet();
-+	tp = cnic_find_unit(dev);
-+
-+	/* interface was "destroyed" already */
-+	if (tp == NULL)
-+		goto out_nolock;
-+
-+	ifp = &tp->cnic_if;
-+
-+	CNICDEBUG("%s: cnicpoll\n", ifp->if_xname);
-+
-+	if (events & (POLLIN | POLLRDNORM)) {
-+		if (!IFQ_IS_EMPTY(&ifp->if_snd)) {
-+			CNICDEBUG("%s: cnicpoll q=%d\n", ifp->if_xname,
-+			    ifp->if_snd.ifq_len);
-+			revents |= events & (POLLIN | POLLRDNORM);
-+		} else {
-+			CNICDEBUG("%s: cnicpoll waiting\n", ifp->if_xname);
-+			selrecord(l, &tp->cnic_rsel);
-+		}
-+	}
-+
-+	if (events & (POLLOUT | POLLWRNORM))
-+		revents |= events & (POLLOUT | POLLWRNORM);
-+
-+	mutex_exit(&tp->cnic_lock);
-+out_nolock:
-+	splx(s);
-+	return (revents);
-+}
-+
-+static void
-+filt_cnicrdetach(struct knote *kn)
-+{
-+	struct cnic_softc *tp = kn->kn_hook;
-+	int s;
-+
-+	s = splnet();
-+	SLIST_REMOVE(&tp->cnic_rsel.sel_klist, kn, knote, kn_selnext);
-+	splx(s);
-+}
-+
-+static int
-+filt_cnicread(struct knote *kn, long hint)
-+{
-+	struct cnic_softc *tp = kn->kn_hook;
-+	struct ifnet *ifp = &tp->cnic_if;
-+	struct mbuf *m;
-+	int s;
-+
-+	s = splnet();
-+	IF_POLL(&ifp->if_snd, m);
-+	if (m == NULL) {
-+		splx(s);
-+		return (0);
-+	}
-+
-+	for (kn->kn_data = 0; m != NULL; m = m->m_next)
-+		kn->kn_data += m->m_len;
-+
-+	splx(s);
-+	return (1);
-+}
-+
-+static const struct filterops cnicread_filtops =
-+	{ 1, NULL, filt_cnicrdetach, filt_cnicread };
-+
-+static const struct filterops cnic_seltrue_filtops =
-+	{ 1, NULL, filt_cnicrdetach, filt_seltrue };
-+
-+int
-+cnickqfilter(dev_t dev, struct knote *kn)
-+{
-+	struct cnic_softc *tp;
-+	struct klist *klist;
-+	int rv = 0, s;
-+
-+	s = splnet();
-+	tp = cnic_find_unit(dev);
-+	if (tp == NULL)
-+		goto out_nolock;
-+
-+	switch (kn->kn_filter) {
-+	case EVFILT_READ:
-+		klist = &tp->cnic_rsel.sel_klist;
-+		kn->kn_fop = &cnicread_filtops;
-+		break;
-+
-+	case EVFILT_WRITE:
-+		klist = &tp->cnic_rsel.sel_klist;
-+		kn->kn_fop = &cnic_seltrue_filtops;
-+		break;
-+
-+	default:
-+		rv = EINVAL;
-+		goto out;
-+	}
-+
-+	kn->kn_hook = tp;
-+
-+	SLIST_INSERT_HEAD(klist, kn, kn_selnext);
-+
-+out:
-+	mutex_exit(&tp->cnic_lock);
-+out_nolock:
-+	splx(s);
-+	return (rv);
-+}
-diff --git a/sys/net/if_cnic.h b/sys/net/if_cnic.h
-new file mode 100644
-index 0000000..3dc220c
---- /dev/null
-+++ b/sys/net/if_cnic.h
-@@ -0,0 +1,44 @@
-+#ifndef _NET_IF_CNIC_H_
-+#define _NET_IF_CNIC_H_
-+
-+#ifdef _KERNEL
-+struct cnic_softc {
-+	struct	ifnet cnic_if;		/* the interface */
-+
-+	u_short	cnic_flags;		/* misc flags */
-+#define	CNIC_OPEN	0x0001
-+#define	CNIC_INITED	0x0002
-+#define	CNIC_RCOLL	0x0004
-+#define	CNIC_IASET	0x0008
-+#define	CNIC_DSTADDR	0x0010
-+#define	CNIC_RWAIT	0x0040
-+#define	CNIC_ASYNC	0x0080
-+#define	CNIC_NBIO	0x0100
-+#define	CNIC_PREPADDR	0x0200
-+#define	CNIC_IFHEAD	0x0400
-+
-+#define	CNIC_READY	(CNIC_OPEN | CNIC_INITED | CNIC_IASET)
-+
-+	pid_t	cnic_pgid;		/* PID or process group ID */
-+	struct	selinfo	cnic_rsel;	/* read select */
-+	struct	selinfo	cnic_wsel;	/* write select (not used) */
-+	int	cnic_unit;		/* the tunnel unit number */
-+	kmutex_t cnic_lock;		/* lock for this tunnel */
-+	LIST_ENTRY(cnic_softc) cnic_list;	/* list of all tuns */
-+	void	*cnic_osih;		/* soft interrupt handle */
-+	void	*cnic_isih;		/* soft interrupt handle */
-+};
-+#endif	/* _KERNEL */
-+
-+/* Maximum packet size */
-+#define	CNICMTU		1500
-+
-+/* ioctl's for get/set debug */
-+#define	CNICSDEBUG	_IOW('t', 90, int)
-+#define	CNICGDEBUG	_IOR('t', 89, int)
-+#define	CNICSIFMODE	_IOW('t', 88, int)
-+#define	CNICSLMODE	_IOW('t', 87, int)
-+#define	CNICSIFHEAD	_IOW('t', 66, int)
-+#define	CNICGIFHEAD	_IOR('t', 65, int)
-+
-+#endif /* !_NET_IF_TUN_H_ */
-diff --git a/sys/rump/net/lib/libtap/Makefile b/sys/rump/net/lib/libtap/Makefile
-index c475477..012e2c0 100644
---- a/sys/rump/net/lib/libtap/Makefile
-+++ b/sys/rump/net/lib/libtap/Makefile
-@@ -6,6 +6,8 @@
- LIB=	rumpnet_tap
- 
- SRCS=	if_tap.c
-+#RG addition to support tun devices within tap component
-+SRCS+=  if_cnic.c
- 
- SRCS+=	tap_component.c
- 
-diff --git a/sys/rump/net/lib/libtap/tap_component.c b/sys/rump/net/lib/libtap/tap_component.c
-index 6d9a1f5..457e249 100644
---- a/sys/rump/net/lib/libtap/tap_component.c
-+++ b/sys/rump/net/lib/libtap/tap_component.c
-@@ -36,29 +36,58 @@ __KERNEL_RCSID(0, "$NetBSD: tap_component.c,v 1.1 2015/05/29 12:32:23 pooka Exp
- #include "rump_net_private.h"
- #include "rump_vfs_private.h"
- 
-+#include <rump/rumpuser.h>
-+
- CFDRIVER_DECL(tap, DV_IFNET, NULL);
- 
- void tapattach(int);
-+void cnicattach(int);
- 
- RUMP_COMPONENT(RUMP_COMPONENT_NET_IF)
- {
-+
-+
- 	extern const struct cdevsw tap_cdevsw;
--	devmajor_t bmaj, cmaj;
-+	devmajor_t bmaj_tap, cmaj_tap;
- 	int error;
- 
- 	config_cfdriver_attach(&tap_cd);
- 	tapattach(0);
- 
--	bmaj = cmaj = NODEVMAJOR;
--	error = devsw_attach("tap", NULL, &bmaj, &tap_cdevsw, &cmaj);
-+	bmaj_tap = cmaj_tap = NODEVMAJOR;
-+	error = devsw_attach("tap", NULL, &bmaj_tap, &tap_cdevsw, &cmaj_tap);
- 	if (error != 0)
- 		panic("tap devsw attach failed: %d", error);
- 
--	error = rump_vfs_makeonedevnode(S_IFCHR, "/dev/tap", cmaj, 0xfffff);
-+	error = rump_vfs_makeonedevnode(S_IFCHR, "/dev/tap", cmaj_tap, 0xfffff);
- 	if (error != 0)
- 		panic("cannot create tap device node: %d", error);
- 
--	error = rump_vfs_makedevnodes(S_IFCHR, "/dev/tap", '0', cmaj, 0, 4);
-+	error = rump_vfs_makedevnodes(S_IFCHR, "/dev/tap", '0', cmaj_tap, 0, 4);
- 	if (error != 0)
- 		panic("cannot create tap[0-4] device node: %d", error);
-+
-+	/* ----- TUN ----- */
-+	/* RG: attepting to add cnic to the tap component for rump */
-+	rumpuser_dprintf("----- Hello! Greetings from the tap source code! -----\n");
-+	rumpuser_dprintf("----- Attempting to make cnic device node /dev/cnic -----\n");
-+
-+	extern const struct cdevsw cnic_cdevsw;
-+	devmajor_t bmaj_cnic, cmaj_cnic;
-+
-+	//config_cfdriver_attach(&tap_cd);
-+	cnicattach(0);
-+
-+	bmaj_cnic = cmaj_cnic = NODEVMAJOR;
-+	error = devsw_attach("cnic", NULL, &bmaj_cnic, &cnic_cdevsw, &cmaj_cnic);
-+	if (error != 0)
-+		panic("cnic devsw attach failed: %d", error);
-+
-+	error = rump_vfs_makeonedevnode(S_IFCHR, "/dev/cnic", cmaj_cnic, 0xfffff);
-+	if (error != 0)
-+		panic("cannot create cnic device node: %d", error);
-+
-+	error = rump_vfs_makedevnodes(S_IFCHR, "/dev/cnic", '0', cmaj_cnic, 0, 4);
-+	if (error != 0)
-+		panic("cannot create cnic[0-4] device node: %d", error);
- }
--- 
-1.9.1
-
diff --git a/sys/dev/pci/if_lmc.c b/sys/dev/pci/if_lmc.c
index 3faafb3..a4e27f2 100644
--- a/sys/dev/pci/if_lmc.c
+++ b/sys/dev/pci/if_lmc.c
@@ -3319,6 +3319,7 @@ static void
 ifnet_input(struct ifnet *ifp, struct mbuf *mbuf)
   {
   
+    printf("%s: ifnet_input:\n", NAME_UNIT);
   softc_t *sc = IFP2SC(ifp);
   pktqueue_t *pktq = NULL;
 
diff --git a/sys/dev/pci/if_vioif.c b/sys/dev/pci/if_vioif.c
index 409e54c..f994c14 100644
--- a/sys/dev/pci/if_vioif.c
+++ b/sys/dev/pci/if_vioif.c
@@ -32,6 +32,7 @@ __KERNEL_RCSID(0, "$NetBSD: if_vioif.c,v 1.16 2015/05/05 10:56:13 ozaki-r Exp $"
 #include "opt_net_mpsafe.h"
 #endif
 
+
 #include <sys/param.h>
 #include <sys/systm.h>
 #include <sys/kernel.h>
@@ -54,6 +55,7 @@ __KERNEL_RCSID(0, "$NetBSD: if_vioif.c,v 1.16 2015/05/05 10:56:13 ozaki-r Exp $"
 #include <net/if.h>
 #include <net/if_media.h>
 #include <net/if_ether.h>
+#include <net/pktqueue.h>
 
 #include <net/bpf.h>
 
@@ -566,7 +568,10 @@ vioif_attach(device_t parent, device_t self, void *aux)
 		goto err;
 	}
 	vsc->sc_nvqs = 1;
+	
 	sc->sc_vq[0].vq_done = vioif_rx_vq_done;
+
+
 	if (virtio_alloc_vq(vsc, &sc->sc_vq[1], 1,
 			    (sizeof(struct virtio_net_hdr)
 			     + (ETHER_MAX_LEN - ETHER_HDR_LEN)),
@@ -745,7 +750,6 @@ vioif_start(struct ifnet *ifp)
 	struct virtqueue *vq = &sc->sc_vq[1]; /* tx vq */
 	struct mbuf *m;
 	int queued = 0, retry = 0;
-
 	VIOIF_TX_LOCK(sc);
 
 	if ((ifp->if_flags & (IFF_RUNNING|IFF_OACTIVE)) != IFF_RUNNING)
@@ -753,7 +757,6 @@ vioif_start(struct ifnet *ifp)
 
 	if (sc->sc_stopping)
 		goto out;
-
 	for (;;) {
 		int slot, r;
 
@@ -774,6 +777,7 @@ retry:
 		}
 		if (r != 0)
 			panic("enqueue_prep for a tx buffer");
+
 		r = bus_dmamap_load_mbuf(vsc->sc_dmat,
 					 sc->sc_tx_dmamaps[slot],
 					 m, BUS_DMA_WRITE|BUS_DMA_NOWAIT);
@@ -965,10 +969,10 @@ vioif_rx_deq(struct vioif_softc *sc)
 	VIOIF_RX_LOCK(sc);
 	r = vioif_rx_deq_locked(sc);
 	VIOIF_RX_UNLOCK(sc);
-
 	return r;
 }
 
+
 /* dequeue recieved packets */
 static int
 vioif_rx_deq_locked(struct vioif_softc *sc)
@@ -1028,8 +1032,9 @@ vioif_rx_vq_done(struct virtqueue *vq)
 
 	if (sc->sc_stopping)
 		goto out;
-
+	
 	r = vioif_rx_deq_locked(sc);
+		
 	if (r)
 #ifdef VIOIF_SOFTINT_INTR
 		vioif_populate_rx_mbufs_locked(sc);
diff --git a/sys/dev/pci/if_wm.c b/sys/dev/pci/if_wm.c
index b63f394..a3cd669 100644
--- a/sys/dev/pci/if_wm.c
+++ b/sys/dev/pci/if_wm.c
@@ -106,6 +106,7 @@ __KERNEL_RCSID(0, "$NetBSD: if_wm.c,v 1.321 2015/05/16 22:41:59 msaitoh Exp $");
 #include <net/if_dl.h>
 #include <net/if_media.h>
 #include <net/if_ether.h>
+#include <net/pktqueue.h>
 
 #include <net/bpf.h>
 
@@ -591,6 +592,7 @@ static int	wm_nq_tx_offload(struct wm_softc *, struct wm_txsoft *,
 static void	wm_nq_start(struct ifnet *);
 static void	wm_nq_start_locked(struct ifnet *);
 /* Interrupt */
+#include "if_wm.h"
 static void	wm_txintr(struct wm_softc *);
 static void	wm_rxintr(struct wm_softc *);
 static void	wm_linkintr_gmii(struct wm_softc *, uint32_t);
@@ -4475,6 +4477,7 @@ static int
 wm_tx_offload(struct wm_softc *sc, struct wm_txsoft *txs, uint32_t *cmdp,
     uint8_t *fieldsp)
 {
+	printf("wm_tx_offload\n");
 	struct mbuf *m0 = txs->txs_mbuf;
 	struct livengood_tcpip_ctxdesc *t;
 	uint32_t ipcs, tucs, cmd, cmdlen, seg;
@@ -5674,6 +5677,7 @@ wm_txintr(struct wm_softc *sc)
 		ifp->if_timer = 0;
 }
 
+
 /*
  * wm_rxintr:
  *
@@ -5682,13 +5686,14 @@ wm_txintr(struct wm_softc *sc)
 static void
 wm_rxintr(struct wm_softc *sc)
 {
+	printf("wm_rxintr\n");
 	struct ifnet *ifp = &sc->sc_ethercom.ec_if;
 	struct wm_rxsoft *rxs;
 	struct mbuf *m;
 	int i, len;
 	uint8_t status, errors;
 	uint16_t vlantag;
-
+	assert(0);
 	for (i = sc->sc_rxptr;; i = WM_NEXTRX(i)) {
 		rxs = &sc->sc_rxsoft[i];
 
@@ -6038,6 +6043,7 @@ wm_linkintr(struct wm_softc *sc, uint32_t icr)
 		wm_linkintr_tbi(sc, icr);
 }
 
+
 /*
  * wm_intr:
  *
@@ -6046,6 +6052,7 @@ wm_linkintr(struct wm_softc *sc, uint32_t icr)
 static int
 wm_intr(void *arg)
 {
+	printf("wm_intr\n");
 	struct wm_softc *sc = arg;
 	struct ifnet *ifp = &sc->sc_ethercom.ec_if;
 	uint32_t icr;
diff --git a/sys/dev/pci/virtio.c b/sys/dev/pci/virtio.c
index 3c5c69b..d573c54 100644
--- a/sys/dev/pci/virtio.c
+++ b/sys/dev/pci/virtio.c
@@ -35,15 +35,16 @@ __KERNEL_RCSID(0, "$NetBSD: virtio.c,v 1.9 2015/05/05 10:58:35 ozaki-r Exp $");
 #include <sys/bus.h>
 #include <sys/device.h>
 #include <sys/kmem.h>
-
+#include <net/pktqueue.h>
+#include <dev/pci/if_wm.h>
 #include <dev/pci/pcidevs.h>
 #include <dev/pci/pcireg.h>
 #include <dev/pci/pcivar.h>
-
 #include <dev/pci/virtioreg.h>
 #include <dev/pci/virtiovar.h>
 
 #define MINSEG_INDIRECT		2 /* use indirect if nsegs >= this value */
+#define RCVING_VM1 0x00000001
 
 static int	virtio_match(device_t, cfdata_t, void *);
 static void	virtio_attach(device_t, device_t, void *);
@@ -104,6 +105,7 @@ static const char *virtio_device_name[] = {
 };
 #define NDEVNAMES	(sizeof(virtio_device_name)/sizeof(char*))
 
+
 static void
 virtio_attach(device_t parent, device_t self, void *aux)
 {
@@ -176,9 +178,9 @@ virtio_attach(device_t parent, device_t self, void *aux)
 
 	if (sc->sc_flags & VIRTIO_F_PCI_INTR_MPSAFE)
 		pci_intr_setattr(pc, &ih, PCI_INTR_MPSAFE, true);
-
+	
 	sc->sc_ih = pci_intr_establish(pc, ih, sc->sc_ipl, virtio_intr, sc);
-
+	
 	if (sc->sc_ih == NULL) {
 		aprint_error_dev(self, "couldn't establish interrupt");
 		if (intrstr != NULL)
@@ -395,18 +397,20 @@ virtio_intr(void *arg)
 	/* check and ack the interrupt */
 	isr = bus_space_read_1(sc->sc_iot, sc->sc_ioh,
 			       VIRTIO_CONFIG_ISR_STATUS);
+	
 	if (isr == 0)
 		return 0;
 	if ((isr & VIRTIO_CONFIG_ISR_CONFIG_CHANGE) &&
-	    (sc->sc_config_change != NULL))
+	    (sc->sc_config_change != NULL)){
 		r = (sc->sc_config_change)(sc);
+	}
 	if (sc->sc_intrhand != NULL) {
-		if (sc->sc_soft_ih != NULL)
+		if (sc->sc_soft_ih != NULL){
 			softint_schedule(sc->sc_soft_ih);
-		else
+		}else{
 			r |= (sc->sc_intrhand)(sc);
+		}
 	}
-
 	return r;
 }
 
@@ -416,7 +420,6 @@ virtio_soft_intr(void *arg)
 	struct virtio_softc *sc = arg;
 
 	KASSERT(sc->sc_intrhand != NULL);
-
 	(sc->sc_intrhand)(sc);
 }
 
@@ -484,12 +487,13 @@ virtio_vq_intr(struct virtio_softc *sc)
 		}
 		vq_sync_uring(sc, vq, BUS_DMASYNC_POSTREAD);
 		membar_consumer();
+	
 		if (vq->vq_used_idx != vq->vq_used->idx) {
-			if (vq->vq_done)
+			if (vq->vq_done){
 				r |= (vq->vq_done)(vq);
+			}
 		}
 	}
-
 	return r;
 }
 
diff --git a/sys/kern/kern_softint.c b/sys/kern/kern_softint.c
index 59f383d..7455f3f 100644
--- a/sys/kern/kern_softint.c
+++ b/sys/kern/kern_softint.c
@@ -483,7 +483,7 @@ softint_schedule(void *arg)
 	KASSERTMSG(offset != 0 && offset < softint_bytes, "%"PRIuPTR" %u",
 	    offset, softint_bytes);
 	sh = (softhand_t *)((uint8_t *)curcpu()->ci_data.cpu_softcpu + offset);
-
+	
 	/* If it's already pending there's nothing to do. */
 	if ((sh->sh_flags & SOFTINT_PENDING) != 0) {
 		return;
diff --git a/sys/net/.if_cnic.c.swo b/sys/net/.if_cnic.c.swo
deleted file mode 100644
index 3e51b4f910153b1ead0db54095c6bfc85edca9aa..0000000000000000000000000000000000000000
GIT binary patch
literal 0
HcmV?d00001

literal 40960
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
E0KdVWB>(^b

diff --git a/sys/net/.if_cnic.c.swp b/sys/net/.if_cnic.c.swp
deleted file mode 100644
index 1f43a3f9aa3615ace9b7f125a448841147c724e1..0000000000000000000000000000000000000000
GIT binary patch
literal 0
HcmV?d00001

literal 16384
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
WOO>3yP2`rXMW@-wr$J`@UhbclB!X4|

diff --git a/sys/net/.if_ethersubr.c.swp b/sys/net/.if_ethersubr.c.swp
deleted file mode 100644
index 2cf388c81aea98b4c6b18b518c93caf207f93152..0000000000000000000000000000000000000000
GIT binary patch
literal 0
HcmV?d00001

literal 53248
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

diff --git a/sys/net/if.c b/sys/net/if.c
index dc69e5a..3028954 100644
--- a/sys/net/if.c
+++ b/sys/net/if.c
@@ -1203,8 +1203,9 @@ ifa_ifwithaddr(const struct sockaddr *addr)
 		IFADDR_FOREACH(ifa, ifp) {
 			if (ifa->ifa_addr->sa_family != addr->sa_family)
 				continue;
-			if (equal(addr, ifa->ifa_addr))
+			if (equal(addr, ifa->ifa_addr)){
 				return ifa;
+			}
 			if ((ifp->if_flags & IFF_BROADCAST) &&
 			    ifa->ifa_broadaddr &&
 			    /* IP6 doesn't have broadcast */
diff --git a/sys/net/if_bridge.c b/sys/net/if_bridge.c
index c55be91..edfcf80 100644
--- a/sys/net/if_bridge.c
+++ b/sys/net/if_bridge.c
@@ -1677,7 +1677,6 @@ bridge_start(struct ifnet *ifp)
 static void
 bridge_forward(void *v)
 {
-	printf("bridge_forward\n");
 	struct bridge_softc *sc = v;
 	struct mbuf *m;
 	struct bridge_iflist *bif;
@@ -1867,10 +1866,11 @@ bridge_ourether(struct bridge_iflist *bif, struct ether_header *eh, int src)
 static void
 bridge_input(struct ifnet *ifp, struct mbuf *m)
 {
+	printf("bridge_input\n");
 	struct bridge_softc *sc = ifp->if_bridge;
 	struct bridge_iflist *bif;
 	struct ether_header *eh;
-
+	
 	if (__predict_false(sc == NULL) ||
 	    (sc->sc_if.if_flags & IFF_RUNNING) == 0) {
 		ether_input(ifp, m);
diff --git a/sys/net/if_cnic.c~ b/sys/net/if_cnic.c~
new file mode 100644
index 0000000..20d7ea3
--- /dev/null
+++ b/sys/net/if_cnic.c~
@@ -0,0 +1,1124 @@
+/* All rights go the NetBSD, this is simply a copy of if_tun.c with tun namespace replaced with cnic */
+
+#include <sys/cdefs.h>
+
+#include "opt_inet.h"
+
+#include <sys/param.h>
+#include <sys/proc.h>
+#include <sys/systm.h>
+#include <sys/mbuf.h>
+#include <sys/buf.h>
+#include <sys/protosw.h>
+#include <sys/socket.h>
+#include <sys/ioctl.h>
+#include <sys/errno.h>
+#include <sys/syslog.h>
+#include <sys/select.h>
+#include <sys/poll.h>
+#include <sys/file.h>
+#include <sys/signalvar.h>
+#include <sys/conf.h>
+#include <sys/kauth.h>
+#include <sys/mutex.h>
+#include <sys/cpu.h>
+
+#include <net/if.h>
+#include <net/if_types.h>
+#include <net/netisr.h>
+#include <net/route.h>
+
+#ifdef INET
+#include <netinet/in.h>
+#include <netinet/in_systm.h>
+#include <netinet/in_var.h>
+#include <netinet/ip.h>
+#include <netinet/if_inarp.h>
+#endif
+
+#include <sys/time.h>
+#include <net/bpf.h>
+
+#include <net/if_cnic.h>
+
+#define CNICDEBUG	if (cnicdebug) printf
+int	cnicdebug = 0;
+extern int ifqmaxlen;
+void	cnicattach(int);
+extern int rump_vmid;
+static LIST_HEAD(, cnic_softc) cnic_softc_list;
+static LIST_HEAD(, cnic_softc) cnicz_softc_list;
+static kmutex_t cnic_softc_lock;
+
+static int	cnic_ioctl(struct ifnet *, u_long, void *);
+static int	cnic_output(struct ifnet *, struct mbuf *,
+			const struct sockaddr *, struct rtentry *rt);
+static int	cnic_clone_create(struct if_clone *, int);
+static int	cnic_clone_destroy(struct ifnet *);
+
+static struct if_clone cnic_cloner =
+    IF_CLONE_INITIALIZER("cnic", cnic_clone_create, cnic_clone_destroy);
+
+static void cnicattach0(struct cnic_softc *);
+static void cnicinit(struct cnic_softc *);
+static void cnic_i_softintr(void *);
+static void cnic_o_softintr(void *);
+#ifdef ALTQ
+static void cnicstart(struct ifnet *);
+#endif
+static struct cnic_softc *cnic_find_unit(dev_t);
+static struct cnic_softc *cnic_find_zunit(int);
+
+static dev_type_open(cnicopen);
+static dev_type_close(cnicclose);
+static dev_type_read(cnicread);
+static dev_type_write(cnicwrite);
+static dev_type_ioctl(cnicioctl);
+static dev_type_poll(cnicpoll);
+static dev_type_kqfilter(cnickqfilter);
+
+const struct cdevsw cnic_cdevsw = {
+	.d_open = cnicopen,
+	.d_close = cnicclose,
+	.d_read = cnicread,
+	.d_write = cnicwrite,
+	.d_ioctl = cnicioctl,
+	.d_stop = nostop,
+	.d_tty = notty,
+	.d_poll = cnicpoll,
+	.d_mmap = nommap,
+	.d_kqfilter = cnickqfilter,
+	.d_discard = nodiscard,
+	.d_flag = D_OTHER
+};
+
+
+void
+cnicattach(int unused)
+{
+
+	mutex_init(&cnic_softc_lock, MUTEX_DEFAULT, IPL_NET);
+	LIST_INIT(&cnic_softc_list);
+	LIST_INIT(&cnicz_softc_list);
+	if_clone_attach(&cnic_cloner);
+}
+
+/*
+ * Find driver instance from dev_t.
+ * Returns with tp locked (if found).
+ */
+static struct cnic_softc *
+cnic_find_unit(dev_t dev)
+{
+	struct cnic_softc *tp;
+	int unit = minor(dev);
+
+	mutex_enter(&cnic_softc_lock);
+	LIST_FOREACH(tp, &cnic_softc_list, cnic_list)
+		if (unit == tp->cnic_unit)
+			break;
+	if (tp)
+		mutex_enter(&tp->cnic_lock);
+	mutex_exit(&cnic_softc_lock);
+
+	return (tp);
+}
+
+/*
+ * Find zombie driver instance by unit number.
+ * Remove tp from list and return it unlocked (if found).
+ */
+static struct cnic_softc *
+cnic_find_zunit(int unit)
+{
+	struct cnic_softc *tp;
+
+	mutex_enter(&cnic_softc_lock);
+	LIST_FOREACH(tp, &cnicz_softc_list, cnic_list)
+		if (unit == tp->cnic_unit)
+			break;
+	if (tp)
+		LIST_REMOVE(tp, cnic_list);
+	mutex_exit(&cnic_softc_lock);
+#ifdef DIAGNOSTIC
+	if (tp != NULL && (tp->cnic_flags & (CNIC_INITED|CNIC_OPEN)) != CNIC_OPEN)
+		printf("cnic%d: inconsistent flags: %x\n", unit, tp->cnic_flags);
+#endif
+
+	return (tp);
+}
+
+static int
+cnic_clone_create(struct if_clone *ifc, int unit)
+{
+	struct cnic_softc *tp;
+
+	if ((tp = cnic_find_zunit(unit)) == NULL) {
+		/* Allocate a new instance */
+		tp = malloc(sizeof(*tp), M_DEVBUF, M_WAITOK|M_ZERO);
+
+		tp->cnic_unit = unit;
+		mutex_init(&tp->cnic_lock, MUTEX_DEFAULT, IPL_NET);
+		selinit(&tp->cnic_rsel);
+		selinit(&tp->cnic_wsel);
+	} else {
+		/* Revive cnicnel instance; clear ifp part */
+		(void)memset(&tp->cnic_if, 0, sizeof(struct ifnet));
+	}
+
+	if_initname(&tp->cnic_if, ifc->ifc_name, unit);
+	cnicattach0(tp);
+	tp->cnic_flags |= CNIC_INITED;
+	tp->cnic_osih = softint_establish(SOFTINT_CLOCK, cnic_o_softintr, tp);
+	tp->cnic_isih = softint_establish(SOFTINT_CLOCK, cnic_i_softintr, tp);
+
+	mutex_enter(&cnic_softc_lock);
+	LIST_INSERT_HEAD(&cnic_softc_list, tp, cnic_list);
+	mutex_exit(&cnic_softc_lock);
+
+	return (0);
+}
+
+static void
+cnicattach0(struct cnic_softc *tp)
+{
+	struct ifnet *ifp;
+
+	ifp = &tp->cnic_if;
+	ifp->if_softc = tp;
+	ifp->if_mtu = CNICMTU;
+	ifp->if_ioctl = cnic_ioctl;
+	ifp->if_output = cnic_output;
+#ifdef ALTQ
+	ifp->if_start = cnicstart;
+#endif
+	ifp->if_flags = IFF_POINTOPOINT;
+	ifp->if_type = IFT_TUNNEL;
+	ifp->if_snd.ifq_maxlen = ifqmaxlen;
+	ifp->if_collisions = 0;
+	ifp->if_ierrors = 0;
+	ifp->if_oerrors = 0;
+	ifp->if_ipackets = 0;
+	ifp->if_opackets = 0;
+	ifp->if_ibytes   = 0;
+	ifp->if_obytes   = 0;
+	ifp->if_dlt = DLT_NULL;
+	IFQ_SET_READY(&ifp->if_snd);
+	if_attach(ifp);
+	if_alloc_sadl(ifp);
+	bpf_attach(ifp, DLT_NULL, sizeof(uint32_t));
+}
+
+static int
+cnic_clone_destroy(struct ifnet *ifp)
+{
+	struct cnic_softc *tp = (void *)ifp;
+	int zombie = 0;
+
+	IF_PURGE(&ifp->if_snd);
+	ifp->if_flags &= ~IFF_RUNNING;
+
+	mutex_enter(&cnic_softc_lock);
+	mutex_enter(&tp->cnic_lock);
+	LIST_REMOVE(tp, cnic_list);
+	if (tp->cnic_flags & CNIC_OPEN) {
+		/* Hang on to storage until last close */
+		zombie = 1;
+		tp->cnic_flags &= ~CNIC_INITED;
+		LIST_INSERT_HEAD(&cnicz_softc_list, tp, cnic_list);
+	}
+	mutex_exit(&cnic_softc_lock);
+
+	if (tp->cnic_flags & CNIC_RWAIT) {
+		tp->cnic_flags &= ~CNIC_RWAIT;
+		wakeup((void *)tp);
+	}
+	selnotify(&tp->cnic_rsel, 0, 0);
+
+	mutex_exit(&tp->cnic_lock);
+
+	if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
+		fownsignal(tp->cnic_pgid, SIGIO, POLL_HUP, 0, NULL);
+
+	bpf_detach(ifp);
+	if_detach(ifp);
+
+	if (!zombie) {
+		seldestroy(&tp->cnic_rsel);
+		seldestroy(&tp->cnic_wsel);
+		softint_disestablish(tp->cnic_osih);
+		softint_disestablish(tp->cnic_isih);
+		mutex_destroy(&tp->cnic_lock);
+		free(tp, M_DEVBUF);
+	}
+
+	return (0);
+}
+
+/*
+ * cnicnel open - must be superuser & the device must be
+ * configured in
+ */
+
+struct ifnet *global_ifp = 0;
+
+static int
+cnicopen(dev_t dev, int flag, int mode, struct lwp *l)
+{
+	struct ifnet	*ifp;
+	struct cnic_softc *tp;
+	int	error;
+
+	error = kauth_authorize_network(l->l_cred, KAUTH_NETWORK_INTERFACE_TUN,
+	    KAUTH_REQ_NETWORK_INTERFACE_TUN_ADD, NULL, NULL, NULL);
+	if (error)
+		return (error);
+
+	tp = cnic_find_unit(dev);
+
+	if (tp == NULL) {
+		(void)cnic_clone_create(&cnic_cloner, minor(dev));
+		tp = cnic_find_unit(dev);
+		if (tp == NULL) {
+			error = ENXIO;
+			goto out_nolock;
+		}
+	}
+
+	if (tp->cnic_flags & CNIC_OPEN) {
+		error = EBUSY;
+		goto out;
+	}
+
+	ifp = &tp->cnic_if;
+	global_ifp = ifp;
+	tp->cnic_flags |= CNIC_OPEN;
+	CNICDEBUG("%s: open\n", ifp->if_xname);
+out:
+	mutex_exit(&tp->cnic_lock);
+out_nolock:
+	return (error);
+}
+
+/*
+ * cnicclose - close the device - mark i/f down & delete
+ * routing info
+ */
+int
+cnicclose(dev_t dev, int flag, int mode,
+    struct lwp *l)
+{
+	struct cnic_softc *tp;
+	struct ifnet	*ifp;
+
+	if ((tp = cnic_find_zunit(minor(dev))) != NULL) {
+		/* interface was "destroyed" before the close */
+		seldestroy(&tp->cnic_rsel);
+		seldestroy(&tp->cnic_wsel);
+		softint_disestablish(tp->cnic_osih);
+		softint_disestablish(tp->cnic_isih);
+		mutex_destroy(&tp->cnic_lock);
+		free(tp, M_DEVBUF);
+		goto out_nolock;
+	}
+
+	if ((tp = cnic_find_unit(dev)) == NULL)
+		goto out_nolock;
+
+	ifp = &tp->cnic_if;
+
+	tp->cnic_flags &= ~CNIC_OPEN;
+
+	tp->cnic_pgid = 0;
+	selnotify(&tp->cnic_rsel, 0, 0);
+
+	CNICDEBUG ("%s: closed\n", ifp->if_xname);
+	mutex_exit(&tp->cnic_lock);
+
+	/*
+	 * junk all pending output
+	 */
+	IFQ_PURGE(&ifp->if_snd);
+
+	if (ifp->if_flags & IFF_UP) {
+		if_down(ifp);
+		if (ifp->if_flags & IFF_RUNNING) {
+			/* find internet addresses and delete routes */
+			struct ifaddr *ifa;
+			IFADDR_FOREACH(ifa, ifp) {
+#if defined(INET) || defined(INET6)
+				if (ifa->ifa_addr->sa_family == AF_INET ||
+				    ifa->ifa_addr->sa_family == AF_INET6) {
+					rtinit(ifa, (int)RTM_DELETE,
+					       tp->cnic_flags & CNIC_DSTADDR
+							? RTF_HOST
+							: 0);
+				}
+#endif
+			}
+		}
+	}
+out_nolock:
+	return (0);
+}
+
+/*
+ * Call at splnet().
+ */
+static void
+cnicinit(struct cnic_softc *tp)
+{
+	struct ifnet	*ifp = &tp->cnic_if;
+	struct ifaddr	*ifa;
+
+	CNICDEBUG("%s: cnicinit\n", ifp->if_xname);
+
+	mutex_enter(&tp->cnic_lock);
+	ifp->if_flags |= IFF_UP | IFF_RUNNING;
+
+	tp->cnic_flags &= ~(CNIC_IASET|CNIC_DSTADDR);
+	IFADDR_FOREACH(ifa, ifp) {
+#ifdef INET
+		if (ifa->ifa_addr->sa_family == AF_INET) {
+			struct sockaddr_in *sin;
+
+			sin = satosin(ifa->ifa_addr);
+			if (sin && sin->sin_addr.s_addr)
+				tp->cnic_flags |= CNIC_IASET;
+
+			if (ifp->if_flags & IFF_POINTOPOINT) {
+				sin = satosin(ifa->ifa_dstaddr);
+				if (sin && sin->sin_addr.s_addr)
+					tp->cnic_flags |= CNIC_DSTADDR;
+			}
+		}
+#endif
+#ifdef INET6
+		if (ifa->ifa_addr->sa_family == AF_INET6) {
+			struct sockaddr_in6 *sin;
+
+			sin = (struct sockaddr_in6 *)ifa->ifa_addr;
+			if (!IN6_IS_ADDR_UNSPECIFIED(&sin->sin6_addr))
+				tp->cnic_flags |= CNIC_IASET;
+
+			if (ifp->if_flags & IFF_POINTOPOINT) {
+				sin = (struct sockaddr_in6 *)ifa->ifa_dstaddr;
+				if (sin &&
+				    !IN6_IS_ADDR_UNSPECIFIED(&sin->sin6_addr))
+					tp->cnic_flags |= CNIC_DSTADDR;
+			} else
+				tp->cnic_flags &= ~CNIC_DSTADDR;
+		}
+#endif /* INET6 */
+	}
+	mutex_exit(&tp->cnic_lock);
+}
+
+/*
+ * Process an ioctl request.
+ */
+static int
+cnic_ioctl(struct ifnet *ifp, u_long cmd, void *data)
+{
+	int		error = 0, s;
+	struct cnic_softc *tp = (struct cnic_softc *)(ifp->if_softc);
+	struct ifreq *ifr = (struct ifreq *)data;
+	struct ifaddr *ifa = (struct ifaddr *)data;
+
+	s = splnet();
+
+	switch (cmd) {
+	case SIOCINITIFADDR:
+		cnicinit(tp);
+		ifa->ifa_rtrequest = p2p_rtrequest;
+		CNICDEBUG("%s: address set\n", ifp->if_xname);
+		break;
+	case SIOCSIFBRDADDR:
+		CNICDEBUG("%s: broadcast address set\n", ifp->if_xname);
+		break;
+	case SIOCSIFMTU:
+		if (ifr->ifr_mtu > CNICMTU || ifr->ifr_mtu < 576) {
+			error = EINVAL;
+			break;
+		}
+		CNICDEBUG("%s: interface mtu set\n", ifp->if_xname);
+		if ((error = ifioctl_common(ifp, cmd, data)) == ENETRESET)
+			error = 0;
+		break;
+	case SIOCADDMULTI:
+	case SIOCDELMULTI:
+		if (ifr == NULL) {
+	        	error = EAFNOSUPPORT;           /* XXX */
+			break;
+		}
+		switch (ifreq_getaddr(cmd, ifr)->sa_family) {
+#ifdef INET
+		case AF_INET:
+			break;
+#endif
+#ifdef INET6
+		case AF_INET6:
+			break;
+#endif
+		default:
+			error = EAFNOSUPPORT;
+			break;
+		}
+		break;
+	default:
+		error = ifioctl_common(ifp, cmd, data);
+	}
+
+	splx(s);
+	return (error);
+}
+
+/*
+ * cnic_output - queue packets from higher level ready to put out.
+ */
+static int
+cnic_output(struct ifnet *ifp, struct mbuf *m0, const struct sockaddr *dst,
+    struct rtentry *rt)
+{
+	CNICDEBUG("%s: cnic_output. \n", ifp->if_xname);
+	struct cnic_softc *tp = ifp->if_softc;
+	int		s;
+	int		error;
+#if defined(INET) || defined(INET6)
+	int		mlen;
+	uint32_t	*af;
+#endif
+	
+	ALTQ_DECL(struct altq_pktattr pktattr;)
+
+	s = splnet();
+	mutex_enter(&tp->cnic_lock);
+
+	if ((tp->cnic_flags & CNIC_READY) != CNIC_READY) {
+		CNICDEBUG ("%s: not ready 0%o\n", ifp->if_xname,
+			  tp->cnic_flags);
+		error = EHOSTDOWN;
+		goto out;
+	}
+	printf("mbuf(%p){ m_next:%p m_nextpkt:%p m_data:%p "
+	       "m_len:%d m_type:0x%02x m_flags:0x%02x }\n",
+		m0, m0->m_next, m0->m_nextpkt, m0->m_data,
+		m0->m_len, m0->m_type, m0->m_flags);
+
+	if (m0->m_flags & M_EXT) {
+		printf("  m_pkthdr{ len:%d rcvif:%p }\n",
+		    m0->m_pkthdr.len, m0->m_pkthdr.rcvif);
+	}
+	//send to corresponding RK	
+	char test[] = "Hello from VM1";	
+	cos_pktq_enqueue(test, sizeof(test), 1);	
+	m_free(m0);
+	goto out;
+	
+	/*
+	 * if the queueing discipline needs packet classification,
+	 * do it before prepending link headers.
+	 */
+	IFQ_CLASSIFY(&ifp->if_snd, m0, dst->sa_family, &pktattr);
+	
+	bpf_mtap_af(ifp, dst->sa_family, m0);
+
+	switch(dst->sa_family) {
+#ifdef INET6
+	case AF_INET6:
+#endif
+#ifdef INET
+	case AF_INET:
+#endif
+#if defined(INET) || defined(INET6)
+		if (tp->cnic_flags & CNIC_PREPADDR) {
+			/* Simple link-layer header */
+			M_PREPEND(m0, dst->sa_len, M_DONTWAIT);
+			if (m0 == NULL) {
+				IF_DROP(&ifp->if_snd);
+				error = ENOBUFS;
+				goto out;
+			}
+			bcopy(dst, mtod(m0, char *), dst->sa_len);
+		}
+
+		if (tp->cnic_flags & CNIC_IFHEAD) {
+			/* Prepend the address family */
+			M_PREPEND(m0, sizeof(*af), M_DONTWAIT);
+			if (m0 == NULL) {
+				IF_DROP(&ifp->if_snd);
+				error = ENOBUFS;
+				goto out;
+			}
+			af = mtod(m0,uint32_t *);
+			*af = htonl(dst->sa_family);
+		} else {
+#ifdef INET
+			if (dst->sa_family != AF_INET)
+#endif
+			{
+				error = EAFNOSUPPORT;
+				goto out;
+			}
+		}
+		/* FALLTHROUGH */
+	case AF_UNSPEC:
+		
+		IFQ_ENQUEUE(&ifp->if_snd, m0, &pktattr, error);
+		
+		if (error) {
+			ifp->if_collisions++;
+			error = EAFNOSUPPORT;
+			m0 = NULL;
+			goto out;
+		}
+		
+		mlen = m0->m_pkthdr.len;
+		ifp->if_opackets++;
+		ifp->if_obytes += mlen;
+		break;
+#endif
+	default:
+		error = EAFNOSUPPORT;
+		goto out;
+	}
+
+	if (tp->cnic_flags & CNIC_RWAIT) {
+		tp->cnic_flags &= ~CNIC_RWAIT;
+		wakeup((void *)tp);
+	}
+	if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
+		softint_schedule(tp->cnic_isih);
+
+	selnotify(&tp->cnic_rsel, 0, 0);
+out:
+	mutex_exit(&tp->cnic_lock);
+	splx(s);
+
+	if (error && m0) {
+		m_freem(m0);
+	}
+	return 0;
+}
+
+static void
+cnic_i_softintr(void *cookie)
+{
+	struct cnic_softc *tp = cookie;
+
+	if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
+		fownsignal(tp->cnic_pgid, SIGIO, POLL_IN, POLLIN|POLLRDNORM,
+		    NULL);
+}
+
+static void
+cnic_o_softintr(void *cookie)
+{
+	struct cnic_softc *tp = cookie;
+
+	if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
+		fownsignal(tp->cnic_pgid, SIGIO, POLL_OUT, POLLOUT|POLLWRNORM,
+		    NULL);
+}
+
+/*
+ * the cdevsw interface is now pretty minimal.
+ */
+int
+cnicioctl(dev_t dev, u_long cmd, void *data, int flag, struct lwp *l)
+{
+	struct cnic_softc *tp;
+	int s, error = 0;
+
+	s = splnet();
+	tp = cnic_find_unit(dev);
+
+	/* interface was "destroyed" already */
+	if (tp == NULL) {
+		error = ENXIO;
+		goto out_nolock;
+	}
+
+	switch (cmd) {
+	case CNICSDEBUG:
+		cnicdebug = *(int *)data;
+		break;
+
+	case CNICGDEBUG:
+		*(int *)data = cnicdebug;
+		break;
+
+	case CNICSIFMODE:
+		switch (*(int *)data & (IFF_POINTOPOINT|IFF_BROADCAST)) {
+		case IFF_POINTOPOINT:
+		case IFF_BROADCAST:
+			if (tp->cnic_if.if_flags & IFF_UP) {
+				error = EBUSY;
+				goto out;
+			}
+			tp->cnic_if.if_flags &=
+				~(IFF_BROADCAST|IFF_POINTOPOINT|IFF_MULTICAST);
+			tp->cnic_if.if_flags |= *(int *)data;
+			break;
+		default:
+			error = EINVAL;
+			goto out;
+		}
+		break;
+
+	case CNICSLMODE:
+		if (*(int *)data) {
+			tp->cnic_flags |= CNIC_PREPADDR;
+			tp->cnic_flags &= ~CNIC_IFHEAD;
+		} else
+			tp->cnic_flags &= ~CNIC_PREPADDR;
+		break;
+
+	case CNICSIFHEAD:
+		if (*(int *)data) {
+			tp->cnic_flags |= CNIC_IFHEAD;
+			tp->cnic_flags &= ~CNIC_PREPADDR;
+		} else
+			tp->cnic_flags &= ~CNIC_IFHEAD;
+		break;
+
+	case CNICGIFHEAD:
+		*(int *)data = (tp->cnic_flags & CNIC_IFHEAD);
+		break;
+
+	case FIONBIO:
+		if (*(int *)data)
+			tp->cnic_flags |= CNIC_NBIO;
+		else
+			tp->cnic_flags &= ~CNIC_NBIO;
+		break;
+
+	case FIOASYNC:
+		if (*(int *)data)
+			tp->cnic_flags |= CNIC_ASYNC;
+		else
+			tp->cnic_flags &= ~CNIC_ASYNC;
+		break;
+
+	case FIONREAD:
+		if (tp->cnic_if.if_snd.ifq_head)
+			*(int *)data = tp->cnic_if.if_snd.ifq_head->m_pkthdr.len;
+		else
+			*(int *)data = 0;
+		break;
+
+	case TIOCSPGRP:
+	case FIOSETOWN:
+		error = fsetown(&tp->cnic_pgid, cmd, data);
+		break;
+
+	case TIOCGPGRP:
+	case FIOGETOWN:
+		error = fgetown(tp->cnic_pgid, cmd, data);
+		break;
+
+	default:
+		error = ENOTTY;
+	}
+
+out:
+	mutex_exit(&tp->cnic_lock);
+out_nolock:
+	splx(s);
+	return (error);
+}
+
+/*
+ * The cdevsw read interface - reads a packet at a time, or at
+ * least as much of a packet as can be read.
+ */
+int
+cnicread(dev_t dev, struct uio *uio, int ioflag)
+{
+	printf("cnic read\n");
+//	if(1) return 0;	
+	struct cnic_softc *tp;
+	struct ifnet	*ifp;
+	struct mbuf	*m, *m0;
+	int		error = 0, len, s, index;
+
+	s = splnet();
+	tp = cnic_find_unit(dev);
+
+	/* interface was "destroyed" already */
+	if (tp == NULL) {
+		error = ENXIO;
+		goto out_nolock;
+	}
+
+	index = tp->cnic_if.if_index;
+	ifp = &tp->cnic_if;
+
+	CNICDEBUG ("%s: read\n", ifp->if_xname);
+	if ((tp->cnic_flags & CNIC_READY) != CNIC_READY) {
+		CNICDEBUG ("%s: not ready 0%o\n", ifp->if_xname, tp->cnic_flags);
+		error = EHOSTDOWN;
+		goto out;
+	}
+
+	tp->cnic_flags &= ~CNIC_RWAIT;
+	
+	do {
+		IFQ_DEQUEUE(&ifp->if_snd, m0);
+		if (m0 == 0) {
+			if (tp->cnic_flags & CNIC_NBIO) {
+				error = EWOULDBLOCK;
+				goto out;
+			}
+			tp->cnic_flags |= CNIC_RWAIT;
+			if (mtsleep((void *)tp, PZERO|PCATCH|PNORELOCK,
+					"cnicread", 0, &tp->cnic_lock) != 0) {
+				error = EINTR;
+				goto out_nolock;
+			} else {
+				/*
+				 * Maybe the interface was destroyed while
+				 * we were sleeping, so let's ensure that
+				 * we're looking at the same (valid) cnic
+				 * interface before looping.
+				 */
+				tp = cnic_find_unit(dev);
+				if (tp == NULL) {
+					error = ENXIO;
+					goto out_nolock;
+				}
+				if (tp->cnic_if.if_index != index) {
+					error = ENXIO;
+					goto out;
+				}
+			}
+		}
+	} while (m0 == 0);
+	
+	mutex_exit(&tp->cnic_lock);
+	splx(s);
+
+	/* Copy the mbuf chain */
+	while (m0 && uio->uio_resid > 0 && error == 0) {
+		len = min(uio->uio_resid, m0->m_len);
+		if (len != 0)
+			error = uiomove(mtod(m0, void *), len, uio);
+		MFREE(m0, m);
+		m0 = m;
+	}
+
+	if (m0) {
+		CNICDEBUG("Dropping mbuf\n");
+		m_freem(m0);
+	}
+	if (error)
+		ifp->if_ierrors++;
+
+	return (error);
+
+out:
+	mutex_exit(&tp->cnic_lock);
+out_nolock:
+	splx(s);
+	return (error);
+}
+
+/*
+ * the cdevsw write interface - an atomic write is a packet - or else!
+ */
+int
+cnicwrite(dev_t dev, struct uio *uio, int ioflag)
+{
+	printf("cnicwrite\n");
+	//if(1) return 0;
+	
+	struct cnic_softc *tp;
+	struct ifnet	*ifp;
+	struct mbuf	*top, **mp, *m;
+	pktqueue_t	*pktq;
+	struct sockaddr	dst;
+	int		error = 0, s, tlen, mlen;
+	uint32_t	family;
+
+	s = splnet();
+	tp = cnic_find_unit(dev);
+
+	/* interface was "destroyed" already */
+	if (tp == NULL) {
+		error = ENXIO;
+		goto out_nolock;
+	}
+
+	/* Unlock until we've got the data */
+	mutex_exit(&tp->cnic_lock);
+	splx(s);
+
+	ifp = &tp->cnic_if;
+
+	CNICDEBUG("%s: cnicwrite\n", ifp->if_xname);
+
+	if (tp->cnic_flags & CNIC_PREPADDR) {
+		if (uio->uio_resid < sizeof(dst)) {
+			error = EIO;
+			goto out0;
+		}
+		error = uiomove((void *)&dst, sizeof(dst), uio);
+		if (dst.sa_len > sizeof(dst)) {
+			/* Duh.. */
+			char discard;
+			int n = dst.sa_len - sizeof(dst);
+			while (n--)
+				if ((error = uiomove(&discard, 1, uio)) != 0) {
+					goto out0;
+				}
+		}
+	} else if (tp->cnic_flags & CNIC_IFHEAD) {
+		if (uio->uio_resid < sizeof(family)){
+			error = EIO;
+			goto out0;
+		}
+		error = uiomove((void *)&family, sizeof(family), uio);
+		dst.sa_family = ntohl(family);
+	} else {
+#ifdef INET
+		dst.sa_family = AF_INET;
+#endif
+	}
+
+	if (uio->uio_resid > CNICMTU) {
+		CNICDEBUG("%s: len=%lu!\n", ifp->if_xname,
+		    (unsigned long)uio->uio_resid);
+		error = EIO;
+		goto out0;
+	}
+
+	switch (dst.sa_family) {
+#ifdef INET
+	case AF_INET:
+		pktq = ip_pktq;
+		break;
+#endif
+#ifdef INET6
+	case AF_INET6:
+		pktq = ip6_pktq;
+		break;
+#endif
+	default:
+		error = EAFNOSUPPORT;
+		goto out0;
+	}
+
+	tlen = uio->uio_resid;
+
+	/* get a header mbuf */
+	MGETHDR(m, M_DONTWAIT, MT_DATA);
+	if (m == NULL) {
+		error = ENOBUFS;
+		goto out0;
+	}
+	mlen = MHLEN;
+
+	top = NULL;
+	mp = &top;
+	while (error == 0 && uio->uio_resid > 0) {
+		m->m_len = min(mlen, uio->uio_resid);
+		error = uiomove(mtod(m, void *), m->m_len, uio);
+		*mp = m;
+		mp = &m->m_next;
+		if (error == 0 && uio->uio_resid > 0) {
+			MGET(m, M_DONTWAIT, MT_DATA);
+			if (m == NULL) {
+				error = ENOBUFS;
+				break;
+			}
+			mlen = MLEN;
+		}
+	}
+	if (error) {
+		if (top != NULL)
+			m_freem (top);
+		ifp->if_ierrors++;
+		goto out0;
+	}
+	
+	top->m_pkthdr.len = tlen;
+	top->m_pkthdr.rcvif = ifp;
+
+	bpf_mtap_af(ifp, dst.sa_family, top);
+
+	s = splnet();
+	mutex_enter(&tp->cnic_lock);
+	if ((tp->cnic_flags & CNIC_INITED) == 0) {
+		/* Interface was destroyed */
+		error = ENXIO;
+		goto out;
+	}
+
+	if (__predict_false(!pktq_enqueue(pktq, top, 0))) {
+		ifp->if_collisions++;
+		mutex_exit(&tp->cnic_lock);
+		error = ENOBUFS;
+		m_freem(top);
+		goto out_nolock;
+	}
+	ifp->if_ipackets++;
+	ifp->if_ibytes += tlen;
+out:
+	mutex_exit(&tp->cnic_lock);
+out_nolock:
+	splx(s);
+out0:
+	return (error);
+}
+
+#ifdef ALTQ
+/*
+ * Start packet transmission on the interface.
+ * when the interface queue is rate-limited by ALTQ or TBR,
+ * if_start is needed to drain packets from the queue in order
+ * to notify readers when outgoing packets become ready.
+ *
+ * Should be called at splnet.
+ */
+static void
+cnicstart(struct ifnet *ifp)
+{
+	struct cnic_softc *tp = ifp->if_softc;
+
+	if (!ALTQ_IS_ENABLED(&ifp->if_snd) && !TBR_IS_ENABLED(&ifp->if_snd))
+		return;
+
+	mutex_enter(&tp->cnic_lock);
+	if (!IF_IS_EMPTY(&ifp->if_snd)) {
+		if (tp->cnic_flags & CNIC_RWAIT) {
+			tp->cnic_flags &= ~CNIC_RWAIT;
+			wakeup((void *)tp);
+		}
+		if (tp->cnic_flags & CNIC_ASYNC && tp->cnic_pgid)
+			softint_schedule(tp->cnic_osih);
+
+		selnotify(&tp->cnic_rsel, 0, 0);
+	}
+	mutex_exit(&tp->cnic_lock);
+}
+#endif /* ALTQ */
+/*
+ * cnicpoll - the poll interface, this is only useful on reads
+ * really. The write detect always returns true, write never blocks
+ * anyway, it either accepts the packet or drops it.
+ */
+int
+cnicpoll(dev_t dev, int events, struct lwp *l)
+{
+	struct cnic_softc *tp;
+	struct ifnet	*ifp;
+	int		s, revents = 0;
+
+	s = splnet();
+	tp = cnic_find_unit(dev);
+
+	/* interface was "destroyed" already */
+	if (tp == NULL)
+		goto out_nolock;
+
+	ifp = &tp->cnic_if;
+
+	CNICDEBUG("%s: cnicpoll\n", ifp->if_xname);
+
+	if (events & (POLLIN | POLLRDNORM)) {
+		if (!IFQ_IS_EMPTY(&ifp->if_snd)) {
+			CNICDEBUG("%s: cnicpoll q=%d\n", ifp->if_xname,
+			    ifp->if_snd.ifq_len);
+			revents |= events & (POLLIN | POLLRDNORM);
+		} else {
+			CNICDEBUG("%s: cnicpoll waiting\n", ifp->if_xname);
+			selrecord(l, &tp->cnic_rsel);
+		}
+	}
+
+	if (events & (POLLOUT | POLLWRNORM))
+		revents |= events & (POLLOUT | POLLWRNORM);
+
+	mutex_exit(&tp->cnic_lock);
+out_nolock:
+	splx(s);
+	return (revents);
+}
+
+static void
+filt_cnicrdetach(struct knote *kn)
+{
+	struct cnic_softc *tp = kn->kn_hook;
+	int s;
+
+	s = splnet();
+	SLIST_REMOVE(&tp->cnic_rsel.sel_klist, kn, knote, kn_selnext);
+	splx(s);
+}
+
+static int
+filt_cnicread(struct knote *kn, long hint)
+{
+	struct cnic_softc *tp = kn->kn_hook;
+	struct ifnet *ifp = &tp->cnic_if;
+	struct mbuf *m;
+	int s;
+
+	s = splnet();
+	IF_POLL(&ifp->if_snd, m);
+	if (m == NULL) {
+		splx(s);
+		return (0);
+	}
+
+	for (kn->kn_data = 0; m != NULL; m = m->m_next)
+		kn->kn_data += m->m_len;
+
+	splx(s);
+	return (1);
+}
+
+static const struct filterops cnicread_filtops =
+	{ 1, NULL, filt_cnicrdetach, filt_cnicread };
+
+static const struct filterops cnic_seltrue_filtops =
+	{ 1, NULL, filt_cnicrdetach, filt_seltrue };
+
+int
+cnickqfilter(dev_t dev, struct knote *kn)
+{
+	struct cnic_softc *tp;
+	struct klist *klist;
+	int rv = 0, s;
+
+	s = splnet();
+	tp = cnic_find_unit(dev);
+	if (tp == NULL)
+		goto out_nolock;
+
+	switch (kn->kn_filter) {
+	case EVFILT_READ:
+		klist = &tp->cnic_rsel.sel_klist;
+		kn->kn_fop = &cnicread_filtops;
+		break;
+
+	case EVFILT_WRITE:
+		klist = &tp->cnic_rsel.sel_klist;
+		kn->kn_fop = &cnic_seltrue_filtops;
+		break;
+
+	default:
+		rv = EINVAL;
+		goto out;
+	}
+
+	kn->kn_hook = tp;
+
+	SLIST_INSERT_HEAD(klist, kn, kn_selnext);
+
+out:
+	mutex_exit(&tp->cnic_lock);
+out_nolock:
+	splx(s);
+	return (rv);
+}
diff --git a/sys/net/pktqueue.c b/sys/net/pktqueue.c
index 6039748..3641f9d 100644
--- a/sys/net/pktqueue.c
+++ b/sys/net/pktqueue.c
@@ -215,7 +215,6 @@ cos_pktq_enqueue(void *buff, int size, int to_vmid)
 	//assume VMs can only send to/recv from DOM0
 	if(to_vmid != 0) assert(rump_vmid == 0);
 
-
 	if(!rump_shmem_write(buff, size, rump_vmid, to_vmid)){
 		return false;
 	}
diff --git a/sys/netinet/.ip_input.c.swp b/sys/netinet/.ip_input.c.swp
deleted file mode 100644
index 7d11b1e7ad1e57e053412f3ec93af65e6a38b9a3..0000000000000000000000000000000000000000
GIT binary patch
literal 0
HcmV?d00001

literal 20480
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

diff --git a/sys/netinet/Makefile b/sys/netinet/Makefile
index 84c0fb7..87e0b69 100644
--- a/sys/netinet/Makefile
+++ b/sys/netinet/Makefile
@@ -9,7 +9,7 @@ INCS=	dccp.h icmp6.h icmp_var.h if_atm.h if_ether.h if_inarp.h igmp.h \
 	ip_icmp.h ip_mroute.h ip_var.h pim.h pim_var.h portalgo.h \
 	tcp.h tcp_debug.h tcp_fsm.h tcp_seq.h tcp_timer.h tcp_var.h \
 	tcpip.h udp.h udp_var.h \
-	tcp_vtw.h
+	tcp_vtw.h ip_input.h
 
 # ipfilter headers
 # XXX shouldn't be here
diff --git a/sys/netinet/ip_icmp.c b/sys/netinet/ip_icmp.c
index 3531ce2..20b3da3 100644
--- a/sys/netinet/ip_icmp.c
+++ b/sys/netinet/ip_icmp.c
@@ -217,6 +217,7 @@ void
 icmp_error(struct mbuf *n, int type, int code, n_long dest,
     int destmtu)
 {
+	printf("icmp_error\n");
 	struct ip *oip = mtod(n, struct ip *), *nip;
 	unsigned oiplen = oip->ip_hl << 2;
 	struct icmp *icp;
@@ -381,9 +382,12 @@ struct sockaddr_in icmpmask = {
 /*
  * Process a received ICMP message.
  */
+extern int rump_dom0_rcv;
+extern int rump_vmid;
 void
 icmp_input(struct mbuf *m, ...)
 {
+//	printf("VM%d- icmp_input\n", rump_vmid);	
 	int proto;
 	struct icmp *icp;
 	struct ip *ip = mtod(m, struct ip *);
@@ -400,7 +404,6 @@ icmp_input(struct mbuf *m, ...)
 	hlen = va_arg(ap, int);
 	proto = va_arg(ap, int);
 	va_end(ap);
-
 	/*
 	 * Locate icmp structure in mbuf, and check
 	 * that not corrupted and of at least minimum length.
@@ -414,6 +417,7 @@ icmp_input(struct mbuf *m, ...)
 		    icmplen);
 	}
 #endif
+	
 	if (icmplen < ICMP_MINLEN) {
 		ICMP_STATINC(ICMP_STAT_TOOSHORT);
 		goto freeit;
@@ -677,6 +681,7 @@ freeit:
 void
 icmp_reflect(struct mbuf *m)
 {
+	//printf("VM%d- icmp_reflect\n", rump_vmid);
 	struct ip *ip = mtod(m, struct ip *);
 	struct in_ifaddr *ia;
 	struct ifaddr *ifa;
@@ -907,10 +912,11 @@ icmp_send(struct mbuf *m, struct mbuf *opts)
 #ifdef ICMPPRINTFS
 	if (icmpprintfs) {
 		char sbuf[INET_ADDRSTRLEN], dbuf[INET_ADDRSTRLEN];
-		printf("icmp_send to destination `%s' from `%s'\n",
-		    IN_PRINT(dbuf, &ip->ip_dst), IN_PRINT(sbuf, &ip->ip_src));
+		printf("VM%d- icmp_send to destination '%s' from '%s'\n",rump_vmid,	
+    		IN_PRINT(dbuf, &ip->ip_dst), IN_PRINT(sbuf, &ip->ip_src));
 	}
 #endif
+	
 	(void)ip_output(m, opts, NULL, 0, NULL, NULL);
 }
 
diff --git a/sys/netinet/ip_output.c b/sys/netinet/ip_output.c
index 0c81162..5192d0b 100644
--- a/sys/netinet/ip_output.c
+++ b/sys/netinet/ip_output.c
@@ -113,7 +113,7 @@ __KERNEL_RCSID(0, "$NetBSD: ip_output.c,v 1.238 2015/04/27 10:14:44 ozaki-r Exp
 #include <net/if.h>
 #include <net/route.h>
 #include <net/pfil.h>
-
+#include <net/pktqueue.h>
 #include <netinet/in.h>
 #include <netinet/in_systm.h>
 #include <netinet/ip.h>
@@ -154,9 +154,12 @@ int	ip_do_loopback_cksum = 0;
  * The mbuf chain containing the packet will be freed.
  * The mbuf opt, if present, will not be freed.
  */
+extern int rump_vmid;
+
 int
 ip_output(struct mbuf *m0, ...)
 {
+//	printf("VM%d- ip_output\n", rump_vmid);
 	struct rtentry *rt;
 	struct ip *ip;
 	struct ifnet *ifp;
@@ -183,6 +186,7 @@ ip_output(struct mbuf *m0, ...)
 		struct sockaddr		dst;
 		struct sockaddr_in	dst4;
 	} u;
+	
 	struct sockaddr *rdst = &u.dst;	/* real IP destination, as opposed
 					 * to the nexthop
 					 */
@@ -208,8 +212,9 @@ ip_output(struct mbuf *m0, ...)
 		if (len >= sizeof(struct ip))
 			hlen = len;
 	}
+	
 	ip = mtod(m, struct ip *);
-
+	
 	/*
 	 * Fill in IP header.
 	 */
@@ -229,7 +234,6 @@ ip_output(struct mbuf *m0, ...)
 		memset(&iproute, 0, sizeof(iproute));
 		ro = &iproute;
 	}
-
 	sockaddr_in_init(&u.dst4, &ip->ip_dst, 0);
 	dst = satocsin(rtcache_getdst(ro));
 
@@ -242,7 +246,6 @@ ip_output(struct mbuf *m0, ...)
 	if (dst && (dst->sin_family != AF_INET ||
 	    !in_hosteq(dst->sin_addr, ip->ip_dst)))
 		rtcache_free(ro);
-
 	if ((rt = rtcache_validate(ro)) == NULL &&
 	    (rt = rtcache_update(ro, 1)) == NULL) {
 		dst = &u.dst4;
@@ -509,7 +512,6 @@ sendit:
 	 */
 	INADDR_TO_IA(ip->ip_src, ia);
 #endif
-
 	/* Maybe skip checksums on loopback interfaces. */
 	if (IN_NEED_CHECKSUM(ifp, M_CSUM_IPv4)) {
 		m->m_pkthdr.csum_flags |= M_CSUM_IPv4;
@@ -659,6 +661,7 @@ done:
 #endif
 	return error;
 bad:
+	printf("VM%d- ip_output, bad packet\n");
 	m_freem(m);
 	goto done;
 }
@@ -854,7 +857,6 @@ ip_insertoptions(struct mbuf *m, struct mbuf *opt, int *phlen)
 	struct mbuf *n;
 	struct ip *ip = mtod(m, struct ip *);
 	unsigned optlen;
-
 	optlen = opt->m_len - sizeof(p->ipopt_dst);
 	if (optlen + ntohs(ip->ip_len) > IP_MAXPACKET)
 		return (m);		/* XXX should fail */
diff --git a/sys/netinet/ip_reass.c b/sys/netinet/ip_reass.c
index 7f6239f..9c123eb 100644
--- a/sys/netinet/ip_reass.c
+++ b/sys/netinet/ip_reass.c
@@ -630,6 +630,7 @@ ip_reass_packet(struct mbuf **m0, struct ip *ip)
 	off = (ntohs(ip->ip_off) & IP_OFFMASK) << 3;
 	if ((off > 0 ? off + hlen : len) < IP_MINFRAGSIZE - 1) {
 		IP_STATINC(IP_STAT_BADFRAGS);
+		printf("ip_reassssss\n");
 		return EINVAL;
 	}
 
diff --git a/sys/netinet/raw_ip.c b/sys/netinet/raw_ip.c
index 06a5db8..4d4b550 100644
--- a/sys/netinet/raw_ip.c
+++ b/sys/netinet/raw_ip.c
@@ -169,6 +169,7 @@ rip_sbappendaddr(struct inpcb *last, struct ip *ip, const struct sockaddr *sa,
 void
 rip_input(struct mbuf *m, ...)
 {
+	printf("rip_input\n");
 	int hlen, proto;
 	struct ip *ip = mtod(m, struct ip *);
 	struct inpcb_hdr *inph;
@@ -311,6 +312,7 @@ rip_ctlinput(int cmd, const struct sockaddr *sa, void *v)
 int
 rip_output(struct mbuf *m, ...)
 {
+	printf("rip_output\n");
 	struct inpcb *inp;
 	struct ip *ip;
 	struct mbuf *opts;
diff --git a/sys/rump/dev/lib/libpci/pci_user.h b/sys/rump/dev/lib/libpci/pci_user.h
index a683f88..214dcba 100644
--- a/sys/rump/dev/lib/libpci/pci_user.h
+++ b/sys/rump/dev/lib/libpci/pci_user.h
@@ -9,7 +9,7 @@
  *	must be provided.
  */
 
-#include "rumpcomp_userfeatures_pci.h"
+#include "../../../../../../platform/cos/pci/rumpcomp_userfeatures_pci.h"
 
 void *rumpcomp_pci_map(unsigned long, unsigned long);
 int rumpcomp_pci_confread(unsigned, unsigned, unsigned, int, unsigned int *);
-- 
1.9.1

